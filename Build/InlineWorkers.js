globalThis.CESIUM_WORKERS = atob("dmFyIENlc2l1bVdvcmtlcnMgPSAoKCkgPT4gewogIHZhciBfX2NyZWF0ZSA9IE9iamVjdC5jcmVhdGU7CiAgdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICB2YXIgX19nZXRPd25Qcm9wRGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3I7CiAgdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CiAgdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKICB2YXIgX19oYXNPd25Qcm9wID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICB2YXIgX19yZXF1aXJlID0gLyogQF9fUFVSRV9fICovICgoeCkgPT4gdHlwZW9mIHJlcXVpcmUgIT09ICJ1bmRlZmluZWQiID8gcmVxdWlyZSA6IHR5cGVvZiBQcm94eSAhPT0gInVuZGVmaW5lZCIgPyBuZXcgUHJveHkoeCwgewogICAgZ2V0OiAoYTMsIGIpID0+ICh0eXBlb2YgcmVxdWlyZSAhPT0gInVuZGVmaW5lZCIgPyByZXF1aXJlIDogYTMpW2JdCiAgfSkgOiB4KShmdW5jdGlvbih4KSB7CiAgICBpZiAodHlwZW9mIHJlcXVpcmUgIT09ICJ1bmRlZmluZWQiKSByZXR1cm4gcmVxdWlyZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhyb3cgRXJyb3IoJ0R5bmFtaWMgcmVxdWlyZSBvZiAiJyArIHggKyAnIiBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfSk7CiAgdmFyIF9fZ2xvYiA9IChtYXApID0+IChwYXRoKSA9PiB7CiAgICB2YXIgZm4gPSBtYXBbcGF0aF07CiAgICBpZiAoZm4pIHJldHVybiBmbigpOwogICAgdGhyb3cgbmV3IEVycm9yKCJNb2R1bGUgbm90IGZvdW5kIGluIGJ1bmRsZTogIiArIHBhdGgpOwogIH07CiAgdmFyIF9fZXNtID0gKGZuLCByZXMpID0+IGZ1bmN0aW9uIF9faW5pdCgpIHsKICAgIHJldHVybiBmbiAmJiAocmVzID0gKDAsIGZuW19fZ2V0T3duUHJvcE5hbWVzKGZuKVswXV0pKGZuID0gMCkpLCByZXM7CiAgfTsKICB2YXIgX19jb21tb25KUyA9IChjYiwgbW9kKSA9PiBmdW5jdGlvbiBfX3JlcXVpcmUyKCkgewogICAgcmV0dXJuIG1vZCB8fCAoMCwgY2JbX19nZXRPd25Qcm9wTmFtZXMoY2IpWzBdXSkoKG1vZCA9IHsgZXhwb3J0czoge30gfSkuZXhwb3J0cywgbW9kKSwgbW9kLmV4cG9ydHM7CiAgfTsKICB2YXIgX19leHBvcnQgPSAodGFyZ2V0LCBhbGwpID0+IHsKICAgIGZvciAodmFyIG5hbWUgaW4gYWxsKQogICAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwogIH07CiAgdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tLCBleGNlcHQsIGRlc2MpID0+IHsKICAgIGlmIChmcm9tICYmIHR5cGVvZiBmcm9tID09PSAib2JqZWN0IiB8fCB0eXBlb2YgZnJvbSA9PT0gImZ1bmN0aW9uIikgewogICAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbSkpCiAgICAgICAgaWYgKCFfX2hhc093blByb3AuY2FsbCh0bywga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICAgIF9fZGVmUHJvcCh0bywga2V5LCB7IGdldDogKCkgPT4gZnJvbVtrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20sIGtleSkpIHx8IGRlc2MuZW51bWVyYWJsZSB9KTsKICAgIH0KICAgIHJldHVybiB0bzsKICB9OwogIHZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgICAvLyBJZiB0aGUgaW1wb3J0ZXIgaXMgaW4gbm9kZSBjb21wYXRpYmlsaXR5IG1vZGUgb3IgdGhpcyBpcyBub3QgYW4gRVNNCiAgICAvLyBmaWxlIHRoYXQgaGFzIGJlZW4gY29udmVydGVkIHRvIGEgQ29tbW9uSlMgZmlsZSB1c2luZyBhIEJhYmVsLQogICAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogICAgLy8gImRlZmF1bHQiIHRvIHRoZSBDb21tb25KUyAibW9kdWxlLmV4cG9ydHMiIGZvciBub2RlIGNvbXBhdGliaWxpdHkuCiAgICBpc05vZGVNb2RlIHx8ICFtb2QgfHwgIW1vZC5fX2VzTW9kdWxlID8gX19kZWZQcm9wKHRhcmdldCwgImRlZmF1bHQiLCB7IHZhbHVlOiBtb2QsIGVudW1lcmFibGU6IHRydWUgfSkgOiB0YXJnZXQsCiAgICBtb2QKICApKTsKICB2YXIgX190b0NvbW1vbkpTID0gKG1vZCkgPT4gX19jb3B5UHJvcHMoX19kZWZQcm9wKHt9LCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSksIG1vZCk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZWZpbmVkLmpzCiAgZnVuY3Rpb24gZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9PSB2b2lkIDAgJiYgdmFsdWUgIT09IG51bGw7CiAgfQogIHZhciBkZWZpbmVkX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVmaW5lZCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVmaW5lZC5qcyIoKSB7CiAgICAgIGRlZmluZWRfZGVmYXVsdCA9IGRlZmluZWQ7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9EZXZlbG9wZXJFcnJvci5qcwogIGZ1bmN0aW9uIERldmVsb3BlckVycm9yKG1lc3NhZ2UpIHsKICAgIHRoaXMubmFtZSA9ICJEZXZlbG9wZXJFcnJvciI7CiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgbGV0IHN0YWNrOwogICAgdHJ5IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHN0YWNrID0gZS5zdGFjazsKICAgIH0KICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICB9CiAgdmFyIERldmVsb3BlckVycm9yX2RlZmF1bHQ7CiAgdmFyIGluaXRfRGV2ZWxvcGVyRXJyb3IgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0RldmVsb3BlckVycm9yLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoT2JqZWN0LmNyZWF0ZSkpIHsKICAgICAgICBEZXZlbG9wZXJFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgICAgICAgRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGV2ZWxvcGVyRXJyb3I7CiAgICAgIH0KICAgICAgRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9IGAke3RoaXMubmFtZX06ICR7dGhpcy5tZXNzYWdlfWA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLnN0YWNrKSkgewogICAgICAgICAgc3RyICs9IGAKJHt0aGlzLnN0YWNrLnRvU3RyaW5nKCl9YDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgRGV2ZWxvcGVyRXJyb3IudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoCiAgICAgICAgICAiVGhpcyBmdW5jdGlvbiBkZWZpbmVzIGFuIGludGVyZmFjZSBhbmQgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHkuIgogICAgICAgICk7CiAgICAgIH07CiAgICAgIERldmVsb3BlckVycm9yX2RlZmF1bHQgPSBEZXZlbG9wZXJFcnJvcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NoZWNrLmpzCiAgZnVuY3Rpb24gZ2V0VW5kZWZpbmVkRXJyb3JNZXNzYWdlKG5hbWUpIHsKICAgIHJldHVybiBgJHtuYW1lfSBpcyByZXF1aXJlZCwgYWN0dWFsIHZhbHVlIHdhcyB1bmRlZmluZWRgOwogIH0KICBmdW5jdGlvbiBnZXRGYWlsZWRUeXBlRXJyb3JNZXNzYWdlKGFjdHVhbCwgZXhwZWN0ZWQsIG5hbWUpIHsKICAgIHJldHVybiBgRXhwZWN0ZWQgJHtuYW1lfSB0byBiZSB0eXBlb2YgJHtleHBlY3RlZH0sIGFjdHVhbCB0eXBlb2Ygd2FzICR7YWN0dWFsfWA7CiAgfQogIHZhciBDaGVjaywgQ2hlY2tfZGVmYXVsdDsKICB2YXIgaW5pdF9DaGVjayA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2hlY2suanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBDaGVjayA9IHt9OwogICAgICBDaGVjay50eXBlT2YgPSB7fTsKICAgICAgQ2hlY2suZGVmaW5lZCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0ZXN0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoZ2V0VW5kZWZpbmVkRXJyb3JNZXNzYWdlKG5hbWUpKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5mdW5jID0gZnVuY3Rpb24obmFtZSwgdGVzdCkgewogICAgICAgIGlmICh0eXBlb2YgdGVzdCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGdldEZhaWxlZFR5cGVFcnJvck1lc3NhZ2UodHlwZW9mIHRlc3QsICJmdW5jdGlvbiIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLnN0cmluZyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgInN0cmluZyIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlciA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgIm51bWJlciIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5sZXNzVGhhbiA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA+PSBsaW1pdCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBFeHBlY3RlZCAke25hbWV9IHRvIGJlIGxlc3MgdGhhbiAke2xpbWl0fSwgYWN0dWFsIHZhbHVlIHdhcyAke3Rlc3R9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA+IGxpbWl0KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEV4cGVjdGVkICR7bmFtZX0gdG8gYmUgbGVzcyB0aGFuIG9yIGVxdWFsIHRvICR7bGltaXR9LCBhY3R1YWwgdmFsdWUgd2FzICR7dGVzdH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbiA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA8PSBsaW1pdCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBFeHBlY3RlZCAke25hbWV9IHRvIGJlIGdyZWF0ZXIgdGhhbiAke2xpbWl0fSwgYWN0dWFsIHZhbHVlIHdhcyAke3Rlc3R9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA8IGxpbWl0KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEV4cGVjdGVkICR7bmFtZX0gdG8gYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvICR7bGltaXR9LCBhY3R1YWwgdmFsdWUgd2FzICR7dGVzdH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm9iamVjdCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgIm9iamVjdCIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLmJvb2wgPSBmdW5jdGlvbihuYW1lLCB0ZXN0KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0ZXN0ICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICBnZXRGYWlsZWRUeXBlRXJyb3JNZXNzYWdlKHR5cGVvZiB0ZXN0LCAiYm9vbGVhbiIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLmJpZ2ludCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJiaWdpbnQiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgImJpZ2ludCIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5lcXVhbHMgPSBmdW5jdGlvbihuYW1lMSwgbmFtZTIsIHRlc3QxLCB0ZXN0MikgewogICAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIobmFtZTEsIHRlc3QxKTsKICAgICAgICBDaGVjay50eXBlT2YubnVtYmVyKG5hbWUyLCB0ZXN0Mik7CiAgICAgICAgaWYgKHRlc3QxICE9PSB0ZXN0MikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGAke25hbWUxfSBtdXN0IGJlIGVxdWFsIHRvICR7bmFtZTJ9LCB0aGUgYWN0dWFsIHZhbHVlcyBhcmUgJHt0ZXN0MX0gYW5kICR7dGVzdDJ9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrX2RlZmF1bHQgPSBDaGVjazsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlZmF1bHRWYWx1ZS5qcwogIGZ1bmN0aW9uIGRlZmF1bHRWYWx1ZShhMywgYikgewogICAgaWYgKGEzICE9PSB2b2lkIDAgJiYgYTMgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIGEzOwogICAgfQogICAgcmV0dXJuIGI7CiAgfQogIHZhciBkZWZhdWx0VmFsdWVfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWZhdWx0VmFsdWUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlZmF1bHRWYWx1ZS5qcyIoKSB7CiAgICAgIGRlZmF1bHRWYWx1ZS5FTVBUWV9PQkpFQ1QgPSBPYmplY3QuZnJlZXplKHt9KTsKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQgPSBkZWZhdWx0VmFsdWU7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9tZXJzZW5uZS10d2lzdGVyL3NyYy9tZXJzZW5uZS10d2lzdGVyLmpzCiAgdmFyIHJlcXVpcmVfbWVyc2VubmVfdHdpc3RlciA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9tZXJzZW5uZS10d2lzdGVyL3NyYy9tZXJzZW5uZS10d2lzdGVyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIHZhciBNZXJzZW5uZVR3aXN0ZXIyID0gZnVuY3Rpb24oc2VlZCkgewogICAgICAgIGlmIChzZWVkID09IHZvaWQgMCkgewogICAgICAgICAgc2VlZCA9ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkuZ2V0VGltZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLk4gPSA2MjQ7CiAgICAgICAgdGhpcy5NID0gMzk3OwogICAgICAgIHRoaXMuTUFUUklYX0EgPSAyNTY3NDgzNjE1OwogICAgICAgIHRoaXMuVVBQRVJfTUFTSyA9IDIxNDc0ODM2NDg7CiAgICAgICAgdGhpcy5MT1dFUl9NQVNLID0gMjE0NzQ4MzY0NzsKICAgICAgICB0aGlzLm10ID0gbmV3IEFycmF5KHRoaXMuTik7CiAgICAgICAgdGhpcy5tdGkgPSB0aGlzLk4gKyAxOwogICAgICAgIGlmIChzZWVkLmNvbnN0cnVjdG9yID09IEFycmF5KSB7CiAgICAgICAgICB0aGlzLmluaXRfYnlfYXJyYXkoc2VlZCwgc2VlZC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmluaXRfc2VlZChzZWVkKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIE1lcnNlbm5lVHdpc3RlcjIucHJvdG90eXBlLmluaXRfc2VlZCA9IGZ1bmN0aW9uKHMpIHsKICAgICAgICB0aGlzLm10WzBdID0gcyA+Pj4gMDsKICAgICAgICBmb3IgKHRoaXMubXRpID0gMTsgdGhpcy5tdGkgPCB0aGlzLk47IHRoaXMubXRpKyspIHsKICAgICAgICAgIHZhciBzID0gdGhpcy5tdFt0aGlzLm10aSAtIDFdIF4gdGhpcy5tdFt0aGlzLm10aSAtIDFdID4+PiAzMDsKICAgICAgICAgIHRoaXMubXRbdGhpcy5tdGldID0gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxODEyNDMzMjUzIDw8IDE2KSArIChzICYgNjU1MzUpICogMTgxMjQzMzI1MyArIHRoaXMubXRpOwogICAgICAgICAgdGhpcy5tdFt0aGlzLm10aV0gPj4+PSAwOwogICAgICAgIH0KICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUuaW5pdF9ieV9hcnJheSA9IGZ1bmN0aW9uKGluaXRfa2V5LCBrZXlfbGVuZ3RoKSB7CiAgICAgICAgdmFyIGksIGosIGs7CiAgICAgICAgdGhpcy5pbml0X3NlZWQoMTk2NTAyMTgpOwogICAgICAgIGkgPSAxOwogICAgICAgIGogPSAwOwogICAgICAgIGsgPSB0aGlzLk4gPiBrZXlfbGVuZ3RoID8gdGhpcy5OIDoga2V5X2xlbmd0aDsKICAgICAgICBmb3IgKDsgazsgay0tKSB7CiAgICAgICAgICB2YXIgcyA9IHRoaXMubXRbaSAtIDFdIF4gdGhpcy5tdFtpIC0gMV0gPj4+IDMwOwogICAgICAgICAgdGhpcy5tdFtpXSA9ICh0aGlzLm10W2ldIF4gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxNjY0NTI1IDw8IDE2KSArIChzICYgNjU1MzUpICogMTY2NDUyNSkgKyBpbml0X2tleVtqXSArIGo7CiAgICAgICAgICB0aGlzLm10W2ldID4+Pj0gMDsKICAgICAgICAgIGkrKzsKICAgICAgICAgIGorKzsKICAgICAgICAgIGlmIChpID49IHRoaXMuTikgewogICAgICAgICAgICB0aGlzLm10WzBdID0gdGhpcy5tdFt0aGlzLk4gLSAxXTsKICAgICAgICAgICAgaSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA+PSBrZXlfbGVuZ3RoKSBqID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChrID0gdGhpcy5OIC0gMTsgazsgay0tKSB7CiAgICAgICAgICB2YXIgcyA9IHRoaXMubXRbaSAtIDFdIF4gdGhpcy5tdFtpIC0gMV0gPj4+IDMwOwogICAgICAgICAgdGhpcy5tdFtpXSA9ICh0aGlzLm10W2ldIF4gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxNTY2MDgzOTQxIDw8IDE2KSArIChzICYgNjU1MzUpICogMTU2NjA4Mzk0MSkgLSBpOwogICAgICAgICAgdGhpcy5tdFtpXSA+Pj49IDA7CiAgICAgICAgICBpKys7CiAgICAgICAgICBpZiAoaSA+PSB0aGlzLk4pIHsKICAgICAgICAgICAgdGhpcy5tdFswXSA9IHRoaXMubXRbdGhpcy5OIC0gMV07CiAgICAgICAgICAgIGkgPSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLm10WzBdID0gMjE0NzQ4MzY0ODsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2ludCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB5OwogICAgICAgIHZhciBtYWcwMSA9IG5ldyBBcnJheSgwLCB0aGlzLk1BVFJJWF9BKTsKICAgICAgICBpZiAodGhpcy5tdGkgPj0gdGhpcy5OKSB7CiAgICAgICAgICB2YXIga2s7CiAgICAgICAgICBpZiAodGhpcy5tdGkgPT0gdGhpcy5OICsgMSkKICAgICAgICAgICAgdGhpcy5pbml0X3NlZWQoNTQ4OSk7CiAgICAgICAgICBmb3IgKGtrID0gMDsga2sgPCB0aGlzLk4gLSB0aGlzLk07IGtrKyspIHsKICAgICAgICAgICAgeSA9IHRoaXMubXRba2tdICYgdGhpcy5VUFBFUl9NQVNLIHwgdGhpcy5tdFtrayArIDFdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgICB0aGlzLm10W2trXSA9IHRoaXMubXRba2sgKyB0aGlzLk1dIF4geSA+Pj4gMSBeIG1hZzAxW3kgJiAxXTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoOyBrayA8IHRoaXMuTiAtIDE7IGtrKyspIHsKICAgICAgICAgICAgeSA9IHRoaXMubXRba2tdICYgdGhpcy5VUFBFUl9NQVNLIHwgdGhpcy5tdFtrayArIDFdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgICB0aGlzLm10W2trXSA9IHRoaXMubXRba2sgKyAodGhpcy5NIC0gdGhpcy5OKV0gXiB5ID4+PiAxIF4gbWFnMDFbeSAmIDFdOwogICAgICAgICAgfQogICAgICAgICAgeSA9IHRoaXMubXRbdGhpcy5OIC0gMV0gJiB0aGlzLlVQUEVSX01BU0sgfCB0aGlzLm10WzBdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgdGhpcy5tdFt0aGlzLk4gLSAxXSA9IHRoaXMubXRbdGhpcy5NIC0gMV0gXiB5ID4+PiAxIF4gbWFnMDFbeSAmIDFdOwogICAgICAgICAgdGhpcy5tdGkgPSAwOwogICAgICAgIH0KICAgICAgICB5ID0gdGhpcy5tdFt0aGlzLm10aSsrXTsKICAgICAgICB5IF49IHkgPj4+IDExOwogICAgICAgIHkgXj0geSA8PCA3ICYgMjYzNjkyODY0MDsKICAgICAgICB5IF49IHkgPDwgMTUgJiA0MDIyNzMwNzUyOwogICAgICAgIHkgXj0geSA+Pj4gMTg7CiAgICAgICAgcmV0dXJuIHkgPj4+IDA7CiAgICAgIH07CiAgICAgIE1lcnNlbm5lVHdpc3RlcjIucHJvdG90eXBlLnJhbmRvbV9pbnQzMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnJhbmRvbV9pbnQoKSA+Pj4gMTsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2luY2wgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYW5kb21faW50KCkgKiAoMSAvIDQyOTQ5NjcyOTUpOwogICAgICB9OwogICAgICBNZXJzZW5uZVR3aXN0ZXIyLnByb3RvdHlwZS5yYW5kb20gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYW5kb21faW50KCkgKiAoMSAvIDQyOTQ5NjcyOTYpOwogICAgICB9OwogICAgICBNZXJzZW5uZVR3aXN0ZXIyLnByb3RvdHlwZS5yYW5kb21fZXhjbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAodGhpcy5yYW5kb21faW50KCkgKyAwLjUpICogKDEgLyA0Mjk0OTY3Mjk2KTsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2xvbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYTMgPSB0aGlzLnJhbmRvbV9pbnQoKSA+Pj4gNSwgYiA9IHRoaXMucmFuZG9tX2ludCgpID4+PiA2OwogICAgICAgIHJldHVybiAoYTMgKiA2NzEwODg2NCArIGIpICogKDEgLyA5MDA3MTk5MjU0NzQwOTkyKTsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBNZXJzZW5uZVR3aXN0ZXIyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0aC5qcwogIHZhciBpbXBvcnRfbWVyc2VubmVfdHdpc3RlciwgQ2VzaXVtTWF0aCwgZmFjdG9yaWFscywgcmFuZG9tTnVtYmVyR2VuZXJhdG9yLCBNYXRoX2RlZmF1bHQ7CiAgdmFyIGluaXRfTWF0aCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0aC5qcyIoKSB7CiAgICAgIGltcG9ydF9tZXJzZW5uZV90d2lzdGVyID0gX190b0VTTShyZXF1aXJlX21lcnNlbm5lX3R3aXN0ZXIoKSwgMSk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgQ2VzaXVtTWF0aCA9IHt9OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT04xID0gMC4xOwogICAgICBDZXNpdW1NYXRoLkVQU0lMT04yID0gMC4wMTsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OMyA9IDFlLTM7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjQgPSAxZS00OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT041ID0gMWUtNTsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9ONiA9IDFlLTY7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjcgPSAxZS03OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT044ID0gMWUtODsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OOSA9IDFlLTk7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEwID0gMWUtMTA7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjExID0gMWUtMTE7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEyID0gMWUtMTI7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEzID0gMWUtMTM7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE0ID0gMWUtMTQ7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE1ID0gMWUtMTU7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE2ID0gMWUtMTY7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE3ID0gMWUtMTc7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE4ID0gMWUtMTg7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE5ID0gMWUtMTk7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjIwID0gMWUtMjA7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjIxID0gMWUtMjE7CiAgICAgIENlc2l1bU1hdGguR1JBVklUQVRJT05BTFBBUkFNRVRFUiA9IDM5ODYwMDQ0MThlNTsKICAgICAgQ2VzaXVtTWF0aC5TT0xBUl9SQURJVVMgPSA2OTU1ZTU7CiAgICAgIENlc2l1bU1hdGguTFVOQVJfUkFESVVTID0gMTczNzQwMDsKICAgICAgQ2VzaXVtTWF0aC5TSVhUWV9GT1VSX0tJTE9CWVRFUyA9IDY0ICogMTAyNDsKICAgICAgQ2VzaXVtTWF0aC5GT1VSX0dJR0FCWVRFUyA9IDQgKiAxMDI0ICogMTAyNCAqIDEwMjQ7CiAgICAgIENlc2l1bU1hdGguc2lnbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KE1hdGguc2lnbiwgZnVuY3Rpb24gc2lnbih2YWx1ZSkgewogICAgICAgIHZhbHVlID0gK3ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gMCB8fCB2YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlID4gMCA/IDEgOiAtMTsKICAgICAgfSk7CiAgICAgIENlc2l1bU1hdGguc2lnbk5vdFplcm8gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgudG9TTm9ybSA9IGZ1bmN0aW9uKHZhbHVlLCByYW5nZU1heGltdW0pIHsKICAgICAgICByYW5nZU1heGltdW0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChyYW5nZU1heGltdW0sIDI1NSk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoCiAgICAgICAgICAoQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpICogMC41ICsgMC41KSAqIHJhbmdlTWF4aW11bQogICAgICAgICk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZnJvbVNOb3JtID0gZnVuY3Rpb24odmFsdWUsIHJhbmdlTWF4aW11bSkgewogICAgICAgIHJhbmdlTWF4aW11bSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJhbmdlTWF4aW11bSwgMjU1KTsKICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgMCwgcmFuZ2VNYXhpbXVtKSAvIHJhbmdlTWF4aW11bSAqIDIgLSAxOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKHZhbHVlLCByYW5nZU1pbmltdW0sIHJhbmdlTWF4aW11bSkgewogICAgICAgIHJhbmdlTWF4aW11bSA9IE1hdGgubWF4KHJhbmdlTWF4aW11bSAtIHJhbmdlTWluaW11bSwgMCk7CiAgICAgICAgcmV0dXJuIHJhbmdlTWF4aW11bSA9PT0gMCA/IDAgOiBDZXNpdW1NYXRoLmNsYW1wKCh2YWx1ZSAtIHJhbmdlTWluaW11bSkgLyByYW5nZU1heGltdW0sIDAsIDEpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnNpbmggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChNYXRoLnNpbmgsIGZ1bmN0aW9uIHNpbmgodmFsdWUpIHsKICAgICAgICByZXR1cm4gKE1hdGguZXhwKHZhbHVlKSAtIE1hdGguZXhwKC12YWx1ZSkpIC8gMjsKICAgICAgfSk7CiAgICAgIENlc2l1bU1hdGguY29zaCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KE1hdGguY29zaCwgZnVuY3Rpb24gY29zaCh2YWx1ZSkgewogICAgICAgIHJldHVybiAoTWF0aC5leHAodmFsdWUpICsgTWF0aC5leHAoLXZhbHVlKSkgLyAyOwogICAgICB9KTsKICAgICAgQ2VzaXVtTWF0aC5sZXJwID0gZnVuY3Rpb24ocCwgcSwgdGltZSkgewogICAgICAgIHJldHVybiAoMSAtIHRpbWUpICogcCArIHRpbWUgKiBxOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLlBJID0gTWF0aC5QSTsKICAgICAgQ2VzaXVtTWF0aC5PTkVfT1ZFUl9QSSA9IDEgLyBNYXRoLlBJOwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfVFdPID0gTWF0aC5QSSAvIDI7CiAgICAgIENlc2l1bU1hdGguUElfT1ZFUl9USFJFRSA9IE1hdGguUEkgLyAzOwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfRk9VUiA9IE1hdGguUEkgLyA0OwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfU0lYID0gTWF0aC5QSSAvIDY7CiAgICAgIENlc2l1bU1hdGguVEhSRUVfUElfT1ZFUl9UV08gPSAzICogTWF0aC5QSSAvIDI7CiAgICAgIENlc2l1bU1hdGguVFdPX1BJID0gMiAqIE1hdGguUEk7CiAgICAgIENlc2l1bU1hdGguT05FX09WRVJfVFdPX1BJID0gMSAvICgyICogTWF0aC5QSSk7CiAgICAgIENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFID0gTWF0aC5QSSAvIDE4MDsKICAgICAgQ2VzaXVtTWF0aC5ERUdSRUVTX1BFUl9SQURJQU4gPSAxODAgLyBNYXRoLlBJOwogICAgICBDZXNpdW1NYXRoLlJBRElBTlNfUEVSX0FSQ1NFQ09ORCA9IENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFIC8gMzYwMDsKICAgICAgQ2VzaXVtTWF0aC50b1JhZGlhbnMgPSBmdW5jdGlvbihkZWdyZWVzKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGVncmVlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkZWdyZWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVncmVlcyAqIENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnRvRGVncmVlcyA9IGZ1bmN0aW9uKHJhZGlhbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYWRpYW5zKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJhZGlhbnMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByYWRpYW5zICogQ2VzaXVtTWF0aC5ERUdSRUVTX1BFUl9SQURJQU47CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguY29udmVydExvbmdpdHVkZVJhbmdlID0gZnVuY3Rpb24oYW5nbGUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhbmdsZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdHdvUGkgPSBDZXNpdW1NYXRoLlRXT19QSTsKICAgICAgICBjb25zdCBzaW1wbGlmaWVkID0gYW5nbGUgLSBNYXRoLmZsb29yKGFuZ2xlIC8gdHdvUGkpICogdHdvUGk7CiAgICAgICAgaWYgKHNpbXBsaWZpZWQgPCAtTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQgKyB0d29QaTsKICAgICAgICB9CiAgICAgICAgaWYgKHNpbXBsaWZpZWQgPj0gTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQgLSB0d29QaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQ7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguY2xhbXBUb0xhdGl0dWRlUmFuZ2UgPSBmdW5jdGlvbihhbmdsZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFuZ2xlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5jbGFtcCgKICAgICAgICAgIGFuZ2xlLAogICAgICAgICAgLTEgKiBDZXNpdW1NYXRoLlBJX09WRVJfVFdPLAogICAgICAgICAgQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTwogICAgICAgICk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubmVnYXRpdmVQaVRvUGkgPSBmdW5jdGlvbihhbmdsZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFuZ2xlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoYW5nbGUgPj0gLUNlc2l1bU1hdGguUEkgJiYgYW5nbGUgPD0gQ2VzaXVtTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIGFuZ2xlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC56ZXJvVG9Ud29QaShhbmdsZSArIENlc2l1bU1hdGguUEkpIC0gQ2VzaXVtTWF0aC5QSTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC56ZXJvVG9Ud29QaSA9IGZ1bmN0aW9uKGFuZ2xlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYW5nbGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChhbmdsZSA+PSAwICYmIGFuZ2xlIDw9IENlc2l1bU1hdGguVFdPX1BJKSB7CiAgICAgICAgICByZXR1cm4gYW5nbGU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1vZCA9IENlc2l1bU1hdGgubW9kKGFuZ2xlLCBDZXNpdW1NYXRoLlRXT19QSSk7CiAgICAgICAgaWYgKE1hdGguYWJzKG1vZCkgPCBDZXNpdW1NYXRoLkVQU0lMT04xNCAmJiBNYXRoLmFicyhhbmdsZSkgPiBDZXNpdW1NYXRoLkVQU0lMT04xNCkgewogICAgICAgICAgcmV0dXJuIENlc2l1bU1hdGguVFdPX1BJOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbW9kOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm1vZCA9IGZ1bmN0aW9uKG0sIG4pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm0gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG4pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG4gPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXZpc29yIGNhbm5vdCBiZSAwLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoQ2VzaXVtTWF0aC5zaWduKG0pID09PSBDZXNpdW1NYXRoLnNpZ24obikgJiYgTWF0aC5hYnMobSkgPCBNYXRoLmFicyhuKSkgewogICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgfQogICAgICAgIHJldHVybiAobSAlIG4gKyBuKSAlIG47CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJlbGF0aXZlRXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJlbGF0aXZlRXBzaWxvbiwgMCk7CiAgICAgICAgYWJzb2x1dGVFcHNpbG9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYWJzb2x1dGVFcHNpbG9uLCByZWxhdGl2ZUVwc2lsb24pOwogICAgICAgIGNvbnN0IGFic0RpZmYgPSBNYXRoLmFicyhsZWZ0IC0gcmlnaHQpOwogICAgICAgIHJldHVybiBhYnNEaWZmIDw9IGFic29sdXRlRXBzaWxvbiB8fCBhYnNEaWZmIDw9IHJlbGF0aXZlRXBzaWxvbiAqIE1hdGgubWF4KE1hdGguYWJzKGxlZnQpLCBNYXRoLmFicyhyaWdodCkpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmxlc3NUaGFuID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZmlyc3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNlY29uZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYWJzb2x1dGVFcHNpbG9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFic29sdXRlRXBzaWxvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlZnQgLSByaWdodCA8IC1hYnNvbHV0ZUVwc2lsb247CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsZWZ0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImZpcnN0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZWNvbmQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFic29sdXRlRXBzaWxvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhYnNvbHV0ZUVwc2lsb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBsZWZ0IC0gcmlnaHQgPCBhYnNvbHV0ZUVwc2lsb247CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZ3JlYXRlclRoYW4gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJmaXJzdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYWJzb2x1dGVFcHNpbG9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGVmdCAtIHJpZ2h0ID4gYWJzb2x1dGVFcHNpbG9uOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmdyZWF0ZXJUaGFuT3JFcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJmaXJzdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYWJzb2x1dGVFcHNpbG9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGVmdCAtIHJpZ2h0ID4gLWFic29sdXRlRXBzaWxvbjsKICAgICAgfTsKICAgICAgZmFjdG9yaWFscyA9IFsxXTsKICAgICAgQ2VzaXVtTWF0aC5mYWN0b3JpYWwgPSBmdW5jdGlvbihuKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuICE9PSAibnVtYmVyIiB8fCBuIDwgMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJBIG51bWJlciBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gMCBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBmYWN0b3JpYWxzLmxlbmd0aDsKICAgICAgICBpZiAobiA+PSBsZW5ndGgpIHsKICAgICAgICAgIGxldCBzdW0gPSBmYWN0b3JpYWxzW2xlbmd0aCAtIDFdOwogICAgICAgICAgZm9yIChsZXQgaSA9IGxlbmd0aDsgaSA8PSBuOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgbmV4dCA9IHN1bSAqIGk7CiAgICAgICAgICAgIGZhY3RvcmlhbHMucHVzaChuZXh0KTsKICAgICAgICAgICAgc3VtID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhY3RvcmlhbHNbbl07CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguaW5jcmVtZW50V3JhcCA9IGZ1bmN0aW9uKG4sIG1heGltdW1WYWx1ZSwgbWluaW11bVZhbHVlKSB7CiAgICAgICAgbWluaW11bVZhbHVlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWluaW11bVZhbHVlLCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChuKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm4gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChtYXhpbXVtVmFsdWUgPD0gbWluaW11bVZhbHVlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF4aW11bVZhbHVlIG11c3QgYmUgZ3JlYXRlciB0aGFuIG1pbmltdW1WYWx1ZS4iKTsKICAgICAgICB9CiAgICAgICAgKytuOwogICAgICAgIGlmIChuID4gbWF4aW11bVZhbHVlKSB7CiAgICAgICAgICBuID0gbWluaW11bVZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbjsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5pc1Bvd2VyT2ZUd28gPSBmdW5jdGlvbihuKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuICE9PSAibnVtYmVyIiB8fCBuIDwgMCB8fCBuID4gNDI5NDk2NzI5NSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkEgbnVtYmVyIGJldHdlZW4gMCBhbmQgKDJeMzIpLTEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuICE9PSAwICYmIChuICYgbiAtIDEpID09PSAwOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm5leHRQb3dlck9mVHdvID0gZnVuY3Rpb24obikgewogICAgICAgIGlmICh0eXBlb2YgbiAhPT0gIm51bWJlciIgfHwgbiA8IDAgfHwgbiA+IDIxNDc0ODM2NDgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBIG51bWJlciBiZXR3ZWVuIDAgYW5kIDJeMzEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIC0tbjsKICAgICAgICBuIHw9IG4gPj4gMTsKICAgICAgICBuIHw9IG4gPj4gMjsKICAgICAgICBuIHw9IG4gPj4gNDsKICAgICAgICBuIHw9IG4gPj4gODsKICAgICAgICBuIHw9IG4gPj4gMTY7CiAgICAgICAgKytuOwogICAgICAgIHJldHVybiBuOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnByZXZpb3VzUG93ZXJPZlR3byA9IGZ1bmN0aW9uKG4pIHsKICAgICAgICBpZiAodHlwZW9mIG4gIT09ICJudW1iZXIiIHx8IG4gPCAwIHx8IG4gPiA0Mjk0OTY3Mjk1KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQSBudW1iZXIgYmV0d2VlbiAwIGFuZCAoMl4zMiktMSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbiB8PSBuID4+IDE7CiAgICAgICAgbiB8PSBuID4+IDI7CiAgICAgICAgbiB8PSBuID4+IDQ7CiAgICAgICAgbiB8PSBuID4+IDg7CiAgICAgICAgbiB8PSBuID4+IDE2OwogICAgICAgIG4gfD0gbiA+PiAzMjsKICAgICAgICBuID0gKG4gPj4+IDApIC0gKG4gPj4+IDEpOwogICAgICAgIHJldHVybiBuOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmNsYW1wID0gZnVuY3Rpb24odmFsdWUsIG1pbjMsIG1heDMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibWluIiwgbWluMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJtYXgiLCBtYXgzKTsKICAgICAgICByZXR1cm4gdmFsdWUgPCBtaW4zID8gbWluMyA6IHZhbHVlID4gbWF4MyA/IG1heDMgOiB2YWx1ZTsKICAgICAgfTsKICAgICAgcmFuZG9tTnVtYmVyR2VuZXJhdG9yID0gbmV3IGltcG9ydF9tZXJzZW5uZV90d2lzdGVyLmRlZmF1bHQoKTsKICAgICAgQ2VzaXVtTWF0aC5zZXRSYW5kb21OdW1iZXJTZWVkID0gZnVuY3Rpb24oc2VlZCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlZWQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2VlZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmFuZG9tTnVtYmVyR2VuZXJhdG9yID0gbmV3IGltcG9ydF9tZXJzZW5uZV90d2lzdGVyLmRlZmF1bHQoc2VlZCk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubmV4dFJhbmRvbU51bWJlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiByYW5kb21OdW1iZXJHZW5lcmF0b3IucmFuZG9tKCk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgucmFuZG9tQmV0d2VlbiA9IGZ1bmN0aW9uKG1pbjMsIG1heDMpIHsKICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4MyAtIG1pbjMpICsgbWluMzsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5hY29zQ2xhbXBlZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoLmFjb3MoQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5hc2luQ2xhbXBlZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoLmFzaW4oQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5jaG9yZExlbmd0aCA9IGZ1bmN0aW9uKGFuZ2xlLCByYWRpdXMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhbmdsZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmFkaXVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJhZGl1cyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDIgKiByYWRpdXMgKiBNYXRoLnNpbihhbmdsZSAqIDAuNSk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubG9nQmFzZSA9IGZ1bmN0aW9uKG51bWJlciwgYmFzZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG51bWJlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJudW1iZXIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJhc2UpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYmFzZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdGgubG9nKG51bWJlcikgLyBNYXRoLmxvZyhiYXNlKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5jYnJ0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoTWF0aC5jYnJ0LCBmdW5jdGlvbiBjYnJ0KG51bWJlcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IE1hdGgucG93KE1hdGguYWJzKG51bWJlciksIDEgLyAzKTsKICAgICAgICByZXR1cm4gbnVtYmVyIDwgMCA/IC1yZXN1bHQgOiByZXN1bHQ7CiAgICAgIH0pOwogICAgICBDZXNpdW1NYXRoLmxvZzIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChNYXRoLmxvZzIsIGZ1bmN0aW9uIGxvZzIobnVtYmVyKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubG9nKG51bWJlcikgKiBNYXRoLkxPRzJFOwogICAgICB9KTsKICAgICAgQ2VzaXVtTWF0aC5mb2cgPSBmdW5jdGlvbihkaXN0YW5jZVRvQ2FtZXJhLCBkZW5zaXR5KSB7CiAgICAgICAgY29uc3Qgc2NhbGFyID0gZGlzdGFuY2VUb0NhbWVyYSAqIGRlbnNpdHk7CiAgICAgICAgcmV0dXJuIDEgLSBNYXRoLmV4cCgtKHNjYWxhciAqIHNjYWxhcikpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmZhc3RBcHByb3hpbWF0ZUF0YW4gPSBmdW5jdGlvbih4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ4IiwgeCk7CiAgICAgICAgcmV0dXJuIHggKiAoLTAuMTc4NCAqIE1hdGguYWJzKHgpIC0gMC4wNjYzICogeCAqIHggKyAxLjAzMDEpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmZhc3RBcHByb3hpbWF0ZUF0YW4yID0gZnVuY3Rpb24oeCwgeSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieCIsIHgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieSIsIHkpOwogICAgICAgIGxldCBvcHBvc2l0ZTsKICAgICAgICBsZXQgdCA9IE1hdGguYWJzKHgpOwogICAgICAgIG9wcG9zaXRlID0gTWF0aC5hYnMoeSk7CiAgICAgICAgY29uc3QgYWRqYWNlbnQgPSBNYXRoLm1heCh0LCBvcHBvc2l0ZSk7CiAgICAgICAgb3Bwb3NpdGUgPSBNYXRoLm1pbih0LCBvcHBvc2l0ZSk7CiAgICAgICAgY29uc3Qgb3Bwb3NpdGVPdmVyQWRqYWNlbnQgPSBvcHBvc2l0ZSAvIGFkamFjZW50OwogICAgICAgIGlmIChpc05hTihvcHBvc2l0ZU92ZXJBZGphY2VudCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJlaXRoZXIgeCBvciB5IG11c3QgYmUgbm9uemVybyIpOwogICAgICAgIH0KICAgICAgICB0ID0gQ2VzaXVtTWF0aC5mYXN0QXBwcm94aW1hdGVBdGFuKG9wcG9zaXRlT3ZlckFkamFjZW50KTsKICAgICAgICB0ID0gTWF0aC5hYnMoeSkgPiBNYXRoLmFicyh4KSA/IENlc2l1bU1hdGguUElfT1ZFUl9UV08gLSB0IDogdDsKICAgICAgICB0ID0geCA8IDAgPyBDZXNpdW1NYXRoLlBJIC0gdCA6IHQ7CiAgICAgICAgdCA9IHkgPCAwID8gLXQgOiB0OwogICAgICAgIHJldHVybiB0OwogICAgICB9OwogICAgICBNYXRoX2RlZmF1bHQgPSBDZXNpdW1NYXRoOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuMy5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjMoeCwgeSwgeikgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMueiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogIH0KICB2YXIgZGlzdGFuY2VTY3JhdGNoLCBsZXJwU2NyYXRjaCwgYW5nbGVCZXR3ZWVuU2NyYXRjaCwgYW5nbGVCZXR3ZWVuU2NyYXRjaDIsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gsIHNjcmF0Y2hOLCBzY3JhdGNoSywgQ2FydGVzaWFuM19kZWZhdWx0OwogIHZhciBpbml0X0NhcnRlc2lhbjMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NhcnRlc2lhbjMuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBDYXJ0ZXNpYW4zLmZyb21TcGhlcmljYWwgPSBmdW5jdGlvbihzcGhlcmljYWwsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJpY2FsIiwgc3BoZXJpY2FsKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjbG9jayA9IHNwaGVyaWNhbC5jbG9jazsKICAgICAgICBjb25zdCBjb25lID0gc3BoZXJpY2FsLmNvbmU7CiAgICAgICAgY29uc3QgbWFnbml0dWRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3BoZXJpY2FsLm1hZ25pdHVkZSwgMSk7CiAgICAgICAgY29uc3QgcmFkaWFsID0gbWFnbml0dWRlICogTWF0aC5zaW4oY29uZSk7CiAgICAgICAgcmVzdWx0LnggPSByYWRpYWwgKiBNYXRoLmNvcyhjbG9jayk7CiAgICAgICAgcmVzdWx0LnkgPSByYWRpYWwgKiBNYXRoLnNpbihjbG9jayk7CiAgICAgICAgcmVzdWx0LnogPSBtYWduaXR1ZGUgKiBNYXRoLmNvcyhjb25lKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmZyb21FbGVtZW50cyA9IGZ1bmN0aW9uKHgsIHksIHosIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuMyh4LCB5LCB6KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5jbG9uZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuMyhjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tQ2FydGVzaWFuNCA9IENhcnRlc2lhbjMuY2xvbmU7CiAgICAgIENhcnRlc2lhbjMucGFja2VkTGVuZ3RoID0gMzsKICAgICAgQ2FydGVzaWFuMy5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLno7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC56ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogMzsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiAzIGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgQ2FydGVzaWFuMy5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiAzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDMpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSAzICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gMzsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gMzsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW4zLnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbUFycmF5ID0gQ2FydGVzaWFuMy51bnBhY2s7CiAgICAgIENhcnRlc2lhbjMubWF4aW11bUNvbXBvbmVudCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnksIGNhcnRlc2lhbjExLnopOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLm1pbmltdW1Db21wb25lbnQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIHJldHVybiBNYXRoLm1pbihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5taW5pbXVtQnlDb21wb25lbnQgPSBmdW5jdGlvbihmaXJzdCwgc2Vjb25kLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImZpcnN0IiwgZmlyc3QpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2Vjb25kIiwgc2Vjb25kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBNYXRoLm1pbihmaXJzdC54LCBzZWNvbmQueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLm1pbihmaXJzdC55LCBzZWNvbmQueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLm1pbihmaXJzdC56LCBzZWNvbmQueik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5tYXhpbXVtQnlDb21wb25lbnQgPSBmdW5jdGlvbihmaXJzdCwgc2Vjb25kLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImZpcnN0IiwgZmlyc3QpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2Vjb25kIiwgc2Vjb25kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBNYXRoLm1heChmaXJzdC54LCBzZWNvbmQueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLm1heChmaXJzdC55LCBzZWNvbmQueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLm1heChmaXJzdC56LCBzZWNvbmQueik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5jbGFtcCA9IGZ1bmN0aW9uKHZhbHVlLCBtaW4zLCBtYXgzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWluIiwgbWluMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXgiLCBtYXgzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS54LCBtaW4zLngsIG1heDMueCk7CiAgICAgICAgY29uc3QgeSA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS55LCBtaW4zLnksIG1heDMueSk7CiAgICAgICAgY29uc3QgeiA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS56LCBtaW4zLnosIG1heDMueik7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5tYWduaXR1ZGVTcXVhcmVkID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gY2FydGVzaWFuMTEueCAqIGNhcnRlc2lhbjExLnggKyBjYXJ0ZXNpYW4xMS55ICogY2FydGVzaWFuMTEueSArIGNhcnRlc2lhbjExLnogKiBjYXJ0ZXNpYW4xMS56OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLm1hZ25pdHVkZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydChDYXJ0ZXNpYW4zLm1hZ25pdHVkZVNxdWFyZWQoY2FydGVzaWFuMTEpKTsKICAgICAgfTsKICAgICAgZGlzdGFuY2VTY3JhdGNoID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgQ2FydGVzaWFuMy5kaXN0YW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4zLnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zLm1hZ25pdHVkZShkaXN0YW5jZVNjcmF0Y2gpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmRpc3RhbmNlU3F1YXJlZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4zLnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zLm1hZ25pdHVkZVNxdWFyZWQoZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5ub3JtYWxpemUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG1hZ25pdHVkZSA9IENhcnRlc2lhbjMubWFnbml0dWRlKGNhcnRlc2lhbjExKTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggLyBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEueiAvIG1hZ25pdHVkZTsKICAgICAgICBpZiAoaXNOYU4ocmVzdWx0LngpIHx8IGlzTmFOKHJlc3VsdC55KSB8fCBpc05hTihyZXN1bHQueikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJub3JtYWxpemVkIHJlc3VsdCBpcyBub3QgYSBudW1iZXIiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5kb3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQueCAqIHJpZ2h0LnggKyBsZWZ0LnkgKiByaWdodC55ICsgbGVmdC56ICogcmlnaHQuejsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5tdWx0aXBseUNvbXBvbmVudHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBsZWZ0LnggKiByaWdodC54OwogICAgICAgIHJlc3VsdC55ID0gbGVmdC55ICogcmlnaHQueTsKICAgICAgICByZXN1bHQueiA9IGxlZnQueiAqIHJpZ2h0Lno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5kaXZpZGVDb21wb25lbnRzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC8gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAvIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLyByaWdodC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICsgcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSArIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogKyByaWdodC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBsZWZ0LnggLSByaWdodC54OwogICAgICAgIHJlc3VsdC55ID0gbGVmdC55IC0gcmlnaHQueTsKICAgICAgICByZXN1bHQueiA9IGxlZnQueiAtIHJpZ2h0Lno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEueiAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEueiAvIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLm5lZ2F0ZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSAtY2FydGVzaWFuMTEueDsKICAgICAgICByZXN1bHQueSA9IC1jYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdC56ID0gLWNhcnRlc2lhbjExLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5hYnMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS55KTsKICAgICAgICByZXN1bHQueiA9IE1hdGguYWJzKGNhcnRlc2lhbjExLnopOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGxlcnBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgQ2FydGVzaWFuMy5sZXJwID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVuZCIsIGVuZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIENhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhcihlbmQsIHQsIGxlcnBTY3JhdGNoKTsKICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIoc3RhcnQsIDEgLSB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zLmFkZChsZXJwU2NyYXRjaCwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBhbmdsZUJldHdlZW5TY3JhdGNoID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICBDYXJ0ZXNpYW4zLmFuZ2xlQmV0d2VlbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4zLm5vcm1hbGl6ZShsZWZ0LCBhbmdsZUJldHdlZW5TY3JhdGNoKTsKICAgICAgICBDYXJ0ZXNpYW4zLm5vcm1hbGl6ZShyaWdodCwgYW5nbGVCZXR3ZWVuU2NyYXRjaDIpOwogICAgICAgIGNvbnN0IGNvc2luZSA9IENhcnRlc2lhbjMuZG90KGFuZ2xlQmV0d2VlblNjcmF0Y2gsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyKTsKICAgICAgICBjb25zdCBzaW5lID0gQ2FydGVzaWFuMy5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zLmNyb3NzKAogICAgICAgICAgICBhbmdsZUJldHdlZW5TY3JhdGNoLAogICAgICAgICAgICBhbmdsZUJldHdlZW5TY3JhdGNoMiwKICAgICAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaAogICAgICAgICAgKQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIE1hdGguYXRhbjIoc2luZSwgY29zaW5lKTsKICAgICAgfTsKICAgICAgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIENhcnRlc2lhbjMubW9zdE9ydGhvZ29uYWxBeGlzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBmID0gQ2FydGVzaWFuMy5ub3JtYWxpemUoY2FydGVzaWFuMTEsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gpOwogICAgICAgIENhcnRlc2lhbjMuYWJzKGYsIGYpOwogICAgICAgIGlmIChmLnggPD0gZi55KSB7CiAgICAgICAgICBpZiAoZi54IDw9IGYueikgewogICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zLmNsb25lKENhcnRlc2lhbjMuVU5JVF9YLCByZXN1bHQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuMy5jbG9uZShDYXJ0ZXNpYW4zLlVOSVRfWiwgcmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGYueSA8PSBmLnopIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjMuY2xvbmUoQ2FydGVzaWFuMy5VTklUX1ksIHJlc3VsdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjMuY2xvbmUoQ2FydGVzaWFuMy5VTklUX1osIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMucHJvamVjdFZlY3RvciA9IGZ1bmN0aW9uKGEzLCBiLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImEiLCBhMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJiIiwgYik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNjYWxhciA9IENhcnRlc2lhbjMuZG90KGEzLCBiKSAvIENhcnRlc2lhbjMuZG90KGIsIGIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIoYiwgc2NhbGFyLCByZXN1bHQpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnQueCA9PT0gcmlnaHQueCAmJiBsZWZ0LnkgPT09IHJpZ2h0LnkgJiYgbGVmdC56ID09PSByaWdodC56OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmVxdWFsc0FycmF5ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIGFycmF5LCBvZmZzZXQpIHsKICAgICAgICByZXR1cm4gY2FydGVzaWFuMTEueCA9PT0gYXJyYXlbb2Zmc2V0XSAmJiBjYXJ0ZXNpYW4xMS55ID09PSBhcnJheVtvZmZzZXQgKyAxXSAmJiBjYXJ0ZXNpYW4xMS56ID09PSBhcnJheVtvZmZzZXQgKyAyXTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC54LAogICAgICAgICAgcmlnaHQueCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LnksCiAgICAgICAgICByaWdodC55LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueiwKICAgICAgICAgIHJpZ2h0LnosCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmNyb3NzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGxlZnRYID0gbGVmdC54OwogICAgICAgIGNvbnN0IGxlZnRZID0gbGVmdC55OwogICAgICAgIGNvbnN0IGxlZnRaID0gbGVmdC56OwogICAgICAgIGNvbnN0IHJpZ2h0WCA9IHJpZ2h0Lng7CiAgICAgICAgY29uc3QgcmlnaHRZID0gcmlnaHQueTsKICAgICAgICBjb25zdCByaWdodFogPSByaWdodC56OwogICAgICAgIGNvbnN0IHggPSBsZWZ0WSAqIHJpZ2h0WiAtIGxlZnRaICogcmlnaHRZOwogICAgICAgIGNvbnN0IHkgPSBsZWZ0WiAqIHJpZ2h0WCAtIGxlZnRYICogcmlnaHRaOwogICAgICAgIGNvbnN0IHogPSBsZWZ0WCAqIHJpZ2h0WSAtIGxlZnRZICogcmlnaHRYOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWlkcG9pbnQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSAobGVmdC54ICsgcmlnaHQueCkgKiAwLjU7CiAgICAgICAgcmVzdWx0LnkgPSAobGVmdC55ICsgcmlnaHQueSkgKiAwLjU7CiAgICAgICAgcmVzdWx0LnogPSAobGVmdC56ICsgcmlnaHQueikgKiAwLjU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tRGVncmVlcyA9IGZ1bmN0aW9uKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxvbmdpdHVkZSIsIGxvbmdpdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsYXRpdHVkZSIsIGxhdGl0dWRlKTsKICAgICAgICBsb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGxvbmdpdHVkZSk7CiAgICAgICAgbGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGxhdGl0dWRlKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5mcm9tUmFkaWFucyhsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaE4gPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICBzY3JhdGNoSyA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIENhcnRlc2lhbjMuX2VsbGlwc29pZFJhZGlpU3F1YXJlZCA9IG5ldyBDYXJ0ZXNpYW4zKAogICAgICAgIDYzNzgxMzcgKiA2Mzc4MTM3LAogICAgICAgIDYzNzgxMzcgKiA2Mzc4MTM3LAogICAgICAgIDYzNTY3NTIzMTQyNDUxNzllLTkgKiA2MzU2NzUyMzE0MjQ1MTc5ZS05CiAgICAgICk7CiAgICAgIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsb25naXR1ZGUiLCBsb25naXR1ZGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGF0aXR1ZGUiLCBsYXRpdHVkZSk7CiAgICAgICAgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVpZ2h0LCAwKTsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSAhZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkgPyBDYXJ0ZXNpYW4zLl9lbGxpcHNvaWRSYWRpaVNxdWFyZWQgOiBlbGxpcHNvaWQucmFkaWlTcXVhcmVkOwogICAgICAgIGNvbnN0IGNvc0xhdGl0dWRlID0gTWF0aC5jb3MobGF0aXR1ZGUpOwogICAgICAgIHNjcmF0Y2hOLnggPSBjb3NMYXRpdHVkZSAqIE1hdGguY29zKGxvbmdpdHVkZSk7CiAgICAgICAgc2NyYXRjaE4ueSA9IGNvc0xhdGl0dWRlICogTWF0aC5zaW4obG9uZ2l0dWRlKTsKICAgICAgICBzY3JhdGNoTi56ID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgICAgIHNjcmF0Y2hOID0gQ2FydGVzaWFuMy5ub3JtYWxpemUoc2NyYXRjaE4sIHNjcmF0Y2hOKTsKICAgICAgICBDYXJ0ZXNpYW4zLm11bHRpcGx5Q29tcG9uZW50cyhyYWRpaVNxdWFyZWQsIHNjcmF0Y2hOLCBzY3JhdGNoSyk7CiAgICAgICAgY29uc3QgZ2FtbWEgPSBNYXRoLnNxcnQoQ2FydGVzaWFuMy5kb3Qoc2NyYXRjaE4sIHNjcmF0Y2hLKSk7CiAgICAgICAgc2NyYXRjaEsgPSBDYXJ0ZXNpYW4zLmRpdmlkZUJ5U2NhbGFyKHNjcmF0Y2hLLCBnYW1tYSwgc2NyYXRjaEspOwogICAgICAgIHNjcmF0Y2hOID0gQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKHNjcmF0Y2hOLCBoZWlnaHQsIHNjcmF0Y2hOKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5hZGQoc2NyYXRjaEssIHNjcmF0Y2hOLCByZXN1bHQpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmZyb21EZWdyZWVzQXJyYXkgPSBmdW5jdGlvbihjb29yZGluYXRlcywgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvb3JkaW5hdGVzIiwgY29vcmRpbmF0ZXMpOwogICAgICAgIGlmIChjb29yZGluYXRlcy5sZW5ndGggPCAyIHx8IGNvb3JkaW5hdGVzLmxlbmd0aCAlIDIgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAidGhlIG51bWJlciBvZiBjb29yZGluYXRlcyBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMiBhbmQgYXQgbGVhc3QgMiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNvb3JkaW5hdGVzLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjb29yZGluYXRlc1tpXTsKICAgICAgICAgIGNvbnN0IGxhdGl0dWRlID0gY29vcmRpbmF0ZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gMjsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW4zLmZyb21EZWdyZWVzKAogICAgICAgICAgICBsb25naXR1ZGUsCiAgICAgICAgICAgIGxhdGl0dWRlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHJlc3VsdFtpbmRleF0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbVJhZGlhbnNBcnJheSA9IGZ1bmN0aW9uKGNvb3JkaW5hdGVzLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY29vcmRpbmF0ZXMiLCBjb29yZGluYXRlcyk7CiAgICAgICAgaWYgKGNvb3JkaW5hdGVzLmxlbmd0aCA8IDIgfHwgY29vcmRpbmF0ZXMubGVuZ3RoICUgMiAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJ0aGUgbnVtYmVyIG9mIGNvb3JkaW5hdGVzIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAyIGFuZCBhdCBsZWFzdCAyIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY29vcmRpbmF0ZXMubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyAyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aCAvIDI7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGNvb3JkaW5hdGVzW2ldOwogICAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjb29yZGluYXRlc1tpICsgMV07CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAyOwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgIGxvbmdpdHVkZSwKICAgICAgICAgICAgbGF0aXR1ZGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcmVzdWx0W2luZGV4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tRGVncmVlc0FycmF5SGVpZ2h0cyA9IGZ1bmN0aW9uKGNvb3JkaW5hdGVzLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY29vcmRpbmF0ZXMiLCBjb29yZGluYXRlcyk7CiAgICAgICAgaWYgKGNvb3JkaW5hdGVzLmxlbmd0aCA8IDMgfHwgY29vcmRpbmF0ZXMubGVuZ3RoICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJ0aGUgbnVtYmVyIG9mIGNvb3JkaW5hdGVzIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzIGFuZCBhdCBsZWFzdCAzIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY29vcmRpbmF0ZXMubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyAzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aCAvIDM7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGNvb3JkaW5hdGVzW2ldOwogICAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjb29yZGluYXRlc1tpICsgMV07CiAgICAgICAgICBjb25zdCBoZWlnaHQgPSBjb29yZGluYXRlc1tpICsgMl07CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAzOwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjMuZnJvbURlZ3JlZXMoCiAgICAgICAgICAgIGxvbmdpdHVkZSwKICAgICAgICAgICAgbGF0aXR1ZGUsCiAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICByZXN1bHRbaW5kZXhdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zQXJyYXlIZWlnaHRzID0gZnVuY3Rpb24oY29vcmRpbmF0ZXMsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjb29yZGluYXRlcyIsIGNvb3JkaW5hdGVzKTsKICAgICAgICBpZiAoY29vcmRpbmF0ZXMubGVuZ3RoIDwgMyB8fCBjb29yZGluYXRlcy5sZW5ndGggJSAzICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgInRoZSBudW1iZXIgb2YgY29vcmRpbmF0ZXMgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDMgYW5kIGF0IGxlYXN0IDMiCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBjb29yZGluYXRlcy5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gMzsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY29vcmRpbmF0ZXNbaV07CiAgICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNvb3JkaW5hdGVzW2kgKyAxXTsKICAgICAgICAgIGNvbnN0IGhlaWdodCA9IGNvb3JkaW5hdGVzW2kgKyAyXTsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAvIDM7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gQ2FydGVzaWFuMy5mcm9tUmFkaWFucygKICAgICAgICAgICAgbG9uZ2l0dWRlLAogICAgICAgICAgICBsYXRpdHVkZSwKICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHJlc3VsdFtpbmRleF0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuWkVSTyA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjMoMCwgMCwgMCkpOwogICAgICBDYXJ0ZXNpYW4zLk9ORSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjMoMSwgMSwgMSkpOwogICAgICBDYXJ0ZXNpYW4zLlVOSVRfWCA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjMoMSwgMCwgMCkpOwogICAgICBDYXJ0ZXNpYW4zLlVOSVRfWSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjMoMCwgMSwgMCkpOwogICAgICBDYXJ0ZXNpYW4zLlVOSVRfWiA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjMoMCwgMCwgMSkpOwogICAgICBDYXJ0ZXNpYW4zLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjMuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zLmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcmlnaHQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpcy54fSwgJHt0aGlzLnl9LCAke3RoaXMuen0pYDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0ID0gQ2FydGVzaWFuMzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UuanMKICBmdW5jdGlvbiBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlKGNhcnRlc2lhbjExLCBvbmVPdmVyUmFkaWksIG9uZU92ZXJSYWRpaVNxdWFyZWQsIGNlbnRlclRvbGVyYW5jZVNxdWFyZWQsIHJlc3VsdCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYXJ0ZXNpYW4gaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvbmVPdmVyUmFkaWkpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvbmVPdmVyUmFkaWkgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvbmVPdmVyUmFkaWlTcXVhcmVkKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib25lT3ZlclJhZGlpU3F1YXJlZCBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNlbnRlclRvbGVyYW5jZVNxdWFyZWQpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjZW50ZXJUb2xlcmFuY2VTcXVhcmVkIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgY29uc3QgcG9zaXRpb25YID0gY2FydGVzaWFuMTEueDsKICAgIGNvbnN0IHBvc2l0aW9uWSA9IGNhcnRlc2lhbjExLnk7CiAgICBjb25zdCBwb3NpdGlvblogPSBjYXJ0ZXNpYW4xMS56OwogICAgY29uc3Qgb25lT3ZlclJhZGlpWCA9IG9uZU92ZXJSYWRpaS54OwogICAgY29uc3Qgb25lT3ZlclJhZGlpWSA9IG9uZU92ZXJSYWRpaS55OwogICAgY29uc3Qgb25lT3ZlclJhZGlpWiA9IG9uZU92ZXJSYWRpaS56OwogICAgY29uc3QgeDIgPSBwb3NpdGlvblggKiBwb3NpdGlvblggKiBvbmVPdmVyUmFkaWlYICogb25lT3ZlclJhZGlpWDsKICAgIGNvbnN0IHkyID0gcG9zaXRpb25ZICogcG9zaXRpb25ZICogb25lT3ZlclJhZGlpWSAqIG9uZU92ZXJSYWRpaVk7CiAgICBjb25zdCB6MiA9IHBvc2l0aW9uWiAqIHBvc2l0aW9uWiAqIG9uZU92ZXJSYWRpaVogKiBvbmVPdmVyUmFkaWlaOwogICAgY29uc3Qgc3F1YXJlZE5vcm0gPSB4MiArIHkyICsgejI7CiAgICBjb25zdCByYXRpbyA9IE1hdGguc3FydCgxIC8gc3F1YXJlZE5vcm0pOwogICAgY29uc3QgaW50ZXJzZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGNhcnRlc2lhbjExLAogICAgICByYXRpbywKICAgICAgc2NhbGVUb0dlb2RldGljU3VyZmFjZUludGVyc2VjdGlvbgogICAgKTsKICAgIGlmIChzcXVhcmVkTm9ybSA8IGNlbnRlclRvbGVyYW5jZVNxdWFyZWQpIHsKICAgICAgcmV0dXJuICFpc0Zpbml0ZShyYXRpbykgPyB2b2lkIDAgOiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW50ZXJzZWN0aW9uLCByZXN1bHQpOwogICAgfQogICAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFggPSBvbmVPdmVyUmFkaWlTcXVhcmVkLng7CiAgICBjb25zdCBvbmVPdmVyUmFkaWlTcXVhcmVkWSA9IG9uZU92ZXJSYWRpaVNxdWFyZWQueTsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVNxdWFyZWRaID0gb25lT3ZlclJhZGlpU3F1YXJlZC56OwogICAgY29uc3QgZ3JhZGllbnQgPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlR3JhZGllbnQ7CiAgICBncmFkaWVudC54ID0gaW50ZXJzZWN0aW9uLnggKiBvbmVPdmVyUmFkaWlTcXVhcmVkWCAqIDI7CiAgICBncmFkaWVudC55ID0gaW50ZXJzZWN0aW9uLnkgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWSAqIDI7CiAgICBncmFkaWVudC56ID0gaW50ZXJzZWN0aW9uLnogKiBvbmVPdmVyUmFkaWlTcXVhcmVkWiAqIDI7CiAgICBsZXQgbGFtYmRhID0gKDEgLSByYXRpbykgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGNhcnRlc2lhbjExKSAvICgwLjUgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGdyYWRpZW50KSk7CiAgICBsZXQgY29ycmVjdGlvbiA9IDA7CiAgICBsZXQgZnVuYzsKICAgIGxldCBkZW5vbWluYXRvcjsKICAgIGxldCB4TXVsdGlwbGllcjsKICAgIGxldCB5TXVsdGlwbGllcjsKICAgIGxldCB6TXVsdGlwbGllcjsKICAgIGxldCB4TXVsdGlwbGllcjI7CiAgICBsZXQgeU11bHRpcGxpZXIyOwogICAgbGV0IHpNdWx0aXBsaWVyMjsKICAgIGxldCB4TXVsdGlwbGllcjM7CiAgICBsZXQgeU11bHRpcGxpZXIzOwogICAgbGV0IHpNdWx0aXBsaWVyMzsKICAgIGRvIHsKICAgICAgbGFtYmRhIC09IGNvcnJlY3Rpb247CiAgICAgIHhNdWx0aXBsaWVyID0gMSAvICgxICsgbGFtYmRhICogb25lT3ZlclJhZGlpU3F1YXJlZFgpOwogICAgICB5TXVsdGlwbGllciA9IDEgLyAoMSArIGxhbWJkYSAqIG9uZU92ZXJSYWRpaVNxdWFyZWRZKTsKICAgICAgek11bHRpcGxpZXIgPSAxIC8gKDEgKyBsYW1iZGEgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWik7CiAgICAgIHhNdWx0aXBsaWVyMiA9IHhNdWx0aXBsaWVyICogeE11bHRpcGxpZXI7CiAgICAgIHlNdWx0aXBsaWVyMiA9IHlNdWx0aXBsaWVyICogeU11bHRpcGxpZXI7CiAgICAgIHpNdWx0aXBsaWVyMiA9IHpNdWx0aXBsaWVyICogek11bHRpcGxpZXI7CiAgICAgIHhNdWx0aXBsaWVyMyA9IHhNdWx0aXBsaWVyMiAqIHhNdWx0aXBsaWVyOwogICAgICB5TXVsdGlwbGllcjMgPSB5TXVsdGlwbGllcjIgKiB5TXVsdGlwbGllcjsKICAgICAgek11bHRpcGxpZXIzID0gek11bHRpcGxpZXIyICogek11bHRpcGxpZXI7CiAgICAgIGZ1bmMgPSB4MiAqIHhNdWx0aXBsaWVyMiArIHkyICogeU11bHRpcGxpZXIyICsgejIgKiB6TXVsdGlwbGllcjIgLSAxOwogICAgICBkZW5vbWluYXRvciA9IHgyICogeE11bHRpcGxpZXIzICogb25lT3ZlclJhZGlpU3F1YXJlZFggKyB5MiAqIHlNdWx0aXBsaWVyMyAqIG9uZU92ZXJSYWRpaVNxdWFyZWRZICsgejIgKiB6TXVsdGlwbGllcjMgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWjsKICAgICAgY29uc3QgZGVyaXZhdGl2ZSA9IC0yICogZGVub21pbmF0b3I7CiAgICAgIGNvcnJlY3Rpb24gPSBmdW5jIC8gZGVyaXZhdGl2ZTsKICAgIH0gd2hpbGUgKE1hdGguYWJzKGZ1bmMpID4gTWF0aF9kZWZhdWx0LkVQU0lMT04xMik7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICAgIHBvc2l0aW9uWCAqIHhNdWx0aXBsaWVyLAogICAgICAgIHBvc2l0aW9uWSAqIHlNdWx0aXBsaWVyLAogICAgICAgIHBvc2l0aW9uWiAqIHpNdWx0aXBsaWVyCiAgICAgICk7CiAgICB9CiAgICByZXN1bHQueCA9IHBvc2l0aW9uWCAqIHhNdWx0aXBsaWVyOwogICAgcmVzdWx0LnkgPSBwb3NpdGlvblkgKiB5TXVsdGlwbGllcjsKICAgIHJlc3VsdC56ID0gcG9zaXRpb25aICogek11bHRpcGxpZXI7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgc2NhbGVUb0dlb2RldGljU3VyZmFjZUludGVyc2VjdGlvbiwgc2NhbGVUb0dlb2RldGljU3VyZmFjZUdyYWRpZW50LCBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlX2RlZmF1bHQ7CiAgdmFyIGluaXRfc2NhbGVUb0dlb2RldGljU3VyZmFjZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvc2NhbGVUb0dlb2RldGljU3VyZmFjZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgc2NhbGVUb0dlb2RldGljU3VyZmFjZUludGVyc2VjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVUb0dlb2RldGljU3VyZmFjZUdyYWRpZW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlX2RlZmF1bHQgPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydG9ncmFwaGljLmpzCiAgZnVuY3Rpb24gQ2FydG9ncmFwaGljKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCkgewogICAgdGhpcy5sb25naXR1ZGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsb25naXR1ZGUsIDApOwogICAgdGhpcy5sYXRpdHVkZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGxhdGl0dWRlLCAwKTsKICAgIHRoaXMuaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVpZ2h0LCAwKTsKICB9CiAgdmFyIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTiwgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQLCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY0gsIENhcnRvZ3JhcGhpY19kZWZhdWx0OwogIHZhciBpbml0X0NhcnRvZ3JhcGhpYyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydG9ncmFwaGljLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UoKTsKICAgICAgQ2FydG9ncmFwaGljLmZyb21SYWRpYW5zID0gZnVuY3Rpb24obG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxvbmdpdHVkZSIsIGxvbmdpdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsYXRpdHVkZSIsIGxhdGl0dWRlKTsKICAgICAgICBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoZWlnaHQsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibG9uZ2l0dWRlIiwgbG9uZ2l0dWRlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxhdGl0dWRlIiwgbGF0aXR1ZGUpOwogICAgICAgIGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobG9uZ2l0dWRlKTsKICAgICAgICBsYXRpdHVkZSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobGF0aXR1ZGUpOwogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpOwogICAgICB9OwogICAgICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNIID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBDYXJ0b2dyYXBoaWMuX2VsbGlwc29pZE9uZU92ZXJSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoCiAgICAgICAgMSAvIDYzNzgxMzcsCiAgICAgICAgMSAvIDYzNzgxMzcsCiAgICAgICAgMSAvIDYzNTY3NTIzMTQyNDUxNzllLTkKICAgICAgKTsKICAgICAgQ2FydG9ncmFwaGljLl9lbGxpcHNvaWRPbmVPdmVyUmFkaWlTcXVhcmVkID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICAxIC8gKDYzNzgxMzcgKiA2Mzc4MTM3KSwKICAgICAgICAxIC8gKDYzNzgxMzcgKiA2Mzc4MTM3KSwKICAgICAgICAxIC8gKDYzNTY3NTIzMTQyNDUxNzllLTkgKiA2MzU2NzUyMzE0MjQ1MTc5ZS05KQogICAgICApOwogICAgICBDYXJ0b2dyYXBoaWMuX2VsbGlwc29pZENlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE7CiAgICAgIENhcnRvZ3JhcGhpYy5mcm9tQ2FydGVzaWFuID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3Qgb25lT3ZlclJhZGlpID0gZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkgPyBlbGxpcHNvaWQub25lT3ZlclJhZGlpIDogQ2FydG9ncmFwaGljLl9lbGxpcHNvaWRPbmVPdmVyUmFkaWk7CiAgICAgICAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZCA9IGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpID8gZWxsaXBzb2lkLm9uZU92ZXJSYWRpaVNxdWFyZWQgOiBDYXJ0b2dyYXBoaWMuX2VsbGlwc29pZE9uZU92ZXJSYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgY2VudGVyVG9sZXJhbmNlU3F1YXJlZCA9IGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpID8gZWxsaXBzb2lkLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkIDogQ2FydG9ncmFwaGljLl9lbGxpcHNvaWRDZW50ZXJUb2xlcmFuY2VTcXVhcmVkOwogICAgICAgIGNvbnN0IHAgPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlX2RlZmF1bHQoCiAgICAgICAgICBjYXJ0ZXNpYW4xMSwKICAgICAgICAgIG9uZU92ZXJSYWRpaSwKICAgICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQsCiAgICAgICAgICBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkLAogICAgICAgICAgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgbGV0IG4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKAogICAgICAgICAgcCwKICAgICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQsCiAgICAgICAgICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04KICAgICAgICApOwogICAgICAgIG4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG4sIG4pOwogICAgICAgIGNvbnN0IGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2FydGVzaWFuMTEsIHAsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSCk7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gTWF0aC5hdGFuMihuLnksIG4ueCk7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBNYXRoLmFzaW4obi56KTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBNYXRoX2RlZmF1bHQuc2lnbihDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGgsIGNhcnRlc2lhbjExKSkgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMudG9DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydG9ncmFwaGljIiwgY2FydG9ncmFwaGljMik7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlLAogICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIuaGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLmNsb25lID0gZnVuY3Rpb24oY2FydG9ncmFwaGljMiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydG9ncmFwaGljMikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKAogICAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSwKICAgICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgICAgY2FydG9ncmFwaGljMi5oZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZTsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBjYXJ0b2dyYXBoaWMyLmhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC5sb25naXR1ZGUgPT09IHJpZ2h0LmxvbmdpdHVkZSAmJiBsZWZ0LmxhdGl0dWRlID09PSByaWdodC5sYXRpdHVkZSAmJiBsZWZ0LmhlaWdodCA9PT0gcmlnaHQuaGVpZ2h0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0LmxvbmdpdHVkZSAtIHJpZ2h0LmxvbmdpdHVkZSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0LmxhdGl0dWRlIC0gcmlnaHQubGF0aXR1ZGUpIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5oZWlnaHQgLSByaWdodC5oZWlnaHQpIDw9IGVwc2lsb247CiAgICAgIH07CiAgICAgIENhcnRvZ3JhcGhpYy5aRVJPID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydG9ncmFwaGljKDAsIDAsIDApKTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gQ2FydG9ncmFwaGljLmVxdWFsc0Vwc2lsb24odGhpcywgcmlnaHQsIGVwc2lsb24pOwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLmxvbmdpdHVkZX0sICR7dGhpcy5sYXRpdHVkZX0sICR7dGhpcy5oZWlnaHR9KWA7CiAgICAgIH07CiAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0ID0gQ2FydG9ncmFwaGljOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuMi5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjIoeCwgeSkgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICB9CiAgdmFyIGRpc3RhbmNlU2NyYXRjaDIsIGxlcnBTY3JhdGNoMiwgYW5nbGVCZXR3ZWVuU2NyYXRjaDMsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyMiwgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDIsIENhcnRlc2lhbjJfZGVmYXVsdDsKICB2YXIgaW5pdF9DYXJ0ZXNpYW4yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DYXJ0ZXNpYW4yLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ2FydGVzaWFuMi5mcm9tRWxlbWVudHMgPSBmdW5jdGlvbih4LCB5LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjIoeCwgeSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5jbG9uZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuMihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmZyb21DYXJ0ZXNpYW4zID0gQ2FydGVzaWFuMi5jbG9uZTsKICAgICAgQ2FydGVzaWFuMi5mcm9tQ2FydGVzaWFuNCA9IENhcnRlc2lhbjIuY2xvbmU7CiAgICAgIENhcnRlc2lhbjIucGFja2VkTGVuZ3RoID0gMjsKICAgICAgQ2FydGVzaWFuMi5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSBsZW5ndGggKiAyOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShyZXN1bHRMZW5ndGgpOwogICAgICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiSWYgcmVzdWx0IGlzIGEgdHlwZWQgYXJyYXksIGl0IG11c3QgaGF2ZSBleGFjdGx5IGFycmF5Lmxlbmd0aCAqIDIgZWxlbWVudHMiCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAocmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gcmVzdWx0TGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4yLnBhY2soYXJyYXlbaV0sIHJlc3VsdCwgaSAqIDIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnVucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImFycmF5Lmxlbmd0aCIsIGFycmF5Lmxlbmd0aCwgMik7CiAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCAlIDIgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAyOwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjIudW5wYWNrKGFycmF5LCBpLCByZXN1bHRbaW5kZXhdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5mcm9tQXJyYXkgPSBDYXJ0ZXNpYW4yLnVucGFjazsKICAgICAgQ2FydGVzaWFuMi5tYXhpbXVtQ29tcG9uZW50ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWluaW11bUNvbXBvbmVudCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnkpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm1pbmltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWluKGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWluKGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm1heGltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWF4KGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWF4KGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmNsYW1wID0gZnVuY3Rpb24odmFsdWUsIG1pbjMsIG1heDMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtaW4iLCBtaW4zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1heCIsIG1heDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB4ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLngsIG1pbjMueCwgbWF4My54KTsKICAgICAgICBjb25zdCB5ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLnksIG1pbjMueSwgbWF4My55KTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWFnbml0dWRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KENhcnRlc2lhbjIubWFnbml0dWRlU3F1YXJlZChjYXJ0ZXNpYW4xMSkpOwogICAgICB9OwogICAgICBkaXN0YW5jZVNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjIoKTsKICAgICAgQ2FydGVzaWFuMi5kaXN0YW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4yLnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gyKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMi5tYWduaXR1ZGUoZGlzdGFuY2VTY3JhdGNoMik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZGlzdGFuY2VTcXVhcmVkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENhcnRlc2lhbjIuc3VidHJhY3QobGVmdCwgcmlnaHQsIGRpc3RhbmNlU2NyYXRjaDIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLm1hZ25pdHVkZVNxdWFyZWQoZGlzdGFuY2VTY3JhdGNoMik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubm9ybWFsaXplID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYWduaXR1ZGUgPSBDYXJ0ZXNpYW4yLm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIG1hZ25pdHVkZTsKICAgICAgICBpZiAoaXNOYU4ocmVzdWx0LngpIHx8IGlzTmFOKHJlc3VsdC55KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5vcm1hbGl6ZWQgcmVzdWx0IGlzIG5vdCBhIG51bWJlciIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmRvdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICByZXR1cm4gbGVmdC54ICogcmlnaHQueCArIGxlZnQueSAqIHJpZ2h0Lnk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuY3Jvc3MgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQueCAqIHJpZ2h0LnkgLSBsZWZ0LnkgKiByaWdodC54OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm11bHRpcGx5Q29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAqIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKiByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZGl2aWRlQ29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAvIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLyByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICsgcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSArIHJpZ2h0Lnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5zdWJ0cmFjdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAtIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLSByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55IC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubmVnYXRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1jYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gLWNhcnRlc2lhbjExLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5hYnMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBsZXJwU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLmxlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuMi5tdWx0aXBseUJ5U2NhbGFyKGVuZCwgdCwgbGVycFNjcmF0Y2gyKTsKICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4yLm11bHRpcGx5QnlTY2FsYXIoc3RhcnQsIDEgLSB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmFkZChsZXJwU2NyYXRjaDIsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBhbmdsZUJldHdlZW5TY3JhdGNoMjIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLmFuZ2xlQmV0d2VlbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4yLm5vcm1hbGl6ZShsZWZ0LCBhbmdsZUJldHdlZW5TY3JhdGNoMyk7CiAgICAgICAgQ2FydGVzaWFuMi5ub3JtYWxpemUocmlnaHQsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyMik7CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5hY29zQ2xhbXBlZCgKICAgICAgICAgIENhcnRlc2lhbjIuZG90KGFuZ2xlQmV0d2VlblNjcmF0Y2gzLCBhbmdsZUJldHdlZW5TY3JhdGNoMjIpCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLm1vc3RPcnRob2dvbmFsQXhpcyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZiA9IENhcnRlc2lhbjIubm9ybWFsaXplKGNhcnRlc2lhbjExLCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoMik7CiAgICAgICAgQ2FydGVzaWFuMi5hYnMoZiwgZik7CiAgICAgICAgaWYgKGYueCA8PSBmLnkpIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjIuY2xvbmUoQ2FydGVzaWFuMi5VTklUX1gsIHJlc3VsdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjIuY2xvbmUoQ2FydGVzaWFuMi5VTklUX1ksIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC54ID09PSByaWdodC54ICYmIGxlZnQueSA9PT0gcmlnaHQueTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5lcXVhbHNBcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggPT09IGFycmF5W29mZnNldF0gJiYgY2FydGVzaWFuMTEueSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV07CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueCwKICAgICAgICAgIHJpZ2h0LngsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC55LAogICAgICAgICAgcmlnaHQueSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuWkVSTyA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMCwgMCkpOwogICAgICBDYXJ0ZXNpYW4yLk9ORSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMSwgMSkpOwogICAgICBDYXJ0ZXNpYW4yLlVOSVRfWCA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMSwgMCkpOwogICAgICBDYXJ0ZXNpYW4yLlVOSVRfWSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMCwgMSkpOwogICAgICBDYXJ0ZXNpYW4yLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjIuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcmlnaHQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpcy54fSwgJHt0aGlzLnl9KWA7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjJfZGVmYXVsdCA9IENhcnRlc2lhbjI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWQuanMKICBmdW5jdGlvbiBpbml0aWFsaXplKGVsbGlwc29pZCwgeCwgeSwgeikgewogICAgeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgeSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHksIDApOwogICAgeiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIngiLCB4LCAwKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJ5IiwgeSwgMCk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygieiIsIHosIDApOwogICAgZWxsaXBzb2lkLl9yYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgeSwgeik7CiAgICBlbGxpcHNvaWQuX3JhZGlpU3F1YXJlZCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCAqIHgsIHkgKiB5LCB6ICogeik7CiAgICBlbGxpcHNvaWQuX3JhZGlpVG9UaGVGb3VydGggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICB4ICogeCAqIHggKiB4LAogICAgICB5ICogeSAqIHkgKiB5LAogICAgICB6ICogeiAqIHogKiB6CiAgICApOwogICAgZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICB4ID09PSAwID8gMCA6IDEgLyB4LAogICAgICB5ID09PSAwID8gMCA6IDEgLyB5LAogICAgICB6ID09PSAwID8gMCA6IDEgLyB6CiAgICApOwogICAgZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWlTcXVhcmVkID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgeCA9PT0gMCA/IDAgOiAxIC8gKHggKiB4KSwKICAgICAgeSA9PT0gMCA/IDAgOiAxIC8gKHkgKiB5KSwKICAgICAgeiA9PT0gMCA/IDAgOiAxIC8gKHogKiB6KQogICAgKTsKICAgIGVsbGlwc29pZC5fbWluaW11bVJhZGl1cyA9IE1hdGgubWluKHgsIHksIHopOwogICAgZWxsaXBzb2lkLl9tYXhpbXVtUmFkaXVzID0gTWF0aC5tYXgoeCwgeSwgeik7CiAgICBlbGxpcHNvaWQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE7CiAgICBpZiAoZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQueiAhPT0gMCkgewogICAgICBlbGxpcHNvaWQuX3NxdWFyZWRYT3ZlclNxdWFyZWRaID0gZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQueCAvIGVsbGlwc29pZC5fcmFkaWlTcXVhcmVkLno7CiAgICB9CiAgfQogIGZ1bmN0aW9uIEVsbGlwc29pZCh4LCB5LCB6KSB7CiAgICB0aGlzLl9yYWRpaSA9IHZvaWQgMDsKICAgIHRoaXMuX3JhZGlpU3F1YXJlZCA9IHZvaWQgMDsKICAgIHRoaXMuX3JhZGlpVG9UaGVGb3VydGggPSB2b2lkIDA7CiAgICB0aGlzLl9vbmVPdmVyUmFkaWkgPSB2b2lkIDA7CiAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkID0gdm9pZCAwOwogICAgdGhpcy5fbWluaW11bVJhZGl1cyA9IHZvaWQgMDsKICAgIHRoaXMuX21heGltdW1SYWRpdXMgPSB2b2lkIDA7CiAgICB0aGlzLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkID0gdm9pZCAwOwogICAgdGhpcy5fc3F1YXJlZFhPdmVyU3F1YXJlZFogPSB2b2lkIDA7CiAgICBpbml0aWFsaXplKHRoaXMsIHgsIHksIHopOwogIH0KICBmdW5jdGlvbiBnYXVzc0xlZ2VuZHJlUXVhZHJhdHVyZShhMywgYiwgZnVuYykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhIiwgYTMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJiIiwgYik7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJmdW5jIiwgZnVuYyk7CiAgICBjb25zdCB4TWVhbiA9IDAuNSAqIChiICsgYTMpOwogICAgY29uc3QgeFJhbmdlID0gMC41ICogKGIgLSBhMyk7CiAgICBsZXQgc3VtID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7CiAgICAgIGNvbnN0IGR4ID0geFJhbmdlICogYWJzY2lzc2FzW2ldOwogICAgICBzdW0gKz0gd2VpZ2h0c1tpXSAqIChmdW5jKHhNZWFuICsgZHgpICsgZnVuYyh4TWVhbiAtIGR4KSk7CiAgICB9CiAgICBzdW0gKj0geFJhbmdlOwogICAgcmV0dXJuIHN1bTsKICB9CiAgdmFyIGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuTm9ybWFsLCBjYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbkssIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTjIsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUDIsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSDIsIHNjcmF0Y2hFbmRwb2ludCwgYWJzY2lzc2FzLCB3ZWlnaHRzLCBFbGxpcHNvaWRfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNvaWQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZC5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSByYWRpaSBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRlc2lhbjN9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgcmFkaWk6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yYWRpaTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHNxdWFyZWQgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHJhZGlpU3F1YXJlZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JhZGlpU3F1YXJlZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHJhZGlpIG9mIHRoZSBlbGxpcHNvaWQgcmFpc2UgdG8gdGhlIGZvdXJ0aCBwb3dlci4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHJhZGlpVG9UaGVGb3VydGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yYWRpaVRvVGhlRm91cnRoOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBvbmUgb3ZlciB0aGUgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIG9uZU92ZXJSYWRpaTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29uZU92ZXJSYWRpaTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgb25lIG92ZXIgdGhlIHNxdWFyZWQgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbWluaW11bSByYWRpdXMgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgbWluaW11bVJhZGl1czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21pbmltdW1SYWRpdXM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBtYXhpbXVtIHJhZGl1cyBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBtYXhpbXVtUmFkaXVzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWF4aW11bVJhZGl1czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBFbGxpcHNvaWQuY2xvbmUgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJhZGlpID0gZWxsaXBzb2lkLl9yYWRpaTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZChyYWRpaS54LCByYWRpaS55LCByYWRpaS56KTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJhZGlpLCByZXN1bHQuX3JhZGlpKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQsIHJlc3VsdC5fcmFkaWlTcXVhcmVkKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVRvVGhlRm91cnRoLCByZXN1bHQuX3JhZGlpVG9UaGVGb3VydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaSwgcmVzdWx0Ll9vbmVPdmVyUmFkaWkpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaVNxdWFyZWQsIHJlc3VsdC5fb25lT3ZlclJhZGlpU3F1YXJlZCk7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtUmFkaXVzID0gZWxsaXBzb2lkLl9taW5pbXVtUmFkaXVzOwogICAgICAgIHJlc3VsdC5fbWF4aW11bVJhZGl1cyA9IGVsbGlwc29pZC5fbWF4aW11bVJhZGl1czsKICAgICAgICByZXN1bHQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBlbGxpcHNvaWQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLmZyb21DYXJ0ZXNpYW4zID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBFbGxpcHNvaWQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBpbml0aWFsaXplKHJlc3VsdCwgY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLldHUzg0ID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgRWxsaXBzb2lkKDYzNzgxMzcsIDYzNzgxMzcsIDYzNTY3NTIzMTQyNDUxNzllLTkpCiAgICAgICk7CiAgICAgIEVsbGlwc29pZC5VTklUX1NQSEVSRSA9IE9iamVjdC5mcmVlemUobmV3IEVsbGlwc29pZCgxLCAxLCAxKSk7CiAgICAgIEVsbGlwc29pZC5NT09OID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgRWxsaXBzb2lkKAogICAgICAgICAgTWF0aF9kZWZhdWx0LkxVTkFSX1JBRElVUywKICAgICAgICAgIE1hdGhfZGVmYXVsdC5MVU5BUl9SQURJVVMsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuTFVOQVJfUkFESVVTCiAgICAgICAgKQogICAgICApOwogICAgICBFbGxpcHNvaWQuX2RlZmF1bHQgPSBFbGxpcHNvaWQuV0dTODQ7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZCwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBkZWZhdWx0IGVsbGlwc29pZCB1c2VkIHdoZW4gbm90IG90aGVyd2lzZSBzcGVjaWZpZWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZAogICAgICAgICAqIEB0eXBlIHtFbGxpcHNvaWR9CiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgKiBDZXNpdW0uRWxsaXBzb2lkLmRlZmF1bHQgPSBDZXNpdW0uRWxsaXBzb2lkLk1PT047CiAgICAgICAgICoKICAgICAgICAgKiAvLyBBcG9sbG8gMTEgbGFuZGluZyBzaXRlCiAgICAgICAgICogY29uc3QgcG9zaXRpb24gPSBDZXNpdW0uQ2FydGVzaWFuMy5mcm9tUmFkaWFucygKICAgICAgICAgKiAgIDAuNjc0MTYsCiAgICAgICAgICogICAyMy40NzMxNSwKICAgICAgICAgKiApOwogICAgICAgICAqLwogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBFbGxpcHNvaWQuX2RlZmF1bHQ7CiAgICAgICAgICB9LAogICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgICAgICBFbGxpcHNvaWQuX2RlZmF1bHQgPSB2YWx1ZTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Ll9lbGxpcHNvaWRSYWRpaVNxdWFyZWQgPSB2YWx1ZS5yYWRpaVNxdWFyZWQ7CiAgICAgICAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0Ll9lbGxpcHNvaWRPbmVPdmVyUmFkaWkgPSB2YWx1ZS5vbmVPdmVyUmFkaWk7CiAgICAgICAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0Ll9lbGxpcHNvaWRPbmVPdmVyUmFkaWlTcXVhcmVkID0gdmFsdWUub25lT3ZlclJhZGlpU3F1YXJlZDsKICAgICAgICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuX2VsbGlwc29pZENlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSB2YWx1ZS5fY2VudGVyVG9sZXJhbmNlU3F1YXJlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEVsbGlwc29pZC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucGFja2VkTGVuZ3RoID0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgRWxsaXBzb2lkLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9yYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHJldHVybiBFbGxpcHNvaWQuZnJvbUNhcnRlc2lhbjMocmFkaWksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuZ2VvY2VudHJpY1N1cmZhY2VOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpYzIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydG9ncmFwaGljIiwgY2FydG9ncmFwaGljMik7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGU7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlOwogICAgICAgIGNvbnN0IGNvc0xhdGl0dWRlID0gTWF0aC5jb3MobGF0aXR1ZGUpOwogICAgICAgIGNvbnN0IHggPSBjb3NMYXRpdHVkZSAqIE1hdGguY29zKGxvbmdpdHVkZSk7CiAgICAgICAgY29uc3QgeSA9IGNvc0xhdGl0dWRlICogTWF0aC5zaW4obG9uZ2l0dWRlKTsKICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBpZiAoaXNOYU4oY2FydGVzaWFuMTEueCkgfHwgaXNOYU4oY2FydGVzaWFuMTEueSkgfHwgaXNOYU4oY2FydGVzaWFuMTEueikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYXJ0ZXNpYW4gaGFzIGEgTmFOIGNvbXBvbmVudCIpOwogICAgICAgIH0KICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oY2FydGVzaWFuMTEsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKAogICAgICAgICAgY2FydGVzaWFuMTEsCiAgICAgICAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbksgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBuID0gY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW5Ob3JtYWw7CiAgICAgICAgY29uc3QgayA9IGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuSzsKICAgICAgICB0aGlzLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyhjYXJ0b2dyYXBoaWMyLCBuKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKHRoaXMuX3JhZGlpU3F1YXJlZCwgbiwgayk7CiAgICAgICAgY29uc3QgZ2FtbWEgPSBNYXRoLnNxcnQoQ2FydGVzaWFuM19kZWZhdWx0LmRvdChuLCBrKSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRpdmlkZUJ5U2NhbGFyKGssIGdhbW1hLCBrKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBjYXJ0b2dyYXBoaWMyLmhlaWdodCwgbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChrLCBuLCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmNhcnRvZ3JhcGhpY0FycmF5VG9DYXJ0ZXNpYW5BcnJheSA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpY3MsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydG9ncmFwaGljcyIsIGNhcnRvZ3JhcGhpY3MpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRvZ3JhcGhpY3MubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSB0aGlzLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvZ3JhcGhpY3NbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgcCA9IHRoaXMuc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4xMSwgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQMik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG4gPSB0aGlzLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04yKTsKICAgICAgICBjb25zdCBoID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNhcnRlc2lhbjExLCBwLCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY0gyKTsKICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBNYXRoLmF0YW4yKG4ueSwgbi54KTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IE1hdGguYXNpbihuLnopOwogICAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGhfZGVmYXVsdC5zaWduKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoaCwgY2FydGVzaWFuMTEpKSAqIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoaCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IGxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5jYXJ0ZXNpYW5BcnJheVRvQ2FydG9ncmFwaGljQXJyYXkgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBjYXJ0ZXNpYW5zLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VfZGVmYXVsdCgKICAgICAgICAgIGNhcnRlc2lhbjExLAogICAgICAgICAgdGhpcy5fb25lT3ZlclJhZGlpLAogICAgICAgICAgdGhpcy5fb25lT3ZlclJhZGlpU3F1YXJlZCwKICAgICAgICAgIHRoaXMuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLnNjYWxlVG9HZW9jZW50cmljU3VyZmFjZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9uWCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgcG9zaXRpb25ZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCBwb3NpdGlvblogPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIGNvbnN0IG9uZU92ZXJSYWRpaVNxdWFyZWQgPSB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogICAgICAgIGNvbnN0IGJldGEgPSAxIC8gTWF0aC5zcXJ0KAogICAgICAgICAgcG9zaXRpb25YICogcG9zaXRpb25YICogb25lT3ZlclJhZGlpU3F1YXJlZC54ICsgcG9zaXRpb25ZICogcG9zaXRpb25ZICogb25lT3ZlclJhZGlpU3F1YXJlZC55ICsgcG9zaXRpb25aICogcG9zaXRpb25aICogb25lT3ZlclJhZGlpU3F1YXJlZC56CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoY2FydGVzaWFuMTEsIGJldGEsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlID0gZnVuY3Rpb24ocG9zaXRpb24sIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUNvbXBvbmVudHMocG9zaXRpb24sIHRoaXMuX29uZU92ZXJSYWRpaSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS50cmFuc2Zvcm1Qb3NpdGlvbkZyb21TY2FsZWRTcGFjZSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKHBvc2l0aW9uLCB0aGlzLl9yYWRpaSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiB0aGlzID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHModGhpcy5fcmFkaWksIHJpZ2h0Ll9yYWRpaSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmFkaWkudG9TdHJpbmcoKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5nZXRTdXJmYWNlTm9ybWFsSW50ZXJzZWN0aW9uV2l0aFpBeGlzID0gZnVuY3Rpb24ocG9zaXRpb24sIGJ1ZmZlciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwb3NpdGlvbiIsIHBvc2l0aW9uKTsKICAgICAgICBpZiAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5fcmFkaWkueCwKICAgICAgICAgIHRoaXMuX3JhZGlpLnksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJFbGxpcHNvaWQgbXVzdCBiZSBhbiBlbGxpcHNvaWQgb2YgcmV2b2x1dGlvbiAocmFkaWkueCA9PSByYWRpaS55KSIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiRWxsaXBzb2lkLnJhZGlpLnoiLCB0aGlzLl9yYWRpaS56LCAwKTsKICAgICAgICBidWZmZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChidWZmZXIsIDApOwogICAgICAgIGNvbnN0IHNxdWFyZWRYT3ZlclNxdWFyZWRaID0gdGhpcy5fc3F1YXJlZFhPdmVyU3F1YXJlZFo7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IDA7CiAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgIHJlc3VsdC56ID0gcG9zaXRpb24ueiAqICgxIC0gc3F1YXJlZFhPdmVyU3F1YXJlZFopOwogICAgICAgIGlmIChNYXRoLmFicyhyZXN1bHQueikgPj0gdGhpcy5fcmFkaWkueiAtIGJ1ZmZlcikgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEVuZHBvaW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdldExvY2FsQ3VydmF0dXJlID0gZnVuY3Rpb24oc3VyZmFjZVBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN1cmZhY2VQb3NpdGlvbiIsIHN1cmZhY2VQb3NpdGlvbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwcmltZVZlcnRpY2FsRW5kcG9pbnQgPSB0aGlzLmdldFN1cmZhY2VOb3JtYWxJbnRlcnNlY3Rpb25XaXRoWkF4aXMoCiAgICAgICAgICBzdXJmYWNlUG9zaXRpb24sCiAgICAgICAgICAwLAogICAgICAgICAgc2NyYXRjaEVuZHBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcmltZVZlcnRpY2FsUmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKAogICAgICAgICAgc3VyZmFjZVBvc2l0aW9uLAogICAgICAgICAgcHJpbWVWZXJ0aWNhbEVuZHBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCByYWRpdXNSYXRpbyA9IHRoaXMubWluaW11bVJhZGl1cyAqIHByaW1lVmVydGljYWxSYWRpdXMgLyB0aGlzLm1heGltdW1SYWRpdXMgKiogMjsKICAgICAgICBjb25zdCBtZXJpZGlvbmFsUmFkaXVzID0gcHJpbWVWZXJ0aWNhbFJhZGl1cyAqIHJhZGl1c1JhdGlvICoqIDI7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgICAgICAxIC8gcHJpbWVWZXJ0aWNhbFJhZGl1cywKICAgICAgICAgIDEgLyBtZXJpZGlvbmFsUmFkaXVzLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgYWJzY2lzc2FzID0gWwogICAgICAgIDAuMTQ4ODc0MzM4OTgxNjMsCiAgICAgICAgMC40MzMzOTUzOTQxMjkyNSwKICAgICAgICAwLjY3OTQwOTU2ODI5OTAyLAogICAgICAgIDAuODY1MDYzMzY2Njg4OTgsCiAgICAgICAgMC45NzM5MDY1Mjg1MTcxNywKICAgICAgICAwCiAgICAgIF07CiAgICAgIHdlaWdodHMgPSBbCiAgICAgICAgMC4yOTU1MjQyMjQ3MTQ3NSwKICAgICAgICAwLjI2OTI2NjcxOTMwOTk5LAogICAgICAgIDAuMjE5MDg2MzYyNTE1OTgsCiAgICAgICAgMC4xNDk0NTEzNDkxNTA1OCwKICAgICAgICAwLjA2NjY3MTM0NDMwODY4NCwKICAgICAgICAwCiAgICAgIF07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuc3VyZmFjZUFyZWEgPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgbWluTG9uZ2l0dWRlID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgbGV0IG1heExvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGNvbnN0IG1pbkxhdGl0dWRlID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICAgIGNvbnN0IG1heExhdGl0dWRlID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIHdoaWxlIChtYXhMb25naXR1ZGUgPCBtaW5Mb25naXR1ZGUpIHsKICAgICAgICAgIG1heExvbmdpdHVkZSArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSB0aGlzLl9yYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgYTIyID0gcmFkaWlTcXVhcmVkLng7CiAgICAgICAgY29uc3QgYjIgPSByYWRpaVNxdWFyZWQueTsKICAgICAgICBjb25zdCBjMiA9IHJhZGlpU3F1YXJlZC56OwogICAgICAgIGNvbnN0IGEyYjIgPSBhMjIgKiBiMjsKICAgICAgICByZXR1cm4gZ2F1c3NMZWdlbmRyZVF1YWRyYXR1cmUobWluTGF0aXR1ZGUsIG1heExhdGl0dWRlLCBmdW5jdGlvbihsYXQpIHsKICAgICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguY29zKGxhdCk7CiAgICAgICAgICBjb25zdCBjb3NQaGkgPSBNYXRoLnNpbihsYXQpOwogICAgICAgICAgcmV0dXJuIE1hdGguY29zKGxhdCkgKiBnYXVzc0xlZ2VuZHJlUXVhZHJhdHVyZShtaW5Mb25naXR1ZGUsIG1heExvbmdpdHVkZSwgZnVuY3Rpb24obG9uKSB7CiAgICAgICAgICAgIGNvbnN0IGNvc1RoZXRhID0gTWF0aC5jb3MobG9uKTsKICAgICAgICAgICAgY29uc3Qgc2luVGhldGEgPSBNYXRoLnNpbihsb24pOwogICAgICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KAogICAgICAgICAgICAgIGEyYjIgKiBjb3NQaGkgKiBjb3NQaGkgKyBjMiAqIChiMiAqIGNvc1RoZXRhICogY29zVGhldGEgKyBhMjIgKiBzaW5UaGV0YSAqIHNpblRoZXRhKSAqIHNpblBoaSAqIHNpblBoaQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZF9kZWZhdWx0ID0gRWxsaXBzb2lkOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvZ3JhcGhpY1Byb2plY3Rpb24uanMKICBmdW5jdGlvbiBHZW9ncmFwaGljUHJvamVjdGlvbihlbGxpcHNvaWQpIHsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCk7CiAgICB0aGlzLl9zZW1pbWFqb3JBeGlzID0gdGhpcy5fZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICB0aGlzLl9vbmVPdmVyU2VtaW1ham9yQXhpcyA9IDEgLyB0aGlzLl9zZW1pbWFqb3JBeGlzOwogIH0KICB2YXIgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvZ3JhcGhpY1Byb2plY3Rpb24uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoR2VvZ3JhcGhpY1Byb2plY3Rpb24ucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUge0BsaW5rIEVsbGlwc29pZH0uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgR2VvZ3JhcGhpY1Byb2plY3Rpb24ucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBHZW9ncmFwaGljUHJvamVjdGlvbi5wcm90b3R5cGUucHJvamVjdCA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpYzIsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHNlbWltYWpvckF4aXMgPSB0aGlzLl9zZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IHggPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSAqIHNlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgeSA9IGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUgKiBzZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IHogPSBjYXJ0b2dyYXBoaWMyLmhlaWdodDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB5LCB6KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1Byb2plY3Rpb24ucHJvdG90eXBlLnVucHJvamVjdCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYXJ0ZXNpYW4gaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb25lT3ZlckVhcnRoU2VtaW1ham9yQXhpcyA9IHRoaXMuX29uZU92ZXJTZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGNhcnRlc2lhbjExLnggKiBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGxhdGl0dWRlID0gY2FydGVzaWFuMTEueSAqIG9uZU92ZXJFYXJ0aFNlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gY2FydGVzaWFuMTEuejsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0ID0gR2VvZ3JhcGhpY1Byb2plY3Rpb247CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnNlY3QuanMKICB2YXIgSW50ZXJzZWN0LCBJbnRlcnNlY3RfZGVmYXVsdDsKICB2YXIgaW5pdF9JbnRlcnNlY3QgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ludGVyc2VjdC5qcyIoKSB7CiAgICAgIEludGVyc2VjdCA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBSZXByZXNlbnRzIHRoYXQgYW4gb2JqZWN0IGlzIG5vdCBjb250YWluZWQgd2l0aGluIHRoZSBmcnVzdHVtLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBPVVRTSURFOiAtMSwKICAgICAgICAvKioKICAgICAgICAgKiBSZXByZXNlbnRzIHRoYXQgYW4gb2JqZWN0IGludGVyc2VjdHMgb25lIG9mIHRoZSBmcnVzdHVtJ3MgcGxhbmVzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBJTlRFUlNFQ1RJTkc6IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogUmVwcmVzZW50cyB0aGF0IGFuIG9iamVjdCBpcyBmdWxseSB3aXRoaW4gdGhlIGZydXN0dW0uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIElOU0lERTogMQogICAgICB9OwogICAgICBJbnRlcnNlY3RfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoSW50ZXJzZWN0KTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ludGVydmFsLmpzCiAgZnVuY3Rpb24gSW50ZXJ2YWwoc3RhcnQsIHN0b3ApIHsKICAgIHRoaXMuc3RhcnQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydCwgMCk7CiAgICB0aGlzLnN0b3AgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdG9wLCAwKTsKICB9CiAgdmFyIEludGVydmFsX2RlZmF1bHQ7CiAgdmFyIGluaXRfSW50ZXJ2YWwgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ludGVydmFsLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgSW50ZXJ2YWxfZGVmYXVsdCA9IEludGVydmFsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0cml4My5qcwogIGZ1bmN0aW9uIE1hdHJpeDMoY29sdW1uMFJvdzAsIGNvbHVtbjFSb3cwLCBjb2x1bW4yUm93MCwgY29sdW1uMFJvdzEsIGNvbHVtbjFSb3cxLCBjb2x1bW4yUm93MSwgY29sdW1uMFJvdzIsIGNvbHVtbjFSb3cyLCBjb2x1bW4yUm93MikgewogICAgdGhpc1swXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cwLCAwKTsKICAgIHRoaXNbMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MSwgMCk7CiAgICB0aGlzWzJdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzIsIDApOwogICAgdGhpc1szXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cwLCAwKTsKICAgIHRoaXNbNF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MSwgMCk7CiAgICB0aGlzWzVdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzIsIDApOwogICAgdGhpc1s2XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjJSb3cwLCAwKTsKICAgIHRoaXNbN10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4yUm93MSwgMCk7CiAgICB0aGlzWzhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzIsIDApOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRnJvYmVuaXVzTm9ybShtYXRyaXgpIHsKICAgIGxldCBub3JtID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgOTsgKytpKSB7CiAgICAgIGNvbnN0IHRlbXAgPSBtYXRyaXhbaV07CiAgICAgIG5vcm0gKz0gdGVtcCAqIHRlbXA7CiAgICB9CiAgICByZXR1cm4gTWF0aC5zcXJ0KG5vcm0pOwogIH0KICBmdW5jdGlvbiBvZmZEaWFnb25hbEZyb2Jlbml1c05vcm0obWF0cml4KSB7CiAgICBsZXQgbm9ybSA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7ICsraSkgewogICAgICBjb25zdCB0ZW1wID0gbWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KGNvbFZhbFtpXSwgcm93VmFsW2ldKV07CiAgICAgIG5vcm0gKz0gMiAqIHRlbXAgKiB0ZW1wOwogICAgfQogICAgcmV0dXJuIE1hdGguc3FydChub3JtKTsKICB9CiAgZnVuY3Rpb24gc2h1ckRlY29tcG9zaXRpb24obWF0cml4LCByZXN1bHQpIHsKICAgIGNvbnN0IHRvbGVyYW5jZSA9IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTU7CiAgICBsZXQgbWF4RGlhZ29uYWwgPSAwOwogICAgbGV0IHJvdEF4aXMyID0gMTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgKytpKSB7CiAgICAgIGNvbnN0IHRlbXAgPSBNYXRoLmFicygKICAgICAgICBtYXRyaXhbTWF0cml4My5nZXRFbGVtZW50SW5kZXgoY29sVmFsW2ldLCByb3dWYWxbaV0pXQogICAgICApOwogICAgICBpZiAodGVtcCA+IG1heERpYWdvbmFsKSB7CiAgICAgICAgcm90QXhpczIgPSBpOwogICAgICAgIG1heERpYWdvbmFsID0gdGVtcDsKICAgICAgfQogICAgfQogICAgbGV0IGMgPSAxOwogICAgbGV0IHMgPSAwOwogICAgY29uc3QgcCA9IHJvd1ZhbFtyb3RBeGlzMl07CiAgICBjb25zdCBxID0gY29sVmFsW3JvdEF4aXMyXTsKICAgIGlmIChNYXRoLmFicyhtYXRyaXhbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocSwgcCldKSA+IHRvbGVyYW5jZSkgewogICAgICBjb25zdCBxcSA9IG1hdHJpeFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChxLCBxKV07CiAgICAgIGNvbnN0IHBwID0gbWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHAsIHApXTsKICAgICAgY29uc3QgcXAgPSBtYXRyaXhbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocSwgcCldOwogICAgICBjb25zdCB0YXUgPSAocXEgLSBwcCkgLyAyIC8gcXA7CiAgICAgIGxldCB0OwogICAgICBpZiAodGF1IDwgMCkgewogICAgICAgIHQgPSAtMSAvICgtdGF1ICsgTWF0aC5zcXJ0KDEgKyB0YXUgKiB0YXUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0ID0gMSAvICh0YXUgKyBNYXRoLnNxcnQoMSArIHRhdSAqIHRhdSkpOwogICAgICB9CiAgICAgIGMgPSAxIC8gTWF0aC5zcXJ0KDEgKyB0ICogdCk7CiAgICAgIHMgPSB0ICogYzsKICAgIH0KICAgIHJlc3VsdCA9IE1hdHJpeDMuY2xvbmUoTWF0cml4My5JREVOVElUWSwgcmVzdWx0KTsKICAgIHJlc3VsdFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChwLCBwKV0gPSByZXN1bHRbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocSwgcSldID0gYzsKICAgIHJlc3VsdFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChxLCBwKV0gPSBzOwogICAgcmVzdWx0W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHAsIHEpXSA9IC1zOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHNjYWxlU2NyYXRjaDEsIHNjYWxlU2NyYXRjaDIsIHNjcmF0Y2hDb2x1bW4sIHNjYWxlU2NyYXRjaDMsIHNjYWxlU2NyYXRjaDQsIHNjYWxlU2NyYXRjaDUsIHJvd1ZhbCwgY29sVmFsLCBqTWF0cml4LCBqTWF0cml4VHJhbnNwb3NlLCBzY3JhdGNoVHJhbnNwb3NlTWF0cml4LCBNYXRyaXgzX2RlZmF1bHQ7CiAgdmFyIGluaXRfTWF0cml4MyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0cml4My5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBNYXRyaXgzLnBhY2tlZExlbmd0aCA9IDk7CiAgICAgIE1hdHJpeDMucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzBdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMl07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzNdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs0XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbNV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzZdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs3XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbOF07CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBNYXRyaXgzLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4MygpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzJdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbM10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs0XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzVdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbNl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs3XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzhdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSBsZW5ndGggKiA5OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShyZXN1bHRMZW5ndGgpOwogICAgICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiSWYgcmVzdWx0IGlzIGEgdHlwZWQgYXJyYXksIGl0IG11c3QgaGF2ZSBleGFjdGx5IGFycmF5Lmxlbmd0aCAqIDkgZWxlbWVudHMiCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAocmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gcmVzdWx0TGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBNYXRyaXgzLnBhY2soYXJyYXlbaV0sIHJlc3VsdCwgaSAqIDkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnVucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImFycmF5Lmxlbmd0aCIsIGFycmF5Lmxlbmd0aCwgOSk7CiAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCAlIDkgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDkuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gOSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyA5OwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSA5KSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyA5OwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IE1hdHJpeDMudW5wYWNrKGFycmF5LCBpLCByZXN1bHRbaW5kZXhdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5jbG9uZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWF0cml4KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKAogICAgICAgICAgICBtYXRyaXhbMF0sCiAgICAgICAgICAgIG1hdHJpeFszXSwKICAgICAgICAgICAgbWF0cml4WzZdLAogICAgICAgICAgICBtYXRyaXhbMV0sCiAgICAgICAgICAgIG1hdHJpeFs0XSwKICAgICAgICAgICAgbWF0cml4WzddLAogICAgICAgICAgICBtYXRyaXhbMl0sCiAgICAgICAgICAgIG1hdHJpeFs1XSwKICAgICAgICAgICAgbWF0cml4WzhdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21BcnJheSA9IE1hdHJpeDMudW5wYWNrOwogICAgICBNYXRyaXgzLmZyb21Db2x1bW5NYWpvckFycmF5ID0gZnVuY3Rpb24odmFsdWVzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlcyIsIHZhbHVlcyk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDMuY2xvbmUodmFsdWVzLCByZXN1bHQpOwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3dNYWpvckFycmF5ID0gZnVuY3Rpb24odmFsdWVzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlcyIsIHZhbHVlcyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKAogICAgICAgICAgICB2YWx1ZXNbMF0sCiAgICAgICAgICAgIHZhbHVlc1sxXSwKICAgICAgICAgICAgdmFsdWVzWzJdLAogICAgICAgICAgICB2YWx1ZXNbM10sCiAgICAgICAgICAgIHZhbHVlc1s0XSwKICAgICAgICAgICAgdmFsdWVzWzVdLAogICAgICAgICAgICB2YWx1ZXNbNl0sCiAgICAgICAgICAgIHZhbHVlc1s3XSwKICAgICAgICAgICAgdmFsdWVzWzhdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSB2YWx1ZXNbMF07CiAgICAgICAgcmVzdWx0WzFdID0gdmFsdWVzWzNdOwogICAgICAgIHJlc3VsdFsyXSA9IHZhbHVlc1s2XTsKICAgICAgICByZXN1bHRbM10gPSB2YWx1ZXNbMV07CiAgICAgICAgcmVzdWx0WzRdID0gdmFsdWVzWzRdOwogICAgICAgIHJlc3VsdFs1XSA9IHZhbHVlc1s3XTsKICAgICAgICByZXN1bHRbNl0gPSB2YWx1ZXNbMl07CiAgICAgICAgcmVzdWx0WzddID0gdmFsdWVzWzVdOwogICAgICAgIHJlc3VsdFs4XSA9IHZhbHVlc1s4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21RdWF0ZXJuaW9uID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgY29uc3QgeDIgPSBxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLng7CiAgICAgICAgY29uc3QgeHkgPSBxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLnk7CiAgICAgICAgY29uc3QgeHogPSBxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLno7CiAgICAgICAgY29uc3QgeHcgPSBxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLnc7CiAgICAgICAgY29uc3QgeTIgPSBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLnk7CiAgICAgICAgY29uc3QgeXogPSBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLno7CiAgICAgICAgY29uc3QgeXcgPSBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLnc7CiAgICAgICAgY29uc3QgejIgPSBxdWF0ZXJuaW9uLnogKiBxdWF0ZXJuaW9uLno7CiAgICAgICAgY29uc3QgencgPSBxdWF0ZXJuaW9uLnogKiBxdWF0ZXJuaW9uLnc7CiAgICAgICAgY29uc3QgdzIgPSBxdWF0ZXJuaW9uLncgKiBxdWF0ZXJuaW9uLnc7CiAgICAgICAgY29uc3QgbTAwID0geDIgLSB5MiAtIHoyICsgdzI7CiAgICAgICAgY29uc3QgbTAxID0gMiAqICh4eSAtIHp3KTsKICAgICAgICBjb25zdCBtMDIgPSAyICogKHh6ICsgeXcpOwogICAgICAgIGNvbnN0IG0xMCA9IDIgKiAoeHkgKyB6dyk7CiAgICAgICAgY29uc3QgbTExID0gLXgyICsgeTIgLSB6MiArIHcyOwogICAgICAgIGNvbnN0IG0xMiA9IDIgKiAoeXogLSB4dyk7CiAgICAgICAgY29uc3QgbTIwID0gMiAqICh4eiAtIHl3KTsKICAgICAgICBjb25zdCBtMjEgPSAyICogKHl6ICsgeHcpOwogICAgICAgIGNvbnN0IG0yMiA9IC14MiAtIHkyICsgejIgKyB3MjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMobTAwLCBtMDEsIG0wMiwgbTEwLCBtMTEsIG0xMiwgbTIwLCBtMjEsIG0yMik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IG0wMDsKICAgICAgICByZXN1bHRbMV0gPSBtMTA7CiAgICAgICAgcmVzdWx0WzJdID0gbTIwOwogICAgICAgIHJlc3VsdFszXSA9IG0wMTsKICAgICAgICByZXN1bHRbNF0gPSBtMTE7CiAgICAgICAgcmVzdWx0WzVdID0gbTIxOwogICAgICAgIHJlc3VsdFs2XSA9IG0wMjsKICAgICAgICByZXN1bHRbN10gPSBtMTI7CiAgICAgICAgcmVzdWx0WzhdID0gbTIyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZnJvbUhlYWRpbmdQaXRjaFJvbGwgPSBmdW5jdGlvbihoZWFkaW5nUGl0Y2hSb2xsLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImhlYWRpbmdQaXRjaFJvbGwiLCBoZWFkaW5nUGl0Y2hSb2xsKTsKICAgICAgICBjb25zdCBjb3NUaGV0YSA9IE1hdGguY29zKC1oZWFkaW5nUGl0Y2hSb2xsLnBpdGNoKTsKICAgICAgICBjb25zdCBjb3NQc2kgPSBNYXRoLmNvcygtaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nKTsKICAgICAgICBjb25zdCBjb3NQaGkgPSBNYXRoLmNvcyhoZWFkaW5nUGl0Y2hSb2xsLnJvbGwpOwogICAgICAgIGNvbnN0IHNpblRoZXRhID0gTWF0aC5zaW4oLWhlYWRpbmdQaXRjaFJvbGwucGl0Y2gpOwogICAgICAgIGNvbnN0IHNpblBzaSA9IE1hdGguc2luKC1oZWFkaW5nUGl0Y2hSb2xsLmhlYWRpbmcpOwogICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguc2luKGhlYWRpbmdQaXRjaFJvbGwucm9sbCk7CiAgICAgICAgY29uc3QgbTAwID0gY29zVGhldGEgKiBjb3NQc2k7CiAgICAgICAgY29uc3QgbTAxID0gLWNvc1BoaSAqIHNpblBzaSArIHNpblBoaSAqIHNpblRoZXRhICogY29zUHNpOwogICAgICAgIGNvbnN0IG0wMiA9IHNpblBoaSAqIHNpblBzaSArIGNvc1BoaSAqIHNpblRoZXRhICogY29zUHNpOwogICAgICAgIGNvbnN0IG0xMCA9IGNvc1RoZXRhICogc2luUHNpOwogICAgICAgIGNvbnN0IG0xMSA9IGNvc1BoaSAqIGNvc1BzaSArIHNpblBoaSAqIHNpblRoZXRhICogc2luUHNpOwogICAgICAgIGNvbnN0IG0xMiA9IC1zaW5QaGkgKiBjb3NQc2kgKyBjb3NQaGkgKiBzaW5UaGV0YSAqIHNpblBzaTsKICAgICAgICBjb25zdCBtMjAgPSAtc2luVGhldGE7CiAgICAgICAgY29uc3QgbTIxID0gc2luUGhpICogY29zVGhldGE7CiAgICAgICAgY29uc3QgbTIyID0gY29zUGhpICogY29zVGhldGE7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKG0wMCwgbTAxLCBtMDIsIG0xMCwgbTExLCBtMTIsIG0yMCwgbTIxLCBtMjIpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtMDA7CiAgICAgICAgcmVzdWx0WzFdID0gbTEwOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMDsKICAgICAgICByZXN1bHRbM10gPSBtMDE7CiAgICAgICAgcmVzdWx0WzRdID0gbTExOwogICAgICAgIHJlc3VsdFs1XSA9IG0yMTsKICAgICAgICByZXN1bHRbNl0gPSBtMDI7CiAgICAgICAgcmVzdWx0WzddID0gbTEyOwogICAgICAgIHJlc3VsdFs4XSA9IG0yMjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21TY2FsZSA9IGZ1bmN0aW9uKHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MyhzY2FsZS54LCAwLCAwLCAwLCBzY2FsZS55LCAwLCAwLCAwLCBzY2FsZS56KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSBzY2FsZS55OwogICAgICAgIHJlc3VsdFs1XSA9IDA7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IHNjYWxlLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tVW5pZm9ybVNjYWxlID0gZnVuY3Rpb24oc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKHNjYWxlLCAwLCAwLCAwLCBzY2FsZSwgMCwgMCwgMCwgc2NhbGUpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBzY2FsZTsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSBzY2FsZTsKICAgICAgICByZXN1bHRbNV0gPSAwOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBzY2FsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Dcm9zc1Byb2R1Y3QgPSBmdW5jdGlvbih2ZWN0b3IsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmVjdG9yIiwgdmVjdG9yKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIC12ZWN0b3IueiwKICAgICAgICAgICAgdmVjdG9yLnksCiAgICAgICAgICAgIHZlY3Rvci56LAogICAgICAgICAgICAwLAogICAgICAgICAgICAtdmVjdG9yLngsCiAgICAgICAgICAgIC12ZWN0b3IueSwKICAgICAgICAgICAgdmVjdG9yLngsCiAgICAgICAgICAgIDAKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IDA7CiAgICAgICAgcmVzdWx0WzFdID0gdmVjdG9yLno7CiAgICAgICAgcmVzdWx0WzJdID0gLXZlY3Rvci55OwogICAgICAgIHJlc3VsdFszXSA9IC12ZWN0b3IuejsKICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgIHJlc3VsdFs1XSA9IHZlY3Rvci54OwogICAgICAgIHJlc3VsdFs2XSA9IHZlY3Rvci55OwogICAgICAgIHJlc3VsdFs3XSA9IC12ZWN0b3IueDsKICAgICAgICByZXN1bHRbOF0gPSAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZnJvbVJvdGF0aW9uWCA9IGZ1bmN0aW9uKGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFuZ2xlIiwgYW5nbGUpOwogICAgICAgIGNvbnN0IGNvc0FuZ2xlID0gTWF0aC5jb3MoYW5nbGUpOwogICAgICAgIGNvbnN0IHNpbkFuZ2xlID0gTWF0aC5zaW4oYW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICAgICAgMSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgY29zQW5nbGUsCiAgICAgICAgICAgIC1zaW5BbmdsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2luQW5nbGUsCiAgICAgICAgICAgIGNvc0FuZ2xlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSAxOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IGNvc0FuZ2xlOwogICAgICAgIHJlc3VsdFs1XSA9IHNpbkFuZ2xlOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gLXNpbkFuZ2xlOwogICAgICAgIHJlc3VsdFs4XSA9IGNvc0FuZ2xlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZnJvbVJvdGF0aW9uWSA9IGZ1bmN0aW9uKGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFuZ2xlIiwgYW5nbGUpOwogICAgICAgIGNvbnN0IGNvc0FuZ2xlID0gTWF0aC5jb3MoYW5nbGUpOwogICAgICAgIGNvbnN0IHNpbkFuZ2xlID0gTWF0aC5zaW4oYW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICAgICAgY29zQW5nbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHNpbkFuZ2xlLAogICAgICAgICAgICAwLAogICAgICAgICAgICAxLAogICAgICAgICAgICAwLAogICAgICAgICAgICAtc2luQW5nbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIGNvc0FuZ2xlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBjb3NBbmdsZTsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IC1zaW5BbmdsZTsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDE7CiAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICByZXN1bHRbNl0gPSBzaW5BbmdsZTsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IGNvc0FuZ2xlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZnJvbVJvdGF0aW9uWiA9IGZ1bmN0aW9uKGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFuZ2xlIiwgYW5nbGUpOwogICAgICAgIGNvbnN0IGNvc0FuZ2xlID0gTWF0aC5jb3MoYW5nbGUpOwogICAgICAgIGNvbnN0IHNpbkFuZ2xlID0gTWF0aC5zaW4oYW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICAgICAgY29zQW5nbGUsCiAgICAgICAgICAgIC1zaW5BbmdsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2luQW5nbGUsCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAxCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBjb3NBbmdsZTsKICAgICAgICByZXN1bHRbMV0gPSBzaW5BbmdsZTsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IC1zaW5BbmdsZTsKICAgICAgICByZXN1bHRbNF0gPSBjb3NBbmdsZTsKICAgICAgICByZXN1bHRbNV0gPSAwOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMudG9BcnJheSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgIG1hdHJpeFswXSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbMl0sCiAgICAgICAgICAgIG1hdHJpeFszXSwKICAgICAgICAgICAgbWF0cml4WzRdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs2XSwKICAgICAgICAgICAgbWF0cml4WzddLAogICAgICAgICAgICBtYXRyaXhbOF0KICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZ2V0RWxlbWVudEluZGV4ID0gZnVuY3Rpb24oY29sdW1uLCByb3cpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygicm93Iiwgcm93LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygicm93Iiwgcm93LCAyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAyKTsKICAgICAgICByZXR1cm4gY29sdW1uICogMyArIHJvdzsKICAgICAgfTsKICAgICAgTWF0cml4My5nZXRDb2x1bW4gPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMzsKICAgICAgICBjb25zdCB4ID0gbWF0cml4W3N0YXJ0SW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbc3RhcnRJbmRleCArIDFdOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbc3RhcnRJbmRleCArIDJdOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuc2V0Q29sdW1uID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQgPSBNYXRyaXgzLmNsb25lKG1hdHJpeCwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzdGFydEluZGV4ID0gaW5kZXggKiAzOwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4XSA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0W3N0YXJ0SW5kZXggKyAxXSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0W3N0YXJ0SW5kZXggKyAyXSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5nZXRSb3cgPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFtpbmRleF07CiAgICAgICAgY29uc3QgeSA9IG1hdHJpeFtpbmRleCArIDNdOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbaW5kZXggKyA2XTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnNldFJvdyA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4My5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0W2luZGV4ICsgM10gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdFtpbmRleCArIDZdID0gY2FydGVzaWFuMTEuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXgzLnNldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nU2NhbGUgPSBNYXRyaXgzLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMSk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZS54IC8gZXhpc3RpbmdTY2FsZS54OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9ZID0gc2NhbGUueSAvIGV4aXN0aW5nU2NhbGUueTsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWiA9IHNjYWxlLnogLyBleGlzdGluZ1NjYWxlLno7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4My5zZXRVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDMuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gyKTsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWCA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS54OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9ZID0gc2NhbGUgLyBleGlzdGluZ1NjYWxlLnk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ogPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUuejsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoQ29sdW1uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXgzLmdldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzBdLCBtYXRyaXhbMV0sIG1hdHJpeFsyXSwgc2NyYXRjaENvbHVtbikKICAgICAgICApOwogICAgICAgIHJlc3VsdC55ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzNdLCBtYXRyaXhbNF0sIG1hdHJpeFs1XSwgc2NyYXRjaENvbHVtbikKICAgICAgICApOwogICAgICAgIHJlc3VsdC56ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzZdLCBtYXRyaXhbN10sIG1hdHJpeFs4XSwgc2NyYXRjaENvbHVtbikKICAgICAgICApOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuZ2V0TWF4aW11bVNjYWxlID0gZnVuY3Rpb24obWF0cml4KSB7CiAgICAgICAgTWF0cml4My5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDMpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUNvbXBvbmVudChzY2FsZVNjcmF0Y2gzKTsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4My5zZXRSb3RhdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgcm90YXRpb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBNYXRyaXgzLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoNCk7CiAgICAgICAgcmVzdWx0WzBdID0gcm90YXRpb25bMF0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IHJvdGF0aW9uWzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzNdID0gcm90YXRpb25bM10gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzRdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSByb3RhdGlvbls1XSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gcm90YXRpb25bNl0gKiBzY2FsZS56OwogICAgICAgIHJlc3VsdFs3XSA9IHJvdGF0aW9uWzddICogc2NhbGUuejsKICAgICAgICByZXN1bHRbOF0gPSByb3RhdGlvbls4XSAqIHNjYWxlLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4My5nZXRSb3RhdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDMuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2g1KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdIC8gc2NhbGUueDsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gLyBzY2FsZS55OwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAvIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl0gLyBzY2FsZS56OwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XSAvIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdIC8gc2NhbGUuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLm11bHRpcGx5ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gbGVmdFswXSAqIHJpZ2h0WzBdICsgbGVmdFszXSAqIHJpZ2h0WzFdICsgbGVmdFs2XSAqIHJpZ2h0WzJdOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cxID0gbGVmdFsxXSAqIHJpZ2h0WzBdICsgbGVmdFs0XSAqIHJpZ2h0WzFdICsgbGVmdFs3XSAqIHJpZ2h0WzJdOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cyID0gbGVmdFsyXSAqIHJpZ2h0WzBdICsgbGVmdFs1XSAqIHJpZ2h0WzFdICsgbGVmdFs4XSAqIHJpZ2h0WzJdOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbGVmdFswXSAqIHJpZ2h0WzNdICsgbGVmdFszXSAqIHJpZ2h0WzRdICsgbGVmdFs2XSAqIHJpZ2h0WzVdOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbGVmdFsxXSAqIHJpZ2h0WzNdICsgbGVmdFs0XSAqIHJpZ2h0WzRdICsgbGVmdFs3XSAqIHJpZ2h0WzVdOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cyID0gbGVmdFsyXSAqIHJpZ2h0WzNdICsgbGVmdFs1XSAqIHJpZ2h0WzRdICsgbGVmdFs4XSAqIHJpZ2h0WzVdOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cwID0gbGVmdFswXSAqIHJpZ2h0WzZdICsgbGVmdFszXSAqIHJpZ2h0WzddICsgbGVmdFs2XSAqIHJpZ2h0WzhdOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cxID0gbGVmdFsxXSAqIHJpZ2h0WzZdICsgbGVmdFs0XSAqIHJpZ2h0WzddICsgbGVmdFs3XSAqIHJpZ2h0WzhdOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gbGVmdFsyXSAqIHJpZ2h0WzZdICsgbGVmdFs1XSAqIHJpZ2h0WzddICsgbGVmdFs4XSAqIHJpZ2h0WzhdOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IGNvbHVtbjBSb3cxOwogICAgICAgIHJlc3VsdFsyXSA9IGNvbHVtbjBSb3cyOwogICAgICAgIHJlc3VsdFszXSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFs0XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cyOwogICAgICAgIHJlc3VsdFs2XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs3XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gKyByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdICsgcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSArIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gKyByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdICsgcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSArIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gKyByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddICsgcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSArIHJpZ2h0WzhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbGVmdFswXSAtIHJpZ2h0WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IGxlZnRbMV0gLSByaWdodFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBsZWZ0WzJdIC0gcmlnaHRbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbGVmdFszXSAtIHJpZ2h0WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IGxlZnRbNF0gLSByaWdodFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBsZWZ0WzVdIC0gcmlnaHRbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbGVmdFs2XSAtIHJpZ2h0WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IGxlZnRbN10gLSByaWdodFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBsZWZ0WzhdIC0gcmlnaHRbOF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5tdWx0aXBseUJ5VmVjdG9yID0gZnVuY3Rpb24obWF0cml4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB2WCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgdlkgPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIGNvbnN0IHZaID0gY2FydGVzaWFuMTEuejsKICAgICAgICBjb25zdCB4ID0gbWF0cml4WzBdICogdlggKyBtYXRyaXhbM10gKiB2WSArIG1hdHJpeFs2XSAqIHZaOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbMV0gKiB2WCArIG1hdHJpeFs0XSAqIHZZICsgbWF0cml4WzddICogdlo7CiAgICAgICAgY29uc3QgeiA9IG1hdHJpeFsyXSAqIHZYICsgbWF0cml4WzVdICogdlkgKyBtYXRyaXhbOF0gKiB2WjsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLm11bHRpcGx5QnlTY2FsYXIgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5tdWx0aXBseUJ5U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdICogc2NhbGUuejsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsZS56OwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAqIHNjYWxlLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5tdWx0aXBseUJ5VW5pZm9ybVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAqIHNjYWxlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubmVnYXRlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IC1tYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gLW1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSAtbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IC1tYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gLW1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSAtbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IC1tYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gLW1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSAtbWF0cml4WzhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMudHJhbnNwb3NlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gbWF0cml4WzBdOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cxID0gbWF0cml4WzNdOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cyID0gbWF0cml4WzZdOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbWF0cml4WzFdOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbWF0cml4WzRdOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cyID0gbWF0cml4WzddOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cwID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cxID0gbWF0cml4WzVdOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gbWF0cml4WzhdOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IGNvbHVtbjBSb3cxOwogICAgICAgIHJlc3VsdFsyXSA9IGNvbHVtbjBSb3cyOwogICAgICAgIHJlc3VsdFszXSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFs0XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cyOwogICAgICAgIHJlc3VsdFs2XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs3XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHJvd1ZhbCA9IFsxLCAwLCAwXTsKICAgICAgY29sVmFsID0gWzIsIDIsIDFdOwogICAgICBqTWF0cml4ID0gbmV3IE1hdHJpeDMoKTsKICAgICAgak1hdHJpeFRyYW5zcG9zZSA9IG5ldyBNYXRyaXgzKCk7CiAgICAgIE1hdHJpeDMuY29tcHV0ZUVpZ2VuRGVjb21wb3NpdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIGNvbnN0IHRvbGVyYW5jZSA9IE1hdGhfZGVmYXVsdC5FUFNJTE9OMjA7CiAgICAgICAgY29uc3QgbWF4U3dlZXBzID0gMTA7CiAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICBsZXQgc3dlZXAgPSAwOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IHt9OwogICAgICAgIH0KICAgICAgICBjb25zdCB1bml0YXJ5TWF0cml4ID0gcmVzdWx0LnVuaXRhcnkgPSBNYXRyaXgzLmNsb25lKAogICAgICAgICAgTWF0cml4My5JREVOVElUWSwKICAgICAgICAgIHJlc3VsdC51bml0YXJ5CiAgICAgICAgKTsKICAgICAgICBjb25zdCBkaWFnTWF0cml4ID0gcmVzdWx0LmRpYWdvbmFsID0gTWF0cml4My5jbG9uZShtYXRyaXgsIHJlc3VsdC5kaWFnb25hbCk7CiAgICAgICAgY29uc3QgZXBzaWxvbiA9IHRvbGVyYW5jZSAqIGNvbXB1dGVGcm9iZW5pdXNOb3JtKGRpYWdNYXRyaXgpOwogICAgICAgIHdoaWxlIChzd2VlcCA8IG1heFN3ZWVwcyAmJiBvZmZEaWFnb25hbEZyb2Jlbml1c05vcm0oZGlhZ01hdHJpeCkgPiBlcHNpbG9uKSB7CiAgICAgICAgICBzaHVyRGVjb21wb3NpdGlvbihkaWFnTWF0cml4LCBqTWF0cml4KTsKICAgICAgICAgIE1hdHJpeDMudHJhbnNwb3NlKGpNYXRyaXgsIGpNYXRyaXhUcmFuc3Bvc2UpOwogICAgICAgICAgTWF0cml4My5tdWx0aXBseShkaWFnTWF0cml4LCBqTWF0cml4LCBkaWFnTWF0cml4KTsKICAgICAgICAgIE1hdHJpeDMubXVsdGlwbHkoak1hdHJpeFRyYW5zcG9zZSwgZGlhZ01hdHJpeCwgZGlhZ01hdHJpeCk7CiAgICAgICAgICBNYXRyaXgzLm11bHRpcGx5KHVuaXRhcnlNYXRyaXgsIGpNYXRyaXgsIHVuaXRhcnlNYXRyaXgpOwogICAgICAgICAgaWYgKCsrY291bnQgPiAyKSB7CiAgICAgICAgICAgICsrc3dlZXA7CiAgICAgICAgICAgIGNvdW50ID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5hYnMgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gTWF0aC5hYnMobWF0cml4WzBdKTsKICAgICAgICByZXN1bHRbMV0gPSBNYXRoLmFicyhtYXRyaXhbMV0pOwogICAgICAgIHJlc3VsdFsyXSA9IE1hdGguYWJzKG1hdHJpeFsyXSk7CiAgICAgICAgcmVzdWx0WzNdID0gTWF0aC5hYnMobWF0cml4WzNdKTsKICAgICAgICByZXN1bHRbNF0gPSBNYXRoLmFicyhtYXRyaXhbNF0pOwogICAgICAgIHJlc3VsdFs1XSA9IE1hdGguYWJzKG1hdHJpeFs1XSk7CiAgICAgICAgcmVzdWx0WzZdID0gTWF0aC5hYnMobWF0cml4WzZdKTsKICAgICAgICByZXN1bHRbN10gPSBNYXRoLmFicyhtYXRyaXhbN10pOwogICAgICAgIHJlc3VsdFs4XSA9IE1hdGguYWJzKG1hdHJpeFs4XSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5kZXRlcm1pbmFudCA9IGZ1bmN0aW9uKG1hdHJpeCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBjb25zdCBtMTEgPSBtYXRyaXhbMF07CiAgICAgICAgY29uc3QgbTIxID0gbWF0cml4WzNdOwogICAgICAgIGNvbnN0IG0zMSA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBtMTIgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbTIyID0gbWF0cml4WzRdOwogICAgICAgIGNvbnN0IG0zMiA9IG1hdHJpeFs3XTsKICAgICAgICBjb25zdCBtMTMgPSBtYXRyaXhbMl07CiAgICAgICAgY29uc3QgbTIzID0gbWF0cml4WzVdOwogICAgICAgIGNvbnN0IG0zMyA9IG1hdHJpeFs4XTsKICAgICAgICByZXR1cm4gbTExICogKG0yMiAqIG0zMyAtIG0yMyAqIG0zMikgKyBtMTIgKiAobTIzICogbTMxIC0gbTIxICogbTMzKSArIG0xMyAqIChtMjEgKiBtMzIgLSBtMjIgKiBtMzEpOwogICAgICB9OwogICAgICBNYXRyaXgzLmludmVyc2UgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbTExID0gbWF0cml4WzBdOwogICAgICAgIGNvbnN0IG0yMSA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBtMzEgPSBtYXRyaXhbMl07CiAgICAgICAgY29uc3QgbTEyID0gbWF0cml4WzNdOwogICAgICAgIGNvbnN0IG0yMiA9IG1hdHJpeFs0XTsKICAgICAgICBjb25zdCBtMzIgPSBtYXRyaXhbNV07CiAgICAgICAgY29uc3QgbTEzID0gbWF0cml4WzZdOwogICAgICAgIGNvbnN0IG0yMyA9IG1hdHJpeFs3XTsKICAgICAgICBjb25zdCBtMzMgPSBtYXRyaXhbOF07CiAgICAgICAgY29uc3QgZGV0ZXJtaW5hbnQgPSBNYXRyaXgzLmRldGVybWluYW50KG1hdHJpeCk7CiAgICAgICAgaWYgKE1hdGguYWJzKGRldGVybWluYW50KSA8PSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF0cml4IGlzIG5vdCBpbnZlcnRpYmxlIik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IG0yMiAqIG0zMyAtIG0yMyAqIG0zMjsKICAgICAgICByZXN1bHRbMV0gPSBtMjMgKiBtMzEgLSBtMjEgKiBtMzM7CiAgICAgICAgcmVzdWx0WzJdID0gbTIxICogbTMyIC0gbTIyICogbTMxOwogICAgICAgIHJlc3VsdFszXSA9IG0xMyAqIG0zMiAtIG0xMiAqIG0zMzsKICAgICAgICByZXN1bHRbNF0gPSBtMTEgKiBtMzMgLSBtMTMgKiBtMzE7CiAgICAgICAgcmVzdWx0WzVdID0gbTEyICogbTMxIC0gbTExICogbTMyOwogICAgICAgIHJlc3VsdFs2XSA9IG0xMiAqIG0yMyAtIG0xMyAqIG0yMjsKICAgICAgICByZXN1bHRbN10gPSBtMTMgKiBtMjEgLSBtMTEgKiBtMjM7CiAgICAgICAgcmVzdWx0WzhdID0gbTExICogbTIyIC0gbTEyICogbTIxOwogICAgICAgIGNvbnN0IHNjYWxlID0gMSAvIGRldGVybWluYW50OwogICAgICAgIHJldHVybiBNYXRyaXgzLm11bHRpcGx5QnlTY2FsYXIocmVzdWx0LCBzY2FsZSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaFRyYW5zcG9zZU1hdHJpeCA9IG5ldyBNYXRyaXgzKCk7CiAgICAgIE1hdHJpeDMuaW52ZXJzZVRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gTWF0cml4My5pbnZlcnNlKAogICAgICAgICAgTWF0cml4My50cmFuc3Bvc2UobWF0cml4LCBzY3JhdGNoVHJhbnNwb3NlTWF0cml4KSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdFswXSA9PT0gcmlnaHRbMF0gJiYgbGVmdFsxXSA9PT0gcmlnaHRbMV0gJiYgbGVmdFsyXSA9PT0gcmlnaHRbMl0gJiYgbGVmdFszXSA9PT0gcmlnaHRbM10gJiYgbGVmdFs0XSA9PT0gcmlnaHRbNF0gJiYgbGVmdFs1XSA9PT0gcmlnaHRbNV0gJiYgbGVmdFs2XSA9PT0gcmlnaHRbNl0gJiYgbGVmdFs3XSA9PT0gcmlnaHRbN10gJiYgbGVmdFs4XSA9PT0gcmlnaHRbOF07CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0WzBdIC0gcmlnaHRbMF0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFsxXSAtIHJpZ2h0WzFdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMl0gLSByaWdodFsyXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzNdIC0gcmlnaHRbM10pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs0XSAtIHJpZ2h0WzRdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbNV0gLSByaWdodFs1XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzZdIC0gcmlnaHRbNl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs3XSAtIHJpZ2h0WzddKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbOF0gLSByaWdodFs4XSkgPD0gZXBzaWxvbjsKICAgICAgfTsKICAgICAgTWF0cml4My5JREVOVElUWSA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IE1hdHJpeDMoMSwgMCwgMCwgMCwgMSwgMCwgMCwgMCwgMSkKICAgICAgKTsKICAgICAgTWF0cml4My5aRVJPID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgTWF0cml4MygwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwKQogICAgICApOwogICAgICBNYXRyaXgzLkNPTFVNTjBST1cwID0gMDsKICAgICAgTWF0cml4My5DT0xVTU4wUk9XMSA9IDE7CiAgICAgIE1hdHJpeDMuQ09MVU1OMFJPVzIgPSAyOwogICAgICBNYXRyaXgzLkNPTFVNTjFST1cwID0gMzsKICAgICAgTWF0cml4My5DT0xVTU4xUk9XMSA9IDQ7CiAgICAgIE1hdHJpeDMuQ09MVU1OMVJPVzIgPSA1OwogICAgICBNYXRyaXgzLkNPTFVNTjJST1cwID0gNjsKICAgICAgTWF0cml4My5DT0xVTU4yUk9XMSA9IDc7CiAgICAgIE1hdHJpeDMuQ09MVU1OMlJPVzIgPSA4OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhNYXRyaXgzLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG51bWJlciBvZiBpdGVtcyBpbiB0aGUgY29sbGVjdGlvbi4KICAgICAgICAgKiBAbWVtYmVyb2YgTWF0cml4My5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gTWF0cml4My5wYWNrZWRMZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgTWF0cml4My5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4My5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBNYXRyaXgzLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBNYXRyaXgzLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihtYXRyaXgsIGFycmF5LCBvZmZzZXQpIHsKICAgICAgICByZXR1cm4gbWF0cml4WzBdID09PSBhcnJheVtvZmZzZXRdICYmIG1hdHJpeFsxXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV0gJiYgbWF0cml4WzJdID09PSBhcnJheVtvZmZzZXQgKyAyXSAmJiBtYXRyaXhbM10gPT09IGFycmF5W29mZnNldCArIDNdICYmIG1hdHJpeFs0XSA9PT0gYXJyYXlbb2Zmc2V0ICsgNF0gJiYgbWF0cml4WzVdID09PSBhcnJheVtvZmZzZXQgKyA1XSAmJiBtYXRyaXhbNl0gPT09IGFycmF5W29mZnNldCArIDZdICYmIG1hdHJpeFs3XSA9PT0gYXJyYXlbb2Zmc2V0ICsgN10gJiYgbWF0cml4WzhdID09PSBhcnJheVtvZmZzZXQgKyA4XTsKICAgICAgfTsKICAgICAgTWF0cml4My5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDMuZXF1YWxzRXBzaWxvbih0aGlzLCByaWdodCwgZXBzaWxvbik7CiAgICAgIH07CiAgICAgIE1hdHJpeDMucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzWzBdfSwgJHt0aGlzWzNdfSwgJHt0aGlzWzZdfSkKKCR7dGhpc1sxXX0sICR7dGhpc1s0XX0sICR7dGhpc1s3XX0pCigke3RoaXNbMl19LCAke3RoaXNbNV19LCAke3RoaXNbOF19KWA7CiAgICAgIH07CiAgICAgIE1hdHJpeDNfZGVmYXVsdCA9IE1hdHJpeDM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DYXJ0ZXNpYW40LmpzCiAgZnVuY3Rpb24gQ2FydGVzaWFuNCh4LCB5LCB6LCB3KSB7CiAgICB0aGlzLnggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh4LCAwKTsKICAgIHRoaXMueSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHksIDApOwogICAgdGhpcy56ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeiwgMCk7CiAgICB0aGlzLncgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh3LCAwKTsKICB9CiAgdmFyIGRpc3RhbmNlU2NyYXRjaDMsIGxlcnBTY3JhdGNoMywgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDMsIHNjcmF0Y2hGMzJBcnJheSwgc2NyYXRjaFU4QXJyYXksIHRlc3RVMzIsIHRlc3RVOCwgbGl0dGxlRW5kaWFuLCBDYXJ0ZXNpYW40X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ2FydGVzaWFuNCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuNC5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIENhcnRlc2lhbjQuZnJvbUVsZW1lbnRzID0gZnVuY3Rpb24oeCwgeSwgeiwgdywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW40KHgsIHksIHosIHcpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5mcm9tQ29sb3IgPSBmdW5jdGlvbihjb2xvciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjQoY29sb3IucmVkLCBjb2xvci5ncmVlbiwgY29sb3IuYmx1ZSwgY29sb3IuYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGNvbG9yLnJlZDsKICAgICAgICByZXN1bHQueSA9IGNvbG9yLmdyZWVuOwogICAgICAgIHJlc3VsdC56ID0gY29sb3IuYmx1ZTsKICAgICAgICByZXN1bHQudyA9IGNvbG9yLmFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuY2xvbmUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjQoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueiwgY2FydGVzaWFuMTEudyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueDsKICAgICAgICByZXN1bHQueSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJlc3VsdC53ID0gY2FydGVzaWFuMTEudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LnBhY2tlZExlbmd0aCA9IDQ7CiAgICAgIENhcnRlc2lhbjQucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLng7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLno7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS53OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LncgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSBsZW5ndGggKiA0OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShyZXN1bHRMZW5ndGgpOwogICAgICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiSWYgcmVzdWx0IGlzIGEgdHlwZWQgYXJyYXksIGl0IG11c3QgaGF2ZSBleGFjdGx5IGFycmF5Lmxlbmd0aCAqIDQgZWxlbWVudHMiCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAocmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gcmVzdWx0TGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW40LnBhY2soYXJyYXlbaV0sIHJlc3VsdCwgaSAqIDQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LnVucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImFycmF5Lmxlbmd0aCIsIGFycmF5Lmxlbmd0aCwgNCk7CiAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCAlIDQgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gNCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyA0OwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSA0KSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyA0OwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjQudW5wYWNrKGFycmF5LCBpLCByZXN1bHRbaW5kZXhdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5mcm9tQXJyYXkgPSBDYXJ0ZXNpYW40LnVucGFjazsKICAgICAgQ2FydGVzaWFuNC5tYXhpbXVtQ29tcG9uZW50ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueiwgY2FydGVzaWFuMTEudyk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubWluaW11bUNvbXBvbmVudCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnksIGNhcnRlc2lhbjExLnosIGNhcnRlc2lhbjExLncpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm1pbmltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWluKGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWluKGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXN1bHQueiA9IE1hdGgubWluKGZpcnN0LnosIHNlY29uZC56KTsKICAgICAgICByZXN1bHQudyA9IE1hdGgubWluKGZpcnN0LncsIHNlY29uZC53KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm1heGltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWF4KGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWF4KGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXN1bHQueiA9IE1hdGgubWF4KGZpcnN0LnosIHNlY29uZC56KTsKICAgICAgICByZXN1bHQudyA9IE1hdGgubWF4KGZpcnN0LncsIHNlY29uZC53KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmNsYW1wID0gZnVuY3Rpb24odmFsdWUsIG1pbjMsIG1heDMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtaW4iLCBtaW4zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1heCIsIG1heDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB4ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLngsIG1pbjMueCwgbWF4My54KTsKICAgICAgICBjb25zdCB5ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLnksIG1pbjMueSwgbWF4My55KTsKICAgICAgICBjb25zdCB6ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLnosIG1pbjMueiwgbWF4My56KTsKICAgICAgICBjb25zdCB3ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLncsIG1pbjMudywgbWF4My53KTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5tYWduaXR1ZGVTcXVhcmVkID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gY2FydGVzaWFuMTEueCAqIGNhcnRlc2lhbjExLnggKyBjYXJ0ZXNpYW4xMS55ICogY2FydGVzaWFuMTEueSArIGNhcnRlc2lhbjExLnogKiBjYXJ0ZXNpYW4xMS56ICsgY2FydGVzaWFuMTEudyAqIGNhcnRlc2lhbjExLnc7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubWFnbml0dWRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KENhcnRlc2lhbjQubWFnbml0dWRlU3F1YXJlZChjYXJ0ZXNpYW4xMSkpOwogICAgICB9OwogICAgICBkaXN0YW5jZVNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjQoKTsKICAgICAgQ2FydGVzaWFuNC5kaXN0YW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW40LnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gzKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5tYWduaXR1ZGUoZGlzdGFuY2VTY3JhdGNoMyk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZGlzdGFuY2VTcXVhcmVkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENhcnRlc2lhbjQuc3VidHJhY3QobGVmdCwgcmlnaHQsIGRpc3RhbmNlU2NyYXRjaDMpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW40Lm1hZ25pdHVkZVNxdWFyZWQoZGlzdGFuY2VTY3JhdGNoMyk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubm9ybWFsaXplID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYWduaXR1ZGUgPSBDYXJ0ZXNpYW40Lm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LncgPSBjYXJ0ZXNpYW4xMS53IC8gbWFnbml0dWRlOwogICAgICAgIGlmIChpc05hTihyZXN1bHQueCkgfHwgaXNOYU4ocmVzdWx0LnkpIHx8IGlzTmFOKHJlc3VsdC56KSB8fCBpc05hTihyZXN1bHQudykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJub3JtYWxpemVkIHJlc3VsdCBpcyBub3QgYSBudW1iZXIiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5kb3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQueCAqIHJpZ2h0LnggKyBsZWZ0LnkgKiByaWdodC55ICsgbGVmdC56ICogcmlnaHQueiArIGxlZnQudyAqIHJpZ2h0Lnc7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubXVsdGlwbHlDb21wb25lbnRzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICogcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAqIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogKiByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53ICogcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmRpdmlkZUNvbXBvbmVudHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBsZWZ0LnggLyByaWdodC54OwogICAgICAgIHJlc3VsdC55ID0gbGVmdC55IC8gcmlnaHQueTsKICAgICAgICByZXN1bHQueiA9IGxlZnQueiAvIHJpZ2h0Lno7CiAgICAgICAgcmVzdWx0LncgPSBsZWZ0LncgLyByaWdodC53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICsgcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSArIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogKyByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53ICsgcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC0gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAtIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLSByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53IC0gcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm11bHRpcGx5QnlTY2FsYXIgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgc2NhbGFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueCAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueSA9IGNhcnRlc2lhbjExLnkgKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC53ID0gY2FydGVzaWFuMTEudyAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEueiAvIHNjYWxhcjsKICAgICAgICByZXN1bHQudyA9IGNhcnRlc2lhbjExLncgLyBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5uZWdhdGUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gLWNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LnkgPSAtY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQueiA9IC1jYXJ0ZXNpYW4xMS56OwogICAgICAgIHJlc3VsdC53ID0gLWNhcnRlc2lhbjExLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5hYnMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS55KTsKICAgICAgICByZXN1bHQueiA9IE1hdGguYWJzKGNhcnRlc2lhbjExLnopOwogICAgICAgIHJlc3VsdC53ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEudyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgbGVycFNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjQoKTsKICAgICAgQ2FydGVzaWFuNC5sZXJwID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVuZCIsIGVuZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIENhcnRlc2lhbjQubXVsdGlwbHlCeVNjYWxhcihlbmQsIHQsIGxlcnBTY3JhdGNoMyk7CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5tdWx0aXBseUJ5U2NhbGFyKHN0YXJ0LCAxIC0gdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5hZGQobGVycFNjcmF0Y2gzLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjQoKTsKICAgICAgQ2FydGVzaWFuNC5tb3N0T3J0aG9nb25hbEF4aXMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGYgPSBDYXJ0ZXNpYW40Lm5vcm1hbGl6ZShjYXJ0ZXNpYW4xMSwgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDMpOwogICAgICAgIENhcnRlc2lhbjQuYWJzKGYsIGYpOwogICAgICAgIGlmIChmLnggPD0gZi55KSB7CiAgICAgICAgICBpZiAoZi54IDw9IGYueikgewogICAgICAgICAgICBpZiAoZi54IDw9IGYudykgewogICAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQuY2xvbmUoQ2FydGVzaWFuNC5VTklUX1gsIHJlc3VsdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfVywgcmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChmLnogPD0gZi53KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQuY2xvbmUoQ2FydGVzaWFuNC5VTklUX1osIHJlc3VsdCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9XLCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZi55IDw9IGYueikgewogICAgICAgICAgaWYgKGYueSA8PSBmLncpIHsKICAgICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfWSwgcmVzdWx0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQuY2xvbmUoQ2FydGVzaWFuNC5VTklUX1csIHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChmLnogPD0gZi53KSB7CiAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9aLCByZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9XLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnQueCA9PT0gcmlnaHQueCAmJiBsZWZ0LnkgPT09IHJpZ2h0LnkgJiYgbGVmdC56ID09PSByaWdodC56ICYmIGxlZnQudyA9PT0gcmlnaHQudzsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5lcXVhbHNBcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggPT09IGFycmF5W29mZnNldF0gJiYgY2FydGVzaWFuMTEueSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV0gJiYgY2FydGVzaWFuMTEueiA9PT0gYXJyYXlbb2Zmc2V0ICsgMl0gJiYgY2FydGVzaWFuMTEudyA9PT0gYXJyYXlbb2Zmc2V0ICsgM107CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueCwKICAgICAgICAgIHJpZ2h0LngsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC55LAogICAgICAgICAgcmlnaHQueSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LnosCiAgICAgICAgICByaWdodC56LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQudywKICAgICAgICAgIHJpZ2h0LncsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LlpFUk8gPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW40KDAsIDAsIDAsIDApKTsKICAgICAgQ2FydGVzaWFuNC5PTkUgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW40KDEsIDEsIDEsIDEpKTsKICAgICAgQ2FydGVzaWFuNC5VTklUX1ggPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW40KDEsIDAsIDAsIDApKTsKICAgICAgQ2FydGVzaWFuNC5VTklUX1kgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW40KDAsIDEsIDAsIDApKTsKICAgICAgQ2FydGVzaWFuNC5VTklUX1ogPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW40KDAsIDAsIDEsIDApKTsKICAgICAgQ2FydGVzaWFuNC5VTklUX1cgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW40KDAsIDAsIDAsIDEpKTsKICAgICAgQ2FydGVzaWFuNC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW40LmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcywKICAgICAgICAgIHJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXMueH0sICR7dGhpcy55fSwgJHt0aGlzLnp9LCAke3RoaXMud30pYDsKICAgICAgfTsKICAgICAgc2NyYXRjaEYzMkFycmF5ID0gbmV3IEZsb2F0MzJBcnJheSgxKTsKICAgICAgc2NyYXRjaFU4QXJyYXkgPSBuZXcgVWludDhBcnJheShzY3JhdGNoRjMyQXJyYXkuYnVmZmVyKTsKICAgICAgdGVzdFUzMiA9IG5ldyBVaW50MzJBcnJheShbMjg3NDU0MDIwXSk7CiAgICAgIHRlc3RVOCA9IG5ldyBVaW50OEFycmF5KHRlc3RVMzIuYnVmZmVyKTsKICAgICAgbGl0dGxlRW5kaWFuID0gdGVzdFU4WzBdID09PSA2ODsKICAgICAgQ2FydGVzaWFuNC5wYWNrRmxvYXQgPSBmdW5jdGlvbih2YWx1ZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuNCgpOwogICAgICAgIH0KICAgICAgICBzY3JhdGNoRjMyQXJyYXlbMF0gPSB2YWx1ZTsKICAgICAgICBpZiAobGl0dGxlRW5kaWFuKSB7CiAgICAgICAgICByZXN1bHQueCA9IHNjcmF0Y2hVOEFycmF5WzBdOwogICAgICAgICAgcmVzdWx0LnkgPSBzY3JhdGNoVThBcnJheVsxXTsKICAgICAgICAgIHJlc3VsdC56ID0gc2NyYXRjaFU4QXJyYXlbMl07CiAgICAgICAgICByZXN1bHQudyA9IHNjcmF0Y2hVOEFycmF5WzNdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQueCA9IHNjcmF0Y2hVOEFycmF5WzNdOwogICAgICAgICAgcmVzdWx0LnkgPSBzY3JhdGNoVThBcnJheVsyXTsKICAgICAgICAgIHJlc3VsdC56ID0gc2NyYXRjaFU4QXJyYXlbMV07CiAgICAgICAgICByZXN1bHQudyA9IHNjcmF0Y2hVOEFycmF5WzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LnVucGFja0Zsb2F0ID0gZnVuY3Rpb24ocGFja2VkRmxvYXQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBhY2tlZEZsb2F0IiwgcGFja2VkRmxvYXQpOwogICAgICAgIGlmIChsaXR0bGVFbmRpYW4pIHsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzBdID0gcGFja2VkRmxvYXQueDsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzFdID0gcGFja2VkRmxvYXQueTsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzJdID0gcGFja2VkRmxvYXQuejsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzNdID0gcGFja2VkRmxvYXQudzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2NyYXRjaFU4QXJyYXlbMF0gPSBwYWNrZWRGbG9hdC53OwogICAgICAgICAgc2NyYXRjaFU4QXJyYXlbMV0gPSBwYWNrZWRGbG9hdC56OwogICAgICAgICAgc2NyYXRjaFU4QXJyYXlbMl0gPSBwYWNrZWRGbG9hdC55OwogICAgICAgICAgc2NyYXRjaFU4QXJyYXlbM10gPSBwYWNrZWRGbG9hdC54OwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2NyYXRjaEYzMkFycmF5WzBdOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40X2RlZmF1bHQgPSBDYXJ0ZXNpYW40OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUnVudGltZUVycm9yLmpzCiAgZnVuY3Rpb24gUnVudGltZUVycm9yKG1lc3NhZ2UpIHsKICAgIHRoaXMubmFtZSA9ICJSdW50aW1lRXJyb3IiOwogICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKICAgIGxldCBzdGFjazsKICAgIHRyeSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBzdGFjayA9IGUuc3RhY2s7CiAgICB9CiAgICB0aGlzLnN0YWNrID0gc3RhY2s7CiAgfQogIHZhciBSdW50aW1lRXJyb3JfZGVmYXVsdDsKICB2YXIgaW5pdF9SdW50aW1lRXJyb3IgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1J1bnRpbWVFcnJvci5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KE9iamVjdC5jcmVhdGUpKSB7CiAgICAgICAgUnVudGltZUVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlKTsKICAgICAgICBSdW50aW1lRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUnVudGltZUVycm9yOwogICAgICB9CiAgICAgIFJ1bnRpbWVFcnJvci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgc3RyID0gYCR7dGhpcy5uYW1lfTogJHt0aGlzLm1lc3NhZ2V9YDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuc3RhY2spKSB7CiAgICAgICAgICBzdHIgKz0gYAoke3RoaXMuc3RhY2sudG9TdHJpbmcoKX1gOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgICB9OwogICAgICBSdW50aW1lRXJyb3JfZGVmYXVsdCA9IFJ1bnRpbWVFcnJvcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDQuanMKICBmdW5jdGlvbiBNYXRyaXg0KGNvbHVtbjBSb3cwLCBjb2x1bW4xUm93MCwgY29sdW1uMlJvdzAsIGNvbHVtbjNSb3cwLCBjb2x1bW4wUm93MSwgY29sdW1uMVJvdzEsIGNvbHVtbjJSb3cxLCBjb2x1bW4zUm93MSwgY29sdW1uMFJvdzIsIGNvbHVtbjFSb3cyLCBjb2x1bW4yUm93MiwgY29sdW1uM1JvdzIsIGNvbHVtbjBSb3czLCBjb2x1bW4xUm93MywgY29sdW1uMlJvdzMsIGNvbHVtbjNSb3czKSB7CiAgICB0aGlzWzBdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzAsIDApOwogICAgdGhpc1sxXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cxLCAwKTsKICAgIHRoaXNbMl0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MiwgMCk7CiAgICB0aGlzWzNdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzMsIDApOwogICAgdGhpc1s0XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cwLCAwKTsKICAgIHRoaXNbNV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MSwgMCk7CiAgICB0aGlzWzZdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzIsIDApOwogICAgdGhpc1s3XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3czLCAwKTsKICAgIHRoaXNbOF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4yUm93MCwgMCk7CiAgICB0aGlzWzldID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzEsIDApOwogICAgdGhpc1sxMF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4yUm93MiwgMCk7CiAgICB0aGlzWzExXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjJSb3czLCAwKTsKICAgIHRoaXNbMTJdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uM1JvdzAsIDApOwogICAgdGhpc1sxM10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4zUm93MSwgMCk7CiAgICB0aGlzWzE0XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjNSb3cyLCAwKTsKICAgIHRoaXNbMTVdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uM1JvdzMsIDApOwogIH0KICB2YXIgZnJvbUNhbWVyYUYsIGZyb21DYW1lcmFSLCBmcm9tQ2FtZXJhVSwgc2NhbGVTY3JhdGNoMTIsIHNjYWxlU2NyYXRjaDIyLCBzY3JhdGNoQ29sdW1uMiwgc2NhbGVTY3JhdGNoMzIsIHNjYWxlU2NyYXRjaDQyLCBzY2FsZVNjcmF0Y2g1Miwgc2NyYXRjaEludmVyc2VSb3RhdGlvbiwgc2NyYXRjaE1hdHJpeDNaZXJvLCBzY3JhdGNoQm90dG9tUm93LCBzY3JhdGNoRXhwZWN0ZWRCb3R0b21Sb3csIHNjcmF0Y2hUcmFuc3Bvc2VNYXRyaXgyLCBNYXRyaXg0X2RlZmF1bHQ7CiAgdmFyIGluaXRfTWF0cml4NCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0cml4NC5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIE1hdHJpeDQucGFja2VkTGVuZ3RoID0gMTY7CiAgICAgIE1hdHJpeDQucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzBdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMl07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzNdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs0XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbNV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzZdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs3XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbOF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzldOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxMF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzExXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMTJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxM107CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzE0XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlWzE1XTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIE1hdHJpeDQudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXg0KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzFdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbMl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFszXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzRdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbNV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs2XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzddID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbOF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs5XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzEwXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzExXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzEyXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzEzXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzE0XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzE1XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGNvbnN0IHJlc3VsdExlbmd0aCA9IGxlbmd0aCAqIDE2OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShyZXN1bHRMZW5ndGgpOwogICAgICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiSWYgcmVzdWx0IGlzIGEgdHlwZWQgYXJyYXksIGl0IG11c3QgaGF2ZSBleGFjdGx5IGFycmF5Lmxlbmd0aCAqIDE2IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgTWF0cml4NC5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiAxNik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQudW5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiYXJyYXkubGVuZ3RoIiwgYXJyYXkubGVuZ3RoLCAxNik7CiAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNi4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyAxNik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAxNjsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMTYpIHsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAvIDE2OwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IE1hdHJpeDQudW5wYWNrKGFycmF5LCBpLCByZXN1bHRbaW5kZXhdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jbG9uZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWF0cml4KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXg0KAogICAgICAgICAgICBtYXRyaXhbMF0sCiAgICAgICAgICAgIG1hdHJpeFs0XSwKICAgICAgICAgICAgbWF0cml4WzhdLAogICAgICAgICAgICBtYXRyaXhbMTJdLAogICAgICAgICAgICBtYXRyaXhbMV0sCiAgICAgICAgICAgIG1hdHJpeFs1XSwKICAgICAgICAgICAgbWF0cml4WzldLAogICAgICAgICAgICBtYXRyaXhbMTNdLAogICAgICAgICAgICBtYXRyaXhbMl0sCiAgICAgICAgICAgIG1hdHJpeFs2XSwKICAgICAgICAgICAgbWF0cml4WzEwXSwKICAgICAgICAgICAgbWF0cml4WzE0XSwKICAgICAgICAgICAgbWF0cml4WzNdLAogICAgICAgICAgICBtYXRyaXhbN10sCiAgICAgICAgICAgIG1hdHJpeFsxMV0sCiAgICAgICAgICAgIG1hdHJpeFsxNV0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21BcnJheSA9IE1hdHJpeDQudW5wYWNrOwogICAgICBNYXRyaXg0LmZyb21Db2x1bW5NYWpvckFycmF5ID0gZnVuY3Rpb24odmFsdWVzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlcyIsIHZhbHVlcyk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDQuY2xvbmUodmFsdWVzLCByZXN1bHQpOwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21Sb3dNYWpvckFycmF5ID0gZnVuY3Rpb24odmFsdWVzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlcyIsIHZhbHVlcyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXg0KAogICAgICAgICAgICB2YWx1ZXNbMF0sCiAgICAgICAgICAgIHZhbHVlc1sxXSwKICAgICAgICAgICAgdmFsdWVzWzJdLAogICAgICAgICAgICB2YWx1ZXNbM10sCiAgICAgICAgICAgIHZhbHVlc1s0XSwKICAgICAgICAgICAgdmFsdWVzWzVdLAogICAgICAgICAgICB2YWx1ZXNbNl0sCiAgICAgICAgICAgIHZhbHVlc1s3XSwKICAgICAgICAgICAgdmFsdWVzWzhdLAogICAgICAgICAgICB2YWx1ZXNbOV0sCiAgICAgICAgICAgIHZhbHVlc1sxMF0sCiAgICAgICAgICAgIHZhbHVlc1sxMV0sCiAgICAgICAgICAgIHZhbHVlc1sxMl0sCiAgICAgICAgICAgIHZhbHVlc1sxM10sCiAgICAgICAgICAgIHZhbHVlc1sxNF0sCiAgICAgICAgICAgIHZhbHVlc1sxNV0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHZhbHVlc1swXTsKICAgICAgICByZXN1bHRbMV0gPSB2YWx1ZXNbNF07CiAgICAgICAgcmVzdWx0WzJdID0gdmFsdWVzWzhdOwogICAgICAgIHJlc3VsdFszXSA9IHZhbHVlc1sxMl07CiAgICAgICAgcmVzdWx0WzRdID0gdmFsdWVzWzFdOwogICAgICAgIHJlc3VsdFs1XSA9IHZhbHVlc1s1XTsKICAgICAgICByZXN1bHRbNl0gPSB2YWx1ZXNbOV07CiAgICAgICAgcmVzdWx0WzddID0gdmFsdWVzWzEzXTsKICAgICAgICByZXN1bHRbOF0gPSB2YWx1ZXNbMl07CiAgICAgICAgcmVzdWx0WzldID0gdmFsdWVzWzZdOwogICAgICAgIHJlc3VsdFsxMF0gPSB2YWx1ZXNbMTBdOwogICAgICAgIHJlc3VsdFsxMV0gPSB2YWx1ZXNbMTRdOwogICAgICAgIHJlc3VsdFsxMl0gPSB2YWx1ZXNbM107CiAgICAgICAgcmVzdWx0WzEzXSA9IHZhbHVlc1s3XTsKICAgICAgICByZXN1bHRbMTRdID0gdmFsdWVzWzExXTsKICAgICAgICByZXN1bHRbMTVdID0gdmFsdWVzWzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21Sb3RhdGlvblRyYW5zbGF0aW9uID0gZnVuY3Rpb24ocm90YXRpb24sIHRyYW5zbGF0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICB0cmFuc2xhdGlvbjIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh0cmFuc2xhdGlvbjIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDQoCiAgICAgICAgICAgIHJvdGF0aW9uWzBdLAogICAgICAgICAgICByb3RhdGlvblszXSwKICAgICAgICAgICAgcm90YXRpb25bNl0sCiAgICAgICAgICAgIHRyYW5zbGF0aW9uMi54LAogICAgICAgICAgICByb3RhdGlvblsxXSwKICAgICAgICAgICAgcm90YXRpb25bNF0sCiAgICAgICAgICAgIHJvdGF0aW9uWzddLAogICAgICAgICAgICB0cmFuc2xhdGlvbjIueSwKICAgICAgICAgICAgcm90YXRpb25bMl0sCiAgICAgICAgICAgIHJvdGF0aW9uWzVdLAogICAgICAgICAgICByb3RhdGlvbls4XSwKICAgICAgICAgICAgdHJhbnNsYXRpb24yLnosCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHJvdGF0aW9uWzBdOwogICAgICAgIHJlc3VsdFsxXSA9IHJvdGF0aW9uWzFdOwogICAgICAgIHJlc3VsdFsyXSA9IHJvdGF0aW9uWzJdOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gcm90YXRpb25bM107CiAgICAgICAgcmVzdWx0WzVdID0gcm90YXRpb25bNF07CiAgICAgICAgcmVzdWx0WzZdID0gcm90YXRpb25bNV07CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSByb3RhdGlvbls2XTsKICAgICAgICByZXN1bHRbOV0gPSByb3RhdGlvbls3XTsKICAgICAgICByZXN1bHRbMTBdID0gcm90YXRpb25bOF07CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IHRyYW5zbGF0aW9uMi54OwogICAgICAgIHJlc3VsdFsxM10gPSB0cmFuc2xhdGlvbjIueTsKICAgICAgICByZXN1bHRbMTRdID0gdHJhbnNsYXRpb24yLno7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tVHJhbnNsYXRpb25RdWF0ZXJuaW9uUm90YXRpb25TY2FsZSA9IGZ1bmN0aW9uKHRyYW5zbGF0aW9uMiwgcm90YXRpb24sIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zbGF0aW9uIiwgdHJhbnNsYXRpb24yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJvdGF0aW9uIiwgcm90YXRpb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2NhbGVYID0gc2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVkgPSBzY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlWiA9IHNjYWxlLno7CiAgICAgICAgY29uc3QgeDIgPSByb3RhdGlvbi54ICogcm90YXRpb24ueDsKICAgICAgICBjb25zdCB4eSA9IHJvdGF0aW9uLnggKiByb3RhdGlvbi55OwogICAgICAgIGNvbnN0IHh6ID0gcm90YXRpb24ueCAqIHJvdGF0aW9uLno7CiAgICAgICAgY29uc3QgeHcgPSByb3RhdGlvbi54ICogcm90YXRpb24udzsKICAgICAgICBjb25zdCB5MiA9IHJvdGF0aW9uLnkgKiByb3RhdGlvbi55OwogICAgICAgIGNvbnN0IHl6ID0gcm90YXRpb24ueSAqIHJvdGF0aW9uLno7CiAgICAgICAgY29uc3QgeXcgPSByb3RhdGlvbi55ICogcm90YXRpb24udzsKICAgICAgICBjb25zdCB6MiA9IHJvdGF0aW9uLnogKiByb3RhdGlvbi56OwogICAgICAgIGNvbnN0IHp3ID0gcm90YXRpb24ueiAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgdzIgPSByb3RhdGlvbi53ICogcm90YXRpb24udzsKICAgICAgICBjb25zdCBtMDAgPSB4MiAtIHkyIC0gejIgKyB3MjsKICAgICAgICBjb25zdCBtMDEgPSAyICogKHh5IC0gencpOwogICAgICAgIGNvbnN0IG0wMiA9IDIgKiAoeHogKyB5dyk7CiAgICAgICAgY29uc3QgbTEwID0gMiAqICh4eSArIHp3KTsKICAgICAgICBjb25zdCBtMTEgPSAteDIgKyB5MiAtIHoyICsgdzI7CiAgICAgICAgY29uc3QgbTEyID0gMiAqICh5eiAtIHh3KTsKICAgICAgICBjb25zdCBtMjAgPSAyICogKHh6IC0geXcpOwogICAgICAgIGNvbnN0IG0yMSA9IDIgKiAoeXogKyB4dyk7CiAgICAgICAgY29uc3QgbTIyID0gLXgyIC0geTIgKyB6MiArIHcyOwogICAgICAgIHJlc3VsdFswXSA9IG0wMCAqIHNjYWxlWDsKICAgICAgICByZXN1bHRbMV0gPSBtMTAgKiBzY2FsZVg7CiAgICAgICAgcmVzdWx0WzJdID0gbTIwICogc2NhbGVYOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gbTAxICogc2NhbGVZOwogICAgICAgIHJlc3VsdFs1XSA9IG0xMSAqIHNjYWxlWTsKICAgICAgICByZXN1bHRbNl0gPSBtMjEgKiBzY2FsZVk7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBtMDIgKiBzY2FsZVo7CiAgICAgICAgcmVzdWx0WzldID0gbTEyICogc2NhbGVaOwogICAgICAgIHJlc3VsdFsxMF0gPSBtMjIgKiBzY2FsZVo7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IHRyYW5zbGF0aW9uMi54OwogICAgICAgIHJlc3VsdFsxM10gPSB0cmFuc2xhdGlvbjIueTsKICAgICAgICByZXN1bHRbMTRdID0gdHJhbnNsYXRpb24yLno7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tVHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlID0gZnVuY3Rpb24odHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zbGF0aW9uUm90YXRpb25TY2FsZSIsIHRyYW5zbGF0aW9uUm90YXRpb25TY2FsZSk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDQuZnJvbVRyYW5zbGF0aW9uUXVhdGVybmlvblJvdGF0aW9uU2NhbGUoCiAgICAgICAgICB0cmFuc2xhdGlvblJvdGF0aW9uU2NhbGUudHJhbnNsYXRpb24sCiAgICAgICAgICB0cmFuc2xhdGlvblJvdGF0aW9uU2NhbGUucm90YXRpb24sCiAgICAgICAgICB0cmFuc2xhdGlvblJvdGF0aW9uU2NhbGUuc2NhbGUsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21UcmFuc2xhdGlvbiA9IGZ1bmN0aW9uKHRyYW5zbGF0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvbiIsIHRyYW5zbGF0aW9uMik7CiAgICAgICAgcmV0dXJuIE1hdHJpeDQuZnJvbVJvdGF0aW9uVHJhbnNsYXRpb24oTWF0cml4M19kZWZhdWx0LklERU5USVRZLCB0cmFuc2xhdGlvbjIsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZnJvbVNjYWxlID0gZnVuY3Rpb24oc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXg0KAogICAgICAgICAgICBzY2FsZS54LAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBzY2FsZS55LAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBzY2FsZS56LAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAxCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gc2NhbGUueTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICByZXN1bHRbOV0gPSAwOwogICAgICAgIHJlc3VsdFsxMF0gPSBzY2FsZS56OwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSAwOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZnJvbVVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgc2NhbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHNjYWxlLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBzY2FsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSBzY2FsZTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICByZXN1bHRbOV0gPSAwOwogICAgICAgIHJlc3VsdFsxMF0gPSBzY2FsZTsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gMDsKICAgICAgICByZXN1bHRbMTNdID0gMDsKICAgICAgICByZXN1bHRbMTRdID0gMDsKICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21Sb3RhdGlvbiA9IGZ1bmN0aW9uKHJvdGF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJvdGF0aW9uIiwgcm90YXRpb24pOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXg0KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHJvdGF0aW9uWzBdOwogICAgICAgIHJlc3VsdFsxXSA9IHJvdGF0aW9uWzFdOwogICAgICAgIHJlc3VsdFsyXSA9IHJvdGF0aW9uWzJdOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gcm90YXRpb25bM107CiAgICAgICAgcmVzdWx0WzVdID0gcm90YXRpb25bNF07CiAgICAgICAgcmVzdWx0WzZdID0gcm90YXRpb25bNV07CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSByb3RhdGlvbls2XTsKICAgICAgICByZXN1bHRbOV0gPSByb3RhdGlvbls3XTsKICAgICAgICByZXN1bHRbMTBdID0gcm90YXRpb25bOF07CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IDA7CiAgICAgICAgcmVzdWx0WzE0XSA9IDA7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZnJvbUNhbWVyYUYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21DYW1lcmFSID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tQ2FtZXJhVSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4NC5mcm9tQ2FtZXJhID0gZnVuY3Rpb24oY2FtZXJhLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhbWVyYSIsIGNhbWVyYSk7CiAgICAgICAgY29uc3QgcG9zaXRpb24gPSBjYW1lcmEucG9zaXRpb247CiAgICAgICAgY29uc3QgZGlyZWN0aW9uMiA9IGNhbWVyYS5kaXJlY3Rpb247CiAgICAgICAgY29uc3QgdXAgPSBjYW1lcmEudXA7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYW1lcmEucG9zaXRpb24iLCBwb3NpdGlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYW1lcmEuZGlyZWN0aW9uIiwgZGlyZWN0aW9uMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYW1lcmEudXAiLCB1cCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShkaXJlY3Rpb24yLCBmcm9tQ2FtZXJhRik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhmcm9tQ2FtZXJhRiwgdXAsIGZyb21DYW1lcmFSKSwKICAgICAgICAgIGZyb21DYW1lcmFSCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGZyb21DYW1lcmFSLCBmcm9tQ2FtZXJhRiwgZnJvbUNhbWVyYVUpLAogICAgICAgICAgZnJvbUNhbWVyYVUKICAgICAgICApOwogICAgICAgIGNvbnN0IHNYID0gZnJvbUNhbWVyYVIueDsKICAgICAgICBjb25zdCBzWSA9IGZyb21DYW1lcmFSLnk7CiAgICAgICAgY29uc3Qgc1ogPSBmcm9tQ2FtZXJhUi56OwogICAgICAgIGNvbnN0IGZYID0gZnJvbUNhbWVyYUYueDsKICAgICAgICBjb25zdCBmWSA9IGZyb21DYW1lcmFGLnk7CiAgICAgICAgY29uc3QgZlogPSBmcm9tQ2FtZXJhRi56OwogICAgICAgIGNvbnN0IHVYID0gZnJvbUNhbWVyYVUueDsKICAgICAgICBjb25zdCB1WSA9IGZyb21DYW1lcmFVLnk7CiAgICAgICAgY29uc3QgdVogPSBmcm9tQ2FtZXJhVS56OwogICAgICAgIGNvbnN0IHBvc2l0aW9uWCA9IHBvc2l0aW9uLng7CiAgICAgICAgY29uc3QgcG9zaXRpb25ZID0gcG9zaXRpb24ueTsKICAgICAgICBjb25zdCBwb3NpdGlvblogPSBwb3NpdGlvbi56OwogICAgICAgIGNvbnN0IHQwID0gc1ggKiAtcG9zaXRpb25YICsgc1kgKiAtcG9zaXRpb25ZICsgc1ogKiAtcG9zaXRpb25aOwogICAgICAgIGNvbnN0IHQxID0gdVggKiAtcG9zaXRpb25YICsgdVkgKiAtcG9zaXRpb25ZICsgdVogKiAtcG9zaXRpb25aOwogICAgICAgIGNvbnN0IHQyID0gZlggKiBwb3NpdGlvblggKyBmWSAqIHBvc2l0aW9uWSArIGZaICogcG9zaXRpb25aOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgc1gsCiAgICAgICAgICAgIHNZLAogICAgICAgICAgICBzWiwKICAgICAgICAgICAgdDAsCiAgICAgICAgICAgIHVYLAogICAgICAgICAgICB1WSwKICAgICAgICAgICAgdVosCiAgICAgICAgICAgIHQxLAogICAgICAgICAgICAtZlgsCiAgICAgICAgICAgIC1mWSwKICAgICAgICAgICAgLWZaLAogICAgICAgICAgICB0MiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc1g7CiAgICAgICAgcmVzdWx0WzFdID0gdVg7CiAgICAgICAgcmVzdWx0WzJdID0gLWZYOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gc1k7CiAgICAgICAgcmVzdWx0WzVdID0gdVk7CiAgICAgICAgcmVzdWx0WzZdID0gLWZZOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gc1o7CiAgICAgICAgcmVzdWx0WzldID0gdVo7CiAgICAgICAgcmVzdWx0WzEwXSA9IC1mWjsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gdDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IHQxOwogICAgICAgIHJlc3VsdFsxNF0gPSB0MjsKICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmNvbXB1dGVQZXJzcGVjdGl2ZUZpZWxkT2ZWaWV3ID0gZnVuY3Rpb24oZm92WSwgYXNwZWN0UmF0aW8sIG5lYXIsIGZhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuKCJmb3ZZIiwgZm92WSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuKCJmb3ZZIiwgZm92WSwgTWF0aC5QSSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuKCJuZWFyIiwgbmVhciwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuKCJmYXIiLCBmYXIsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBib3R0b20gPSBNYXRoLnRhbihmb3ZZICogMC41KTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IDEgLyBib3R0b207CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSBjb2x1bW4xUm93MSAvIGFzcGVjdFJhdGlvOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gKGZhciArIG5lYXIpIC8gKG5lYXIgLSBmYXIpOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cyID0gMiAqIGZhciAqIG5lYXIgLyAobmVhciAtIGZhcik7CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICByZXN1bHRbOV0gPSAwOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gLTE7CiAgICAgICAgcmVzdWx0WzEyXSA9IDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IDA7CiAgICAgICAgcmVzdWx0WzE0XSA9IGNvbHVtbjNSb3cyOwogICAgICAgIHJlc3VsdFsxNV0gPSAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuY29tcHV0ZU9ydGhvZ3JhcGhpY09mZkNlbnRlciA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBib3R0b20sIHRvcCwgbmVhciwgZmFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiYm90dG9tIiwgYm90dG9tKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInRvcCIsIHRvcCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJuZWFyIiwgbmVhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJmYXIiLCBmYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBsZXQgYTMgPSAxIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICAgICAgbGV0IGIgPSAxIC8gKHRvcCAtIGJvdHRvbSk7CiAgICAgICAgbGV0IGMgPSAxIC8gKGZhciAtIG5lYXIpOwogICAgICAgIGNvbnN0IHR4ID0gLShyaWdodCArIGxlZnQpICogYTM7CiAgICAgICAgY29uc3QgdHkgPSAtKHRvcCArIGJvdHRvbSkgKiBiOwogICAgICAgIGNvbnN0IHR6ID0gLShmYXIgKyBuZWFyKSAqIGM7CiAgICAgICAgYTMgKj0gMjsKICAgICAgICBiICo9IDI7CiAgICAgICAgYyAqPSAtMjsKICAgICAgICByZXN1bHRbMF0gPSBhMzsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgIHJlc3VsdFs1XSA9IGI7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gYzsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gdHg7CiAgICAgICAgcmVzdWx0WzEzXSA9IHR5OwogICAgICAgIHJlc3VsdFsxNF0gPSB0ejsKICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmNvbXB1dGVQZXJzcGVjdGl2ZU9mZkNlbnRlciA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBib3R0b20sIHRvcCwgbmVhciwgZmFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiYm90dG9tIiwgYm90dG9tKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInRvcCIsIHRvcCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJuZWFyIiwgbmVhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJmYXIiLCBmYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IDIgKiBuZWFyIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSAyICogbmVhciAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cwID0gKHJpZ2h0ICsgbGVmdCkgLyAocmlnaHQgLSBsZWZ0KTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9ICh0b3AgKyBib3R0b20pIC8gKHRvcCAtIGJvdHRvbSk7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzIgPSAtKGZhciArIG5lYXIpIC8gKGZhciAtIG5lYXIpOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3czID0gLTE7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzIgPSAtMiAqIGZhciAqIG5lYXIgLyAoZmFyIC0gbmVhcik7CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gY29sdW1uMlJvdzA7CiAgICAgICAgcmVzdWx0WzldID0gY29sdW1uMlJvdzE7CiAgICAgICAgcmVzdWx0WzEwXSA9IGNvbHVtbjJSb3cyOwogICAgICAgIHJlc3VsdFsxMV0gPSBjb2x1bW4yUm93MzsKICAgICAgICByZXN1bHRbMTJdID0gMDsKICAgICAgICByZXN1bHRbMTNdID0gMDsKICAgICAgICByZXN1bHRbMTRdID0gY29sdW1uM1JvdzI7CiAgICAgICAgcmVzdWx0WzE1XSA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlSW5maW5pdGVQZXJzcGVjdGl2ZU9mZkNlbnRlciA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBib3R0b20sIHRvcCwgbmVhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImJvdHRvbSIsIGJvdHRvbSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0b3AiLCB0b3ApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibmVhciIsIG5lYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IDIgKiBuZWFyIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSAyICogbmVhciAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cwID0gKHJpZ2h0ICsgbGVmdCkgLyAocmlnaHQgLSBsZWZ0KTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9ICh0b3AgKyBib3R0b20pIC8gKHRvcCAtIGJvdHRvbSk7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzIgPSAtMTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MyA9IC0xOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cyID0gLTIgKiBuZWFyOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gY29sdW1uMlJvdzM7CiAgICAgICAgcmVzdWx0WzEyXSA9IDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IDA7CiAgICAgICAgcmVzdWx0WzE0XSA9IGNvbHVtbjNSb3cyOwogICAgICAgIHJlc3VsdFsxNV0gPSAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuY29tcHV0ZVZpZXdwb3J0VHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbih2aWV3cG9ydCwgbmVhckRlcHRoUmFuZ2UsIGZhckRlcHRoUmFuZ2UsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXg0KCk7CiAgICAgICAgfQogICAgICAgIHZpZXdwb3J0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmlld3BvcnQsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZpZXdwb3J0LngsIDApOwogICAgICAgIGNvbnN0IHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2aWV3cG9ydC55LCAwKTsKICAgICAgICBjb25zdCB3aWR0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZpZXdwb3J0LndpZHRoLCAwKTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2aWV3cG9ydC5oZWlnaHQsIDApOwogICAgICAgIG5lYXJEZXB0aFJhbmdlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobmVhckRlcHRoUmFuZ2UsIDApOwogICAgICAgIGZhckRlcHRoUmFuZ2UgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChmYXJEZXB0aFJhbmdlLCAxKTsKICAgICAgICBjb25zdCBoYWxmV2lkdGggPSB3aWR0aCAqIDAuNTsKICAgICAgICBjb25zdCBoYWxmSGVpZ2h0ID0gaGVpZ2h0ICogMC41OwogICAgICAgIGNvbnN0IGhhbGZEZXB0aCA9IChmYXJEZXB0aFJhbmdlIC0gbmVhckRlcHRoUmFuZ2UpICogMC41OwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gaGFsZldpZHRoOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gaGFsZkhlaWdodDsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IGhhbGZEZXB0aDsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MCA9IHggKyBoYWxmV2lkdGg7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzEgPSB5ICsgaGFsZkhlaWdodDsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MiA9IG5lYXJEZXB0aFJhbmdlICsgaGFsZkRlcHRoOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3czID0gMTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSAwOwogICAgICAgIHJlc3VsdFs5XSA9IDA7CiAgICAgICAgcmVzdWx0WzEwXSA9IGNvbHVtbjJSb3cyOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSBjb2x1bW4zUm93MDsKICAgICAgICByZXN1bHRbMTNdID0gY29sdW1uM1JvdzE7CiAgICAgICAgcmVzdWx0WzE0XSA9IGNvbHVtbjNSb3cyOwogICAgICAgIHJlc3VsdFsxNV0gPSBjb2x1bW4zUm93MzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmNvbXB1dGVWaWV3ID0gZnVuY3Rpb24ocG9zaXRpb24sIGRpcmVjdGlvbjIsIHVwLCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwb3NpdGlvbiIsIHBvc2l0aW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpcmVjdGlvbiIsIGRpcmVjdGlvbjIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidXAiLCB1cCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gcmlnaHQueDsKICAgICAgICByZXN1bHRbMV0gPSB1cC54OwogICAgICAgIHJlc3VsdFsyXSA9IC1kaXJlY3Rpb24yLng7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSByaWdodC55OwogICAgICAgIHJlc3VsdFs1XSA9IHVwLnk7CiAgICAgICAgcmVzdWx0WzZdID0gLWRpcmVjdGlvbjIueTsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IHJpZ2h0Lno7CiAgICAgICAgcmVzdWx0WzldID0gdXAuejsKICAgICAgICByZXN1bHRbMTBdID0gLWRpcmVjdGlvbjIuejsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QocmlnaHQsIHBvc2l0aW9uKTsKICAgICAgICByZXN1bHRbMTNdID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QodXAsIHBvc2l0aW9uKTsKICAgICAgICByZXN1bHRbMTRdID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCBwb3NpdGlvbik7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC50b0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgbWF0cml4WzBdLAogICAgICAgICAgICBtYXRyaXhbMV0sCiAgICAgICAgICAgIG1hdHJpeFsyXSwKICAgICAgICAgICAgbWF0cml4WzNdLAogICAgICAgICAgICBtYXRyaXhbNF0sCiAgICAgICAgICAgIG1hdHJpeFs1XSwKICAgICAgICAgICAgbWF0cml4WzZdLAogICAgICAgICAgICBtYXRyaXhbN10sCiAgICAgICAgICAgIG1hdHJpeFs4XSwKICAgICAgICAgICAgbWF0cml4WzldLAogICAgICAgICAgICBtYXRyaXhbMTBdLAogICAgICAgICAgICBtYXRyaXhbMTFdLAogICAgICAgICAgICBtYXRyaXhbMTJdLAogICAgICAgICAgICBtYXRyaXhbMTNdLAogICAgICAgICAgICBtYXRyaXhbMTRdLAogICAgICAgICAgICBtYXRyaXhbMTVdCiAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5nZXRFbGVtZW50SW5kZXggPSBmdW5jdGlvbihjb2x1bW4sIHJvdykgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJyb3ciLCByb3csIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJyb3ciLCByb3csIDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJjb2x1bW4iLCBjb2x1bW4sIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJjb2x1bW4iLCBjb2x1bW4sIDMpOwogICAgICAgIHJldHVybiBjb2x1bW4gKiA0ICsgcm93OwogICAgICB9OwogICAgICBNYXRyaXg0LmdldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzdGFydEluZGV4ID0gaW5kZXggKiA0OwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbc3RhcnRJbmRleF07CiAgICAgICAgY29uc3QgeSA9IG1hdHJpeFtzdGFydEluZGV4ICsgMV07CiAgICAgICAgY29uc3QgeiA9IG1hdHJpeFtzdGFydEluZGV4ICsgMl07CiAgICAgICAgY29uc3QgdyA9IG1hdHJpeFtzdGFydEluZGV4ICsgM107CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuc2V0Q29sdW1uID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQgPSBNYXRyaXg0LmNsb25lKG1hdHJpeCwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzdGFydEluZGV4ID0gaW5kZXggKiA0OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4XSA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0W3N0YXJ0SW5kZXggKyAxXSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0W3N0YXJ0SW5kZXggKyAyXSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmVzdWx0W3N0YXJ0SW5kZXggKyAzXSA9IGNhcnRlc2lhbjExLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5nZXRSb3cgPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFtpbmRleF07CiAgICAgICAgY29uc3QgeSA9IG1hdHJpeFtpbmRleCArIDRdOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbaW5kZXggKyA4XTsKICAgICAgICBjb25zdCB3ID0gbWF0cml4W2luZGV4ICsgMTJdOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJlc3VsdC53ID0gdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnNldFJvdyA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4NC5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0W2luZGV4ICsgNF0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdFtpbmRleCArIDhdID0gY2FydGVzaWFuMTEuejsKICAgICAgICByZXN1bHRbaW5kZXggKyAxMl0gPSBjYXJ0ZXNpYW4xMS53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuc2V0VHJhbnNsYXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHRyYW5zbGF0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNsYXRpb24iLCB0cmFuc2xhdGlvbjIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IHRyYW5zbGF0aW9uMi54OwogICAgICAgIHJlc3VsdFsxM10gPSB0cmFuc2xhdGlvbjIueTsKICAgICAgICByZXN1bHRbMTRdID0gdHJhbnNsYXRpb24yLno7CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDQuc2V0U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDQuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gxMik7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZS54IC8gZXhpc3RpbmdTY2FsZS54OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9ZID0gc2NhbGUueSAvIGV4aXN0aW5nU2NhbGUueTsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWiA9IHNjYWxlLnogLyBleGlzdGluZ1NjYWxlLno7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LnNldFVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBleGlzdGluZ1NjYWxlID0gTWF0cml4NC5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDIyKTsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWCA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS54OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9ZID0gc2NhbGUgLyBleGlzdGluZ1NjYWxlLnk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ogPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUuejsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeFs5XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXhbMTBdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaENvbHVtbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDQuZ2V0U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21FbGVtZW50cyhtYXRyaXhbMF0sIG1hdHJpeFsxXSwgbWF0cml4WzJdLCBzY3JhdGNoQ29sdW1uMikKICAgICAgICApOwogICAgICAgIHJlc3VsdC55ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzRdLCBtYXRyaXhbNV0sIG1hdHJpeFs2XSwgc2NyYXRjaENvbHVtbjIpCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFs4XSwgbWF0cml4WzldLCBtYXRyaXhbMTBdLCBzY3JhdGNoQ29sdW1uMikKICAgICAgICApOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LmdldE1heGltdW1TY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCkgewogICAgICAgIE1hdHJpeDQuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gzMik7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5tYXhpbXVtQ29tcG9uZW50KHNjYWxlU2NyYXRjaDMyKTsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoNDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDQuc2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJvdGF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNjYWxlID0gTWF0cml4NC5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDQyKTsKICAgICAgICByZXN1bHRbMF0gPSByb3RhdGlvblswXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gcm90YXRpb25bMV0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IHJvdGF0aW9uWzJdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gcm90YXRpb25bM10gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs1XSA9IHJvdGF0aW9uWzRdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNl0gPSByb3RhdGlvbls1XSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IHJvdGF0aW9uWzZdICogc2NhbGUuejsKICAgICAgICByZXN1bHRbOV0gPSByb3RhdGlvbls3XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzEwXSA9IHJvdGF0aW9uWzhdICogc2NhbGUuejsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2g1MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4NC5nZXRSb3RhdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDQuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2g1Mik7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdIC8gc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzRdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNV0gLyBzY2FsZS55OwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs2XSAvIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzhdIC8gc2NhbGUuejsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbOV0gLyBzY2FsZS56OwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFsxMF0gLyBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHkgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbGVmdDAgPSBsZWZ0WzBdOwogICAgICAgIGNvbnN0IGxlZnQxID0gbGVmdFsxXTsKICAgICAgICBjb25zdCBsZWZ0MiA9IGxlZnRbMl07CiAgICAgICAgY29uc3QgbGVmdDMgPSBsZWZ0WzNdOwogICAgICAgIGNvbnN0IGxlZnQ0ID0gbGVmdFs0XTsKICAgICAgICBjb25zdCBsZWZ0NSA9IGxlZnRbNV07CiAgICAgICAgY29uc3QgbGVmdDYgPSBsZWZ0WzZdOwogICAgICAgIGNvbnN0IGxlZnQ3ID0gbGVmdFs3XTsKICAgICAgICBjb25zdCBsZWZ0OCA9IGxlZnRbOF07CiAgICAgICAgY29uc3QgbGVmdDkgPSBsZWZ0WzldOwogICAgICAgIGNvbnN0IGxlZnQxMCA9IGxlZnRbMTBdOwogICAgICAgIGNvbnN0IGxlZnQxMSA9IGxlZnRbMTFdOwogICAgICAgIGNvbnN0IGxlZnQxMiA9IGxlZnRbMTJdOwogICAgICAgIGNvbnN0IGxlZnQxMyA9IGxlZnRbMTNdOwogICAgICAgIGNvbnN0IGxlZnQxNCA9IGxlZnRbMTRdOwogICAgICAgIGNvbnN0IGxlZnQxNSA9IGxlZnRbMTVdOwogICAgICAgIGNvbnN0IHJpZ2h0MCA9IHJpZ2h0WzBdOwogICAgICAgIGNvbnN0IHJpZ2h0MSA9IHJpZ2h0WzFdOwogICAgICAgIGNvbnN0IHJpZ2h0MiA9IHJpZ2h0WzJdOwogICAgICAgIGNvbnN0IHJpZ2h0MyA9IHJpZ2h0WzNdOwogICAgICAgIGNvbnN0IHJpZ2h0NCA9IHJpZ2h0WzRdOwogICAgICAgIGNvbnN0IHJpZ2h0NSA9IHJpZ2h0WzVdOwogICAgICAgIGNvbnN0IHJpZ2h0NiA9IHJpZ2h0WzZdOwogICAgICAgIGNvbnN0IHJpZ2h0NyA9IHJpZ2h0WzddOwogICAgICAgIGNvbnN0IHJpZ2h0OCA9IHJpZ2h0WzhdOwogICAgICAgIGNvbnN0IHJpZ2h0OSA9IHJpZ2h0WzldOwogICAgICAgIGNvbnN0IHJpZ2h0MTAgPSByaWdodFsxMF07CiAgICAgICAgY29uc3QgcmlnaHQxMSA9IHJpZ2h0WzExXTsKICAgICAgICBjb25zdCByaWdodDEyID0gcmlnaHRbMTJdOwogICAgICAgIGNvbnN0IHJpZ2h0MTMgPSByaWdodFsxM107CiAgICAgICAgY29uc3QgcmlnaHQxNCA9IHJpZ2h0WzE0XTsKICAgICAgICBjb25zdCByaWdodDE1ID0gcmlnaHRbMTVdOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gbGVmdDAgKiByaWdodDAgKyBsZWZ0NCAqIHJpZ2h0MSArIGxlZnQ4ICogcmlnaHQyICsgbGVmdDEyICogcmlnaHQzOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cxID0gbGVmdDEgKiByaWdodDAgKyBsZWZ0NSAqIHJpZ2h0MSArIGxlZnQ5ICogcmlnaHQyICsgbGVmdDEzICogcmlnaHQzOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cyID0gbGVmdDIgKiByaWdodDAgKyBsZWZ0NiAqIHJpZ2h0MSArIGxlZnQxMCAqIHJpZ2h0MiArIGxlZnQxNCAqIHJpZ2h0MzsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MyA9IGxlZnQzICogcmlnaHQwICsgbGVmdDcgKiByaWdodDEgKyBsZWZ0MTEgKiByaWdodDIgKyBsZWZ0MTUgKiByaWdodDM7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzAgPSBsZWZ0MCAqIHJpZ2h0NCArIGxlZnQ0ICogcmlnaHQ1ICsgbGVmdDggKiByaWdodDYgKyBsZWZ0MTIgKiByaWdodDc7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSBsZWZ0MSAqIHJpZ2h0NCArIGxlZnQ1ICogcmlnaHQ1ICsgbGVmdDkgKiByaWdodDYgKyBsZWZ0MTMgKiByaWdodDc7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzIgPSBsZWZ0MiAqIHJpZ2h0NCArIGxlZnQ2ICogcmlnaHQ1ICsgbGVmdDEwICogcmlnaHQ2ICsgbGVmdDE0ICogcmlnaHQ3OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3czID0gbGVmdDMgKiByaWdodDQgKyBsZWZ0NyAqIHJpZ2h0NSArIGxlZnQxMSAqIHJpZ2h0NiArIGxlZnQxNSAqIHJpZ2h0NzsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IGxlZnQwICogcmlnaHQ4ICsgbGVmdDQgKiByaWdodDkgKyBsZWZ0OCAqIHJpZ2h0MTAgKyBsZWZ0MTIgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cxID0gbGVmdDEgKiByaWdodDggKyBsZWZ0NSAqIHJpZ2h0OSArIGxlZnQ5ICogcmlnaHQxMCArIGxlZnQxMyAqIHJpZ2h0MTE7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzIgPSBsZWZ0MiAqIHJpZ2h0OCArIGxlZnQ2ICogcmlnaHQ5ICsgbGVmdDEwICogcmlnaHQxMCArIGxlZnQxNCAqIHJpZ2h0MTE7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzMgPSBsZWZ0MyAqIHJpZ2h0OCArIGxlZnQ3ICogcmlnaHQ5ICsgbGVmdDExICogcmlnaHQxMCArIGxlZnQxNSAqIHJpZ2h0MTE7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzAgPSBsZWZ0MCAqIHJpZ2h0MTIgKyBsZWZ0NCAqIHJpZ2h0MTMgKyBsZWZ0OCAqIHJpZ2h0MTQgKyBsZWZ0MTIgKiByaWdodDE1OwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cxID0gbGVmdDEgKiByaWdodDEyICsgbGVmdDUgKiByaWdodDEzICsgbGVmdDkgKiByaWdodDE0ICsgbGVmdDEzICogcmlnaHQxNTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MiA9IGxlZnQyICogcmlnaHQxMiArIGxlZnQ2ICogcmlnaHQxMyArIGxlZnQxMCAqIHJpZ2h0MTQgKyBsZWZ0MTQgKiByaWdodDE1OwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3czID0gbGVmdDMgKiByaWdodDEyICsgbGVmdDcgKiByaWdodDEzICsgbGVmdDExICogcmlnaHQxNCArIGxlZnQxNSAqIHJpZ2h0MTU7CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gY29sdW1uMFJvdzE7CiAgICAgICAgcmVzdWx0WzJdID0gY29sdW1uMFJvdzI7CiAgICAgICAgcmVzdWx0WzNdID0gY29sdW1uMFJvdzM7CiAgICAgICAgcmVzdWx0WzRdID0gY29sdW1uMVJvdzA7CiAgICAgICAgcmVzdWx0WzVdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmVzdWx0WzZdID0gY29sdW1uMVJvdzI7CiAgICAgICAgcmVzdWx0WzddID0gY29sdW1uMVJvdzM7CiAgICAgICAgcmVzdWx0WzhdID0gY29sdW1uMlJvdzA7CiAgICAgICAgcmVzdWx0WzldID0gY29sdW1uMlJvdzE7CiAgICAgICAgcmVzdWx0WzEwXSA9IGNvbHVtbjJSb3cyOwogICAgICAgIHJlc3VsdFsxMV0gPSBjb2x1bW4yUm93MzsKICAgICAgICByZXN1bHRbMTJdID0gY29sdW1uM1JvdzA7CiAgICAgICAgcmVzdWx0WzEzXSA9IGNvbHVtbjNSb3cxOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gY29sdW1uM1JvdzM7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5hZGQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbGVmdFswXSArIHJpZ2h0WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IGxlZnRbMV0gKyByaWdodFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBsZWZ0WzJdICsgcmlnaHRbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbGVmdFszXSArIHJpZ2h0WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IGxlZnRbNF0gKyByaWdodFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBsZWZ0WzVdICsgcmlnaHRbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbGVmdFs2XSArIHJpZ2h0WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IGxlZnRbN10gKyByaWdodFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBsZWZ0WzhdICsgcmlnaHRbOF07CiAgICAgICAgcmVzdWx0WzldID0gbGVmdFs5XSArIHJpZ2h0WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSBsZWZ0WzEwXSArIHJpZ2h0WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gbGVmdFsxMV0gKyByaWdodFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IGxlZnRbMTJdICsgcmlnaHRbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBsZWZ0WzEzXSArIHJpZ2h0WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbGVmdFsxNF0gKyByaWdodFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IGxlZnRbMTVdICsgcmlnaHRbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbGVmdFswXSAtIHJpZ2h0WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IGxlZnRbMV0gLSByaWdodFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBsZWZ0WzJdIC0gcmlnaHRbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbGVmdFszXSAtIHJpZ2h0WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IGxlZnRbNF0gLSByaWdodFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBsZWZ0WzVdIC0gcmlnaHRbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbGVmdFs2XSAtIHJpZ2h0WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IGxlZnRbN10gLSByaWdodFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBsZWZ0WzhdIC0gcmlnaHRbOF07CiAgICAgICAgcmVzdWx0WzldID0gbGVmdFs5XSAtIHJpZ2h0WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSBsZWZ0WzEwXSAtIHJpZ2h0WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gbGVmdFsxMV0gLSByaWdodFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IGxlZnRbMTJdIC0gcmlnaHRbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBsZWZ0WzEzXSAtIHJpZ2h0WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbGVmdFsxNF0gLSByaWdodFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IGxlZnRbMTVdIC0gcmlnaHRbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlUcmFuc2Zvcm1hdGlvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBsZWZ0MCA9IGxlZnRbMF07CiAgICAgICAgY29uc3QgbGVmdDEgPSBsZWZ0WzFdOwogICAgICAgIGNvbnN0IGxlZnQyID0gbGVmdFsyXTsKICAgICAgICBjb25zdCBsZWZ0NCA9IGxlZnRbNF07CiAgICAgICAgY29uc3QgbGVmdDUgPSBsZWZ0WzVdOwogICAgICAgIGNvbnN0IGxlZnQ2ID0gbGVmdFs2XTsKICAgICAgICBjb25zdCBsZWZ0OCA9IGxlZnRbOF07CiAgICAgICAgY29uc3QgbGVmdDkgPSBsZWZ0WzldOwogICAgICAgIGNvbnN0IGxlZnQxMCA9IGxlZnRbMTBdOwogICAgICAgIGNvbnN0IGxlZnQxMiA9IGxlZnRbMTJdOwogICAgICAgIGNvbnN0IGxlZnQxMyA9IGxlZnRbMTNdOwogICAgICAgIGNvbnN0IGxlZnQxNCA9IGxlZnRbMTRdOwogICAgICAgIGNvbnN0IHJpZ2h0MCA9IHJpZ2h0WzBdOwogICAgICAgIGNvbnN0IHJpZ2h0MSA9IHJpZ2h0WzFdOwogICAgICAgIGNvbnN0IHJpZ2h0MiA9IHJpZ2h0WzJdOwogICAgICAgIGNvbnN0IHJpZ2h0NCA9IHJpZ2h0WzRdOwogICAgICAgIGNvbnN0IHJpZ2h0NSA9IHJpZ2h0WzVdOwogICAgICAgIGNvbnN0IHJpZ2h0NiA9IHJpZ2h0WzZdOwogICAgICAgIGNvbnN0IHJpZ2h0OCA9IHJpZ2h0WzhdOwogICAgICAgIGNvbnN0IHJpZ2h0OSA9IHJpZ2h0WzldOwogICAgICAgIGNvbnN0IHJpZ2h0MTAgPSByaWdodFsxMF07CiAgICAgICAgY29uc3QgcmlnaHQxMiA9IHJpZ2h0WzEyXTsKICAgICAgICBjb25zdCByaWdodDEzID0gcmlnaHRbMTNdOwogICAgICAgIGNvbnN0IHJpZ2h0MTQgPSByaWdodFsxNF07CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSBsZWZ0MCAqIHJpZ2h0MCArIGxlZnQ0ICogcmlnaHQxICsgbGVmdDggKiByaWdodDI7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzEgPSBsZWZ0MSAqIHJpZ2h0MCArIGxlZnQ1ICogcmlnaHQxICsgbGVmdDkgKiByaWdodDI7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzIgPSBsZWZ0MiAqIHJpZ2h0MCArIGxlZnQ2ICogcmlnaHQxICsgbGVmdDEwICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbGVmdDAgKiByaWdodDQgKyBsZWZ0NCAqIHJpZ2h0NSArIGxlZnQ4ICogcmlnaHQ2OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbGVmdDEgKiByaWdodDQgKyBsZWZ0NSAqIHJpZ2h0NSArIGxlZnQ5ICogcmlnaHQ2OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cyID0gbGVmdDIgKiByaWdodDQgKyBsZWZ0NiAqIHJpZ2h0NSArIGxlZnQxMCAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IGxlZnQwICogcmlnaHQ4ICsgbGVmdDQgKiByaWdodDkgKyBsZWZ0OCAqIHJpZ2h0MTA7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSBsZWZ0MSAqIHJpZ2h0OCArIGxlZnQ1ICogcmlnaHQ5ICsgbGVmdDkgKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gbGVmdDIgKiByaWdodDggKyBsZWZ0NiAqIHJpZ2h0OSArIGxlZnQxMCAqIHJpZ2h0MTA7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzAgPSBsZWZ0MCAqIHJpZ2h0MTIgKyBsZWZ0NCAqIHJpZ2h0MTMgKyBsZWZ0OCAqIHJpZ2h0MTQgKyBsZWZ0MTI7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzEgPSBsZWZ0MSAqIHJpZ2h0MTIgKyBsZWZ0NSAqIHJpZ2h0MTMgKyBsZWZ0OSAqIHJpZ2h0MTQgKyBsZWZ0MTM7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzIgPSBsZWZ0MiAqIHJpZ2h0MTIgKyBsZWZ0NiAqIHJpZ2h0MTMgKyBsZWZ0MTAgKiByaWdodDE0ICsgbGVmdDE0OwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IGNvbHVtbjBSb3cxOwogICAgICAgIHJlc3VsdFsyXSA9IGNvbHVtbjBSb3cyOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gY29sdW1uMVJvdzA7CiAgICAgICAgcmVzdWx0WzVdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmVzdWx0WzZdID0gY29sdW1uMVJvdzI7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbOV0gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbMTBdID0gY29sdW1uMlJvdzI7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IGNvbHVtbjNSb3cwOwogICAgICAgIHJlc3VsdFsxM10gPSBjb2x1bW4zUm93MTsKICAgICAgICByZXN1bHRbMTRdID0gY29sdW1uM1JvdzI7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5TWF0cml4MyA9IGZ1bmN0aW9uKG1hdHJpeCwgcm90YXRpb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJvdGF0aW9uIiwgcm90YXRpb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBsZWZ0MCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBsZWZ0MSA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBsZWZ0MiA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBsZWZ0NCA9IG1hdHJpeFs0XTsKICAgICAgICBjb25zdCBsZWZ0NSA9IG1hdHJpeFs1XTsKICAgICAgICBjb25zdCBsZWZ0NiA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBsZWZ0OCA9IG1hdHJpeFs4XTsKICAgICAgICBjb25zdCBsZWZ0OSA9IG1hdHJpeFs5XTsKICAgICAgICBjb25zdCBsZWZ0MTAgPSBtYXRyaXhbMTBdOwogICAgICAgIGNvbnN0IHJpZ2h0MCA9IHJvdGF0aW9uWzBdOwogICAgICAgIGNvbnN0IHJpZ2h0MSA9IHJvdGF0aW9uWzFdOwogICAgICAgIGNvbnN0IHJpZ2h0MiA9IHJvdGF0aW9uWzJdOwogICAgICAgIGNvbnN0IHJpZ2h0NCA9IHJvdGF0aW9uWzNdOwogICAgICAgIGNvbnN0IHJpZ2h0NSA9IHJvdGF0aW9uWzRdOwogICAgICAgIGNvbnN0IHJpZ2h0NiA9IHJvdGF0aW9uWzVdOwogICAgICAgIGNvbnN0IHJpZ2h0OCA9IHJvdGF0aW9uWzZdOwogICAgICAgIGNvbnN0IHJpZ2h0OSA9IHJvdGF0aW9uWzddOwogICAgICAgIGNvbnN0IHJpZ2h0MTAgPSByb3RhdGlvbls4XTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGxlZnQwICogcmlnaHQwICsgbGVmdDQgKiByaWdodDEgKyBsZWZ0OCAqIHJpZ2h0MjsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IGxlZnQxICogcmlnaHQwICsgbGVmdDUgKiByaWdodDEgKyBsZWZ0OSAqIHJpZ2h0MjsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IGxlZnQyICogcmlnaHQwICsgbGVmdDYgKiByaWdodDEgKyBsZWZ0MTAgKiByaWdodDI7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzAgPSBsZWZ0MCAqIHJpZ2h0NCArIGxlZnQ0ICogcmlnaHQ1ICsgbGVmdDggKiByaWdodDY7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSBsZWZ0MSAqIHJpZ2h0NCArIGxlZnQ1ICogcmlnaHQ1ICsgbGVmdDkgKiByaWdodDY7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzIgPSBsZWZ0MiAqIHJpZ2h0NCArIGxlZnQ2ICogcmlnaHQ1ICsgbGVmdDEwICogcmlnaHQ2OwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cwID0gbGVmdDAgKiByaWdodDggKyBsZWZ0NCAqIHJpZ2h0OSArIGxlZnQ4ICogcmlnaHQxMDsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IGxlZnQxICogcmlnaHQ4ICsgbGVmdDUgKiByaWdodDkgKyBsZWZ0OSAqIHJpZ2h0MTA7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzIgPSBsZWZ0MiAqIHJpZ2h0OCArIGxlZnQ2ICogcmlnaHQ5ICsgbGVmdDEwICogcmlnaHQxMDsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IGNvbHVtbjFSb3cyOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gY29sdW1uMlJvdzA7CiAgICAgICAgcmVzdWx0WzldID0gY29sdW1uMlJvdzE7CiAgICAgICAgcmVzdWx0WzEwXSA9IGNvbHVtbjJSb3cyOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeVRyYW5zbGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCB0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zbGF0aW9uIiwgdHJhbnNsYXRpb24yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IHRyYW5zbGF0aW9uMi54OwogICAgICAgIGNvbnN0IHkgPSB0cmFuc2xhdGlvbjIueTsKICAgICAgICBjb25zdCB6ID0gdHJhbnNsYXRpb24yLno7CiAgICAgICAgY29uc3QgdHggPSB4ICogbWF0cml4WzBdICsgeSAqIG1hdHJpeFs0XSArIHogKiBtYXRyaXhbOF0gKyBtYXRyaXhbMTJdOwogICAgICAgIGNvbnN0IHR5ID0geCAqIG1hdHJpeFsxXSArIHkgKiBtYXRyaXhbNV0gKyB6ICogbWF0cml4WzldICsgbWF0cml4WzEzXTsKICAgICAgICBjb25zdCB0eiA9IHggKiBtYXRyaXhbMl0gKyB5ICogbWF0cml4WzZdICsgeiAqIG1hdHJpeFsxMF0gKyBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gdHg7CiAgICAgICAgcmVzdWx0WzEzXSA9IHR5OwogICAgICAgIHJlc3VsdFsxNF0gPSB0ejsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5QnlTY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZVggPSBzY2FsZS54OwogICAgICAgIGNvbnN0IHNjYWxlWSA9IHNjYWxlLnk7CiAgICAgICAgY29uc3Qgc2NhbGVaID0gc2NhbGUuejsKICAgICAgICBpZiAoc2NhbGVYID09PSAxICYmIHNjYWxlWSA9PT0gMSAmJiBzY2FsZVogPT09IDEpIHsKICAgICAgICAgIHJldHVybiBNYXRyaXg0LmNsb25lKG1hdHJpeCwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc2NhbGVYICogbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IHNjYWxlWCAqIG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBzY2FsZVggKiBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IHNjYWxlWSAqIG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBzY2FsZVkgKiBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gc2NhbGVZICogbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBzY2FsZVogKiBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzldID0gc2NhbGVaICogbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSBzY2FsZVogKiBtYXRyaXhbMTBdOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeVVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeFs5XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXhbMTBdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5VmVjdG9yID0gZnVuY3Rpb24obWF0cml4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB2WCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgdlkgPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIGNvbnN0IHZaID0gY2FydGVzaWFuMTEuejsKICAgICAgICBjb25zdCB2VyA9IGNhcnRlc2lhbjExLnc7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIHZYICsgbWF0cml4WzRdICogdlkgKyBtYXRyaXhbOF0gKiB2WiArIG1hdHJpeFsxMl0gKiB2VzsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNV0gKiB2WSArIG1hdHJpeFs5XSAqIHZaICsgbWF0cml4WzEzXSAqIHZXOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbMl0gKiB2WCArIG1hdHJpeFs2XSAqIHZZICsgbWF0cml4WzEwXSAqIHZaICsgbWF0cml4WzE0XSAqIHZXOwogICAgICAgIGNvbnN0IHcgPSBtYXRyaXhbM10gKiB2WCArIG1hdHJpeFs3XSAqIHZZICsgbWF0cml4WzExXSAqIHZaICsgbWF0cml4WzE1XSAqIHZXOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJlc3VsdC53ID0gdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5QnlQb2ludEFzVmVjdG9yID0gZnVuY3Rpb24obWF0cml4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB2WCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgdlkgPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIGNvbnN0IHZaID0gY2FydGVzaWFuMTEuejsKICAgICAgICBjb25zdCB4ID0gbWF0cml4WzBdICogdlggKyBtYXRyaXhbNF0gKiB2WSArIG1hdHJpeFs4XSAqIHZaOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbMV0gKiB2WCArIG1hdHJpeFs1XSAqIHZZICsgbWF0cml4WzldICogdlo7CiAgICAgICAgY29uc3QgeiA9IG1hdHJpeFsyXSAqIHZYICsgbWF0cml4WzZdICogdlkgKyBtYXRyaXhbMTBdICogdlo7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5UG9pbnQgPSBmdW5jdGlvbihtYXRyaXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHZYID0gY2FydGVzaWFuMTEueDsKICAgICAgICBjb25zdCB2WSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgY29uc3QgdlogPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbMF0gKiB2WCArIG1hdHJpeFs0XSAqIHZZICsgbWF0cml4WzhdICogdlogKyBtYXRyaXhbMTJdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbMV0gKiB2WCArIG1hdHJpeFs1XSAqIHZZICsgbWF0cml4WzldICogdlogKyBtYXRyaXhbMTNdOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbMl0gKiB2WCArIG1hdHJpeFs2XSAqIHZZICsgbWF0cml4WzEwXSAqIHZaICsgbWF0cml4WzE0XTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5QnlTY2FsYXIgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXhbMTBdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubmVnYXRlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IC1tYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gLW1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSAtbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IC1tYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gLW1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSAtbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IC1tYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gLW1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSAtbWF0cml4WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IC1tYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzEwXSA9IC1tYXRyaXhbMTBdOwogICAgICAgIHJlc3VsdFsxMV0gPSAtbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gLW1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IC1tYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSAtbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gLW1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC50cmFuc3Bvc2UgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbWF0cml4MSA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBtYXRyaXgyID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IG1hdHJpeDMgPSBtYXRyaXhbM107CiAgICAgICAgY29uc3QgbWF0cml4NiA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBtYXRyaXg3ID0gbWF0cml4WzddOwogICAgICAgIGNvbnN0IG1hdHJpeDExID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeDE7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs5XTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeDI7CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4NjsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4MzsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4NzsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4MTE7CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5hYnMgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gTWF0aC5hYnMobWF0cml4WzBdKTsKICAgICAgICByZXN1bHRbMV0gPSBNYXRoLmFicyhtYXRyaXhbMV0pOwogICAgICAgIHJlc3VsdFsyXSA9IE1hdGguYWJzKG1hdHJpeFsyXSk7CiAgICAgICAgcmVzdWx0WzNdID0gTWF0aC5hYnMobWF0cml4WzNdKTsKICAgICAgICByZXN1bHRbNF0gPSBNYXRoLmFicyhtYXRyaXhbNF0pOwogICAgICAgIHJlc3VsdFs1XSA9IE1hdGguYWJzKG1hdHJpeFs1XSk7CiAgICAgICAgcmVzdWx0WzZdID0gTWF0aC5hYnMobWF0cml4WzZdKTsKICAgICAgICByZXN1bHRbN10gPSBNYXRoLmFicyhtYXRyaXhbN10pOwogICAgICAgIHJlc3VsdFs4XSA9IE1hdGguYWJzKG1hdHJpeFs4XSk7CiAgICAgICAgcmVzdWx0WzldID0gTWF0aC5hYnMobWF0cml4WzldKTsKICAgICAgICByZXN1bHRbMTBdID0gTWF0aC5hYnMobWF0cml4WzEwXSk7CiAgICAgICAgcmVzdWx0WzExXSA9IE1hdGguYWJzKG1hdHJpeFsxMV0pOwogICAgICAgIHJlc3VsdFsxMl0gPSBNYXRoLmFicyhtYXRyaXhbMTJdKTsKICAgICAgICByZXN1bHRbMTNdID0gTWF0aC5hYnMobWF0cml4WzEzXSk7CiAgICAgICAgcmVzdWx0WzE0XSA9IE1hdGguYWJzKG1hdHJpeFsxNF0pOwogICAgICAgIHJlc3VsdFsxNV0gPSBNYXRoLmFicyhtYXRyaXhbMTVdKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIC8vIFRyYW5zbGF0aW9uCiAgICAgICAgbGVmdFsxMl0gPT09IHJpZ2h0WzEyXSAmJiBsZWZ0WzEzXSA9PT0gcmlnaHRbMTNdICYmIGxlZnRbMTRdID09PSByaWdodFsxNF0gJiYgLy8gUm90YXRpb24vc2NhbGUKICAgICAgICBsZWZ0WzBdID09PSByaWdodFswXSAmJiBsZWZ0WzFdID09PSByaWdodFsxXSAmJiBsZWZ0WzJdID09PSByaWdodFsyXSAmJiBsZWZ0WzRdID09PSByaWdodFs0XSAmJiBsZWZ0WzVdID09PSByaWdodFs1XSAmJiBsZWZ0WzZdID09PSByaWdodFs2XSAmJiBsZWZ0WzhdID09PSByaWdodFs4XSAmJiBsZWZ0WzldID09PSByaWdodFs5XSAmJiBsZWZ0WzEwXSA9PT0gcmlnaHRbMTBdICYmIC8vIEJvdHRvbSByb3cKICAgICAgICBsZWZ0WzNdID09PSByaWdodFszXSAmJiBsZWZ0WzddID09PSByaWdodFs3XSAmJiBsZWZ0WzExXSA9PT0gcmlnaHRbMTFdICYmIGxlZnRbMTVdID09PSByaWdodFsxNV07CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0WzBdIC0gcmlnaHRbMF0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFsxXSAtIHJpZ2h0WzFdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMl0gLSByaWdodFsyXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzNdIC0gcmlnaHRbM10pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs0XSAtIHJpZ2h0WzRdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbNV0gLSByaWdodFs1XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzZdIC0gcmlnaHRbNl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs3XSAtIHJpZ2h0WzddKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbOF0gLSByaWdodFs4XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzldIC0gcmlnaHRbOV0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFsxMF0gLSByaWdodFsxMF0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFsxMV0gLSByaWdodFsxMV0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFsxMl0gLSByaWdodFsxMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFsxM10gLSByaWdodFsxM10pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFsxNF0gLSByaWdodFsxNF0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFsxNV0gLSByaWdodFsxNV0pIDw9IGVwc2lsb247CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0VHJhbnNsYXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdC55ID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHQueiA9IG1hdHJpeFsxNF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5nZXRNYXRyaXgzID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzEwXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoSW52ZXJzZVJvdGF0aW9uID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWF0cml4M1plcm8gPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCb3R0b21Sb3cgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFeHBlY3RlZEJvdHRvbVJvdyA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoMCwgMCwgMCwgMSk7CiAgICAgIE1hdHJpeDQuaW52ZXJzZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzcmMwID0gbWF0cml4WzBdOwogICAgICAgIGNvbnN0IHNyYzEgPSBtYXRyaXhbNF07CiAgICAgICAgY29uc3Qgc3JjMiA9IG1hdHJpeFs4XTsKICAgICAgICBjb25zdCBzcmMzID0gbWF0cml4WzEyXTsKICAgICAgICBjb25zdCBzcmM0ID0gbWF0cml4WzFdOwogICAgICAgIGNvbnN0IHNyYzUgPSBtYXRyaXhbNV07CiAgICAgICAgY29uc3Qgc3JjNiA9IG1hdHJpeFs5XTsKICAgICAgICBjb25zdCBzcmM3ID0gbWF0cml4WzEzXTsKICAgICAgICBjb25zdCBzcmM4ID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IHNyYzkgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3Qgc3JjMTAgPSBtYXRyaXhbMTBdOwogICAgICAgIGNvbnN0IHNyYzExID0gbWF0cml4WzE0XTsKICAgICAgICBjb25zdCBzcmMxMiA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBzcmMxMyA9IG1hdHJpeFs3XTsKICAgICAgICBjb25zdCBzcmMxNCA9IG1hdHJpeFsxMV07CiAgICAgICAgY29uc3Qgc3JjMTUgPSBtYXRyaXhbMTVdOwogICAgICAgIGxldCB0bXAwID0gc3JjMTAgKiBzcmMxNTsKICAgICAgICBsZXQgdG1wMSA9IHNyYzExICogc3JjMTQ7CiAgICAgICAgbGV0IHRtcDIgPSBzcmM5ICogc3JjMTU7CiAgICAgICAgbGV0IHRtcDMgPSBzcmMxMSAqIHNyYzEzOwogICAgICAgIGxldCB0bXA0ID0gc3JjOSAqIHNyYzE0OwogICAgICAgIGxldCB0bXA1ID0gc3JjMTAgKiBzcmMxMzsKICAgICAgICBsZXQgdG1wNiA9IHNyYzggKiBzcmMxNTsKICAgICAgICBsZXQgdG1wNyA9IHNyYzExICogc3JjMTI7CiAgICAgICAgbGV0IHRtcDggPSBzcmM4ICogc3JjMTQ7CiAgICAgICAgbGV0IHRtcDkgPSBzcmMxMCAqIHNyYzEyOwogICAgICAgIGxldCB0bXAxMCA9IHNyYzggKiBzcmMxMzsKICAgICAgICBsZXQgdG1wMTEgPSBzcmM5ICogc3JjMTI7CiAgICAgICAgY29uc3QgZHN0MCA9IHRtcDAgKiBzcmM1ICsgdG1wMyAqIHNyYzYgKyB0bXA0ICogc3JjNyAtICh0bXAxICogc3JjNSArIHRtcDIgKiBzcmM2ICsgdG1wNSAqIHNyYzcpOwogICAgICAgIGNvbnN0IGRzdDEgPSB0bXAxICogc3JjNCArIHRtcDYgKiBzcmM2ICsgdG1wOSAqIHNyYzcgLSAodG1wMCAqIHNyYzQgKyB0bXA3ICogc3JjNiArIHRtcDggKiBzcmM3KTsKICAgICAgICBjb25zdCBkc3QyID0gdG1wMiAqIHNyYzQgKyB0bXA3ICogc3JjNSArIHRtcDEwICogc3JjNyAtICh0bXAzICogc3JjNCArIHRtcDYgKiBzcmM1ICsgdG1wMTEgKiBzcmM3KTsKICAgICAgICBjb25zdCBkc3QzID0gdG1wNSAqIHNyYzQgKyB0bXA4ICogc3JjNSArIHRtcDExICogc3JjNiAtICh0bXA0ICogc3JjNCArIHRtcDkgKiBzcmM1ICsgdG1wMTAgKiBzcmM2KTsKICAgICAgICBjb25zdCBkc3Q0ID0gdG1wMSAqIHNyYzEgKyB0bXAyICogc3JjMiArIHRtcDUgKiBzcmMzIC0gKHRtcDAgKiBzcmMxICsgdG1wMyAqIHNyYzIgKyB0bXA0ICogc3JjMyk7CiAgICAgICAgY29uc3QgZHN0NSA9IHRtcDAgKiBzcmMwICsgdG1wNyAqIHNyYzIgKyB0bXA4ICogc3JjMyAtICh0bXAxICogc3JjMCArIHRtcDYgKiBzcmMyICsgdG1wOSAqIHNyYzMpOwogICAgICAgIGNvbnN0IGRzdDYgPSB0bXAzICogc3JjMCArIHRtcDYgKiBzcmMxICsgdG1wMTEgKiBzcmMzIC0gKHRtcDIgKiBzcmMwICsgdG1wNyAqIHNyYzEgKyB0bXAxMCAqIHNyYzMpOwogICAgICAgIGNvbnN0IGRzdDcgPSB0bXA0ICogc3JjMCArIHRtcDkgKiBzcmMxICsgdG1wMTAgKiBzcmMyIC0gKHRtcDUgKiBzcmMwICsgdG1wOCAqIHNyYzEgKyB0bXAxMSAqIHNyYzIpOwogICAgICAgIHRtcDAgPSBzcmMyICogc3JjNzsKICAgICAgICB0bXAxID0gc3JjMyAqIHNyYzY7CiAgICAgICAgdG1wMiA9IHNyYzEgKiBzcmM3OwogICAgICAgIHRtcDMgPSBzcmMzICogc3JjNTsKICAgICAgICB0bXA0ID0gc3JjMSAqIHNyYzY7CiAgICAgICAgdG1wNSA9IHNyYzIgKiBzcmM1OwogICAgICAgIHRtcDYgPSBzcmMwICogc3JjNzsKICAgICAgICB0bXA3ID0gc3JjMyAqIHNyYzQ7CiAgICAgICAgdG1wOCA9IHNyYzAgKiBzcmM2OwogICAgICAgIHRtcDkgPSBzcmMyICogc3JjNDsKICAgICAgICB0bXAxMCA9IHNyYzAgKiBzcmM1OwogICAgICAgIHRtcDExID0gc3JjMSAqIHNyYzQ7CiAgICAgICAgY29uc3QgZHN0OCA9IHRtcDAgKiBzcmMxMyArIHRtcDMgKiBzcmMxNCArIHRtcDQgKiBzcmMxNSAtICh0bXAxICogc3JjMTMgKyB0bXAyICogc3JjMTQgKyB0bXA1ICogc3JjMTUpOwogICAgICAgIGNvbnN0IGRzdDkgPSB0bXAxICogc3JjMTIgKyB0bXA2ICogc3JjMTQgKyB0bXA5ICogc3JjMTUgLSAodG1wMCAqIHNyYzEyICsgdG1wNyAqIHNyYzE0ICsgdG1wOCAqIHNyYzE1KTsKICAgICAgICBjb25zdCBkc3QxMCA9IHRtcDIgKiBzcmMxMiArIHRtcDcgKiBzcmMxMyArIHRtcDEwICogc3JjMTUgLSAodG1wMyAqIHNyYzEyICsgdG1wNiAqIHNyYzEzICsgdG1wMTEgKiBzcmMxNSk7CiAgICAgICAgY29uc3QgZHN0MTEgPSB0bXA1ICogc3JjMTIgKyB0bXA4ICogc3JjMTMgKyB0bXAxMSAqIHNyYzE0IC0gKHRtcDQgKiBzcmMxMiArIHRtcDkgKiBzcmMxMyArIHRtcDEwICogc3JjMTQpOwogICAgICAgIGNvbnN0IGRzdDEyID0gdG1wMiAqIHNyYzEwICsgdG1wNSAqIHNyYzExICsgdG1wMSAqIHNyYzkgLSAodG1wNCAqIHNyYzExICsgdG1wMCAqIHNyYzkgKyB0bXAzICogc3JjMTApOwogICAgICAgIGNvbnN0IGRzdDEzID0gdG1wOCAqIHNyYzExICsgdG1wMCAqIHNyYzggKyB0bXA3ICogc3JjMTAgLSAodG1wNiAqIHNyYzEwICsgdG1wOSAqIHNyYzExICsgdG1wMSAqIHNyYzgpOwogICAgICAgIGNvbnN0IGRzdDE0ID0gdG1wNiAqIHNyYzkgKyB0bXAxMSAqIHNyYzExICsgdG1wMyAqIHNyYzggLSAodG1wMTAgKiBzcmMxMSArIHRtcDIgKiBzcmM4ICsgdG1wNyAqIHNyYzkpOwogICAgICAgIGNvbnN0IGRzdDE1ID0gdG1wMTAgKiBzcmMxMCArIHRtcDQgKiBzcmM4ICsgdG1wOSAqIHNyYzkgLSAodG1wOCAqIHNyYzkgKyB0bXAxMSAqIHNyYzEwICsgdG1wNSAqIHNyYzgpOwogICAgICAgIGxldCBkZXQgPSBzcmMwICogZHN0MCArIHNyYzEgKiBkc3QxICsgc3JjMiAqIGRzdDIgKyBzcmMzICogZHN0MzsKICAgICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMjEpIHsKICAgICAgICAgIGlmIChNYXRyaXgzX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgICAgTWF0cml4NC5nZXRNYXRyaXgzKG1hdHJpeCwgc2NyYXRjaEludmVyc2VSb3RhdGlvbiksCiAgICAgICAgICAgIHNjcmF0Y2hNYXRyaXgzWmVybywKICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT043CiAgICAgICAgICApICYmIENhcnRlc2lhbjRfZGVmYXVsdC5lcXVhbHMoCiAgICAgICAgICAgIE1hdHJpeDQuZ2V0Um93KG1hdHJpeCwgMywgc2NyYXRjaEJvdHRvbVJvdyksCiAgICAgICAgICAgIHNjcmF0Y2hFeHBlY3RlZEJvdHRvbVJvdwogICAgICAgICAgKSkgewogICAgICAgICAgICByZXN1bHRbMF0gPSAwOwogICAgICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgICAgICByZXN1bHRbNV0gPSAwOwogICAgICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgICAgICByZXN1bHRbOF0gPSAwOwogICAgICAgICAgICByZXN1bHRbOV0gPSAwOwogICAgICAgICAgICByZXN1bHRbMTBdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgICAgIHJlc3VsdFsxMl0gPSAtbWF0cml4WzEyXTsKICAgICAgICAgICAgcmVzdWx0WzEzXSA9IC1tYXRyaXhbMTNdOwogICAgICAgICAgICByZXN1bHRbMTRdID0gLW1hdHJpeFsxNF07CiAgICAgICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAibWF0cml4IGlzIG5vdCBpbnZlcnRpYmxlIGJlY2F1c2UgaXRzIGRldGVybWluYXRlIGlzIHplcm8uIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZGV0ID0gMSAvIGRldDsKICAgICAgICByZXN1bHRbMF0gPSBkc3QwICogZGV0OwogICAgICAgIHJlc3VsdFsxXSA9IGRzdDEgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzJdID0gZHN0MiAqIGRldDsKICAgICAgICByZXN1bHRbM10gPSBkc3QzICogZGV0OwogICAgICAgIHJlc3VsdFs0XSA9IGRzdDQgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzVdID0gZHN0NSAqIGRldDsKICAgICAgICByZXN1bHRbNl0gPSBkc3Q2ICogZGV0OwogICAgICAgIHJlc3VsdFs3XSA9IGRzdDcgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzhdID0gZHN0OCAqIGRldDsKICAgICAgICByZXN1bHRbOV0gPSBkc3Q5ICogZGV0OwogICAgICAgIHJlc3VsdFsxMF0gPSBkc3QxMCAqIGRldDsKICAgICAgICByZXN1bHRbMTFdID0gZHN0MTEgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzEyXSA9IGRzdDEyICogZGV0OwogICAgICAgIHJlc3VsdFsxM10gPSBkc3QxMyAqIGRldDsKICAgICAgICByZXN1bHRbMTRdID0gZHN0MTQgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzE1XSA9IGRzdDE1ICogZGV0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG1hdHJpeDAgPSBtYXRyaXhbMF07CiAgICAgICAgY29uc3QgbWF0cml4MSA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBtYXRyaXgyID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IG1hdHJpeDQgPSBtYXRyaXhbNF07CiAgICAgICAgY29uc3QgbWF0cml4NSA9IG1hdHJpeFs1XTsKICAgICAgICBjb25zdCBtYXRyaXg2ID0gbWF0cml4WzZdOwogICAgICAgIGNvbnN0IG1hdHJpeDggPSBtYXRyaXhbOF07CiAgICAgICAgY29uc3QgbWF0cml4OSA9IG1hdHJpeFs5XTsKICAgICAgICBjb25zdCBtYXRyaXgxMCA9IG1hdHJpeFsxMF07CiAgICAgICAgY29uc3QgdlggPSBtYXRyaXhbMTJdOwogICAgICAgIGNvbnN0IHZZID0gbWF0cml4WzEzXTsKICAgICAgICBjb25zdCB2WiA9IG1hdHJpeFsxNF07CiAgICAgICAgY29uc3QgeCA9IC1tYXRyaXgwICogdlggLSBtYXRyaXgxICogdlkgLSBtYXRyaXgyICogdlo7CiAgICAgICAgY29uc3QgeSA9IC1tYXRyaXg0ICogdlggLSBtYXRyaXg1ICogdlkgLSBtYXRyaXg2ICogdlo7CiAgICAgICAgY29uc3QgeiA9IC1tYXRyaXg4ICogdlggLSBtYXRyaXg5ICogdlkgLSBtYXRyaXgxMCAqIHZaOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeDA7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4NDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXg4OwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4MTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXg1OwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeDk7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXgyOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeDY7CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeDEwOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSB4OwogICAgICAgIHJlc3VsdFsxM10gPSB5OwogICAgICAgIHJlc3VsdFsxNF0gPSB6OwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hUcmFuc3Bvc2VNYXRyaXgyID0gbmV3IE1hdHJpeDQoKTsKICAgICAgTWF0cml4NC5pbnZlcnNlVHJhbnNwb3NlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmludmVyc2UoCiAgICAgICAgICBNYXRyaXg0LnRyYW5zcG9zZShtYXRyaXgsIHNjcmF0Y2hUcmFuc3Bvc2VNYXRyaXgyKSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuSURFTlRJVFkgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBNYXRyaXg0KAogICAgICAgICAgMSwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAxLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDEsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMQogICAgICAgICkKICAgICAgKTsKICAgICAgTWF0cml4NC5aRVJPID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgTWF0cml4NCgKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAKICAgICAgICApCiAgICAgICk7CiAgICAgIE1hdHJpeDQuQ09MVU1OMFJPVzAgPSAwOwogICAgICBNYXRyaXg0LkNPTFVNTjBST1cxID0gMTsKICAgICAgTWF0cml4NC5DT0xVTU4wUk9XMiA9IDI7CiAgICAgIE1hdHJpeDQuQ09MVU1OMFJPVzMgPSAzOwogICAgICBNYXRyaXg0LkNPTFVNTjFST1cwID0gNDsKICAgICAgTWF0cml4NC5DT0xVTU4xUk9XMSA9IDU7CiAgICAgIE1hdHJpeDQuQ09MVU1OMVJPVzIgPSA2OwogICAgICBNYXRyaXg0LkNPTFVNTjFST1czID0gNzsKICAgICAgTWF0cml4NC5DT0xVTU4yUk9XMCA9IDg7CiAgICAgIE1hdHJpeDQuQ09MVU1OMlJPVzEgPSA5OwogICAgICBNYXRyaXg0LkNPTFVNTjJST1cyID0gMTA7CiAgICAgIE1hdHJpeDQuQ09MVU1OMlJPVzMgPSAxMTsKICAgICAgTWF0cml4NC5DT0xVTU4zUk9XMCA9IDEyOwogICAgICBNYXRyaXg0LkNPTFVNTjNST1cxID0gMTM7CiAgICAgIE1hdHJpeDQuQ09MVU1OM1JPVzIgPSAxNDsKICAgICAgTWF0cml4NC5DT0xVTU4zUk9XMyA9IDE1OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhNYXRyaXg0LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG51bWJlciBvZiBpdGVtcyBpbiB0aGUgY29sbGVjdGlvbi4KICAgICAgICAgKiBAbWVtYmVyb2YgTWF0cml4NC5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gTWF0cml4NC5wYWNrZWRMZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgTWF0cml4NC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4NC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBNYXRyaXg0LnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBNYXRyaXg0LmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihtYXRyaXgsIGFycmF5LCBvZmZzZXQpIHsKICAgICAgICByZXR1cm4gbWF0cml4WzBdID09PSBhcnJheVtvZmZzZXRdICYmIG1hdHJpeFsxXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV0gJiYgbWF0cml4WzJdID09PSBhcnJheVtvZmZzZXQgKyAyXSAmJiBtYXRyaXhbM10gPT09IGFycmF5W29mZnNldCArIDNdICYmIG1hdHJpeFs0XSA9PT0gYXJyYXlbb2Zmc2V0ICsgNF0gJiYgbWF0cml4WzVdID09PSBhcnJheVtvZmZzZXQgKyA1XSAmJiBtYXRyaXhbNl0gPT09IGFycmF5W29mZnNldCArIDZdICYmIG1hdHJpeFs3XSA9PT0gYXJyYXlbb2Zmc2V0ICsgN10gJiYgbWF0cml4WzhdID09PSBhcnJheVtvZmZzZXQgKyA4XSAmJiBtYXRyaXhbOV0gPT09IGFycmF5W29mZnNldCArIDldICYmIG1hdHJpeFsxMF0gPT09IGFycmF5W29mZnNldCArIDEwXSAmJiBtYXRyaXhbMTFdID09PSBhcnJheVtvZmZzZXQgKyAxMV0gJiYgbWF0cml4WzEyXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMTJdICYmIG1hdHJpeFsxM10gPT09IGFycmF5W29mZnNldCArIDEzXSAmJiBtYXRyaXhbMTRdID09PSBhcnJheVtvZmZzZXQgKyAxNF0gJiYgbWF0cml4WzE1XSA9PT0gYXJyYXlbb2Zmc2V0ICsgMTVdOwogICAgICB9OwogICAgICBNYXRyaXg0LnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gTWF0cml4NC5lcXVhbHNFcHNpbG9uKHRoaXMsIHJpZ2h0LCBlcHNpbG9uKTsKICAgICAgfTsKICAgICAgTWF0cml4NC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXNbMF19LCAke3RoaXNbNF19LCAke3RoaXNbOF19LCAke3RoaXNbMTJdfSkKKCR7dGhpc1sxXX0sICR7dGhpc1s1XX0sICR7dGhpc1s5XX0sICR7dGhpc1sxM119KQooJHt0aGlzWzJdfSwgJHt0aGlzWzZdfSwgJHt0aGlzWzEwXX0sICR7dGhpc1sxNF19KQooJHt0aGlzWzNdfSwgJHt0aGlzWzddfSwgJHt0aGlzWzExXX0sICR7dGhpc1sxNV19KWA7CiAgICAgIH07CiAgICAgIE1hdHJpeDRfZGVmYXVsdCA9IE1hdHJpeDQ7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9iaW5hcnlTZWFyY2guanMKICBmdW5jdGlvbiBiaW5hcnlTZWFyY2goYXJyYXksIGl0ZW1Ub0ZpbmQsIGNvbXBhcmF0b3IpIHsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIml0ZW1Ub0ZpbmQiLCBpdGVtVG9GaW5kKTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY29tcGFyYXRvciIsIGNvbXBhcmF0b3IpOwogICAgbGV0IGxvdyA9IDA7CiAgICBsZXQgaGlnaCA9IGFycmF5Lmxlbmd0aCAtIDE7CiAgICBsZXQgaTsKICAgIGxldCBjb21wYXJpc29uOwogICAgd2hpbGUgKGxvdyA8PSBoaWdoKSB7CiAgICAgIGkgPSB+figobG93ICsgaGlnaCkgLyAyKTsKICAgICAgY29tcGFyaXNvbiA9IGNvbXBhcmF0b3IoYXJyYXlbaV0sIGl0ZW1Ub0ZpbmQpOwogICAgICBpZiAoY29tcGFyaXNvbiA8IDApIHsKICAgICAgICBsb3cgPSBpICsgMTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoY29tcGFyaXNvbiA+IDApIHsKICAgICAgICBoaWdoID0gaSAtIDE7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGk7CiAgICB9CiAgICByZXR1cm4gfihoaWdoICsgMSk7CiAgfQogIHZhciBiaW5hcnlTZWFyY2hfZGVmYXVsdDsKICB2YXIgaW5pdF9iaW5hcnlTZWFyY2ggPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2JpbmFyeVNlYXJjaC5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgYmluYXJ5U2VhcmNoX2RlZmF1bHQgPSBiaW5hcnlTZWFyY2g7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZS5qcwogIGZ1bmN0aW9uIEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlKHhQb2xlV2FuZGVyLCB5UG9sZVdhbmRlciwgeFBvbGVPZmZzZXQsIHlQb2xlT2Zmc2V0LCB1dDFNaW51c1V0YykgewogICAgdGhpcy54UG9sZVdhbmRlciA9IHhQb2xlV2FuZGVyOwogICAgdGhpcy55UG9sZVdhbmRlciA9IHlQb2xlV2FuZGVyOwogICAgdGhpcy54UG9sZU9mZnNldCA9IHhQb2xlT2Zmc2V0OwogICAgdGhpcy55UG9sZU9mZnNldCA9IHlQb2xlT2Zmc2V0OwogICAgdGhpcy51dDFNaW51c1V0YyA9IHV0MU1pbnVzVXRjOwogIH0KICB2YXIgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGVfZGVmYXVsdDsKICB2YXIgaW5pdF9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGUuanMiKCkgewogICAgICBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZV9kZWZhdWx0ID0gRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0xlYXBZZWFyLmpzCiAgZnVuY3Rpb24gaXNMZWFwWWVhcih5ZWFyKSB7CiAgICBpZiAoeWVhciA9PT0gbnVsbCB8fCBpc05hTih5ZWFyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieWVhciBpcyByZXF1aXJlZCBhbmQgbXVzdCBiZSBhIG51bWJlci4iKTsKICAgIH0KICAgIHJldHVybiB5ZWFyICUgNCA9PT0gMCAmJiB5ZWFyICUgMTAwICE9PSAwIHx8IHllYXIgJSA0MDAgPT09IDA7CiAgfQogIHZhciBpc0xlYXBZZWFyX2RlZmF1bHQ7CiAgdmFyIGluaXRfaXNMZWFwWWVhciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvaXNMZWFwWWVhci5qcyIoKSB7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaXNMZWFwWWVhcl9kZWZhdWx0ID0gaXNMZWFwWWVhcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dyZWdvcmlhbkRhdGUuanMKICBmdW5jdGlvbiBHcmVnb3JpYW5EYXRlKHllYXIsIG1vbnRoLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kLCBtaWxsaXNlY29uZCwgaXNMZWFwU2Vjb25kKSB7CiAgICBjb25zdCBtaW5pbXVtWWVhciA9IDE7CiAgICBjb25zdCBtaW5pbXVtTW9udGggPSAxOwogICAgY29uc3QgbWluaW11bURheSA9IDE7CiAgICBjb25zdCBtaW5pbXVtSG91ciA9IDA7CiAgICBjb25zdCBtaW5pbXVtTWludXRlID0gMDsKICAgIGNvbnN0IG1pbmltdW1TZWNvbmQgPSAwOwogICAgY29uc3QgbWluaW11bU1pbGxpc2Vjb25kID0gMDsKICAgIHllYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5ZWFyLCBtaW5pbXVtWWVhcik7CiAgICBtb250aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1vbnRoLCBtaW5pbXVtTW9udGgpOwogICAgZGF5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZGF5LCBtaW5pbXVtRGF5KTsKICAgIGhvdXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChob3VyLCBtaW5pbXVtSG91cik7CiAgICBtaW51dGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtaW51dGUsIG1pbmltdW1NaW51dGUpOwogICAgc2Vjb25kID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc2Vjb25kLCBtaW5pbXVtU2Vjb25kKTsKICAgIG1pbGxpc2Vjb25kID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWlsbGlzZWNvbmQsIG1pbmltdW1NaWxsaXNlY29uZCk7CiAgICBpc0xlYXBTZWNvbmQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChpc0xlYXBTZWNvbmQsIGZhbHNlKTsKICAgIHZhbGlkYXRlUmFuZ2UoKTsKICAgIHZhbGlkYXRlRGF0ZSgpOwogICAgdGhpcy55ZWFyID0geWVhcjsKICAgIHRoaXMubW9udGggPSBtb250aDsKICAgIHRoaXMuZGF5ID0gZGF5OwogICAgdGhpcy5ob3VyID0gaG91cjsKICAgIHRoaXMubWludXRlID0gbWludXRlOwogICAgdGhpcy5zZWNvbmQgPSBzZWNvbmQ7CiAgICB0aGlzLm1pbGxpc2Vjb25kID0gbWlsbGlzZWNvbmQ7CiAgICB0aGlzLmlzTGVhcFNlY29uZCA9IGlzTGVhcFNlY29uZDsKICAgIGZ1bmN0aW9uIHZhbGlkYXRlUmFuZ2UoKSB7CiAgICAgIGNvbnN0IG1heGltdW1ZZWFyID0gOTk5OTsKICAgICAgY29uc3QgbWF4aW11bU1vbnRoID0gMTI7CiAgICAgIGNvbnN0IG1heGltdW1EYXkgPSAzMTsKICAgICAgY29uc3QgbWF4aW11bUhvdXIgPSAyMzsKICAgICAgY29uc3QgbWF4aW11bU1pbnV0ZSA9IDU5OwogICAgICBjb25zdCBtYXhpbXVtU2Vjb25kID0gNTk7CiAgICAgIGNvbnN0IGV4Y2x1ZGVkTWF4aW11bU1pbGlzZWNvbmQgPSAxZTM7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJZZWFyIiwgeWVhciwgbWluaW11bVllYXIpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiWWVhciIsIHllYXIsIG1heGltdW1ZZWFyKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIk1vbnRoIiwgbW9udGgsIG1pbmltdW1Nb250aCk7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJNb250aCIsIG1vbnRoLCBtYXhpbXVtTW9udGgpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiRGF5IiwgZGF5LCBtaW5pbXVtRGF5KTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoIkRheSIsIGRheSwgbWF4aW11bURheSk7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJIb3VyIiwgaG91ciwgbWluaW11bUhvdXIpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiSG91ciIsIGhvdXIsIG1heGltdW1Ib3VyKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIk1pbnV0ZSIsIG1pbnV0ZSwgbWluaW11bU1pbnV0ZSk7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJNaW51dGUiLCBtaW51dGUsIG1heGltdW1NaW51dGUpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5ib29sKCJJc0xlYXBTZWNvbmQiLCBpc0xlYXBTZWNvbmQpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiU2Vjb25kIiwgc2Vjb25kLCBtaW5pbXVtU2Vjb25kKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoCiAgICAgICAgIlNlY29uZCIsCiAgICAgICAgc2Vjb25kLAogICAgICAgIGlzTGVhcFNlY29uZCA/IG1heGltdW1TZWNvbmQgKyAxIDogbWF4aW11bVNlY29uZAogICAgICApOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgICAiTWlsbGlzZWNvbmQiLAogICAgICAgIG1pbGxpc2Vjb25kLAogICAgICAgIG1pbmltdW1NaWxsaXNlY29uZAogICAgICApOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW4oCiAgICAgICAgIk1pbGxpc2Vjb25kIiwKICAgICAgICBtaWxsaXNlY29uZCwKICAgICAgICBleGNsdWRlZE1heGltdW1NaWxpc2Vjb25kCiAgICAgICk7CiAgICB9CiAgICBmdW5jdGlvbiB2YWxpZGF0ZURhdGUoKSB7CiAgICAgIGNvbnN0IGRheXNJbk1vbnRoMiA9IG1vbnRoID09PSAyICYmIGlzTGVhcFllYXJfZGVmYXVsdCh5ZWFyKSA/IGRheXNJblllYXJbbW9udGggLSAxXSArIDEgOiBkYXlzSW5ZZWFyW21vbnRoIC0gMV07CiAgICAgIGlmIChkYXkgPiBkYXlzSW5Nb250aDIpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiTW9udGggYW5kIERheSByZXByZXNlbnRzIGludmFsaWQgZGF0ZSIpOwogICAgICB9CiAgICB9CiAgfQogIHZhciBkYXlzSW5ZZWFyLCBHcmVnb3JpYW5EYXRlX2RlZmF1bHQ7CiAgdmFyIGluaXRfR3JlZ29yaWFuRGF0ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR3JlZ29yaWFuRGF0ZS5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2lzTGVhcFllYXIoKTsKICAgICAgZGF5c0luWWVhciA9IFszMSwgMjgsIDMxLCAzMCwgMzEsIDMwLCAzMSwgMzEsIDMwLCAzMSwgMzAsIDMxXTsKICAgICAgR3JlZ29yaWFuRGF0ZV9kZWZhdWx0ID0gR3JlZ29yaWFuRGF0ZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0xlYXBTZWNvbmQuanMKICBmdW5jdGlvbiBMZWFwU2Vjb25kKGRhdGUsIG9mZnNldCkgewogICAgdGhpcy5qdWxpYW5EYXRlID0gZGF0ZTsKICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0OwogIH0KICB2YXIgTGVhcFNlY29uZF9kZWZhdWx0OwogIHZhciBpbml0X0xlYXBTZWNvbmQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0xlYXBTZWNvbmQuanMiKCkgewogICAgICBMZWFwU2Vjb25kX2RlZmF1bHQgPSBMZWFwU2Vjb25kOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGltZUNvbnN0YW50cy5qcwogIHZhciBUaW1lQ29uc3RhbnRzLCBUaW1lQ29uc3RhbnRzX2RlZmF1bHQ7CiAgdmFyIGluaXRfVGltZUNvbnN0YW50cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGltZUNvbnN0YW50cy5qcyIoKSB7CiAgICAgIFRpbWVDb25zdGFudHMgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBzZWNvbmRzIGluIG9uZSBtaWxsaXNlY29uZDogPGNvZGU+MC4wMDE8L2NvZGU+CiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBTRUNPTkRTX1BFUl9NSUxMSVNFQ09ORDogMWUtMywKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIHNlY29uZHMgaW4gb25lIG1pbnV0ZTogPGNvZGU+NjA8L2NvZGU+LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgU0VDT05EU19QRVJfTUlOVVRFOiA2MCwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIG1pbnV0ZXMgaW4gb25lIGhvdXI6IDxjb2RlPjYwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE1JTlVURVNfUEVSX0hPVVI6IDYwLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgaG91cnMgaW4gb25lIGRheTogPGNvZGU+MjQ8L2NvZGU+LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSE9VUlNfUEVSX0RBWTogMjQsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBzZWNvbmRzIGluIG9uZSBob3VyOiA8Y29kZT4zNjAwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNFQ09ORFNfUEVSX0hPVVI6IDM2MDAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBtaW51dGVzIGluIG9uZSBkYXk6IDxjb2RlPjE0NDA8L2NvZGU+LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTUlOVVRFU19QRVJfREFZOiAxNDQwLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyBpbiBvbmUgZGF5LCBpZ25vcmluZyBsZWFwIHNlY29uZHM6IDxjb2RlPjg2NDAwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNFQ09ORFNfUEVSX0RBWTogODY0MDAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBkYXlzIGluIG9uZSBKdWxpYW4gY2VudHVyeTogPGNvZGU+MzY1MjU8L2NvZGU+LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgREFZU19QRVJfSlVMSUFOX0NFTlRVUlk6IDM2NTI1LAogICAgICAgIC8qKgogICAgICAgICAqIE9uZSB0cmlsbGlvbnRoIG9mIGEgc2Vjb25kLgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUElDT1NFQ09ORDogMWUtOSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIGRheXMgdG8gc3VidHJhY3QgZnJvbSBhIEp1bGlhbiBkYXRlIHRvIGRldGVybWluZSB0aGUKICAgICAgICAgKiBtb2RpZmllZCBKdWxpYW4gZGF0ZSwgd2hpY2ggZ2l2ZXMgdGhlIG51bWJlciBvZiBkYXlzIHNpbmNlIG1pZG5pZ2h0CiAgICAgICAgICogb24gTm92ZW1iZXIgMTcsIDE4NTguCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNT0RJRklFRF9KVUxJQU5fREFURV9ESUZGRVJFTkNFOiAyNDAwMDAwNWUtMQogICAgICB9OwogICAgICBUaW1lQ29uc3RhbnRzX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFRpbWVDb25zdGFudHMpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGltZVN0YW5kYXJkLmpzCiAgdmFyIFRpbWVTdGFuZGFyZCwgVGltZVN0YW5kYXJkX2RlZmF1bHQ7CiAgdmFyIGluaXRfVGltZVN0YW5kYXJkID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UaW1lU3RhbmRhcmQuanMiKCkgewogICAgICBUaW1lU3RhbmRhcmQgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogUmVwcmVzZW50cyB0aGUgY29vcmRpbmF0ZWQgVW5pdmVyc2FsIFRpbWUgKFVUQykgdGltZSBzdGFuZGFyZC4KICAgICAgICAgKgogICAgICAgICAqIFVUQyBpcyByZWxhdGVkIHRvIFRBSSBhY2NvcmRpbmcgdG8gdGhlIHJlbGF0aW9uc2hpcAogICAgICAgICAqIDxjb2RlPlVUQyA9IFRBSSAtIGRlbHRhVDwvY29kZT4gd2hlcmUgPGNvZGU+ZGVsdGFUPC9jb2RlPiBpcyB0aGUgbnVtYmVyIG9mIGxlYXAKICAgICAgICAgKiBzZWNvbmRzIHdoaWNoIGhhdmUgYmVlbiBpbnRyb2R1Y2VkIGFzIG9mIHRoZSB0aW1lIGluIFRBSS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVVRDOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIFJlcHJlc2VudHMgdGhlIEludGVybmF0aW9uYWwgQXRvbWljIFRpbWUgKFRBSSkgdGltZSBzdGFuZGFyZC4KICAgICAgICAgKiBUQUkgaXMgdGhlIHByaW5jaXBhbCB0aW1lIHN0YW5kYXJkIHRvIHdoaWNoIHRoZSBvdGhlciB0aW1lIHN0YW5kYXJkcyBhcmUgcmVsYXRlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVEFJOiAxCiAgICAgIH07CiAgICAgIFRpbWVTdGFuZGFyZF9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShUaW1lU3RhbmRhcmQpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSnVsaWFuRGF0ZS5qcwogIGZ1bmN0aW9uIGNvbXBhcmVMZWFwU2Vjb25kRGF0ZXMobGVhcFNlY29uZCwgZGF0ZVRvRmluZCkgewogICAgcmV0dXJuIEp1bGlhbkRhdGUuY29tcGFyZShsZWFwU2Vjb25kLmp1bGlhbkRhdGUsIGRhdGVUb0ZpbmQuanVsaWFuRGF0ZSk7CiAgfQogIGZ1bmN0aW9uIGNvbnZlcnRVdGNUb1RhaShqdWxpYW5EYXRlKSB7CiAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZC5qdWxpYW5EYXRlID0ganVsaWFuRGF0ZTsKICAgIGNvbnN0IGxlYXBTZWNvbmRzID0gSnVsaWFuRGF0ZS5sZWFwU2Vjb25kczsKICAgIGxldCBpbmRleCA9IGJpbmFyeVNlYXJjaF9kZWZhdWx0KAogICAgICBsZWFwU2Vjb25kcywKICAgICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQsCiAgICAgIGNvbXBhcmVMZWFwU2Vjb25kRGF0ZXMKICAgICk7CiAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgIGluZGV4ID0gfmluZGV4OwogICAgfQogICAgaWYgKGluZGV4ID49IGxlYXBTZWNvbmRzLmxlbmd0aCkgewogICAgICBpbmRleCA9IGxlYXBTZWNvbmRzLmxlbmd0aCAtIDE7CiAgICB9CiAgICBsZXQgb2Zmc2V0ID0gbGVhcFNlY29uZHNbaW5kZXhdLm9mZnNldDsKICAgIGlmIChpbmRleCA+IDApIHsKICAgICAgY29uc3QgZGlmZmVyZW5jZSA9IEp1bGlhbkRhdGUuc2Vjb25kc0RpZmZlcmVuY2UoCiAgICAgICAgbGVhcFNlY29uZHNbaW5kZXhdLmp1bGlhbkRhdGUsCiAgICAgICAganVsaWFuRGF0ZQogICAgICApOwogICAgICBpZiAoZGlmZmVyZW5jZSA+IG9mZnNldCkgewogICAgICAgIGluZGV4LS07CiAgICAgICAgb2Zmc2V0ID0gbGVhcFNlY29uZHNbaW5kZXhdLm9mZnNldDsKICAgICAgfQogICAgfQogICAgSnVsaWFuRGF0ZS5hZGRTZWNvbmRzKGp1bGlhbkRhdGUsIG9mZnNldCwganVsaWFuRGF0ZSk7CiAgfQogIGZ1bmN0aW9uIGNvbnZlcnRUYWlUb1V0YyhqdWxpYW5EYXRlLCByZXN1bHQpIHsKICAgIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLmp1bGlhbkRhdGUgPSBqdWxpYW5EYXRlOwogICAgY29uc3QgbGVhcFNlY29uZHMgPSBKdWxpYW5EYXRlLmxlYXBTZWNvbmRzOwogICAgbGV0IGluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoCiAgICAgIGxlYXBTZWNvbmRzLAogICAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZCwKICAgICAgY29tcGFyZUxlYXBTZWNvbmREYXRlcwogICAgKTsKICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgaW5kZXggPSB+aW5kZXg7CiAgICB9CiAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyhqdWxpYW5EYXRlLCAtbGVhcFNlY29uZHNbMF0ub2Zmc2V0LCByZXN1bHQpOwogICAgfQogICAgaWYgKGluZGV4ID49IGxlYXBTZWNvbmRzLmxlbmd0aCkgewogICAgICByZXR1cm4gSnVsaWFuRGF0ZS5hZGRTZWNvbmRzKAogICAgICAgIGp1bGlhbkRhdGUsCiAgICAgICAgLWxlYXBTZWNvbmRzW2luZGV4IC0gMV0ub2Zmc2V0LAogICAgICAgIHJlc3VsdAogICAgICApOwogICAgfQogICAgY29uc3QgZGlmZmVyZW5jZSA9IEp1bGlhbkRhdGUuc2Vjb25kc0RpZmZlcmVuY2UoCiAgICAgIGxlYXBTZWNvbmRzW2luZGV4XS5qdWxpYW5EYXRlLAogICAgICBqdWxpYW5EYXRlCiAgICApOwogICAgaWYgKGRpZmZlcmVuY2UgPT09IDApIHsKICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuYWRkU2Vjb25kcygKICAgICAgICBqdWxpYW5EYXRlLAogICAgICAgIC1sZWFwU2Vjb25kc1tpbmRleF0ub2Zmc2V0LAogICAgICAgIHJlc3VsdAogICAgICApOwogICAgfQogICAgaWYgKGRpZmZlcmVuY2UgPD0gMSkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgcmV0dXJuIEp1bGlhbkRhdGUuYWRkU2Vjb25kcygKICAgICAganVsaWFuRGF0ZSwKICAgICAgLWxlYXBTZWNvbmRzWy0taW5kZXhdLm9mZnNldCwKICAgICAgcmVzdWx0CiAgICApOwogIH0KICBmdW5jdGlvbiBzZXRDb21wb25lbnRzKHdob2xlRGF5cywgc2Vjb25kc09mRGF5LCBqdWxpYW5EYXRlKSB7CiAgICBjb25zdCBleHRyYURheXMgPSBzZWNvbmRzT2ZEYXkgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZIHwgMDsKICAgIHdob2xlRGF5cyArPSBleHRyYURheXM7CiAgICBzZWNvbmRzT2ZEYXkgLT0gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWSAqIGV4dHJhRGF5czsKICAgIGlmIChzZWNvbmRzT2ZEYXkgPCAwKSB7CiAgICAgIHdob2xlRGF5cy0tOwogICAgICBzZWNvbmRzT2ZEYXkgKz0gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgIH0KICAgIGp1bGlhbkRhdGUuZGF5TnVtYmVyID0gd2hvbGVEYXlzOwogICAganVsaWFuRGF0ZS5zZWNvbmRzT2ZEYXkgPSBzZWNvbmRzT2ZEYXk7CiAgICByZXR1cm4ganVsaWFuRGF0ZTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUp1bGlhbkRhdGVDb21wb25lbnRzKHllYXIsIG1vbnRoLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kLCBtaWxsaXNlY29uZCkgewogICAgY29uc3QgYTMgPSAobW9udGggLSAxNCkgLyAxMiB8IDA7CiAgICBjb25zdCBiID0geWVhciArIDQ4MDAgKyBhMzsKICAgIGxldCBkYXlOdW1iZXIgPSAoMTQ2MSAqIGIgLyA0IHwgMCkgKyAoMzY3ICogKG1vbnRoIC0gMiAtIDEyICogYTMpIC8gMTIgfCAwKSAtICgzICogKChiICsgMTAwKSAvIDEwMCB8IDApIC8gNCB8IDApICsgZGF5IC0gMzIwNzU7CiAgICBob3VyID0gaG91ciAtIDEyOwogICAgaWYgKGhvdXIgPCAwKSB7CiAgICAgIGhvdXIgKz0gMjQ7CiAgICB9CiAgICBjb25zdCBzZWNvbmRzT2ZEYXkgPSBzZWNvbmQgKyAoaG91ciAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9IT1VSICsgbWludXRlICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX01JTlVURSArIG1pbGxpc2Vjb25kICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX01JTExJU0VDT05EKTsKICAgIGlmIChzZWNvbmRzT2ZEYXkgPj0gNDMyMDApIHsKICAgICAgZGF5TnVtYmVyIC09IDE7CiAgICB9CiAgICByZXR1cm4gW2RheU51bWJlciwgc2Vjb25kc09mRGF5XTsKICB9CiAgZnVuY3Rpb24gSnVsaWFuRGF0ZShqdWxpYW5EYXlOdW1iZXIsIHNlY29uZHNPZkRheSwgdGltZVN0YW5kYXJkKSB7CiAgICB0aGlzLmRheU51bWJlciA9IHZvaWQgMDsKICAgIHRoaXMuc2Vjb25kc09mRGF5ID0gdm9pZCAwOwogICAganVsaWFuRGF5TnVtYmVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoanVsaWFuRGF5TnVtYmVyLCAwKTsKICAgIHNlY29uZHNPZkRheSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNlY29uZHNPZkRheSwgMCk7CiAgICB0aW1lU3RhbmRhcmQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh0aW1lU3RhbmRhcmQsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlVUQyk7CiAgICBjb25zdCB3aG9sZURheXMgPSBqdWxpYW5EYXlOdW1iZXIgfCAwOwogICAgc2Vjb25kc09mRGF5ID0gc2Vjb25kc09mRGF5ICsgKGp1bGlhbkRheU51bWJlciAtIHdob2xlRGF5cykgKiBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZOwogICAgc2V0Q29tcG9uZW50cyh3aG9sZURheXMsIHNlY29uZHNPZkRheSwgdGhpcyk7CiAgICBpZiAodGltZVN0YW5kYXJkID09PSBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpIHsKICAgICAgY29udmVydFV0Y1RvVGFpKHRoaXMpOwogICAgfQogIH0KICB2YXIgZ3JlZ29yaWFuRGF0ZVNjcmF0Y2gsIGRheXNJbk1vbnRoLCBkYXlzSW5MZWFwRmVicnVhcnksIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLCBtYXRjaENhbGVuZGFyWWVhciwgbWF0Y2hDYWxlbmRhck1vbnRoLCBtYXRjaE9yZGluYWxEYXRlLCBtYXRjaFdlZWtEYXRlLCBtYXRjaENhbGVuZGFyRGF0ZSwgdXRjT2Zmc2V0LCBtYXRjaEhvdXJzLCBtYXRjaEhvdXJzTWludXRlcywgbWF0Y2hIb3Vyc01pbnV0ZXNTZWNvbmRzLCBpc284NjAxRXJyb3JNZXNzYWdlLCB0b0dyZWdvcmlhbkRhdGVTY3JhdGNoLCBKdWxpYW5EYXRlX2RlZmF1bHQ7CiAgdmFyIGluaXRfSnVsaWFuRGF0ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSnVsaWFuRGF0ZS5qcyIoKSB7CiAgICAgIGluaXRfYmluYXJ5U2VhcmNoKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfR3JlZ29yaWFuRGF0ZSgpOwogICAgICBpbml0X2lzTGVhcFllYXIoKTsKICAgICAgaW5pdF9MZWFwU2Vjb25kKCk7CiAgICAgIGluaXRfVGltZUNvbnN0YW50cygpOwogICAgICBpbml0X1RpbWVTdGFuZGFyZCgpOwogICAgICBncmVnb3JpYW5EYXRlU2NyYXRjaCA9IG5ldyBHcmVnb3JpYW5EYXRlX2RlZmF1bHQoKTsKICAgICAgZGF5c0luTW9udGggPSBbMzEsIDI4LCAzMSwgMzAsIDMxLCAzMCwgMzEsIDMxLCAzMCwgMzEsIDMwLCAzMV07CiAgICAgIGRheXNJbkxlYXBGZWJydWFyeSA9IDI5OwogICAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZCA9IG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQoKTsKICAgICAgbWF0Y2hDYWxlbmRhclllYXIgPSAvXihcZHs0fSkkLzsKICAgICAgbWF0Y2hDYWxlbmRhck1vbnRoID0gL14oXGR7NH0pLShcZHsyfSkkLzsKICAgICAgbWF0Y2hPcmRpbmFsRGF0ZSA9IC9eKFxkezR9KS0/KFxkezN9KSQvOwogICAgICBtYXRjaFdlZWtEYXRlID0gL14oXGR7NH0pLT9XKFxkezJ9KS0/KFxkezF9KT8kLzsKICAgICAgbWF0Y2hDYWxlbmRhckRhdGUgPSAvXihcZHs0fSktPyhcZHsyfSktPyhcZHsyfSkkLzsKICAgICAgdXRjT2Zmc2V0ID0gLyhbWitcLV0pPyhcZHsyfSk/Oj8oXGR7Mn0pPyQvOwogICAgICBtYXRjaEhvdXJzID0gL14oXGR7Mn0pKFwuXGQrKT8vLnNvdXJjZSArIHV0Y09mZnNldC5zb3VyY2U7CiAgICAgIG1hdGNoSG91cnNNaW51dGVzID0gL14oXGR7Mn0pOj8oXGR7Mn0pKFwuXGQrKT8vLnNvdXJjZSArIHV0Y09mZnNldC5zb3VyY2U7CiAgICAgIG1hdGNoSG91cnNNaW51dGVzU2Vjb25kcyA9IC9eKFxkezJ9KTo/KFxkezJ9KTo/KFxkezJ9KShcLlxkKyk/Ly5zb3VyY2UgKyB1dGNPZmZzZXQuc291cmNlOwogICAgICBpc284NjAxRXJyb3JNZXNzYWdlID0gIkludmFsaWQgSVNPIDg2MDEgZGF0ZS4iOwogICAgICBKdWxpYW5EYXRlLmZyb21HcmVnb3JpYW5EYXRlID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCEoZGF0ZSBpbnN0YW5jZW9mIEdyZWdvcmlhbkRhdGVfZGVmYXVsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIG11c3QgYmUgYSB2YWxpZCBHcmVnb3JpYW5EYXRlLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21wb25lbnRzID0gY29tcHV0ZUp1bGlhbkRhdGVDb21wb25lbnRzKAogICAgICAgICAgZGF0ZS55ZWFyLAogICAgICAgICAgZGF0ZS5tb250aCwKICAgICAgICAgIGRhdGUuZGF5LAogICAgICAgICAgZGF0ZS5ob3VyLAogICAgICAgICAgZGF0ZS5taW51dGUsCiAgICAgICAgICBkYXRlLnNlY29uZCwKICAgICAgICAgIGRhdGUubWlsbGlzZWNvbmQKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgSnVsaWFuRGF0ZShjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpOwogICAgICAgIH0KICAgICAgICBzZXRDb21wb25lbnRzKGNvbXBvbmVudHNbMF0sIGNvbXBvbmVudHNbMV0sIHJlc3VsdCk7CiAgICAgICAgY29udmVydFV0Y1RvVGFpKHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5mcm9tRGF0ZSA9IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB8fCBpc05hTihkYXRlLmdldFRpbWUoKSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIG11c3QgYmUgYSB2YWxpZCBKYXZhU2NyaXB0IERhdGUuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbXBvbmVudHMgPSBjb21wdXRlSnVsaWFuRGF0ZUNvbXBvbmVudHMoCiAgICAgICAgICBkYXRlLmdldFVUQ0Z1bGxZZWFyKCksCiAgICAgICAgICBkYXRlLmdldFVUQ01vbnRoKCkgKyAxLAogICAgICAgICAgZGF0ZS5nZXRVVENEYXRlKCksCiAgICAgICAgICBkYXRlLmdldFVUQ0hvdXJzKCksCiAgICAgICAgICBkYXRlLmdldFVUQ01pbnV0ZXMoKSwKICAgICAgICAgIGRhdGUuZ2V0VVRDU2Vjb25kcygpLAogICAgICAgICAgZGF0ZS5nZXRVVENNaWxsaXNlY29uZHMoKQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBKdWxpYW5EYXRlKGNvbXBvbmVudHNbMF0sIGNvbXBvbmVudHNbMV0sIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlVUQyk7CiAgICAgICAgfQogICAgICAgIHNldENvbXBvbmVudHMoY29tcG9uZW50c1swXSwgY29tcG9uZW50c1sxXSwgcmVzdWx0KTsKICAgICAgICBjb252ZXJ0VXRjVG9UYWkocmVzdWx0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmZyb21Jc284NjAxID0gZnVuY3Rpb24oaXNvODYwMVN0cmluZywgcmVzdWx0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBpc284NjAxU3RyaW5nICE9PSAic3RyaW5nIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIGlzbzg2MDFTdHJpbmcgPSBpc284NjAxU3RyaW5nLnJlcGxhY2UoIiwiLCAiLiIpOwogICAgICAgIGxldCB0b2tlbnMgPSBpc284NjAxU3RyaW5nLnNwbGl0KCJUIik7CiAgICAgICAgbGV0IHllYXI7CiAgICAgICAgbGV0IG1vbnRoID0gMTsKICAgICAgICBsZXQgZGF5ID0gMTsKICAgICAgICBsZXQgaG91ciA9IDA7CiAgICAgICAgbGV0IG1pbnV0ZSA9IDA7CiAgICAgICAgbGV0IHNlY29uZCA9IDA7CiAgICAgICAgbGV0IG1pbGxpc2Vjb25kID0gMDsKICAgICAgICBjb25zdCBkYXRlID0gdG9rZW5zWzBdOwogICAgICAgIGNvbnN0IHRpbWUgPSB0b2tlbnNbMV07CiAgICAgICAgbGV0IHRtcDI7CiAgICAgICAgbGV0IGluTGVhcFllYXI7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgICBsZXQgZGFzaENvdW50OwogICAgICAgIHRva2VucyA9IGRhdGUubWF0Y2gobWF0Y2hDYWxlbmRhckRhdGUpOwogICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgIGRhc2hDb3VudCA9IGRhdGUuc3BsaXQoIi0iKS5sZW5ndGggLSAxOwogICAgICAgICAgaWYgKGRhc2hDb3VudCA+IDAgJiYgZGFzaENvdW50ICE9PSAyKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgfQogICAgICAgICAgeWVhciA9ICt0b2tlbnNbMV07CiAgICAgICAgICBtb250aCA9ICt0b2tlbnNbMl07CiAgICAgICAgICBkYXkgPSArdG9rZW5zWzNdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0b2tlbnMgPSBkYXRlLm1hdGNoKG1hdGNoQ2FsZW5kYXJNb250aCk7CiAgICAgICAgICBpZiAodG9rZW5zICE9PSBudWxsKSB7CiAgICAgICAgICAgIHllYXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICBtb250aCA9ICt0b2tlbnNbMl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0b2tlbnMgPSBkYXRlLm1hdGNoKG1hdGNoQ2FsZW5kYXJZZWFyKTsKICAgICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHllYXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxldCBkYXlPZlllYXI7CiAgICAgICAgICAgICAgdG9rZW5zID0gZGF0ZS5tYXRjaChtYXRjaE9yZGluYWxEYXRlKTsKICAgICAgICAgICAgICBpZiAodG9rZW5zICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB5ZWFyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgICAgIGRheU9mWWVhciA9ICt0b2tlbnNbMl07CiAgICAgICAgICAgICAgICBpbkxlYXBZZWFyID0gaXNMZWFwWWVhcl9kZWZhdWx0KHllYXIpOwogICAgICAgICAgICAgICAgaWYgKGRheU9mWWVhciA8IDEgfHwgaW5MZWFwWWVhciAmJiBkYXlPZlllYXIgPiAzNjYgfHwgIWluTGVhcFllYXIgJiYgZGF5T2ZZZWFyID4gMzY1KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0b2tlbnMgPSBkYXRlLm1hdGNoKG1hdGNoV2Vla0RhdGUpOwogICAgICAgICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB5ZWFyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgICAgICAgY29uc3Qgd2Vla051bWJlciA9ICt0b2tlbnNbMl07CiAgICAgICAgICAgICAgICAgIGNvbnN0IGRheU9mV2VlayA9ICt0b2tlbnNbM10gfHwgMDsKICAgICAgICAgICAgICAgICAgZGFzaENvdW50ID0gZGF0ZS5zcGxpdCgiLSIpLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICAgIGlmIChkYXNoQ291bnQgPiAwICYmICghZGVmaW5lZF9kZWZhdWx0KHRva2Vuc1szXSkgJiYgZGFzaENvdW50ICE9PSAxIHx8IGRlZmluZWRfZGVmYXVsdCh0b2tlbnNbM10pICYmIGRhc2hDb3VudCAhPT0gMikpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb25zdCBqYW51YXJ5NCA9IG5ldyBEYXRlKERhdGUuVVRDKHllYXIsIDAsIDQpKTsKICAgICAgICAgICAgICAgICAgZGF5T2ZZZWFyID0gd2Vla051bWJlciAqIDcgKyBkYXlPZldlZWsgLSBqYW51YXJ5NC5nZXRVVENEYXkoKSAtIDM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdG1wMiA9IG5ldyBEYXRlKERhdGUuVVRDKHllYXIsIDAsIDEpKTsKICAgICAgICAgICAgICB0bXAyLnNldFVUQ0RhdGUoZGF5T2ZZZWFyKTsKICAgICAgICAgICAgICBtb250aCA9IHRtcDIuZ2V0VVRDTW9udGgoKSArIDE7CiAgICAgICAgICAgICAgZGF5ID0gdG1wMi5nZXRVVENEYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5MZWFwWWVhciA9IGlzTGVhcFllYXJfZGVmYXVsdCh5ZWFyKTsKICAgICAgICBpZiAobW9udGggPCAxIHx8IG1vbnRoID4gMTIgfHwgZGF5IDwgMSB8fCAobW9udGggIT09IDIgfHwgIWluTGVhcFllYXIpICYmIGRheSA+IGRheXNJbk1vbnRoW21vbnRoIC0gMV0gfHwgaW5MZWFwWWVhciAmJiBtb250aCA9PT0gMiAmJiBkYXkgPiBkYXlzSW5MZWFwRmVicnVhcnkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgICBsZXQgb2Zmc2V0SW5kZXg7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aW1lKSkgewogICAgICAgICAgdG9rZW5zID0gdGltZS5tYXRjaChtYXRjaEhvdXJzTWludXRlc1NlY29uZHMpOwogICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICBkYXNoQ291bnQgPSB0aW1lLnNwbGl0KCI6IikubGVuZ3RoIC0gMTsKICAgICAgICAgICAgaWYgKGRhc2hDb3VudCA+IDAgJiYgZGFzaENvdW50ICE9PSAyICYmIGRhc2hDb3VudCAhPT0gMykgewogICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvdXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICBtaW51dGUgPSArdG9rZW5zWzJdOwogICAgICAgICAgICBzZWNvbmQgPSArdG9rZW5zWzNdOwogICAgICAgICAgICBtaWxsaXNlY29uZCA9ICsodG9rZW5zWzRdIHx8IDApICogMWUzOwogICAgICAgICAgICBvZmZzZXRJbmRleCA9IDU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0b2tlbnMgPSB0aW1lLm1hdGNoKG1hdGNoSG91cnNNaW51dGVzKTsKICAgICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGRhc2hDb3VudCA9IHRpbWUuc3BsaXQoIjoiKS5sZW5ndGggLSAxOwogICAgICAgICAgICAgIGlmIChkYXNoQ291bnQgPiAyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaG91ciA9ICt0b2tlbnNbMV07CiAgICAgICAgICAgICAgbWludXRlID0gK3Rva2Vuc1syXTsKICAgICAgICAgICAgICBzZWNvbmQgPSArKHRva2Vuc1szXSB8fCAwKSAqIDYwOwogICAgICAgICAgICAgIG9mZnNldEluZGV4ID0gNDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0b2tlbnMgPSB0aW1lLm1hdGNoKG1hdGNoSG91cnMpOwogICAgICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGhvdXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICAgICAgbWludXRlID0gKyh0b2tlbnNbMl0gfHwgMCkgKiA2MDsKICAgICAgICAgICAgICAgIG9mZnNldEluZGV4ID0gMzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWludXRlID49IDYwIHx8IHNlY29uZCA+PSA2MSB8fCBob3VyID4gMjQgfHwgaG91ciA9PT0gMjQgJiYgKG1pbnV0ZSA+IDAgfHwgc2Vjb25kID4gMCB8fCBtaWxsaXNlY29uZCA+IDApKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdG9rZW5zW29mZnNldEluZGV4XTsKICAgICAgICAgIGNvbnN0IG9mZnNldEhvdXJzID0gK3Rva2Vuc1tvZmZzZXRJbmRleCArIDFdOwogICAgICAgICAgY29uc3Qgb2Zmc2V0TWludXRlcyA9ICsodG9rZW5zW29mZnNldEluZGV4ICsgMl0gfHwgMCk7CiAgICAgICAgICBzd2l0Y2ggKG9mZnNldCkgewogICAgICAgICAgICBjYXNlICIrIjoKICAgICAgICAgICAgICBob3VyID0gaG91ciAtIG9mZnNldEhvdXJzOwogICAgICAgICAgICAgIG1pbnV0ZSA9IG1pbnV0ZSAtIG9mZnNldE1pbnV0ZXM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIi0iOgogICAgICAgICAgICAgIGhvdXIgPSBob3VyICsgb2Zmc2V0SG91cnM7CiAgICAgICAgICAgICAgbWludXRlID0gbWludXRlICsgb2Zmc2V0TWludXRlczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiWiI6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgbWludXRlID0gbWludXRlICsgbmV3IERhdGUoCiAgICAgICAgICAgICAgICBEYXRlLlVUQyh5ZWFyLCBtb250aCAtIDEsIGRheSwgaG91ciwgbWludXRlKQogICAgICAgICAgICAgICkuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgaXNMZWFwU2Vjb25kID0gc2Vjb25kID09PSA2MDsKICAgICAgICBpZiAoaXNMZWFwU2Vjb25kKSB7CiAgICAgICAgICBzZWNvbmQtLTsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKG1pbnV0ZSA+PSA2MCkgewogICAgICAgICAgbWludXRlIC09IDYwOwogICAgICAgICAgaG91cisrOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoaG91ciA+PSAyNCkgewogICAgICAgICAgaG91ciAtPSAyNDsKICAgICAgICAgIGRheSsrOwogICAgICAgIH0KICAgICAgICB0bXAyID0gaW5MZWFwWWVhciAmJiBtb250aCA9PT0gMiA/IGRheXNJbkxlYXBGZWJydWFyeSA6IGRheXNJbk1vbnRoW21vbnRoIC0gMV07CiAgICAgICAgd2hpbGUgKGRheSA+IHRtcDIpIHsKICAgICAgICAgIGRheSAtPSB0bXAyOwogICAgICAgICAgbW9udGgrKzsKICAgICAgICAgIGlmIChtb250aCA+IDEyKSB7CiAgICAgICAgICAgIG1vbnRoIC09IDEyOwogICAgICAgICAgICB5ZWFyKys7CiAgICAgICAgICB9CiAgICAgICAgICB0bXAyID0gaW5MZWFwWWVhciAmJiBtb250aCA9PT0gMiA/IGRheXNJbkxlYXBGZWJydWFyeSA6IGRheXNJbk1vbnRoW21vbnRoIC0gMV07CiAgICAgICAgfQogICAgICAgIHdoaWxlIChtaW51dGUgPCAwKSB7CiAgICAgICAgICBtaW51dGUgKz0gNjA7CiAgICAgICAgICBob3VyLS07CiAgICAgICAgfQogICAgICAgIHdoaWxlIChob3VyIDwgMCkgewogICAgICAgICAgaG91ciArPSAyNDsKICAgICAgICAgIGRheS0tOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoZGF5IDwgMSkgewogICAgICAgICAgbW9udGgtLTsKICAgICAgICAgIGlmIChtb250aCA8IDEpIHsKICAgICAgICAgICAgbW9udGggKz0gMTI7CiAgICAgICAgICAgIHllYXItLTsKICAgICAgICAgIH0KICAgICAgICAgIHRtcDIgPSBpbkxlYXBZZWFyICYmIG1vbnRoID09PSAyID8gZGF5c0luTGVhcEZlYnJ1YXJ5IDogZGF5c0luTW9udGhbbW9udGggLSAxXTsKICAgICAgICAgIGRheSArPSB0bXAyOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21wb25lbnRzID0gY29tcHV0ZUp1bGlhbkRhdGVDb21wb25lbnRzKAogICAgICAgICAgeWVhciwKICAgICAgICAgIG1vbnRoLAogICAgICAgICAgZGF5LAogICAgICAgICAgaG91ciwKICAgICAgICAgIG1pbnV0ZSwKICAgICAgICAgIHNlY29uZCwKICAgICAgICAgIG1pbGxpc2Vjb25kCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSnVsaWFuRGF0ZShjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXRDb21wb25lbnRzKGNvbXBvbmVudHNbMF0sIGNvbXBvbmVudHNbMV0sIHJlc3VsdCk7CiAgICAgICAgICBjb252ZXJ0VXRjVG9UYWkocmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTGVhcFNlY29uZCkgewogICAgICAgICAgSnVsaWFuRGF0ZS5hZGRTZWNvbmRzKHJlc3VsdCwgMSwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5ub3cgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5mcm9tRGF0ZSgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgdG9HcmVnb3JpYW5EYXRlU2NyYXRjaCA9IG5ldyBKdWxpYW5EYXRlKDAsIDAsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSk7CiAgICAgIEp1bGlhbkRhdGUudG9HcmVnb3JpYW5EYXRlID0gZnVuY3Rpb24oanVsaWFuRGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgaXNMZWFwU2Vjb25kID0gZmFsc2U7CiAgICAgICAgbGV0IHRoaXNVdGMgPSBjb252ZXJ0VGFpVG9VdGMoanVsaWFuRGF0ZSwgdG9HcmVnb3JpYW5EYXRlU2NyYXRjaCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpc1V0YykpIHsKICAgICAgICAgIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyhqdWxpYW5EYXRlLCAtMSwgdG9HcmVnb3JpYW5EYXRlU2NyYXRjaCk7CiAgICAgICAgICB0aGlzVXRjID0gY29udmVydFRhaVRvVXRjKHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2gsIHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2gpOwogICAgICAgICAgaXNMZWFwU2Vjb25kID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgbGV0IGp1bGlhbkRheU51bWJlciA9IHRoaXNVdGMuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IHNlY29uZHNPZkRheSA9IHRoaXNVdGMuc2Vjb25kc09mRGF5OwogICAgICAgIGlmIChzZWNvbmRzT2ZEYXkgPj0gNDMyMDApIHsKICAgICAgICAgIGp1bGlhbkRheU51bWJlciArPSAxOwogICAgICAgIH0KICAgICAgICBsZXQgTCA9IGp1bGlhbkRheU51bWJlciArIDY4NTY5IHwgMDsKICAgICAgICBjb25zdCBOID0gNCAqIEwgLyAxNDYwOTcgfCAwOwogICAgICAgIEwgPSBMIC0gKCgxNDYwOTcgKiBOICsgMykgLyA0IHwgMCkgfCAwOwogICAgICAgIGNvbnN0IEkgPSA0ZTMgKiAoTCArIDEpIC8gMTQ2MTAwMSB8IDA7CiAgICAgICAgTCA9IEwgLSAoMTQ2MSAqIEkgLyA0IHwgMCkgKyAzMSB8IDA7CiAgICAgICAgY29uc3QgSiA9IDgwICogTCAvIDI0NDcgfCAwOwogICAgICAgIGNvbnN0IGRheSA9IEwgLSAoMjQ0NyAqIEogLyA4MCB8IDApIHwgMDsKICAgICAgICBMID0gSiAvIDExIHwgMDsKICAgICAgICBjb25zdCBtb250aCA9IEogKyAyIC0gMTIgKiBMIHwgMDsKICAgICAgICBjb25zdCB5ZWFyID0gMTAwICogKE4gLSA0OSkgKyBJICsgTCB8IDA7CiAgICAgICAgbGV0IGhvdXIgPSBzZWNvbmRzT2ZEYXkgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfSE9VUiB8IDA7CiAgICAgICAgbGV0IHJlbWFpbmluZ1NlY29uZHMgPSBzZWNvbmRzT2ZEYXkgLSBob3VyICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0hPVVI7CiAgICAgICAgY29uc3QgbWludXRlID0gcmVtYWluaW5nU2Vjb25kcyAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSU5VVEUgfCAwOwogICAgICAgIHJlbWFpbmluZ1NlY29uZHMgPSByZW1haW5pbmdTZWNvbmRzIC0gbWludXRlICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX01JTlVURTsKICAgICAgICBsZXQgc2Vjb25kID0gcmVtYWluaW5nU2Vjb25kcyB8IDA7CiAgICAgICAgY29uc3QgbWlsbGlzZWNvbmQgPSAocmVtYWluaW5nU2Vjb25kcyAtIHNlY29uZCkgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfTUlMTElTRUNPTkQ7CiAgICAgICAgaG91ciArPSAxMjsKICAgICAgICBpZiAoaG91ciA+IDIzKSB7CiAgICAgICAgICBob3VyIC09IDI0OwogICAgICAgIH0KICAgICAgICBpZiAoaXNMZWFwU2Vjb25kKSB7CiAgICAgICAgICBzZWNvbmQgKz0gMTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBHcmVnb3JpYW5EYXRlX2RlZmF1bHQoCiAgICAgICAgICAgIHllYXIsCiAgICAgICAgICAgIG1vbnRoLAogICAgICAgICAgICBkYXksCiAgICAgICAgICAgIGhvdXIsCiAgICAgICAgICAgIG1pbnV0ZSwKICAgICAgICAgICAgc2Vjb25kLAogICAgICAgICAgICBtaWxsaXNlY29uZCwKICAgICAgICAgICAgaXNMZWFwU2Vjb25kCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQueWVhciA9IHllYXI7CiAgICAgICAgcmVzdWx0Lm1vbnRoID0gbW9udGg7CiAgICAgICAgcmVzdWx0LmRheSA9IGRheTsKICAgICAgICByZXN1bHQuaG91ciA9IGhvdXI7CiAgICAgICAgcmVzdWx0Lm1pbnV0ZSA9IG1pbnV0ZTsKICAgICAgICByZXN1bHQuc2Vjb25kID0gc2Vjb25kOwogICAgICAgIHJlc3VsdC5taWxsaXNlY29uZCA9IG1pbGxpc2Vjb25kOwogICAgICAgIHJlc3VsdC5pc0xlYXBTZWNvbmQgPSBpc0xlYXBTZWNvbmQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS50b0RhdGUgPSBmdW5jdGlvbihqdWxpYW5EYXRlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBnRGF0ZSA9IEp1bGlhbkRhdGUudG9HcmVnb3JpYW5EYXRlKGp1bGlhbkRhdGUsIGdyZWdvcmlhbkRhdGVTY3JhdGNoKTsKICAgICAgICBsZXQgc2Vjb25kID0gZ0RhdGUuc2Vjb25kOwogICAgICAgIGlmIChnRGF0ZS5pc0xlYXBTZWNvbmQpIHsKICAgICAgICAgIHNlY29uZCAtPSAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IERhdGUoCiAgICAgICAgICBEYXRlLlVUQygKICAgICAgICAgICAgZ0RhdGUueWVhciwKICAgICAgICAgICAgZ0RhdGUubW9udGggLSAxLAogICAgICAgICAgICBnRGF0ZS5kYXksCiAgICAgICAgICAgIGdEYXRlLmhvdXIsCiAgICAgICAgICAgIGdEYXRlLm1pbnV0ZSwKICAgICAgICAgICAgc2Vjb25kLAogICAgICAgICAgICBnRGF0ZS5taWxsaXNlY29uZAogICAgICAgICAgKQogICAgICAgICk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUudG9Jc284NjAxID0gZnVuY3Rpb24oanVsaWFuRGF0ZSwgcHJlY2lzaW9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBnRGF0ZSA9IEp1bGlhbkRhdGUudG9HcmVnb3JpYW5EYXRlKGp1bGlhbkRhdGUsIGdyZWdvcmlhbkRhdGVTY3JhdGNoKTsKICAgICAgICBsZXQgeWVhciA9IGdEYXRlLnllYXI7CiAgICAgICAgbGV0IG1vbnRoID0gZ0RhdGUubW9udGg7CiAgICAgICAgbGV0IGRheSA9IGdEYXRlLmRheTsKICAgICAgICBsZXQgaG91ciA9IGdEYXRlLmhvdXI7CiAgICAgICAgY29uc3QgbWludXRlID0gZ0RhdGUubWludXRlOwogICAgICAgIGNvbnN0IHNlY29uZCA9IGdEYXRlLnNlY29uZDsKICAgICAgICBjb25zdCBtaWxsaXNlY29uZCA9IGdEYXRlLm1pbGxpc2Vjb25kOwogICAgICAgIGlmICh5ZWFyID09PSAxZTQgJiYgbW9udGggPT09IDEgJiYgZGF5ID09PSAxICYmIGhvdXIgPT09IDAgJiYgbWludXRlID09PSAwICYmIHNlY29uZCA9PT0gMCAmJiBtaWxsaXNlY29uZCA9PT0gMCkgewogICAgICAgICAgeWVhciA9IDk5OTk7CiAgICAgICAgICBtb250aCA9IDEyOwogICAgICAgICAgZGF5ID0gMzE7CiAgICAgICAgICBob3VyID0gMjQ7CiAgICAgICAgfQogICAgICAgIGxldCBtaWxsaXNlY29uZFN0cjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcmVjaXNpb24pICYmIG1pbGxpc2Vjb25kICE9PSAwKSB7CiAgICAgICAgICBjb25zdCBtaWxsaXNlY29uZEh1bmRyZWRzID0gbWlsbGlzZWNvbmQgKiAwLjAxOwogICAgICAgICAgbWlsbGlzZWNvbmRTdHIgPSBtaWxsaXNlY29uZEh1bmRyZWRzIDwgMWUtNiA/IG1pbGxpc2Vjb25kSHVuZHJlZHMudG9GaXhlZCgyMCkucmVwbGFjZSgiLiIsICIiKS5yZXBsYWNlKC8wKyQvLCAiIikgOiBtaWxsaXNlY29uZEh1bmRyZWRzLnRvU3RyaW5nKCkucmVwbGFjZSgiLiIsICIiKTsKICAgICAgICAgIHJldHVybiBgJHt5ZWFyLnRvU3RyaW5nKCkucGFkU3RhcnQoNCwgIjAiKX0tJHttb250aC50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9LSR7ZGF5LnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX1UJHtob3VyLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06JHttaW51dGUudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke3NlY29uZC50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9LiR7bWlsbGlzZWNvbmRTdHJ9WmA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHByZWNpc2lvbikgfHwgcHJlY2lzaW9uID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gYCR7eWVhci50b1N0cmluZygpLnBhZFN0YXJ0KDQsICIwIil9LSR7bW9udGgudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfS0ke2RheS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9VCR7aG91ci50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9OiR7bWludXRlLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06JHtzZWNvbmQudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfVpgOwogICAgICAgIH0KICAgICAgICBtaWxsaXNlY29uZFN0ciA9IChtaWxsaXNlY29uZCAqIDAuMDEpLnRvRml4ZWQocHJlY2lzaW9uKS5yZXBsYWNlKCIuIiwgIiIpLnNsaWNlKDAsIHByZWNpc2lvbik7CiAgICAgICAgcmV0dXJuIGAke3llYXIudG9TdHJpbmcoKS5wYWRTdGFydCg0LCAiMCIpfS0ke21vbnRoLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX0tJHtkYXkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfVQke2hvdXIudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke21pbnV0ZS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9OiR7c2Vjb25kLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX0uJHttaWxsaXNlY29uZFN0cn1aYDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5jbG9uZSA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEp1bGlhbkRhdGUoCiAgICAgICAgICAgIGp1bGlhbkRhdGUuZGF5TnVtYmVyLAogICAgICAgICAgICBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSwKICAgICAgICAgICAgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQuZGF5TnVtYmVyID0ganVsaWFuRGF0ZS5kYXlOdW1iZXI7CiAgICAgICAgcmVzdWx0LnNlY29uZHNPZkRheSA9IGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuY29tcGFyZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJsZWZ0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QganVsaWFuRGF5TnVtYmVyRGlmZmVyZW5jZSA9IGxlZnQuZGF5TnVtYmVyIC0gcmlnaHQuZGF5TnVtYmVyOwogICAgICAgIGlmIChqdWxpYW5EYXlOdW1iZXJEaWZmZXJlbmNlICE9PSAwKSB7CiAgICAgICAgICByZXR1cm4ganVsaWFuRGF5TnVtYmVyRGlmZmVyZW5jZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlZnQuc2Vjb25kc09mRGF5IC0gcmlnaHQuc2Vjb25kc09mRGF5OwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnQuZGF5TnVtYmVyID09PSByaWdodC5kYXlOdW1iZXIgJiYgbGVmdC5zZWNvbmRzT2ZEYXkgPT09IHJpZ2h0LnNlY29uZHNPZkRheTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIGVwc2lsb24pIHsKICAgICAgICBlcHNpbG9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZXBzaWxvbiwgMCk7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIE1hdGguYWJzKEp1bGlhbkRhdGUuc2Vjb25kc0RpZmZlcmVuY2UobGVmdCwgcmlnaHQpKSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLnRvdGFsRGF5cyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChqdWxpYW5EYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImp1bGlhbkRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBqdWxpYW5EYXRlLmRheU51bWJlciArIGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5IC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5zZWNvbmRzRGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJsZWZ0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF5RGlmZmVyZW5jZSA9IChsZWZ0LmRheU51bWJlciAtIHJpZ2h0LmRheU51bWJlcikgKiBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZOwogICAgICAgIHJldHVybiBkYXlEaWZmZXJlbmNlICsgKGxlZnQuc2Vjb25kc09mRGF5IC0gcmlnaHQuc2Vjb25kc09mRGF5KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5kYXlzRGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJsZWZ0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF5RGlmZmVyZW5jZSA9IGxlZnQuZGF5TnVtYmVyIC0gcmlnaHQuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IHNlY29uZERpZmZlcmVuY2UgPSAobGVmdC5zZWNvbmRzT2ZEYXkgLSByaWdodC5zZWNvbmRzT2ZEYXkpIC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgICAgICByZXR1cm4gZGF5RGlmZmVyZW5jZSArIHNlY29uZERpZmZlcmVuY2U7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuY29tcHV0ZVRhaU1pbnVzVXRjID0gZnVuY3Rpb24oanVsaWFuRGF0ZSkgewogICAgICAgIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLmp1bGlhbkRhdGUgPSBqdWxpYW5EYXRlOwogICAgICAgIGNvbnN0IGxlYXBTZWNvbmRzID0gSnVsaWFuRGF0ZS5sZWFwU2Vjb25kczsKICAgICAgICBsZXQgaW5kZXggPSBiaW5hcnlTZWFyY2hfZGVmYXVsdCgKICAgICAgICAgIGxlYXBTZWNvbmRzLAogICAgICAgICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQsCiAgICAgICAgICBjb21wYXJlTGVhcFNlY29uZERhdGVzCiAgICAgICAgKTsKICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICBpbmRleCA9IH5pbmRleDsKICAgICAgICAgIC0taW5kZXg7CiAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIGluZGV4ID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlYXBTZWNvbmRzW2luZGV4XS5vZmZzZXQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIHNlY29uZHMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2Vjb25kcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZWNvbmRzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2V0Q29tcG9uZW50cygKICAgICAgICAgIGp1bGlhbkRhdGUuZGF5TnVtYmVyLAogICAgICAgICAganVsaWFuRGF0ZS5zZWNvbmRzT2ZEYXkgKyBzZWNvbmRzLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5hZGRNaW51dGVzID0gZnVuY3Rpb24oanVsaWFuRGF0ZSwgbWludXRlcywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtaW51dGVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1pbnV0ZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZXN1bHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld1NlY29uZHNPZkRheSA9IGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5ICsgbWludXRlcyAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSU5VVEU7CiAgICAgICAgcmV0dXJuIHNldENvbXBvbmVudHMoanVsaWFuRGF0ZS5kYXlOdW1iZXIsIG5ld1NlY29uZHNPZkRheSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5hZGRIb3VycyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIGhvdXJzLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChqdWxpYW5EYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImp1bGlhbkRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhvdXJzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImhvdXJzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdTZWNvbmRzT2ZEYXkgPSBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSArIGhvdXJzICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0hPVVI7CiAgICAgICAgcmV0dXJuIHNldENvbXBvbmVudHMoanVsaWFuRGF0ZS5kYXlOdW1iZXIsIG5ld1NlY29uZHNPZkRheSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5hZGREYXlzID0gZnVuY3Rpb24oanVsaWFuRGF0ZSwgZGF5cywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkYXlzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRheXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZXN1bHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld0p1bGlhbkRheU51bWJlciA9IGp1bGlhbkRhdGUuZGF5TnVtYmVyICsgZGF5czsKICAgICAgICByZXR1cm4gc2V0Q29tcG9uZW50cyhuZXdKdWxpYW5EYXlOdW1iZXIsIGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5LCByZXN1bHQpOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmxlc3NUaGFuID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5jb21wYXJlKGxlZnQsIHJpZ2h0KSA8IDA7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuY29tcGFyZShsZWZ0LCByaWdodCkgPD0gMDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5ncmVhdGVyVGhhbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuY29tcGFyZShsZWZ0LCByaWdodCkgPiAwOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmdyZWF0ZXJUaGFuT3JFcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBKdWxpYW5EYXRlLmNvbXBhcmUobGVmdCwgcmlnaHQpID49IDA7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5lcXVhbHNFcHNpbG9uKHRoaXMsIHJpZ2h0LCBlcHNpbG9uKTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS50b0lzbzg2MDEodGhpcyk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUubGVhcFNlY29uZHMgPSBbCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQxMzE3LCA0MzIxMCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTApLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3MiAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDE0OTksIDQzMjExLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxMSksCiAgICAgICAgLy8gSnVseSAxLCAxOTcyIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0MTY4MywgNDMyMTIsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDEyKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzMgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQyMDQ4LCA0MzIxMywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTMpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3NCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDI0MTMsIDQzMjE0LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxNCksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTc1IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0Mjc3OCwgNDMyMTUsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDE1KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzYgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQzMTQ0LCA0MzIxNiwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTYpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3NyAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDM1MDksIDQzMjE3LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxNyksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTc4IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0Mzg3NCwgNDMyMTgsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDE4KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzkgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ0MjM5LCA0MzIxOSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTkpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk4MCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDQ3ODYsIDQzMjIwLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyMCksCiAgICAgICAgLy8gSnVseSAxLCAxOTgxIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0NTE1MSwgNDMyMjEsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDIxKSwKICAgICAgICAvLyBKdWx5IDEsIDE5ODIgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ1NTE2LCA0MzIyMiwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjIpLAogICAgICAgIC8vIEp1bHkgMSwgMTk4MyAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDYyNDcsIDQzMjIzLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyMyksCiAgICAgICAgLy8gSnVseSAxLCAxOTg1IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0NzE2MSwgNDMyMjQsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDI0KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5ODggMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ3ODkyLCA0MzIyNSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjUpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk5MCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDgyNTcsIDQzMjI2LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyNiksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTkxIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0ODgwNCwgNDMyMjcsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDI3KSwKICAgICAgICAvLyBKdWx5IDEsIDE5OTIgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ5MTY5LCA0MzIyOCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjgpLAogICAgICAgIC8vIEp1bHkgMSwgMTk5MyAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDk1MzQsIDQzMjI5LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyOSksCiAgICAgICAgLy8gSnVseSAxLCAxOTk0IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1MDA4MywgNDMyMzAsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDMwKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5OTYgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDUwNjMwLCA0MzIzMSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzEpLAogICAgICAgIC8vIEp1bHkgMSwgMTk5NyAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTExNzksIDQzMjMyLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzMiksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTk5IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1MzczNiwgNDMyMzMsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDMzKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDIwMDYgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDU0ODMyLCA0MzIzNCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzQpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMjAwOSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTYxMDksIDQzMjM1LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzNSksCiAgICAgICAgLy8gSnVseSAxLCAyMDEyIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1NzIwNCwgNDMyMzYsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDM2KSwKICAgICAgICAvLyBKdWx5IDEsIDIwMTUgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDU3NzU0LCA0MzIzNywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzcpCiAgICAgICAgLy8gSmFudWFyeSAxLCAyMDE3IDAwOjAwOjAwIFVUQwogICAgICBdOwogICAgICBKdWxpYW5EYXRlX2RlZmF1bHQgPSBKdWxpYW5EYXRlOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvdXJpanMvc3JjL3B1bnljb2RlLmpzCiAgdmFyIHJlcXVpcmVfcHVueWNvZGUgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvdXJpanMvc3JjL3B1bnljb2RlLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIC8qISBodHRwczovL210aHMuYmUvcHVueWNvZGUgdjEuNC4wIGJ5IEBtYXRoaWFzICovCiAgICAgIChmdW5jdGlvbihyb290KSB7CiAgICAgICAgdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMyID09ICJvYmplY3QiICYmIGV4cG9ydHMyICYmICFleHBvcnRzMi5ub2RlVHlwZSAmJiBleHBvcnRzMjsKICAgICAgICB2YXIgZnJlZU1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT0gIm9iamVjdCIgJiYgbW9kdWxlICYmICFtb2R1bGUubm9kZVR5cGUgJiYgbW9kdWxlOwogICAgICAgIHZhciBmcmVlR2xvYmFsID0gdHlwZW9mIGdsb2JhbCA9PSAib2JqZWN0IiAmJiBnbG9iYWw7CiAgICAgICAgaWYgKGZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsIHx8IGZyZWVHbG9iYWwud2luZG93ID09PSBmcmVlR2xvYmFsIHx8IGZyZWVHbG9iYWwuc2VsZiA9PT0gZnJlZUdsb2JhbCkgewogICAgICAgICAgcm9vdCA9IGZyZWVHbG9iYWw7CiAgICAgICAgfQogICAgICAgIHZhciBwdW55Y29kZSwgbWF4SW50ID0gMjE0NzQ4MzY0NywgYmFzZSA9IDM2LCB0TWluID0gMSwgdE1heCA9IDI2LCBza2V3ID0gMzgsIGRhbXAgPSA3MDAsIGluaXRpYWxCaWFzID0gNzIsIGluaXRpYWxOID0gMTI4LCBkZWxpbWl0ZXIgPSAiLSIsIHJlZ2V4UHVueWNvZGUgPSAvXnhuLS0vLCByZWdleE5vbkFTQ0lJID0gL1teXHgyMC1ceDdFXS8sIHJlZ2V4U2VwYXJhdG9ycyA9IC9bXHgyRVx1MzAwMlx1RkYwRVx1RkY2MV0vZywgZXJyb3JzID0gewogICAgICAgICAgIm92ZXJmbG93IjogIk92ZXJmbG93OiBpbnB1dCBuZWVkcyB3aWRlciBpbnRlZ2VycyB0byBwcm9jZXNzIiwKICAgICAgICAgICJub3QtYmFzaWMiOiAiSWxsZWdhbCBpbnB1dCA+PSAweDgwIChub3QgYSBiYXNpYyBjb2RlIHBvaW50KSIsCiAgICAgICAgICAiaW52YWxpZC1pbnB1dCI6ICJJbnZhbGlkIGlucHV0IgogICAgICAgIH0sIGJhc2VNaW51c1RNaW4gPSBiYXNlIC0gdE1pbiwgZmxvb3IgPSBNYXRoLmZsb29yLCBzdHJpbmdGcm9tQ2hhckNvZGUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLCBrZXk7CiAgICAgICAgZnVuY3Rpb24gZXJyb3IodHlwZSkgewogICAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoZXJyb3JzW3R5cGVdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwKGFycmF5LCBmbikgewogICAgICAgICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGZuKGFycmF5W2xlbmd0aF0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwRG9tYWluKHN0cmluZywgZm4pIHsKICAgICAgICAgIHZhciBwYXJ0cyA9IHN0cmluZy5zcGxpdCgiQCIpOwogICAgICAgICAgdmFyIHJlc3VsdCA9ICIiOwogICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgcmVzdWx0ID0gcGFydHNbMF0gKyAiQCI7CiAgICAgICAgICAgIHN0cmluZyA9IHBhcnRzWzFdOwogICAgICAgICAgfQogICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVnZXhTZXBhcmF0b3JzLCAiLiIpOwogICAgICAgICAgdmFyIGxhYmVscyA9IHN0cmluZy5zcGxpdCgiLiIpOwogICAgICAgICAgdmFyIGVuY29kZWQgPSBtYXAobGFiZWxzLCBmbikuam9pbigiLiIpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdCArIGVuY29kZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVjczJkZWNvZGUoc3RyaW5nKSB7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gW10sIGNvdW50ZXIgPSAwLCBsZW5ndGggPSBzdHJpbmcubGVuZ3RoLCB2YWx1ZSwgZXh0cmE7CiAgICAgICAgICB3aGlsZSAoY291bnRlciA8IGxlbmd0aCkgewogICAgICAgICAgICB2YWx1ZSA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSA+PSA1NTI5NiAmJiB2YWx1ZSA8PSA1NjMxOSAmJiBjb3VudGVyIDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgZXh0cmEgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgICAgICAgIGlmICgoZXh0cmEgJiA2NDUxMikgPT0gNTYzMjApIHsKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKCgodmFsdWUgJiAxMDIzKSA8PCAxMCkgKyAoZXh0cmEgJiAxMDIzKSArIDY1NTM2KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgY291bnRlci0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVjczJlbmNvZGUoYXJyYXkpIHsKICAgICAgICAgIHJldHVybiBtYXAoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSAiIjsKICAgICAgICAgICAgaWYgKHZhbHVlID4gNjU1MzUpIHsKICAgICAgICAgICAgICB2YWx1ZSAtPSA2NTUzNjsKICAgICAgICAgICAgICBvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlID4+PiAxMCAmIDEwMjMgfCA1NTI5Nik7CiAgICAgICAgICAgICAgdmFsdWUgPSA1NjMyMCB8IHZhbHVlICYgMTAyMzsKICAgICAgICAgICAgfQogICAgICAgICAgICBvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICAgIH0pLmpvaW4oIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYXNpY1RvRGlnaXQoY29kZVBvaW50KSB7CiAgICAgICAgICBpZiAoY29kZVBvaW50IC0gNDggPCAxMCkgewogICAgICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gMjI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29kZVBvaW50IC0gNjUgPCAyNikgewogICAgICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gNjU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29kZVBvaW50IC0gOTcgPCAyNikgewogICAgICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gOTc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlnaXRUb0Jhc2ljKGRpZ2l0LCBmbGFnKSB7CiAgICAgICAgICByZXR1cm4gZGlnaXQgKyAyMiArIDc1ICogKGRpZ2l0IDwgMjYpIC0gKChmbGFnICE9IDApIDw8IDUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGFwdChkZWx0YSwgbnVtUG9pbnRzLCBmaXJzdFRpbWUpIHsKICAgICAgICAgIHZhciBrID0gMDsKICAgICAgICAgIGRlbHRhID0gZmlyc3RUaW1lID8gZmxvb3IoZGVsdGEgLyBkYW1wKSA6IGRlbHRhID4+IDE7CiAgICAgICAgICBkZWx0YSArPSBmbG9vcihkZWx0YSAvIG51bVBvaW50cyk7CiAgICAgICAgICBmb3IgKDsgZGVsdGEgPiBiYXNlTWludXNUTWluICogdE1heCA+PiAxOyBrICs9IGJhc2UpIHsKICAgICAgICAgICAgZGVsdGEgPSBmbG9vcihkZWx0YSAvIGJhc2VNaW51c1RNaW4pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZsb29yKGsgKyAoYmFzZU1pbnVzVE1pbiArIDEpICogZGVsdGEgLyAoZGVsdGEgKyBza2V3KSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlY29kZTMoaW5wdXQpIHsKICAgICAgICAgIHZhciBvdXRwdXQgPSBbXSwgaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsIG91dCwgaSA9IDAsIG4gPSBpbml0aWFsTiwgYmlhcyA9IGluaXRpYWxCaWFzLCBiYXNpYywgaiwgaW5kZXgsIG9sZGksIHcsIGssIGRpZ2l0LCB0LCBiYXNlTWludXNUOwogICAgICAgICAgYmFzaWMgPSBpbnB1dC5sYXN0SW5kZXhPZihkZWxpbWl0ZXIpOwogICAgICAgICAgaWYgKGJhc2ljIDwgMCkgewogICAgICAgICAgICBiYXNpYyA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgYmFzaWM7ICsraikgewogICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChqKSA+PSAxMjgpIHsKICAgICAgICAgICAgICBlcnJvcigibm90LWJhc2ljIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3V0cHV0LnB1c2goaW5wdXQuY2hhckNvZGVBdChqKSk7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGluZGV4ID0gYmFzaWMgPiAwID8gYmFzaWMgKyAxIDogMDsgaW5kZXggPCBpbnB1dExlbmd0aDsgKSB7CiAgICAgICAgICAgIGZvciAob2xkaSA9IGksIHcgPSAxLCBrID0gYmFzZTsgOyBrICs9IGJhc2UpIHsKICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gaW5wdXRMZW5ndGgpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJpbnZhbGlkLWlucHV0Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpZ2l0ID0gYmFzaWNUb0RpZ2l0KGlucHV0LmNoYXJDb2RlQXQoaW5kZXgrKykpOwogICAgICAgICAgICAgIGlmIChkaWdpdCA+PSBiYXNlIHx8IGRpZ2l0ID4gZmxvb3IoKG1heEludCAtIGkpIC8gdykpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJvdmVyZmxvdyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpICs9IGRpZ2l0ICogdzsKICAgICAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXM7CiAgICAgICAgICAgICAgaWYgKGRpZ2l0IDwgdCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJhc2VNaW51c1QgPSBiYXNlIC0gdDsKICAgICAgICAgICAgICBpZiAodyA+IGZsb29yKG1heEludCAvIGJhc2VNaW51c1QpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigib3ZlcmZsb3ciKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdyAqPSBiYXNlTWludXNUOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG91dCA9IG91dHB1dC5sZW5ndGggKyAxOwogICAgICAgICAgICBiaWFzID0gYWRhcHQoaSAtIG9sZGksIG91dCwgb2xkaSA9PSAwKTsKICAgICAgICAgICAgaWYgKGZsb29yKGkgLyBvdXQpID4gbWF4SW50IC0gbikgewogICAgICAgICAgICAgIGVycm9yKCJvdmVyZmxvdyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG4gKz0gZmxvb3IoaSAvIG91dCk7CiAgICAgICAgICAgIGkgJT0gb3V0OwogICAgICAgICAgICBvdXRwdXQuc3BsaWNlKGkrKywgMCwgbik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdWNzMmVuY29kZShvdXRwdXQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbmNvZGUoaW5wdXQpIHsKICAgICAgICAgIHZhciBuLCBkZWx0YSwgaGFuZGxlZENQQ291bnQsIGJhc2ljTGVuZ3RoLCBiaWFzLCBqLCBtLCBxLCBrLCB0LCBjdXJyZW50VmFsdWUsIG91dHB1dCA9IFtdLCBpbnB1dExlbmd0aCwgaGFuZGxlZENQQ291bnRQbHVzT25lLCBiYXNlTWludXNULCBxTWludXNUOwogICAgICAgICAgaW5wdXQgPSB1Y3MyZGVjb2RlKGlucHV0KTsKICAgICAgICAgIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoOwogICAgICAgICAgbiA9IGluaXRpYWxOOwogICAgICAgICAgZGVsdGEgPSAwOwogICAgICAgICAgYmlhcyA9IGluaXRpYWxCaWFzOwogICAgICAgICAgZm9yIChqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPCAxMjgpIHsKICAgICAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoY3VycmVudFZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGhhbmRsZWRDUENvdW50ID0gYmFzaWNMZW5ndGggPSBvdXRwdXQubGVuZ3RoOwogICAgICAgICAgaWYgKGJhc2ljTGVuZ3RoKSB7CiAgICAgICAgICAgIG91dHB1dC5wdXNoKGRlbGltaXRlcik7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoaGFuZGxlZENQQ291bnQgPCBpbnB1dExlbmd0aCkgewogICAgICAgICAgICBmb3IgKG0gPSBtYXhJbnQsIGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPj0gbiAmJiBjdXJyZW50VmFsdWUgPCBtKSB7CiAgICAgICAgICAgICAgICBtID0gY3VycmVudFZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBoYW5kbGVkQ1BDb3VudFBsdXNPbmUgPSBoYW5kbGVkQ1BDb3VudCArIDE7CiAgICAgICAgICAgIGlmIChtIC0gbiA+IGZsb29yKChtYXhJbnQgLSBkZWx0YSkgLyBoYW5kbGVkQ1BDb3VudFBsdXNPbmUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIm92ZXJmbG93Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsdGEgKz0gKG0gLSBuKSAqIGhhbmRsZWRDUENvdW50UGx1c09uZTsKICAgICAgICAgICAgbiA9IG07CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA8IG4gJiYgKytkZWx0YSA+IG1heEludCkgewogICAgICAgICAgICAgICAgZXJyb3IoIm92ZXJmbG93Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPT0gbikgewogICAgICAgICAgICAgICAgZm9yIChxID0gZGVsdGEsIGsgPSBiYXNlOyA7IGsgKz0gYmFzZSkgewogICAgICAgICAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXM7CiAgICAgICAgICAgICAgICAgIGlmIChxIDwgdCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHFNaW51c1QgPSBxIC0gdDsKICAgICAgICAgICAgICAgICAgYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwogICAgICAgICAgICAgICAgICBvdXRwdXQucHVzaCgKICAgICAgICAgICAgICAgICAgICBzdHJpbmdGcm9tQ2hhckNvZGUoZGlnaXRUb0Jhc2ljKHQgKyBxTWludXNUICUgYmFzZU1pbnVzVCwgMCkpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIHEgPSBmbG9vcihxTWludXNUIC8gYmFzZU1pbnVzVCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoZGlnaXRUb0Jhc2ljKHEsIDApKSk7CiAgICAgICAgICAgICAgICBiaWFzID0gYWRhcHQoZGVsdGEsIGhhbmRsZWRDUENvdW50UGx1c09uZSwgaGFuZGxlZENQQ291bnQgPT0gYmFzaWNMZW5ndGgpOwogICAgICAgICAgICAgICAgZGVsdGEgPSAwOwogICAgICAgICAgICAgICAgKytoYW5kbGVkQ1BDb3VudDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytkZWx0YTsKICAgICAgICAgICAgKytuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9Vbmljb2RlKGlucHV0KSB7CiAgICAgICAgICByZXR1cm4gbWFwRG9tYWluKGlucHV0LCBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHJlZ2V4UHVueWNvZGUudGVzdChzdHJpbmcpID8gZGVjb2RlMyhzdHJpbmcuc2xpY2UoNCkudG9Mb3dlckNhc2UoKSkgOiBzdHJpbmc7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9BU0NJSShpbnB1dCkgewogICAgICAgICAgcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiByZWdleE5vbkFTQ0lJLnRlc3Qoc3RyaW5nKSA/ICJ4bi0tIiArIGVuY29kZShzdHJpbmcpIDogc3RyaW5nOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHB1bnljb2RlID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGN1cnJlbnQgUHVueWNvZGUuanMgdmVyc2lvbiBudW1iZXIuCiAgICAgICAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgICAgICovCiAgICAgICAgICAidmVyc2lvbiI6ICIxLjMuMiIsCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEFuIG9iamVjdCBvZiBtZXRob2RzIHRvIGNvbnZlcnQgZnJvbSBKYXZhU2NyaXB0J3MgaW50ZXJuYWwgY2hhcmFjdGVyCiAgICAgICAgICAgKiByZXByZXNlbnRhdGlvbiAoVUNTLTIpIHRvIFVuaWNvZGUgY29kZSBwb2ludHMsIGFuZCBiYWNrLgogICAgICAgICAgICogQHNlZSA8aHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2phdmFzY3JpcHQtZW5jb2Rpbmc+CiAgICAgICAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAgICAgICAqIEB0eXBlIE9iamVjdAogICAgICAgICAgICovCiAgICAgICAgICAidWNzMiI6IHsKICAgICAgICAgICAgImRlY29kZSI6IHVjczJkZWNvZGUsCiAgICAgICAgICAgICJlbmNvZGUiOiB1Y3MyZW5jb2RlCiAgICAgICAgICB9LAogICAgICAgICAgImRlY29kZSI6IGRlY29kZTMsCiAgICAgICAgICAiZW5jb2RlIjogZW5jb2RlLAogICAgICAgICAgInRvQVNDSUkiOiB0b0FTQ0lJLAogICAgICAgICAgInRvVW5pY29kZSI6IHRvVW5pY29kZQogICAgICAgIH07CiAgICAgICAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PSAib2JqZWN0IiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgICBkZWZpbmUoInB1bnljb2RlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBwdW55Y29kZTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAoZnJlZUV4cG9ydHMgJiYgZnJlZU1vZHVsZSkgewogICAgICAgICAgaWYgKG1vZHVsZS5leHBvcnRzID09IGZyZWVFeHBvcnRzKSB7CiAgICAgICAgICAgIGZyZWVNb2R1bGUuZXhwb3J0cyA9IHB1bnljb2RlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChrZXkgaW4gcHVueWNvZGUpIHsKICAgICAgICAgICAgICBwdW55Y29kZS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIChmcmVlRXhwb3J0c1trZXldID0gcHVueWNvZGVba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm9vdC5wdW55Y29kZSA9IHB1bnljb2RlOwogICAgICAgIH0KICAgICAgfSkoZXhwb3J0czIpOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvdXJpanMvc3JjL0lQdjYuanMKICB2YXIgcmVxdWlyZV9JUHY2ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9JUHY2LmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIC8qIQogICAgICAgKiBVUkkuanMgLSBNdXRhdGluZyBVUkxzCiAgICAgICAqIElQdjYgU3VwcG9ydAogICAgICAgKgogICAgICAgKiBWZXJzaW9uOiAxLjE5LjExCiAgICAgICAqCiAgICAgICAqIEF1dGhvcjogUm9kbmV5IFJlaG0KICAgICAgICogV2ViOiBodHRwOi8vbWVkaWFsaXplLmdpdGh1Yi5pby9VUkkuanMvCiAgICAgICAqCiAgICAgICAqIExpY2Vuc2VkIHVuZGVyCiAgICAgICAqICAgTUlUIExpY2Vuc2UgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZQogICAgICAgKgogICAgICAgKi8KICAgICAgKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgICAgZGVmaW5lKGZhY3RvcnkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByb290LklQdjYgPSBmYWN0b3J5KHJvb3QpOwogICAgICAgIH0KICAgICAgfSkoZXhwb3J0czIsIGZ1bmN0aW9uKHJvb3QpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIF9JUHY2ID0gcm9vdCAmJiByb290LklQdjY7CiAgICAgICAgZnVuY3Rpb24gYmVzdFByZXNlbnRhdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICB2YXIgX2FkZHJlc3MgPSBhZGRyZXNzLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICB2YXIgc2VnbWVudHMgPSBfYWRkcmVzcy5zcGxpdCgiOiIpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IHNlZ21lbnRzLmxlbmd0aDsKICAgICAgICAgIHZhciB0b3RhbCA9IDg7CiAgICAgICAgICBpZiAoc2VnbWVudHNbMF0gPT09ICIiICYmIHNlZ21lbnRzWzFdID09PSAiIiAmJiBzZWdtZW50c1syXSA9PT0gIiIpIHsKICAgICAgICAgICAgc2VnbWVudHMuc2hpZnQoKTsKICAgICAgICAgICAgc2VnbWVudHMuc2hpZnQoKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VnbWVudHNbMF0gPT09ICIiICYmIHNlZ21lbnRzWzFdID09PSAiIikgewogICAgICAgICAgICBzZWdtZW50cy5zaGlmdCgpOwogICAgICAgICAgfSBlbHNlIGlmIChzZWdtZW50c1tsZW5ndGggLSAxXSA9PT0gIiIgJiYgc2VnbWVudHNbbGVuZ3RoIC0gMl0gPT09ICIiKSB7CiAgICAgICAgICAgIHNlZ21lbnRzLnBvcCgpOwogICAgICAgICAgfQogICAgICAgICAgbGVuZ3RoID0gc2VnbWVudHMubGVuZ3RoOwogICAgICAgICAgaWYgKHNlZ21lbnRzW2xlbmd0aCAtIDFdLmluZGV4T2YoIi4iKSAhPT0gLTEpIHsKICAgICAgICAgICAgdG90YWwgPSA3OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBvczsKICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuZ3RoOyBwb3MrKykgewogICAgICAgICAgICBpZiAoc2VnbWVudHNbcG9zXSA9PT0gIiIpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBvcyA8IHRvdGFsKSB7CiAgICAgICAgICAgIHNlZ21lbnRzLnNwbGljZShwb3MsIDEsICIwMDAwIik7CiAgICAgICAgICAgIHdoaWxlIChzZWdtZW50cy5sZW5ndGggPCB0b3RhbCkgewogICAgICAgICAgICAgIHNlZ21lbnRzLnNwbGljZShwb3MsIDAsICIwMDAwIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBfc2VnbWVudHM7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICAgICAgX3NlZ21lbnRzID0gc2VnbWVudHNbaV0uc3BsaXQoIiIpOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IDM7IGorKykgewogICAgICAgICAgICAgIGlmIChfc2VnbWVudHNbMF0gPT09ICIwIiAmJiBfc2VnbWVudHMubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgX3NlZ21lbnRzLnNwbGljZSgwLCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlZ21lbnRzW2ldID0gX3NlZ21lbnRzLmpvaW4oIiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGJlc3QgPSAtMTsKICAgICAgICAgIHZhciBfYmVzdCA9IDA7CiAgICAgICAgICB2YXIgX2N1cnJlbnQgPSAwOwogICAgICAgICAgdmFyIGN1cnJlbnQgPSAtMTsKICAgICAgICAgIHZhciBpbnplcm9lcyA9IGZhbHNlOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICAgICAgaWYgKGluemVyb2VzKSB7CiAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzW2ldID09PSAiMCIpIHsKICAgICAgICAgICAgICAgIF9jdXJyZW50ICs9IDE7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluemVyb2VzID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoX2N1cnJlbnQgPiBfYmVzdCkgewogICAgICAgICAgICAgICAgICBiZXN0ID0gY3VycmVudDsKICAgICAgICAgICAgICAgICAgX2Jlc3QgPSBfY3VycmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzW2ldID09PSAiMCIpIHsKICAgICAgICAgICAgICAgIGluemVyb2VzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBpOwogICAgICAgICAgICAgICAgX2N1cnJlbnQgPSAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKF9jdXJyZW50ID4gX2Jlc3QpIHsKICAgICAgICAgICAgYmVzdCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIF9iZXN0ID0gX2N1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoX2Jlc3QgPiAxKSB7CiAgICAgICAgICAgIHNlZ21lbnRzLnNwbGljZShiZXN0LCBfYmVzdCwgIiIpOwogICAgICAgICAgfQogICAgICAgICAgbGVuZ3RoID0gc2VnbWVudHMubGVuZ3RoOwogICAgICAgICAgdmFyIHJlc3VsdCA9ICIiOwogICAgICAgICAgaWYgKHNlZ21lbnRzWzBdID09PSAiIikgewogICAgICAgICAgICByZXN1bHQgPSAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVzdWx0ICs9IHNlZ21lbnRzW2ldOwogICAgICAgICAgICBpZiAoaSA9PT0gbGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdCArPSAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2VnbWVudHNbbGVuZ3RoIC0gMV0gPT09ICIiKSB7CiAgICAgICAgICAgIHJlc3VsdCArPSAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBub0NvbmZsaWN0KCkgewogICAgICAgICAgaWYgKHJvb3QuSVB2NiA9PT0gdGhpcykgewogICAgICAgICAgICByb290LklQdjYgPSBfSVB2NjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgYmVzdDogYmVzdFByZXNlbnRhdGlvbiwKICAgICAgICAgIG5vQ29uZmxpY3QKICAgICAgICB9OwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9TZWNvbmRMZXZlbERvbWFpbnMuanMKICB2YXIgcmVxdWlyZV9TZWNvbmRMZXZlbERvbWFpbnMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvdXJpanMvc3JjL1NlY29uZExldmVsRG9tYWlucy5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiEKICAgICAgICogVVJJLmpzIC0gTXV0YXRpbmcgVVJMcwogICAgICAgKiBTZWNvbmQgTGV2ZWwgRG9tYWluIChTTEQpIFN1cHBvcnQKICAgICAgICoKICAgICAgICogVmVyc2lvbjogMS4xOS4xMQogICAgICAgKgogICAgICAgKiBBdXRob3I6IFJvZG5leSBSZWhtCiAgICAgICAqIFdlYjogaHR0cDovL21lZGlhbGl6ZS5naXRodWIuaW8vVVJJLmpzLwogICAgICAgKgogICAgICAgKiBMaWNlbnNlZCB1bmRlcgogICAgICAgKiAgIE1JVCBMaWNlbnNlIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UKICAgICAgICoKICAgICAgICovCiAgICAgIChmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgICAgICAgIGRlZmluZShmYWN0b3J5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm9vdC5TZWNvbmRMZXZlbERvbWFpbnMgPSBmYWN0b3J5KHJvb3QpOwogICAgICAgIH0KICAgICAgfSkoZXhwb3J0czIsIGZ1bmN0aW9uKHJvb3QpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIF9TZWNvbmRMZXZlbERvbWFpbnMgPSByb290ICYmIHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zOwogICAgICAgIHZhciBTTEQgPSB7CiAgICAgICAgICAvLyBsaXN0IG9mIGtub3duIFNlY29uZCBMZXZlbCBEb21haW5zCiAgICAgICAgICAvLyBjb252ZXJ0ZWQgbGlzdCBvZiBTTERzIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL2dhdmluZ21pbGxlci9zZWNvbmQtbGV2ZWwtZG9tYWlucwogICAgICAgICAgLy8gLS0tLQogICAgICAgICAgLy8gcHVibGljc3VmZml4Lm9yZyBpcyBtb3JlIGN1cnJlbnQgYW5kIGFjdHVhbGx5IHVzZWQgYnkgYSBjb3VwbGUgb2YgYnJvd3NlcnMgaW50ZXJuYWxseS4KICAgICAgICAgIC8vIGRvd25zaWRlIGlzIGl0IGFsc28gY29udGFpbnMgZG9tYWlucyBsaWtlICJkeW5kbnMub3JnIiAtIHdoaWNoIGlzIGZpbmUgZm9yIHRoZSBzZWN1cml0eQogICAgICAgICAgLy8gaXNzdWVzIGJyb3dzZXIgaGF2ZSB0byBkZWFsIHdpdGggKFNPUCBmb3IgY29va2llcywgZXRjKSAtIGJ1dCBpcyB3YXkgb3ZlcmJvYXJkIGZvciBVUkkuanMKICAgICAgICAgIC8vIC0tLS0KICAgICAgICAgIGxpc3Q6IHsKICAgICAgICAgICAgImFjIjogIiBjb20gZ292IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJhZSI6ICIgYWMgY28gZ292IG1pbCBuYW1lIG5ldCBvcmcgcHJvIHNjaCAiLAogICAgICAgICAgICAiYWYiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImFsIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiYW8iOiAiIGNvIGVkIGd2IGl0IG9nIHBiICIsCiAgICAgICAgICAgICJhciI6ICIgY29tIGVkdSBnb2IgZ292IGludCBtaWwgbmV0IG9yZyB0dXIgIiwKICAgICAgICAgICAgImF0IjogIiBhYyBjbyBndiBvciAiLAogICAgICAgICAgICAiYXUiOiAiIGFzbiBjb20gY3Npcm8gZWR1IGdvdiBpZCBuZXQgb3JnICIsCiAgICAgICAgICAgICJiYSI6ICIgY28gY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgcnMgdW5iaSB1bm1vIHVuc2EgdW50eiB1bnplICIsCiAgICAgICAgICAgICJiYiI6ICIgYml6IGNvIGNvbSBlZHUgZ292IGluZm8gbmV0IG9yZyBzdG9yZSB0diAiLAogICAgICAgICAgICAiYmgiOiAiIGJpeiBjYyBjb20gZWR1IGdvdiBpbmZvIG5ldCBvcmcgIiwKICAgICAgICAgICAgImJuIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJibyI6ICIgY29tIGVkdSBnb2IgZ292IGludCBtaWwgbmV0IG9yZyB0diAiLAogICAgICAgICAgICAiYnIiOiAiIGFkbSBhZHYgYWdyIGFtIGFycSBhcnQgYXRvIGIgYmlvIGJsb2cgYm1kIGNpbSBjbmcgY250IGNvbSBjb29wIGVjbiBlZHUgZW5nIGVzcCBldGMgZXRpIGZhciBmbG9nIGZtIGZuZCBmb3QgZnN0IGcxMiBnZ2YgZ292IGltYiBpbmQgaW5mIGpvciBqdXMgbGVsIG1hdCBtZWQgbWlsIG11cyBuZXQgbm9tIG5vdCBudHIgb2RvIG9yZyBwcGcgcHJvIHBzYyBwc2kgcXNsIHJlYyBzbGcgc3J2IHRtcCB0cmQgdHVyIHR2IHZldCB2bG9nIHdpa2kgemxnICIsCiAgICAgICAgICAgICJicyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAiYnoiOiAiIGR1IGV0IG9tIG92IHJnICIsCiAgICAgICAgICAgICJjYSI6ICIgYWIgYmMgbWIgbmIgbmYgbmwgbnMgbnQgbnUgb24gcGUgcWMgc2sgeWsgIiwKICAgICAgICAgICAgImNrIjogIiBiaXogY28gZWR1IGdlbiBnb3YgaW5mbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJjbiI6ICIgYWMgYWggYmogY29tIGNxIGVkdSBmaiBnZCBnb3YgZ3MgZ3ggZ3ogaGEgaGIgaGUgaGkgaGwgaG4gamwganMganggbG4gbWlsIG5ldCBubSBueCBvcmcgcWggc2Mgc2Qgc2ggc24gc3ggdGogdHcgeGogeHogeW4gemogIiwKICAgICAgICAgICAgImNvIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG5vbSBvcmcgIiwKICAgICAgICAgICAgImNyIjogIiBhYyBjIGNvIGVkIGZpIGdvIG9yIHNhICIsCiAgICAgICAgICAgICJjeSI6ICIgYWMgYml6IGNvbSBla2xvZ2VzIGdvdiBsdGQgbmFtZSBuZXQgb3JnIHBhcmxpYW1lbnQgcHJlc3MgcHJvIHRtICIsCiAgICAgICAgICAgICJkbyI6ICIgYXJ0IGNvbSBlZHUgZ29iIGdvdiBtaWwgbmV0IG9yZyBzbGQgd2ViICIsCiAgICAgICAgICAgICJkeiI6ICIgYXJ0IGFzc28gY29tIGVkdSBnb3YgbmV0IG9yZyBwb2wgIiwKICAgICAgICAgICAgImVjIjogIiBjb20gZWR1IGZpbiBnb3YgaW5mbyBtZWQgbWlsIG5ldCBvcmcgcHJvICIsCiAgICAgICAgICAgICJlZyI6ICIgY29tIGVkdSBldW4gZ292IG1pbCBuYW1lIG5ldCBvcmcgc2NpICIsCiAgICAgICAgICAgICJlciI6ICIgY29tIGVkdSBnb3YgaW5kIG1pbCBuZXQgb3JnIHJvY2hlc3QgdyAiLAogICAgICAgICAgICAiZXMiOiAiIGNvbSBlZHUgZ29iIG5vbSBvcmcgIiwKICAgICAgICAgICAgImV0IjogIiBiaXogY29tIGVkdSBnb3YgaW5mbyBuYW1lIG5ldCBvcmcgIiwKICAgICAgICAgICAgImZqIjogIiBhYyBiaXogY29tIGluZm8gbWlsIG5hbWUgbmV0IG9yZyBwcm8gIiwKICAgICAgICAgICAgImZrIjogIiBhYyBjbyBnb3YgbmV0IG5vbSBvcmcgIiwKICAgICAgICAgICAgImZyIjogIiBhc3NvIGNvbSBmIGdvdXYgbm9tIHByZCBwcmVzc2UgdG0gIiwKICAgICAgICAgICAgImdnIjogIiBjbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJnaCI6ICIgY29tIGVkdSBnb3YgbWlsIG9yZyAiLAogICAgICAgICAgICAiZ24iOiAiIGFjIGNvbSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAiZ3IiOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJndCI6ICIgY29tIGVkdSBnb2IgaW5kIG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJndSI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAiaGsiOiAiIGNvbSBlZHUgZ292IGlkdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJodSI6ICIgMjAwMCBhZ3JhciBib2x0IGNhc2lubyBjaXR5IGNvIGVyb3RpY2EgZXJvdGlrYSBmaWxtIGZvcnVtIGdhbWVzIGhvdGVsIGluZm8gaW5nYXRsYW4gam9nYXN6IGtvbnl2ZWxvIGxha2FzIG1lZGlhIG5ld3Mgb3JnIHByaXYgcmVrbGFtIHNleCBzaG9wIHNwb3J0IHN1bGkgc3pleCB0bSB0b3pzZGUgdXRhemFzIHZpZGVvICIsCiAgICAgICAgICAgICJpZCI6ICIgYWMgY28gZ28gbWlsIG5ldCBvciBzY2ggd2ViICIsCiAgICAgICAgICAgICJpbCI6ICIgYWMgY28gZ292IGlkZiBrMTIgbXVuaSBuZXQgb3JnICIsCiAgICAgICAgICAgICJpbiI6ICIgYWMgY28gZWR1IGVybmV0IGZpcm0gZ2VuIGdvdiBpIGluZCBtaWwgbmV0IG5pYyBvcmcgcmVzICIsCiAgICAgICAgICAgICJpcSI6ICIgY29tIGVkdSBnb3YgaSBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiaXIiOiAiIGFjIGNvIGRuc3NlYyBnb3YgaSBpZCBuZXQgb3JnIHNjaCAiLAogICAgICAgICAgICAiaXQiOiAiIGVkdSBnb3YgIiwKICAgICAgICAgICAgImplIjogIiBjbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJqbyI6ICIgY29tIGVkdSBnb3YgbWlsIG5hbWUgbmV0IG9yZyBzY2ggIiwKICAgICAgICAgICAgImpwIjogIiBhYyBhZCBjbyBlZCBnbyBnciBsZyBuZSBvciAiLAogICAgICAgICAgICAia2UiOiAiIGFjIGNvIGdvIGluZm8gbWUgbW9iaSBuZSBvciBzYyAiLAogICAgICAgICAgICAia2giOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnIHBlciAiLAogICAgICAgICAgICAia2kiOiAiIGJpeiBjb20gZGUgZWR1IGdvdiBpbmZvIG1vYiBuZXQgb3JnIHRlbCAiLAogICAgICAgICAgICAia20iOiAiIGFzc28gY29tIGNvb3AgZWR1IGdvdXYgayBtZWRlY2luIG1pbCBub20gbm90YWlyZXMgcGhhcm1hY2llbnMgcHJlc3NlIHRtIHZldGVyaW5haXJlICIsCiAgICAgICAgICAgICJrbiI6ICIgZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJrciI6ICIgYWMgYnVzYW4gY2h1bmdidWsgY2h1bmduYW0gY28gZGFlZ3UgZGFlamVvbiBlcyBnYW5nd29uIGdvIGd3YW5nanUgZ3llb25nYnVrIGd5ZW9uZ2dpIGd5ZW9uZ25hbSBocyBpbmNoZW9uIGplanUgamVvbmJ1ayBqZW9ubmFtIGsga2cgbWlsIG1zIG5lIG9yIHBlIHJlIHNjIHNlb3VsIHVsc2FuICIsCiAgICAgICAgICAgICJrdyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAia3kiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImt6IjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAibGIiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImxrIjogIiBhc3NuIGNvbSBlZHUgZ292IGdycCBob3RlbCBpbnQgbHRkIG5ldCBuZ28gb3JnIHNjaCBzb2Mgd2ViICIsCiAgICAgICAgICAgICJsciI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAibHYiOiAiIGFzbiBjb20gY29uZiBlZHUgZ292IGlkIG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJseSI6ICIgY29tIGVkdSBnb3YgaWQgbWVkIG5ldCBvcmcgcGxjIHNjaCAiLAogICAgICAgICAgICAibWEiOiAiIGFjIGNvIGdvdiBtIG5ldCBvcmcgcHJlc3MgIiwKICAgICAgICAgICAgIm1jIjogIiBhc3NvIHRtICIsCiAgICAgICAgICAgICJtZSI6ICIgYWMgY28gZWR1IGdvdiBpdHMgbmV0IG9yZyBwcml2ICIsCiAgICAgICAgICAgICJtZyI6ICIgY29tIGVkdSBnb3YgbWlsIG5vbSBvcmcgcHJkIHRtICIsCiAgICAgICAgICAgICJtayI6ICIgY29tIGVkdSBnb3YgaW5mIG5hbWUgbmV0IG9yZyBwcm8gIiwKICAgICAgICAgICAgIm1sIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnIHByZXNzZSAiLAogICAgICAgICAgICAibW4iOiAiIGVkdSBnb3Ygb3JnICIsCiAgICAgICAgICAgICJtbyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAibXQiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgIm12IjogIiBhZXJvIGJpeiBjb20gY29vcCBlZHUgZ292IGluZm8gaW50IG1pbCBtdXNldW0gbmFtZSBuZXQgb3JnIHBybyAiLAogICAgICAgICAgICAibXciOiAiIGFjIGNvIGNvbSBjb29wIGVkdSBnb3YgaW50IG11c2V1bSBuZXQgb3JnICIsCiAgICAgICAgICAgICJteCI6ICIgY29tIGVkdSBnb2IgbmV0IG9yZyAiLAogICAgICAgICAgICAibXkiOiAiIGNvbSBlZHUgZ292IG1pbCBuYW1lIG5ldCBvcmcgc2NoICIsCiAgICAgICAgICAgICJuZiI6ICIgYXJ0cyBjb20gZmlybSBpbmZvIG5ldCBvdGhlciBwZXIgcmVjIHN0b3JlIHdlYiAiLAogICAgICAgICAgICAibmciOiAiIGJpeiBjb20gZWR1IGdvdiBtaWwgbW9iaSBuYW1lIG5ldCBvcmcgc2NoICIsCiAgICAgICAgICAgICJuaSI6ICIgYWMgY28gY29tIGVkdSBnb2IgbWlsIG5ldCBub20gb3JnICIsCiAgICAgICAgICAgICJucCI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgIm5yIjogIiBiaXogY29tIGVkdSBnb3YgaW5mbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJvbSI6ICIgYWMgYml6IGNvIGNvbSBlZHUgZ292IG1lZCBtaWwgbXVzZXVtIG5ldCBvcmcgcHJvIHNjaCAiLAogICAgICAgICAgICAicGUiOiAiIGNvbSBlZHUgZ29iIG1pbCBuZXQgbm9tIG9yZyBzbGQgIiwKICAgICAgICAgICAgInBoIjogIiBjb20gZWR1IGdvdiBpIG1pbCBuZXQgbmdvIG9yZyAiLAogICAgICAgICAgICAicGsiOiAiIGJpeiBjb20gZWR1IGZhbSBnb2IgZ29rIGdvbiBnb3AgZ29zIGdvdiBuZXQgb3JnIHdlYiAiLAogICAgICAgICAgICAicGwiOiAiIGFydCBiaWFseXN0b2sgYml6IGNvbSBlZHUgZ2RhIGdkYW5zayBnb3J6b3cgZ292IGluZm8ga2F0b3dpY2Uga3Jha293IGxvZHogbHVibGluIG1pbCBuZXQgbmdvIG9sc3p0eW4gb3JnIHBvem5hbiBwd3IgcmFkb20gc2x1cHNrIHN6Y3plY2luIHRvcnVuIHdhcnN6YXdhIHdhdyB3cm9jIHdyb2NsYXcgemdvcmEgIiwKICAgICAgICAgICAgInByIjogIiBhYyBiaXogY29tIGVkdSBlc3QgZ292IGluZm8gaXNsYSBuYW1lIG5ldCBvcmcgcHJvIHByb2YgIiwKICAgICAgICAgICAgInBzIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnIHBsbyBzZWMgIiwKICAgICAgICAgICAgInB3IjogIiBiZWxhdSBjbyBlZCBnbyBuZSBvciAiLAogICAgICAgICAgICAicm8iOiAiIGFydHMgY29tIGZpcm0gaW5mbyBub20gbnQgb3JnIHJlYyBzdG9yZSB0bSB3d3cgIiwKICAgICAgICAgICAgInJzIjogIiBhYyBjbyBlZHUgZ292IGluIG9yZyAiLAogICAgICAgICAgICAic2IiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgInNjIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJzaCI6ICIgY28gY29tIGVkdSBnb3YgbmV0IG5vbSBvcmcgIiwKICAgICAgICAgICAgInNsIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJzdCI6ICIgY28gY29tIGNvbnN1bGFkbyBlZHUgZW1iYWl4YWRhIGdvdiBtaWwgbmV0IG9yZyBwcmluY2lwZSBzYW90b21lIHN0b3JlICIsCiAgICAgICAgICAgICJzdiI6ICIgY29tIGVkdSBnb2Igb3JnIHJlZCAiLAogICAgICAgICAgICAic3oiOiAiIGFjIGNvIG9yZyAiLAogICAgICAgICAgICAidHIiOiAiIGF2IGJicyBiZWwgYml6IGNvbSBkciBlZHUgZ2VuIGdvdiBpbmZvIGsxMiBuYW1lIG5ldCBvcmcgcG9sIHRlbCB0c2sgdHYgd2ViICIsCiAgICAgICAgICAgICJ0dCI6ICIgYWVybyBiaXogY2F0IGNvIGNvbSBjb29wIGVkdSBnb3YgaW5mbyBpbnQgam9icyBtaWwgbW9iaSBtdXNldW0gbmFtZSBuZXQgb3JnIHBybyB0ZWwgdHJhdmVsICIsCiAgICAgICAgICAgICJ0dyI6ICIgY2x1YiBjb20gZWJpeiBlZHUgZ2FtZSBnb3YgaWR2IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJtdSI6ICIgYWMgY28gY29tIGdvdiBuZXQgb3Igb3JnICIsCiAgICAgICAgICAgICJteiI6ICIgYWMgY28gZWR1IGdvdiBvcmcgIiwKICAgICAgICAgICAgIm5hIjogIiBjbyBjb20gIiwKICAgICAgICAgICAgIm56IjogIiBhYyBjbyBjcmkgZ2VlayBnZW4gZ292dCBoZWFsdGggaXdpIG1hb3JpIG1pbCBuZXQgb3JnIHBhcmxpYW1lbnQgc2Nob29sICIsCiAgICAgICAgICAgICJwYSI6ICIgYWJvIGFjIGNvbSBlZHUgZ29iIGluZyBtZWQgbmV0IG5vbSBvcmcgc2xkICIsCiAgICAgICAgICAgICJwdCI6ICIgY29tIGVkdSBnb3YgaW50IG5ldCBub21lIG9yZyBwdWJsICIsCiAgICAgICAgICAgICJweSI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgInFhIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAicmUiOiAiIGFzc28gY29tIG5vbSAiLAogICAgICAgICAgICAicnUiOiAiIGFjIGFkeWdleWEgYWx0YWkgYW11ciBhcmtoYW5nZWxzayBhc3RyYWtoYW4gYmFzaGtpcmlhIGJlbGdvcm9kIGJpciBicnlhbnNrIGJ1cnlhdGlhIGNiZyBjaGVsIGNoZWx5YWJpbnNrIGNoaXRhIGNodWtvdGthIGNodXZhc2hpYSBjb20gZGFnZXN0YW4gZS1idXJnIGVkdSBnb3YgZ3Jvem55IGludCBpcmt1dHNrIGl2YW5vdm8gaXpoZXZzayBqYXIgam9zaGthci1vbGEga2FsbXlraWEga2FsdWdhIGthbWNoYXRrYSBrYXJlbGlhIGthemFuIGtjaHIga2VtZXJvdm8ga2hhYmFyb3ZzayBraGFrYXNzaWEga2h2IGtpcm92IGtvZW5pZyBrb21pIGtvc3Ryb21hIGtyYW5veWFyc2sga3ViYW4ga3VyZ2FuIGt1cnNrIGxpcGV0c2sgbWFnYWRhbiBtYXJpIG1hcmktZWwgbWFyaW5lIG1pbCBtb3Jkb3ZpYSBtb3NyZWcgbXNrIG11cm1hbnNrIG5hbGNoaWsgbmV0IG5ub3Ygbm92IG5vdm9zaWJpcnNrIG5zayBvbXNrIG9yZW5idXJnIG9yZyBvcnlvbCBwZW56YSBwZXJtIHBwIHBza292IHB0eiBybmQgcnlhemFuIHNha2hhbGluIHNhbWFyYSBzYXJhdG92IHNpbWJpcnNrIHNtb2xlbnNrIHNwYiBzdGF2cm9wb2wgc3R2IHN1cmd1dCB0YW1ib3YgdGF0YXJzdGFuIHRvbSB0b21zayB0c2FyaXRzeW4gdHNrIHR1bGEgdHV2YSB0dmVyIHR5dW1lbiB1ZG0gdWRtdXJ0aWEgdWxhbi11ZGUgdmxhZGlrYXZrYXogdmxhZGltaXIgdmxhZGl2b3N0b2sgdm9sZ29ncmFkIHZvbG9nZGEgdm9yb25lemggdnJuIHZ5YXRrYSB5YWt1dGlhIHlhbWFsIHlla2F0ZXJpbmJ1cmcgeXV6aG5vLXNha2hhbGluc2sgIiwKICAgICAgICAgICAgInJ3IjogIiBhYyBjbyBjb20gZWR1IGdvdXYgZ292IGludCBtaWwgbmV0ICIsCiAgICAgICAgICAgICJzYSI6ICIgY29tIGVkdSBnb3YgbWVkIG5ldCBvcmcgcHViIHNjaCAiLAogICAgICAgICAgICAic2QiOiAiIGNvbSBlZHUgZ292IGluZm8gbWVkIG5ldCBvcmcgdHYgIiwKICAgICAgICAgICAgInNlIjogIiBhIGFjIGIgYmQgYyBkIGUgZiBnIGggaSBrIGwgbSBuIG8gb3JnIHAgcGFydGkgcHAgcHJlc3MgciBzIHQgdG0gdSB3IHggeSB6ICIsCiAgICAgICAgICAgICJzZyI6ICIgY29tIGVkdSBnb3YgaWRuIG5ldCBvcmcgcGVyICIsCiAgICAgICAgICAgICJzbiI6ICIgYXJ0IGNvbSBlZHUgZ291diBvcmcgcGVyc28gdW5pdiAiLAogICAgICAgICAgICAic3kiOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgbmV3cyBvcmcgIiwKICAgICAgICAgICAgInRoIjogIiBhYyBjbyBnbyBpbiBtaSBuZXQgb3IgIiwKICAgICAgICAgICAgInRqIjogIiBhYyBiaXogY28gY29tIGVkdSBnbyBnb3YgaW5mbyBpbnQgbWlsIG5hbWUgbmV0IG5pYyBvcmcgdGVzdCB3ZWIgIiwKICAgICAgICAgICAgInRuIjogIiBhZ3JpbmV0IGNvbSBkZWZlbnNlIGVkdW5ldCBlbnMgZmluIGdvdiBpbmQgaW5mbyBpbnRsIG1pbmNvbSBuYXQgbmV0IG9yZyBwZXJzbyBybnJ0IHJucyBybnUgdG91cmlzbSAiLAogICAgICAgICAgICAidHoiOiAiIGFjIGNvIGdvIG5lIG9yICIsCiAgICAgICAgICAgICJ1YSI6ICIgYml6IGNoZXJrYXNzeSBjaGVybmlnb3YgY2hlcm5vdnRzeSBjayBjbiBjbyBjb20gY3JpbWVhIGN2IGRuIGRuZXByb3BldHJvdnNrIGRvbmV0c2sgZHAgZWR1IGdvdiBpZiBpbiBpdmFuby1mcmFua2l2c2sga2gga2hhcmtvdiBraGVyc29uIGtobWVsbml0c2tpeSBraWV2IGtpcm92b2dyYWQga20ga3Iga3Mga3YgbGcgbHVnYW5zayBsdXRzayBsdml2IG1lIG1rIG5ldCBuaWtvbGFldiBvZCBvZGVzc2Egb3JnIHBsIHBvbHRhdmEgcHAgcm92bm8gcnYgc2ViYXN0b3BvbCBzdW15IHRlIHRlcm5vcGlsIHV6aGdvcm9kIHZpbm5pY2Egdm4gemFwb3Jpemh6aGUgemhpdG9taXIgenAgenQgIiwKICAgICAgICAgICAgInVnIjogIiBhYyBjbyBnbyBuZSBvciBvcmcgc2MgIiwKICAgICAgICAgICAgInVrIjogIiBhYyBibCBicml0aXNoLWxpYnJhcnkgY28gY3ltIGdvdiBnb3Z0IGljbmV0IGpldCBsZWEgbHRkIG1lIG1pbCBtb2QgbmF0aW9uYWwtbGlicmFyeS1zY290bGFuZCBuZWwgbmV0IG5ocyBuaWMgbmxzIG9yZyBvcmduIHBhcmxpYW1lbnQgcGxjIHBvbGljZSBzY2ggc2NvdCBzb2MgIiwKICAgICAgICAgICAgInVzIjogIiBkbmkgZmVkIGlzYSBraWRzIG5zbiAiLAogICAgICAgICAgICAidXkiOiAiIGNvbSBlZHUgZ3ViIG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJ2ZSI6ICIgY28gY29tIGVkdSBnb2IgaW5mbyBtaWwgbmV0IG9yZyB3ZWIgIiwKICAgICAgICAgICAgInZpIjogIiBjbyBjb20gazEyIG5ldCBvcmcgIiwKICAgICAgICAgICAgInZuIjogIiBhYyBiaXogY29tIGVkdSBnb3YgaGVhbHRoIGluZm8gaW50IG5hbWUgbmV0IG9yZyBwcm8gIiwKICAgICAgICAgICAgInllIjogIiBjbyBjb20gZ292IGx0ZCBtZSBuZXQgb3JnIHBsYyAiLAogICAgICAgICAgICAieXUiOiAiIGFjIGNvIGVkdSBnb3Ygb3JnICIsCiAgICAgICAgICAgICJ6YSI6ICIgYWMgYWdyaWMgYWx0IGJvdXJzZSBjaXR5IGNvIGN5YmVybmV0IGRiIGVkdSBnb3YgZ3JvbmRhciBpYWNjZXNzIGltdCBpbmNhIGxhbmRlc2lnbiBsYXcgbWlsIG5ldCBuZ28gbmlzIG5vbSBvbGl2ZXR0aSBvcmcgcGl4IHNjaG9vbCB0bSB3ZWIgIiwKICAgICAgICAgICAgInptIjogIiBhYyBjbyBjb20gZWR1IGdvdiBuZXQgb3JnIHNjaCAiLAogICAgICAgICAgICAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DZW50cmFsTmljI1NlY29uZC1sZXZlbF9kb21haW5zCiAgICAgICAgICAgICJjb20iOiAiYXIgYnIgY24gZGUgZXUgZ2IgZ3IgaHUganBuIGtyIG5vIHFjIHJ1IHNhIHNlIHVrIHVzIHV5IHphICIsCiAgICAgICAgICAgICJuZXQiOiAiZ2IganAgc2UgdWsgIiwKICAgICAgICAgICAgIm9yZyI6ICJhZSIsCiAgICAgICAgICAgICJkZSI6ICJjb20gIgogICAgICAgICAgfSwKICAgICAgICAgIC8vIGdvcmhpbGwgMjAxMy0xMC0yNTogVXNpbmcgaW5kZXhPZigpIGluc3RlYWQgUmVnZXhwKCkuIFNpZ25pZmljYW50IGJvb3N0CiAgICAgICAgICAvLyBpbiBib3RoIHBlcmZvcm1hbmNlIGFuZCBtZW1vcnkgZm9vdHByaW50LiBObyBpbml0aWFsaXphdGlvbiByZXF1aXJlZC4KICAgICAgICAgIC8vIGh0dHA6Ly9qc3BlcmYuY29tL3VyaS1qcy1zbGQtcmVnZXgtdnMtYmluYXJ5LXNlYXJjaC80CiAgICAgICAgICAvLyBGb2xsb3dpbmcgbWV0aG9kcyB1c2UgbGFzdEluZGV4T2YoKSByYXRoZXIgdGhhbiBhcnJheS5zcGxpdCgpIGluIG9yZGVyCiAgICAgICAgICAvLyB0byBhdm9pZCBhbnkgbWVtb3J5IGFsbG9jYXRpb25zLgogICAgICAgICAgaGFzOiBmdW5jdGlvbihkb21haW4pIHsKICAgICAgICAgICAgdmFyIHRsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIpOwogICAgICAgICAgICBpZiAodGxkT2Zmc2V0IDw9IDAgfHwgdGxkT2Zmc2V0ID49IGRvbWFpbi5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRPZmZzZXQgPSBkb21haW4ubGFzdEluZGV4T2YoIi4iLCB0bGRPZmZzZXQgLSAxKTsKICAgICAgICAgICAgaWYgKHNsZE9mZnNldCA8PSAwIHx8IHNsZE9mZnNldCA+PSB0bGRPZmZzZXQgLSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRMaXN0ID0gU0xELmxpc3RbZG9tYWluLnNsaWNlKHRsZE9mZnNldCArIDEpXTsKICAgICAgICAgICAgaWYgKCFzbGRMaXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzbGRMaXN0LmluZGV4T2YoIiAiICsgZG9tYWluLnNsaWNlKHNsZE9mZnNldCArIDEsIHRsZE9mZnNldCkgKyAiICIpID49IDA7CiAgICAgICAgICB9LAogICAgICAgICAgaXM6IGZ1bmN0aW9uKGRvbWFpbikgewogICAgICAgICAgICB2YXIgdGxkT2Zmc2V0ID0gZG9tYWluLmxhc3RJbmRleE9mKCIuIik7CiAgICAgICAgICAgIGlmICh0bGRPZmZzZXQgPD0gMCB8fCB0bGRPZmZzZXQgPj0gZG9tYWluLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIsIHRsZE9mZnNldCAtIDEpOwogICAgICAgICAgICBpZiAoc2xkT2Zmc2V0ID49IDApIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNsZExpc3QgPSBTTEQubGlzdFtkb21haW4uc2xpY2UodGxkT2Zmc2V0ICsgMSldOwogICAgICAgICAgICBpZiAoIXNsZExpc3QpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNsZExpc3QuaW5kZXhPZigiICIgKyBkb21haW4uc2xpY2UoMCwgdGxkT2Zmc2V0KSArICIgIikgPj0gMDsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGRvbWFpbikgewogICAgICAgICAgICB2YXIgdGxkT2Zmc2V0ID0gZG9tYWluLmxhc3RJbmRleE9mKCIuIik7CiAgICAgICAgICAgIGlmICh0bGRPZmZzZXQgPD0gMCB8fCB0bGRPZmZzZXQgPj0gZG9tYWluLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2xkT2Zmc2V0ID0gZG9tYWluLmxhc3RJbmRleE9mKCIuIiwgdGxkT2Zmc2V0IC0gMSk7CiAgICAgICAgICAgIGlmIChzbGRPZmZzZXQgPD0gMCB8fCBzbGRPZmZzZXQgPj0gdGxkT2Zmc2V0IC0gMSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRMaXN0ID0gU0xELmxpc3RbZG9tYWluLnNsaWNlKHRsZE9mZnNldCArIDEpXTsKICAgICAgICAgICAgaWYgKCFzbGRMaXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNsZExpc3QuaW5kZXhPZigiICIgKyBkb21haW4uc2xpY2Uoc2xkT2Zmc2V0ICsgMSwgdGxkT2Zmc2V0KSArICIgIikgPCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRvbWFpbi5zbGljZShzbGRPZmZzZXQgKyAxKTsKICAgICAgICAgIH0sCiAgICAgICAgICBub0NvbmZsaWN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgcm9vdC5TZWNvbmRMZXZlbERvbWFpbnMgPSBfU2Vjb25kTGV2ZWxEb21haW5zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIFNMRDsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy91cmlqcy9zcmMvVVJJLmpzCiAgdmFyIHJlcXVpcmVfVVJJID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9VUkkuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgLyohCiAgICAgICAqIFVSSS5qcyAtIE11dGF0aW5nIFVSTHMKICAgICAgICoKICAgICAgICogVmVyc2lvbjogMS4xOS4xMQogICAgICAgKgogICAgICAgKiBBdXRob3I6IFJvZG5leSBSZWhtCiAgICAgICAqIFdlYjogaHR0cDovL21lZGlhbGl6ZS5naXRodWIuaW8vVVJJLmpzLwogICAgICAgKgogICAgICAgKiBMaWNlbnNlZCB1bmRlcgogICAgICAgKiAgIE1JVCBMaWNlbnNlIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UKICAgICAgICoKICAgICAgICovCiAgICAgIChmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmVfcHVueWNvZGUoKSwgcmVxdWlyZV9JUHY2KCksIHJlcXVpcmVfU2Vjb25kTGV2ZWxEb21haW5zKCkpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgICBkZWZpbmUoWyIuL3B1bnljb2RlIiwgIi4vSVB2NiIsICIuL1NlY29uZExldmVsRG9tYWlucyJdLCBmYWN0b3J5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm9vdC5VUkkgPSBmYWN0b3J5KHJvb3QucHVueWNvZGUsIHJvb3QuSVB2Niwgcm9vdC5TZWNvbmRMZXZlbERvbWFpbnMsIHJvb3QpOwogICAgICAgIH0KICAgICAgfSkoZXhwb3J0czIsIGZ1bmN0aW9uKHB1bnljb2RlLCBJUHY2LCBTTEQsIHJvb3QpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIF9VUkkgPSByb290ICYmIHJvb3QuVVJJOwogICAgICAgIGZ1bmN0aW9uIFVSSSh1cmwsIGJhc2UpIHsKICAgICAgICAgIHZhciBfdXJsU3VwcGxpZWQgPSBhcmd1bWVudHMubGVuZ3RoID49IDE7CiAgICAgICAgICB2YXIgX2Jhc2VTdXBwbGllZCA9IGFyZ3VtZW50cy5sZW5ndGggPj0gMjsKICAgICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBVUkkpKSB7CiAgICAgICAgICAgIGlmIChfdXJsU3VwcGxpZWQpIHsKICAgICAgICAgICAgICBpZiAoX2Jhc2VTdXBwbGllZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkkodXJsLCBiYXNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkkodXJsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFVSSSgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHVybCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChfdXJsU3VwcGxpZWQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJ1bmRlZmluZWQgaXMgbm90IGEgdmFsaWQgYXJndW1lbnQgZm9yIFVSSSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbG9jYXRpb24gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgdXJsID0gbG9jYXRpb24uaHJlZiArICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVybCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXJsID09PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChfdXJsU3VwcGxpZWQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJudWxsIGlzIG5vdCBhIHZhbGlkIGFyZ3VtZW50IGZvciBVUkkiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5ocmVmKHVybCk7CiAgICAgICAgICBpZiAoYmFzZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFic29sdXRlVG8oYmFzZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbnRlZ2VyKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gL15bMC05XSskLy50ZXN0KHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgVVJJLnZlcnNpb24gPSAiMS4xOS4xMSI7CiAgICAgICAgdmFyIHAgPSBVUkkucHJvdG90eXBlOwogICAgICAgIHZhciBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIGZ1bmN0aW9uIGVzY2FwZVJlZ0V4KHN0cmluZykgewogICAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC8oWy4qKz9ePSE6JHt9KCl8W1xdXC9cXF0pL2csICJcXCQxIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFR5cGUodmFsdWUpIHsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiAiVW5kZWZpbmVkIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBTdHJpbmcoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSkuc2xpY2UoOCwgLTEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FycmF5KG9iaikgewogICAgICAgICAgcmV0dXJuIGdldFR5cGUob2JqKSA9PT0gIkFycmF5IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmlsdGVyQXJyYXlWYWx1ZXMoZGF0YSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBsb29rdXAgPSB7fTsKICAgICAgICAgIHZhciBpLCBsZW5ndGg7CiAgICAgICAgICBpZiAoZ2V0VHlwZSh2YWx1ZSkgPT09ICJSZWdFeHAiKSB7CiAgICAgICAgICAgIGxvb2t1cCA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgbG9va3VwW3ZhbHVlW2ldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxvb2t1cFt2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gZGF0YS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgX21hdGNoID0gbG9va3VwICYmIGxvb2t1cFtkYXRhW2ldXSAhPT0gdm9pZCAwIHx8ICFsb29rdXAgJiYgdmFsdWUudGVzdChkYXRhW2ldKTsKICAgICAgICAgICAgaWYgKF9tYXRjaCkgewogICAgICAgICAgICAgIGRhdGEuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFycmF5Q29udGFpbnMobGlzdCwgdmFsdWUpIHsKICAgICAgICAgIHZhciBpLCBsZW5ndGg7CiAgICAgICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gdmFsdWUubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBpZiAoIWFycmF5Q29udGFpbnMobGlzdCwgdmFsdWVbaV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIF90eXBlID0gZ2V0VHlwZSh2YWx1ZSk7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChfdHlwZSA9PT0gIlJlZ0V4cCIpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGxpc3RbaV0gPT09ICJzdHJpbmciICYmIGxpc3RbaV0ubWF0Y2godmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobGlzdFtpXSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcnJheXNFcXVhbChvbmUsIHR3bykgewogICAgICAgICAgaWYgKCFpc0FycmF5KG9uZSkgfHwgIWlzQXJyYXkodHdvKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob25lLmxlbmd0aCAhPT0gdHdvLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBvbmUuc29ydCgpOwogICAgICAgICAgdHdvLnNvcnQoKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gb25lLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBpZiAob25lW2ldICE9PSB0d29baV0pIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmltU2xhc2hlcyh0ZXh0KSB7CiAgICAgICAgICB2YXIgdHJpbV9leHByZXNzaW9uID0gL15cLyt8XC8rJC9nOwogICAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSh0cmltX2V4cHJlc3Npb24sICIiKTsKICAgICAgICB9CiAgICAgICAgVVJJLl9wYXJ0cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJvdG9jb2w6IG51bGwsCiAgICAgICAgICAgIHVzZXJuYW1lOiBudWxsLAogICAgICAgICAgICBwYXNzd29yZDogbnVsbCwKICAgICAgICAgICAgaG9zdG5hbWU6IG51bGwsCiAgICAgICAgICAgIHVybjogbnVsbCwKICAgICAgICAgICAgcG9ydDogbnVsbCwKICAgICAgICAgICAgcGF0aDogbnVsbCwKICAgICAgICAgICAgcXVlcnk6IG51bGwsCiAgICAgICAgICAgIGZyYWdtZW50OiBudWxsLAogICAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgICBwcmV2ZW50SW52YWxpZEhvc3RuYW1lOiBVUkkucHJldmVudEludmFsaWRIb3N0bmFtZSwKICAgICAgICAgICAgZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzOiBVUkkuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICBlc2NhcGVRdWVyeVNwYWNlOiBVUkkuZXNjYXBlUXVlcnlTcGFjZQogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFVSSS5wcmV2ZW50SW52YWxpZEhvc3RuYW1lID0gZmFsc2U7CiAgICAgICAgVVJJLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycyA9IGZhbHNlOwogICAgICAgIFVSSS5lc2NhcGVRdWVyeVNwYWNlID0gdHJ1ZTsKICAgICAgICBVUkkucHJvdG9jb2xfZXhwcmVzc2lvbiA9IC9eW2Etel1bYS16MC05ListXSokL2k7CiAgICAgICAgVVJJLmlkbl9leHByZXNzaW9uID0gL1teYS16MC05XC5fLV0vaTsKICAgICAgICBVUkkucHVueWNvZGVfZXhwcmVzc2lvbiA9IC8oeG4tLSkvaTsKICAgICAgICBVUkkuaXA0X2V4cHJlc3Npb24gPSAvXlxkezEsM31cLlxkezEsM31cLlxkezEsM31cLlxkezEsM30kLzsKICAgICAgICBVUkkuaXA2X2V4cHJlc3Npb24gPSAvXlxzKigoKFswLTlBLUZhLWZdezEsNH06KXs3fShbMC05QS1GYS1mXXsxLDR9fDopKXwoKFswLTlBLUZhLWZdezEsNH06KXs2fSg6WzAtOUEtRmEtZl17MSw0fXwoKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSl8OikpfCgoWzAtOUEtRmEtZl17MSw0fTopezV9KCgoOlswLTlBLUZhLWZdezEsNH0pezEsMn0pfDooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSl8OikpfCgoWzAtOUEtRmEtZl17MSw0fTopezR9KCgoOlswLTlBLUZhLWZdezEsNH0pezEsM30pfCgoOlswLTlBLUZhLWZdezEsNH0pPzooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSkpfDopKXwoKFswLTlBLUZhLWZdezEsNH06KXszfSgoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDR9KXwoKDpbMC05QS1GYS1mXXsxLDR9KXswLDJ9OigoMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkoXC4oMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkpezN9KSl8OikpfCgoWzAtOUEtRmEtZl17MSw0fTopezJ9KCgoOlswLTlBLUZhLWZdezEsNH0pezEsNX0pfCgoOlswLTlBLUZhLWZdezEsNH0pezAsM306KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pKXw6KSl8KChbMC05QS1GYS1mXXsxLDR9Oil7MX0oKCg6WzAtOUEtRmEtZl17MSw0fSl7MSw2fSl8KCg6WzAtOUEtRmEtZl17MSw0fSl7MCw0fTooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSkpfDopKXwoOigoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDd9KXwoKDpbMC05QS1GYS1mXXsxLDR9KXswLDV9OigoMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkoXC4oMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkpezN9KSl8OikpKSglLispP1xzKiQvOwogICAgICAgIFVSSS5maW5kX3VyaV9leHByZXNzaW9uID0gL1xiKCg/OlthLXpdW1x3LV0rOig/OlwvezEsM318W2EtejAtOSVdKXx3d3dcZHswLDN9Wy5dfFthLXowLTkuXC1dK1suXVthLXpdezIsNH1cLykoPzpbXlxzKCk8Pl0rfFwoKFteXHMoKTw+XSt8KFwoW15ccygpPD5dK1wpKSkqXCkpKyg/OlwoKFteXHMoKTw+XSt8KFwoW15ccygpPD5dK1wpKSkqXCl8W15cc2AhKClcW1xde307OiciLiw8Pj/Cq8K74oCc4oCd4oCY4oCZXSkpL2lnOwogICAgICAgIFVSSS5maW5kVXJpID0gewogICAgICAgICAgLy8gdmFsaWQgInNjaGVtZTovLyIgb3IgInd3dy4iCiAgICAgICAgICBzdGFydDogL1xiKD86KFthLXpdW2EtejAtOS4rLV0qOlwvXC8pfHd3d1wuKS9naSwKICAgICAgICAgIC8vIGV2ZXJ5dGhpbmcgdXAgdG8gdGhlIG5leHQgd2hpdGVzcGFjZQogICAgICAgICAgZW5kOiAvW1xzXHJcbl18JC8sCiAgICAgICAgICAvLyB0cmltIHRyYWlsaW5nIHB1bmN0dWF0aW9uIGNhcHR1cmVkIGJ5IGVuZCBSZWdFeHAKICAgICAgICAgIHRyaW06IC9bYCEoKVxbXF17fTs6JyIuLDw+P8KrwrvigJzigJ3igJ7igJjigJldKyQvLAogICAgICAgICAgLy8gYmFsYW5jZWQgcGFyZW5zIGluY2x1c2lvbiAoKSwgW10sIHt9LCA8PgogICAgICAgICAgcGFyZW5zOiAvKFwoW15cKV0qXCl8XFtbXlxdXSpcXXxce1tefV0qXH18PFtePl0qPikvZwogICAgICAgIH07CiAgICAgICAgVVJJLmxlYWRpbmdfd2hpdGVzcGFjZV9leHByZXNzaW9uID0gL15bXHgwMC1ceDIwXHUwMGEwXHUxNjgwXHUyMDAwLVx1MjAwYVx1MjAyOFx1MjAyOVx1MjAyZlx1MjA1Zlx1MzAwMFx1ZmVmZl0rLzsKICAgICAgICBVUkkuYXNjaWlfdGFiX3doaXRlc3BhY2UgPSAvW1x1MDAwOVx1MDAwQVx1MDAwRF0rL2c7CiAgICAgICAgVVJJLmRlZmF1bHRQb3J0cyA9IHsKICAgICAgICAgIGh0dHA6ICI4MCIsCiAgICAgICAgICBodHRwczogIjQ0MyIsCiAgICAgICAgICBmdHA6ICIyMSIsCiAgICAgICAgICBnb3BoZXI6ICI3MCIsCiAgICAgICAgICB3czogIjgwIiwKICAgICAgICAgIHdzczogIjQ0MyIKICAgICAgICB9OwogICAgICAgIFVSSS5ob3N0UHJvdG9jb2xzID0gWwogICAgICAgICAgImh0dHAiLAogICAgICAgICAgImh0dHBzIgogICAgICAgIF07CiAgICAgICAgVVJJLmludmFsaWRfaG9zdG5hbWVfY2hhcmFjdGVycyA9IC9bXmEtekEtWjAtOVwuXC06X10vOwogICAgICAgIFVSSS5kb21BdHRyaWJ1dGVzID0gewogICAgICAgICAgImEiOiAiaHJlZiIsCiAgICAgICAgICAiYmxvY2txdW90ZSI6ICJjaXRlIiwKICAgICAgICAgICJsaW5rIjogImhyZWYiLAogICAgICAgICAgImJhc2UiOiAiaHJlZiIsCiAgICAgICAgICAic2NyaXB0IjogInNyYyIsCiAgICAgICAgICAiZm9ybSI6ICJhY3Rpb24iLAogICAgICAgICAgImltZyI6ICJzcmMiLAogICAgICAgICAgImFyZWEiOiAiaHJlZiIsCiAgICAgICAgICAiaWZyYW1lIjogInNyYyIsCiAgICAgICAgICAiZW1iZWQiOiAic3JjIiwKICAgICAgICAgICJzb3VyY2UiOiAic3JjIiwKICAgICAgICAgICJ0cmFjayI6ICJzcmMiLAogICAgICAgICAgImlucHV0IjogInNyYyIsCiAgICAgICAgICAvLyBidXQgb25seSBpZiB0eXBlPSJpbWFnZSIKICAgICAgICAgICJhdWRpbyI6ICJzcmMiLAogICAgICAgICAgInZpZGVvIjogInNyYyIKICAgICAgICB9OwogICAgICAgIFVSSS5nZXREb21BdHRyaWJ1dGUgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICBpZiAoIW5vZGUgfHwgIW5vZGUubm9kZU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiBub2RlLnR5cGUgIT09ICJpbWFnZSIpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBVUkkuZG9tQXR0cmlidXRlc1tub2RlTmFtZV07CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBlc2NhcGVGb3JEdW1iRmlyZWZveDM2KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gZXNjYXBlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RyaWN0RW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZykgewogICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmcpLnJlcGxhY2UoL1shJygpKl0vZywgZXNjYXBlRm9yRHVtYkZpcmVmb3gzNikucmVwbGFjZSgvXCovZywgIiUyQSIpOwogICAgICAgIH0KICAgICAgICBVUkkuZW5jb2RlID0gc3RyaWN0RW5jb2RlVVJJQ29tcG9uZW50OwogICAgICAgIFVSSS5kZWNvZGUgPSBkZWNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgVVJJLmlzbzg4NTkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIFVSSS5lbmNvZGUgPSBlc2NhcGU7CiAgICAgICAgICBVUkkuZGVjb2RlID0gdW5lc2NhcGU7CiAgICAgICAgfTsKICAgICAgICBVUkkudW5pY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgVVJJLmVuY29kZSA9IHN0cmljdEVuY29kZVVSSUNvbXBvbmVudDsKICAgICAgICAgIFVSSS5kZWNvZGUgPSBkZWNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuY2hhcmFjdGVycyA9IHsKICAgICAgICAgIHBhdGhuYW1lOiB7CiAgICAgICAgICAgIGVuY29kZTogewogICAgICAgICAgICAgIC8vIFJGQzM5ODYgMi4xOiBGb3IgY29uc2lzdGVuY3ksIFVSSSBwcm9kdWNlcnMgYW5kIG5vcm1hbGl6ZXJzIHNob3VsZAogICAgICAgICAgICAgIC8vIHVzZSB1cHBlcmNhc2UgaGV4YWRlY2ltYWwgZGlnaXRzIGZvciBhbGwgcGVyY2VudC1lbmNvZGluZ3MuCiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogLyUoMjR8MjZ8MkJ8MkN8M0J8M0R8M0F8NDApL2lnLAogICAgICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgICAgLy8gLS5ffiEnKCkqCiAgICAgICAgICAgICAgICAiJTI0IjogIiQiLAogICAgICAgICAgICAgICAgIiUyNiI6ICImIiwKICAgICAgICAgICAgICAgICIlMkIiOiAiKyIsCiAgICAgICAgICAgICAgICAiJTJDIjogIiwiLAogICAgICAgICAgICAgICAgIiUzQiI6ICI7IiwKICAgICAgICAgICAgICAgICIlM0QiOiAiPSIsCiAgICAgICAgICAgICAgICAiJTNBIjogIjoiLAogICAgICAgICAgICAgICAgIiU0MCI6ICJAIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVjb2RlOiB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogL1tcL1w/I10vZywKICAgICAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICAgICIvIjogIiUyRiIsCiAgICAgICAgICAgICAgICAiPyI6ICIlM0YiLAogICAgICAgICAgICAgICAgIiMiOiAiJTIzIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHJlc2VydmVkOiB7CiAgICAgICAgICAgIGVuY29kZTogewogICAgICAgICAgICAgIC8vIFJGQzM5ODYgMi4xOiBGb3IgY29uc2lzdGVuY3ksIFVSSSBwcm9kdWNlcnMgYW5kIG5vcm1hbGl6ZXJzIHNob3VsZAogICAgICAgICAgICAgIC8vIHVzZSB1cHBlcmNhc2UgaGV4YWRlY2ltYWwgZGlnaXRzIGZvciBhbGwgcGVyY2VudC1lbmNvZGluZ3MuCiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogLyUoMjF8MjN8MjR8MjZ8Mjd8Mjh8Mjl8MkF8MkJ8MkN8MkZ8M0F8M0J8M0R8M0Z8NDB8NUJ8NUQpL2lnLAogICAgICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgICAgLy8gZ2VuLWRlbGltcwogICAgICAgICAgICAgICAgIiUzQSI6ICI6IiwKICAgICAgICAgICAgICAgICIlMkYiOiAiLyIsCiAgICAgICAgICAgICAgICAiJTNGIjogIj8iLAogICAgICAgICAgICAgICAgIiUyMyI6ICIjIiwKICAgICAgICAgICAgICAgICIlNUIiOiAiWyIsCiAgICAgICAgICAgICAgICAiJTVEIjogIl0iLAogICAgICAgICAgICAgICAgIiU0MCI6ICJAIiwKICAgICAgICAgICAgICAgIC8vIHN1Yi1kZWxpbXMKICAgICAgICAgICAgICAgICIlMjEiOiAiISIsCiAgICAgICAgICAgICAgICAiJTI0IjogIiQiLAogICAgICAgICAgICAgICAgIiUyNiI6ICImIiwKICAgICAgICAgICAgICAgICIlMjciOiAiJyIsCiAgICAgICAgICAgICAgICAiJTI4IjogIigiLAogICAgICAgICAgICAgICAgIiUyOSI6ICIpIiwKICAgICAgICAgICAgICAgICIlMkEiOiAiKiIsCiAgICAgICAgICAgICAgICAiJTJCIjogIisiLAogICAgICAgICAgICAgICAgIiUyQyI6ICIsIiwKICAgICAgICAgICAgICAgICIlM0IiOiAiOyIsCiAgICAgICAgICAgICAgICAiJTNEIjogIj0iCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgdXJucGF0aDogewogICAgICAgICAgICAvLyBUaGUgY2hhcmFjdGVycyB1bmRlciBgZW5jb2RlYCBhcmUgdGhlIGNoYXJhY3RlcnMgY2FsbGVkIG91dCBieSBSRkMgMjE0MSBhcyBiZWluZyBhY2NlcHRhYmxlCiAgICAgICAgICAgIC8vIGZvciB1c2FnZSBpbiBhIFVSTi4gUkZDMjE0MSBhbHNvIGNhbGxzIG91dCAiLSIsICIuIiwgYW5kICJfIiBhcyBhY2NlcHRhYmxlIGNoYXJhY3RlcnMsIGJ1dAogICAgICAgICAgICAvLyB0aGVzZSBhcmVuJ3QgZW5jb2RlZCBieSBlbmNvZGVVUklDb21wb25lbnQsIHNvIHdlIGRvbid0IGhhdmUgdG8gY2FsbCB0aGVtIG91dCBoZXJlLiBBbHNvCiAgICAgICAgICAgIC8vIG5vdGUgdGhhdCB0aGUgY29sb24gY2hhcmFjdGVyIGlzIG5vdCBmZWF0dXJlZCBpbiB0aGUgZW5jb2RpbmcgbWFwOyB0aGlzIGlzIGJlY2F1c2UgVVJJLmpzCiAgICAgICAgICAgIC8vIGdpdmVzIHRoZSBjb2xvbnMgaW4gVVJOcyBzZW1hbnRpYyBtZWFuaW5nIGFzIHRoZSBkZWxpbWl0ZXJzIG9mIHBhdGggc2VnZW1lbnRzLCBhbmQgc28gaXQKICAgICAgICAgICAgLy8gc2hvdWxkIG5vdCBhcHBlYXIgdW5lbmNvZGVkIGluIGEgc2VnbWVudCBpdHNlbGYuCiAgICAgICAgICAgIC8vIFNlZSBhbHNvIHRoZSBub3RlIGFib3ZlIGFib3V0IFJGQzM5ODYgYW5kIGNhcGl0YWxhbGl6ZWQgaGV4IGRpZ2l0cy4KICAgICAgICAgICAgZW5jb2RlOiB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogLyUoMjF8MjR8Mjd8Mjh8Mjl8MkF8MkJ8MkN8M0J8M0R8NDApL2lnLAogICAgICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgICAgIiUyMSI6ICIhIiwKICAgICAgICAgICAgICAgICIlMjQiOiAiJCIsCiAgICAgICAgICAgICAgICAiJTI3IjogIiciLAogICAgICAgICAgICAgICAgIiUyOCI6ICIoIiwKICAgICAgICAgICAgICAgICIlMjkiOiAiKSIsCiAgICAgICAgICAgICAgICAiJTJBIjogIioiLAogICAgICAgICAgICAgICAgIiUyQiI6ICIrIiwKICAgICAgICAgICAgICAgICIlMkMiOiAiLCIsCiAgICAgICAgICAgICAgICAiJTNCIjogIjsiLAogICAgICAgICAgICAgICAgIiUzRCI6ICI9IiwKICAgICAgICAgICAgICAgICIlNDAiOiAiQCIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8vIFRoZXNlIGNoYXJhY3RlcnMgYXJlIHRoZSBjaGFyYWN0ZXJzIGNhbGxlZCBvdXQgYnkgUkZDMjE0MSBhcyAicmVzZXJ2ZWQiIGNoYXJhY3RlcnMgdGhhdAogICAgICAgICAgICAvLyBzaG91bGQgbmV2ZXIgYXBwZWFyIGluIGEgVVJOLCBwbHVzIHRoZSBjb2xvbiBjaGFyYWN0ZXIgKHNlZSBub3RlIGFib3ZlKS4KICAgICAgICAgICAgZGVjb2RlOiB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogL1tcL1w/IzpdL2csCiAgICAgICAgICAgICAgbWFwOiB7CiAgICAgICAgICAgICAgICAiLyI6ICIlMkYiLAogICAgICAgICAgICAgICAgIj8iOiAiJTNGIiwKICAgICAgICAgICAgICAgICIjIjogIiUyMyIsCiAgICAgICAgICAgICAgICAiOiI6ICIlM0EiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkuZW5jb2RlUXVlcnkgPSBmdW5jdGlvbihzdHJpbmcsIGVzY2FwZVF1ZXJ5U3BhY2UpIHsKICAgICAgICAgIHZhciBlc2NhcGVkID0gVVJJLmVuY29kZShzdHJpbmcgKyAiIik7CiAgICAgICAgICBpZiAoZXNjYXBlUXVlcnlTcGFjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVzY2FwZVF1ZXJ5U3BhY2UgPSBVUkkuZXNjYXBlUXVlcnlTcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlc2NhcGVRdWVyeVNwYWNlID8gZXNjYXBlZC5yZXBsYWNlKC8lMjAvZywgIisiKSA6IGVzY2FwZWQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuZGVjb2RlUXVlcnkgPSBmdW5jdGlvbihzdHJpbmcsIGVzY2FwZVF1ZXJ5U3BhY2UpIHsKICAgICAgICAgIHN0cmluZyArPSAiIjsKICAgICAgICAgIGlmIChlc2NhcGVRdWVyeVNwYWNlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgZXNjYXBlUXVlcnlTcGFjZSA9IFVSSS5lc2NhcGVRdWVyeVNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIFVSSS5kZWNvZGUoZXNjYXBlUXVlcnlTcGFjZSA/IHN0cmluZy5yZXBsYWNlKC9cKy9nLCAiJTIwIikgOiBzdHJpbmcpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIF9wYXJ0cyA9IHsgImVuY29kZSI6ICJlbmNvZGUiLCAiZGVjb2RlIjogImRlY29kZSIgfTsKICAgICAgICB2YXIgX3BhcnQ7CiAgICAgICAgdmFyIGdlbmVyYXRlQWNjZXNzb3IgPSBmdW5jdGlvbihfZ3JvdXAsIF9wYXJ0MikgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBVUklbX3BhcnQyXShzdHJpbmcgKyAiIikucmVwbGFjZShVUkkuY2hhcmFjdGVyc1tfZ3JvdXBdW19wYXJ0Ml0uZXhwcmVzc2lvbiwgZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgcmV0dXJuIFVSSS5jaGFyYWN0ZXJzW19ncm91cF1bX3BhcnQyXS5tYXBbY107CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgZm9yIChfcGFydCBpbiBfcGFydHMpIHsKICAgICAgICAgIFVSSVtfcGFydCArICJQYXRoU2VnbWVudCJdID0gZ2VuZXJhdGVBY2Nlc3NvcigicGF0aG5hbWUiLCBfcGFydHNbX3BhcnRdKTsKICAgICAgICAgIFVSSVtfcGFydCArICJVcm5QYXRoU2VnbWVudCJdID0gZ2VuZXJhdGVBY2Nlc3NvcigidXJucGF0aCIsIF9wYXJ0c1tfcGFydF0pOwogICAgICAgIH0KICAgICAgICB2YXIgZ2VuZXJhdGVTZWdtZW50ZWRQYXRoRnVuY3Rpb24gPSBmdW5jdGlvbihfc2VwLCBfY29kaW5nRnVuY05hbWUsIF9pbm5lckNvZGluZ0Z1bmNOYW1lKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBhY3R1YWxDb2RpbmdGdW5jOwogICAgICAgICAgICBpZiAoIV9pbm5lckNvZGluZ0Z1bmNOYW1lKSB7CiAgICAgICAgICAgICAgYWN0dWFsQ29kaW5nRnVuYyA9IFVSSVtfY29kaW5nRnVuY05hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFjdHVhbENvZGluZ0Z1bmMgPSBmdW5jdGlvbihzdHJpbmcyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVVJJW19jb2RpbmdGdW5jTmFtZV0oVVJJW19pbm5lckNvZGluZ0Z1bmNOYW1lXShzdHJpbmcyKSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2VnbWVudHMgPSAoc3RyaW5nICsgIiIpLnNwbGl0KF9zZXApOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gc2VnbWVudHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzZWdtZW50c1tpXSA9IGFjdHVhbENvZGluZ0Z1bmMoc2VnbWVudHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzZWdtZW50cy5qb2luKF9zZXApOwogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFVSSS5kZWNvZGVQYXRoID0gZ2VuZXJhdGVTZWdtZW50ZWRQYXRoRnVuY3Rpb24oIi8iLCAiZGVjb2RlUGF0aFNlZ21lbnQiKTsKICAgICAgICBVUkkuZGVjb2RlVXJuUGF0aCA9IGdlbmVyYXRlU2VnbWVudGVkUGF0aEZ1bmN0aW9uKCI6IiwgImRlY29kZVVyblBhdGhTZWdtZW50Iik7CiAgICAgICAgVVJJLnJlY29kZVBhdGggPSBnZW5lcmF0ZVNlZ21lbnRlZFBhdGhGdW5jdGlvbigiLyIsICJlbmNvZGVQYXRoU2VnbWVudCIsICJkZWNvZGUiKTsKICAgICAgICBVUkkucmVjb2RlVXJuUGF0aCA9IGdlbmVyYXRlU2VnbWVudGVkUGF0aEZ1bmN0aW9uKCI6IiwgImVuY29kZVVyblBhdGhTZWdtZW50IiwgImRlY29kZSIpOwogICAgICAgIFVSSS5lbmNvZGVSZXNlcnZlZCA9IGdlbmVyYXRlQWNjZXNzb3IoInJlc2VydmVkIiwgImVuY29kZSIpOwogICAgICAgIFVSSS5wYXJzZSA9IGZ1bmN0aW9uKHN0cmluZywgcGFydHMpIHsKICAgICAgICAgIHZhciBwb3M7CiAgICAgICAgICBpZiAoIXBhcnRzKSB7CiAgICAgICAgICAgIHBhcnRzID0gewogICAgICAgICAgICAgIHByZXZlbnRJbnZhbGlkSG9zdG5hbWU6IFVSSS5wcmV2ZW50SW52YWxpZEhvc3RuYW1lCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShVUkkubGVhZGluZ193aGl0ZXNwYWNlX2V4cHJlc3Npb24sICIiKTsKICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKFVSSS5hc2NpaV90YWJfd2hpdGVzcGFjZSwgIiIpOwogICAgICAgICAgcG9zID0gc3RyaW5nLmluZGV4T2YoIiMiKTsKICAgICAgICAgIGlmIChwb3MgPiAtMSkgewogICAgICAgICAgICBwYXJ0cy5mcmFnbWVudCA9IHN0cmluZy5zdWJzdHJpbmcocG9zICsgMSkgfHwgbnVsbDsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZygwLCBwb3MpOwogICAgICAgICAgfQogICAgICAgICAgcG9zID0gc3RyaW5nLmluZGV4T2YoIj8iKTsKICAgICAgICAgIGlmIChwb3MgPiAtMSkgewogICAgICAgICAgICBwYXJ0cy5xdWVyeSA9IHN0cmluZy5zdWJzdHJpbmcocG9zICsgMSkgfHwgbnVsbDsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZygwLCBwb3MpOwogICAgICAgICAgfQogICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoL14oaHR0cHM/fGZ0cHx3c3M/KT86K1svXFxdKi9pLCAiJDE6Ly8iKTsKICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9eWy9cXF17Mix9L2ksICIvLyIpOwogICAgICAgICAgaWYgKHN0cmluZy5zdWJzdHJpbmcoMCwgMikgPT09ICIvLyIpIHsKICAgICAgICAgICAgcGFydHMucHJvdG9jb2wgPSBudWxsOwogICAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcuc3Vic3RyaW5nKDIpOwogICAgICAgICAgICBzdHJpbmcgPSBVUkkucGFyc2VBdXRob3JpdHkoc3RyaW5nLCBwYXJ0cyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwb3MgPSBzdHJpbmcuaW5kZXhPZigiOiIpOwogICAgICAgICAgICBpZiAocG9zID4gLTEpIHsKICAgICAgICAgICAgICBwYXJ0cy5wcm90b2NvbCA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKSB8fCBudWxsOwogICAgICAgICAgICAgIGlmIChwYXJ0cy5wcm90b2NvbCAmJiAhcGFydHMucHJvdG9jb2wubWF0Y2goVVJJLnByb3RvY29sX2V4cHJlc3Npb24pKSB7CiAgICAgICAgICAgICAgICBwYXJ0cy5wcm90b2NvbCA9IHZvaWQgMDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmluZy5zdWJzdHJpbmcocG9zICsgMSwgcG9zICsgMykucmVwbGFjZSgvXFwvZywgIi8iKSA9PT0gIi8vIikgewogICAgICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZyhwb3MgKyAzKTsKICAgICAgICAgICAgICAgIHN0cmluZyA9IFVSSS5wYXJzZUF1dGhvcml0eShzdHJpbmcsIHBhcnRzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZyhwb3MgKyAxKTsKICAgICAgICAgICAgICAgIHBhcnRzLnVybiA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwYXJ0cy5wYXRoID0gc3RyaW5nOwogICAgICAgICAgcmV0dXJuIHBhcnRzOwogICAgICAgIH07CiAgICAgICAgVVJJLnBhcnNlSG9zdCA9IGZ1bmN0aW9uKHN0cmluZywgcGFydHMpIHsKICAgICAgICAgIGlmICghc3RyaW5nKSB7CiAgICAgICAgICAgIHN0cmluZyA9ICIiOwogICAgICAgICAgfQogICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgICAgICB2YXIgcG9zID0gc3RyaW5nLmluZGV4T2YoIi8iKTsKICAgICAgICAgIHZhciBicmFja2V0UG9zOwogICAgICAgICAgdmFyIHQ7CiAgICAgICAgICBpZiAocG9zID09PSAtMSkgewogICAgICAgICAgICBwb3MgPSBzdHJpbmcubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0cmluZy5jaGFyQXQoMCkgPT09ICJbIikgewogICAgICAgICAgICBicmFja2V0UG9zID0gc3RyaW5nLmluZGV4T2YoIl0iKTsKICAgICAgICAgICAgcGFydHMuaG9zdG5hbWUgPSBzdHJpbmcuc3Vic3RyaW5nKDEsIGJyYWNrZXRQb3MpIHx8IG51bGw7CiAgICAgICAgICAgIHBhcnRzLnBvcnQgPSBzdHJpbmcuc3Vic3RyaW5nKGJyYWNrZXRQb3MgKyAyLCBwb3MpIHx8IG51bGw7CiAgICAgICAgICAgIGlmIChwYXJ0cy5wb3J0ID09PSAiLyIpIHsKICAgICAgICAgICAgICBwYXJ0cy5wb3J0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGZpcnN0Q29sb24gPSBzdHJpbmcuaW5kZXhPZigiOiIpOwogICAgICAgICAgICB2YXIgZmlyc3RTbGFzaCA9IHN0cmluZy5pbmRleE9mKCIvIik7CiAgICAgICAgICAgIHZhciBuZXh0Q29sb24gPSBzdHJpbmcuaW5kZXhPZigiOiIsIGZpcnN0Q29sb24gKyAxKTsKICAgICAgICAgICAgaWYgKG5leHRDb2xvbiAhPT0gLTEgJiYgKGZpcnN0U2xhc2ggPT09IC0xIHx8IG5leHRDb2xvbiA8IGZpcnN0U2xhc2gpKSB7CiAgICAgICAgICAgICAgcGFydHMuaG9zdG5hbWUgPSBzdHJpbmcuc3Vic3RyaW5nKDAsIHBvcykgfHwgbnVsbDsKICAgICAgICAgICAgICBwYXJ0cy5wb3J0ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0ID0gc3RyaW5nLnN1YnN0cmluZygwLCBwb3MpLnNwbGl0KCI6Iik7CiAgICAgICAgICAgICAgcGFydHMuaG9zdG5hbWUgPSB0WzBdIHx8IG51bGw7CiAgICAgICAgICAgICAgcGFydHMucG9ydCA9IHRbMV0gfHwgbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnRzLmhvc3RuYW1lICYmIHN0cmluZy5zdWJzdHJpbmcocG9zKS5jaGFyQXQoMCkgIT09ICIvIikgewogICAgICAgICAgICBwb3MrKzsKICAgICAgICAgICAgc3RyaW5nID0gIi8iICsgc3RyaW5nOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnRzLnByZXZlbnRJbnZhbGlkSG9zdG5hbWUpIHsKICAgICAgICAgICAgVVJJLmVuc3VyZVZhbGlkSG9zdG5hbWUocGFydHMuaG9zdG5hbWUsIHBhcnRzLnByb3RvY29sKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJ0cy5wb3J0KSB7CiAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZFBvcnQocGFydHMucG9ydCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3RyaW5nLnN1YnN0cmluZyhwb3MpIHx8ICIvIjsKICAgICAgICB9OwogICAgICAgIFVSSS5wYXJzZUF1dGhvcml0eSA9IGZ1bmN0aW9uKHN0cmluZywgcGFydHMpIHsKICAgICAgICAgIHN0cmluZyA9IFVSSS5wYXJzZVVzZXJpbmZvKHN0cmluZywgcGFydHMpOwogICAgICAgICAgcmV0dXJuIFVSSS5wYXJzZUhvc3Qoc3RyaW5nLCBwYXJ0cyk7CiAgICAgICAgfTsKICAgICAgICBVUkkucGFyc2VVc2VyaW5mbyA9IGZ1bmN0aW9uKHN0cmluZywgcGFydHMpIHsKICAgICAgICAgIHZhciBfc3RyaW5nID0gc3RyaW5nOwogICAgICAgICAgdmFyIGZpcnN0QmFja1NsYXNoID0gc3RyaW5nLmluZGV4T2YoIlxcIik7CiAgICAgICAgICBpZiAoZmlyc3RCYWNrU2xhc2ggIT09IC0xKSB7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpcnN0U2xhc2ggPSBzdHJpbmcuaW5kZXhPZigiLyIpOwogICAgICAgICAgdmFyIHBvcyA9IHN0cmluZy5sYXN0SW5kZXhPZigiQCIsIGZpcnN0U2xhc2ggPiAtMSA/IGZpcnN0U2xhc2ggOiBzdHJpbmcubGVuZ3RoIC0gMSk7CiAgICAgICAgICB2YXIgdDsKICAgICAgICAgIGlmIChwb3MgPiAtMSAmJiAoZmlyc3RTbGFzaCA9PT0gLTEgfHwgcG9zIDwgZmlyc3RTbGFzaCkpIHsKICAgICAgICAgICAgdCA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKS5zcGxpdCgiOiIpOwogICAgICAgICAgICBwYXJ0cy51c2VybmFtZSA9IHRbMF0gPyBVUkkuZGVjb2RlKHRbMF0pIDogbnVsbDsKICAgICAgICAgICAgdC5zaGlmdCgpOwogICAgICAgICAgICBwYXJ0cy5wYXNzd29yZCA9IHRbMF0gPyBVUkkuZGVjb2RlKHQuam9pbigiOiIpKSA6IG51bGw7CiAgICAgICAgICAgIHN0cmluZyA9IF9zdHJpbmcuc3Vic3RyaW5nKHBvcyArIDEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFydHMudXNlcm5hbWUgPSBudWxsOwogICAgICAgICAgICBwYXJ0cy5wYXNzd29yZCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH07CiAgICAgICAgVVJJLnBhcnNlUXVlcnkgPSBmdW5jdGlvbihzdHJpbmcsIGVzY2FwZVF1ZXJ5U3BhY2UpIHsKICAgICAgICAgIGlmICghc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICAgIH0KICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC8mKy9nLCAiJiIpLnJlcGxhY2UoL15cPyomKnwmKyQvZywgIiIpOwogICAgICAgICAgaWYgKCFzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGl0ZW1zID0ge307CiAgICAgICAgICB2YXIgc3BsaXRzID0gc3RyaW5nLnNwbGl0KCImIik7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gc3BsaXRzLmxlbmd0aDsKICAgICAgICAgIHZhciB2MywgbmFtZSwgdmFsdWU7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHYzID0gc3BsaXRzW2ldLnNwbGl0KCI9Iik7CiAgICAgICAgICAgIG5hbWUgPSBVUkkuZGVjb2RlUXVlcnkodjMuc2hpZnQoKSwgZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgIHZhbHVlID0gdjMubGVuZ3RoID8gVVJJLmRlY29kZVF1ZXJ5KHYzLmpvaW4oIj0iKSwgZXNjYXBlUXVlcnlTcGFjZSkgOiBudWxsOwogICAgICAgICAgICBpZiAobmFtZSA9PT0gIl9fcHJvdG9fXyIpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNPd24uY2FsbChpdGVtcywgbmFtZSkpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW1zW25hbWVdID09PSAic3RyaW5nIiB8fCBpdGVtc1tuYW1lXSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaXRlbXNbbmFtZV0gPSBbaXRlbXNbbmFtZV1dOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpdGVtc1tuYW1lXS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpdGVtc1tuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaXRlbXM7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGQgPSBmdW5jdGlvbihwYXJ0cykgewogICAgICAgICAgdmFyIHQgPSAiIjsKICAgICAgICAgIHZhciByZXF1aXJlQWJzb2x1dGVQYXRoID0gZmFsc2U7CiAgICAgICAgICBpZiAocGFydHMucHJvdG9jb2wpIHsKICAgICAgICAgICAgdCArPSBwYXJ0cy5wcm90b2NvbCArICI6IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcGFydHMudXJuICYmICh0IHx8IHBhcnRzLmhvc3RuYW1lKSkgewogICAgICAgICAgICB0ICs9ICIvLyI7CiAgICAgICAgICAgIHJlcXVpcmVBYnNvbHV0ZVBhdGggPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdCArPSBVUkkuYnVpbGRBdXRob3JpdHkocGFydHMpIHx8ICIiOwogICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0cy5wYXRoID09PSAic3RyaW5nIikgewogICAgICAgICAgICBpZiAocGFydHMucGF0aC5jaGFyQXQoMCkgIT09ICIvIiAmJiByZXF1aXJlQWJzb2x1dGVQYXRoKSB7CiAgICAgICAgICAgICAgdCArPSAiLyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdCArPSBwYXJ0cy5wYXRoOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0cy5xdWVyeSA9PT0gInN0cmluZyIgJiYgcGFydHMucXVlcnkpIHsKICAgICAgICAgICAgdCArPSAiPyIgKyBwYXJ0cy5xdWVyeTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgcGFydHMuZnJhZ21lbnQgPT09ICJzdHJpbmciICYmIHBhcnRzLmZyYWdtZW50KSB7CiAgICAgICAgICAgIHQgKz0gIiMiICsgcGFydHMuZnJhZ21lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdDsKICAgICAgICB9OwogICAgICAgIFVSSS5idWlsZEhvc3QgPSBmdW5jdGlvbihwYXJ0cykgewogICAgICAgICAgdmFyIHQgPSAiIjsKICAgICAgICAgIGlmICghcGFydHMuaG9zdG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfSBlbHNlIGlmIChVUkkuaXA2X2V4cHJlc3Npb24udGVzdChwYXJ0cy5ob3N0bmFtZSkpIHsKICAgICAgICAgICAgdCArPSAiWyIgKyBwYXJ0cy5ob3N0bmFtZSArICJdIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHQgKz0gcGFydHMuaG9zdG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFydHMucG9ydCkgewogICAgICAgICAgICB0ICs9ICI6IiArIHBhcnRzLnBvcnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdDsKICAgICAgICB9OwogICAgICAgIFVSSS5idWlsZEF1dGhvcml0eSA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICAgICAgICByZXR1cm4gVVJJLmJ1aWxkVXNlcmluZm8ocGFydHMpICsgVVJJLmJ1aWxkSG9zdChwYXJ0cyk7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRVc2VyaW5mbyA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICAgICAgICB2YXIgdCA9ICIiOwogICAgICAgICAgaWYgKHBhcnRzLnVzZXJuYW1lKSB7CiAgICAgICAgICAgIHQgKz0gVVJJLmVuY29kZShwYXJ0cy51c2VybmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFydHMucGFzc3dvcmQpIHsKICAgICAgICAgICAgdCArPSAiOiIgKyBVUkkuZW5jb2RlKHBhcnRzLnBhc3N3b3JkKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0KSB7CiAgICAgICAgICAgIHQgKz0gIkAiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRRdWVyeSA9IGZ1bmN0aW9uKGRhdGEsIGR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgZXNjYXBlUXVlcnlTcGFjZSkgewogICAgICAgICAgdmFyIHQgPSAiIjsKICAgICAgICAgIHZhciB1bmlxdWUsIGtleSwgaSwgbGVuZ3RoOwogICAgICAgICAgZm9yIChrZXkgaW4gZGF0YSkgewogICAgICAgICAgICBpZiAoa2V5ID09PSAiX19wcm90b19fIikgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhhc093bi5jYWxsKGRhdGEsIGtleSkpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheShkYXRhW2tleV0pKSB7CiAgICAgICAgICAgICAgICB1bmlxdWUgPSB7fTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IGRhdGFba2V5XS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBpZiAoZGF0YVtrZXldW2ldICE9PSB2b2lkIDAgJiYgdW5pcXVlW2RhdGFba2V5XVtpXSArICIiXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgdCArPSAiJiIgKyBVUkkuYnVpbGRRdWVyeVBhcmFtZXRlcihrZXksIGRhdGFba2V5XVtpXSwgZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgdW5pcXVlW2RhdGFba2V5XVtpXSArICIiXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhW2tleV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdCArPSAiJiIgKyBVUkkuYnVpbGRRdWVyeVBhcmFtZXRlcihrZXksIGRhdGFba2V5XSwgZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdC5zdWJzdHJpbmcoMSk7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRRdWVyeVBhcmFtZXRlciA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCBlc2NhcGVRdWVyeVNwYWNlKSB7CiAgICAgICAgICByZXR1cm4gVVJJLmVuY29kZVF1ZXJ5KG5hbWUsIGVzY2FwZVF1ZXJ5U3BhY2UpICsgKHZhbHVlICE9PSBudWxsID8gIj0iICsgVVJJLmVuY29kZVF1ZXJ5KHZhbHVlLCBlc2NhcGVRdWVyeVNwYWNlKSA6ICIiKTsKICAgICAgICB9OwogICAgICAgIFVSSS5hZGRRdWVyeSA9IGZ1bmN0aW9uKGRhdGEsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG5hbWUsIGtleSkpIHsKICAgICAgICAgICAgICAgIFVSSS5hZGRRdWVyeShkYXRhLCBrZXksIG5hbWVba2V5XSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuYW1lID09PSAic3RyaW5nIikgewogICAgICAgICAgICBpZiAoZGF0YVtuYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGF0YVtuYW1lXSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBkYXRhW25hbWVdID0gW2RhdGFbbmFtZV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IFt2YWx1ZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YVtuYW1lXSA9IChkYXRhW25hbWVdIHx8IFtdKS5jb25jYXQodmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVVJJLmFkZFF1ZXJ5KCkgYWNjZXB0cyBhbiBvYmplY3QsIHN0cmluZyBhcyB0aGUgbmFtZSBwYXJhbWV0ZXIiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFVSSS5zZXRRdWVyeSA9IGZ1bmN0aW9uKGRhdGEsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG5hbWUsIGtleSkpIHsKICAgICAgICAgICAgICAgIFVSSS5zZXRRdWVyeShkYXRhLCBrZXksIG5hbWVba2V5XSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuYW1lID09PSAic3RyaW5nIikgewogICAgICAgICAgICBkYXRhW25hbWVdID0gdmFsdWUgPT09IHZvaWQgMCA/IG51bGwgOiB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5zZXRRdWVyeSgpIGFjY2VwdHMgYW4gb2JqZWN0LCBzdHJpbmcgYXMgdGhlIG5hbWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkucmVtb3ZlUXVlcnkgPSBmdW5jdGlvbihkYXRhLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgdmFyIGksIGxlbmd0aCwga2V5OwogICAgICAgICAgaWYgKGlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbmFtZS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGRhdGFbbmFtZVtpXV0gPSB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoZ2V0VHlwZShuYW1lKSA9PT0gIlJlZ0V4cCIpIHsKICAgICAgICAgICAgZm9yIChrZXkgaW4gZGF0YSkgewogICAgICAgICAgICAgIGlmIChuYW1lLnRlc3Qoa2V5KSkgewogICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgZm9yIChrZXkgaW4gbmFtZSkgewogICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChuYW1lLCBrZXkpKSB7CiAgICAgICAgICAgICAgICBVUkkucmVtb3ZlUXVlcnkoZGF0YSwga2V5LCBuYW1lW2tleV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAoZ2V0VHlwZSh2YWx1ZSkgPT09ICJSZWdFeHAiKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoZGF0YVtuYW1lXSkgJiYgdmFsdWUudGVzdChkYXRhW25hbWVdKSkgewogICAgICAgICAgICAgICAgICBkYXRhW25hbWVdID0gdm9pZCAwOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IGZpbHRlckFycmF5VmFsdWVzKGRhdGFbbmFtZV0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGFbbmFtZV0gPT09IFN0cmluZyh2YWx1ZSkgJiYgKCFpc0FycmF5KHZhbHVlKSB8fCB2YWx1ZS5sZW5ndGggPT09IDEpKSB7CiAgICAgICAgICAgICAgICBkYXRhW25hbWVdID0gdm9pZCAwOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShkYXRhW25hbWVdKSkgewogICAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IGZpbHRlckFycmF5VmFsdWVzKGRhdGFbbmFtZV0sIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVVJJLnJlbW92ZVF1ZXJ5KCkgYWNjZXB0cyBhbiBvYmplY3QsIHN0cmluZywgUmVnRXhwIGFzIHRoZSBmaXJzdCBwYXJhbWV0ZXIiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFVSSS5oYXNRdWVyeSA9IGZ1bmN0aW9uKGRhdGEsIG5hbWUsIHZhbHVlLCB3aXRoaW5BcnJheSkgewogICAgICAgICAgc3dpdGNoIChnZXRUeXBlKG5hbWUpKSB7CiAgICAgICAgICAgIGNhc2UgIlN0cmluZyI6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIlJlZ0V4cCI6CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChkYXRhLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuYW1lLnRlc3Qoa2V5KSAmJiAodmFsdWUgPT09IHZvaWQgMCB8fCBVUkkuaGFzUXVlcnkoZGF0YSwga2V5LCB2YWx1ZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjYXNlICJPYmplY3QiOgogICAgICAgICAgICAgIGZvciAodmFyIF9rZXkgaW4gbmFtZSkgewogICAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG5hbWUsIF9rZXkpKSB7CiAgICAgICAgICAgICAgICAgIGlmICghVVJJLmhhc1F1ZXJ5KGRhdGEsIF9rZXksIG5hbWVbX2tleV0pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5oYXNRdWVyeSgpIGFjY2VwdHMgYSBzdHJpbmcsIHJlZ3VsYXIgZXhwcmVzc2lvbiBvciBvYmplY3QgYXMgdGhlIG5hbWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGdldFR5cGUodmFsdWUpKSB7CiAgICAgICAgICAgIGNhc2UgIlVuZGVmaW5lZCI6CiAgICAgICAgICAgICAgcmV0dXJuIG5hbWUgaW4gZGF0YTsKICAgICAgICAgICAgLy8gZGF0YVtuYW1lXSAhPT0gdW5kZWZpbmVkOwogICAgICAgICAgICBjYXNlICJCb29sZWFuIjoKICAgICAgICAgICAgICB2YXIgX2Jvb2x5ID0gQm9vbGVhbihpc0FycmF5KGRhdGFbbmFtZV0pID8gZGF0YVtuYW1lXS5sZW5ndGggOiBkYXRhW25hbWVdKTsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IF9ib29seTsKICAgICAgICAgICAgY2FzZSAiRnVuY3Rpb24iOgogICAgICAgICAgICAgIHJldHVybiAhIXZhbHVlKGRhdGFbbmFtZV0sIG5hbWUsIGRhdGEpOwogICAgICAgICAgICBjYXNlICJBcnJheSI6CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGRhdGFbbmFtZV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvcCA9IHdpdGhpbkFycmF5ID8gYXJyYXlDb250YWlucyA6IGFycmF5c0VxdWFsOwogICAgICAgICAgICAgIHJldHVybiBvcChkYXRhW25hbWVdLCB2YWx1ZSk7CiAgICAgICAgICAgIGNhc2UgIlJlZ0V4cCI6CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGRhdGFbbmFtZV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQm9vbGVhbihkYXRhW25hbWVdICYmIGRhdGFbbmFtZV0ubWF0Y2godmFsdWUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF3aXRoaW5BcnJheSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gYXJyYXlDb250YWlucyhkYXRhW25hbWVdLCB2YWx1ZSk7CiAgICAgICAgICAgIGNhc2UgIk51bWJlciI6CiAgICAgICAgICAgICAgdmFsdWUgPSBTdHJpbmcodmFsdWUpOwogICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIGNhc2UgIlN0cmluZyI6CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGRhdGFbbmFtZV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVtuYW1lXSA9PT0gdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghd2l0aGluQXJyYXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGFycmF5Q29udGFpbnMoZGF0YVtuYW1lXSwgdmFsdWUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5oYXNRdWVyeSgpIGFjY2VwdHMgdW5kZWZpbmVkLCBib29sZWFuLCBzdHJpbmcsIG51bWJlciwgUmVnRXhwLCBGdW5jdGlvbiBhcyB0aGUgdmFsdWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkuam9pblBhdGhzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgaW5wdXQgPSBbXTsKICAgICAgICAgIHZhciBzZWdtZW50cyA9IFtdOwogICAgICAgICAgdmFyIG5vbkVtcHR5U2VnbWVudHMgPSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHVybCA9IG5ldyBVUkkoYXJndW1lbnRzW2ldKTsKICAgICAgICAgICAgaW5wdXQucHVzaCh1cmwpOwogICAgICAgICAgICB2YXIgX3NlZ21lbnRzID0gdXJsLnNlZ21lbnQoKTsKICAgICAgICAgICAgZm9yICh2YXIgcyA9IDA7IHMgPCBfc2VnbWVudHMubGVuZ3RoOyBzKyspIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIF9zZWdtZW50c1tzXSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHNlZ21lbnRzLnB1c2goX3NlZ21lbnRzW3NdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKF9zZWdtZW50c1tzXSkgewogICAgICAgICAgICAgICAgbm9uRW1wdHlTZWdtZW50cysrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFzZWdtZW50cy5sZW5ndGggfHwgIW5vbkVtcHR5U2VnbWVudHMpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkkoIiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVyaSA9IG5ldyBVUkkoIiIpLnNlZ21lbnQoc2VnbWVudHMpOwogICAgICAgICAgaWYgKGlucHV0WzBdLnBhdGgoKSA9PT0gIiIgfHwgaW5wdXRbMF0ucGF0aCgpLnNsaWNlKDAsIDEpID09PSAiLyIpIHsKICAgICAgICAgICAgdXJpLnBhdGgoIi8iICsgdXJpLnBhdGgoKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXJpLm5vcm1hbGl6ZSgpOwogICAgICAgIH07CiAgICAgICAgVVJJLmNvbW1vblBhdGggPSBmdW5jdGlvbihvbmUsIHR3bykgewogICAgICAgICAgdmFyIGxlbmd0aCA9IE1hdGgubWluKG9uZS5sZW5ndGgsIHR3by5sZW5ndGgpOwogICAgICAgICAgdmFyIHBvczsKICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuZ3RoOyBwb3MrKykgewogICAgICAgICAgICBpZiAob25lLmNoYXJBdChwb3MpICE9PSB0d28uY2hhckF0KHBvcykpIHsKICAgICAgICAgICAgICBwb3MtLTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBvcyA8IDEpIHsKICAgICAgICAgICAgcmV0dXJuIG9uZS5jaGFyQXQoMCkgPT09IHR3by5jaGFyQXQoMCkgJiYgb25lLmNoYXJBdCgwKSA9PT0gIi8iID8gIi8iIDogIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob25lLmNoYXJBdChwb3MpICE9PSAiLyIgfHwgdHdvLmNoYXJBdChwb3MpICE9PSAiLyIpIHsKICAgICAgICAgICAgcG9zID0gb25lLnN1YnN0cmluZygwLCBwb3MpLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gb25lLnN1YnN0cmluZygwLCBwb3MgKyAxKTsKICAgICAgICB9OwogICAgICAgIFVSSS53aXRoaW5TdHJpbmcgPSBmdW5jdGlvbihzdHJpbmcsIGNhbGxiYWNrLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAgICAgdmFyIF9zdGFydCA9IG9wdGlvbnMuc3RhcnQgfHwgVVJJLmZpbmRVcmkuc3RhcnQ7CiAgICAgICAgICB2YXIgX2VuZCA9IG9wdGlvbnMuZW5kIHx8IFVSSS5maW5kVXJpLmVuZDsKICAgICAgICAgIHZhciBfdHJpbSA9IG9wdGlvbnMudHJpbSB8fCBVUkkuZmluZFVyaS50cmltOwogICAgICAgICAgdmFyIF9wYXJlbnMgPSBvcHRpb25zLnBhcmVucyB8fCBVUkkuZmluZFVyaS5wYXJlbnM7CiAgICAgICAgICB2YXIgX2F0dHJpYnV0ZU9wZW4gPSAvW2EtejAtOS1dPVsiJ10/JC9pOwogICAgICAgICAgX3N0YXJ0Lmxhc3RJbmRleCA9IDA7CiAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBfc3RhcnQuZXhlYyhzdHJpbmcpOwogICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN0YXJ0ID0gbWF0Y2guaW5kZXg7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZUh0bWwpIHsKICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlT3BlbiA9IHN0cmluZy5zbGljZShNYXRoLm1heChzdGFydCAtIDMsIDApLCBzdGFydCk7CiAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU9wZW4gJiYgX2F0dHJpYnV0ZU9wZW4udGVzdChhdHRyaWJ1dGVPcGVuKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSBzdGFydCArIHN0cmluZy5zbGljZShzdGFydCkuc2VhcmNoKF9lbmQpOwogICAgICAgICAgICB2YXIgc2xpY2UgPSBzdHJpbmcuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgICAgICAgIHZhciBwYXJlbnNFbmQgPSAtMTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICB2YXIgcGFyZW5zTWF0Y2ggPSBfcGFyZW5zLmV4ZWMoc2xpY2UpOwogICAgICAgICAgICAgIGlmICghcGFyZW5zTWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcGFyZW5zTWF0Y2hFbmQgPSBwYXJlbnNNYXRjaC5pbmRleCArIHBhcmVuc01hdGNoWzBdLmxlbmd0aDsKICAgICAgICAgICAgICBwYXJlbnNFbmQgPSBNYXRoLm1heChwYXJlbnNFbmQsIHBhcmVuc01hdGNoRW5kKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyZW5zRW5kID4gLTEpIHsKICAgICAgICAgICAgICBzbGljZSA9IHNsaWNlLnNsaWNlKDAsIHBhcmVuc0VuZCkgKyBzbGljZS5zbGljZShwYXJlbnNFbmQpLnJlcGxhY2UoX3RyaW0sICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzbGljZSA9IHNsaWNlLnJlcGxhY2UoX3RyaW0sICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2xpY2UubGVuZ3RoIDw9IG1hdGNoWzBdLmxlbmd0aCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZSAmJiBvcHRpb25zLmlnbm9yZS50ZXN0KHNsaWNlKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0ICsgc2xpY2UubGVuZ3RoOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbGJhY2soc2xpY2UsIHN0YXJ0LCBlbmQsIHN0cmluZyk7CiAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIF9zdGFydC5sYXN0SW5kZXggPSBlbmQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gU3RyaW5nKHJlc3VsdCk7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zbGljZSgwLCBzdGFydCkgKyByZXN1bHQgKyBzdHJpbmcuc2xpY2UoZW5kKTsKICAgICAgICAgICAgX3N0YXJ0Lmxhc3RJbmRleCA9IHN0YXJ0ICsgcmVzdWx0Lmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIF9zdGFydC5sYXN0SW5kZXggPSAwOwogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9OwogICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lID0gZnVuY3Rpb24odjMsIHByb3RvY29sKSB7CiAgICAgICAgICB2YXIgaGFzSG9zdG5hbWUgPSAhIXYzOwogICAgICAgICAgdmFyIGhhc1Byb3RvY29sID0gISFwcm90b2NvbDsKICAgICAgICAgIHZhciByZWplY3RFbXB0eUhvc3RuYW1lID0gZmFsc2U7CiAgICAgICAgICBpZiAoaGFzUHJvdG9jb2wpIHsKICAgICAgICAgICAgcmVqZWN0RW1wdHlIb3N0bmFtZSA9IGFycmF5Q29udGFpbnMoVVJJLmhvc3RQcm90b2NvbHMsIHByb3RvY29sKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWplY3RFbXB0eUhvc3RuYW1lICYmICFoYXNIb3N0bmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJIb3N0bmFtZSBjYW5ub3QgYmUgZW1wdHksIGlmIHByb3RvY29sIGlzICIgKyBwcm90b2NvbCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHYzICYmIHYzLm1hdGNoKFVSSS5pbnZhbGlkX2hvc3RuYW1lX2NoYXJhY3RlcnMpKSB7CiAgICAgICAgICAgIGlmICghcHVueWNvZGUpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdIb3N0bmFtZSAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTkuLTpfXSBhbmQgUHVueWNvZGUuanMgaXMgbm90IGF2YWlsYWJsZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwdW55Y29kZS50b0FTQ0lJKHYzKS5tYXRjaChVUkkuaW52YWxpZF9ob3N0bmFtZV9jaGFyYWN0ZXJzKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0hvc3RuYW1lICInICsgdjMgKyAnIiBjb250YWlucyBjaGFyYWN0ZXJzIG90aGVyIHRoYW4gW0EtWjAtOS4tOl9dJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFVSSS5lbnN1cmVWYWxpZFBvcnQgPSBmdW5jdGlvbih2MykgewogICAgICAgICAgaWYgKCF2MykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcG9ydCA9IE51bWJlcih2Myk7CiAgICAgICAgICBpZiAoaXNJbnRlZ2VyKHBvcnQpICYmIHBvcnQgPiAwICYmIHBvcnQgPCA2NTUzNikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdQb3J0ICInICsgdjMgKyAnIiBpcyBub3QgYSB2YWxpZCBwb3J0Jyk7CiAgICAgICAgfTsKICAgICAgICBVUkkubm9Db25mbGljdCA9IGZ1bmN0aW9uKHJlbW92ZUFsbCkgewogICAgICAgICAgaWYgKHJlbW92ZUFsbCkgewogICAgICAgICAgICB2YXIgdW5jb25mbGljdGVkID0gewogICAgICAgICAgICAgIFVSSTogdGhpcy5ub0NvbmZsaWN0KCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHJvb3QuVVJJVGVtcGxhdGUgJiYgdHlwZW9mIHJvb3QuVVJJVGVtcGxhdGUubm9Db25mbGljdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHVuY29uZmxpY3RlZC5VUklUZW1wbGF0ZSA9IHJvb3QuVVJJVGVtcGxhdGUubm9Db25mbGljdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290LklQdjYgJiYgdHlwZW9mIHJvb3QuSVB2Ni5ub0NvbmZsaWN0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdW5jb25mbGljdGVkLklQdjYgPSByb290LklQdjYubm9Db25mbGljdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290LlNlY29uZExldmVsRG9tYWlucyAmJiB0eXBlb2Ygcm9vdC5TZWNvbmRMZXZlbERvbWFpbnMubm9Db25mbGljdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHVuY29uZmxpY3RlZC5TZWNvbmRMZXZlbERvbWFpbnMgPSByb290LlNlY29uZExldmVsRG9tYWlucy5ub0NvbmZsaWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVuY29uZmxpY3RlZDsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdC5VUkkgPT09IHRoaXMpIHsKICAgICAgICAgICAgcm9vdC5VUkkgPSBfVVJJOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLmJ1aWxkID0gZnVuY3Rpb24oZGVmZXJCdWlsZCkgewogICAgICAgICAgaWYgKGRlZmVyQnVpbGQgPT09IHRydWUpIHsKICAgICAgICAgICAgdGhpcy5fZGVmZXJyZWRfYnVpbGQgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChkZWZlckJ1aWxkID09PSB2b2lkIDAgfHwgdGhpcy5fZGVmZXJyZWRfYnVpbGQpIHsKICAgICAgICAgICAgdGhpcy5fc3RyaW5nID0gVVJJLmJ1aWxkKHRoaXMuX3BhcnRzKTsKICAgICAgICAgICAgdGhpcy5fZGVmZXJyZWRfYnVpbGQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5jbG9uZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIG5ldyBVUkkodGhpcyk7CiAgICAgICAgfTsKICAgICAgICBwLnZhbHVlT2YgPSBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5idWlsZChmYWxzZSkuX3N0cmluZzsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoX3BhcnQyKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzW19wYXJ0Ml0gfHwgIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHNbX3BhcnQyXSA9IHYzIHx8IG51bGw7CiAgICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZW5lcmF0ZVByZWZpeEFjY2Vzc29yKF9wYXJ0MiwgX2tleSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0c1tfcGFydDJdIHx8ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh2MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdjMgPSB2MyArICIiOwogICAgICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gX2tleSkgewogICAgICAgICAgICAgICAgICB2MyA9IHYzLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fcGFydHNbX3BhcnQyXSA9IHYzOwogICAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcC5wcm90b2NvbCA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoInByb3RvY29sIik7CiAgICAgICAgcC51c2VybmFtZSA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoInVzZXJuYW1lIik7CiAgICAgICAgcC5wYXNzd29yZCA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoInBhc3N3b3JkIik7CiAgICAgICAgcC5ob3N0bmFtZSA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoImhvc3RuYW1lIik7CiAgICAgICAgcC5wb3J0ID0gZ2VuZXJhdGVTaW1wbGVBY2Nlc3NvcigicG9ydCIpOwogICAgICAgIHAucXVlcnkgPSBnZW5lcmF0ZVByZWZpeEFjY2Vzc29yKCJxdWVyeSIsICI/Iik7CiAgICAgICAgcC5mcmFnbWVudCA9IGdlbmVyYXRlUHJlZml4QWNjZXNzb3IoImZyYWdtZW50IiwgIiMiKTsKICAgICAgICBwLnNlYXJjaCA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgdmFyIHQgPSB0aGlzLnF1ZXJ5KHYzLCBidWlsZCk7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIHQgPT09ICJzdHJpbmciICYmIHQubGVuZ3RoID8gIj8iICsgdCA6IHQ7CiAgICAgICAgfTsKICAgICAgICBwLmhhc2ggPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIHZhciB0ID0gdGhpcy5mcmFnbWVudCh2MywgYnVpbGQpOwogICAgICAgICAgcmV0dXJuIHR5cGVvZiB0ID09PSAic3RyaW5nIiAmJiB0Lmxlbmd0aCA/ICIjIiArIHQgOiB0OwogICAgICAgIH07CiAgICAgICAgcC5wYXRobmFtZSA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDAgfHwgdjMgPT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHJlcyA9IHRoaXMuX3BhcnRzLnBhdGggfHwgKHRoaXMuX3BhcnRzLmhvc3RuYW1lID8gIi8iIDogIiIpOwogICAgICAgICAgICByZXR1cm4gdjMgPyAodGhpcy5fcGFydHMudXJuID8gVVJJLmRlY29kZVVyblBhdGggOiBVUkkuZGVjb2RlUGF0aCkocmVzKSA6IHJlczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gdjMgPyBVUkkucmVjb2RlVXJuUGF0aCh2MykgOiAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gdjMgPyBVUkkucmVjb2RlUGF0aCh2MykgOiAiLyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAucGF0aCA9IHAucGF0aG5hbWU7CiAgICAgICAgcC5ocmVmID0gZnVuY3Rpb24oaHJlZiwgYnVpbGQpIHsKICAgICAgICAgIHZhciBrZXk7CiAgICAgICAgICBpZiAoaHJlZiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRvU3RyaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9zdHJpbmcgPSAiIjsKICAgICAgICAgIHRoaXMuX3BhcnRzID0gVVJJLl9wYXJ0cygpOwogICAgICAgICAgdmFyIF9VUkkyID0gaHJlZiBpbnN0YW5jZW9mIFVSSTsKICAgICAgICAgIHZhciBfb2JqZWN0ID0gdHlwZW9mIGhyZWYgPT09ICJvYmplY3QiICYmIChocmVmLmhvc3RuYW1lIHx8IGhyZWYucGF0aCB8fCBocmVmLnBhdGhuYW1lKTsKICAgICAgICAgIGlmIChocmVmLm5vZGVOYW1lKSB7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGUgPSBVUkkuZ2V0RG9tQXR0cmlidXRlKGhyZWYpOwogICAgICAgICAgICBocmVmID0gaHJlZlthdHRyaWJ1dGVdIHx8ICIiOwogICAgICAgICAgICBfb2JqZWN0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIV9VUkkyICYmIF9vYmplY3QgJiYgaHJlZi5wYXRobmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGhyZWYgPSBocmVmLnRvU3RyaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGhyZWYgPT09ICJzdHJpbmciIHx8IGhyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMgPSBVUkkucGFyc2UoU3RyaW5nKGhyZWYpLCB0aGlzLl9wYXJ0cyk7CiAgICAgICAgICB9IGVsc2UgaWYgKF9VUkkyIHx8IF9vYmplY3QpIHsKICAgICAgICAgICAgdmFyIHNyYyA9IF9VUkkyID8gaHJlZi5fcGFydHMgOiBocmVmOwogICAgICAgICAgICBmb3IgKGtleSBpbiBzcmMpIHsKICAgICAgICAgICAgICBpZiAoa2V5ID09PSAicXVlcnkiKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHRoaXMuX3BhcnRzLCBrZXkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0c1trZXldID0gc3JjW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzcmMucXVlcnkpIHsKICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHNyYy5xdWVyeSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJpbnZhbGlkIGlucHV0Iik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuaXMgPSBmdW5jdGlvbih3aGF0KSB7CiAgICAgICAgICB2YXIgaXAgPSBmYWxzZTsKICAgICAgICAgIHZhciBpcDQgPSBmYWxzZTsKICAgICAgICAgIHZhciBpcDYgPSBmYWxzZTsKICAgICAgICAgIHZhciBuYW1lID0gZmFsc2U7CiAgICAgICAgICB2YXIgc2xkID0gZmFsc2U7CiAgICAgICAgICB2YXIgaWRuID0gZmFsc2U7CiAgICAgICAgICB2YXIgcHVueWNvZGUyID0gZmFsc2U7CiAgICAgICAgICB2YXIgcmVsYXRpdmUgPSAhdGhpcy5fcGFydHMudXJuOwogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIHJlbGF0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlwNCA9IFVSSS5pcDRfZXhwcmVzc2lvbi50ZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgICAgaXA2ID0gVVJJLmlwNl9leHByZXNzaW9uLnRlc3QodGhpcy5fcGFydHMuaG9zdG5hbWUpOwogICAgICAgICAgICBpcCA9IGlwNCB8fCBpcDY7CiAgICAgICAgICAgIG5hbWUgPSAhaXA7CiAgICAgICAgICAgIHNsZCA9IG5hbWUgJiYgU0xEICYmIFNMRC5oYXModGhpcy5fcGFydHMuaG9zdG5hbWUpOwogICAgICAgICAgICBpZG4gPSBuYW1lICYmIFVSSS5pZG5fZXhwcmVzc2lvbi50ZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgICAgcHVueWNvZGUyID0gbmFtZSAmJiBVUkkucHVueWNvZGVfZXhwcmVzc2lvbi50ZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAod2hhdC50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgIGNhc2UgInJlbGF0aXZlIjoKICAgICAgICAgICAgICByZXR1cm4gcmVsYXRpdmU7CiAgICAgICAgICAgIGNhc2UgImFic29sdXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIXJlbGF0aXZlOwogICAgICAgICAgICAvLyBob3N0bmFtZSBpZGVudGlmaWNhdGlvbgogICAgICAgICAgICBjYXNlICJkb21haW4iOgogICAgICAgICAgICBjYXNlICJuYW1lIjoKICAgICAgICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgICAgICAgY2FzZSAic2xkIjoKICAgICAgICAgICAgICByZXR1cm4gc2xkOwogICAgICAgICAgICBjYXNlICJpcCI6CiAgICAgICAgICAgICAgcmV0dXJuIGlwOwogICAgICAgICAgICBjYXNlICJpcDQiOgogICAgICAgICAgICBjYXNlICJpcHY0IjoKICAgICAgICAgICAgY2FzZSAiaW5ldDQiOgogICAgICAgICAgICAgIHJldHVybiBpcDQ7CiAgICAgICAgICAgIGNhc2UgImlwNiI6CiAgICAgICAgICAgIGNhc2UgImlwdjYiOgogICAgICAgICAgICBjYXNlICJpbmV0NiI6CiAgICAgICAgICAgICAgcmV0dXJuIGlwNjsKICAgICAgICAgICAgY2FzZSAiaWRuIjoKICAgICAgICAgICAgICByZXR1cm4gaWRuOwogICAgICAgICAgICBjYXNlICJ1cmwiOgogICAgICAgICAgICAgIHJldHVybiAhdGhpcy5fcGFydHMudXJuOwogICAgICAgICAgICBjYXNlICJ1cm4iOgogICAgICAgICAgICAgIHJldHVybiAhIXRoaXMuX3BhcnRzLnVybjsKICAgICAgICAgICAgY2FzZSAicHVueWNvZGUiOgogICAgICAgICAgICAgIHJldHVybiBwdW55Y29kZTI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIHZhciBfcHJvdG9jb2wgPSBwLnByb3RvY29sOwogICAgICAgIHZhciBfcG9ydCA9IHAucG9ydDsKICAgICAgICB2YXIgX2hvc3RuYW1lID0gcC5ob3N0bmFtZTsKICAgICAgICBwLnByb3RvY29sID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodjMpIHsKICAgICAgICAgICAgdjMgPSB2My5yZXBsYWNlKC86KFwvXC8pPyQvLCAiIik7CiAgICAgICAgICAgIGlmICghdjMubWF0Y2goVVJJLnByb3RvY29sX2V4cHJlc3Npb24pKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUHJvdG9jb2wgIicgKyB2MyArIGAiIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05ListXSBvciBkb2Vzbid0IHN0YXJ0IHdpdGggW0EtWl1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIF9wcm90b2NvbC5jYWxsKHRoaXMsIHYzLCBidWlsZCk7CiAgICAgICAgfTsKICAgICAgICBwLnNjaGVtZSA9IHAucHJvdG9jb2w7CiAgICAgICAgcC5wb3J0ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHYzID09PSAwKSB7CiAgICAgICAgICAgICAgdjMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2MykgewogICAgICAgICAgICAgIHYzICs9ICIiOwogICAgICAgICAgICAgIGlmICh2My5jaGFyQXQoMCkgPT09ICI6IikgewogICAgICAgICAgICAgICAgdjMgPSB2My5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZFBvcnQodjMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gX3BvcnQuY2FsbCh0aGlzLCB2MywgYnVpbGQpOwogICAgICAgIH07CiAgICAgICAgcC5ob3N0bmFtZSA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciB4ID0geyBwcmV2ZW50SW52YWxpZEhvc3RuYW1lOiB0aGlzLl9wYXJ0cy5wcmV2ZW50SW52YWxpZEhvc3RuYW1lIH07CiAgICAgICAgICAgIHZhciByZXMgPSBVUkkucGFyc2VIb3N0KHYzLCB4KTsKICAgICAgICAgICAgaWYgKHJlcyAhPT0gIi8iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSG9zdG5hbWUgIicgKyB2MyArICciIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05Li1dJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdjMgPSB4Lmhvc3RuYW1lOwogICAgICAgICAgICBpZiAodGhpcy5fcGFydHMucHJldmVudEludmFsaWRIb3N0bmFtZSkgewogICAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lKHYzLCB0aGlzLl9wYXJ0cy5wcm90b2NvbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBfaG9zdG5hbWUuY2FsbCh0aGlzLCB2MywgYnVpbGQpOwogICAgICAgIH07CiAgICAgICAgcC5vcmlnaW4gPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB0aGlzLnByb3RvY29sKCk7CiAgICAgICAgICAgIHZhciBhdXRob3JpdHkgPSB0aGlzLmF1dGhvcml0eSgpOwogICAgICAgICAgICBpZiAoIWF1dGhvcml0eSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHByb3RvY29sID8gcHJvdG9jb2wgKyAiOi8vIiA6ICIiKSArIHRoaXMuYXV0aG9yaXR5KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgb3JpZ2luID0gVVJJKHYzKTsKICAgICAgICAgICAgdGhpcy5wcm90b2NvbChvcmlnaW4ucHJvdG9jb2woKSkuYXV0aG9yaXR5KG9yaWdpbi5hdXRob3JpdHkoKSkuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmhvc3QgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFydHMuaG9zdG5hbWUgPyBVUkkuYnVpbGRIb3N0KHRoaXMuX3BhcnRzKSA6ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcyA9IFVSSS5wYXJzZUhvc3QodjMsIHRoaXMuX3BhcnRzKTsKICAgICAgICAgICAgaWYgKHJlcyAhPT0gIi8iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSG9zdG5hbWUgIicgKyB2MyArICciIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05Li1dJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAuYXV0aG9yaXR5ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzLmhvc3RuYW1lID8gVVJJLmJ1aWxkQXV0aG9yaXR5KHRoaXMuX3BhcnRzKSA6ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcyA9IFVSSS5wYXJzZUF1dGhvcml0eSh2MywgdGhpcy5fcGFydHMpOwogICAgICAgICAgICBpZiAocmVzICE9PSAiLyIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdIb3N0bmFtZSAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTkuLV0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC51c2VyaW5mbyA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciB0ID0gVVJJLmJ1aWxkVXNlcmluZm8odGhpcy5fcGFydHMpOwogICAgICAgICAgICByZXR1cm4gdCA/IHQuc3Vic3RyaW5nKDAsIHQubGVuZ3RoIC0gMSkgOiB0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHYzW3YzLmxlbmd0aCAtIDFdICE9PSAiQCIpIHsKICAgICAgICAgICAgICB2MyArPSAiQCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgVVJJLnBhcnNlVXNlcmluZm8odjMsIHRoaXMuX3BhcnRzKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAucmVzb3VyY2UgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIHZhciBwYXJ0czsKICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhdGgoKSArIHRoaXMuc2VhcmNoKCkgKyB0aGlzLmhhc2goKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnRzID0gVVJJLnBhcnNlKHYzKTsKICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSBwYXJ0cy5wYXRoOwogICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBwYXJ0cy5xdWVyeTsKICAgICAgICAgIHRoaXMuX3BhcnRzLmZyYWdtZW50ID0gcGFydHMuZnJhZ21lbnQ7CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuc3ViZG9tYWluID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9wYXJ0cy5ob3N0bmFtZSB8fCB0aGlzLmlzKCJJUCIpKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5sZW5ndGggLSB0aGlzLmRvbWFpbigpLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcoMCwgZW5kKSB8fCAiIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBlID0gdGhpcy5fcGFydHMuaG9zdG5hbWUubGVuZ3RoIC0gdGhpcy5kb21haW4oKS5sZW5ndGg7CiAgICAgICAgICAgIHZhciBzdWIgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcoMCwgZSk7CiAgICAgICAgICAgIHZhciByZXBsYWNlID0gbmV3IFJlZ0V4cCgiXiIgKyBlc2NhcGVSZWdFeChzdWIpKTsKICAgICAgICAgICAgaWYgKHYzICYmIHYzLmNoYXJBdCh2My5sZW5ndGggLSAxKSAhPT0gIi4iKSB7CiAgICAgICAgICAgICAgdjMgKz0gIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2My5pbmRleE9mKCI6IikgIT09IC0xKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiRG9tYWlucyBjYW5ub3QgY29udGFpbiBjb2xvbnMiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodjMpIHsKICAgICAgICAgICAgICBVUkkuZW5zdXJlVmFsaWRIb3N0bmFtZSh2MywgdGhpcy5fcGFydHMucHJvdG9jb2wpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gdGhpcy5fcGFydHMuaG9zdG5hbWUucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmRvbWFpbiA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdjMgPT09ICJib29sZWFuIikgewogICAgICAgICAgICBidWlsZCA9IHYzOwogICAgICAgICAgICB2MyA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMuaG9zdG5hbWUgfHwgdGhpcy5pcygiSVAiKSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdCA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLm1hdGNoKC9cLi9nKTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzLmhvc3RuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5sZW5ndGggLSB0aGlzLnRsZChidWlsZCkubGVuZ3RoIC0gMTsKICAgICAgICAgICAgZW5kID0gdGhpcy5fcGFydHMuaG9zdG5hbWUubGFzdEluZGV4T2YoIi4iLCBlbmQgLSAxKSArIDE7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcoZW5kKSB8fCAiIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJjYW5ub3Qgc2V0IGRvbWFpbiBlbXB0eSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2My5pbmRleE9mKCI6IikgIT09IC0xKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiRG9tYWlucyBjYW5ub3QgY29udGFpbiBjb2xvbnMiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBVUkkuZW5zdXJlVmFsaWRIb3N0bmFtZSh2MywgdGhpcy5fcGFydHMucHJvdG9jb2wpOwogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLmhvc3RuYW1lIHx8IHRoaXMuaXMoIklQIikpIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA9IHYzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeCh0aGlzLmRvbWFpbigpKSArICIkIik7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC50bGQgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHYzID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgYnVpbGQgPSB2MzsKICAgICAgICAgICAgdjMgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLmhvc3RuYW1lIHx8IHRoaXMuaXMoIklQIikpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBvcyA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLmxhc3RJbmRleE9mKCIuIik7CiAgICAgICAgICAgIHZhciB0bGQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcocG9zICsgMSk7CiAgICAgICAgICAgIGlmIChidWlsZCAhPT0gdHJ1ZSAmJiBTTEQgJiYgU0xELmxpc3RbdGxkLnRvTG93ZXJDYXNlKCldKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFNMRC5nZXQodGhpcy5fcGFydHMuaG9zdG5hbWUpIHx8IHRsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGxkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcGxhY2U7CiAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJjYW5ub3Qgc2V0IFRMRCBlbXB0eSIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHYzLm1hdGNoKC9bXmEtekEtWjAtOS1dLykpIHsKICAgICAgICAgICAgICBpZiAoU0xEICYmIFNMRC5pcyh2MykpIHsKICAgICAgICAgICAgICAgIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KHRoaXMudGxkKCkpICsgIiQiKTsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gdGhpcy5fcGFydHMuaG9zdG5hbWUucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RMRCAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTldJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9wYXJ0cy5ob3N0bmFtZSB8fCB0aGlzLmlzKCJJUCIpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJjYW5ub3Qgc2V0IFRMRCBvbiBub24tZG9tYWluIGhvc3QiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeCh0aGlzLnRsZCgpKSArICIkIik7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC5kaXJlY3RvcnkgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCB8fCB2MyA9PT0gdHJ1ZSkgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLnBhdGggJiYgIXRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5wYXRoID09PSAiLyIpIHsKICAgICAgICAgICAgICByZXR1cm4gIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl9wYXJ0cy5wYXRoLmxlbmd0aCAtIHRoaXMuZmlsZW5hbWUoKS5sZW5ndGggLSAxOwogICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5fcGFydHMucGF0aC5zdWJzdHJpbmcoMCwgZW5kKSB8fCAodGhpcy5fcGFydHMuaG9zdG5hbWUgPyAiLyIgOiAiIik7CiAgICAgICAgICAgIHJldHVybiB2MyA/IFVSSS5kZWNvZGVQYXRoKHJlcykgOiByZXM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZSA9IHRoaXMuX3BhcnRzLnBhdGgubGVuZ3RoIC0gdGhpcy5maWxlbmFtZSgpLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGRpcmVjdG9yeSA9IHRoaXMuX3BhcnRzLnBhdGguc3Vic3RyaW5nKDAsIGUpOwogICAgICAgICAgICB2YXIgcmVwbGFjZSA9IG5ldyBSZWdFeHAoIl4iICsgZXNjYXBlUmVnRXgoZGlyZWN0b3J5KSk7CiAgICAgICAgICAgIGlmICghdGhpcy5pcygicmVsYXRpdmUiKSkgewogICAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICAgIHYzID0gIi8iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodjMuY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgICAgIHYzID0gIi8iICsgdjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2MyAmJiB2My5jaGFyQXQodjMubGVuZ3RoIC0gMSkgIT09ICIvIikgewogICAgICAgICAgICAgIHYzICs9ICIvIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2MyA9IFVSSS5yZWNvZGVQYXRoKHYzKTsKICAgICAgICAgICAgdGhpcy5fcGFydHMucGF0aCA9IHRoaXMuX3BhcnRzLnBhdGgucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmZpbGVuYW1lID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB2MyAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9wYXJ0cy5wYXRoIHx8IHRoaXMuX3BhcnRzLnBhdGggPT09ICIvIikgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcG9zID0gdGhpcy5fcGFydHMucGF0aC5sYXN0SW5kZXhPZigiLyIpOwogICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5fcGFydHMucGF0aC5zdWJzdHJpbmcocG9zICsgMSk7CiAgICAgICAgICAgIHJldHVybiB2MyA/IFVSSS5kZWNvZGVQYXRoU2VnbWVudChyZXMpIDogcmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG11dGF0ZWREaXJlY3RvcnkgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgdjMgPSB2My5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHYzLm1hdGNoKC9cLj9cLy8pKSB7CiAgICAgICAgICAgICAgbXV0YXRlZERpcmVjdG9yeSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KHRoaXMuZmlsZW5hbWUoKSkgKyAiJCIpOwogICAgICAgICAgICB2MyA9IFVSSS5yZWNvZGVQYXRoKHYzKTsKICAgICAgICAgICAgdGhpcy5fcGFydHMucGF0aCA9IHRoaXMuX3BhcnRzLnBhdGgucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIGlmIChtdXRhdGVkRGlyZWN0b3J5KSB7CiAgICAgICAgICAgICAgdGhpcy5ub3JtYWxpemVQYXRoKGJ1aWxkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnN1ZmZpeCA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwIHx8IHYzID09PSB0cnVlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMucGF0aCB8fCB0aGlzLl9wYXJ0cy5wYXRoID09PSAiLyIpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gdGhpcy5maWxlbmFtZSgpOwogICAgICAgICAgICB2YXIgcG9zID0gZmlsZW5hbWUubGFzdEluZGV4T2YoIi4iKTsKICAgICAgICAgICAgdmFyIHMsIHJlczsKICAgICAgICAgICAgaWYgKHBvcyA9PT0gLTEpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcyA9IGZpbGVuYW1lLnN1YnN0cmluZyhwb3MgKyAxKTsKICAgICAgICAgICAgcmVzID0gL15bYS16MC05JV0rJC9pLnRlc3QocykgPyBzIDogIiI7CiAgICAgICAgICAgIHJldHVybiB2MyA/IFVSSS5kZWNvZGVQYXRoU2VnbWVudChyZXMpIDogcmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gIi4iKSB7CiAgICAgICAgICAgICAgdjMgPSB2My5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN1ZmZpeCA9IHRoaXMuc3VmZml4KCk7CiAgICAgICAgICAgIHZhciByZXBsYWNlOwogICAgICAgICAgICBpZiAoIXN1ZmZpeCkgewogICAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoICs9ICIuIiArIFVSSS5yZWNvZGVQYXRoKHYzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghdjMpIHsKICAgICAgICAgICAgICByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeCgiLiIgKyBzdWZmaXgpICsgIiQiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeChzdWZmaXgpICsgIiQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgIHYzID0gVVJJLnJlY29kZVBhdGgodjMpOwogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSB0aGlzLl9wYXJ0cy5wYXRoLnJlcGxhY2UocmVwbGFjZSwgdjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnNlZ21lbnQgPSBmdW5jdGlvbihzZWdtZW50LCB2MywgYnVpbGQpIHsKICAgICAgICAgIHZhciBzZXBhcmF0b3IgPSB0aGlzLl9wYXJ0cy51cm4gPyAiOiIgOiAiLyI7CiAgICAgICAgICB2YXIgcGF0aCA9IHRoaXMucGF0aCgpOwogICAgICAgICAgdmFyIGFic29sdXRlID0gcGF0aC5zdWJzdHJpbmcoMCwgMSkgPT09ICIvIjsKICAgICAgICAgIHZhciBzZWdtZW50cyA9IHBhdGguc3BsaXQoc2VwYXJhdG9yKTsKICAgICAgICAgIGlmIChzZWdtZW50ICE9PSB2b2lkIDAgJiYgdHlwZW9mIHNlZ21lbnQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdjM7CiAgICAgICAgICAgIHYzID0gc2VnbWVudDsKICAgICAgICAgICAgc2VnbWVudCA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzZWdtZW50ICE9PSB2b2lkIDAgJiYgdHlwZW9mIHNlZ21lbnQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQmFkIHNlZ21lbnQgIicgKyBzZWdtZW50ICsgJyIsIG11c3QgYmUgMC1iYXNlZCBpbnRlZ2VyJyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYWJzb2x1dGUpIHsKICAgICAgICAgICAgc2VnbWVudHMuc2hpZnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzZWdtZW50IDwgMCkgewogICAgICAgICAgICBzZWdtZW50ID0gTWF0aC5tYXgoc2VnbWVudHMubGVuZ3RoICsgc2VnbWVudCwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gc2VnbWVudCA9PT0gdm9pZCAwID8gc2VnbWVudHMgOiBzZWdtZW50c1tzZWdtZW50XTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VnbWVudCA9PT0gbnVsbCB8fCBzZWdtZW50c1tzZWdtZW50XSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChpc0FycmF5KHYzKSkgewogICAgICAgICAgICAgIHNlZ21lbnRzID0gW107CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2My5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICghdjNbaV0ubGVuZ3RoICYmICghc2VnbWVudHMubGVuZ3RoIHx8ICFzZWdtZW50c1tzZWdtZW50cy5sZW5ndGggLSAxXS5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzLmxlbmd0aCAmJiAhc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHNlZ21lbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaCh0cmltU2xhc2hlcyh2M1tpXSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh2MyB8fCB0eXBlb2YgdjMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdjMgPSB0cmltU2xhc2hlcyh2Myk7CiAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdID09PSAiIikgewogICAgICAgICAgICAgICAgc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0gPSB2MzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaCh2Myk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodjMpIHsKICAgICAgICAgICAgICBzZWdtZW50c1tzZWdtZW50XSA9IHRyaW1TbGFzaGVzKHYzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWdtZW50cy5zcGxpY2Uoc2VnbWVudCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChhYnNvbHV0ZSkgewogICAgICAgICAgICBzZWdtZW50cy51bnNoaWZ0KCIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLnBhdGgoc2VnbWVudHMuam9pbihzZXBhcmF0b3IpLCBidWlsZCk7CiAgICAgICAgfTsKICAgICAgICBwLnNlZ21lbnRDb2RlZCA9IGZ1bmN0aW9uKHNlZ21lbnQsIHYzLCBidWlsZCkgewogICAgICAgICAgdmFyIHNlZ21lbnRzLCBpLCBsOwogICAgICAgICAgaWYgKHR5cGVvZiBzZWdtZW50ICE9PSAibnVtYmVyIikgewogICAgICAgICAgICBidWlsZCA9IHYzOwogICAgICAgICAgICB2MyA9IHNlZ21lbnQ7CiAgICAgICAgICAgIHNlZ21lbnQgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICBzZWdtZW50cyA9IHRoaXMuc2VnbWVudChzZWdtZW50LCB2MywgYnVpbGQpOwogICAgICAgICAgICBpZiAoIWlzQXJyYXkoc2VnbWVudHMpKSB7CiAgICAgICAgICAgICAgc2VnbWVudHMgPSBzZWdtZW50cyAhPT0gdm9pZCAwID8gVVJJLmRlY29kZShzZWdtZW50cykgOiB2b2lkIDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHNlZ21lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgc2VnbWVudHNbaV0gPSBVUkkuZGVjb2RlKHNlZ21lbnRzW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlZ21lbnRzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0FycmF5KHYzKSkgewogICAgICAgICAgICB2MyA9IHR5cGVvZiB2MyA9PT0gInN0cmluZyIgfHwgdjMgaW5zdGFuY2VvZiBTdHJpbmcgPyBVUkkuZW5jb2RlKHYzKSA6IHYzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHYzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgIHYzW2ldID0gVVJJLmVuY29kZSh2M1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLnNlZ21lbnQoc2VnbWVudCwgdjMsIGJ1aWxkKTsKICAgICAgICB9OwogICAgICAgIHZhciBxID0gcC5xdWVyeTsKICAgICAgICBwLnF1ZXJ5ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodjMgPT09IHRydWUpIHsKICAgICAgICAgICAgcmV0dXJuIFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHYzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gdjMuY2FsbCh0aGlzLCBkYXRhKTsKICAgICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBVUkkuYnVpbGRRdWVyeShyZXN1bHQgfHwgZGF0YSwgdGhpcy5fcGFydHMuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzLCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0gZWxzZSBpZiAodjMgIT09IHZvaWQgMCAmJiB0eXBlb2YgdjMgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLnF1ZXJ5ID0gVVJJLmJ1aWxkUXVlcnkodjMsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcS5jYWxsKHRoaXMsIHYzLCBidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnNldFF1ZXJ5ID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIGJ1aWxkKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgfHwgbmFtZSBpbnN0YW5jZW9mIFN0cmluZykgewogICAgICAgICAgICBkYXRhW25hbWVdID0gdmFsdWUgIT09IHZvaWQgMCA/IHZhbHVlIDogbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG5hbWUsIGtleSkpIHsKICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IG5hbWVba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5hZGRRdWVyeSgpIGFjY2VwdHMgYW4gb2JqZWN0LCBzdHJpbmcgYXMgdGhlIG5hbWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9wYXJ0cy5xdWVyeSA9IFVSSS5idWlsZFF1ZXJ5KGRhdGEsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuYWRkUXVlcnkgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgYnVpbGQpIHsKICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgVVJJLmFkZFF1ZXJ5KGRhdGEsIG5hbWUsIHZhbHVlID09PSB2b2lkIDAgPyBudWxsIDogdmFsdWUpOwogICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBVUkkuYnVpbGRRdWVyeShkYXRhLCB0aGlzLl9wYXJ0cy5kdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMsIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgaWYgKHR5cGVvZiBuYW1lICE9PSAic3RyaW5nIikgewogICAgICAgICAgICBidWlsZCA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLnJlbW92ZVF1ZXJ5ID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIGJ1aWxkKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIFVSSS5yZW1vdmVRdWVyeShkYXRhLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICB0aGlzLl9wYXJ0cy5xdWVyeSA9IFVSSS5idWlsZFF1ZXJ5KGRhdGEsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuaGFzUXVlcnkgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgd2l0aGluQXJyYXkpIHsKICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgcmV0dXJuIFVSSS5oYXNRdWVyeShkYXRhLCBuYW1lLCB2YWx1ZSwgd2l0aGluQXJyYXkpOwogICAgICAgIH07CiAgICAgICAgcC5zZXRTZWFyY2ggPSBwLnNldFF1ZXJ5OwogICAgICAgIHAuYWRkU2VhcmNoID0gcC5hZGRRdWVyeTsKICAgICAgICBwLnJlbW92ZVNlYXJjaCA9IHAucmVtb3ZlUXVlcnk7CiAgICAgICAgcC5oYXNTZWFyY2ggPSBwLmhhc1F1ZXJ5OwogICAgICAgIHAubm9ybWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVByb3RvY29sKGZhbHNlKS5ub3JtYWxpemVQYXRoKGZhbHNlKS5ub3JtYWxpemVRdWVyeShmYWxzZSkubm9ybWFsaXplRnJhZ21lbnQoZmFsc2UpLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVQcm90b2NvbChmYWxzZSkubm9ybWFsaXplSG9zdG5hbWUoZmFsc2UpLm5vcm1hbGl6ZVBvcnQoZmFsc2UpLm5vcm1hbGl6ZVBhdGgoZmFsc2UpLm5vcm1hbGl6ZVF1ZXJ5KGZhbHNlKS5ub3JtYWxpemVGcmFnbWVudChmYWxzZSkuYnVpbGQoKTsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUHJvdG9jb2wgPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9wYXJ0cy5wcm90b2NvbCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMucHJvdG9jb2wgPSB0aGlzLl9wYXJ0cy5wcm90b2NvbC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplSG9zdG5hbWUgPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzKCJJRE4iKSAmJiBwdW55Y29kZSkgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gcHVueWNvZGUudG9BU0NJSSh0aGlzLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pcygiSVB2NiIpICYmIElQdjYpIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA9IElQdjYuYmVzdCh0aGlzLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUG9ydCA9IGZ1bmN0aW9uKGJ1aWxkKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3BhcnRzLnByb3RvY29sID09PSAic3RyaW5nIiAmJiB0aGlzLl9wYXJ0cy5wb3J0ID09PSBVUkkuZGVmYXVsdFBvcnRzW3RoaXMuX3BhcnRzLnByb3RvY29sXSkgewogICAgICAgICAgICB0aGlzLl9wYXJ0cy5wb3J0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLm5vcm1hbGl6ZVBhdGggPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgdmFyIF9wYXRoID0gdGhpcy5fcGFydHMucGF0aDsKICAgICAgICAgIGlmICghX3BhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSBVUkkucmVjb2RlVXJuUGF0aCh0aGlzLl9wYXJ0cy5wYXRoKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5wYXRoID09PSAiLyIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBfcGF0aCA9IFVSSS5yZWNvZGVQYXRoKF9wYXRoKTsKICAgICAgICAgIHZhciBfd2FzX3JlbGF0aXZlOwogICAgICAgICAgdmFyIF9sZWFkaW5nUGFyZW50cyA9ICIiOwogICAgICAgICAgdmFyIF9wYXJlbnQsIF9wb3M7CiAgICAgICAgICBpZiAoX3BhdGguY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgX3dhc19yZWxhdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIF9wYXRoID0gIi8iICsgX3BhdGg7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoX3BhdGguc2xpY2UoLTMpID09PSAiLy4uIiB8fCBfcGF0aC5zbGljZSgtMikgPT09ICIvLiIpIHsKICAgICAgICAgICAgX3BhdGggKz0gIi8iOwogICAgICAgICAgfQogICAgICAgICAgX3BhdGggPSBfcGF0aC5yZXBsYWNlKC8oXC8oXC5cLykrKXwoXC9cLiQpL2csICIvIikucmVwbGFjZSgvXC97Mix9L2csICIvIik7CiAgICAgICAgICBpZiAoX3dhc19yZWxhdGl2ZSkgewogICAgICAgICAgICBfbGVhZGluZ1BhcmVudHMgPSBfcGF0aC5zdWJzdHJpbmcoMSkubWF0Y2goL14oXC5cLlwvKSsvKSB8fCAiIjsKICAgICAgICAgICAgaWYgKF9sZWFkaW5nUGFyZW50cykgewogICAgICAgICAgICAgIF9sZWFkaW5nUGFyZW50cyA9IF9sZWFkaW5nUGFyZW50c1swXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgX3BhcmVudCA9IF9wYXRoLnNlYXJjaCgvXC9cLlwuKFwvfCQpLyk7CiAgICAgICAgICAgIGlmIChfcGFyZW50ID09PSAtMSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgaWYgKF9wYXJlbnQgPT09IDApIHsKICAgICAgICAgICAgICBfcGF0aCA9IF9wYXRoLnN1YnN0cmluZygzKTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfcG9zID0gX3BhdGguc3Vic3RyaW5nKDAsIF9wYXJlbnQpLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICAgIGlmIChfcG9zID09PSAtMSkgewogICAgICAgICAgICAgIF9wb3MgPSBfcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9wYXRoID0gX3BhdGguc3Vic3RyaW5nKDAsIF9wb3MpICsgX3BhdGguc3Vic3RyaW5nKF9wYXJlbnQgKyAzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChfd2FzX3JlbGF0aXZlICYmIHRoaXMuaXMoInJlbGF0aXZlIikpIHsKICAgICAgICAgICAgX3BhdGggPSBfbGVhZGluZ1BhcmVudHMgKyBfcGF0aC5zdWJzdHJpbmcoMSk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gX3BhdGg7CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUGF0aG5hbWUgPSBwLm5vcm1hbGl6ZVBhdGg7CiAgICAgICAgcC5ub3JtYWxpemVRdWVyeSA9IGZ1bmN0aW9uKGJ1aWxkKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3BhcnRzLnF1ZXJ5ID09PSAic3RyaW5nIikgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLnF1ZXJ5Lmxlbmd0aCkgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLnF1ZXJ5ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLm5vcm1hbGl6ZUZyYWdtZW50ID0gZnVuY3Rpb24oYnVpbGQpIHsKICAgICAgICAgIGlmICghdGhpcy5fcGFydHMuZnJhZ21lbnQpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMuZnJhZ21lbnQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplU2VhcmNoID0gcC5ub3JtYWxpemVRdWVyeTsKICAgICAgICBwLm5vcm1hbGl6ZUhhc2ggPSBwLm5vcm1hbGl6ZUZyYWdtZW50OwogICAgICAgIHAuaXNvODg1OSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGUgPSBVUkkuZW5jb2RlOwogICAgICAgICAgdmFyIGQgPSBVUkkuZGVjb2RlOwogICAgICAgICAgVVJJLmVuY29kZSA9IGVzY2FwZTsKICAgICAgICAgIFVSSS5kZWNvZGUgPSBkZWNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgVVJJLmVuY29kZSA9IGU7CiAgICAgICAgICAgIFVSSS5kZWNvZGUgPSBkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLnVuaWNvZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBlID0gVVJJLmVuY29kZTsKICAgICAgICAgIHZhciBkID0gVVJJLmRlY29kZTsKICAgICAgICAgIFVSSS5lbmNvZGUgPSBzdHJpY3RFbmNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgICBVUkkuZGVjb2RlID0gdW5lc2NhcGU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgVVJJLmVuY29kZSA9IGU7CiAgICAgICAgICAgIFVSSS5kZWNvZGUgPSBkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLnJlYWRhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdXJpID0gdGhpcy5jbG9uZSgpOwogICAgICAgICAgdXJpLnVzZXJuYW1lKCIiKS5wYXNzd29yZCgiIikubm9ybWFsaXplKCk7CiAgICAgICAgICB2YXIgdCA9ICIiOwogICAgICAgICAgaWYgKHVyaS5fcGFydHMucHJvdG9jb2wpIHsKICAgICAgICAgICAgdCArPSB1cmkuX3BhcnRzLnByb3RvY29sICsgIjovLyI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXJpLl9wYXJ0cy5ob3N0bmFtZSkgewogICAgICAgICAgICBpZiAodXJpLmlzKCJwdW55Y29kZSIpICYmIHB1bnljb2RlKSB7CiAgICAgICAgICAgICAgdCArPSBwdW55Y29kZS50b1VuaWNvZGUodXJpLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgICAgaWYgKHVyaS5fcGFydHMucG9ydCkgewogICAgICAgICAgICAgICAgdCArPSAiOiIgKyB1cmkuX3BhcnRzLnBvcnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHQgKz0gdXJpLmhvc3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVyaS5fcGFydHMuaG9zdG5hbWUgJiYgdXJpLl9wYXJ0cy5wYXRoICYmIHVyaS5fcGFydHMucGF0aC5jaGFyQXQoMCkgIT09ICIvIikgewogICAgICAgICAgICB0ICs9ICIvIjsKICAgICAgICAgIH0KICAgICAgICAgIHQgKz0gdXJpLnBhdGgodHJ1ZSk7CiAgICAgICAgICBpZiAodXJpLl9wYXJ0cy5xdWVyeSkgewogICAgICAgICAgICB2YXIgcTMgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHFwID0gdXJpLl9wYXJ0cy5xdWVyeS5zcGxpdCgiJiIpLCBsID0gcXAubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGt2ID0gKHFwW2ldIHx8ICIiKS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgIHEzICs9ICImIiArIFVSSS5kZWNvZGVRdWVyeShrdlswXSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSkucmVwbGFjZSgvJi9nLCAiJTI2Iik7CiAgICAgICAgICAgICAgaWYgKGt2WzFdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHEzICs9ICI9IiArIFVSSS5kZWNvZGVRdWVyeShrdlsxXSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSkucmVwbGFjZSgvJi9nLCAiJTI2Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHQgKz0gIj8iICsgcTMuc3Vic3RyaW5nKDEpOwogICAgICAgICAgfQogICAgICAgICAgdCArPSBVUkkuZGVjb2RlUXVlcnkodXJpLmhhc2goKSwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gdDsKICAgICAgICB9OwogICAgICAgIHAuYWJzb2x1dGVUbyA9IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICAgIHZhciByZXNvbHZlZCA9IHRoaXMuY2xvbmUoKTsKICAgICAgICAgIHZhciBwcm9wZXJ0aWVzID0gWyJwcm90b2NvbCIsICJ1c2VybmFtZSIsICJwYXNzd29yZCIsICJob3N0bmFtZSIsICJwb3J0Il07CiAgICAgICAgICB2YXIgYmFzZWRpciwgaSwgcDI7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVVJOcyBkbyBub3QgaGF2ZSBhbnkgZ2VuZXJhbGx5IGRlZmluZWQgaGllcmFyY2hpY2FsIGNvbXBvbmVudHMiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghKGJhc2UgaW5zdGFuY2VvZiBVUkkpKSB7CiAgICAgICAgICAgIGJhc2UgPSBuZXcgVVJJKGJhc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlc29sdmVkLl9wYXJ0cy5wcm90b2NvbCkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucHJvdG9jb2wgPSBiYXNlLl9wYXJ0cy5wcm90b2NvbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5ob3N0bmFtZSkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBwMiA9IHByb3BlcnRpZXNbaV07IGkrKykgewogICAgICAgICAgICByZXNvbHZlZC5fcGFydHNbcDJdID0gYmFzZS5fcGFydHNbcDJdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFyZXNvbHZlZC5fcGFydHMucGF0aCkgewogICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucGF0aCA9IGJhc2UuX3BhcnRzLnBhdGg7CiAgICAgICAgICAgIGlmICghcmVzb2x2ZWQuX3BhcnRzLnF1ZXJ5KSB7CiAgICAgICAgICAgICAgcmVzb2x2ZWQuX3BhcnRzLnF1ZXJ5ID0gYmFzZS5fcGFydHMucXVlcnk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlZC5fcGFydHMucGF0aC5zdWJzdHJpbmcoLTIpID09PSAiLi4iKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZWQuX3BhcnRzLnBhdGggKz0gIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXNvbHZlZC5wYXRoKCkuY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgICBiYXNlZGlyID0gYmFzZS5kaXJlY3RvcnkoKTsKICAgICAgICAgICAgICBiYXNlZGlyID0gYmFzZWRpciA/IGJhc2VkaXIgOiBiYXNlLnBhdGgoKS5pbmRleE9mKCIvIikgPT09IDAgPyAiLyIgOiAiIjsKICAgICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucGF0aCA9IChiYXNlZGlyID8gYmFzZWRpciArICIvIiA6ICIiKSArIHJlc29sdmVkLl9wYXJ0cy5wYXRoOwogICAgICAgICAgICAgIHJlc29sdmVkLm5vcm1hbGl6ZVBhdGgoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVzb2x2ZWQuYnVpbGQoKTsKICAgICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgICB9OwogICAgICAgIHAucmVsYXRpdmVUbyA9IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICAgIHZhciByZWxhdGl2ZSA9IHRoaXMuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgIHZhciByZWxhdGl2ZVBhcnRzLCBiYXNlUGFydHMsIGNvbW1vbiwgcmVsYXRpdmVQYXRoLCBiYXNlUGF0aDsKICAgICAgICAgIGlmIChyZWxhdGl2ZS5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVVJOcyBkbyBub3QgaGF2ZSBhbnkgZ2VuZXJhbGx5IGRlZmluZWQgaGllcmFyY2hpY2FsIGNvbXBvbmVudHMiKTsKICAgICAgICAgIH0KICAgICAgICAgIGJhc2UgPSBuZXcgVVJJKGJhc2UpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgcmVsYXRpdmVQYXJ0cyA9IHJlbGF0aXZlLl9wYXJ0czsKICAgICAgICAgIGJhc2VQYXJ0cyA9IGJhc2UuX3BhcnRzOwogICAgICAgICAgcmVsYXRpdmVQYXRoID0gcmVsYXRpdmUucGF0aCgpOwogICAgICAgICAgYmFzZVBhdGggPSBiYXNlLnBhdGgoKTsKICAgICAgICAgIGlmIChyZWxhdGl2ZVBhdGguY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVUkkgaXMgYWxyZWFkeSByZWxhdGl2ZSIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJhc2VQYXRoLmNoYXJBdCgwKSAhPT0gIi8iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNhbGN1bGF0ZSBhIFVSSSByZWxhdGl2ZSB0byBhbm90aGVyIHJlbGF0aXZlIFVSSSIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMucHJvdG9jb2wgPT09IGJhc2VQYXJ0cy5wcm90b2NvbCkgewogICAgICAgICAgICByZWxhdGl2ZVBhcnRzLnByb3RvY29sID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWxhdGl2ZVBhcnRzLnVzZXJuYW1lICE9PSBiYXNlUGFydHMudXNlcm5hbWUgfHwgcmVsYXRpdmVQYXJ0cy5wYXNzd29yZCAhPT0gYmFzZVBhcnRzLnBhc3N3b3JkKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZS5idWlsZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMucHJvdG9jb2wgIT09IG51bGwgfHwgcmVsYXRpdmVQYXJ0cy51c2VybmFtZSAhPT0gbnVsbCB8fCByZWxhdGl2ZVBhcnRzLnBhc3N3b3JkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZS5idWlsZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMuaG9zdG5hbWUgPT09IGJhc2VQYXJ0cy5ob3N0bmFtZSAmJiByZWxhdGl2ZVBhcnRzLnBvcnQgPT09IGJhc2VQYXJ0cy5wb3J0KSB7CiAgICAgICAgICAgIHJlbGF0aXZlUGFydHMuaG9zdG5hbWUgPSBudWxsOwogICAgICAgICAgICByZWxhdGl2ZVBhcnRzLnBvcnQgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVsYXRpdmVQYXRoID09PSBiYXNlUGF0aCkgewogICAgICAgICAgICByZWxhdGl2ZVBhcnRzLnBhdGggPSAiIjsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb21tb24gPSBVUkkuY29tbW9uUGF0aChyZWxhdGl2ZVBhdGgsIGJhc2VQYXRoKTsKICAgICAgICAgIGlmICghY29tbW9uKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZS5idWlsZCgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmVudHMgPSBiYXNlUGFydHMucGF0aC5zdWJzdHJpbmcoY29tbW9uLmxlbmd0aCkucmVwbGFjZSgvW15cL10qJC8sICIiKS5yZXBsYWNlKC8uKj9cLy9nLCAiLi4vIik7CiAgICAgICAgICByZWxhdGl2ZVBhcnRzLnBhdGggPSBwYXJlbnRzICsgcmVsYXRpdmVQYXJ0cy5wYXRoLnN1YnN0cmluZyhjb21tb24ubGVuZ3RoKSB8fCAiLi8iOwogICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgfTsKICAgICAgICBwLmVxdWFscyA9IGZ1bmN0aW9uKHVyaSkgewogICAgICAgICAgdmFyIG9uZSA9IHRoaXMuY2xvbmUoKTsKICAgICAgICAgIHZhciB0d28gPSBuZXcgVVJJKHVyaSk7CiAgICAgICAgICB2YXIgb25lX21hcCA9IHt9OwogICAgICAgICAgdmFyIHR3b19tYXAgPSB7fTsKICAgICAgICAgIHZhciBjaGVja2VkID0ge307CiAgICAgICAgICB2YXIgb25lX3F1ZXJ5LCB0d29fcXVlcnksIGtleTsKICAgICAgICAgIG9uZS5ub3JtYWxpemUoKTsKICAgICAgICAgIHR3by5ub3JtYWxpemUoKTsKICAgICAgICAgIGlmIChvbmUudG9TdHJpbmcoKSA9PT0gdHdvLnRvU3RyaW5nKCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBvbmVfcXVlcnkgPSBvbmUucXVlcnkoKTsKICAgICAgICAgIHR3b19xdWVyeSA9IHR3by5xdWVyeSgpOwogICAgICAgICAgb25lLnF1ZXJ5KCIiKTsKICAgICAgICAgIHR3by5xdWVyeSgiIik7CiAgICAgICAgICBpZiAob25lLnRvU3RyaW5nKCkgIT09IHR3by50b1N0cmluZygpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbmVfcXVlcnkubGVuZ3RoICE9PSB0d29fcXVlcnkubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIG9uZV9tYXAgPSBVUkkucGFyc2VRdWVyeShvbmVfcXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgdHdvX21hcCA9IFVSSS5wYXJzZVF1ZXJ5KHR3b19xdWVyeSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBmb3IgKGtleSBpbiBvbmVfbWFwKSB7CiAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChvbmVfbWFwLCBrZXkpKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KG9uZV9tYXBba2V5XSkpIHsKICAgICAgICAgICAgICAgIGlmIChvbmVfbWFwW2tleV0gIT09IHR3b19tYXBba2V5XSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghYXJyYXlzRXF1YWwob25lX21hcFtrZXldLCB0d29fbWFwW2tleV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoZWNrZWRba2V5XSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAoa2V5IGluIHR3b19tYXApIHsKICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHR3b19tYXAsIGtleSkpIHsKICAgICAgICAgICAgICBpZiAoIWNoZWNrZWRba2V5XSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfTsKICAgICAgICBwLnByZXZlbnRJbnZhbGlkSG9zdG5hbWUgPSBmdW5jdGlvbih2MykgewogICAgICAgICAgdGhpcy5fcGFydHMucHJldmVudEludmFsaWRIb3N0bmFtZSA9ICEhdjM7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24odjMpIHsKICAgICAgICAgIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycyA9ICEhdjM7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuZXNjYXBlUXVlcnlTcGFjZSA9IGZ1bmN0aW9uKHYzKSB7CiAgICAgICAgICB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlID0gISF2MzsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIFVSSTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9hcHBlbmRGb3J3YXJkU2xhc2guanMKICBmdW5jdGlvbiBhcHBlbmRGb3J3YXJkU2xhc2godXJsKSB7CiAgICBpZiAodXJsLmxlbmd0aCA9PT0gMCB8fCB1cmxbdXJsLmxlbmd0aCAtIDFdICE9PSAiLyIpIHsKICAgICAgdXJsID0gYCR7dXJsfS9gOwogICAgfQogICAgcmV0dXJuIHVybDsKICB9CiAgdmFyIGFwcGVuZEZvcndhcmRTbGFzaF9kZWZhdWx0OwogIHZhciBpbml0X2FwcGVuZEZvcndhcmRTbGFzaCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYXBwZW5kRm9yd2FyZFNsYXNoLmpzIigpIHsKICAgICAgYXBwZW5kRm9yd2FyZFNsYXNoX2RlZmF1bHQgPSBhcHBlbmRGb3J3YXJkU2xhc2g7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9jbG9uZS5qcwogIGZ1bmN0aW9uIGNsb25lKG9iamVjdCwgZGVlcCkgewogICAgaWYgKG9iamVjdCA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqZWN0ICE9PSAib2JqZWN0IikgewogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQogICAgZGVlcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRlZXAsIGZhbHNlKTsKICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBvYmplY3QuY29uc3RydWN0b3IoKTsKICAgIGZvciAoY29uc3QgcHJvcGVydHlOYW1lIGluIG9iamVjdCkgewogICAgICBpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KHByb3BlcnR5TmFtZSkpIHsKICAgICAgICBsZXQgdmFsdWUgPSBvYmplY3RbcHJvcGVydHlOYW1lXTsKICAgICAgICBpZiAoZGVlcCkgewogICAgICAgICAgdmFsdWUgPSBjbG9uZSh2YWx1ZSwgZGVlcCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBjbG9uZV9kZWZhdWx0OwogIHZhciBpbml0X2Nsb25lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9jbG9uZS5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGNsb25lX2RlZmF1bHQgPSBjbG9uZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2NvbWJpbmUuanMKICBmdW5jdGlvbiBjb21iaW5lKG9iamVjdDEsIG9iamVjdDIsIGRlZXApIHsKICAgIGRlZXAgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChkZWVwLCBmYWxzZSk7CiAgICBjb25zdCByZXN1bHQgPSB7fTsKICAgIGNvbnN0IG9iamVjdDFEZWZpbmVkID0gZGVmaW5lZF9kZWZhdWx0KG9iamVjdDEpOwogICAgY29uc3Qgb2JqZWN0MkRlZmluZWQgPSBkZWZpbmVkX2RlZmF1bHQob2JqZWN0Mik7CiAgICBsZXQgcHJvcGVydHk7CiAgICBsZXQgb2JqZWN0MVZhbHVlOwogICAgbGV0IG9iamVjdDJWYWx1ZTsKICAgIGlmIChvYmplY3QxRGVmaW5lZCkgewogICAgICBmb3IgKHByb3BlcnR5IGluIG9iamVjdDEpIHsKICAgICAgICBpZiAob2JqZWN0MS5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHsKICAgICAgICAgIG9iamVjdDFWYWx1ZSA9IG9iamVjdDFbcHJvcGVydHldOwogICAgICAgICAgaWYgKG9iamVjdDJEZWZpbmVkICYmIGRlZXAgJiYgdHlwZW9mIG9iamVjdDFWYWx1ZSA9PT0gIm9iamVjdCIgJiYgb2JqZWN0Mi5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHsKICAgICAgICAgICAgb2JqZWN0MlZhbHVlID0gb2JqZWN0Mltwcm9wZXJ0eV07CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0MlZhbHVlID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJlc3VsdFtwcm9wZXJ0eV0gPSBjb21iaW5lKG9iamVjdDFWYWx1ZSwgb2JqZWN0MlZhbHVlLCBkZWVwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHRbcHJvcGVydHldID0gb2JqZWN0MVZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHRbcHJvcGVydHldID0gb2JqZWN0MVZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG9iamVjdDJEZWZpbmVkKSB7CiAgICAgIGZvciAocHJvcGVydHkgaW4gb2JqZWN0MikgewogICAgICAgIGlmIChvYmplY3QyLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiAhcmVzdWx0Lmhhc093blByb3BlcnR5KHByb3BlcnR5KSkgewogICAgICAgICAgb2JqZWN0MlZhbHVlID0gb2JqZWN0Mltwcm9wZXJ0eV07CiAgICAgICAgICByZXN1bHRbcHJvcGVydHldID0gb2JqZWN0MlZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIGNvbWJpbmVfZGVmYXVsdDsKICB2YXIgaW5pdF9jb21iaW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9jb21iaW5lLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNvbWJpbmVfZGVmYXVsdCA9IGNvbWJpbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZWZlci5qcwogIGZ1bmN0aW9uIGRlZmVyKCkgewogICAgbGV0IHJlc29sdmU7CiAgICBsZXQgcmVqZWN0OwogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlcywgcmVqKSB7CiAgICAgIHJlc29sdmUgPSByZXM7CiAgICAgIHJlamVjdCA9IHJlajsKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgcmVzb2x2ZSwKICAgICAgcmVqZWN0LAogICAgICBwcm9taXNlCiAgICB9OwogIH0KICB2YXIgZGVmZXJfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWZlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVmZXIuanMiKCkgewogICAgICBkZWZlcl9kZWZhdWx0ID0gZGVmZXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRBYnNvbHV0ZVVyaS5qcwogIGZ1bmN0aW9uIGdldEFic29sdXRlVXJpKHJlbGF0aXZlLCBiYXNlKSB7CiAgICBsZXQgZG9jdW1lbnRPYmplY3Q7CiAgICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIikgewogICAgICBkb2N1bWVudE9iamVjdCA9IGRvY3VtZW50OwogICAgfQogICAgcmV0dXJuIGdldEFic29sdXRlVXJpLl9pbXBsZW1lbnRhdGlvbihyZWxhdGl2ZSwgYmFzZSwgZG9jdW1lbnRPYmplY3QpOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzLCBnZXRBYnNvbHV0ZVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2dldEFic29sdXRlVXJpID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRBYnNvbHV0ZVVyaS5qcyIoKSB7CiAgICAgIGltcG9ydF91cmlqcyA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGdldEFic29sdXRlVXJpLl9pbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uKHJlbGF0aXZlLCBiYXNlLCBkb2N1bWVudE9iamVjdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlbGF0aXZlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlbGF0aXZlIHVyaSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYmFzZSkpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnRPYmplY3QgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZTsKICAgICAgICAgIH0KICAgICAgICAgIGJhc2UgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChkb2N1bWVudE9iamVjdC5iYXNlVVJJLCBkb2N1bWVudE9iamVjdC5sb2NhdGlvbi5ocmVmKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVsYXRpdmVVcmkgPSBuZXcgaW1wb3J0X3VyaWpzLmRlZmF1bHQocmVsYXRpdmUpOwogICAgICAgIGlmIChyZWxhdGl2ZVVyaS5zY2hlbWUoKSAhPT0gIiIpIHsKICAgICAgICAgIHJldHVybiByZWxhdGl2ZVVyaS50b1N0cmluZygpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVsYXRpdmVVcmkuYWJzb2x1dGVUbyhiYXNlKS50b1N0cmluZygpOwogICAgICB9OwogICAgICBnZXRBYnNvbHV0ZVVyaV9kZWZhdWx0ID0gZ2V0QWJzb2x1dGVVcmk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRCYXNlVXJpLmpzCiAgZnVuY3Rpb24gZ2V0QmFzZVVyaSh1cmksIGluY2x1ZGVRdWVyeSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXJpKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXJpIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgbGV0IGJhc2VQYXRoID0gIiI7CiAgICBjb25zdCBpID0gdXJpLmxhc3RJbmRleE9mKCIvIik7CiAgICBpZiAoaSAhPT0gLTEpIHsKICAgICAgYmFzZVBhdGggPSB1cmkuc3Vic3RyaW5nKDAsIGkgKyAxKTsKICAgIH0KICAgIGlmICghaW5jbHVkZVF1ZXJ5KSB7CiAgICAgIHJldHVybiBiYXNlUGF0aDsKICAgIH0KICAgIHVyaSA9IG5ldyBpbXBvcnRfdXJpanMyLmRlZmF1bHQodXJpKTsKICAgIGlmICh1cmkucXVlcnkoKS5sZW5ndGggIT09IDApIHsKICAgICAgYmFzZVBhdGggKz0gYD8ke3VyaS5xdWVyeSgpfWA7CiAgICB9CiAgICBpZiAodXJpLmZyYWdtZW50KCkubGVuZ3RoICE9PSAwKSB7CiAgICAgIGJhc2VQYXRoICs9IGAjJHt1cmkuZnJhZ21lbnQoKX1gOwogICAgfQogICAgcmV0dXJuIGJhc2VQYXRoOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzMiwgZ2V0QmFzZVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2dldEJhc2VVcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEJhc2VVcmkuanMiKCkgewogICAgICBpbXBvcnRfdXJpanMyID0gX190b0VTTShyZXF1aXJlX1VSSSgpLCAxKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgZ2V0QmFzZVVyaV9kZWZhdWx0ID0gZ2V0QmFzZVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEV4dGVuc2lvbkZyb21VcmkuanMKICBmdW5jdGlvbiBnZXRFeHRlbnNpb25Gcm9tVXJpKHVyaSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXJpKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXJpIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgY29uc3QgdXJpT2JqZWN0ID0gbmV3IGltcG9ydF91cmlqczMuZGVmYXVsdCh1cmkpOwogICAgdXJpT2JqZWN0Lm5vcm1hbGl6ZSgpOwogICAgbGV0IHBhdGggPSB1cmlPYmplY3QucGF0aCgpOwogICAgbGV0IGluZGV4ID0gcGF0aC5sYXN0SW5kZXhPZigiLyIpOwogICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICBwYXRoID0gcGF0aC5zdWJzdHIoaW5kZXggKyAxKTsKICAgIH0KICAgIGluZGV4ID0gcGF0aC5sYXN0SW5kZXhPZigiLiIpOwogICAgaWYgKGluZGV4ID09PSAtMSkgewogICAgICBwYXRoID0gIiI7CiAgICB9IGVsc2UgewogICAgICBwYXRoID0gcGF0aC5zdWJzdHIoaW5kZXggKyAxKTsKICAgIH0KICAgIHJldHVybiBwYXRoOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzMywgZ2V0RXh0ZW5zaW9uRnJvbVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2dldEV4dGVuc2lvbkZyb21VcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEV4dGVuc2lvbkZyb21VcmkuanMiKCkgewogICAgICBpbXBvcnRfdXJpanMzID0gX190b0VTTShyZXF1aXJlX1VSSSgpLCAxKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgZ2V0RXh0ZW5zaW9uRnJvbVVyaV9kZWZhdWx0ID0gZ2V0RXh0ZW5zaW9uRnJvbVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEltYWdlUGl4ZWxzLmpzCiAgZnVuY3Rpb24gZ2V0SW1hZ2VQaXhlbHMoaW1hZ2UsIHdpZHRoLCBoZWlnaHQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHdpZHRoKSkgewogICAgICB3aWR0aCA9IGltYWdlLndpZHRoOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaGVpZ2h0KSkgewogICAgICBoZWlnaHQgPSBpbWFnZS5oZWlnaHQ7CiAgICB9CiAgICBsZXQgY29udGV4dDJEc0J5SGVpZ2h0ID0gY29udGV4dDJEc0J5V2lkdGhBbmRIZWlnaHRbd2lkdGhdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29udGV4dDJEc0J5SGVpZ2h0KSkgewogICAgICBjb250ZXh0MkRzQnlIZWlnaHQgPSB7fTsKICAgICAgY29udGV4dDJEc0J5V2lkdGhBbmRIZWlnaHRbd2lkdGhdID0gY29udGV4dDJEc0J5SGVpZ2h0OwogICAgfQogICAgbGV0IGNvbnRleHQyZCA9IGNvbnRleHQyRHNCeUhlaWdodFtoZWlnaHRdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29udGV4dDJkKSkgewogICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgY2FudmFzLndpZHRoID0gd2lkdGg7CiAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIGNvbnRleHQyZCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsgd2lsbFJlYWRGcmVxdWVudGx5OiB0cnVlIH0pOwogICAgICBjb250ZXh0MmQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gImNvcHkiOwogICAgICBjb250ZXh0MkRzQnlIZWlnaHRbaGVpZ2h0XSA9IGNvbnRleHQyZDsKICAgIH0KICAgIGNvbnRleHQyZC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDAsIHdpZHRoLCBoZWlnaHQpOwogICAgcmV0dXJuIGNvbnRleHQyZC5nZXRJbWFnZURhdGEoMCwgMCwgd2lkdGgsIGhlaWdodCkuZGF0YTsKICB9CiAgdmFyIGNvbnRleHQyRHNCeVdpZHRoQW5kSGVpZ2h0LCBnZXRJbWFnZVBpeGVsc19kZWZhdWx0OwogIHZhciBpbml0X2dldEltYWdlUGl4ZWxzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRJbWFnZVBpeGVscy5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjb250ZXh0MkRzQnlXaWR0aEFuZEhlaWdodCA9IHt9OwogICAgICBnZXRJbWFnZVBpeGVsc19kZWZhdWx0ID0gZ2V0SW1hZ2VQaXhlbHM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0Jsb2JVcmkuanMKICBmdW5jdGlvbiBpc0Jsb2JVcmkodXJpKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoInVyaSIsIHVyaSk7CiAgICByZXR1cm4gYmxvYlVyaVJlZ2V4LnRlc3QodXJpKTsKICB9CiAgdmFyIGJsb2JVcmlSZWdleCwgaXNCbG9iVXJpX2RlZmF1bHQ7CiAgdmFyIGluaXRfaXNCbG9iVXJpID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0Jsb2JVcmkuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGJsb2JVcmlSZWdleCA9IC9eYmxvYjovaTsKICAgICAgaXNCbG9iVXJpX2RlZmF1bHQgPSBpc0Jsb2JVcmk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0Nyb3NzT3JpZ2luVXJsLmpzCiAgZnVuY3Rpb24gaXNDcm9zc09yaWdpblVybCh1cmwpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGEpKSB7CiAgICAgIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICB9CiAgICBhLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgIGNvbnN0IGhvc3QgPSBhLmhvc3Q7CiAgICBjb25zdCBwcm90b2NvbCA9IGEucHJvdG9jb2w7CiAgICBhLmhyZWYgPSB1cmw7CiAgICBhLmhyZWYgPSBhLmhyZWY7CiAgICByZXR1cm4gcHJvdG9jb2wgIT09IGEucHJvdG9jb2wgfHwgaG9zdCAhPT0gYS5ob3N0OwogIH0KICB2YXIgYSwgaXNDcm9zc09yaWdpblVybF9kZWZhdWx0OwogIHZhciBpbml0X2lzQ3Jvc3NPcmlnaW5VcmwgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQ3Jvc3NPcmlnaW5VcmwuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaXNDcm9zc09yaWdpblVybF9kZWZhdWx0ID0gaXNDcm9zc09yaWdpblVybDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzRGF0YVVyaS5qcwogIGZ1bmN0aW9uIGlzRGF0YVVyaSh1cmkpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLnN0cmluZygidXJpIiwgdXJpKTsKICAgIHJldHVybiBkYXRhVXJpUmVnZXgudGVzdCh1cmkpOwogIH0KICB2YXIgZGF0YVVyaVJlZ2V4LCBpc0RhdGFVcmlfZGVmYXVsdDsKICB2YXIgaW5pdF9pc0RhdGFVcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzRGF0YVVyaS5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgZGF0YVVyaVJlZ2V4ID0gL15kYXRhOi9pOwogICAgICBpc0RhdGFVcmlfZGVmYXVsdCA9IGlzRGF0YVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2xvYWRBbmRFeGVjdXRlU2NyaXB0LmpzCiAgZnVuY3Rpb24gbG9hZEFuZEV4ZWN1dGVTY3JpcHQodXJsKSB7CiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgIHNjcmlwdC5hc3luYyA9IHRydWU7CiAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgaWYgKHdpbmRvdy5jcm9zc09yaWdpbklzb2xhdGVkKSB7CiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgiY3Jvc3NvcmlnaW4iLCAiYW5vbnltb3VzIik7CiAgICAgIH0KICAgICAgY29uc3QgaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF07CiAgICAgIHNjcmlwdC5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICBzY3JpcHQub25sb2FkID0gdm9pZCAwOwogICAgICAgIGhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICByZXNvbHZlKCk7CiAgICAgIH07CiAgICAgIHNjcmlwdC5vbmVycm9yID0gZnVuY3Rpb24oZSkgewogICAgICAgIHJlamVjdChlKTsKICAgICAgfTsKICAgICAgaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgfSk7CiAgfQogIHZhciBsb2FkQW5kRXhlY3V0ZVNjcmlwdF9kZWZhdWx0OwogIHZhciBpbml0X2xvYWRBbmRFeGVjdXRlU2NyaXB0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9sb2FkQW5kRXhlY3V0ZVNjcmlwdC5qcyIoKSB7CiAgICAgIGxvYWRBbmRFeGVjdXRlU2NyaXB0X2RlZmF1bHQgPSBsb2FkQW5kRXhlY3V0ZVNjcmlwdDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL29iamVjdFRvUXVlcnkuanMKICBmdW5jdGlvbiBvYmplY3RUb1F1ZXJ5KG9iaikgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob2JqKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib2JqIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgbGV0IHJlc3VsdCA9ICIiOwogICAgZm9yIChjb25zdCBwcm9wTmFtZSBpbiBvYmopIHsKICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICBjb25zdCB2YWx1ZSA9IG9ialtwcm9wTmFtZV07CiAgICAgICAgY29uc3QgcGFydCA9IGAke2VuY29kZVVSSUNvbXBvbmVudChwcm9wTmFtZSl9PWA7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gdmFsdWUubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgcmVzdWx0ICs9IGAke3BhcnQgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWVbaV0pfSZgOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQgKz0gYCR7cGFydCArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSl9JmA7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIG9iamVjdFRvUXVlcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9vYmplY3RUb1F1ZXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9vYmplY3RUb1F1ZXJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgb2JqZWN0VG9RdWVyeV9kZWZhdWx0ID0gb2JqZWN0VG9RdWVyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL3F1ZXJ5VG9PYmplY3QuanMKICBmdW5jdGlvbiBxdWVyeVRvT2JqZWN0KHF1ZXJ5U3RyaW5nKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChxdWVyeVN0cmluZykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInF1ZXJ5U3RyaW5nIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0ge307CiAgICBpZiAocXVlcnlTdHJpbmcgPT09ICIiKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBjb25zdCBwYXJ0cyA9IHF1ZXJ5U3RyaW5nLnJlcGxhY2UoL1wrL2csICIlMjAiKS5zcGxpdCgvWyY7XS8pOwogICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHBhcnRzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGNvbnN0IHN1YnBhcnRzID0gcGFydHNbaV0uc3BsaXQoIj0iKTsKICAgICAgY29uc3QgbmFtZSA9IGRlY29kZVVSSUNvbXBvbmVudChzdWJwYXJ0c1swXSk7CiAgICAgIGxldCB2YWx1ZSA9IHN1YnBhcnRzWzFdOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgIHZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZSA9ICIiOwogICAgICB9CiAgICAgIGNvbnN0IHJlc3VsdFZhbHVlID0gcmVzdWx0W25hbWVdOwogICAgICBpZiAodHlwZW9mIHJlc3VsdFZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgIHJlc3VsdFtuYW1lXSA9IFtyZXN1bHRWYWx1ZSwgdmFsdWVdOwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0VmFsdWUpKSB7CiAgICAgICAgcmVzdWx0VmFsdWUucHVzaCh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W25hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBxdWVyeVRvT2JqZWN0X2RlZmF1bHQ7CiAgdmFyIGluaXRfcXVlcnlUb09iamVjdCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvcXVlcnlUb09iamVjdC5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIHF1ZXJ5VG9PYmplY3RfZGVmYXVsdCA9IHF1ZXJ5VG9PYmplY3Q7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0U3RhdGUuanMKICB2YXIgUmVxdWVzdFN0YXRlLCBSZXF1ZXN0U3RhdGVfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0U3RhdGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RTdGF0ZS5qcyIoKSB7CiAgICAgIFJlcXVlc3RTdGF0ZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBJbml0aWFsIHVuaXNzdWVkIHN0YXRlLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTklTU1VFRDogMCwKICAgICAgICAvKioKICAgICAgICAgKiBJc3N1ZWQgYnV0IG5vdCB5ZXQgYWN0aXZlLiBXaWxsIGJlY29tZSBhY3RpdmUgd2hlbiBvcGVuIHNsb3RzIGFyZSBhdmFpbGFibGUuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIElTU1VFRDogMSwKICAgICAgICAvKioKICAgICAgICAgKiBBY3R1YWwgaHR0cCByZXF1ZXN0IGhhcyBiZWVuIHNlbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEFDVElWRTogMiwKICAgICAgICAvKioKICAgICAgICAgKiBSZXF1ZXN0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJFQ0VJVkVEOiAzLAogICAgICAgIC8qKgogICAgICAgICAqIFJlcXVlc3Qgd2FzIGNhbmNlbGxlZCwgZWl0aGVyIGV4cGxpY2l0bHkgb3IgYXV0b21hdGljYWxseSBiZWNhdXNlIG9mIGxvdyBwcmlvcml0eS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQ0FOQ0VMTEVEOiA0LAogICAgICAgIC8qKgogICAgICAgICAqIFJlcXVlc3QgZmFpbGVkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBGQUlMRUQ6IDUKICAgICAgfTsKICAgICAgUmVxdWVzdFN0YXRlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFJlcXVlc3RTdGF0ZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0VHlwZS5qcwogIHZhciBSZXF1ZXN0VHlwZSwgUmVxdWVzdFR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0VHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdFR5cGUuanMiKCkgewogICAgICBSZXF1ZXN0VHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBUZXJyYWluIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRFUlJBSU46IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogSW1hZ2VyeSByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBJTUFHRVJZOiAxLAogICAgICAgIC8qKgogICAgICAgICAqIDNEIFRpbGVzIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRJTEVTM0Q6IDIsCiAgICAgICAgLyoqCiAgICAgICAgICogT3RoZXIgcmVxdWVzdC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgT1RIRVI6IDMKICAgICAgfTsKICAgICAgUmVxdWVzdFR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoUmVxdWVzdFR5cGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdC5qcwogIGZ1bmN0aW9uIFJlcXVlc3Qob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCB0aHJvdHRsZUJ5U2VydmVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy50aHJvdHRsZUJ5U2VydmVyLCBmYWxzZSk7CiAgICBjb25zdCB0aHJvdHRsZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudGhyb3R0bGUsIGZhbHNlKTsKICAgIHRoaXMudXJsID0gb3B0aW9ucy51cmw7CiAgICB0aGlzLnJlcXVlc3RGdW5jdGlvbiA9IG9wdGlvbnMucmVxdWVzdEZ1bmN0aW9uOwogICAgdGhpcy5jYW5jZWxGdW5jdGlvbiA9IG9wdGlvbnMuY2FuY2VsRnVuY3Rpb247CiAgICB0aGlzLnByaW9yaXR5RnVuY3Rpb24gPSBvcHRpb25zLnByaW9yaXR5RnVuY3Rpb247CiAgICB0aGlzLnByaW9yaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wcmlvcml0eSwgMCk7CiAgICB0aGlzLnRocm90dGxlID0gdGhyb3R0bGU7CiAgICB0aGlzLnRocm90dGxlQnlTZXJ2ZXIgPSB0aHJvdHRsZUJ5U2VydmVyOwogICAgdGhpcy50eXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy50eXBlLCBSZXF1ZXN0VHlwZV9kZWZhdWx0Lk9USEVSKTsKICAgIHRoaXMuc2VydmVyS2V5ID0gb3B0aW9ucy5zZXJ2ZXJLZXk7CiAgICB0aGlzLnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICB0aGlzLmRlZmVycmVkID0gdm9pZCAwOwogICAgdGhpcy5jYW5jZWxsZWQgPSBmYWxzZTsKICB9CiAgdmFyIFJlcXVlc3RfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0LmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfUmVxdWVzdFN0YXRlKCk7CiAgICAgIGluaXRfUmVxdWVzdFR5cGUoKTsKICAgICAgUmVxdWVzdC5wcm90b3R5cGUuY2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jYW5jZWxsZWQgPSB0cnVlOwogICAgICB9OwogICAgICBSZXF1ZXN0LnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVxdWVzdCh0aGlzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnVybCA9IHRoaXMudXJsOwogICAgICAgIHJlc3VsdC5yZXF1ZXN0RnVuY3Rpb24gPSB0aGlzLnJlcXVlc3RGdW5jdGlvbjsKICAgICAgICByZXN1bHQuY2FuY2VsRnVuY3Rpb24gPSB0aGlzLmNhbmNlbEZ1bmN0aW9uOwogICAgICAgIHJlc3VsdC5wcmlvcml0eUZ1bmN0aW9uID0gdGhpcy5wcmlvcml0eUZ1bmN0aW9uOwogICAgICAgIHJlc3VsdC5wcmlvcml0eSA9IHRoaXMucHJpb3JpdHk7CiAgICAgICAgcmVzdWx0LnRocm90dGxlID0gdGhpcy50aHJvdHRsZTsKICAgICAgICByZXN1bHQudGhyb3R0bGVCeVNlcnZlciA9IHRoaXMudGhyb3R0bGVCeVNlcnZlcjsKICAgICAgICByZXN1bHQudHlwZSA9IHRoaXMudHlwZTsKICAgICAgICByZXN1bHQuc2VydmVyS2V5ID0gdGhpcy5zZXJ2ZXJLZXk7CiAgICAgICAgcmVzdWx0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICAgICAgcmVzdWx0LmRlZmVycmVkID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5jYW5jZWxsZWQgPSBmYWxzZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZXF1ZXN0X2RlZmF1bHQgPSBSZXF1ZXN0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvcGFyc2VSZXNwb25zZUhlYWRlcnMuanMKICBmdW5jdGlvbiBwYXJzZVJlc3BvbnNlSGVhZGVycyhoZWFkZXJTdHJpbmcpIHsKICAgIGNvbnN0IGhlYWRlcnMgPSB7fTsKICAgIGlmICghaGVhZGVyU3RyaW5nKSB7CiAgICAgIHJldHVybiBoZWFkZXJzOwogICAgfQogICAgY29uc3QgaGVhZGVyUGFpcnMgPSBoZWFkZXJTdHJpbmcuc3BsaXQoIlxyXG4iKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGVhZGVyUGFpcnMubGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgaGVhZGVyUGFpciA9IGhlYWRlclBhaXJzW2ldOwogICAgICBjb25zdCBpbmRleCA9IGhlYWRlclBhaXIuaW5kZXhPZigiOiAiKTsKICAgICAgaWYgKGluZGV4ID4gMCkgewogICAgICAgIGNvbnN0IGtleSA9IGhlYWRlclBhaXIuc3Vic3RyaW5nKDAsIGluZGV4KTsKICAgICAgICBjb25zdCB2YWwgPSBoZWFkZXJQYWlyLnN1YnN0cmluZyhpbmRleCArIDIpOwogICAgICAgIGhlYWRlcnNba2V5XSA9IHZhbDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGhlYWRlcnM7CiAgfQogIHZhciBwYXJzZVJlc3BvbnNlSGVhZGVyc19kZWZhdWx0OwogIHZhciBpbml0X3BhcnNlUmVzcG9uc2VIZWFkZXJzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9wYXJzZVJlc3BvbnNlSGVhZGVycy5qcyIoKSB7CiAgICAgIHBhcnNlUmVzcG9uc2VIZWFkZXJzX2RlZmF1bHQgPSBwYXJzZVJlc3BvbnNlSGVhZGVyczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RFcnJvckV2ZW50LmpzCiAgZnVuY3Rpb24gUmVxdWVzdEVycm9yRXZlbnQoc3RhdHVzQ29kZSwgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykgewogICAgdGhpcy5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICAgIHRoaXMucmVzcG9uc2UgPSByZXNwb25zZTsKICAgIHRoaXMucmVzcG9uc2VIZWFkZXJzID0gcmVzcG9uc2VIZWFkZXJzOwogICAgaWYgKHR5cGVvZiB0aGlzLnJlc3BvbnNlSGVhZGVycyA9PT0gInN0cmluZyIpIHsKICAgICAgdGhpcy5yZXNwb25zZUhlYWRlcnMgPSBwYXJzZVJlc3BvbnNlSGVhZGVyc19kZWZhdWx0KHRoaXMucmVzcG9uc2VIZWFkZXJzKTsKICAgIH0KICB9CiAgdmFyIFJlcXVlc3RFcnJvckV2ZW50X2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVxdWVzdEVycm9yRXZlbnQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RFcnJvckV2ZW50LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfcGFyc2VSZXNwb25zZUhlYWRlcnMoKTsKICAgICAgUmVxdWVzdEVycm9yRXZlbnQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9ICJSZXF1ZXN0IGhhcyBmYWlsZWQuIjsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuc3RhdHVzQ29kZSkpIHsKICAgICAgICAgIHN0ciArPSBgIFN0YXR1cyBDb2RlOiAke3RoaXMuc3RhdHVzQ29kZX1gOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgICB9OwogICAgICBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0ID0gUmVxdWVzdEVycm9yRXZlbnQ7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FdmVudC5qcwogIGZ1bmN0aW9uIEV2ZW50KCkgewogICAgdGhpcy5fbGlzdGVuZXJzID0gW107CiAgICB0aGlzLl9zY29wZXMgPSBbXTsKICAgIHRoaXMuX3RvUmVtb3ZlID0gW107CiAgICB0aGlzLl9pbnNpZGVSYWlzZUV2ZW50ID0gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGNvbXBhcmVOdW1iZXIoYTMsIGIpIHsKICAgIHJldHVybiBiIC0gYTM7CiAgfQogIHZhciBFdmVudF9kZWZhdWx0OwogIHZhciBpbml0X0V2ZW50ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FdmVudC5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEV2ZW50LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgbGlzdGVuZXJzIGN1cnJlbnRseSBzdWJzY3JpYmVkIHRvIHRoZSBldmVudC4KICAgICAgICAgKiBAbWVtYmVyb2YgRXZlbnQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBudW1iZXJPZkxpc3RlbmVyczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xpc3RlbmVycy5sZW5ndGggLSB0aGlzLl90b1JlbW92ZS5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgRXZlbnQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihsaXN0ZW5lciwgc2NvcGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJsaXN0ZW5lciIsIGxpc3RlbmVyKTsKICAgICAgICB0aGlzLl9saXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgICAgdGhpcy5fc2NvcGVzLnB1c2goc2NvcGUpOwogICAgICAgIGNvbnN0IGV2ZW50ID0gdGhpczsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICBldmVudC5yZW1vdmVFdmVudExpc3RlbmVyKGxpc3RlbmVyLCBzY29wZSk7CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgRXZlbnQucHJvdG90eXBlLnJlbW92ZUV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihsaXN0ZW5lciwgc2NvcGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJsaXN0ZW5lciIsIGxpc3RlbmVyKTsKICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICAgICAgY29uc3Qgc2NvcGVzID0gdGhpcy5fc2NvcGVzOwogICAgICAgIGxldCBpbmRleCA9IC0xOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdGVuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBsaXN0ZW5lciAmJiBzY29wZXNbaV0gPT09IHNjb3BlKSB7CiAgICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgIGlmICh0aGlzLl9pbnNpZGVSYWlzZUV2ZW50KSB7CiAgICAgICAgICAgIHRoaXMuX3RvUmVtb3ZlLnB1c2goaW5kZXgpOwogICAgICAgICAgICBsaXN0ZW5lcnNbaW5kZXhdID0gdm9pZCAwOwogICAgICAgICAgICBzY29wZXNbaW5kZXhdID0gdm9pZCAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIHNjb3Blcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgICAgRXZlbnQucHJvdG90eXBlLnJhaXNlRXZlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9pbnNpZGVSYWlzZUV2ZW50ID0gdHJ1ZTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICAgICAgY29uc3Qgc2NvcGVzID0gdGhpcy5fc2NvcGVzOwogICAgICAgIGxldCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgbGlzdGVuZXIgPSBsaXN0ZW5lcnNbaV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxpc3RlbmVyKSkgewogICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkoc2NvcGVzW2ldLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB0b1JlbW92ZSA9IHRoaXMuX3RvUmVtb3ZlOwogICAgICAgIGxlbmd0aCA9IHRvUmVtb3ZlLmxlbmd0aDsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgdG9SZW1vdmUuc29ydChjb21wYXJlTnVtYmVyKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBpbmRleCA9IHRvUmVtb3ZlW2ldOwogICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgc2NvcGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICB9CiAgICAgICAgICB0b1JlbW92ZS5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICB0aGlzLl9pbnNpZGVSYWlzZUV2ZW50ID0gZmFsc2U7CiAgICAgIH07CiAgICAgIEV2ZW50X2RlZmF1bHQgPSBFdmVudDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0hlYXAuanMKICBmdW5jdGlvbiBIZWFwKG9wdGlvbnMpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucyIsIG9wdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLmNvbXBhcmF0b3IiLCBvcHRpb25zLmNvbXBhcmF0b3IpOwogICAgdGhpcy5fY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX2FycmF5ID0gW107CiAgICB0aGlzLl9sZW5ndGggPSAwOwogICAgdGhpcy5fbWF4aW11bUxlbmd0aCA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gc3dhcChhcnJheSwgYTMsIGIpIHsKICAgIGNvbnN0IHRlbXAgPSBhcnJheVthM107CiAgICBhcnJheVthM10gPSBhcnJheVtiXTsKICAgIGFycmF5W2JdID0gdGVtcDsKICB9CiAgdmFyIEhlYXBfZGVmYXVsdDsKICB2YXIgaW5pdF9IZWFwID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9IZWFwLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoSGVhcC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBsZW5ndGggb2YgdGhlIGhlYXAuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgSGVhcC5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaW50ZXJuYWwgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgSGVhcC5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBpbnRlcm5hbEFycmF5OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fYXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGFuZCBzZXRzIHRoZSBtYXhpbXVtIGxlbmd0aCBvZiB0aGUgaGVhcC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBIZWFwLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICBtYXhpbXVtTGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWF4aW11bUxlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJtYXhpbXVtTGVuZ3RoIiwgdmFsdWUsIDApOwogICAgICAgICAgICBjb25zdCBvcmlnaW5hbExlbmd0aCA9IHRoaXMuX2xlbmd0aDsKICAgICAgICAgICAgaWYgKHZhbHVlIDwgb3JpZ2luYWxMZW5ndGgpIHsKICAgICAgICAgICAgICBjb25zdCBhcnJheSA9IHRoaXMuX2FycmF5OwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSB2YWx1ZTsgaSA8IG9yaWdpbmFsTGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGFycmF5W2ldID0gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9sZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgICBhcnJheS5sZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXhpbXVtTGVuZ3RoID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgY29tcGFyYXRvciB0byB1c2UgZm9yIHRoZSBoZWFwLiBJZiBjb21wYXJhdG9yKGEsIGIpIGlzIGxlc3MgdGhhbiAwLCBzb3J0IGEgdG8gYSBsb3dlciBpbmRleCB0aGFuIGIsIG90aGVyd2lzZSBzb3J0IHRvIGEgaGlnaGVyIGluZGV4LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIEhlYXAucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7SGVhcC5Db21wYXJhdG9yQ2FsbGJhY2t9CiAgICAgICAgICovCiAgICAgICAgY29tcGFyYXRvcjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbXBhcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgSGVhcC5wcm90b3R5cGUucmVzZXJ2ZSA9IGZ1bmN0aW9uKGxlbmd0aCkgewogICAgICAgIGxlbmd0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGxlbmd0aCwgdGhpcy5fbGVuZ3RoKTsKICAgICAgICB0aGlzLl9hcnJheS5sZW5ndGggPSBsZW5ndGg7CiAgICAgIH07CiAgICAgIEhlYXAucHJvdG90eXBlLmhlYXBpZnkgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgIGluZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaW5kZXgsIDApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuX2xlbmd0aDsKICAgICAgICBjb25zdCBjb21wYXJhdG9yID0gdGhpcy5fY29tcGFyYXRvcjsKICAgICAgICBjb25zdCBhcnJheSA9IHRoaXMuX2FycmF5OwogICAgICAgIGxldCBjYW5kaWRhdGUgPSAtMTsKICAgICAgICBsZXQgaW5zZXJ0aW5nID0gdHJ1ZTsKICAgICAgICB3aGlsZSAoaW5zZXJ0aW5nKSB7CiAgICAgICAgICBjb25zdCByaWdodCA9IDIgKiAoaW5kZXggKyAxKTsKICAgICAgICAgIGNvbnN0IGxlZnQgPSByaWdodCAtIDE7CiAgICAgICAgICBpZiAobGVmdCA8IGxlbmd0aCAmJiBjb21wYXJhdG9yKGFycmF5W2xlZnRdLCBhcnJheVtpbmRleF0pIDwgMCkgewogICAgICAgICAgICBjYW5kaWRhdGUgPSBsZWZ0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2FuZGlkYXRlID0gaW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmlnaHQgPCBsZW5ndGggJiYgY29tcGFyYXRvcihhcnJheVtyaWdodF0sIGFycmF5W2NhbmRpZGF0ZV0pIDwgMCkgewogICAgICAgICAgICBjYW5kaWRhdGUgPSByaWdodDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjYW5kaWRhdGUgIT09IGluZGV4KSB7CiAgICAgICAgICAgIHN3YXAoYXJyYXksIGNhbmRpZGF0ZSwgaW5kZXgpOwogICAgICAgICAgICBpbmRleCA9IGNhbmRpZGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluc2VydGluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgSGVhcC5wcm90b3R5cGUucmVzb3J0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fbGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSBNYXRoLmNlaWwobGVuZ3RoIC8gMik7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICB0aGlzLmhlYXBpZnkoaSk7CiAgICAgICAgfQogICAgICB9OwogICAgICBIZWFwLnByb3RvdHlwZS5pbnNlcnQgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJlbGVtZW50IiwgZWxlbWVudCk7CiAgICAgICAgY29uc3QgYXJyYXkgPSB0aGlzLl9hcnJheTsKICAgICAgICBjb25zdCBjb21wYXJhdG9yID0gdGhpcy5fY29tcGFyYXRvcjsKICAgICAgICBjb25zdCBtYXhpbXVtTGVuZ3RoID0gdGhpcy5fbWF4aW11bUxlbmd0aDsKICAgICAgICBsZXQgaW5kZXggPSB0aGlzLl9sZW5ndGgrKzsKICAgICAgICBpZiAoaW5kZXggPCBhcnJheS5sZW5ndGgpIHsKICAgICAgICAgIGFycmF5W2luZGV4XSA9IGVsZW1lbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFycmF5LnB1c2goZWxlbWVudCk7CiAgICAgICAgfQogICAgICAgIHdoaWxlIChpbmRleCAhPT0gMCkgewogICAgICAgICAgY29uc3QgcGFyZW50ID0gTWF0aC5mbG9vcigoaW5kZXggLSAxKSAvIDIpOwogICAgICAgICAgaWYgKGNvbXBhcmF0b3IoYXJyYXlbaW5kZXhdLCBhcnJheVtwYXJlbnRdKSA8IDApIHsKICAgICAgICAgICAgc3dhcChhcnJheSwgaW5kZXgsIHBhcmVudCk7CiAgICAgICAgICAgIGluZGV4ID0gcGFyZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCByZW1vdmVkRWxlbWVudDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1heGltdW1MZW5ndGgpICYmIHRoaXMuX2xlbmd0aCA+IG1heGltdW1MZW5ndGgpIHsKICAgICAgICAgIHJlbW92ZWRFbGVtZW50ID0gYXJyYXlbbWF4aW11bUxlbmd0aF07CiAgICAgICAgICB0aGlzLl9sZW5ndGggPSBtYXhpbXVtTGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVtb3ZlZEVsZW1lbnQ7CiAgICAgIH07CiAgICAgIEhlYXAucHJvdG90eXBlLnBvcCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgaW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChpbmRleCwgMCk7CiAgICAgICAgaWYgKHRoaXMuX2xlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuKCJpbmRleCIsIGluZGV4LCB0aGlzLl9sZW5ndGgpOwogICAgICAgIGNvbnN0IGFycmF5ID0gdGhpcy5fYXJyYXk7CiAgICAgICAgY29uc3Qgcm9vdCA9IGFycmF5W2luZGV4XTsKICAgICAgICBzd2FwKGFycmF5LCBpbmRleCwgLS10aGlzLl9sZW5ndGgpOwogICAgICAgIHRoaXMuaGVhcGlmeShpbmRleCk7CiAgICAgICAgYXJyYXlbdGhpcy5fbGVuZ3RoXSA9IHZvaWQgMDsKICAgICAgICByZXR1cm4gcm9vdDsKICAgICAgfTsKICAgICAgSGVhcF9kZWZhdWx0ID0gSGVhcDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RTY2hlZHVsZXIuanMKICBmdW5jdGlvbiBzb3J0UmVxdWVzdHMoYTMsIGIpIHsKICAgIHJldHVybiBhMy5wcmlvcml0eSAtIGIucHJpb3JpdHk7CiAgfQogIGZ1bmN0aW9uIFJlcXVlc3RTY2hlZHVsZXIoKSB7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZVByaW9yaXR5KHJlcXVlc3QpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVxdWVzdC5wcmlvcml0eUZ1bmN0aW9uKSkgewogICAgICByZXF1ZXN0LnByaW9yaXR5ID0gcmVxdWVzdC5wcmlvcml0eUZ1bmN0aW9uKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzc3VlUmVxdWVzdChyZXF1ZXN0KSB7CiAgICBpZiAocmVxdWVzdC5zdGF0ZSA9PT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQpIHsKICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LklTU1VFRDsKICAgICAgcmVxdWVzdC5kZWZlcnJlZCA9IGRlZmVyX2RlZmF1bHQoKTsKICAgIH0KICAgIHJldHVybiByZXF1ZXN0LmRlZmVycmVkLnByb21pc2U7CiAgfQogIGZ1bmN0aW9uIGdldFJlcXVlc3RSZWNlaXZlZEZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgIHJldHVybiBmdW5jdGlvbihyZXN1bHRzKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5DQU5DRUxMRUQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgZGVmZXJyZWQgPSByZXF1ZXN0LmRlZmVycmVkOwogICAgICAtLXN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0czsKICAgICAgLS1udW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbcmVxdWVzdC5zZXJ2ZXJLZXldOwogICAgICByZXF1ZXN0Q29tcGxldGVkRXZlbnQucmFpc2VFdmVudCgpOwogICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuUkVDRUlWRUQ7CiAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBnZXRSZXF1ZXN0RmFpbGVkRnVuY3Rpb24ocmVxdWVzdCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5DQU5DRUxMRUQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgKytzdGF0aXN0aWNzLm51bWJlck9mRmFpbGVkUmVxdWVzdHM7CiAgICAgIC0tc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogICAgICAtLW51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltyZXF1ZXN0LnNlcnZlcktleV07CiAgICAgIHJlcXVlc3RDb21wbGV0ZWRFdmVudC5yYWlzZUV2ZW50KGVycm9yKTsKICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkZBSUxFRDsKICAgICAgcmVxdWVzdC5kZWZlcnJlZC5yZWplY3QoZXJyb3IpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gc3RhcnRSZXF1ZXN0KHJlcXVlc3QpIHsKICAgIGNvbnN0IHByb21pc2UgPSBpc3N1ZVJlcXVlc3QocmVxdWVzdCk7CiAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQUNUSVZFOwogICAgYWN0aXZlUmVxdWVzdHMucHVzaChyZXF1ZXN0KTsKICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogICAgKytzdGF0aXN0aWNzLm51bWJlck9mQWN0aXZlUmVxdWVzdHNFdmVyOwogICAgKytudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbcmVxdWVzdC5zZXJ2ZXJLZXldOwogICAgcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24oKS50aGVuKGdldFJlcXVlc3RSZWNlaXZlZEZ1bmN0aW9uKHJlcXVlc3QpKS5jYXRjaChnZXRSZXF1ZXN0RmFpbGVkRnVuY3Rpb24ocmVxdWVzdCkpOwogICAgcmV0dXJuIHByb21pc2U7CiAgfQogIGZ1bmN0aW9uIGNhbmNlbFJlcXVlc3QocmVxdWVzdCkgewogICAgY29uc3QgYWN0aXZlID0gcmVxdWVzdC5zdGF0ZSA9PT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQUNUSVZFOwogICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkNBTkNFTExFRDsKICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZFJlcXVlc3RzOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXF1ZXN0LmRlZmVycmVkKSkgewogICAgICBjb25zdCBkZWZlcnJlZCA9IHJlcXVlc3QuZGVmZXJyZWQ7CiAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgIGRlZmVycmVkLnJlamVjdCgpOwogICAgfQogICAgaWYgKGFjdGl2ZSkgewogICAgICAtLXN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0czsKICAgICAgLS1udW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbcmVxdWVzdC5zZXJ2ZXJLZXldOwogICAgICArK3N0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0czsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVxdWVzdC5jYW5jZWxGdW5jdGlvbikpIHsKICAgICAgcmVxdWVzdC5jYW5jZWxGdW5jdGlvbigpOwogICAgfQogIH0KICBmdW5jdGlvbiB1cGRhdGVTdGF0aXN0aWNzKCkgewogICAgaWYgKCFSZXF1ZXN0U2NoZWR1bGVyLmRlYnVnU2hvd1N0YXRpc3RpY3MpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0cyA9PT0gMCAmJiBzdGF0aXN0aWNzLmxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzID4gMCkgewogICAgICBpZiAoc3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgYE51bWJlciBvZiBhdHRlbXB0ZWQgcmVxdWVzdHM6ICR7c3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzfWAKICAgICAgICApOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZBdHRlbXB0ZWRSZXF1ZXN0cyA9IDA7CiAgICAgIH0KICAgICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRSZXF1ZXN0cyA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgIGBOdW1iZXIgb2YgY2FuY2VsbGVkIHJlcXVlc3RzOiAke3N0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRSZXF1ZXN0c31gCiAgICAgICAgKTsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkUmVxdWVzdHMgPSAwOwogICAgICB9CiAgICAgIGlmIChzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkQWN0aXZlUmVxdWVzdHMgPiAwKSB7CiAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICBgTnVtYmVyIG9mIGNhbmNlbGxlZCBhY3RpdmUgcmVxdWVzdHM6ICR7c3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZEFjdGl2ZVJlcXVlc3RzfWAKICAgICAgICApOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgIH0KICAgICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0cyA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgIGBOdW1iZXIgb2YgZmFpbGVkIHJlcXVlc3RzOiAke3N0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0c31gCiAgICAgICAgKTsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mRmFpbGVkUmVxdWVzdHMgPSAwOwogICAgICB9CiAgICB9CiAgICBzdGF0aXN0aWNzLmxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzID0gc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzNCwgc3RhdGlzdGljcywgcHJpb3JpdHlIZWFwTGVuZ3RoLCByZXF1ZXN0SGVhcCwgYWN0aXZlUmVxdWVzdHMsIG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlciwgcGFnZVVyaSwgcmVxdWVzdENvbXBsZXRlZEV2ZW50LCBSZXF1ZXN0U2NoZWR1bGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVxdWVzdFNjaGVkdWxlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdFNjaGVkdWxlci5qcyIoKSB7CiAgICAgIGltcG9ydF91cmlqczQgPSBfX3RvRVNNKHJlcXVpcmVfVVJJKCksIDEpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmZXIoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRXZlbnQoKTsKICAgICAgaW5pdF9IZWFwKCk7CiAgICAgIGluaXRfaXNCbG9iVXJpKCk7CiAgICAgIGluaXRfaXNEYXRhVXJpKCk7CiAgICAgIGluaXRfUmVxdWVzdFN0YXRlKCk7CiAgICAgIHN0YXRpc3RpY3MgPSB7CiAgICAgICAgbnVtYmVyT2ZBdHRlbXB0ZWRSZXF1ZXN0czogMCwKICAgICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzOiAwLAogICAgICAgIG51bWJlck9mQ2FuY2VsbGVkUmVxdWVzdHM6IDAsCiAgICAgICAgbnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0czogMCwKICAgICAgICBudW1iZXJPZkZhaWxlZFJlcXVlc3RzOiAwLAogICAgICAgIG51bWJlck9mQWN0aXZlUmVxdWVzdHNFdmVyOiAwLAogICAgICAgIGxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzOiAwCiAgICAgIH07CiAgICAgIHByaW9yaXR5SGVhcExlbmd0aCA9IDIwOwogICAgICByZXF1ZXN0SGVhcCA9IG5ldyBIZWFwX2RlZmF1bHQoewogICAgICAgIGNvbXBhcmF0b3I6IHNvcnRSZXF1ZXN0cwogICAgICB9KTsKICAgICAgcmVxdWVzdEhlYXAubWF4aW11bUxlbmd0aCA9IHByaW9yaXR5SGVhcExlbmd0aDsKICAgICAgcmVxdWVzdEhlYXAucmVzZXJ2ZShwcmlvcml0eUhlYXBMZW5ndGgpOwogICAgICBhY3RpdmVSZXF1ZXN0cyA9IFtdOwogICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXIgPSB7fTsKICAgICAgcGFnZVVyaSA9IHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBuZXcgaW1wb3J0X3VyaWpzNC5kZWZhdWx0KGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpIDogbmV3IGltcG9ydF91cmlqczQuZGVmYXVsdCgpOwogICAgICByZXF1ZXN0Q29tcGxldGVkRXZlbnQgPSBuZXcgRXZlbnRfZGVmYXVsdCgpOwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLm1heGltdW1SZXF1ZXN0cyA9IDUwOwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLm1heGltdW1SZXF1ZXN0c1BlclNlcnZlciA9IDE4OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnJlcXVlc3RzQnlTZXJ2ZXIgPSB7fTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci50aHJvdHRsZVJlcXVlc3RzID0gdHJ1ZTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5kZWJ1Z1Nob3dTdGF0aXN0aWNzID0gZmFsc2U7CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdENvbXBsZXRlZEV2ZW50ID0gcmVxdWVzdENvbXBsZXRlZEV2ZW50OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhSZXF1ZXN0U2NoZWR1bGVyLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgc3RhdGlzdGljcyB1c2VkIGJ5IHRoZSByZXF1ZXN0IHNjaGVkdWxlci4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXF1ZXN0U2NoZWR1bGVyCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgc3RhdGlzdGljczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHN0YXRpc3RpY3M7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbWF4aW11bSBzaXplIG9mIHRoZSBwcmlvcml0eSBoZWFwLiBUaGlzIGxpbWl0cyB0aGUgbnVtYmVyIG9mIHJlcXVlc3RzIHRoYXQgYXJlIHNvcnRlZCBieSBwcmlvcml0eS4gT25seSBhcHBsaWVzIHRvIHJlcXVlc3RzIHRoYXQgYXJlIG5vdCB5ZXQgYWN0aXZlLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlcXVlc3RTY2hlZHVsZXIKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGRlZmF1bHQgMjAKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHByaW9yaXR5SGVhcExlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHByaW9yaXR5SGVhcExlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA8IHByaW9yaXR5SGVhcExlbmd0aCkgewogICAgICAgICAgICAgIHdoaWxlIChyZXF1ZXN0SGVhcC5sZW5ndGggPiB2YWx1ZSkgewogICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IHJlcXVlc3RIZWFwLnBvcCgpOwogICAgICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJpb3JpdHlIZWFwTGVuZ3RoID0gdmFsdWU7CiAgICAgICAgICAgIHJlcXVlc3RIZWFwLm1heGltdW1MZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgcmVxdWVzdEhlYXAucmVzZXJ2ZSh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5zZXJ2ZXJIYXNPcGVuU2xvdHMgPSBmdW5jdGlvbihzZXJ2ZXJLZXksIGRlc2lyZWRSZXF1ZXN0cykgewogICAgICAgIGRlc2lyZWRSZXF1ZXN0cyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRlc2lyZWRSZXF1ZXN0cywgMSk7CiAgICAgICAgY29uc3QgbWF4UmVxdWVzdHMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldLAogICAgICAgICAgUmVxdWVzdFNjaGVkdWxlci5tYXhpbXVtUmVxdWVzdHNQZXJTZXJ2ZXIKICAgICAgICApOwogICAgICAgIGNvbnN0IGhhc09wZW5TbG90c1NlcnZlciA9IG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldICsgZGVzaXJlZFJlcXVlc3RzIDw9IG1heFJlcXVlc3RzOwogICAgICAgIHJldHVybiBoYXNPcGVuU2xvdHNTZXJ2ZXI7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIuaGVhcEhhc09wZW5TbG90cyA9IGZ1bmN0aW9uKGRlc2lyZWRSZXF1ZXN0cykgewogICAgICAgIGNvbnN0IGhhc09wZW5TbG90c0hlYXAgPSByZXF1ZXN0SGVhcC5sZW5ndGggKyBkZXNpcmVkUmVxdWVzdHMgPD0gcHJpb3JpdHlIZWFwTGVuZ3RoOwogICAgICAgIHJldHVybiBoYXNPcGVuU2xvdHNIZWFwOwogICAgICB9OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGxldCBpOwogICAgICAgIGxldCByZXF1ZXN0OwogICAgICAgIGxldCByZW1vdmVDb3VudCA9IDA7CiAgICAgICAgY29uc3QgYWN0aXZlTGVuZ3RoID0gYWN0aXZlUmVxdWVzdHMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBhY3RpdmVMZW5ndGg7ICsraSkgewogICAgICAgICAgcmVxdWVzdCA9IGFjdGl2ZVJlcXVlc3RzW2ldOwogICAgICAgICAgaWYgKHJlcXVlc3QuY2FuY2VsbGVkKSB7CiAgICAgICAgICAgIGNhbmNlbFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVxdWVzdC5zdGF0ZSAhPT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQUNUSVZFKSB7CiAgICAgICAgICAgICsrcmVtb3ZlQ291bnQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbW92ZUNvdW50ID4gMCkgewogICAgICAgICAgICBhY3RpdmVSZXF1ZXN0c1tpIC0gcmVtb3ZlQ291bnRdID0gcmVxdWVzdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYWN0aXZlUmVxdWVzdHMubGVuZ3RoIC09IHJlbW92ZUNvdW50OwogICAgICAgIGNvbnN0IGlzc3VlZFJlcXVlc3RzID0gcmVxdWVzdEhlYXAuaW50ZXJuYWxBcnJheTsKICAgICAgICBjb25zdCBpc3N1ZWRMZW5ndGggPSByZXF1ZXN0SGVhcC5sZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlzc3VlZExlbmd0aDsgKytpKSB7CiAgICAgICAgICB1cGRhdGVQcmlvcml0eShpc3N1ZWRSZXF1ZXN0c1tpXSk7CiAgICAgICAgfQogICAgICAgIHJlcXVlc3RIZWFwLnJlc29ydCgpOwogICAgICAgIGNvbnN0IG9wZW5TbG90cyA9IE1hdGgubWF4KAogICAgICAgICAgUmVxdWVzdFNjaGVkdWxlci5tYXhpbXVtUmVxdWVzdHMgLSBhY3RpdmVSZXF1ZXN0cy5sZW5ndGgsCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICBsZXQgZmlsbGVkU2xvdHMgPSAwOwogICAgICAgIHdoaWxlIChmaWxsZWRTbG90cyA8IG9wZW5TbG90cyAmJiByZXF1ZXN0SGVhcC5sZW5ndGggPiAwKSB7CiAgICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdEhlYXAucG9wKCk7CiAgICAgICAgICBpZiAocmVxdWVzdC5jYW5jZWxsZWQpIHsKICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVxdWVzdC50aHJvdHRsZUJ5U2VydmVyICYmICFSZXF1ZXN0U2NoZWR1bGVyLnNlcnZlckhhc09wZW5TbG90cyhyZXF1ZXN0LnNlcnZlcktleSkpIHsKICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBzdGFydFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgICArK2ZpbGxlZFNsb3RzOwogICAgICAgIH0KICAgICAgICB1cGRhdGVTdGF0aXN0aWNzKCk7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIuZ2V0U2VydmVyS2V5ID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yuc3RyaW5nKCJ1cmwiLCB1cmwpOwogICAgICAgIGxldCB1cmkgPSBuZXcgaW1wb3J0X3VyaWpzNC5kZWZhdWx0KHVybCk7CiAgICAgICAgaWYgKHVyaS5zY2hlbWUoKSA9PT0gIiIpIHsKICAgICAgICAgIHVyaSA9IHVyaS5hYnNvbHV0ZVRvKHBhZ2VVcmkpOwogICAgICAgICAgdXJpLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICBsZXQgc2VydmVyS2V5ID0gdXJpLmF1dGhvcml0eSgpOwogICAgICAgIGlmICghLzovLnRlc3Qoc2VydmVyS2V5KSkgewogICAgICAgICAgc2VydmVyS2V5ID0gYCR7c2VydmVyS2V5fToke3VyaS5zY2hlbWUoKSA9PT0gImh0dHBzIiA/ICI0NDMiIDogIjgwIn1gOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbc2VydmVyS2V5XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsZW5ndGgpKSB7CiAgICAgICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbc2VydmVyS2V5XSA9IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXJ2ZXJLZXk7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdCA9IGZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlcXVlc3QiLCByZXF1ZXN0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoInJlcXVlc3QudXJsIiwgcmVxdWVzdC51cmwpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLmZ1bmMoInJlcXVlc3QucmVxdWVzdEZ1bmN0aW9uIiwgcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24pOwogICAgICAgIGlmIChpc0RhdGFVcmlfZGVmYXVsdChyZXF1ZXN0LnVybCkgfHwgaXNCbG9iVXJpX2RlZmF1bHQocmVxdWVzdC51cmwpKSB7CiAgICAgICAgICByZXF1ZXN0Q29tcGxldGVkRXZlbnQucmFpc2VFdmVudCgpOwogICAgICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlJFQ0VJVkVEOwogICAgICAgICAgcmV0dXJuIHJlcXVlc3QucmVxdWVzdEZ1bmN0aW9uKCk7CiAgICAgICAgfQogICAgICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlcXVlc3Quc2VydmVyS2V5KSkgewogICAgICAgICAgcmVxdWVzdC5zZXJ2ZXJLZXkgPSBSZXF1ZXN0U2NoZWR1bGVyLmdldFNlcnZlcktleShyZXF1ZXN0LnVybCk7CiAgICAgICAgfQogICAgICAgIGlmIChSZXF1ZXN0U2NoZWR1bGVyLnRocm90dGxlUmVxdWVzdHMgJiYgcmVxdWVzdC50aHJvdHRsZUJ5U2VydmVyICYmICFSZXF1ZXN0U2NoZWR1bGVyLnNlcnZlckhhc09wZW5TbG90cyhyZXF1ZXN0LnNlcnZlcktleSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghUmVxdWVzdFNjaGVkdWxlci50aHJvdHRsZVJlcXVlc3RzIHx8ICFyZXF1ZXN0LnRocm90dGxlKSB7CiAgICAgICAgICByZXR1cm4gc3RhcnRSZXF1ZXN0KHJlcXVlc3QpOwogICAgICAgIH0KICAgICAgICBpZiAoYWN0aXZlUmVxdWVzdHMubGVuZ3RoID49IFJlcXVlc3RTY2hlZHVsZXIubWF4aW11bVJlcXVlc3RzKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICB1cGRhdGVQcmlvcml0eShyZXF1ZXN0KTsKICAgICAgICBjb25zdCByZW1vdmVkUmVxdWVzdCA9IHJlcXVlc3RIZWFwLmluc2VydChyZXF1ZXN0KTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlbW92ZWRSZXF1ZXN0KSkgewogICAgICAgICAgaWYgKHJlbW92ZWRSZXF1ZXN0ID09PSByZXF1ZXN0KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBjYW5jZWxSZXF1ZXN0KHJlbW92ZWRSZXF1ZXN0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzc3VlUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgfTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5jbGVhckZvclNwZWNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgd2hpbGUgKHJlcXVlc3RIZWFwLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSByZXF1ZXN0SGVhcC5wb3AoKTsKICAgICAgICAgIGNhbmNlbFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFjdGl2ZVJlcXVlc3RzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjYW5jZWxSZXF1ZXN0KGFjdGl2ZVJlcXVlc3RzW2ldKTsKICAgICAgICB9CiAgICAgICAgYWN0aXZlUmVxdWVzdHMubGVuZ3RoID0gMDsKICAgICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXIgPSB7fTsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQXR0ZW1wdGVkUmVxdWVzdHMgPSAwOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZFJlcXVlc3RzID0gMDsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkQWN0aXZlUmVxdWVzdHMgPSAwOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0cyA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzRXZlciA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5sYXN0TnVtYmVyT2ZBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0c0J5U2VydmVyID0gZnVuY3Rpb24oc2VydmVyS2V5KSB7CiAgICAgICAgcmV0dXJuIG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldOwogICAgICB9OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnJlcXVlc3RIZWFwID0gcmVxdWVzdEhlYXA7CiAgICAgIFJlcXVlc3RTY2hlZHVsZXJfZGVmYXVsdCA9IFJlcXVlc3RTY2hlZHVsZXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UcnVzdGVkU2VydmVycy5qcwogIGZ1bmN0aW9uIGdldEF1dGhvcml0eSh1cmwpIHsKICAgIGNvbnN0IHVyaSA9IG5ldyBpbXBvcnRfdXJpanM1LmRlZmF1bHQodXJsKTsKICAgIHVyaS5ub3JtYWxpemUoKTsKICAgIGxldCBhdXRob3JpdHkgPSB1cmkuYXV0aG9yaXR5KCk7CiAgICBpZiAoYXV0aG9yaXR5Lmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgdXJpLmF1dGhvcml0eShhdXRob3JpdHkpOwogICAgaWYgKGF1dGhvcml0eS5pbmRleE9mKCJAIikgIT09IC0xKSB7CiAgICAgIGNvbnN0IHBhcnRzID0gYXV0aG9yaXR5LnNwbGl0KCJAIik7CiAgICAgIGF1dGhvcml0eSA9IHBhcnRzWzFdOwogICAgfQogICAgaWYgKGF1dGhvcml0eS5pbmRleE9mKCI6IikgPT09IC0xKSB7CiAgICAgIGxldCBzY2hlbWUgPSB1cmkuc2NoZW1lKCk7CiAgICAgIGlmIChzY2hlbWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgc2NoZW1lID0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sOwogICAgICAgIHNjaGVtZSA9IHNjaGVtZS5zdWJzdHJpbmcoMCwgc2NoZW1lLmxlbmd0aCAtIDEpOwogICAgICB9CiAgICAgIGlmIChzY2hlbWUgPT09ICJodHRwIikgewogICAgICAgIGF1dGhvcml0eSArPSAiOjgwIjsKICAgICAgfSBlbHNlIGlmIChzY2hlbWUgPT09ICJodHRwcyIpIHsKICAgICAgICBhdXRob3JpdHkgKz0gIjo0NDMiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhdXRob3JpdHk7CiAgfQogIHZhciBpbXBvcnRfdXJpanM1LCBUcnVzdGVkU2VydmVycywgX3NlcnZlcnMsIFRydXN0ZWRTZXJ2ZXJzX2RlZmF1bHQ7CiAgdmFyIGluaXRfVHJ1c3RlZFNlcnZlcnMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RydXN0ZWRTZXJ2ZXJzLmpzIigpIHsKICAgICAgaW1wb3J0X3VyaWpzNSA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIFRydXN0ZWRTZXJ2ZXJzID0ge307CiAgICAgIF9zZXJ2ZXJzID0ge307CiAgICAgIFRydXN0ZWRTZXJ2ZXJzLmFkZCA9IGZ1bmN0aW9uKGhvc3QsIHBvcnQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChob3N0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImhvc3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvcnQpIHx8IHBvcnQgPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvcnQgaXMgcmVxdWlyZWQgdG8gYmUgZ3JlYXRlciB0aGFuIDAuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF1dGhvcml0eSA9IGAke2hvc3QudG9Mb3dlckNhc2UoKX06JHtwb3J0fWA7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoX3NlcnZlcnNbYXV0aG9yaXR5XSkpIHsKICAgICAgICAgIF9zZXJ2ZXJzW2F1dGhvcml0eV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgVHJ1c3RlZFNlcnZlcnMucmVtb3ZlID0gZnVuY3Rpb24oaG9zdCwgcG9ydCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhvc3QpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaG9zdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9ydCkgfHwgcG9ydCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9ydCBpcyByZXF1aXJlZCB0byBiZSBncmVhdGVyIHRoYW4gMC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXV0aG9yaXR5ID0gYCR7aG9zdC50b0xvd2VyQ2FzZSgpfToke3BvcnR9YDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KF9zZXJ2ZXJzW2F1dGhvcml0eV0pKSB7CiAgICAgICAgICBkZWxldGUgX3NlcnZlcnNbYXV0aG9yaXR5XTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFRydXN0ZWRTZXJ2ZXJzLmNvbnRhaW5zID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXJsKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInVybCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXV0aG9yaXR5ID0gZ2V0QXV0aG9yaXR5KHVybCk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChhdXRob3JpdHkpICYmIGRlZmluZWRfZGVmYXVsdChfc2VydmVyc1thdXRob3JpdHldKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgICAgVHJ1c3RlZFNlcnZlcnMuY2xlYXIgPSBmdW5jdGlvbigpIHsKICAgICAgICBfc2VydmVycyA9IHt9OwogICAgICB9OwogICAgICBUcnVzdGVkU2VydmVyc19kZWZhdWx0ID0gVHJ1c3RlZFNlcnZlcnM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXNvdXJjZS5qcwogIGZ1bmN0aW9uIFJlc291cmNlKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIikgewogICAgICBvcHRpb25zID0gewogICAgICAgIHVybDogb3B0aW9ucwogICAgICB9OwogICAgfQogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yuc3RyaW5nKCJvcHRpb25zLnVybCIsIG9wdGlvbnMudXJsKTsKICAgIHRoaXMuX3VybCA9IHZvaWQgMDsKICAgIHRoaXMuX3RlbXBsYXRlVmFsdWVzID0gZGVmYXVsdENsb25lKG9wdGlvbnMudGVtcGxhdGVWYWx1ZXMsIHt9KTsKICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IGRlZmF1bHRDbG9uZShvcHRpb25zLnF1ZXJ5UGFyYW1ldGVycywge30pOwogICAgdGhpcy5oZWFkZXJzID0gZGVmYXVsdENsb25lKG9wdGlvbnMuaGVhZGVycywge30pOwogICAgdGhpcy5yZXF1ZXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yZXF1ZXN0LCBuZXcgUmVxdWVzdF9kZWZhdWx0KCkpOwogICAgdGhpcy5wcm94eSA9IG9wdGlvbnMucHJveHk7CiAgICB0aGlzLnJldHJ5Q2FsbGJhY2sgPSBvcHRpb25zLnJldHJ5Q2FsbGJhY2s7CiAgICB0aGlzLnJldHJ5QXR0ZW1wdHMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJldHJ5QXR0ZW1wdHMsIDApOwogICAgdGhpcy5fcmV0cnlDb3VudCA9IDA7CiAgICBjb25zdCBwYXJzZVVybCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucGFyc2VVcmwsIHRydWUpOwogICAgaWYgKHBhcnNlVXJsKSB7CiAgICAgIHRoaXMucGFyc2VVcmwob3B0aW9ucy51cmwsIHRydWUsIHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdXJsID0gb3B0aW9ucy51cmw7CiAgICB9CiAgICB0aGlzLl9jcmVkaXRzID0gb3B0aW9ucy5jcmVkaXRzOwogIH0KICBmdW5jdGlvbiBkZWZhdWx0Q2xvbmUodmFsdWUsIGRlZmF1bHRWYWx1ZTIpIHsKICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQodmFsdWUpID8gY2xvbmVfZGVmYXVsdCh2YWx1ZSkgOiBkZWZhdWx0VmFsdWUyOwogIH0KICBmdW5jdGlvbiBwYXJzZVF1ZXJ5U3RyaW5nKHF1ZXJ5U3RyaW5nKSB7CiAgICBpZiAocXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB7fTsKICAgIH0KICAgIGlmIChxdWVyeVN0cmluZy5pbmRleE9mKCI9IikgPT09IC0xKSB7CiAgICAgIHJldHVybiB7IFtxdWVyeVN0cmluZ106IHZvaWQgMCB9OwogICAgfQogICAgcmV0dXJuIHF1ZXJ5VG9PYmplY3RfZGVmYXVsdChxdWVyeVN0cmluZyk7CiAgfQogIGZ1bmN0aW9uIGNvbWJpbmVRdWVyeVBhcmFtZXRlcnMocTEyLCBxMjIsIHByZXNlcnZlUXVlcnlQYXJhbWV0ZXJzKSB7CiAgICBpZiAoIXByZXNlcnZlUXVlcnlQYXJhbWV0ZXJzKSB7CiAgICAgIHJldHVybiBjb21iaW5lX2RlZmF1bHQocTEyLCBxMjIpOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0gY2xvbmVfZGVmYXVsdChxMTIsIHRydWUpOwogICAgZm9yIChjb25zdCBwYXJhbSBpbiBxMjIpIHsKICAgICAgaWYgKHEyMi5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHsKICAgICAgICBsZXQgdmFsdWUgPSByZXN1bHRbcGFyYW1dOwogICAgICAgIGNvbnN0IHEyVmFsdWUgPSBxMjJbcGFyYW1dOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIHZhbHVlID0gcmVzdWx0W3BhcmFtXSA9IFt2YWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRbcGFyYW1dID0gdmFsdWUuY29uY2F0KHEyVmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHRbcGFyYW1dID0gQXJyYXkuaXNBcnJheShxMlZhbHVlKSA/IHEyVmFsdWUuc2xpY2UoKSA6IHEyVmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBzdHJpbmdpZnlRdWVyeShxdWVyeU9iamVjdCkgewogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHF1ZXJ5T2JqZWN0KTsKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDEgJiYgIWRlZmluZWRfZGVmYXVsdChxdWVyeU9iamVjdFtrZXlzWzBdXSkpIHsKICAgICAgcmV0dXJuIGA/JHtrZXlzWzBdfWA7CiAgICB9CiAgICByZXR1cm4gYD8ke29iamVjdFRvUXVlcnlfZGVmYXVsdChxdWVyeU9iamVjdCl9YDsKICB9CiAgZnVuY3Rpb24gZmV0Y2hJbWFnZShvcHRpb25zKSB7CiAgICBjb25zdCByZXNvdXJjZSA9IG9wdGlvbnMucmVzb3VyY2U7CiAgICBjb25zdCBmbGlwWSA9IG9wdGlvbnMuZmxpcFk7CiAgICBjb25zdCBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24gPSBvcHRpb25zLnNraXBDb2xvclNwYWNlQ29udmVyc2lvbjsKICAgIGNvbnN0IHByZWZlckltYWdlQml0bWFwID0gb3B0aW9ucy5wcmVmZXJJbWFnZUJpdG1hcDsKICAgIGNvbnN0IHJlcXVlc3QgPSByZXNvdXJjZS5yZXF1ZXN0OwogICAgcmVxdWVzdC51cmwgPSByZXNvdXJjZS51cmw7CiAgICByZXF1ZXN0LnJlcXVlc3RGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICBsZXQgY3Jvc3NPcmlnaW4gPSBmYWxzZTsKICAgICAgaWYgKCFyZXNvdXJjZS5pc0RhdGFVcmkgJiYgIXJlc291cmNlLmlzQmxvYlVyaSkgewogICAgICAgIGNyb3NzT3JpZ2luID0gcmVzb3VyY2UuaXNDcm9zc09yaWdpblVybDsKICAgICAgfQogICAgICBjb25zdCBkZWZlcnJlZCA9IGRlZmVyX2RlZmF1bHQoKTsKICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5jcmVhdGVJbWFnZSgKICAgICAgICByZXF1ZXN0LAogICAgICAgIGNyb3NzT3JpZ2luLAogICAgICAgIGRlZmVycmVkLAogICAgICAgIGZsaXBZLAogICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcAogICAgICApOwogICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgIH07CiAgICBjb25zdCBwcm9taXNlID0gUmVxdWVzdFNjaGVkdWxlcl9kZWZhdWx0LnJlcXVlc3QocmVxdWVzdCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9taXNlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gcHJvbWlzZS5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlICE9PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5GQUlMRUQpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc291cmNlLnJldHJ5T25FcnJvcihlKS50aGVuKGZ1bmN0aW9uKHJldHJ5KSB7CiAgICAgICAgaWYgKHJldHJ5KSB7CiAgICAgICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICAgICAgICByZXF1ZXN0LmRlZmVycmVkID0gdm9pZCAwOwogICAgICAgICAgcmV0dXJuIGZldGNoSW1hZ2UoewogICAgICAgICAgICByZXNvdXJjZSwKICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgICAgcHJlZmVySW1hZ2VCaXRtYXAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgIH0pOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGZldGNoSnNvbnAocmVzb3VyY2UsIGNhbGxiYWNrUGFyYW1ldGVyTmFtZSwgZnVuY3Rpb25OYW1lKSB7CiAgICBjb25zdCBjYWxsYmFja1F1ZXJ5ID0ge307CiAgICBjYWxsYmFja1F1ZXJ5W2NhbGxiYWNrUGFyYW1ldGVyTmFtZV0gPSBmdW5jdGlvbk5hbWU7CiAgICByZXNvdXJjZS5zZXRRdWVyeVBhcmFtZXRlcnMoY2FsbGJhY2tRdWVyeSk7CiAgICBjb25zdCByZXF1ZXN0ID0gcmVzb3VyY2UucmVxdWVzdDsKICAgIGNvbnN0IHVybCA9IHJlc291cmNlLnVybDsKICAgIHJlcXVlc3QudXJsID0gdXJsOwogICAgcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgY29uc3QgZGVmZXJyZWQgPSBkZWZlcl9kZWZhdWx0KCk7CiAgICAgIHdpbmRvd1tmdW5jdGlvbk5hbWVdID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGRlZmVycmVkLnJlc29sdmUoZGF0YSk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGRlbGV0ZSB3aW5kb3dbZnVuY3Rpb25OYW1lXTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB3aW5kb3dbZnVuY3Rpb25OYW1lXSA9IHZvaWQgMDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZEFuZEV4ZWN1dGVTY3JpcHQodXJsLCBmdW5jdGlvbk5hbWUsIGRlZmVycmVkKTsKICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICB9OwogICAgY29uc3QgcHJvbWlzZSA9IFJlcXVlc3RTY2hlZHVsZXJfZGVmYXVsdC5yZXF1ZXN0KHJlcXVlc3QpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJvbWlzZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0dXJuIHByb21pc2UuY2F0Y2goZnVuY3Rpb24oZSkgewogICAgICBpZiAocmVxdWVzdC5zdGF0ZSAhPT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuRkFJTEVEKSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGUpOwogICAgICB9CiAgICAgIHJldHVybiByZXNvdXJjZS5yZXRyeU9uRXJyb3IoZSkudGhlbihmdW5jdGlvbihyZXRyeSkgewogICAgICAgIGlmIChyZXRyeSkgewogICAgICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlVOSVNTVUVEOwogICAgICAgICAgcmVxdWVzdC5kZWZlcnJlZCA9IHZvaWQgMDsKICAgICAgICAgIHJldHVybiBmZXRjaEpzb25wKHJlc291cmNlLCBjYWxsYmFja1BhcmFtZXRlck5hbWUsIGZ1bmN0aW9uTmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTsKICAgICAgfSk7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gY2hlY2tBbmRSZXNldFJlcXVlc3QocmVxdWVzdCkgewogICAgaWYgKHJlcXVlc3Quc3RhdGUgPT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LklTU1VFRCB8fCByZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5BQ1RJVkUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJUaGUgUmVzb3VyY2UgaXMgYWxyZWFkeSBiZWluZyBmZXRjaGVkLiIpOwogICAgfQogICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlVOSVNTVUVEOwogICAgcmVxdWVzdC5kZWZlcnJlZCA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRGF0YVVyaVRleHQoaXNCYXNlNjQsIGRhdGEpIHsKICAgIGNvbnN0IHJlc3VsdCA9IGRlY29kZVVSSUNvbXBvbmVudChkYXRhKTsKICAgIGlmIChpc0Jhc2U2NCkgewogICAgICByZXR1cm4gYXRvYihyZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRGF0YVVyaUFycmF5QnVmZmVyKGlzQmFzZTY0LCBkYXRhKSB7CiAgICBjb25zdCBieXRlU3RyaW5nID0gZGVjb2RlRGF0YVVyaVRleHQoaXNCYXNlNjQsIGRhdGEpOwogICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKGJ5dGVTdHJpbmcubGVuZ3RoKTsKICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBieXRlU3RyaW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZpZXdbaV0gPSBieXRlU3RyaW5nLmNoYXJDb2RlQXQoaSk7CiAgICB9CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICBmdW5jdGlvbiBkZWNvZGVEYXRhVXJpKGRhdGFVcmlSZWdleFJlc3VsdCwgcmVzcG9uc2VUeXBlKSB7CiAgICByZXNwb25zZVR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChyZXNwb25zZVR5cGUsICIiKTsKICAgIGNvbnN0IG1pbWVUeXBlID0gZGF0YVVyaVJlZ2V4UmVzdWx0WzFdOwogICAgY29uc3QgaXNCYXNlNjQgPSAhIWRhdGFVcmlSZWdleFJlc3VsdFsyXTsKICAgIGNvbnN0IGRhdGEgPSBkYXRhVXJpUmVnZXhSZXN1bHRbM107CiAgICBsZXQgYnVmZmVyOwogICAgbGV0IHBhcnNlcjsKICAgIHN3aXRjaCAocmVzcG9uc2VUeXBlKSB7CiAgICAgIGNhc2UgIiI6CiAgICAgIGNhc2UgInRleHQiOgogICAgICAgIHJldHVybiBkZWNvZGVEYXRhVXJpVGV4dChpc0Jhc2U2NCwgZGF0YSk7CiAgICAgIGNhc2UgImFycmF5YnVmZmVyIjoKICAgICAgICByZXR1cm4gZGVjb2RlRGF0YVVyaUFycmF5QnVmZmVyKGlzQmFzZTY0LCBkYXRhKTsKICAgICAgY2FzZSAiYmxvYiI6CiAgICAgICAgYnVmZmVyID0gZGVjb2RlRGF0YVVyaUFycmF5QnVmZmVyKGlzQmFzZTY0LCBkYXRhKTsKICAgICAgICByZXR1cm4gbmV3IEJsb2IoW2J1ZmZlcl0sIHsKICAgICAgICAgIHR5cGU6IG1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIGNhc2UgImRvY3VtZW50IjoKICAgICAgICBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgcmV0dXJuIHBhcnNlci5wYXJzZUZyb21TdHJpbmcoCiAgICAgICAgICBkZWNvZGVEYXRhVXJpVGV4dChpc0Jhc2U2NCwgZGF0YSksCiAgICAgICAgICBtaW1lVHlwZQogICAgICAgICk7CiAgICAgIGNhc2UgImpzb24iOgogICAgICAgIHJldHVybiBKU09OLnBhcnNlKGRlY29kZURhdGFVcmlUZXh0KGlzQmFzZTY0LCBkYXRhKSk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoYFVuaGFuZGxlZCByZXNwb25zZVR5cGU6ICR7cmVzcG9uc2VUeXBlfWApOwogICAgfQogIH0KICBmdW5jdGlvbiBsb2FkV2l0aEh0dHBSZXF1ZXN0KHVybCwgcmVzcG9uc2VUeXBlLCBtZXRob2QsIGRhdGEsIGhlYWRlcnMsIGRlZmVycmVkLCBvdmVycmlkZU1pbWVUeXBlKSB7CiAgICBmZXRjaCh1cmwsIHsKICAgICAgbWV0aG9kLAogICAgICBoZWFkZXJzCiAgICB9KS50aGVuKGFzeW5jIChyZXNwb25zZSkgPT4gewogICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7CiAgICAgICAgY29uc3QgcmVzcG9uc2VIZWFkZXJzID0ge307CiAgICAgICAgcmVzcG9uc2UuaGVhZGVycy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7CiAgICAgICAgICByZXNwb25zZUhlYWRlcnNba2V5XSA9IHZhbHVlOwogICAgICAgIH0pOwogICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgIG5ldyBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0KHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykKICAgICAgICApOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzd2l0Y2ggKHJlc3BvbnNlVHlwZSkgewogICAgICAgIGNhc2UgInRleHQiOgogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXNwb25zZS50ZXh0KCkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAianNvbiI6CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3BvbnNlLmpzb24oKSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShuZXcgVWludDhBcnJheShhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpKS5idWZmZXIpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0pLmNhdGNoKCgpID0+IHsKICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0KCkpOwogICAgfSk7CiAgfQogIHZhciBpbXBvcnRfdXJpanM2LCB4aHJCbG9iU3VwcG9ydGVkLCBzdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9uc1Byb21pc2UsIGRhdGFVcmlSZWdleDIsIG5vWE1MSHR0cFJlcXVlc3QsIFJlc291cmNlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVzb3VyY2UgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1Jlc291cmNlLmpzIigpIHsKICAgICAgaW1wb3J0X3VyaWpzNiA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfYXBwZW5kRm9yd2FyZFNsYXNoKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9jbG9uZSgpOwogICAgICBpbml0X2NvbWJpbmUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZlcigpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2dldEFic29sdXRlVXJpKCk7CiAgICAgIGluaXRfZ2V0QmFzZVVyaSgpOwogICAgICBpbml0X2dldEV4dGVuc2lvbkZyb21VcmkoKTsKICAgICAgaW5pdF9nZXRJbWFnZVBpeGVscygpOwogICAgICBpbml0X2lzQmxvYlVyaSgpOwogICAgICBpbml0X2lzQ3Jvc3NPcmlnaW5VcmwoKTsKICAgICAgaW5pdF9pc0RhdGFVcmkoKTsKICAgICAgaW5pdF9sb2FkQW5kRXhlY3V0ZVNjcmlwdCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9vYmplY3RUb1F1ZXJ5KCk7CiAgICAgIGluaXRfcXVlcnlUb09iamVjdCgpOwogICAgICBpbml0X1JlcXVlc3QoKTsKICAgICAgaW5pdF9SZXF1ZXN0RXJyb3JFdmVudCgpOwogICAgICBpbml0X1JlcXVlc3RTY2hlZHVsZXIoKTsKICAgICAgaW5pdF9SZXF1ZXN0U3RhdGUoKTsKICAgICAgaW5pdF9SdW50aW1lRXJyb3IoKTsKICAgICAgaW5pdF9UcnVzdGVkU2VydmVycygpOwogICAgICB4aHJCbG9iU3VwcG9ydGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgeGhyLm9wZW4oIkdFVCIsICIjIiwgdHJ1ZSk7CiAgICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gImJsb2IiOwogICAgICAgICAgcmV0dXJuIHhoci5yZXNwb25zZVR5cGUgPT09ICJibG9iIjsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9KCk7CiAgICAgIFJlc291cmNlLmNyZWF0ZUlmTmVlZGVkID0gZnVuY3Rpb24ocmVzb3VyY2UpIHsKICAgICAgICBpZiAocmVzb3VyY2UgaW5zdGFuY2VvZiBSZXNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHJlc291cmNlLmdldERlcml2ZWRSZXNvdXJjZSh7CiAgICAgICAgICAgIHJlcXVlc3Q6IHJlc291cmNlLnJlcXVlc3QKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHJlc291cmNlICE9PSAic3RyaW5nIikgewogICAgICAgICAgcmV0dXJuIHJlc291cmNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFJlc291cmNlKHsKICAgICAgICAgIHVybDogcmVzb3VyY2UKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2Uuc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnMgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybiBzdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9uc1Byb21pc2U7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgY3JlYXRlSW1hZ2VCaXRtYXAgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZShmYWxzZSk7CiAgICAgICAgICByZXR1cm4gc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnNQcm9taXNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbWFnZURhdGFVcmkgPSAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FJQUFBQ1FkMVBlQUFBQUJHZEJUVUVBQUU0ZzNyRWlEZ0FBQUNCalNGSk5BQUI2SmdBQWdJUUFBUG9BQUFDQTZBQUFkVEFBQU9wZ0FBQTZtQUFBRjNDY3VsRThBQUFBREVsRVFWUUkxMk5nNkdBQUFBRVVBSW5nRTNaaUFBQUFBRWxGVGtTdVFtQ0MiOwogICAgICAgIHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSA9IFJlc291cmNlLmZldGNoQmxvYih7CiAgICAgICAgICB1cmw6IGltYWdlRGF0YVVyaQogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oYmxvYikgewogICAgICAgICAgY29uc3QgaW1hZ2VCaXRtYXBPcHRpb25zID0gewogICAgICAgICAgICBpbWFnZU9yaWVudGF0aW9uOiAiZmxpcFkiLAogICAgICAgICAgICAvLyBkZWZhdWx0IGlzICJub25lIgogICAgICAgICAgICBwcmVtdWx0aXBseUFscGhhOiAibm9uZSIsCiAgICAgICAgICAgIC8vIGRlZmF1bHQgaXMgImRlZmF1bHQiCiAgICAgICAgICAgIGNvbG9yU3BhY2VDb252ZXJzaW9uOiAibm9uZSIKICAgICAgICAgICAgLy8gZGVmYXVsdCBpcyAiZGVmYXVsdCIKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoWwogICAgICAgICAgICBjcmVhdGVJbWFnZUJpdG1hcChibG9iLCBpbWFnZUJpdG1hcE9wdGlvbnMpLAogICAgICAgICAgICBjcmVhdGVJbWFnZUJpdG1hcChibG9iKQogICAgICAgICAgXSk7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbihpbWFnZUJpdG1hcHMpIHsKICAgICAgICAgIGNvbnN0IGNvbG9yV2l0aE9wdGlvbnMgPSBnZXRJbWFnZVBpeGVsc19kZWZhdWx0KGltYWdlQml0bWFwc1swXSk7CiAgICAgICAgICBjb25zdCBjb2xvcldpdGhEZWZhdWx0cyA9IGdldEltYWdlUGl4ZWxzX2RlZmF1bHQoaW1hZ2VCaXRtYXBzWzFdKTsKICAgICAgICAgIHJldHVybiBjb2xvcldpdGhPcHRpb25zWzFdICE9PSBjb2xvcldpdGhEZWZhdWx0c1sxXTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnNQcm9taXNlOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhSZXNvdXJjZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdHJ1ZSBpZiBibG9icyBhcmUgc3VwcG9ydGVkLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICoKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBpc0Jsb2JTdXBwb3J0ZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB4aHJCbG9iU3VwcG9ydGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFJlc291cmNlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFF1ZXJ5IHBhcmFtZXRlcnMgYXBwZW5kZWQgdG8gdGhlIHVybC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXNvdXJjZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqCiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgcXVlcnlQYXJhbWV0ZXJzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcXVlcnlQYXJhbWV0ZXJzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGtleS92YWx1ZSBwYWlycyB1c2VkIHRvIHJlcGxhY2UgdGVtcGxhdGUgcGFyYW1ldGVycyBpbiB0aGUgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICoKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICB0ZW1wbGF0ZVZhbHVlczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RlbXBsYXRlVmFsdWVzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHVybCB0byB0aGUgcmVzb3VyY2Ugd2l0aCB0ZW1wbGF0ZSB2YWx1ZXMgcmVwbGFjZWQsIHF1ZXJ5IHN0cmluZyBhcHBlbmRlZCBhbmQgZW5jb2RlZCBieSBwcm94eSBpZiBvbmUgd2FzIHNldC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXNvdXJjZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHVybDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXJsQ29tcG9uZW50KHRydWUsIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5wYXJzZVVybCh2YWx1ZSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBmaWxlIGV4dGVuc2lvbiBvZiB0aGUgcmVzb3VyY2UuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKgogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGV4dGVuc2lvbjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEV4dGVuc2lvbkZyb21VcmlfZGVmYXVsdCh0aGlzLl91cmwpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgUmVzb3VyY2UgcmVmZXJzIHRvIGEgZGF0YSBVUkkuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNEYXRhVXJpOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gaXNEYXRhVXJpX2RlZmF1bHQodGhpcy5fdXJsKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIFJlc291cmNlIHJlZmVycyB0byBhIGJsb2IgVVJJLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzQmxvYlVyaTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGlzQmxvYlVyaV9kZWZhdWx0KHRoaXMuX3VybCk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBSZXNvdXJjZSByZWZlcnMgdG8gYSBjcm9zcyBvcmlnaW4gVVJMLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzQ3Jvc3NPcmlnaW5Vcmw6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBpc0Nyb3NzT3JpZ2luVXJsX2RlZmF1bHQodGhpcy5fdXJsKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIFJlc291cmNlIGhhcyByZXF1ZXN0IGhlYWRlcnMuIFRoaXMgaXMgZXF1aXZhbGVudCB0byBjaGVja2luZyBpZiB0aGUgaGVhZGVycyBwcm9wZXJ0eSBoYXMgYW55IGtleXMuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaGFzSGVhZGVyczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuaGVhZGVycykubGVuZ3RoID4gMDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGNyZWRpdHMgcmVxdWlyZWQgZm9yIGF0dHJpYnV0aW9uIG9mIGFuIGFzc2V0LgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgY3JlZGl0czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWRpdHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXJsQ29tcG9uZW50KHRydWUsIHRydWUpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUucGFyc2VVcmwgPSBmdW5jdGlvbih1cmwsIG1lcmdlLCBwcmVzZXJ2ZVF1ZXJ5LCBiYXNlVXJsKSB7CiAgICAgICAgbGV0IHVyaSA9IG5ldyBpbXBvcnRfdXJpanM2LmRlZmF1bHQodXJsKTsKICAgICAgICBjb25zdCBxdWVyeSA9IHBhcnNlUXVlcnlTdHJpbmcodXJpLnF1ZXJ5KCkpOwogICAgICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IG1lcmdlID8gY29tYmluZVF1ZXJ5UGFyYW1ldGVycyhxdWVyeSwgdGhpcy5xdWVyeVBhcmFtZXRlcnMsIHByZXNlcnZlUXVlcnkpIDogcXVlcnk7CiAgICAgICAgdXJpLnNlYXJjaCgiIik7CiAgICAgICAgdXJpLmZyYWdtZW50KCIiKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJhc2VVcmwpICYmIHVyaS5zY2hlbWUoKSA9PT0gIiIpIHsKICAgICAgICAgIHVyaSA9IHVyaS5hYnNvbHV0ZVRvKGdldEFic29sdXRlVXJpX2RlZmF1bHQoYmFzZVVybCkpOwogICAgICAgIH0KICAgICAgICB0aGlzLl91cmwgPSB1cmkudG9TdHJpbmcoKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmdldFVybENvbXBvbmVudCA9IGZ1bmN0aW9uKHF1ZXJ5LCBwcm94eSkgewogICAgICAgIGlmICh0aGlzLmlzRGF0YVVyaSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3VybDsKICAgICAgICB9CiAgICAgICAgbGV0IHVybCA9IHRoaXMuX3VybDsKICAgICAgICBpZiAocXVlcnkpIHsKICAgICAgICAgIHVybCA9IGAke3VybH0ke3N0cmluZ2lmeVF1ZXJ5KHRoaXMucXVlcnlQYXJhbWV0ZXJzKX1gOwogICAgICAgIH0KICAgICAgICB1cmwgPSB1cmwucmVwbGFjZSgvJTdCL2csICJ7IikucmVwbGFjZSgvJTdEL2csICJ9Iik7CiAgICAgICAgY29uc3QgdGVtcGxhdGVWYWx1ZXMgPSB0aGlzLl90ZW1wbGF0ZVZhbHVlczsKICAgICAgICBpZiAoT2JqZWN0LmtleXModGVtcGxhdGVWYWx1ZXMpLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKC97KC4qPyl9L2csIGZ1bmN0aW9uKG1hdGNoLCBrZXkpIHsKICAgICAgICAgICAgY29uc3QgcmVwbGFjZW1lbnQgPSB0ZW1wbGF0ZVZhbHVlc1trZXldOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlcGxhY2VtZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQocmVwbGFjZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAocHJveHkgJiYgZGVmaW5lZF9kZWZhdWx0KHRoaXMucHJveHkpKSB7CiAgICAgICAgICB1cmwgPSB0aGlzLnByb3h5LmdldFVSTCh1cmwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXJsOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuc2V0UXVlcnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFyYW1zLCB1c2VBc0RlZmF1bHQpIHsKICAgICAgICBpZiAodXNlQXNEZWZhdWx0KSB7CiAgICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMgPSBjb21iaW5lUXVlcnlQYXJhbWV0ZXJzKAogICAgICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMsCiAgICAgICAgICAgIHBhcmFtcywKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IGNvbWJpbmVRdWVyeVBhcmFtZXRlcnMoCiAgICAgICAgICAgIHBhcmFtcywKICAgICAgICAgICAgdGhpcy5fcXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5hcHBlbmRRdWVyeVBhcmFtZXRlcnMgPSBmdW5jdGlvbihwYXJhbXMpIHsKICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMgPSBjb21iaW5lUXVlcnlQYXJhbWV0ZXJzKAogICAgICAgICAgcGFyYW1zLAogICAgICAgICAgdGhpcy5fcXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5zZXRUZW1wbGF0ZVZhbHVlcyA9IGZ1bmN0aW9uKHRlbXBsYXRlLCB1c2VBc0RlZmF1bHQpIHsKICAgICAgICBpZiAodXNlQXNEZWZhdWx0KSB7CiAgICAgICAgICB0aGlzLl90ZW1wbGF0ZVZhbHVlcyA9IGNvbWJpbmVfZGVmYXVsdCh0aGlzLl90ZW1wbGF0ZVZhbHVlcywgdGVtcGxhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl90ZW1wbGF0ZVZhbHVlcyA9IGNvbWJpbmVfZGVmYXVsdCh0ZW1wbGF0ZSwgdGhpcy5fdGVtcGxhdGVWYWx1ZXMpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmdldERlcml2ZWRSZXNvdXJjZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IHRoaXMuY2xvbmUoKTsKICAgICAgICByZXNvdXJjZS5fcmV0cnlDb3VudCA9IDA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnVybCkpIHsKICAgICAgICAgIGNvbnN0IHByZXNlcnZlUXVlcnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnByZXNlcnZlUXVlcnlQYXJhbWV0ZXJzLCBmYWxzZSk7CiAgICAgICAgICByZXNvdXJjZS5wYXJzZVVybChvcHRpb25zLnVybCwgdHJ1ZSwgcHJlc2VydmVRdWVyeSwgdGhpcy5fdXJsKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnF1ZXJ5UGFyYW1ldGVycykpIHsKICAgICAgICAgIHJlc291cmNlLl9xdWVyeVBhcmFtZXRlcnMgPSBjb21iaW5lX2RlZmF1bHQoCiAgICAgICAgICAgIG9wdGlvbnMucXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICByZXNvdXJjZS5xdWVyeVBhcmFtZXRlcnMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy50ZW1wbGF0ZVZhbHVlcykpIHsKICAgICAgICAgIHJlc291cmNlLl90ZW1wbGF0ZVZhbHVlcyA9IGNvbWJpbmVfZGVmYXVsdCgKICAgICAgICAgICAgb3B0aW9ucy50ZW1wbGF0ZVZhbHVlcywKICAgICAgICAgICAgcmVzb3VyY2UudGVtcGxhdGVWYWx1ZXMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5oZWFkZXJzKSkgewogICAgICAgICAgcmVzb3VyY2UuaGVhZGVycyA9IGNvbWJpbmVfZGVmYXVsdChvcHRpb25zLmhlYWRlcnMsIHJlc291cmNlLmhlYWRlcnMpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucHJveHkpKSB7CiAgICAgICAgICByZXNvdXJjZS5wcm94eSA9IG9wdGlvbnMucHJveHk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5yZXF1ZXN0KSkgewogICAgICAgICAgcmVzb3VyY2UucmVxdWVzdCA9IG9wdGlvbnMucmVxdWVzdDsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnJldHJ5Q2FsbGJhY2spKSB7CiAgICAgICAgICByZXNvdXJjZS5yZXRyeUNhbGxiYWNrID0gb3B0aW9ucy5yZXRyeUNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucmV0cnlBdHRlbXB0cykpIHsKICAgICAgICAgIHJlc291cmNlLnJldHJ5QXR0ZW1wdHMgPSBvcHRpb25zLnJldHJ5QXR0ZW1wdHM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXNvdXJjZTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnJldHJ5T25FcnJvciA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgY29uc3QgcmV0cnlDYWxsYmFjayA9IHRoaXMucmV0cnlDYWxsYmFjazsKICAgICAgICBpZiAodHlwZW9mIHJldHJ5Q2FsbGJhY2sgIT09ICJmdW5jdGlvbiIgfHwgdGhpcy5fcmV0cnlDb3VudCA+PSB0aGlzLnJldHJ5QXR0ZW1wdHMpIHsKICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0aGF0ID0gdGhpczsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJldHJ5Q2FsbGJhY2sodGhpcywgZXJyb3IpKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgKyt0aGF0Ll9yZXRyeUNvdW50OwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZXNvdXJjZSh7CiAgICAgICAgICAgIHVybDogdGhpcy5fdXJsLAogICAgICAgICAgICBxdWVyeVBhcmFtZXRlcnM6IHRoaXMucXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICB0ZW1wbGF0ZVZhbHVlczogdGhpcy50ZW1wbGF0ZVZhbHVlcywKICAgICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgICBwcm94eTogdGhpcy5wcm94eSwKICAgICAgICAgICAgcmV0cnlDYWxsYmFjazogdGhpcy5yZXRyeUNhbGxiYWNrLAogICAgICAgICAgICByZXRyeUF0dGVtcHRzOiB0aGlzLnJldHJ5QXR0ZW1wdHMsCiAgICAgICAgICAgIHJlcXVlc3Q6IHRoaXMucmVxdWVzdC5jbG9uZSgpLAogICAgICAgICAgICBwYXJzZVVybDogZmFsc2UsCiAgICAgICAgICAgIGNyZWRpdHM6IGRlZmluZWRfZGVmYXVsdCh0aGlzLmNyZWRpdHMpID8gdGhpcy5jcmVkaXRzLnNsaWNlKCkgOiB2b2lkIDAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3VybCA9IHRoaXMuX3VybDsKICAgICAgICByZXN1bHQuX3F1ZXJ5UGFyYW1ldGVycyA9IGNsb25lX2RlZmF1bHQodGhpcy5fcXVlcnlQYXJhbWV0ZXJzKTsKICAgICAgICByZXN1bHQuX3RlbXBsYXRlVmFsdWVzID0gY2xvbmVfZGVmYXVsdCh0aGlzLl90ZW1wbGF0ZVZhbHVlcyk7CiAgICAgICAgcmVzdWx0LmhlYWRlcnMgPSBjbG9uZV9kZWZhdWx0KHRoaXMuaGVhZGVycyk7CiAgICAgICAgcmVzdWx0LnByb3h5ID0gdGhpcy5wcm94eTsKICAgICAgICByZXN1bHQucmV0cnlDYWxsYmFjayA9IHRoaXMucmV0cnlDYWxsYmFjazsKICAgICAgICByZXN1bHQucmV0cnlBdHRlbXB0cyA9IHRoaXMucmV0cnlBdHRlbXB0czsKICAgICAgICByZXN1bHQuX3JldHJ5Q291bnQgPSAwOwogICAgICAgIHJlc3VsdC5yZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0LmNsb25lKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmdldEJhc2VVcmkgPSBmdW5jdGlvbihpbmNsdWRlUXVlcnkpIHsKICAgICAgICByZXR1cm4gZ2V0QmFzZVVyaV9kZWZhdWx0KHRoaXMuZ2V0VXJsQ29tcG9uZW50KGluY2x1ZGVRdWVyeSksIGluY2x1ZGVRdWVyeSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5hcHBlbmRGb3J3YXJkU2xhc2ggPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl91cmwgPSBhcHBlbmRGb3J3YXJkU2xhc2hfZGVmYXVsdCh0aGlzLl91cmwpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hBcnJheUJ1ZmZlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogImFycmF5YnVmZmVyIgogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaEFycmF5QnVmZmVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5mZXRjaEFycmF5QnVmZmVyKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaEJsb2IgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5mZXRjaCh7CiAgICAgICAgICByZXNwb25zZVR5cGU6ICJibG9iIgogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaEJsb2IgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoQmxvYigpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hJbWFnZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBwcmVmZXJJbWFnZUJpdG1hcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucHJlZmVySW1hZ2VCaXRtYXAsIGZhbHNlKTsKICAgICAgICBjb25zdCBwcmVmZXJCbG9iID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wcmVmZXJCbG9iLCBmYWxzZSk7CiAgICAgICAgY29uc3QgZmxpcFkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmZsaXBZLCBmYWxzZSk7CiAgICAgICAgY29uc3Qgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBvcHRpb25zLnNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBjaGVja0FuZFJlc2V0UmVxdWVzdCh0aGlzLnJlcXVlc3QpOwogICAgICAgIGlmICgheGhyQmxvYlN1cHBvcnRlZCB8fCB0aGlzLmlzRGF0YVVyaSB8fCB0aGlzLmlzQmxvYlVyaSB8fCAhdGhpcy5oYXNIZWFkZXJzICYmICFwcmVmZXJCbG9iKSB7CiAgICAgICAgICByZXR1cm4gZmV0Y2hJbWFnZSh7CiAgICAgICAgICAgIHJlc291cmNlOiB0aGlzLAogICAgICAgICAgICBmbGlwWSwKICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uLAogICAgICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJsb2JQcm9taXNlID0gdGhpcy5mZXRjaEJsb2IoKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChibG9iUHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbGV0IHN1cHBvcnRzSW1hZ2VCaXRtYXA7CiAgICAgICAgbGV0IHVzZUltYWdlQml0bWFwOwogICAgICAgIGxldCBnZW5lcmF0ZWRCbG9iUmVzb3VyY2U7CiAgICAgICAgbGV0IGdlbmVyYXRlZEJsb2I7CiAgICAgICAgcmV0dXJuIFJlc291cmNlLnN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zKCkudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICAgIHN1cHBvcnRzSW1hZ2VCaXRtYXAgPSByZXN1bHQ7CiAgICAgICAgICB1c2VJbWFnZUJpdG1hcCA9IHN1cHBvcnRzSW1hZ2VCaXRtYXAgJiYgcHJlZmVySW1hZ2VCaXRtYXA7CiAgICAgICAgICByZXR1cm4gYmxvYlByb21pc2U7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbihibG9iKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChibG9iKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBnZW5lcmF0ZWRCbG9iID0gYmxvYjsKICAgICAgICAgIGlmICh1c2VJbWFnZUJpdG1hcCkgewogICAgICAgICAgICByZXR1cm4gUmVzb3VyY2UuY3JlYXRlSW1hZ2VCaXRtYXBGcm9tQmxvYihibG9iLCB7CiAgICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgICAgcHJlbXVsdGlwbHlBbHBoYTogZmFsc2UsCiAgICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgYmxvYlVybCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgICAgZ2VuZXJhdGVkQmxvYlJlc291cmNlID0gbmV3IFJlc291cmNlKHsKICAgICAgICAgICAgdXJsOiBibG9iVXJsCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBmZXRjaEltYWdlKHsKICAgICAgICAgICAgcmVzb3VyY2U6IGdlbmVyYXRlZEJsb2JSZXNvdXJjZSwKICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgICAgcHJlZmVySW1hZ2VCaXRtYXA6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKGltYWdlKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbWFnZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaW1hZ2UuYmxvYiA9IGdlbmVyYXRlZEJsb2I7CiAgICAgICAgICBpZiAodXNlSW1hZ2VCaXRtYXApIHsKICAgICAgICAgICAgcmV0dXJuIGltYWdlOwogICAgICAgICAgfQogICAgICAgICAgd2luZG93LlVSTC5yZXZva2VPYmplY3RVUkwoZ2VuZXJhdGVkQmxvYlJlc291cmNlLnVybCk7CiAgICAgICAgICByZXR1cm4gaW1hZ2U7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VuZXJhdGVkQmxvYlJlc291cmNlKSkgewogICAgICAgICAgICB3aW5kb3cuVVJMLnJldm9rZU9iamVjdFVSTChnZW5lcmF0ZWRCbG9iUmVzb3VyY2UudXJsKTsKICAgICAgICAgIH0KICAgICAgICAgIGVycm9yLmJsb2IgPSBnZW5lcmF0ZWRCbG9iOwogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hJbWFnZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hJbWFnZSh7CiAgICAgICAgICBmbGlwWTogb3B0aW9ucy5mbGlwWSwKICAgICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbjogb3B0aW9ucy5za2lwQ29sb3JTcGFjZUNvbnZlcnNpb24sCiAgICAgICAgICBwcmVmZXJCbG9iOiBvcHRpb25zLnByZWZlckJsb2IsCiAgICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcDogb3B0aW9ucy5wcmVmZXJJbWFnZUJpdG1hcAogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hUZXh0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2goewogICAgICAgICAgcmVzcG9uc2VUeXBlOiAidGV4dCIKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hUZXh0ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5mZXRjaFRleHQoKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmZldGNoSnNvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogInRleHQiLAogICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICBBY2NlcHQ6ICJhcHBsaWNhdGlvbi9qc29uLCovKjtxPTAuMDEiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLmZldGNoSnNvbiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hKc29uKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaFhNTCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogImRvY3VtZW50IiwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6ICJ0ZXh0L3htbCIKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hYTUwgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoWE1MKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaEpzb25wID0gZnVuY3Rpb24oY2FsbGJhY2tQYXJhbWV0ZXJOYW1lKSB7CiAgICAgICAgY2FsbGJhY2tQYXJhbWV0ZXJOYW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2FsbGJhY2tQYXJhbWV0ZXJOYW1lLCAiY2FsbGJhY2siKTsKICAgICAgICBjaGVja0FuZFJlc2V0UmVxdWVzdCh0aGlzLnJlcXVlc3QpOwogICAgICAgIGxldCBmdW5jdGlvbk5hbWU7CiAgICAgICAgZG8gewogICAgICAgICAgZnVuY3Rpb25OYW1lID0gYGxvYWRKc29ucCR7TWF0aF9kZWZhdWx0Lm5leHRSYW5kb21OdW1iZXIoKS50b1N0cmluZygpLnN1YnN0cmluZygyLCA4KX1gOwogICAgICAgIH0gd2hpbGUgKGRlZmluZWRfZGVmYXVsdCh3aW5kb3dbZnVuY3Rpb25OYW1lXSkpOwogICAgICAgIHJldHVybiBmZXRjaEpzb25wKHRoaXMsIGNhbGxiYWNrUGFyYW1ldGVyTmFtZSwgZnVuY3Rpb25OYW1lKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hKc29ucCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hKc29ucChvcHRpb25zLmNhbGxiYWNrUGFyYW1ldGVyTmFtZSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5fbWFrZVJlcXVlc3QgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSB0aGlzOwogICAgICAgIGNoZWNrQW5kUmVzZXRSZXF1ZXN0KHJlc291cmNlLnJlcXVlc3QpOwogICAgICAgIGNvbnN0IHJlcXVlc3QgPSByZXNvdXJjZS5yZXF1ZXN0OwogICAgICAgIGNvbnN0IHVybCA9IHJlc291cmNlLnVybDsKICAgICAgICByZXF1ZXN0LnVybCA9IHVybDsKICAgICAgICByZXF1ZXN0LnJlcXVlc3RGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgY29uc3QgcmVzcG9uc2VUeXBlID0gb3B0aW9ucy5yZXNwb25zZVR5cGU7CiAgICAgICAgICBjb25zdCBoZWFkZXJzID0gY29tYmluZV9kZWZhdWx0KG9wdGlvbnMuaGVhZGVycywgcmVzb3VyY2UuaGVhZGVycyk7CiAgICAgICAgICBjb25zdCBvdmVycmlkZU1pbWVUeXBlID0gb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlOwogICAgICAgICAgY29uc3QgbWV0aG9kID0gb3B0aW9ucy5tZXRob2Q7CiAgICAgICAgICBjb25zdCBkYXRhID0gb3B0aW9ucy5kYXRhOwogICAgICAgICAgY29uc3QgZGVmZXJyZWQgPSBkZWZlcl9kZWZhdWx0KCk7CiAgICAgICAgICBjb25zdCB4aHIgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyKAogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIHJlc3BvbnNlVHlwZSwKICAgICAgICAgICAgbWV0aG9kLAogICAgICAgICAgICBkYXRhLAogICAgICAgICAgICBoZWFkZXJzLAogICAgICAgICAgICBkZWZlcnJlZCwKICAgICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoeGhyKSAmJiBkZWZpbmVkX2RlZmF1bHQoeGhyLmFib3J0KSkgewogICAgICAgICAgICByZXF1ZXN0LmNhbmNlbEZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgeGhyLmFib3J0KCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHByb21pc2UgPSBSZXF1ZXN0U2NoZWR1bGVyX2RlZmF1bHQucmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9taXNlKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgIHJlcXVlc3QuY2FuY2VsRnVuY3Rpb24gPSB2b2lkIDA7CiAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgICAgICByZXF1ZXN0LmNhbmNlbEZ1bmN0aW9uID0gdm9pZCAwOwogICAgICAgICAgaWYgKHJlcXVlc3Quc3RhdGUgIT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkZBSUxFRCkgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzb3VyY2UucmV0cnlPbkVycm9yKGUpLnRoZW4oZnVuY3Rpb24ocmV0cnkpIHsKICAgICAgICAgICAgaWYgKHJldHJ5KSB7CiAgICAgICAgICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlVOSVNTVUVEOwogICAgICAgICAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoKG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9OwogICAgICBkYXRhVXJpUmVnZXgyID0gL15kYXRhOiguKj8pKDtiYXNlNjQpPywoLiopJC87CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJHRVQiOwogICAgICAgIHJldHVybiB0aGlzLl9tYWtlUmVxdWVzdChvcHRpb25zKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2ggPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoKHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBmZXRjaAogICAgICAgICAgcmVzcG9uc2VUeXBlOiBvcHRpb25zLnJlc3BvbnNlVHlwZSwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IG9wdGlvbnMub3ZlcnJpZGVNaW1lVHlwZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZGVsZXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIkRFTEVURSI7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5kZWxldGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmRlbGV0ZSh7CiAgICAgICAgICAvLyBNYWtlIGNvcHkgb2YganVzdCB0aGUgbmVlZGVkIGZpZWxkcyBiZWNhdXNlIGhlYWRlcnMgY2FuIGJlIHBhc3NlZCB0byBib3RoIHRoZSBjb25zdHJ1Y3RvciBhbmQgdG8gZmV0Y2gKICAgICAgICAgIHJlc3BvbnNlVHlwZTogb3B0aW9ucy5yZXNwb25zZVR5cGUsCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGUsCiAgICAgICAgICBkYXRhOiBvcHRpb25zLmRhdGEKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmhlYWQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRDbG9uZShvcHRpb25zLCB7fSk7CiAgICAgICAgb3B0aW9ucy5tZXRob2QgPSAiSEVBRCI7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5oZWFkID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5oZWFkKHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBmZXRjaAogICAgICAgICAgcmVzcG9uc2VUeXBlOiBvcHRpb25zLnJlc3BvbnNlVHlwZSwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IG9wdGlvbnMub3ZlcnJpZGVNaW1lVHlwZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUub3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJPUFRJT05TIjsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLm9wdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLm9wdGlvbnMoewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIGZldGNoCiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5wb3N0ID0gZnVuY3Rpb24oZGF0YSwgb3B0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGF0YSIsIGRhdGEpOwogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIlBPU1QiOwogICAgICAgIG9wdGlvbnMuZGF0YSA9IGRhdGE7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wb3N0ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5wb3N0KG9wdGlvbnMuZGF0YSwgewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIHBvc3QKICAgICAgICAgIHJlc3BvbnNlVHlwZTogb3B0aW9ucy5yZXNwb25zZVR5cGUsCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uKGRhdGEsIG9wdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRhdGEiLCBkYXRhKTsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJQVVQiOwogICAgICAgIG9wdGlvbnMuZGF0YSA9IGRhdGE7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wdXQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLnB1dChvcHRpb25zLmRhdGEsIHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBwb3N0CiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5wYXRjaCA9IGZ1bmN0aW9uKGRhdGEsIG9wdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRhdGEiLCBkYXRhKTsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJQQVRDSCI7CiAgICAgICAgb3B0aW9ucy5kYXRhID0gZGF0YTsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnBhdGNoID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5wYXRjaChvcHRpb25zLmRhdGEsIHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBwb3N0CiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMgPSB7fTsKICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5sb2FkSW1hZ2VFbGVtZW50ID0gZnVuY3Rpb24odXJsLCBjcm9zc09yaWdpbiwgZGVmZXJyZWQpIHsKICAgICAgICBjb25zdCBpbWFnZSA9IG5ldyBJbWFnZSgpOwogICAgICAgIGltYWdlLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGltYWdlLm5hdHVyYWxXaWR0aCA9PT0gMCAmJiBpbWFnZS5uYXR1cmFsSGVpZ2h0ID09PSAwICYmIGltYWdlLndpZHRoID09PSAwICYmIGltYWdlLmhlaWdodCA9PT0gMCkgewogICAgICAgICAgICBpbWFnZS53aWR0aCA9IDMwMDsKICAgICAgICAgICAgaW1hZ2UuaGVpZ2h0ID0gMTUwOwogICAgICAgICAgfQogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShpbWFnZSk7CiAgICAgICAgfTsKICAgICAgICBpbWFnZS5vbmVycm9yID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgIH07CiAgICAgICAgaWYgKGNyb3NzT3JpZ2luKSB7CiAgICAgICAgICBpZiAoVHJ1c3RlZFNlcnZlcnNfZGVmYXVsdC5jb250YWlucyh1cmwpKSB7CiAgICAgICAgICAgIGltYWdlLmNyb3NzT3JpZ2luID0gInVzZS1jcmVkZW50aWFscyI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbWFnZS5jcm9zc09yaWdpbiA9ICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbWFnZS5zcmMgPSB1cmw7CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMuY3JlYXRlSW1hZ2UgPSBmdW5jdGlvbihyZXF1ZXN0LCBjcm9zc09yaWdpbiwgZGVmZXJyZWQsIGZsaXBZLCBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24sIHByZWZlckltYWdlQml0bWFwKSB7CiAgICAgICAgY29uc3QgdXJsID0gcmVxdWVzdC51cmw7CiAgICAgICAgUmVzb3VyY2Uuc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnMoKS50aGVuKGZ1bmN0aW9uKHN1cHBvcnRzSW1hZ2VCaXRtYXApIHsKICAgICAgICAgIGlmICghKHN1cHBvcnRzSW1hZ2VCaXRtYXAgJiYgcHJlZmVySW1hZ2VCaXRtYXApKSB7CiAgICAgICAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZEltYWdlRWxlbWVudCh1cmwsIGNyb3NzT3JpZ2luLCBkZWZlcnJlZCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3BvbnNlVHlwZSA9ICJibG9iIjsKICAgICAgICAgIGNvbnN0IG1ldGhvZCA9ICJHRVQiOwogICAgICAgICAgY29uc3QgeGhyRGVmZXJyZWQgPSBkZWZlcl9kZWZhdWx0KCk7CiAgICAgICAgICBjb25zdCB4aHIgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyKAogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIHJlc3BvbnNlVHlwZSwKICAgICAgICAgICAgbWV0aG9kLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgeGhyRGVmZXJyZWQsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICB2b2lkIDAKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHhocikgJiYgZGVmaW5lZF9kZWZhdWx0KHhoci5hYm9ydCkpIHsKICAgICAgICAgICAgcmVxdWVzdC5jYW5jZWxGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHhockRlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbihibG9iKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJsb2IpKSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KAogICAgICAgICAgICAgICAgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgICAgICBgU3VjY2Vzc2Z1bGx5IHJldHJpZXZlZCAke3VybH0gYnV0IGl0IGNvbnRhaW5lZCBubyBjb250ZW50LmAKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gUmVzb3VyY2UuY3JlYXRlSW1hZ2VCaXRtYXBGcm9tQmxvYihibG9iLCB7CiAgICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgICAgcHJlbXVsdGlwbHlBbHBoYTogZmFsc2UsCiAgICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkudGhlbihmdW5jdGlvbihpbWFnZSkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGltYWdlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuY3JlYXRlSW1hZ2VCaXRtYXBGcm9tQmxvYiA9IGZ1bmN0aW9uKGJsb2IsIG9wdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMiLCBvcHRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5ib29sKCJvcHRpb25zLmZsaXBZIiwgb3B0aW9ucy5mbGlwWSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YuYm9vbCgib3B0aW9ucy5wcmVtdWx0aXBseUFscGhhIiwgb3B0aW9ucy5wcmVtdWx0aXBseUFscGhhKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5ib29sKAogICAgICAgICAgIm9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uIiwKICAgICAgICAgIG9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gY3JlYXRlSW1hZ2VCaXRtYXAoYmxvYiwgewogICAgICAgICAgaW1hZ2VPcmllbnRhdGlvbjogb3B0aW9ucy5mbGlwWSA/ICJmbGlwWSIgOiAibm9uZSIsCiAgICAgICAgICBwcmVtdWx0aXBseUFscGhhOiBvcHRpb25zLnByZW11bHRpcGx5QWxwaGEgPyAicHJlbXVsdGlwbHkiIDogIm5vbmUiLAogICAgICAgICAgY29sb3JTcGFjZUNvbnZlcnNpb246IG9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uID8gIm5vbmUiIDogImRlZmF1bHQiCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIG5vWE1MSHR0cFJlcXVlc3QgPSB0eXBlb2YgWE1MSHR0cFJlcXVlc3QgPT09ICJ1bmRlZmluZWQiOwogICAgICBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyID0gZnVuY3Rpb24odXJsLCByZXNwb25zZVR5cGUsIG1ldGhvZCwgZGF0YSwgaGVhZGVycywgZGVmZXJyZWQsIG92ZXJyaWRlTWltZVR5cGUpIHsKICAgICAgICBjb25zdCBkYXRhVXJpUmVnZXhSZXN1bHQgPSBkYXRhVXJpUmVnZXgyLmV4ZWModXJsKTsKICAgICAgICBpZiAoZGF0YVVyaVJlZ2V4UmVzdWx0ICE9PSBudWxsKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGRlY29kZURhdGFVcmkoZGF0YVVyaVJlZ2V4UmVzdWx0LCByZXNwb25zZVR5cGUpKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG5vWE1MSHR0cFJlcXVlc3QpIHsKICAgICAgICAgIGxvYWRXaXRoSHR0cFJlcXVlc3QoCiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgcmVzcG9uc2VUeXBlLAogICAgICAgICAgICBtZXRob2QsCiAgICAgICAgICAgIGRhdGEsCiAgICAgICAgICAgIGhlYWRlcnMsCiAgICAgICAgICAgIGRlZmVycmVkLAogICAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICBpZiAoVHJ1c3RlZFNlcnZlcnNfZGVmYXVsdC5jb250YWlucyh1cmwpKSB7CiAgICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgeGhyLm9wZW4obWV0aG9kLCB1cmwsIHRydWUpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3ZlcnJpZGVNaW1lVHlwZSkgJiYgZGVmaW5lZF9kZWZhdWx0KHhoci5vdmVycmlkZU1pbWVUeXBlKSkgewogICAgICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUob3ZlcnJpZGVNaW1lVHlwZSk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGVhZGVycykpIHsKICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgaWYgKGhlYWRlcnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgaGVhZGVyc1trZXldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3BvbnNlVHlwZSkpIHsKICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSByZXNwb25zZVR5cGU7CiAgICAgICAgfQogICAgICAgIGxldCBsb2NhbEZpbGUgPSBmYWxzZTsKICAgICAgICBpZiAodHlwZW9mIHVybCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIGxvY2FsRmlsZSA9IHVybC5pbmRleE9mKCJmaWxlOi8vIikgPT09IDAgfHwgdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmxvY2F0aW9uLm9yaWdpbiA9PT0gImZpbGU6Ly8iOwogICAgICAgIH0KICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoKHhoci5zdGF0dXMgPCAyMDAgfHwgeGhyLnN0YXR1cyA+PSAzMDApICYmICEobG9jYWxGaWxlICYmIHhoci5zdGF0dXMgPT09IDApKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgICAgICBuZXcgUmVxdWVzdEVycm9yRXZlbnRfZGVmYXVsdCgKICAgICAgICAgICAgICAgIHhoci5zdGF0dXMsCiAgICAgICAgICAgICAgICB4aHIucmVzcG9uc2UsCiAgICAgICAgICAgICAgICB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0geGhyLnJlc3BvbnNlOwogICAgICAgICAgY29uc3QgYnJvd3NlclJlc3BvbnNlVHlwZSA9IHhoci5yZXNwb25zZVR5cGU7CiAgICAgICAgICBpZiAobWV0aG9kID09PSAiSEVBRCIgfHwgbWV0aG9kID09PSAiT1BUSU9OUyIpIHsKICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VIZWFkZXJTdHJpbmcgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgIGNvbnN0IHNwbGl0SGVhZGVycyA9IHJlc3BvbnNlSGVhZGVyU3RyaW5nLnRyaW0oKS5zcGxpdCgvW1xyXG5dKy8pOwogICAgICAgICAgICBjb25zdCByZXNwb25zZUhlYWRlcnMgPSB7fTsKICAgICAgICAgICAgc3BsaXRIZWFkZXJzLmZvckVhY2goZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gbGluZS5zcGxpdCgiOiAiKTsKICAgICAgICAgICAgICBjb25zdCBoZWFkZXIgPSBwYXJ0cy5zaGlmdCgpOwogICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVyc1toZWFkZXJdID0gcGFydHMuam9pbigiOiAiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwNCkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHZvaWQgMCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChyZXNwb25zZSkgJiYgKCFkZWZpbmVkX2RlZmF1bHQocmVzcG9uc2VUeXBlKSB8fCBicm93c2VyUmVzcG9uc2VUeXBlID09PSByZXNwb25zZVR5cGUpKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzcG9uc2UpOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZVR5cGUgPT09ICJqc29uIiAmJiB0eXBlb2YgcmVzcG9uc2UgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShKU09OLnBhcnNlKHJlc3BvbnNlKSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoKGJyb3dzZXJSZXNwb25zZVR5cGUgPT09ICIiIHx8IGJyb3dzZXJSZXNwb25zZVR5cGUgPT09ICJkb2N1bWVudCIpICYmIGRlZmluZWRfZGVmYXVsdCh4aHIucmVzcG9uc2VYTUwpICYmIHhoci5yZXNwb25zZVhNTC5oYXNDaGlsZE5vZGVzKCkpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh4aHIucmVzcG9uc2VYTUwpOwogICAgICAgICAgfSBlbHNlIGlmICgoYnJvd3NlclJlc3BvbnNlVHlwZSA9PT0gIiIgfHwgYnJvd3NlclJlc3BvbnNlVHlwZSA9PT0gInRleHQiKSAmJiBkZWZpbmVkX2RlZmF1bHQoeGhyLnJlc3BvbnNlVGV4dCkpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgICAgICBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgWE1MSHR0cFJlcXVlc3QgcmVzcG9uc2UgdHlwZS4iKQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgeGhyLm9uZXJyb3IgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QobmV3IFJlcXVlc3RFcnJvckV2ZW50X2RlZmF1bHQoKSk7CiAgICAgICAgfTsKICAgICAgICB4aHIuc2VuZChkYXRhKTsKICAgICAgICByZXR1cm4geGhyOwogICAgICB9OwogICAgICBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRBbmRFeGVjdXRlU2NyaXB0ID0gZnVuY3Rpb24odXJsLCBmdW5jdGlvbk5hbWUsIGRlZmVycmVkKSB7CiAgICAgICAgcmV0dXJuIGxvYWRBbmRFeGVjdXRlU2NyaXB0X2RlZmF1bHQodXJsLCBmdW5jdGlvbk5hbWUpLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuX0RlZmF1bHRJbXBsZW1lbnRhdGlvbnMgPSB7fTsKICAgICAgUmVzb3VyY2UuX0RlZmF1bHRJbXBsZW1lbnRhdGlvbnMuY3JlYXRlSW1hZ2UgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmNyZWF0ZUltYWdlOwogICAgICBSZXNvdXJjZS5fRGVmYXVsdEltcGxlbWVudGF0aW9ucy5sb2FkV2l0aFhociA9IFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZFdpdGhYaHI7CiAgICAgIFJlc291cmNlLl9EZWZhdWx0SW1wbGVtZW50YXRpb25zLmxvYWRBbmRFeGVjdXRlU2NyaXB0ID0gUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5sb2FkQW5kRXhlY3V0ZVNjcmlwdDsKICAgICAgUmVzb3VyY2UuREVGQVVMVCA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFJlc291cmNlKHsKICAgICAgICAgIHVybDogdHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiA/ICIiIDogZG9jdW1lbnQubG9jYXRpb24uaHJlZi5zcGxpdCgiPyIpWzBdCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgUmVzb3VyY2VfZGVmYXVsdCA9IFJlc291cmNlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuanMKICBmdW5jdGlvbiBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyhvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMuX2RhdGVzID0gdm9pZCAwOwogICAgdGhpcy5fc2FtcGxlcyA9IHZvaWQgMDsKICAgIHRoaXMuX2RhdGVDb2x1bW4gPSAtMTsKICAgIHRoaXMuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA9IC0xOwogICAgdGhpcy5feVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0gLTE7CiAgICB0aGlzLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSAtMTsKICAgIHRoaXMuX3hDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA9IC0xOwogICAgdGhpcy5feUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0gLTE7CiAgICB0aGlzLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSAtMTsKICAgIHRoaXMuX2NvbHVtbkNvdW50ID0gMDsKICAgIHRoaXMuX2xhc3RJbmRleCA9IC0xOwogICAgdGhpcy5fYWRkTmV3TGVhcFNlY29uZHMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFkZE5ld0xlYXBTZWNvbmRzLCB0cnVlKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5kYXRhKSkgewogICAgICBvbkRhdGFSZWFkeSh0aGlzLCBvcHRpb25zLmRhdGEpOwogICAgfSBlbHNlIHsKICAgICAgb25EYXRhUmVhZHkodGhpcywgewogICAgICAgIGNvbHVtbk5hbWVzOiBbCiAgICAgICAgICAiZGF0ZUlzbzg2MDEiLAogICAgICAgICAgIm1vZGlmaWVkSnVsaWFuRGF0ZVV0YyIsCiAgICAgICAgICAieFBvbGVXYW5kZXJSYWRpYW5zIiwKICAgICAgICAgICJ5UG9sZVdhbmRlclJhZGlhbnMiLAogICAgICAgICAgInV0MU1pbnVzVXRjU2Vjb25kcyIsCiAgICAgICAgICAibGVuZ3RoT2ZEYXlDb3JyZWN0aW9uU2Vjb25kcyIsCiAgICAgICAgICAieENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zIiwKICAgICAgICAgICJ5Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnMiLAogICAgICAgICAgInRhaU1pbnVzVXRjU2Vjb25kcyIKICAgICAgICBdLAogICAgICAgIHNhbXBsZXM6IFtdCiAgICAgIH0pOwogICAgfQogIH0KICBmdW5jdGlvbiBjb21wYXJlTGVhcFNlY29uZERhdGVzMihsZWFwU2Vjb25kLCBkYXRlVG9GaW5kKSB7CiAgICByZXR1cm4gSnVsaWFuRGF0ZV9kZWZhdWx0LmNvbXBhcmUobGVhcFNlY29uZC5qdWxpYW5EYXRlLCBkYXRlVG9GaW5kKTsKICB9CiAgZnVuY3Rpb24gb25EYXRhUmVhZHkoZW9wLCBlb3BEYXRhKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlb3BEYXRhLmNvbHVtbk5hbWVzKSkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIkVycm9yIGluIGxvYWRlZCBFT1AgZGF0YTogVGhlIGNvbHVtbk5hbWVzIHByb3BlcnR5IGlzIHJlcXVpcmVkLiIKICAgICAgKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVvcERhdGEuc2FtcGxlcykpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICJFcnJvciBpbiBsb2FkZWQgRU9QIGRhdGE6IFRoZSBzYW1wbGVzIHByb3BlcnR5IGlzIHJlcXVpcmVkLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGRhdGVDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoIm1vZGlmaWVkSnVsaWFuRGF0ZVV0YyIpOwogICAgY29uc3QgeFBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5pbmRleE9mKCJ4UG9sZVdhbmRlclJhZGlhbnMiKTsKICAgIGNvbnN0IHlQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA9IGVvcERhdGEuY29sdW1uTmFtZXMuaW5kZXhPZigieVBvbGVXYW5kZXJSYWRpYW5zIik7CiAgICBjb25zdCB1dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoInV0MU1pbnVzVXRjU2Vjb25kcyIpOwogICAgY29uc3QgeENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5pbmRleE9mKAogICAgICAieENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zIgogICAgKTsKICAgIGNvbnN0IHlDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA9IGVvcERhdGEuY29sdW1uTmFtZXMuaW5kZXhPZigKICAgICAgInlDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFucyIKICAgICk7CiAgICBjb25zdCB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoInRhaU1pbnVzVXRjU2Vjb25kcyIpOwogICAgaWYgKGRhdGVDb2x1bW4gPCAwIHx8IHhQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA8IDAgfHwgeVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uIDwgMCB8fCB1dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPCAwIHx8IHhDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA8IDAgfHwgeUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uIDwgMCB8fCB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPCAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAiRXJyb3IgaW4gbG9hZGVkIEVPUCBkYXRhOiBUaGUgY29sdW1uTmFtZXMgcHJvcGVydHkgbXVzdCBpbmNsdWRlIG1vZGlmaWVkSnVsaWFuRGF0ZVV0YywgeFBvbGVXYW5kZXJSYWRpYW5zLCB5UG9sZVdhbmRlclJhZGlhbnMsIHV0MU1pbnVzVXRjU2Vjb25kcywgeENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zLCB5Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnMsIGFuZCB0YWlNaW51c1V0Y1NlY29uZHMgY29sdW1ucyIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHNhbXBsZXMgPSBlb3AuX3NhbXBsZXMgPSBlb3BEYXRhLnNhbXBsZXM7CiAgICBjb25zdCBkYXRlcyA9IGVvcC5fZGF0ZXMgPSBbXTsKICAgIGVvcC5fZGF0ZUNvbHVtbiA9IGRhdGVDb2x1bW47CiAgICBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA9IHhQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbjsKICAgIGVvcC5feVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0geVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uOwogICAgZW9wLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSB1dDFNaW51c1V0Y1NlY29uZHNDb2x1bW47CiAgICBlb3AuX3hDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA9IHhDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbjsKICAgIGVvcC5feUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0geUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uOwogICAgZW9wLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW47CiAgICBlb3AuX2NvbHVtbkNvdW50ID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5sZW5ndGg7CiAgICBlb3AuX2xhc3RJbmRleCA9IHZvaWQgMDsKICAgIGxldCBsYXN0VGFpTWludXNVdGM7CiAgICBjb25zdCBhZGROZXdMZWFwU2Vjb25kcyA9IGVvcC5fYWRkTmV3TGVhcFNlY29uZHM7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc2FtcGxlcy5sZW5ndGg7IGkgPCBsZW47IGkgKz0gZW9wLl9jb2x1bW5Db3VudCkgewogICAgICBjb25zdCBtamQgPSBzYW1wbGVzW2kgKyBkYXRlQ29sdW1uXTsKICAgICAgY29uc3QgdGFpTWludXNVdGMgPSBzYW1wbGVzW2kgKyB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgICBjb25zdCBkYXkgPSBtamQgKyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuTU9ESUZJRURfSlVMSUFOX0RBVEVfRElGRkVSRU5DRTsKICAgICAgY29uc3QgZGF0ZSA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoZGF5LCB0YWlNaW51c1V0YywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKTsKICAgICAgZGF0ZXMucHVzaChkYXRlKTsKICAgICAgaWYgKGFkZE5ld0xlYXBTZWNvbmRzKSB7CiAgICAgICAgaWYgKHRhaU1pbnVzVXRjICE9PSBsYXN0VGFpTWludXNVdGMgJiYgZGVmaW5lZF9kZWZhdWx0KGxhc3RUYWlNaW51c1V0YykpIHsKICAgICAgICAgIGNvbnN0IGxlYXBTZWNvbmRzID0gSnVsaWFuRGF0ZV9kZWZhdWx0LmxlYXBTZWNvbmRzOwogICAgICAgICAgY29uc3QgbGVhcFNlY29uZEluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoCiAgICAgICAgICAgIGxlYXBTZWNvbmRzLAogICAgICAgICAgICBkYXRlLAogICAgICAgICAgICBjb21wYXJlTGVhcFNlY29uZERhdGVzMgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChsZWFwU2Vjb25kSW5kZXggPCAwKSB7CiAgICAgICAgICAgIGNvbnN0IGxlYXBTZWNvbmQgPSBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KGRhdGUsIHRhaU1pbnVzVXRjKTsKICAgICAgICAgICAgbGVhcFNlY29uZHMuc3BsaWNlKH5sZWFwU2Vjb25kSW5kZXgsIDAsIGxlYXBTZWNvbmQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsYXN0VGFpTWludXNVdGMgPSB0YWlNaW51c1V0YzsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBmaWxsUmVzdWx0RnJvbUluZGV4KGVvcCwgc2FtcGxlcywgaW5kZXgsIGNvbHVtbkNvdW50LCByZXN1bHQpIHsKICAgIGNvbnN0IHN0YXJ0ID0gaW5kZXggKiBjb2x1bW5Db3VudDsKICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IHNhbXBsZXNbc3RhcnQgKyBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbl07CiAgICByZXN1bHQueVBvbGVXYW5kZXIgPSBzYW1wbGVzW3N0YXJ0ICsgZW9wLl95UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dOwogICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gc2FtcGxlc1tzdGFydCArIGVvcC5feENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uXTsKICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IHNhbXBsZXNbc3RhcnQgKyBlb3AuX3lDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl07CiAgICByZXN1bHQudXQxTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0ICsgZW9wLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogIH0KICBmdW5jdGlvbiBsaW5lYXJJbnRlcnAoZHgsIHkxLCB5MikgewogICAgcmV0dXJuIHkxICsgZHggKiAoeTIgLSB5MSk7CiAgfQogIGZ1bmN0aW9uIGludGVycG9sYXRlKGVvcCwgZGF0ZXMsIHNhbXBsZXMsIGRhdGUsIGJlZm9yZSwgYWZ0ZXIsIHJlc3VsdCkgewogICAgY29uc3QgY29sdW1uQ291bnQgPSBlb3AuX2NvbHVtbkNvdW50OwogICAgaWYgKGFmdGVyID4gZGF0ZXMubGVuZ3RoIC0gMSkgewogICAgICByZXN1bHQueFBvbGVXYW5kZXIgPSAwOwogICAgICByZXN1bHQueVBvbGVXYW5kZXIgPSAwOwogICAgICByZXN1bHQueFBvbGVPZmZzZXQgPSAwOwogICAgICByZXN1bHQueVBvbGVPZmZzZXQgPSAwOwogICAgICByZXN1bHQudXQxTWludXNVdGMgPSAwOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgY29uc3QgYmVmb3JlRGF0ZSA9IGRhdGVzW2JlZm9yZV07CiAgICBjb25zdCBhZnRlckRhdGUgPSBkYXRlc1thZnRlcl07CiAgICBpZiAoYmVmb3JlRGF0ZS5lcXVhbHMoYWZ0ZXJEYXRlKSB8fCBkYXRlLmVxdWFscyhiZWZvcmVEYXRlKSkgewogICAgICBmaWxsUmVzdWx0RnJvbUluZGV4KGVvcCwgc2FtcGxlcywgYmVmb3JlLCBjb2x1bW5Db3VudCwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0gZWxzZSBpZiAoZGF0ZS5lcXVhbHMoYWZ0ZXJEYXRlKSkgewogICAgICBmaWxsUmVzdWx0RnJvbUluZGV4KGVvcCwgc2FtcGxlcywgYWZ0ZXIsIGNvbHVtbkNvdW50LCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgY29uc3QgZmFjdG9yID0gSnVsaWFuRGF0ZV9kZWZhdWx0LnNlY29uZHNEaWZmZXJlbmNlKGRhdGUsIGJlZm9yZURhdGUpIC8gSnVsaWFuRGF0ZV9kZWZhdWx0LnNlY29uZHNEaWZmZXJlbmNlKGFmdGVyRGF0ZSwgYmVmb3JlRGF0ZSk7CiAgICBjb25zdCBzdGFydEJlZm9yZSA9IGJlZm9yZSAqIGNvbHVtbkNvdW50OwogICAgY29uc3Qgc3RhcnRBZnRlciA9IGFmdGVyICogY29sdW1uQ291bnQ7CiAgICBsZXQgYmVmb3JlVXQxTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgbGV0IGFmdGVyVXQxTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3V0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbl07CiAgICBjb25zdCBvZmZzZXREaWZmZXJlbmNlID0gYWZ0ZXJVdDFNaW51c1V0YyAtIGJlZm9yZVV0MU1pbnVzVXRjOwogICAgaWYgKG9mZnNldERpZmZlcmVuY2UgPiAwLjUgfHwgb2Zmc2V0RGlmZmVyZW5jZSA8IC0wLjUpIHsKICAgICAgY29uc3QgYmVmb3JlVGFpTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgICBjb25zdCBhZnRlclRhaU1pbnVzVXRjID0gc2FtcGxlc1tzdGFydEFmdGVyICsgZW9wLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgICBpZiAoYmVmb3JlVGFpTWludXNVdGMgIT09IGFmdGVyVGFpTWludXNVdGMpIHsKICAgICAgICBpZiAoYWZ0ZXJEYXRlLmVxdWFscyhkYXRlKSkgewogICAgICAgICAgYmVmb3JlVXQxTWludXNVdGMgPSBhZnRlclV0MU1pbnVzVXRjOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhZnRlclV0MU1pbnVzVXRjIC09IGFmdGVyVGFpTWludXNVdGMgLSBiZWZvcmVUYWlNaW51c1V0YzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IGxpbmVhckludGVycCgKICAgICAgZmFjdG9yLAogICAgICBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl94UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dLAogICAgICBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbl0KICAgICk7CiAgICByZXN1bHQueVBvbGVXYW5kZXIgPSBsaW5lYXJJbnRlcnAoCiAgICAgIGZhY3RvciwKICAgICAgc2FtcGxlc1tzdGFydEJlZm9yZSArIGVvcC5feVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uXSwKICAgICAgc2FtcGxlc1tzdGFydEFmdGVyICsgZW9wLl95UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dCiAgICApOwogICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gbGluZWFySW50ZXJwKAogICAgICBmYWN0b3IsCiAgICAgIHNhbXBsZXNbc3RhcnRCZWZvcmUgKyBlb3AuX3hDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl0sCiAgICAgIHNhbXBsZXNbc3RhcnRBZnRlciArIGVvcC5feENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uXQogICAgKTsKICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IGxpbmVhckludGVycCgKICAgICAgZmFjdG9yLAogICAgICBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl95Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW5dLAogICAgICBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3lDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl0KICAgICk7CiAgICByZXN1bHQudXQxTWludXNVdGMgPSBsaW5lYXJJbnRlcnAoCiAgICAgIGZhY3RvciwKICAgICAgYmVmb3JlVXQxTWludXNVdGMsCiAgICAgIGFmdGVyVXQxTWludXNVdGMKICAgICk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNfZGVmYXVsdDsKICB2YXIgaW5pdF9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuanMiKCkgewogICAgICBpbml0X2JpbmFyeVNlYXJjaCgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlKCk7CiAgICAgIGluaXRfSnVsaWFuRGF0ZSgpOwogICAgICBpbml0X0xlYXBTZWNvbmQoKTsKICAgICAgaW5pdF9SZXNvdXJjZSgpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBpbml0X1RpbWVDb25zdGFudHMoKTsKICAgICAgaW5pdF9UaW1lU3RhbmRhcmQoKTsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuZnJvbVVybCA9IGFzeW5jIGZ1bmN0aW9uKHVybCwgb3B0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidXJsIiwgdXJsKTsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IFJlc291cmNlX2RlZmF1bHQuY3JlYXRlSWZOZWVkZWQodXJsKTsKICAgICAgICBsZXQgZW9wRGF0YTsKICAgICAgICB0cnkgewogICAgICAgICAgZW9wRGF0YSA9IGF3YWl0IHJlc291cmNlLmZldGNoSnNvbigpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEFuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgdGhlIEVPUCBkYXRhIGZyb20gdGhlIFVSTCAke3Jlc291cmNlLnVybH0uYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyh7CiAgICAgICAgICBhZGROZXdMZWFwU2Vjb25kczogb3B0aW9ucy5hZGROZXdMZWFwU2Vjb25kcywKICAgICAgICAgIGRhdGE6IGVvcERhdGEKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuTk9ORSA9IE9iamVjdC5mcmVlemUoewogICAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICByZXN1bHQgPSBuZXcgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGVfZGVmYXVsdCgwLCAwLCAwLCAwLCAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICAgIHJlc3VsdC55UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICAgIHJlc3VsdC54UG9sZU9mZnNldCA9IDA7CiAgICAgICAgICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IDA7CiAgICAgICAgICAgIHJlc3VsdC51dDFNaW51c1V0YyA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzLnByb3RvdHlwZS5jb21wdXRlID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fc2FtcGxlcykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZV9kZWZhdWx0KDAsIDAsIDAsIDAsIDApOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fc2FtcGxlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICByZXN1bHQueVBvbGVXYW5kZXIgPSAwOwogICAgICAgICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gMDsKICAgICAgICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IDA7CiAgICAgICAgICByZXN1bHQudXQxTWludXNVdGMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF0ZXMgPSB0aGlzLl9kYXRlczsKICAgICAgICBjb25zdCBsYXN0SW5kZXggPSB0aGlzLl9sYXN0SW5kZXg7CiAgICAgICAgbGV0IGJlZm9yZSA9IDA7CiAgICAgICAgbGV0IGFmdGVyID0gMDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxhc3RJbmRleCkpIHsKICAgICAgICAgIGNvbnN0IHByZXZpb3VzSW5kZXhEYXRlID0gZGF0ZXNbbGFzdEluZGV4XTsKICAgICAgICAgIGNvbnN0IG5leHRJbmRleERhdGUgPSBkYXRlc1tsYXN0SW5kZXggKyAxXTsKICAgICAgICAgIGNvbnN0IGlzQWZ0ZXJQcmV2aW91cyA9IEp1bGlhbkRhdGVfZGVmYXVsdC5sZXNzVGhhbk9yRXF1YWxzKAogICAgICAgICAgICBwcmV2aW91c0luZGV4RGF0ZSwKICAgICAgICAgICAgZGF0ZQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGlzQWZ0ZXJMYXN0U2FtcGxlID0gIWRlZmluZWRfZGVmYXVsdChuZXh0SW5kZXhEYXRlKTsKICAgICAgICAgIGNvbnN0IGlzQmVmb3JlTmV4dCA9IGlzQWZ0ZXJMYXN0U2FtcGxlIHx8IEp1bGlhbkRhdGVfZGVmYXVsdC5ncmVhdGVyVGhhbk9yRXF1YWxzKG5leHRJbmRleERhdGUsIGRhdGUpOwogICAgICAgICAgaWYgKGlzQWZ0ZXJQcmV2aW91cyAmJiBpc0JlZm9yZU5leHQpIHsKICAgICAgICAgICAgYmVmb3JlID0gbGFzdEluZGV4OwogICAgICAgICAgICBpZiAoIWlzQWZ0ZXJMYXN0U2FtcGxlICYmIG5leHRJbmRleERhdGUuZXF1YWxzKGRhdGUpKSB7CiAgICAgICAgICAgICAgKytiZWZvcmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWZ0ZXIgPSBiZWZvcmUgKyAxOwogICAgICAgICAgICBpbnRlcnBvbGF0ZSh0aGlzLCBkYXRlcywgdGhpcy5fc2FtcGxlcywgZGF0ZSwgYmVmb3JlLCBhZnRlciwgcmVzdWx0KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoZGF0ZXMsIGRhdGUsIEp1bGlhbkRhdGVfZGVmYXVsdC5jb21wYXJlLCB0aGlzLl9kYXRlQ29sdW1uKTsKICAgICAgICBpZiAoaW5kZXggPj0gMCkgewogICAgICAgICAgaWYgKGluZGV4IDwgZGF0ZXMubGVuZ3RoIC0gMSAmJiBkYXRlc1tpbmRleCArIDFdLmVxdWFscyhkYXRlKSkgewogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgfQogICAgICAgICAgYmVmb3JlID0gaW5kZXg7CiAgICAgICAgICBhZnRlciA9IGluZGV4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhZnRlciA9IH5pbmRleDsKICAgICAgICAgIGJlZm9yZSA9IGFmdGVyIC0gMTsKICAgICAgICAgIGlmIChiZWZvcmUgPCAwKSB7CiAgICAgICAgICAgIGJlZm9yZSA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuX2xhc3RJbmRleCA9IGJlZm9yZTsKICAgICAgICBpbnRlcnBvbGF0ZSh0aGlzLCBkYXRlcywgdGhpcy5fc2FtcGxlcywgZGF0ZSwgYmVmb3JlLCBhZnRlciwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc19kZWZhdWx0ID0gRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9IZWFkaW5nUGl0Y2hSb2xsLmpzCiAgZnVuY3Rpb24gSGVhZGluZ1BpdGNoUm9sbChoZWFkaW5nLCBwaXRjaCwgcm9sbCkgewogICAgdGhpcy5oZWFkaW5nID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVhZGluZywgMCk7CiAgICB0aGlzLnBpdGNoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocGl0Y2gsIDApOwogICAgdGhpcy5yb2xsID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocm9sbCwgMCk7CiAgfQogIHZhciBIZWFkaW5nUGl0Y2hSb2xsX2RlZmF1bHQ7CiAgdmFyIGluaXRfSGVhZGluZ1BpdGNoUm9sbCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVhZGluZ1BpdGNoUm9sbC5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmZyb21RdWF0ZXJuaW9uID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocXVhdGVybmlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJxdWF0ZXJuaW9uIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBIZWFkaW5nUGl0Y2hSb2xsKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRlc3QgPSAyICogKHF1YXRlcm5pb24udyAqIHF1YXRlcm5pb24ueSAtIHF1YXRlcm5pb24ueiAqIHF1YXRlcm5pb24ueCk7CiAgICAgICAgY29uc3QgZGVub21pbmF0b3JSb2xsID0gMSAtIDIgKiAocXVhdGVybmlvbi54ICogcXVhdGVybmlvbi54ICsgcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi55KTsKICAgICAgICBjb25zdCBudW1lcmF0b3JSb2xsID0gMiAqIChxdWF0ZXJuaW9uLncgKiBxdWF0ZXJuaW9uLnggKyBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLnopOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9ySGVhZGluZyA9IDEgLSAyICogKHF1YXRlcm5pb24ueSAqIHF1YXRlcm5pb24ueSArIHF1YXRlcm5pb24ueiAqIHF1YXRlcm5pb24ueik7CiAgICAgICAgY29uc3QgbnVtZXJhdG9ySGVhZGluZyA9IDIgKiAocXVhdGVybmlvbi53ICogcXVhdGVybmlvbi56ICsgcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi55KTsKICAgICAgICByZXN1bHQuaGVhZGluZyA9IC1NYXRoLmF0YW4yKG51bWVyYXRvckhlYWRpbmcsIGRlbm9taW5hdG9ySGVhZGluZyk7CiAgICAgICAgcmVzdWx0LnJvbGwgPSBNYXRoLmF0YW4yKG51bWVyYXRvclJvbGwsIGRlbm9taW5hdG9yUm9sbCk7CiAgICAgICAgcmVzdWx0LnBpdGNoID0gLU1hdGhfZGVmYXVsdC5hc2luQ2xhbXBlZCh0ZXN0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmZyb21EZWdyZWVzID0gZnVuY3Rpb24oaGVhZGluZywgcGl0Y2gsIHJvbGwsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhlYWRpbmcpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaGVhZGluZyBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwaXRjaCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXRjaCBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyb2xsKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJvbGwgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEhlYWRpbmdQaXRjaFJvbGwoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmhlYWRpbmcgPSBoZWFkaW5nICogTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRTsKICAgICAgICByZXN1bHQucGl0Y2ggPSBwaXRjaCAqIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUU7CiAgICAgICAgcmVzdWx0LnJvbGwgPSByb2xsICogTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmNsb25lID0gZnVuY3Rpb24oaGVhZGluZ1BpdGNoUm9sbCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaGVhZGluZ1BpdGNoUm9sbCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgSGVhZGluZ1BpdGNoUm9sbCgKICAgICAgICAgICAgaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nLAogICAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLnBpdGNoLAogICAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLnJvbGwKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5oZWFkaW5nID0gaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nOwogICAgICAgIHJlc3VsdC5waXRjaCA9IGhlYWRpbmdQaXRjaFJvbGwucGl0Y2g7CiAgICAgICAgcmVzdWx0LnJvbGwgPSBoZWFkaW5nUGl0Y2hSb2xsLnJvbGw7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LmhlYWRpbmcgPT09IHJpZ2h0LmhlYWRpbmcgJiYgbGVmdC5waXRjaCA9PT0gcmlnaHQucGl0Y2ggJiYgbGVmdC5yb2xsID09PSByaWdodC5yb2xsOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LmhlYWRpbmcsCiAgICAgICAgICByaWdodC5oZWFkaW5nLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQucGl0Y2gsCiAgICAgICAgICByaWdodC5waXRjaCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LnJvbGwsCiAgICAgICAgICByaWdodC5yb2xsLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gSGVhZGluZ1BpdGNoUm9sbC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBIZWFkaW5nUGl0Y2hSb2xsLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEhlYWRpbmdQaXRjaFJvbGwucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gSGVhZGluZ1BpdGNoUm9sbC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcywKICAgICAgICAgIHJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXMuaGVhZGluZ30sICR7dGhpcy5waXRjaH0sICR7dGhpcy5yb2xsfSlgOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsX2RlZmF1bHQgPSBIZWFkaW5nUGl0Y2hSb2xsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYnVpbGRNb2R1bGVVcmwuanMKICBmdW5jdGlvbiBnZXRCYXNlVXJsRnJvbUNlc2l1bVNjcmlwdCgpIHsKICAgIGNvbnN0IHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0Iik7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc2NyaXB0cy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICBjb25zdCBzcmMgPSBzY3JpcHRzW2ldLmdldEF0dHJpYnV0ZSgic3JjIik7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGNlc2l1bVNjcmlwdFJlZ2V4LmV4ZWMoc3JjKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiByZXN1bHRbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGZ1bmN0aW9uIHRyeU1ha2VBYnNvbHV0ZSh1cmwpIHsKICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhMikpIHsKICAgICAgYTIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICB9CiAgICBhMi5ocmVmID0gdXJsOwogICAgcmV0dXJuIGEyLmhyZWY7CiAgfQogIGZ1bmN0aW9uIGdldENlc2l1bUJhc2VVcmwoKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJhc2VSZXNvdXJjZSkpIHsKICAgICAgcmV0dXJuIGJhc2VSZXNvdXJjZTsKICAgIH0KICAgIGxldCBiYXNlVXJsU3RyaW5nOwogICAgaWYgKHR5cGVvZiBDRVNJVU1fQkFTRV9VUkwgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGJhc2VVcmxTdHJpbmcgPSBDRVNJVU1fQkFTRV9VUkw7CiAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbXBvcnRfbWV0YT8udXJsKSkgewogICAgICBiYXNlVXJsU3RyaW5nID0gZ2V0QWJzb2x1dGVVcmlfZGVmYXVsdCgiLiIsIGltcG9ydF9tZXRhLnVybCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJvYmplY3QiICYmIGRlZmluZWRfZGVmYXVsdChkZWZpbmUuYW1kKSAmJiAhZGVmaW5lLmFtZC50b1VybFVuZGVmaW5lZCAmJiBkZWZpbmVkX2RlZmF1bHQoX19yZXF1aXJlLnRvVXJsKSkgewogICAgICBiYXNlVXJsU3RyaW5nID0gZ2V0QWJzb2x1dGVVcmlfZGVmYXVsdCgKICAgICAgICAiLi4iLAogICAgICAgIGJ1aWxkTW9kdWxlVXJsKCJDb3JlL2J1aWxkTW9kdWxlVXJsLmpzIikKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGJhc2VVcmxTdHJpbmcgPSBnZXRCYXNlVXJsRnJvbUNlc2l1bVNjcmlwdCgpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYmFzZVVybFN0cmluZykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIlVuYWJsZSB0byBkZXRlcm1pbmUgQ2VzaXVtIGJhc2UgVVJMIGF1dG9tYXRpY2FsbHksIHRyeSBkZWZpbmluZyBhIGdsb2JhbCB2YXJpYWJsZSBjYWxsZWQgQ0VTSVVNX0JBU0VfVVJMLiIKICAgICAgKTsKICAgIH0KICAgIGJhc2VSZXNvdXJjZSA9IG5ldyBSZXNvdXJjZV9kZWZhdWx0KHsKICAgICAgdXJsOiB0cnlNYWtlQWJzb2x1dGUoYmFzZVVybFN0cmluZykKICAgIH0pOwogICAgYmFzZVJlc291cmNlLmFwcGVuZEZvcndhcmRTbGFzaCgpOwogICAgcmV0dXJuIGJhc2VSZXNvdXJjZTsKICB9CiAgZnVuY3Rpb24gYnVpbGRNb2R1bGVVcmxGcm9tUmVxdWlyZVRvVXJsKG1vZHVsZUlEKSB7CiAgICByZXR1cm4gdHJ5TWFrZUFic29sdXRlKF9fcmVxdWlyZS50b1VybChgLi4vJHttb2R1bGVJRH1gKSk7CiAgfQogIGZ1bmN0aW9uIGJ1aWxkTW9kdWxlVXJsRnJvbUJhc2VVcmwobW9kdWxlSUQpIHsKICAgIGNvbnN0IHJlc291cmNlID0gZ2V0Q2VzaXVtQmFzZVVybCgpLmdldERlcml2ZWRSZXNvdXJjZSh7CiAgICAgIHVybDogbW9kdWxlSUQKICAgIH0pOwogICAgcmV0dXJuIHJlc291cmNlLnVybDsKICB9CiAgZnVuY3Rpb24gYnVpbGRNb2R1bGVVcmwocmVsYXRpdmVVcmwpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGltcGxlbWVudGF0aW9uKSkgewogICAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gIm9iamVjdCIgJiYgZGVmaW5lZF9kZWZhdWx0KGRlZmluZS5hbWQpICYmICFkZWZpbmUuYW1kLnRvVXJsVW5kZWZpbmVkICYmIGRlZmluZWRfZGVmYXVsdChfX3JlcXVpcmUudG9VcmwpKSB7CiAgICAgICAgaW1wbGVtZW50YXRpb24gPSBidWlsZE1vZHVsZVVybEZyb21SZXF1aXJlVG9Vcmw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW1wbGVtZW50YXRpb24gPSBidWlsZE1vZHVsZVVybEZyb21CYXNlVXJsOwogICAgICB9CiAgICB9CiAgICBjb25zdCB1cmwgPSBpbXBsZW1lbnRhdGlvbihyZWxhdGl2ZVVybCk7CiAgICByZXR1cm4gdXJsOwogIH0KICB2YXIgaW1wb3J0X21ldGEsIGNlc2l1bVNjcmlwdFJlZ2V4LCBhMiwgYmFzZVJlc291cmNlLCBpbXBsZW1lbnRhdGlvbiwgYnVpbGRNb2R1bGVVcmxfZGVmYXVsdDsKICB2YXIgaW5pdF9idWlsZE1vZHVsZVVybCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYnVpbGRNb2R1bGVVcmwuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2dldEFic29sdXRlVXJpKCk7CiAgICAgIGluaXRfUmVzb3VyY2UoKTsKICAgICAgaW1wb3J0X21ldGEgPSB7fTsKICAgICAgY2VzaXVtU2NyaXB0UmVnZXggPSAvKCg/Oi4qXC8pfF4pQ2VzaXVtXC5qcyg/Olw/fFwjfCQpLzsKICAgICAgYnVpbGRNb2R1bGVVcmwuX2Nlc2l1bVNjcmlwdFJlZ2V4ID0gY2VzaXVtU2NyaXB0UmVnZXg7CiAgICAgIGJ1aWxkTW9kdWxlVXJsLl9idWlsZE1vZHVsZVVybEZyb21CYXNlVXJsID0gYnVpbGRNb2R1bGVVcmxGcm9tQmFzZVVybDsKICAgICAgYnVpbGRNb2R1bGVVcmwuX2NsZWFyQmFzZVJlc291cmNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgYmFzZVJlc291cmNlID0gdm9pZCAwOwogICAgICB9OwogICAgICBidWlsZE1vZHVsZVVybC5zZXRCYXNlVXJsID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBiYXNlUmVzb3VyY2UgPSBSZXNvdXJjZV9kZWZhdWx0LkRFRkFVTFQuZ2V0RGVyaXZlZFJlc291cmNlKHsKICAgICAgICAgIHVybDogdmFsdWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgYnVpbGRNb2R1bGVVcmwuZ2V0Q2VzaXVtQmFzZVVybCA9IGdldENlc2l1bUJhc2VVcmw7CiAgICAgIGJ1aWxkTW9kdWxlVXJsX2RlZmF1bHQgPSBidWlsZE1vZHVsZVVybDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0lhdTIwMDZYeXNTYW1wbGUuanMKICBmdW5jdGlvbiBJYXUyMDA2WHlzU2FtcGxlKHgsIHksIHMpIHsKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogICAgdGhpcy5zID0gczsKICB9CiAgdmFyIElhdTIwMDZYeXNTYW1wbGVfZGVmYXVsdDsKICB2YXIgaW5pdF9JYXUyMDA2WHlzU2FtcGxlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JYXUyMDA2WHlzU2FtcGxlLmpzIigpIHsKICAgICAgSWF1MjAwNlh5c1NhbXBsZV9kZWZhdWx0ID0gSWF1MjAwNlh5c1NhbXBsZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0lhdTIwMDZYeXNEYXRhLmpzCiAgZnVuY3Rpb24gSWF1MjAwNlh5c0RhdGEob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLl94eXNGaWxlVXJsVGVtcGxhdGUgPSBSZXNvdXJjZV9kZWZhdWx0LmNyZWF0ZUlmTmVlZGVkKAogICAgICBvcHRpb25zLnh5c0ZpbGVVcmxUZW1wbGF0ZQogICAgKTsKICAgIHRoaXMuX2ludGVycG9sYXRpb25PcmRlciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaW50ZXJwb2xhdGlvbk9yZGVyLCA5KTsKICAgIHRoaXMuX3NhbXBsZVplcm9KdWxpYW5FcGhlbWVyaXNEYXRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuc2FtcGxlWmVyb0p1bGlhbkVwaGVtZXJpc0RhdGUsCiAgICAgIDI0NDIzOTY1ZS0xCiAgICApOwogICAgdGhpcy5fc2FtcGxlWmVyb0RhdGVUVCA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoCiAgICAgIHRoaXMuX3NhbXBsZVplcm9KdWxpYW5FcGhlbWVyaXNEYXRlLAogICAgICAwLAogICAgICBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkKICAgICk7CiAgICB0aGlzLl9zdGVwU2l6ZURheXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0ZXBTaXplRGF5cywgMSk7CiAgICB0aGlzLl9zYW1wbGVzUGVyWHlzRmlsZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2FtcGxlc1Blclh5c0ZpbGUsIDFlMyk7CiAgICB0aGlzLl90b3RhbFNhbXBsZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnRvdGFsU2FtcGxlcywgMjc0MjYpOwogICAgdGhpcy5fc2FtcGxlcyA9IG5ldyBBcnJheSh0aGlzLl90b3RhbFNhbXBsZXMgKiAzKTsKICAgIHRoaXMuX2NodW5rRG93bmxvYWRzSW5Qcm9ncmVzcyA9IFtdOwogICAgY29uc3Qgb3JkZXIgPSB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXI7CiAgICBjb25zdCBkZW5vbSA9IHRoaXMuX2Rlbm9taW5hdG9ycyA9IG5ldyBBcnJheShvcmRlciArIDEpOwogICAgY29uc3QgeFRhYmxlID0gdGhpcy5feFRhYmxlID0gbmV3IEFycmF5KG9yZGVyICsgMSk7CiAgICBjb25zdCBzdGVwTiA9IE1hdGgucG93KHRoaXMuX3N0ZXBTaXplRGF5cywgb3JkZXIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gb3JkZXI7ICsraSkgewogICAgICBkZW5vbVtpXSA9IHN0ZXBOOwogICAgICB4VGFibGVbaV0gPSBpICogdGhpcy5fc3RlcFNpemVEYXlzOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8PSBvcmRlcjsgKytqKSB7CiAgICAgICAgaWYgKGogIT09IGkpIHsKICAgICAgICAgIGRlbm9tW2ldICo9IGkgLSBqOwogICAgICAgIH0KICAgICAgfQogICAgICBkZW5vbVtpXSA9IDEgLyBkZW5vbVtpXTsKICAgIH0KICAgIHRoaXMuX3dvcmsgPSBuZXcgQXJyYXkob3JkZXIgKyAxKTsKICAgIHRoaXMuX2NvZWYgPSBuZXcgQXJyYXkob3JkZXIgKyAxKTsKICB9CiAgZnVuY3Rpb24gZ2V0RGF5c1NpbmNlRXBvY2goeHlzLCBkYXlUVCwgc2Vjb25kVFQpIHsKICAgIGNvbnN0IGRhdGVUVCA9IGp1bGlhbkRhdGVTY3JhdGNoOwogICAgZGF0ZVRULmRheU51bWJlciA9IGRheVRUOwogICAgZGF0ZVRULnNlY29uZHNPZkRheSA9IHNlY29uZFRUOwogICAgcmV0dXJuIEp1bGlhbkRhdGVfZGVmYXVsdC5kYXlzRGlmZmVyZW5jZShkYXRlVFQsIHh5cy5fc2FtcGxlWmVyb0RhdGVUVCk7CiAgfQogIGZ1bmN0aW9uIHJlcXVlc3RYeXNDaHVuayh4eXNEYXRhLCBjaHVua0luZGV4KSB7CiAgICBpZiAoeHlzRGF0YS5fY2h1bmtEb3dubG9hZHNJblByb2dyZXNzW2NodW5rSW5kZXhdKSB7CiAgICAgIHJldHVybiB4eXNEYXRhLl9jaHVua0Rvd25sb2Fkc0luUHJvZ3Jlc3NbY2h1bmtJbmRleF07CiAgICB9CiAgICBsZXQgY2h1bmtVcmw7CiAgICBjb25zdCB4eXNGaWxlVXJsVGVtcGxhdGUgPSB4eXNEYXRhLl94eXNGaWxlVXJsVGVtcGxhdGU7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHh5c0ZpbGVVcmxUZW1wbGF0ZSkpIHsKICAgICAgY2h1bmtVcmwgPSB4eXNGaWxlVXJsVGVtcGxhdGUuZ2V0RGVyaXZlZFJlc291cmNlKHsKICAgICAgICB0ZW1wbGF0ZVZhbHVlczogewogICAgICAgICAgMDogY2h1bmtJbmRleAogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjaHVua1VybCA9IG5ldyBSZXNvdXJjZV9kZWZhdWx0KHsKICAgICAgICB1cmw6IGJ1aWxkTW9kdWxlVXJsX2RlZmF1bHQoYEFzc2V0cy9JQVUyMDA2X1hZUy9JQVUyMDA2X1hZU18ke2NodW5rSW5kZXh9Lmpzb25gKQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHByb21pc2UgPSBjaHVua1VybC5mZXRjaEpzb24oKS50aGVuKGZ1bmN0aW9uKGNodW5rKSB7CiAgICAgIHh5c0RhdGEuX2NodW5rRG93bmxvYWRzSW5Qcm9ncmVzc1tjaHVua0luZGV4XSA9IGZhbHNlOwogICAgICBjb25zdCBzYW1wbGVzID0geHlzRGF0YS5fc2FtcGxlczsKICAgICAgY29uc3QgbmV3U2FtcGxlcyA9IGNodW5rLnNhbXBsZXM7CiAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBjaHVua0luZGV4ICogeHlzRGF0YS5fc2FtcGxlc1Blclh5c0ZpbGUgKiAzOwogICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gbmV3U2FtcGxlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIHNhbXBsZXNbc3RhcnRJbmRleCArIGldID0gbmV3U2FtcGxlc1tpXTsKICAgICAgfQogICAgfSk7CiAgICB4eXNEYXRhLl9jaHVua0Rvd25sb2Fkc0luUHJvZ3Jlc3NbY2h1bmtJbmRleF0gPSBwcm9taXNlOwogICAgcmV0dXJuIHByb21pc2U7CiAgfQogIHZhciBqdWxpYW5EYXRlU2NyYXRjaCwgSWF1MjAwNlh5c0RhdGFfZGVmYXVsdDsKICB2YXIgaW5pdF9JYXUyMDA2WHlzRGF0YSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSWF1MjAwNlh5c0RhdGEuanMiKCkgewogICAgICBpbml0X2J1aWxkTW9kdWxlVXJsKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0lhdTIwMDZYeXNTYW1wbGUoKTsKICAgICAgaW5pdF9KdWxpYW5EYXRlKCk7CiAgICAgIGluaXRfUmVzb3VyY2UoKTsKICAgICAgaW5pdF9UaW1lU3RhbmRhcmQoKTsKICAgICAganVsaWFuRGF0ZVNjcmF0Y2ggPSBuZXcgSnVsaWFuRGF0ZV9kZWZhdWx0KDAsIDAsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSk7CiAgICAgIElhdTIwMDZYeXNEYXRhLnByb3RvdHlwZS5wcmVsb2FkID0gZnVuY3Rpb24oc3RhcnREYXlUVCwgc3RhcnRTZWNvbmRUVCwgc3RvcERheVRULCBzdG9wU2Vjb25kVFQpIHsKICAgICAgICBjb25zdCBzdGFydERheXNTaW5jZUVwb2NoID0gZ2V0RGF5c1NpbmNlRXBvY2goCiAgICAgICAgICB0aGlzLAogICAgICAgICAgc3RhcnREYXlUVCwKICAgICAgICAgIHN0YXJ0U2Vjb25kVFQKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0b3BEYXlzU2luY2VFcG9jaCA9IGdldERheXNTaW5jZUVwb2NoKHRoaXMsIHN0b3BEYXlUVCwgc3RvcFNlY29uZFRUKTsKICAgICAgICBsZXQgc3RhcnRJbmRleCA9IHN0YXJ0RGF5c1NpbmNlRXBvY2ggLyB0aGlzLl9zdGVwU2l6ZURheXMgLSB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXIgLyAyIHwgMDsKICAgICAgICBpZiAoc3RhcnRJbmRleCA8IDApIHsKICAgICAgICAgIHN0YXJ0SW5kZXggPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgc3RvcEluZGV4ID0gc3RvcERheXNTaW5jZUVwb2NoIC8gdGhpcy5fc3RlcFNpemVEYXlzIC0gdGhpcy5faW50ZXJwb2xhdGlvbk9yZGVyIC8gMiB8IDAgKyB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXI7CiAgICAgICAgaWYgKHN0b3BJbmRleCA+PSB0aGlzLl90b3RhbFNhbXBsZXMpIHsKICAgICAgICAgIHN0b3BJbmRleCA9IHRoaXMuX3RvdGFsU2FtcGxlcyAtIDE7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXJ0Q2h1bmsgPSBzdGFydEluZGV4IC8gdGhpcy5fc2FtcGxlc1Blclh5c0ZpbGUgfCAwOwogICAgICAgIGNvbnN0IHN0b3BDaHVuayA9IHN0b3BJbmRleCAvIHRoaXMuX3NhbXBsZXNQZXJYeXNGaWxlIHwgMDsKICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSBzdGFydENodW5rOyBpIDw9IHN0b3BDaHVuazsgKytpKSB7CiAgICAgICAgICBwcm9taXNlcy5wdXNoKHJlcXVlc3RYeXNDaHVuayh0aGlzLCBpKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7CiAgICAgIH07CiAgICAgIElhdTIwMDZYeXNEYXRhLnByb3RvdHlwZS5jb21wdXRlWHlzUmFkaWFucyA9IGZ1bmN0aW9uKGRheVRULCBzZWNvbmRUVCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZGF5c1NpbmNlRXBvY2ggPSBnZXREYXlzU2luY2VFcG9jaCh0aGlzLCBkYXlUVCwgc2Vjb25kVFQpOwogICAgICAgIGlmIChkYXlzU2luY2VFcG9jaCA8IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNlbnRlckluZGV4ID0gZGF5c1NpbmNlRXBvY2ggLyB0aGlzLl9zdGVwU2l6ZURheXMgfCAwOwogICAgICAgIGlmIChjZW50ZXJJbmRleCA+PSB0aGlzLl90b3RhbFNhbXBsZXMpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRlZ3JlZSA9IHRoaXMuX2ludGVycG9sYXRpb25PcmRlcjsKICAgICAgICBsZXQgZmlyc3RJbmRleCA9IGNlbnRlckluZGV4IC0gKGRlZ3JlZSAvIDIgfCAwKTsKICAgICAgICBpZiAoZmlyc3RJbmRleCA8IDApIHsKICAgICAgICAgIGZpcnN0SW5kZXggPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgbGFzdEluZGV4ID0gZmlyc3RJbmRleCArIGRlZ3JlZTsKICAgICAgICBpZiAobGFzdEluZGV4ID49IHRoaXMuX3RvdGFsU2FtcGxlcykgewogICAgICAgICAgbGFzdEluZGV4ID0gdGhpcy5fdG90YWxTYW1wbGVzIC0gMTsKICAgICAgICAgIGZpcnN0SW5kZXggPSBsYXN0SW5kZXggLSBkZWdyZWU7CiAgICAgICAgICBpZiAoZmlyc3RJbmRleCA8IDApIHsKICAgICAgICAgICAgZmlyc3RJbmRleCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBpc0RhdGFNaXNzaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3Qgc2FtcGxlcyA9IHRoaXMuX3NhbXBsZXM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2FtcGxlc1tmaXJzdEluZGV4ICogM10pKSB7CiAgICAgICAgICByZXF1ZXN0WHlzQ2h1bmsodGhpcywgZmlyc3RJbmRleCAvIHRoaXMuX3NhbXBsZXNQZXJYeXNGaWxlIHwgMCk7CiAgICAgICAgICBpc0RhdGFNaXNzaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2FtcGxlc1tsYXN0SW5kZXggKiAzXSkpIHsKICAgICAgICAgIHJlcXVlc3RYeXNDaHVuayh0aGlzLCBsYXN0SW5kZXggLyB0aGlzLl9zYW1wbGVzUGVyWHlzRmlsZSB8IDApOwogICAgICAgICAgaXNEYXRhTWlzc2luZyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChpc0RhdGFNaXNzaW5nKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSWF1MjAwNlh5c1NhbXBsZV9kZWZhdWx0KDAsIDAsIDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQueCA9IDA7CiAgICAgICAgICByZXN1bHQueSA9IDA7CiAgICAgICAgICByZXN1bHQucyA9IDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHggPSBkYXlzU2luY2VFcG9jaCAtIGZpcnN0SW5kZXggKiB0aGlzLl9zdGVwU2l6ZURheXM7CiAgICAgICAgY29uc3Qgd29yayA9IHRoaXMuX3dvcms7CiAgICAgICAgY29uc3QgZGVub20gPSB0aGlzLl9kZW5vbWluYXRvcnM7CiAgICAgICAgY29uc3QgY29lZiA9IHRoaXMuX2NvZWY7CiAgICAgICAgY29uc3QgeFRhYmxlID0gdGhpcy5feFRhYmxlOwogICAgICAgIGxldCBpLCBqOwogICAgICAgIGZvciAoaSA9IDA7IGkgPD0gZGVncmVlOyArK2kpIHsKICAgICAgICAgIHdvcmtbaV0gPSB4IC0geFRhYmxlW2ldOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDw9IGRlZ3JlZTsgKytpKSB7CiAgICAgICAgICBjb2VmW2ldID0gMTsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPD0gZGVncmVlOyArK2opIHsKICAgICAgICAgICAgaWYgKGogIT09IGkpIHsKICAgICAgICAgICAgICBjb2VmW2ldICo9IHdvcmtbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvZWZbaV0gKj0gZGVub21baV07CiAgICAgICAgICBsZXQgc2FtcGxlSW5kZXggPSAoZmlyc3RJbmRleCArIGkpICogMzsKICAgICAgICAgIHJlc3VsdC54ICs9IGNvZWZbaV0gKiBzYW1wbGVzW3NhbXBsZUluZGV4KytdOwogICAgICAgICAgcmVzdWx0LnkgKz0gY29lZltpXSAqIHNhbXBsZXNbc2FtcGxlSW5kZXgrK107CiAgICAgICAgICByZXN1bHQucyArPSBjb2VmW2ldICogc2FtcGxlc1tzYW1wbGVJbmRleF07CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIElhdTIwMDZYeXNEYXRhX2RlZmF1bHQgPSBJYXUyMDA2WHlzRGF0YTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0Z1bGxzY3JlZW4uanMKICB2YXIgX3N1cHBvcnRzRnVsbHNjcmVlbiwgX25hbWVzLCBGdWxsc2NyZWVuLCBGdWxsc2NyZWVuX2RlZmF1bHQ7CiAgdmFyIGluaXRfRnVsbHNjcmVlbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRnVsbHNjcmVlbi5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBfbmFtZXMgPSB7CiAgICAgICAgcmVxdWVzdEZ1bGxzY3JlZW46IHZvaWQgMCwKICAgICAgICBleGl0RnVsbHNjcmVlbjogdm9pZCAwLAogICAgICAgIGZ1bGxzY3JlZW5FbmFibGVkOiB2b2lkIDAsCiAgICAgICAgZnVsbHNjcmVlbkVsZW1lbnQ6IHZvaWQgMCwKICAgICAgICBmdWxsc2NyZWVuY2hhbmdlOiB2b2lkIDAsCiAgICAgICAgZnVsbHNjcmVlbmVycm9yOiB2b2lkIDAKICAgICAgfTsKICAgICAgRnVsbHNjcmVlbiA9IHt9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhGdWxsc2NyZWVuLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGVsZW1lbnQgdGhhdCBpcyBjdXJyZW50bHkgZnVsbHNjcmVlbiwgaWYgYW55LiAgVG8gc2ltcGx5IGNoZWNrIGlmIHRoZQogICAgICAgICAqIGJyb3dzZXIgaXMgaW4gZnVsbHNjcmVlbiBtb2RlIG9yIG5vdCwgdXNlIHtAbGluayBGdWxsc2NyZWVuI2Z1bGxzY3JlZW59LgogICAgICAgICAqIEBtZW1iZXJvZiBGdWxsc2NyZWVuCiAgICAgICAgICogQHR5cGUge29iamVjdH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGVtZW50OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudFtfbmFtZXMuZnVsbHNjcmVlbkVsZW1lbnRdOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG5hbWUgb2YgdGhlIGV2ZW50IG9uIHRoZSBkb2N1bWVudCB0aGF0IGlzIGZpcmVkIHdoZW4gZnVsbHNjcmVlbiBpcwogICAgICAgICAqIGVudGVyZWQgb3IgZXhpdGVkLiAgVGhpcyBldmVudCBuYW1lIGlzIGludGVuZGVkIGZvciB1c2Ugd2l0aCBhZGRFdmVudExpc3RlbmVyLgogICAgICAgICAqIEluIHlvdXIgZXZlbnQgaGFuZGxlciwgdG8gZGV0ZXJtaW5lIGlmIHRoZSBicm93c2VyIGlzIGluIGZ1bGxzY3JlZW4gbW9kZSBvciBub3QsCiAgICAgICAgICogdXNlIHtAbGluayBGdWxsc2NyZWVuI2Z1bGxzY3JlZW59LgogICAgICAgICAqIEBtZW1iZXJvZiBGdWxsc2NyZWVuCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBjaGFuZ2VFdmVudE5hbWU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4oKSkgewogICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9uYW1lcy5mdWxsc2NyZWVuY2hhbmdlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG5hbWUgb2YgdGhlIGV2ZW50IHRoYXQgaXMgZmlyZWQgd2hlbiBhIGZ1bGxzY3JlZW4gZXJyb3IKICAgICAgICAgKiBvY2N1cnMuICBUaGlzIGV2ZW50IG5hbWUgaXMgaW50ZW5kZWQgZm9yIHVzZSB3aXRoIGFkZEV2ZW50TGlzdGVuZXIuCiAgICAgICAgICogQG1lbWJlcm9mIEZ1bGxzY3JlZW4KICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVycm9yRXZlbnROYW1lOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfbmFtZXMuZnVsbHNjcmVlbmVycm9yOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogRGV0ZXJtaW5lIHdoZXRoZXIgdGhlIGJyb3dzZXIgd2lsbCBhbGxvdyBhbiBlbGVtZW50IHRvIGJlIG1hZGUgZnVsbHNjcmVlbiwgb3Igbm90LgogICAgICAgICAqIEZvciBleGFtcGxlLCBieSBkZWZhdWx0LCBpZnJhbWVzIGNhbm5vdCBnbyBmdWxsc2NyZWVuIHVubGVzcyB0aGUgY29udGFpbmluZyBwYWdlCiAgICAgICAgICogYWRkcyBhbiAiYWxsb3dmdWxsc2NyZWVuIiBhdHRyaWJ1dGUgKG9yIHByZWZpeGVkIGVxdWl2YWxlbnQpLgogICAgICAgICAqIEBtZW1iZXJvZiBGdWxsc2NyZWVuCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZW5hYmxlZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnRbX25hbWVzLmZ1bGxzY3JlZW5FbmFibGVkXTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIERldGVybWluZXMgaWYgdGhlIGJyb3dzZXIgaXMgY3VycmVudGx5IGluIGZ1bGxzY3JlZW4gbW9kZS4KICAgICAgICAgKiBAbWVtYmVyb2YgRnVsbHNjcmVlbgogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGZ1bGxzY3JlZW46IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4oKSkgewogICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIEZ1bGxzY3JlZW4uZWxlbWVudCAhPT0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoX3N1cHBvcnRzRnVsbHNjcmVlbikpIHsKICAgICAgICAgIHJldHVybiBfc3VwcG9ydHNGdWxsc2NyZWVuOwogICAgICAgIH0KICAgICAgICBfc3VwcG9ydHNGdWxsc2NyZWVuID0gZmFsc2U7CiAgICAgICAgY29uc3QgYm9keSA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgaWYgKHR5cGVvZiBib2R5LnJlcXVlc3RGdWxsc2NyZWVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfbmFtZXMucmVxdWVzdEZ1bGxzY3JlZW4gPSAicmVxdWVzdEZ1bGxzY3JlZW4iOwogICAgICAgICAgX25hbWVzLmV4aXRGdWxsc2NyZWVuID0gImV4aXRGdWxsc2NyZWVuIjsKICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRW5hYmxlZCA9ICJmdWxsc2NyZWVuRW5hYmxlZCI7CiAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbkVsZW1lbnQgPSAiZnVsbHNjcmVlbkVsZW1lbnQiOwogICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5jaGFuZ2UgPSAiZnVsbHNjcmVlbmNoYW5nZSI7CiAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbmVycm9yID0gImZ1bGxzY3JlZW5lcnJvciI7CiAgICAgICAgICBfc3VwcG9ydHNGdWxsc2NyZWVuID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiBfc3VwcG9ydHNGdWxsc2NyZWVuOwogICAgICAgIH0KICAgICAgICBjb25zdCBwcmVmaXhlcyA9IFsid2Via2l0IiwgIm1veiIsICJvIiwgIm1zIiwgImtodG1sIl07CiAgICAgICAgbGV0IG5hbWU7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHByZWZpeGVzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICBjb25zdCBwcmVmaXggPSBwcmVmaXhlc1tpXTsKICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9UmVxdWVzdEZ1bGxzY3JlZW5gOwogICAgICAgICAgaWYgKHR5cGVvZiBib2R5W25hbWVdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIF9uYW1lcy5yZXF1ZXN0RnVsbHNjcmVlbiA9IG5hbWU7CiAgICAgICAgICAgIF9zdXBwb3J0c0Z1bGxzY3JlZW4gPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmFtZSA9IGAke3ByZWZpeH1SZXF1ZXN0RnVsbFNjcmVlbmA7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYm9keVtuYW1lXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIF9uYW1lcy5yZXF1ZXN0RnVsbHNjcmVlbiA9IG5hbWU7CiAgICAgICAgICAgICAgX3N1cHBvcnRzRnVsbHNjcmVlbiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RXhpdEZ1bGxzY3JlZW5gOwogICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudFtuYW1lXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBfbmFtZXMuZXhpdEZ1bGxzY3JlZW4gPSBuYW1lOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmFtZSA9IGAke3ByZWZpeH1DYW5jZWxGdWxsU2NyZWVuYDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudFtuYW1lXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIF9uYW1lcy5leGl0RnVsbHNjcmVlbiA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RnVsbHNjcmVlbkVuYWJsZWRgOwogICAgICAgICAgaWYgKGRvY3VtZW50W25hbWVdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5FbmFibGVkID0gbmFtZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RnVsbFNjcmVlbkVuYWJsZWRgOwogICAgICAgICAgICBpZiAoZG9jdW1lbnRbbmFtZV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRW5hYmxlZCA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RnVsbHNjcmVlbkVsZW1lbnRgOwogICAgICAgICAgaWYgKGRvY3VtZW50W25hbWVdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5FbGVtZW50ID0gbmFtZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RnVsbFNjcmVlbkVsZW1lbnRgOwogICAgICAgICAgICBpZiAoZG9jdW1lbnRbbmFtZV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRWxlbWVudCA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9ZnVsbHNjcmVlbmNoYW5nZWA7CiAgICAgICAgICBpZiAoZG9jdW1lbnRbYG9uJHtuYW1lfWBdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gIm1zIikgewogICAgICAgICAgICAgIG5hbWUgPSAiTVNGdWxsc2NyZWVuQ2hhbmdlIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbmNoYW5nZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fWZ1bGxzY3JlZW5lcnJvcmA7CiAgICAgICAgICBpZiAoZG9jdW1lbnRbYG9uJHtuYW1lfWBdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gIm1zIikgewogICAgICAgICAgICAgIG5hbWUgPSAiTVNGdWxsc2NyZWVuRXJyb3IiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuZXJyb3IgPSBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gX3N1cHBvcnRzRnVsbHNjcmVlbjsKICAgICAgfTsKICAgICAgRnVsbHNjcmVlbi5yZXF1ZXN0RnVsbHNjcmVlbiA9IGZ1bmN0aW9uKGVsZW1lbnQsIHZyRGV2aWNlKSB7CiAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGVsZW1lbnRbX25hbWVzLnJlcXVlc3RGdWxsc2NyZWVuXSh7IHZyRGlzcGxheTogdnJEZXZpY2UgfSk7CiAgICAgIH07CiAgICAgIEZ1bGxzY3JlZW4uZXhpdEZ1bGxzY3JlZW4gPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZG9jdW1lbnRbX25hbWVzLmV4aXRGdWxsc2NyZWVuXSgpOwogICAgICB9OwogICAgICBGdWxsc2NyZWVuLl9uYW1lcyA9IF9uYW1lczsKICAgICAgRnVsbHNjcmVlbl9kZWZhdWx0ID0gRnVsbHNjcmVlbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ZlYXR1cmVEZXRlY3Rpb24uanMKICBmdW5jdGlvbiBleHRyYWN0VmVyc2lvbih2ZXJzaW9uU3RyaW5nKSB7CiAgICBjb25zdCBwYXJ0cyA9IHZlcnNpb25TdHJpbmcuc3BsaXQoIi4iKTsKICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBwYXJ0cy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICBwYXJ0c1tpXSA9IHBhcnNlSW50KHBhcnRzW2ldLCAxMCk7CiAgICB9CiAgICByZXR1cm4gcGFydHM7CiAgfQogIGZ1bmN0aW9uIGlzQ2hyb21lKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNDaHJvbWVSZXN1bHQpKSB7CiAgICAgIGlzQ2hyb21lUmVzdWx0ID0gZmFsc2U7CiAgICAgIGlmICghaXNFZGdlKCkpIHsKICAgICAgICBjb25zdCBmaWVsZHMgPSAvIENocm9tZVwvKFtcLjAtOV0rKS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgICBpc0Nocm9tZVJlc3VsdCA9IHRydWU7CiAgICAgICAgICBjaHJvbWVWZXJzaW9uUmVzdWx0ID0gZXh0cmFjdFZlcnNpb24oZmllbGRzWzFdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc0Nocm9tZVJlc3VsdDsKICB9CiAgZnVuY3Rpb24gY2hyb21lVmVyc2lvbigpIHsKICAgIHJldHVybiBpc0Nocm9tZSgpICYmIGNocm9tZVZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzU2FmYXJpKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNTYWZhcmlSZXN1bHQpKSB7CiAgICAgIGlzU2FmYXJpUmVzdWx0ID0gZmFsc2U7CiAgICAgIGlmICghaXNDaHJvbWUoKSAmJiAhaXNFZGdlKCkgJiYgLyBTYWZhcmlcL1tcLjAtOV0rLy50ZXN0KHRoZU5hdmlnYXRvci51c2VyQWdlbnQpKSB7CiAgICAgICAgY29uc3QgZmllbGRzID0gLyBWZXJzaW9uXC8oW1wuMC05XSspLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICAgIGlmIChmaWVsZHMgIT09IG51bGwpIHsKICAgICAgICAgIGlzU2FmYXJpUmVzdWx0ID0gdHJ1ZTsKICAgICAgICAgIHNhZmFyaVZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGlzU2FmYXJpUmVzdWx0OwogIH0KICBmdW5jdGlvbiBzYWZhcmlWZXJzaW9uKCkgewogICAgcmV0dXJuIGlzU2FmYXJpKCkgJiYgc2FmYXJpVmVyc2lvblJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaXNXZWJraXQoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpc1dlYmtpdFJlc3VsdCkpIHsKICAgICAgaXNXZWJraXRSZXN1bHQgPSBmYWxzZTsKICAgICAgY29uc3QgZmllbGRzID0gLyBBcHBsZVdlYktpdFwvKFtcLjAtOV0rKShcKz8pLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgaXNXZWJraXRSZXN1bHQgPSB0cnVlOwogICAgICAgIHdlYmtpdFZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICAgIHdlYmtpdFZlcnNpb25SZXN1bHQuaXNOaWdodGx5ID0gISFmaWVsZHNbMl07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc1dlYmtpdFJlc3VsdDsKICB9CiAgZnVuY3Rpb24gd2Via2l0VmVyc2lvbigpIHsKICAgIHJldHVybiBpc1dlYmtpdCgpICYmIHdlYmtpdFZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzSW50ZXJuZXRFeHBsb3JlcigpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdCkpIHsKICAgICAgaXNJbnRlcm5ldEV4cGxvcmVyUmVzdWx0ID0gZmFsc2U7CiAgICAgIGxldCBmaWVsZHM7CiAgICAgIGlmICh0aGVOYXZpZ2F0b3IuYXBwTmFtZSA9PT0gIk1pY3Jvc29mdCBJbnRlcm5ldCBFeHBsb3JlciIpIHsKICAgICAgICBmaWVsZHMgPSAvTVNJRSAoWzAtOV17MSx9W1wuMC05XXswLH0pLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICAgIGlmIChmaWVsZHMgIT09IG51bGwpIHsKICAgICAgICAgIGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdCA9IHRydWU7CiAgICAgICAgICBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHRoZU5hdmlnYXRvci5hcHBOYW1lID09PSAiTmV0c2NhcGUiKSB7CiAgICAgICAgZmllbGRzID0gL1RyaWRlbnRcLy4qcnY6KFswLTldezEsfVtcLjAtOV17MCx9KS8uZXhlYygKICAgICAgICAgIHRoZU5hdmlnYXRvci51c2VyQWdlbnQKICAgICAgICApOwogICAgICAgIGlmIChmaWVsZHMgIT09IG51bGwpIHsKICAgICAgICAgIGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdCA9IHRydWU7CiAgICAgICAgICBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNJbnRlcm5ldEV4cGxvcmVyUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvbigpIHsKICAgIHJldHVybiBpc0ludGVybmV0RXhwbG9yZXIoKSAmJiBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvblJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaXNFZGdlKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNFZGdlUmVzdWx0KSkgewogICAgICBpc0VkZ2VSZXN1bHQgPSBmYWxzZTsKICAgICAgY29uc3QgZmllbGRzID0gLyBFZGdcLyhbXC4wLTldKykvLmV4ZWModGhlTmF2aWdhdG9yLnVzZXJBZ2VudCk7CiAgICAgIGlmIChmaWVsZHMgIT09IG51bGwpIHsKICAgICAgICBpc0VkZ2VSZXN1bHQgPSB0cnVlOwogICAgICAgIGVkZ2VWZXJzaW9uUmVzdWx0ID0gZXh0cmFjdFZlcnNpb24oZmllbGRzWzFdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGlzRWRnZVJlc3VsdDsKICB9CiAgZnVuY3Rpb24gZWRnZVZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNFZGdlKCkgJiYgZWRnZVZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzRmlyZWZveCgpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzRmlyZWZveFJlc3VsdCkpIHsKICAgICAgaXNGaXJlZm94UmVzdWx0ID0gZmFsc2U7CiAgICAgIGNvbnN0IGZpZWxkcyA9IC9GaXJlZm94XC8oW1wuMC05XSspLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgaXNGaXJlZm94UmVzdWx0ID0gdHJ1ZTsKICAgICAgICBmaXJlZm94VmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc0ZpcmVmb3hSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzV2luZG93cygpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzV2luZG93c1Jlc3VsdCkpIHsKICAgICAgaXNXaW5kb3dzUmVzdWx0ID0gL1dpbmRvd3MvaS50ZXN0KHRoZU5hdmlnYXRvci5hcHBWZXJzaW9uKTsKICAgIH0KICAgIHJldHVybiBpc1dpbmRvd3NSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzSVBhZE9ySU9TKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNJUGFkT3JJT1NSZXN1bHQpKSB7CiAgICAgIGlzSVBhZE9ySU9TUmVzdWx0ID0gbmF2aWdhdG9yLnBsYXRmb3JtID09PSAiaVBob25lIiB8fCBuYXZpZ2F0b3IucGxhdGZvcm0gPT09ICJpUG9kIiB8fCBuYXZpZ2F0b3IucGxhdGZvcm0gPT09ICJpUGFkIjsKICAgIH0KICAgIHJldHVybiBpc0lQYWRPcklPU1Jlc3VsdDsKICB9CiAgZnVuY3Rpb24gZmlyZWZveFZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNGaXJlZm94KCkgJiYgZmlyZWZveFZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHN1cHBvcnRzUG9pbnRlckV2ZW50cygpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhhc1BvaW50ZXJFdmVudHMpKSB7CiAgICAgIGhhc1BvaW50ZXJFdmVudHMgPSAhaXNGaXJlZm94KCkgJiYgdHlwZW9mIFBvaW50ZXJFdmVudCAhPT0gInVuZGVmaW5lZCIgJiYgKCFkZWZpbmVkX2RlZmF1bHQodGhlTmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkKSB8fCB0aGVOYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQpOwogICAgfQogICAgcmV0dXJuIGhhc1BvaW50ZXJFdmVudHM7CiAgfQogIGZ1bmN0aW9uIHN1cHBvcnRzSW1hZ2VSZW5kZXJpbmdQaXhlbGF0ZWQoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkUmVzdWx0KSkgewogICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgY2FudmFzLnNldEF0dHJpYnV0ZSgKICAgICAgICAic3R5bGUiLAogICAgICAgICJpbWFnZS1yZW5kZXJpbmc6IC1tb3otY3Jpc3AtZWRnZXM7aW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7IgogICAgICApOwogICAgICBjb25zdCB0bXAyID0gY2FudmFzLnN0eWxlLmltYWdlUmVuZGVyaW5nOwogICAgICBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkUmVzdWx0ID0gZGVmaW5lZF9kZWZhdWx0KHRtcDIpICYmIHRtcDIgIT09ICIiOwogICAgICBpZiAoc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdCkgewogICAgICAgIGltYWdlUmVuZGVyaW5nVmFsdWVSZXN1bHQgPSB0bXAyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaW1hZ2VSZW5kZXJpbmdWYWx1ZSgpIHsKICAgIHJldHVybiBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkKCkgPyBpbWFnZVJlbmRlcmluZ1ZhbHVlUmVzdWx0IDogdm9pZCAwOwogIH0KICBmdW5jdGlvbiBzdXBwb3J0c1dlYlAoKSB7CiAgICBpZiAoIXN1cHBvcnRzV2ViUC5pbml0aWFsaXplZCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiWW91IG11c3QgY2FsbCBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViUC5pbml0aWFsaXplIGFuZCB3YWl0IGZvciB0aGUgcHJvbWlzZSB0byByZXNvbHZlIGJlZm9yZSBjYWxsaW5nIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNXZWJQIgogICAgICApOwogICAgfQogICAgcmV0dXJuIHN1cHBvcnRzV2ViUC5fcmVzdWx0OwogIH0KICB2YXIgdGhlTmF2aWdhdG9yLCBpc0Nocm9tZVJlc3VsdCwgY2hyb21lVmVyc2lvblJlc3VsdCwgaXNTYWZhcmlSZXN1bHQsIHNhZmFyaVZlcnNpb25SZXN1bHQsIGlzV2Via2l0UmVzdWx0LCB3ZWJraXRWZXJzaW9uUmVzdWx0LCBpc0ludGVybmV0RXhwbG9yZXJSZXN1bHQsIGludGVybmV0RXhwbG9yZXJWZXJzaW9uUmVzdWx0LCBpc0VkZ2VSZXN1bHQsIGVkZ2VWZXJzaW9uUmVzdWx0LCBpc0ZpcmVmb3hSZXN1bHQsIGZpcmVmb3hWZXJzaW9uUmVzdWx0LCBpc1dpbmRvd3NSZXN1bHQsIGlzSVBhZE9ySU9TUmVzdWx0LCBoYXNQb2ludGVyRXZlbnRzLCBpbWFnZVJlbmRlcmluZ1ZhbHVlUmVzdWx0LCBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkUmVzdWx0LCB0eXBlZEFycmF5VHlwZXMsIEZlYXR1cmVEZXRlY3Rpb24sIEZlYXR1cmVEZXRlY3Rpb25fZGVmYXVsdDsKICB2YXIgaW5pdF9GZWF0dXJlRGV0ZWN0aW9uID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GZWF0dXJlRGV0ZWN0aW9uLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0Z1bGxzY3JlZW4oKTsKICAgICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgdGhlTmF2aWdhdG9yID0gbmF2aWdhdG9yOwogICAgICB9IGVsc2UgewogICAgICAgIHRoZU5hdmlnYXRvciA9IHt9OwogICAgICB9CiAgICAgIHN1cHBvcnRzV2ViUC5fcHJvbWlzZSA9IHZvaWQgMDsKICAgICAgc3VwcG9ydHNXZWJQLl9yZXN1bHQgPSB2b2lkIDA7CiAgICAgIHN1cHBvcnRzV2ViUC5pbml0aWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdXBwb3J0c1dlYlAuX3Byb21pc2UpKSB7CiAgICAgICAgICByZXR1cm4gc3VwcG9ydHNXZWJQLl9wcm9taXNlOwogICAgICAgIH0KICAgICAgICBzdXBwb3J0c1dlYlAuX3Byb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgY29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2UoKTsKICAgICAgICAgIGltYWdlLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzdXBwb3J0c1dlYlAuX3Jlc3VsdCA9IGltYWdlLndpZHRoID4gMCAmJiBpbWFnZS5oZWlnaHQgPiAwOwogICAgICAgICAgICByZXNvbHZlKHN1cHBvcnRzV2ViUC5fcmVzdWx0KTsKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZS5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHN1cHBvcnRzV2ViUC5fcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgICAgIHJlc29sdmUoc3VwcG9ydHNXZWJQLl9yZXN1bHQpOwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlLnNyYyA9ICJkYXRhOmltYWdlL3dlYnA7YmFzZTY0LFVrbEdSaUlBQUFCWFJVSlFWbEE0SUJZQUFBQXdBUUNkQVNvQkFBRUFEc0QrSmFRQUEzQUFBQUFBIjsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gc3VwcG9ydHNXZWJQLl9wcm9taXNlOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhzdXBwb3J0c1dlYlAsIHsKICAgICAgICBpbml0aWFsaXplZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmluZWRfZGVmYXVsdChzdXBwb3J0c1dlYlAuX3Jlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdHlwZWRBcnJheVR5cGVzID0gW107CiAgICAgIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgdHlwZWRBcnJheVR5cGVzLnB1c2goCiAgICAgICAgICBJbnQ4QXJyYXksCiAgICAgICAgICBVaW50OEFycmF5LAogICAgICAgICAgSW50MTZBcnJheSwKICAgICAgICAgIFVpbnQxNkFycmF5LAogICAgICAgICAgSW50MzJBcnJheSwKICAgICAgICAgIFVpbnQzMkFycmF5LAogICAgICAgICAgRmxvYXQzMkFycmF5LAogICAgICAgICAgRmxvYXQ2NEFycmF5CiAgICAgICAgKTsKICAgICAgICBpZiAodHlwZW9mIFVpbnQ4Q2xhbXBlZEFycmF5ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdHlwZWRBcnJheVR5cGVzLnB1c2goVWludDhDbGFtcGVkQXJyYXkpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIFVpbnQ4Q2xhbXBlZEFycmF5ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdHlwZWRBcnJheVR5cGVzLnB1c2goVWludDhDbGFtcGVkQXJyYXkpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIEJpZ0ludDY0QXJyYXkgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICB0eXBlZEFycmF5VHlwZXMucHVzaChCaWdJbnQ2NEFycmF5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBCaWdVaW50NjRBcnJheSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHR5cGVkQXJyYXlUeXBlcy5wdXNoKEJpZ1VpbnQ2NEFycmF5KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgRmVhdHVyZURldGVjdGlvbiA9IHsKICAgICAgICBpc0Nocm9tZSwKICAgICAgICBjaHJvbWVWZXJzaW9uLAogICAgICAgIGlzU2FmYXJpLAogICAgICAgIHNhZmFyaVZlcnNpb24sCiAgICAgICAgaXNXZWJraXQsCiAgICAgICAgd2Via2l0VmVyc2lvbiwKICAgICAgICBpc0ludGVybmV0RXhwbG9yZXIsCiAgICAgICAgaW50ZXJuZXRFeHBsb3JlclZlcnNpb24sCiAgICAgICAgaXNFZGdlLAogICAgICAgIGVkZ2VWZXJzaW9uLAogICAgICAgIGlzRmlyZWZveCwKICAgICAgICBmaXJlZm94VmVyc2lvbiwKICAgICAgICBpc1dpbmRvd3MsCiAgICAgICAgaXNJUGFkT3JJT1MsCiAgICAgICAgaGFyZHdhcmVDb25jdXJyZW5jeTogZGVmYXVsdFZhbHVlX2RlZmF1bHQodGhlTmF2aWdhdG9yLmhhcmR3YXJlQ29uY3VycmVuY3ksIDMpLAogICAgICAgIHN1cHBvcnRzUG9pbnRlckV2ZW50cywKICAgICAgICBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkLAogICAgICAgIHN1cHBvcnRzV2ViUCwKICAgICAgICBpbWFnZVJlbmRlcmluZ1ZhbHVlLAogICAgICAgIHR5cGVkQXJyYXlUeXBlcwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzQmFzaXMgPSBmdW5jdGlvbihzY2VuZSkgewogICAgICAgIHJldHVybiBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViQXNzZW1ibHkoKSAmJiBzY2VuZS5jb250ZXh0LnN1cHBvcnRzQmFzaXM7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNGdWxsc2NyZWVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEZ1bGxzY3JlZW5fZGVmYXVsdC5zdXBwb3J0c0Z1bGxzY3JlZW4oKTsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1R5cGVkQXJyYXlzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNCaWdJbnQ2NEFycmF5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBCaWdJbnQ2NEFycmF5ICE9PSAidW5kZWZpbmVkIjsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c0JpZ1VpbnQ2NEFycmF5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBCaWdVaW50NjRBcnJheSAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNCaWdJbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIEJpZ0ludCAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNXZWJXb3JrZXJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBXb3JrZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViQXNzZW1ibHkgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIFdlYkFzc2VtYmx5ICE9PSAidW5kZWZpbmVkIjsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1dlYmdsMiA9IGZ1bmN0aW9uKHNjZW5lKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJzY2VuZSIsIHNjZW5lKTsKICAgICAgICByZXR1cm4gc2NlbmUuY29udGV4dC53ZWJnbDI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNFc21XZWJXb3JrZXJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICFpc0ZpcmVmb3goKSB8fCBwYXJzZUludChmaXJlZm94VmVyc2lvblJlc3VsdCkgPj0gMTE0OwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQgPSBGZWF0dXJlRGV0ZWN0aW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhdGVybmlvbi5qcwogIGZ1bmN0aW9uIFF1YXRlcm5pb24oeCwgeSwgeiwgdykgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMueiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgdGhpcy53ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodywgMCk7CiAgfQogIHZhciBmcm9tQXhpc0FuZ2xlU2NyYXRjaCwgZnJvbVJvdGF0aW9uTWF0cml4TmV4dCwgZnJvbVJvdGF0aW9uTWF0cml4UXVhdCwgc2NyYXRjaEhQUlF1YXRlcm5pb24sIHNjcmF0Y2hIZWFkaW5nUXVhdGVybmlvbiwgc2NyYXRjaFBpdGNoUXVhdGVybmlvbiwgc2NyYXRjaFJvbGxRdWF0ZXJuaW9uLCBzYW1wbGVkUXVhdGVybmlvbkF4aXMsIHNhbXBsZWRRdWF0ZXJuaW9uUm90YXRpb24sIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24sIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjAsIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUsIGxlcnBTY3JhdGNoNCwgc2xlcnBFbmROZWdhdGVkLCBzbGVycFNjYWxlZFAsIHNsZXJwU2NhbGVkUiwgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMCwgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMSwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjAsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xLCBmYXN0U2xlcnBTY3JhdGNoUXVhdGVybmlvbiwgb3BtdSwgdSwgdiwgYlQsIGJELCBRdWF0ZXJuaW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfUXVhdGVybmlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhdGVybmlvbi5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0ZlYXR1cmVEZXRlY3Rpb24oKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBmcm9tQXhpc0FuZ2xlU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlID0gZnVuY3Rpb24oYXhpcywgYW5nbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYXhpcyIsIGF4aXMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiYW5nbGUiLCBhbmdsZSk7CiAgICAgICAgY29uc3QgaGFsZkFuZ2xlID0gYW5nbGUgLyAyOwogICAgICAgIGNvbnN0IHMgPSBNYXRoLnNpbihoYWxmQW5nbGUpOwogICAgICAgIGZyb21BeGlzQW5nbGVTY3JhdGNoID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShheGlzLCBmcm9tQXhpc0FuZ2xlU2NyYXRjaCk7CiAgICAgICAgY29uc3QgeCA9IGZyb21BeGlzQW5nbGVTY3JhdGNoLnggKiBzOwogICAgICAgIGNvbnN0IHkgPSBmcm9tQXhpc0FuZ2xlU2NyYXRjaC55ICogczsKICAgICAgICBjb25zdCB6ID0gZnJvbUF4aXNBbmdsZVNjcmF0Y2gueiAqIHM7CiAgICAgICAgY29uc3QgdyA9IE1hdGguY29zKGhhbGZBbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBRdWF0ZXJuaW9uKHgsIHksIHosIHcpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZnJvbVJvdGF0aW9uTWF0cml4TmV4dCA9IFsxLCAyLCAwXTsKICAgICAgZnJvbVJvdGF0aW9uTWF0cml4UXVhdCA9IG5ldyBBcnJheSgzKTsKICAgICAgUXVhdGVybmlvbi5mcm9tUm90YXRpb25NYXRyaXggPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBsZXQgcm9vdDsKICAgICAgICBsZXQgeDsKICAgICAgICBsZXQgeTsKICAgICAgICBsZXQgejsKICAgICAgICBsZXQgdzsKICAgICAgICBjb25zdCBtMDAgPSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjBST1cwXTsKICAgICAgICBjb25zdCBtMTEgPSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cxXTsKICAgICAgICBjb25zdCBtMjIgPSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cyXTsKICAgICAgICBjb25zdCB0cmFjZSA9IG0wMCArIG0xMSArIG0yMjsKICAgICAgICBpZiAodHJhY2UgPiAwKSB7CiAgICAgICAgICByb290ID0gTWF0aC5zcXJ0KHRyYWNlICsgMSk7CiAgICAgICAgICB3ID0gMC41ICogcm9vdDsKICAgICAgICAgIHJvb3QgPSAwLjUgLyByb290OwogICAgICAgICAgeCA9IChtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cyXSAtIG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzFdKSAqIHJvb3Q7CiAgICAgICAgICB5ID0gKG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzBdIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMl0pICogcm9vdDsKICAgICAgICAgIHogPSAobWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMV0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cwXSkgKiByb290OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBuZXh0ID0gZnJvbVJvdGF0aW9uTWF0cml4TmV4dDsKICAgICAgICAgIGxldCBpID0gMDsKICAgICAgICAgIGlmIChtMTEgPiBtMDApIHsKICAgICAgICAgICAgaSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobTIyID4gbTAwICYmIG0yMiA+IG0xMSkgewogICAgICAgICAgICBpID0gMjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGogPSBuZXh0W2ldOwogICAgICAgICAgY29uc3QgayA9IG5leHRbal07CiAgICAgICAgICByb290ID0gTWF0aC5zcXJ0KAogICAgICAgICAgICBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChpLCBpKV0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChqLCBqKV0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChrLCBrKV0gKyAxCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcXVhdCA9IGZyb21Sb3RhdGlvbk1hdHJpeFF1YXQ7CiAgICAgICAgICBxdWF0W2ldID0gMC41ICogcm9vdDsKICAgICAgICAgIHJvb3QgPSAwLjUgLyByb290OwogICAgICAgICAgdyA9IChtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChrLCBqKV0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChqLCBrKV0pICogcm9vdDsKICAgICAgICAgIHF1YXRbal0gPSAobWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaiwgaSldICsgbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaSwgaildKSAqIHJvb3Q7CiAgICAgICAgICBxdWF0W2tdID0gKG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuZ2V0RWxlbWVudEluZGV4KGssIGkpXSArIG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuZ2V0RWxlbWVudEluZGV4KGksIGspXSkgKiByb290OwogICAgICAgICAgeCA9IC1xdWF0WzBdOwogICAgICAgICAgeSA9IC1xdWF0WzFdOwogICAgICAgICAgeiA9IC1xdWF0WzJdOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24oeCwgeSwgeiwgdyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJlc3VsdC53ID0gdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoSFBSUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNjcmF0Y2hIZWFkaW5nUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNjcmF0Y2hQaXRjaFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzY3JhdGNoUm9sbFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBRdWF0ZXJuaW9uLmZyb21IZWFkaW5nUGl0Y2hSb2xsID0gZnVuY3Rpb24oaGVhZGluZ1BpdGNoUm9sbCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJoZWFkaW5nUGl0Y2hSb2xsIiwgaGVhZGluZ1BpdGNoUm9sbCk7CiAgICAgICAgc2NyYXRjaFJvbGxRdWF0ZXJuaW9uID0gUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwKICAgICAgICAgIGhlYWRpbmdQaXRjaFJvbGwucm9sbCwKICAgICAgICAgIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoUGl0Y2hRdWF0ZXJuaW9uID0gUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwKICAgICAgICAgIC1oZWFkaW5nUGl0Y2hSb2xsLnBpdGNoLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICByZXN1bHQgPSBRdWF0ZXJuaW9uLm11bHRpcGx5KAogICAgICAgICAgc2NyYXRjaFBpdGNoUXVhdGVybmlvbiwKICAgICAgICAgIHNjcmF0Y2hSb2xsUXVhdGVybmlvbiwKICAgICAgICAgIHNjcmF0Y2hQaXRjaFF1YXRlcm5pb24KICAgICAgICApOwogICAgICAgIHNjcmF0Y2hIZWFkaW5nUXVhdGVybmlvbiA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICAtaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nLAogICAgICAgICAgc2NyYXRjaEhQUlF1YXRlcm5pb24KICAgICAgICApOwogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLm11bHRpcGx5KHNjcmF0Y2hIZWFkaW5nUXVhdGVybmlvbiwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBzYW1wbGVkUXVhdGVybmlvbkF4aXMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUm90YXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMENvbmp1Z2F0ZSA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIFF1YXRlcm5pb24ucGFja2VkTGVuZ3RoID0gNDsKICAgICAgUXVhdGVybmlvbi5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuejsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnc7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJlc3VsdC55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIDFdOwogICAgICAgIHJlc3VsdC56ID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIDJdOwogICAgICAgIHJlc3VsdC53ID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIDNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ucGFja2VkSW50ZXJwb2xhdGlvbkxlbmd0aCA9IDM7CiAgICAgIFF1YXRlcm5pb24uY29udmVydFBhY2tlZEFycmF5Rm9ySW50ZXJwb2xhdGlvbiA9IGZ1bmN0aW9uKHBhY2tlZEFycmF5LCBzdGFydGluZ0luZGV4LCBsYXN0SW5kZXgsIHJlc3VsdCkgewogICAgICAgIFF1YXRlcm5pb24udW5wYWNrKAogICAgICAgICAgcGFja2VkQXJyYXksCiAgICAgICAgICBsYXN0SW5kZXggKiA0LAogICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMENvbmp1Z2F0ZQogICAgICAgICk7CiAgICAgICAgUXVhdGVybmlvbi5jb25qdWdhdGUoCiAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wQ29uanVnYXRlLAogICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMENvbmp1Z2F0ZQogICAgICAgICk7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGxhc3RJbmRleCAtIHN0YXJ0aW5nSW5kZXggKyAxOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGkgKiAzOwogICAgICAgICAgUXVhdGVybmlvbi51bnBhY2soCiAgICAgICAgICAgIHBhY2tlZEFycmF5LAogICAgICAgICAgICAoc3RhcnRpbmdJbmRleCArIGkpICogNCwKICAgICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbgogICAgICAgICAgKTsKICAgICAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHkoCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24sCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUsCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24KICAgICAgICAgICk7CiAgICAgICAgICBpZiAoc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbi53IDwgMCkgewogICAgICAgICAgICBRdWF0ZXJuaW9uLm5lZ2F0ZSgKICAgICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uLAogICAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIFF1YXRlcm5pb24uY29tcHV0ZUF4aXMoCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24sCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uQXhpcwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGFuZ2xlID0gUXVhdGVybmlvbi5jb21wdXRlQW5nbGUoc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbik7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0W29mZnNldF0gPSBzYW1wbGVkUXVhdGVybmlvbkF4aXMueCAqIGFuZ2xlOwogICAgICAgICAgcmVzdWx0W29mZnNldCArIDFdID0gc2FtcGxlZFF1YXRlcm5pb25BeGlzLnkgKiBhbmdsZTsKICAgICAgICAgIHJlc3VsdFtvZmZzZXQgKyAyXSA9IHNhbXBsZWRRdWF0ZXJuaW9uQXhpcy56ICogYW5nbGU7CiAgICAgICAgfQogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnVucGFja0ludGVycG9sYXRpb25SZXN1bHQgPSBmdW5jdGlvbihhcnJheSwgc291cmNlQXJyYXksIGZpcnN0SW5kZXgsIGxhc3RJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShhcnJheSwgMCwgc2FtcGxlZFF1YXRlcm5pb25Sb3RhdGlvbik7CiAgICAgICAgY29uc3QgbWFnbml0dWRlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShzYW1wbGVkUXVhdGVybmlvblJvdGF0aW9uKTsKICAgICAgICBRdWF0ZXJuaW9uLnVucGFjayhzb3VyY2VBcnJheSwgbGFzdEluZGV4ICogNCwgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMCk7CiAgICAgICAgaWYgKG1hZ25pdHVkZSA9PT0gMCkgewogICAgICAgICAgUXVhdGVybmlvbi5jbG9uZShRdWF0ZXJuaW9uLklERU5USVRZLCBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblJvdGF0aW9uLAogICAgICAgICAgICBtYWduaXR1ZGUsCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLm11bHRpcGx5KAogICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbiwKICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjAsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmNsb25lID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocXVhdGVybmlvbikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUXVhdGVybmlvbigKICAgICAgICAgICAgcXVhdGVybmlvbi54LAogICAgICAgICAgICBxdWF0ZXJuaW9uLnksCiAgICAgICAgICAgIHF1YXRlcm5pb24ueiwKICAgICAgICAgICAgcXVhdGVybmlvbi53CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHF1YXRlcm5pb24ueDsKICAgICAgICByZXN1bHQueSA9IHF1YXRlcm5pb24ueTsKICAgICAgICByZXN1bHQueiA9IHF1YXRlcm5pb24uejsKICAgICAgICByZXN1bHQudyA9IHF1YXRlcm5pb24udzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmNvbmp1Z2F0ZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1xdWF0ZXJuaW9uLng7CiAgICAgICAgcmVzdWx0LnkgPSAtcXVhdGVybmlvbi55OwogICAgICAgIHJlc3VsdC56ID0gLXF1YXRlcm5pb24uejsKICAgICAgICByZXN1bHQudyA9IHF1YXRlcm5pb24udzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLm1hZ25pdHVkZVNxdWFyZWQgPSBmdW5jdGlvbihxdWF0ZXJuaW9uKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgcmV0dXJuIHF1YXRlcm5pb24ueCAqIHF1YXRlcm5pb24ueCArIHF1YXRlcm5pb24ueSAqIHF1YXRlcm5pb24ueSArIHF1YXRlcm5pb24ueiAqIHF1YXRlcm5pb24ueiArIHF1YXRlcm5pb24udyAqIHF1YXRlcm5pb24udzsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5tYWduaXR1ZGUgPSBmdW5jdGlvbihxdWF0ZXJuaW9uKSB7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydChRdWF0ZXJuaW9uLm1hZ25pdHVkZVNxdWFyZWQocXVhdGVybmlvbikpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBpbnZlcnNlTWFnbml0dWRlID0gMSAvIFF1YXRlcm5pb24ubWFnbml0dWRlKHF1YXRlcm5pb24pOwogICAgICAgIGNvbnN0IHggPSBxdWF0ZXJuaW9uLnggKiBpbnZlcnNlTWFnbml0dWRlOwogICAgICAgIGNvbnN0IHkgPSBxdWF0ZXJuaW9uLnkgKiBpbnZlcnNlTWFnbml0dWRlOwogICAgICAgIGNvbnN0IHogPSBxdWF0ZXJuaW9uLnogKiBpbnZlcnNlTWFnbml0dWRlOwogICAgICAgIGNvbnN0IHcgPSBxdWF0ZXJuaW9uLncgKiBpbnZlcnNlTWFnbml0dWRlOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJlc3VsdC53ID0gdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmludmVyc2UgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbWFnbml0dWRlU3F1YXJlZCA9IFF1YXRlcm5pb24ubWFnbml0dWRlU3F1YXJlZChxdWF0ZXJuaW9uKTsKICAgICAgICByZXN1bHQgPSBRdWF0ZXJuaW9uLmNvbmp1Z2F0ZShxdWF0ZXJuaW9uLCByZXN1bHQpOwogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIocmVzdWx0LCAxIC8gbWFnbml0dWRlU3F1YXJlZCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5hZGQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBsZWZ0LnggKyByaWdodC54OwogICAgICAgIHJlc3VsdC55ID0gbGVmdC55ICsgcmlnaHQueTsKICAgICAgICByZXN1bHQueiA9IGxlZnQueiArIHJpZ2h0Lno7CiAgICAgICAgcmVzdWx0LncgPSBsZWZ0LncgKyByaWdodC53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBsZWZ0LnggLSByaWdodC54OwogICAgICAgIHJlc3VsdC55ID0gbGVmdC55IC0gcmlnaHQueTsKICAgICAgICByZXN1bHQueiA9IGxlZnQueiAtIHJpZ2h0Lno7CiAgICAgICAgcmVzdWx0LncgPSBsZWZ0LncgLSByaWdodC53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubmVnYXRlID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gLXF1YXRlcm5pb24ueDsKICAgICAgICByZXN1bHQueSA9IC1xdWF0ZXJuaW9uLnk7CiAgICAgICAgcmVzdWx0LnogPSAtcXVhdGVybmlvbi56OwogICAgICAgIHJlc3VsdC53ID0gLXF1YXRlcm5pb24udzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmRvdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICByZXR1cm4gbGVmdC54ICogcmlnaHQueCArIGxlZnQueSAqIHJpZ2h0LnkgKyBsZWZ0LnogKiByaWdodC56ICsgbGVmdC53ICogcmlnaHQudzsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5tdWx0aXBseSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBsZWZ0WCA9IGxlZnQueDsKICAgICAgICBjb25zdCBsZWZ0WSA9IGxlZnQueTsKICAgICAgICBjb25zdCBsZWZ0WiA9IGxlZnQuejsKICAgICAgICBjb25zdCBsZWZ0VyA9IGxlZnQudzsKICAgICAgICBjb25zdCByaWdodFggPSByaWdodC54OwogICAgICAgIGNvbnN0IHJpZ2h0WSA9IHJpZ2h0Lnk7CiAgICAgICAgY29uc3QgcmlnaHRaID0gcmlnaHQuejsKICAgICAgICBjb25zdCByaWdodFcgPSByaWdodC53OwogICAgICAgIGNvbnN0IHggPSBsZWZ0VyAqIHJpZ2h0WCArIGxlZnRYICogcmlnaHRXICsgbGVmdFkgKiByaWdodFogLSBsZWZ0WiAqIHJpZ2h0WTsKICAgICAgICBjb25zdCB5ID0gbGVmdFcgKiByaWdodFkgLSBsZWZ0WCAqIHJpZ2h0WiArIGxlZnRZICogcmlnaHRXICsgbGVmdFogKiByaWdodFg7CiAgICAgICAgY29uc3QgeiA9IGxlZnRXICogcmlnaHRaICsgbGVmdFggKiByaWdodFkgLSBsZWZ0WSAqIHJpZ2h0WCArIGxlZnRaICogcmlnaHRXOwogICAgICAgIGNvbnN0IHcgPSBsZWZ0VyAqIHJpZ2h0VyAtIGxlZnRYICogcmlnaHRYIC0gbGVmdFkgKiByaWdodFkgLSBsZWZ0WiAqIHJpZ2h0WjsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgc2NhbGFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gcXVhdGVybmlvbi54ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gcXVhdGVybmlvbi55ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gcXVhdGVybmlvbi56ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC53ID0gcXVhdGVybmlvbi53ICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uZGl2aWRlQnlTY2FsYXIgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBxdWF0ZXJuaW9uLnggLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBxdWF0ZXJuaW9uLnkgLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnogPSBxdWF0ZXJuaW9uLnogLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LncgPSBxdWF0ZXJuaW9uLncgLyBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5jb21wdXRlQXhpcyA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB3ID0gcXVhdGVybmlvbi53OwogICAgICAgIGlmIChNYXRoLmFicyh3IC0gMSkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYgfHwgTWF0aC5hYnModyArIDEpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICByZXN1bHQueCA9IDE7CiAgICAgICAgICByZXN1bHQueSA9IHJlc3VsdC56ID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNjYWxhciA9IDEgLyBNYXRoLnNxcnQoMSAtIHcgKiB3KTsKICAgICAgICByZXN1bHQueCA9IHF1YXRlcm5pb24ueCAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueSA9IHF1YXRlcm5pb24ueSAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IHF1YXRlcm5pb24ueiAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmNvbXB1dGVBbmdsZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24pIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBpZiAoTWF0aC5hYnMocXVhdGVybmlvbi53IC0gMSkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMiAqIE1hdGguYWNvcyhxdWF0ZXJuaW9uLncpOwogICAgICB9OwogICAgICBsZXJwU2NyYXRjaDQgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBRdWF0ZXJuaW9uLmxlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgbGVycFNjcmF0Y2g0ID0gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKGVuZCwgdCwgbGVycFNjcmF0Y2g0KTsKICAgICAgICByZXN1bHQgPSBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIoc3RhcnQsIDEgLSB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmFkZChsZXJwU2NyYXRjaDQsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2xlcnBFbmROZWdhdGVkID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2xlcnBTY2FsZWRQID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2xlcnBTY2FsZWRSID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgUXVhdGVybmlvbi5zbGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBsZXQgZG90ID0gUXVhdGVybmlvbi5kb3Qoc3RhcnQsIGVuZCk7CiAgICAgICAgbGV0IHIgPSBlbmQ7CiAgICAgICAgaWYgKGRvdCA8IDApIHsKICAgICAgICAgIGRvdCA9IC1kb3Q7CiAgICAgICAgICByID0gc2xlcnBFbmROZWdhdGVkID0gUXVhdGVybmlvbi5uZWdhdGUoZW5kLCBzbGVycEVuZE5lZ2F0ZWQpOwogICAgICAgIH0KICAgICAgICBpZiAoMSAtIGRvdCA8IE1hdGhfZGVmYXVsdC5FUFNJTE9ONikgewogICAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24ubGVycChzdGFydCwgciwgdCwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLmFjb3MoZG90KTsKICAgICAgICBzbGVycFNjYWxlZFAgPSBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBzdGFydCwKICAgICAgICAgIE1hdGguc2luKCgxIC0gdCkgKiB0aGV0YSksCiAgICAgICAgICBzbGVycFNjYWxlZFAKICAgICAgICApOwogICAgICAgIHNsZXJwU2NhbGVkUiA9IFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIHIsCiAgICAgICAgICBNYXRoLnNpbih0ICogdGhldGEpLAogICAgICAgICAgc2xlcnBTY2FsZWRSCiAgICAgICAgKTsKICAgICAgICByZXN1bHQgPSBRdWF0ZXJuaW9uLmFkZChzbGVycFNjYWxlZFAsIHNsZXJwU2NhbGVkUiwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKHJlc3VsdCwgMSAvIE1hdGguc2luKHRoZXRhKSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5sb2cgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoX2RlZmF1bHQuYWNvc0NsYW1wZWQocXVhdGVybmlvbi53KTsKICAgICAgICBsZXQgdGhldGFPdmVyU2luVGhldGEgPSAwOwogICAgICAgIGlmICh0aGV0YSAhPT0gMCkgewogICAgICAgICAgdGhldGFPdmVyU2luVGhldGEgPSB0aGV0YSAvIE1hdGguc2luKHRoZXRhKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHF1YXRlcm5pb24sIHRoZXRhT3ZlclNpblRoZXRhLCByZXN1bHQpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmV4cCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdGhldGEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGNhcnRlc2lhbjExKTsKICAgICAgICBsZXQgc2luVGhldGFPdmVyVGhldGEgPSAwOwogICAgICAgIGlmICh0aGV0YSAhPT0gMCkgewogICAgICAgICAgc2luVGhldGFPdmVyVGhldGEgPSBNYXRoLnNpbih0aGV0YSkgLyB0aGV0YTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54ICogc2luVGhldGFPdmVyVGhldGE7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55ICogc2luVGhldGFPdmVyVGhldGE7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56ICogc2luVGhldGFPdmVyVGhldGE7CiAgICAgICAgcmVzdWx0LncgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjAgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIFF1YXRlcm5pb24uY29tcHV0ZUlubmVyUXVhZHJhbmdsZSA9IGZ1bmN0aW9uKHEwLCBxMTIsIHEyMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMCIsIHEwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInExIiwgcTEyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInEyIiwgcTIyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgcUludiA9IFF1YXRlcm5pb24uY29uanVnYXRlKHExMiwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjApOwogICAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHkocUludiwgcTIyLCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSk7CiAgICAgICAgY29uc3QgY2FydDAgPSBRdWF0ZXJuaW9uLmxvZyhzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSwgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMCk7CiAgICAgICAgUXVhdGVybmlvbi5tdWx0aXBseShxSW52LCBxMCwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEpOwogICAgICAgIGNvbnN0IGNhcnQxID0gUXVhdGVybmlvbi5sb2coc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEsIHNxdWFkU2NyYXRjaENhcnRlc2lhbjEpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2FydDAsIGNhcnQxLCBjYXJ0MCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoY2FydDAsIDAuMjUsIGNhcnQwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGNhcnQwLCBjYXJ0MCk7CiAgICAgICAgUXVhdGVybmlvbi5leHAoY2FydDAsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wKTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseShxMTIsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wLCByZXN1bHQpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnNxdWFkID0gZnVuY3Rpb24ocTAsIHExMiwgczAsIHMxLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInEwIiwgcTApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicTEiLCBxMTIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiczAiLCBzMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzMSIsIHMxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2xlcnAwID0gUXVhdGVybmlvbi5zbGVycChxMCwgcTEyLCB0LCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMCk7CiAgICAgICAgY29uc3Qgc2xlcnAxID0gUXVhdGVybmlvbi5zbGVycChzMCwgczEsIHQsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xKTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5zbGVycChzbGVycDAsIHNsZXJwMSwgMiAqIHQgKiAoMSAtIHQpLCByZXN1bHQpOwogICAgICB9OwogICAgICBmYXN0U2xlcnBTY3JhdGNoUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIG9wbXUgPSAxLjkwMTEwNzQ1MzUxNzMwMDM7CiAgICAgIHUgPSBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQuc3VwcG9ydHNUeXBlZEFycmF5cygpID8gbmV3IEZsb2F0MzJBcnJheSg4KSA6IFtdOwogICAgICB2ID0gRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0LnN1cHBvcnRzVHlwZWRBcnJheXMoKSA/IG5ldyBGbG9hdDMyQXJyYXkoOCkgOiBbXTsKICAgICAgYlQgPSBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQuc3VwcG9ydHNUeXBlZEFycmF5cygpID8gbmV3IEZsb2F0MzJBcnJheSg4KSA6IFtdOwogICAgICBiRCA9IEZlYXR1cmVEZXRlY3Rpb25fZGVmYXVsdC5zdXBwb3J0c1R5cGVkQXJyYXlzKCkgPyBuZXcgRmxvYXQzMkFycmF5KDgpIDogW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNzsgKytpKSB7CiAgICAgICAgY29uc3QgcyA9IGkgKyAxOwogICAgICAgIGNvbnN0IHQgPSAyICogcyArIDE7CiAgICAgICAgdVtpXSA9IDEgLyAocyAqIHQpOwogICAgICAgIHZbaV0gPSBzIC8gdDsKICAgICAgfQogICAgICB1WzddID0gb3BtdSAvICg4ICogMTcpOwogICAgICB2WzddID0gb3BtdSAqIDggLyAxNzsKICAgICAgUXVhdGVybmlvbi5mYXN0U2xlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgbGV0IHggPSBRdWF0ZXJuaW9uLmRvdChzdGFydCwgZW5kKTsKICAgICAgICBsZXQgc2lnbjM7CiAgICAgICAgaWYgKHggPj0gMCkgewogICAgICAgICAgc2lnbjMgPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzaWduMyA9IC0xOwogICAgICAgICAgeCA9IC14OwogICAgICAgIH0KICAgICAgICBjb25zdCB4bTEgPSB4IC0gMTsKICAgICAgICBjb25zdCBkID0gMSAtIHQ7CiAgICAgICAgY29uc3Qgc3FyVCA9IHQgKiB0OwogICAgICAgIGNvbnN0IHNxckQgPSBkICogZDsKICAgICAgICBmb3IgKGxldCBpID0gNzsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgIGJUW2ldID0gKHVbaV0gKiBzcXJUIC0gdltpXSkgKiB4bTE7CiAgICAgICAgICBiRFtpXSA9ICh1W2ldICogc3FyRCAtIHZbaV0pICogeG0xOwogICAgICAgIH0KICAgICAgICBjb25zdCBjVCA9IHNpZ24zICogdCAqICgxICsgYlRbMF0gKiAoMSArIGJUWzFdICogKDEgKyBiVFsyXSAqICgxICsgYlRbM10gKiAoMSArIGJUWzRdICogKDEgKyBiVFs1XSAqICgxICsgYlRbNl0gKiAoMSArIGJUWzddKSkpKSkpKSk7CiAgICAgICAgY29uc3QgY0QgPSBkICogKDEgKyBiRFswXSAqICgxICsgYkRbMV0gKiAoMSArIGJEWzJdICogKDEgKyBiRFszXSAqICgxICsgYkRbNF0gKiAoMSArIGJEWzVdICogKDEgKyBiRFs2XSAqICgxICsgYkRbN10pKSkpKSkpKTsKICAgICAgICBjb25zdCB0ZW1wID0gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgc3RhcnQsCiAgICAgICAgICBjRCwKICAgICAgICAgIGZhc3RTbGVycFNjcmF0Y2hRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIoZW5kLCBjVCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5hZGQodGVtcCwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmZhc3RTcXVhZCA9IGZ1bmN0aW9uKHEwLCBxMTIsIHMwLCBzMSwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMCIsIHEwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInExIiwgcTEyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInMwIiwgczApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiczEiLCBzMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNsZXJwMCA9IFF1YXRlcm5pb24uZmFzdFNsZXJwKHEwLCBxMTIsIHQsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wKTsKICAgICAgICBjb25zdCBzbGVycDEgPSBRdWF0ZXJuaW9uLmZhc3RTbGVycChzMCwgczEsIHQsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xKTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5mYXN0U2xlcnAoc2xlcnAwLCBzbGVycDEsIDIgKiB0ICogKDEgLSB0KSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQueiA9PT0gcmlnaHQueiAmJiBsZWZ0LncgPT09IHJpZ2h0Lnc7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0LnggLSByaWdodC54KSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnQueSAtIHJpZ2h0LnkpIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC56IC0gcmlnaHQueikgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0LncgLSByaWdodC53KSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLlpFUk8gPSBPYmplY3QuZnJlZXplKG5ldyBRdWF0ZXJuaW9uKDAsIDAsIDAsIDApKTsKICAgICAgUXVhdGVybmlvbi5JREVOVElUWSA9IE9iamVjdC5mcmVlemUobmV3IFF1YXRlcm5pb24oMCwgMCwgMCwgMSkpOwogICAgICBRdWF0ZXJuaW9uLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uZXF1YWxzRXBzaWxvbih0aGlzLCByaWdodCwgZXBzaWxvbik7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLnh9LCAke3RoaXMueX0sICR7dGhpcy56fSwgJHt0aGlzLnd9KWA7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb25fZGVmYXVsdCA9IFF1YXRlcm5pb247CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UcmFuc2Zvcm1zLmpzCiAgdmFyIFRyYW5zZm9ybXMsIHZlY3RvclByb2R1Y3RMb2NhbEZyYW1lLCBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lLCBsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGUsIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4sIHNjcmF0Y2hGaXJzdENhcnRlc2lhbiwgc2NyYXRjaFNlY29uZENhcnRlc2lhbiwgc2NyYXRjaFRoaXJkQ2FydGVzaWFuLCBzY3JhdGNoSFBSUXVhdGVybmlvbjIsIHNjcmF0Y2hTY2FsZSwgc2NyYXRjaEhQUk1hdHJpeDQsIHNjcmF0Y2hFTlVNYXRyaXg0LCBzY3JhdGNoSFBSTWF0cml4Mywgbm9TY2FsZSwgaHByQ2VudGVyU2NyYXRjaCwgZmZTY3JhdGNoLCBocHJUcmFuc2Zvcm1TY3JhdGNoLCBocHJSb3RhdGlvblNjcmF0Y2gsIGhwclF1YXRlcm5pb25TY3JhdGNoLCBnbXN0Q29uc3RhbnQwLCBnbXN0Q29uc3RhbnQxLCBnbXN0Q29uc3RhbnQyLCBnbXN0Q29uc3RhbnQzLCByYXRlQ29lZiwgd2dzODRXUlByZWNlc3NpbmcsIHR3b1BpT3ZlclNlY29uZHNJbkRheSwgZGF0ZUluVXRjLCB0dE1pbnVzVGFpLCBqMjAwMHR0RGF5cywgVGR0TWludXNUYWksIEoyMDAwZCwgc2NyYXRjaEhwciwgc2NyYXRjaFJvdGF0aW9uTWF0cml4LCBkYXRlU2NyYXRjaCwgeHlzU2NyYXRjaCwgZW9wU2NyYXRjaCwgcm90YXRpb24xU2NyYXRjaCwgcm90YXRpb24yU2NyYXRjaCwgcG9pbnRUb1dpbmRvd0Nvb3JkaW5hdGVzVGVtcCwgbm9ybWFsU2NyYXRjaCwgcmlnaHRTY3JhdGNoLCB1cFNjcmF0Y2gsIHN3aXp6bGVNYXRyaXgsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMsIHNjcmF0Y2hDYXJ0ZXNpYW4zUHJvamVjdGlvbiwgc2NyYXRjaENlbnRlciwgc2NyYXRjaFJvdGF0aW9uLCBzY3JhdGNoRnJvbUVOVSwgc2NyYXRjaFRvRU5VLCBUcmFuc2Zvcm1zX2RlZmF1bHQ7CiAgdmFyIGluaXRfVHJhbnNmb3JtcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVHJhbnNmb3Jtcy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycygpOwogICAgICBpbml0X0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfSGVhZGluZ1BpdGNoUm9sbCgpOwogICAgICBpbml0X0lhdTIwMDZYeXNEYXRhKCk7CiAgICAgIGluaXRfSWF1MjAwNlh5c1NhbXBsZSgpOwogICAgICBpbml0X0p1bGlhbkRhdGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfVGltZUNvbnN0YW50cygpOwogICAgICBUcmFuc2Zvcm1zID0ge307CiAgICAgIHZlY3RvclByb2R1Y3RMb2NhbEZyYW1lID0gewogICAgICAgIHVwOiB7CiAgICAgICAgICBzb3V0aDogImVhc3QiLAogICAgICAgICAgbm9ydGg6ICJ3ZXN0IiwKICAgICAgICAgIHdlc3Q6ICJzb3V0aCIsCiAgICAgICAgICBlYXN0OiAibm9ydGgiCiAgICAgICAgfSwKICAgICAgICBkb3duOiB7CiAgICAgICAgICBzb3V0aDogIndlc3QiLAogICAgICAgICAgbm9ydGg6ICJlYXN0IiwKICAgICAgICAgIHdlc3Q6ICJub3J0aCIsCiAgICAgICAgICBlYXN0OiAic291dGgiCiAgICAgICAgfSwKICAgICAgICBzb3V0aDogewogICAgICAgICAgdXA6ICJ3ZXN0IiwKICAgICAgICAgIGRvd246ICJlYXN0IiwKICAgICAgICAgIHdlc3Q6ICJkb3duIiwKICAgICAgICAgIGVhc3Q6ICJ1cCIKICAgICAgICB9LAogICAgICAgIG5vcnRoOiB7CiAgICAgICAgICB1cDogImVhc3QiLAogICAgICAgICAgZG93bjogIndlc3QiLAogICAgICAgICAgd2VzdDogInVwIiwKICAgICAgICAgIGVhc3Q6ICJkb3duIgogICAgICAgIH0sCiAgICAgICAgd2VzdDogewogICAgICAgICAgdXA6ICJub3J0aCIsCiAgICAgICAgICBkb3duOiAic291dGgiLAogICAgICAgICAgbm9ydGg6ICJkb3duIiwKICAgICAgICAgIHNvdXRoOiAidXAiCiAgICAgICAgfSwKICAgICAgICBlYXN0OiB7CiAgICAgICAgICB1cDogInNvdXRoIiwKICAgICAgICAgIGRvd246ICJub3J0aCIsCiAgICAgICAgICBub3J0aDogInVwIiwKICAgICAgICAgIHNvdXRoOiAiZG93biIKICAgICAgICB9CiAgICAgIH07CiAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWUgPSB7CiAgICAgICAgbm9ydGg6IFstMSwgMCwgMF0sCiAgICAgICAgZWFzdDogWzAsIDEsIDBdLAogICAgICAgIHVwOiBbMCwgMCwgMV0sCiAgICAgICAgc291dGg6IFsxLCAwLCAwXSwKICAgICAgICB3ZXN0OiBbMCwgLTEsIDBdLAogICAgICAgIGRvd246IFswLCAwLCAtMV0KICAgICAgfTsKICAgICAgbG9jYWxGcmFtZVRvRml4ZWRGcmFtZUNhY2hlID0ge307CiAgICAgIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4gPSB7CiAgICAgICAgZWFzdDogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIG5vcnRoOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgdXA6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICB3ZXN0OiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgc291dGg6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBkb3duOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkKICAgICAgfTsKICAgICAgc2NyYXRjaEZpcnN0Q2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMubG9jYWxGcmFtZVRvRml4ZWRGcmFtZUdlbmVyYXRvciA9IGZ1bmN0aW9uKGZpcnN0QXhpcywgc2Vjb25kQXhpcykgewogICAgICAgIGlmICghdmVjdG9yUHJvZHVjdExvY2FsRnJhbWUuaGFzT3duUHJvcGVydHkoZmlyc3RBeGlzKSB8fCAhdmVjdG9yUHJvZHVjdExvY2FsRnJhbWVbZmlyc3RBeGlzXS5oYXNPd25Qcm9wZXJ0eShzZWNvbmRBeGlzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJmaXJzdEF4aXMgYW5kIHNlY29uZEF4aXMgbXVzdCBiZSBlYXN0LCBub3J0aCwgdXAsIHdlc3QsIHNvdXRoIG9yIGRvd24uIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGhpcmRBeGlzID0gdmVjdG9yUHJvZHVjdExvY2FsRnJhbWVbZmlyc3RBeGlzXVtzZWNvbmRBeGlzXTsKICAgICAgICBsZXQgcmVzdWx0YXQ7CiAgICAgICAgY29uc3QgaGFzaEF4aXMgPSBmaXJzdEF4aXMgKyBzZWNvbmRBeGlzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobG9jYWxGcmFtZVRvRml4ZWRGcmFtZUNhY2hlW2hhc2hBeGlzXSkpIHsKICAgICAgICAgIHJlc3VsdGF0ID0gbG9jYWxGcmFtZVRvRml4ZWRGcmFtZUNhY2hlW2hhc2hBeGlzXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0YXQgPSBmdW5jdGlvbihvcmlnaW4sIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9yaWdpbikpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3JpZ2luIGlzIHJlcXVpcmVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc05hTihvcmlnaW4ueCkgfHwgaXNOYU4ob3JpZ2luLnkpIHx8IGlzTmFOKG9yaWdpbi56KSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcmlnaW4gaGFzIGEgTmFOIGNvbXBvbmVudCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKG9yaWdpbiwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbZmlyc3RBeGlzXSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgICBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW3NlY29uZEF4aXNdLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgICBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW3RoaXJkQXhpc10sCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgc2NyYXRjaFRoaXJkQ2FydGVzaWFuCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihvcmlnaW4ueCwgMCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24ob3JpZ2luLnksIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2lnbjMgPSBNYXRoX2RlZmF1bHQuc2lnbihvcmlnaW4ueik7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbZmlyc3RBeGlzXSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChmaXJzdEF4aXMgIT09ICJlYXN0IiAmJiBmaXJzdEF4aXMgIT09ICJ3ZXN0IikgewogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hGaXJzdENhcnRlc2lhbiwKICAgICAgICAgICAgICAgICAgc2lnbjMsCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hGaXJzdENhcnRlc2lhbgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbc2Vjb25kQXhpc10sCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgc2NyYXRjaFNlY29uZENhcnRlc2lhbgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHNlY29uZEF4aXMgIT09ICJlYXN0IiAmJiBzZWNvbmRBeGlzICE9PSAid2VzdCIpIHsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuLAogICAgICAgICAgICAgICAgICBzaWduMywKICAgICAgICAgICAgICAgICAgc2NyYXRjaFNlY29uZENhcnRlc2lhbgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbdGhpcmRBeGlzXSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICh0aGlyZEF4aXMgIT09ICJlYXN0IiAmJiB0aGlyZEF4aXMgIT09ICJ3ZXN0IikgewogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbiwKICAgICAgICAgICAgICAgICAgc2lnbjMsCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KTsKICAgICAgICAgICAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKG9yaWdpbiwgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi51cCk7CiAgICAgICAgICAgICAgY29uc3QgdXAgPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLnVwOwogICAgICAgICAgICAgIGNvbnN0IGVhc3QgPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLmVhc3Q7CiAgICAgICAgICAgICAgZWFzdC54ID0gLW9yaWdpbi55OwogICAgICAgICAgICAgIGVhc3QueSA9IG9yaWdpbi54OwogICAgICAgICAgICAgIGVhc3QueiA9IDA7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShlYXN0LCBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLmVhc3QpOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1cCwgZWFzdCwgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5ub3J0aCk7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLnVwLAogICAgICAgICAgICAgICAgLTEsCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLmRvd24KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5lYXN0LAogICAgICAgICAgICAgICAgLTEsCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLndlc3QKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5ub3J0aCwKICAgICAgICAgICAgICAgIC0xLAogICAgICAgICAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5zb3V0aAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc2NyYXRjaEZpcnN0Q2FydGVzaWFuID0gc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbltmaXJzdEF4aXNdOwogICAgICAgICAgICAgIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4gPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuW3NlY29uZEF4aXNdOwogICAgICAgICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbiA9IHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW5bdGhpcmRBeGlzXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHRbMF0gPSBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4ueDsKICAgICAgICAgICAgcmVzdWx0WzFdID0gc2NyYXRjaEZpcnN0Q2FydGVzaWFuLnk7CiAgICAgICAgICAgIHJlc3VsdFsyXSA9IHNjcmF0Y2hGaXJzdENhcnRlc2lhbi56OwogICAgICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgICAgICByZXN1bHRbNF0gPSBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuLng7CiAgICAgICAgICAgIHJlc3VsdFs1XSA9IHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4ueTsKICAgICAgICAgICAgcmVzdWx0WzZdID0gc2NyYXRjaFNlY29uZENhcnRlc2lhbi56OwogICAgICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgICAgICByZXN1bHRbOF0gPSBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4ueDsKICAgICAgICAgICAgcmVzdWx0WzldID0gc2NyYXRjaFRoaXJkQ2FydGVzaWFuLnk7CiAgICAgICAgICAgIHJlc3VsdFsxMF0gPSBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4uejsKICAgICAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgICAgIHJlc3VsdFsxMl0gPSBvcmlnaW4ueDsKICAgICAgICAgICAgcmVzdWx0WzEzXSA9IG9yaWdpbi55OwogICAgICAgICAgICByZXN1bHRbMTRdID0gb3JpZ2luLno7CiAgICAgICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfTsKICAgICAgICAgIGxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVDYWNoZVtoYXNoQXhpc10gPSByZXN1bHRhdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdGF0OwogICAgICB9OwogICAgICBUcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lID0gVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yKAogICAgICAgICJlYXN0IiwKICAgICAgICAibm9ydGgiCiAgICAgICk7CiAgICAgIFRyYW5zZm9ybXMubm9ydGhFYXN0RG93blRvRml4ZWRGcmFtZSA9IFRyYW5zZm9ybXMubG9jYWxGcmFtZVRvRml4ZWRGcmFtZUdlbmVyYXRvcigibm9ydGgiLCAiZWFzdCIpOwogICAgICBUcmFuc2Zvcm1zLm5vcnRoVXBFYXN0VG9GaXhlZEZyYW1lID0gVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yKAogICAgICAgICJub3J0aCIsCiAgICAgICAgInVwIgogICAgICApOwogICAgICBUcmFuc2Zvcm1zLm5vcnRoV2VzdFVwVG9GaXhlZEZyYW1lID0gVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yKAogICAgICAgICJub3J0aCIsCiAgICAgICAgIndlc3QiCiAgICAgICk7CiAgICAgIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uMiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFNjYWxlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKTsKICAgICAgc2NyYXRjaEhQUk1hdHJpeDQgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuaGVhZGluZ1BpdGNoUm9sbFRvRml4ZWRGcmFtZSA9IGZ1bmN0aW9uKG9yaWdpbiwgaGVhZGluZ1BpdGNoUm9sbCwgZWxsaXBzb2lkLCBmaXhlZEZyYW1lVHJhbnNmb3JtLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIkhlYWRpbmdQaXRjaFJvbGwiLCBoZWFkaW5nUGl0Y2hSb2xsKTsKICAgICAgICBmaXhlZEZyYW1lVHJhbnNmb3JtID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBmaXhlZEZyYW1lVHJhbnNmb3JtLAogICAgICAgICAgVHJhbnNmb3Jtcy5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZQogICAgICAgICk7CiAgICAgICAgY29uc3QgaHByUXVhdGVybmlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tSGVhZGluZ1BpdGNoUm9sbCgKICAgICAgICAgIGhlYWRpbmdQaXRjaFJvbGwsCiAgICAgICAgICBzY3JhdGNoSFBSUXVhdGVybmlvbjIKICAgICAgICApOwogICAgICAgIGNvbnN0IGhwck1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5mcm9tVHJhbnNsYXRpb25RdWF0ZXJuaW9uUm90YXRpb25TY2FsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgaHByUXVhdGVybmlvbiwKICAgICAgICAgIHNjcmF0Y2hTY2FsZSwKICAgICAgICAgIHNjcmF0Y2hIUFJNYXRyaXg0CiAgICAgICAgKTsKICAgICAgICByZXN1bHQgPSBmaXhlZEZyYW1lVHJhbnNmb3JtKG9yaWdpbiwgZWxsaXBzb2lkLCByZXN1bHQpOwogICAgICAgIHJldHVybiBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkocmVzdWx0LCBocHJNYXRyaXgsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFTlVNYXRyaXg0ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoSFBSTWF0cml4MyA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5oZWFkaW5nUGl0Y2hSb2xsUXVhdGVybmlvbiA9IGZ1bmN0aW9uKG9yaWdpbiwgaGVhZGluZ1BpdGNoUm9sbCwgZWxsaXBzb2lkLCBmaXhlZEZyYW1lVHJhbnNmb3JtLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIkhlYWRpbmdQaXRjaFJvbGwiLCBoZWFkaW5nUGl0Y2hSb2xsKTsKICAgICAgICBjb25zdCB0cmFuc2Zvcm0yID0gVHJhbnNmb3Jtcy5oZWFkaW5nUGl0Y2hSb2xsVG9GaXhlZEZyYW1lKAogICAgICAgICAgb3JpZ2luLAogICAgICAgICAgaGVhZGluZ1BpdGNoUm9sbCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGZpeGVkRnJhbWVUcmFuc2Zvcm0sCiAgICAgICAgICBzY3JhdGNoRU5VTWF0cml4NAogICAgICAgICk7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF0cml4Myh0cmFuc2Zvcm0yLCBzY3JhdGNoSFBSTWF0cml4Myk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tUm90YXRpb25NYXRyaXgocm90YXRpb24sIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIG5vU2NhbGUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDEsIDEsIDEpOwogICAgICBocHJDZW50ZXJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmZlNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGhwclRyYW5zZm9ybVNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGhwclJvdGF0aW9uU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgaHByUXVhdGVybmlvblNjcmF0Y2ggPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuZml4ZWRGcmFtZVRvSGVhZGluZ1BpdGNoUm9sbCA9IGZ1bmN0aW9uKHRyYW5zZm9ybTIsIGVsbGlwc29pZCwgZml4ZWRGcmFtZVRyYW5zZm9ybSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ0cmFuc2Zvcm0iLCB0cmFuc2Zvcm0yKTsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgICAgIGZpeGVkRnJhbWVUcmFuc2Zvcm0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIGZpeGVkRnJhbWVUcmFuc2Zvcm0sCiAgICAgICAgICBUcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSGVhZGluZ1BpdGNoUm9sbF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNlbnRlciA9IE1hdHJpeDRfZGVmYXVsdC5nZXRUcmFuc2xhdGlvbih0cmFuc2Zvcm0yLCBocHJDZW50ZXJTY3JhdGNoKTsKICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhjZW50ZXIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgcmVzdWx0LmhlYWRpbmcgPSAwOwogICAgICAgICAgcmVzdWx0LnBpdGNoID0gMDsKICAgICAgICAgIHJlc3VsdC5yb2xsID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGxldCB0b0ZpeGVkRnJhbWUgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKAogICAgICAgICAgZml4ZWRGcmFtZVRyYW5zZm9ybShjZW50ZXIsIGVsbGlwc29pZCwgZmZTY3JhdGNoKSwKICAgICAgICAgIGZmU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IHRyYW5zZm9ybUNvcHkgPSBNYXRyaXg0X2RlZmF1bHQuc2V0U2NhbGUodHJhbnNmb3JtMiwgbm9TY2FsZSwgaHByVHJhbnNmb3JtU2NyYXRjaCk7CiAgICAgICAgdHJhbnNmb3JtQ29weSA9IE1hdHJpeDRfZGVmYXVsdC5zZXRUcmFuc2xhdGlvbigKICAgICAgICAgIHRyYW5zZm9ybUNvcHksCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgIHRyYW5zZm9ybUNvcHkKICAgICAgICApOwogICAgICAgIHRvRml4ZWRGcmFtZSA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSh0b0ZpeGVkRnJhbWUsIHRyYW5zZm9ybUNvcHksIHRvRml4ZWRGcmFtZSk7CiAgICAgICAgbGV0IHF1YXRlcm5pb25Sb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tUm90YXRpb25NYXRyaXgoCiAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF0cml4Myh0b0ZpeGVkRnJhbWUsIGhwclJvdGF0aW9uU2NyYXRjaCksCiAgICAgICAgICBocHJRdWF0ZXJuaW9uU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgcXVhdGVybmlvblJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIHF1YXRlcm5pb25Sb3RhdGlvbiwKICAgICAgICAgIHF1YXRlcm5pb25Sb3RhdGlvbgogICAgICAgICk7CiAgICAgICAgcmV0dXJuIEhlYWRpbmdQaXRjaFJvbGxfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihxdWF0ZXJuaW9uUm90YXRpb24sIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIGdtc3RDb25zdGFudDAgPSA2ICogMzYwMCArIDQxICogNjAgKyA1MC41NDg0MTsKICAgICAgZ21zdENvbnN0YW50MSA9IDg2NDAxODQ4MTI4NjZlLTY7CiAgICAgIGdtc3RDb25zdGFudDIgPSAwLjA5MzEwNDsKICAgICAgZ21zdENvbnN0YW50MyA9IC02MmUtNzsKICAgICAgcmF0ZUNvZWYgPSAxMTc3Mjc1ODM4NDY2OGUtMzI7CiAgICAgIHdnczg0V1JQcmVjZXNzaW5nID0gNzI5MjExNTg1NTNlLTE1OwogICAgICB0d29QaU92ZXJTZWNvbmRzSW5EYXkgPSBNYXRoX2RlZmF1bHQuVFdPX1BJIC8gODY0MDA7CiAgICAgIGRhdGVJblV0YyA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5jb21wdXRlSWNyZlRvQ2VudHJhbEJvZHlGaXhlZE1hdHJpeCA9IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgIGxldCB0cmFuc2Zvcm1NYXRyaXggPSBUcmFuc2Zvcm1zLmNvbXB1dGVJY3JmVG9GaXhlZE1hdHJpeChkYXRlLCByZXN1bHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRyYW5zZm9ybU1hdHJpeCkpIHsKICAgICAgICAgIHRyYW5zZm9ybU1hdHJpeCA9IFRyYW5zZm9ybXMuY29tcHV0ZVRlbWVUb1BzZXVkb0ZpeGVkTWF0cml4KGRhdGUsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cmFuc2Zvcm1NYXRyaXg7CiAgICAgIH07CiAgICAgIFRyYW5zZm9ybXMuY29tcHV0ZVRlbWVUb1BzZXVkb0ZpeGVkTWF0cml4ID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBkYXRlSW5VdGMgPSBKdWxpYW5EYXRlX2RlZmF1bHQuYWRkU2Vjb25kcygKICAgICAgICAgIGRhdGUsCiAgICAgICAgICAtSnVsaWFuRGF0ZV9kZWZhdWx0LmNvbXB1dGVUYWlNaW51c1V0YyhkYXRlKSwKICAgICAgICAgIGRhdGVJblV0YwogICAgICAgICk7CiAgICAgICAgY29uc3QgdXRjRGF5TnVtYmVyID0gZGF0ZUluVXRjLmRheU51bWJlcjsKICAgICAgICBjb25zdCB1dGNTZWNvbmRzSW50b0RheSA9IGRhdGVJblV0Yy5zZWNvbmRzT2ZEYXk7CiAgICAgICAgbGV0IHQ7CiAgICAgICAgY29uc3QgZGlmZkRheXMgPSB1dGNEYXlOdW1iZXIgLSAyNDUxNTQ1OwogICAgICAgIGlmICh1dGNTZWNvbmRzSW50b0RheSA+PSA0MzIwMCkgewogICAgICAgICAgdCA9IChkaWZmRGF5cyArIDAuNSkgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuREFZU19QRVJfSlVMSUFOX0NFTlRVUlk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHQgPSAoZGlmZkRheXMgLSAwLjUpIC8gVGltZUNvbnN0YW50c19kZWZhdWx0LkRBWVNfUEVSX0pVTElBTl9DRU5UVVJZOwogICAgICAgIH0KICAgICAgICBjb25zdCBnbXN0MCA9IGdtc3RDb25zdGFudDAgKyB0ICogKGdtc3RDb25zdGFudDEgKyB0ICogKGdtc3RDb25zdGFudDIgKyB0ICogZ21zdENvbnN0YW50MykpOwogICAgICAgIGNvbnN0IGFuZ2xlID0gZ21zdDAgKiB0d29QaU92ZXJTZWNvbmRzSW5EYXkgJSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIGNvbnN0IHJhdGlvID0gd2dzODRXUlByZWNlc3NpbmcgKyByYXRlQ29lZiAqICh1dGNEYXlOdW1iZXIgLSAyNDUxNTQ1NWUtMSk7CiAgICAgICAgY29uc3Qgc2Vjb25kc1NpbmNlTWlkbmlnaHQgPSAodXRjU2Vjb25kc0ludG9EYXkgKyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZICogMC41KSAlIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICAgICAgY29uc3QgZ2hhID0gYW5nbGUgKyByYXRpbyAqIHNlY29uZHNTaW5jZU1pZG5pZ2h0OwogICAgICAgIGNvbnN0IGNvc0doYSA9IE1hdGguY29zKGdoYSk7CiAgICAgICAgY29uc3Qgc2luR2hhID0gTWF0aC5zaW4oZ2hhKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDNfZGVmYXVsdCgKICAgICAgICAgICAgY29zR2hhLAogICAgICAgICAgICBzaW5HaGEsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIC1zaW5HaGEsCiAgICAgICAgICAgIGNvc0doYSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gY29zR2hhOwogICAgICAgIHJlc3VsdFsxXSA9IC1zaW5HaGE7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSBzaW5HaGE7CiAgICAgICAgcmVzdWx0WzRdID0gY29zR2hhOwogICAgICAgIHJlc3VsdFs1XSA9IDA7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVHJhbnNmb3Jtcy5pYXUyMDA2WHlzRGF0YSA9IG5ldyBJYXUyMDA2WHlzRGF0YV9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuZWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMgPSBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc19kZWZhdWx0Lk5PTkU7CiAgICAgIHR0TWludXNUYWkgPSAzMi4xODQ7CiAgICAgIGoyMDAwdHREYXlzID0gMjQ1MTU0NTsKICAgICAgVHJhbnNmb3Jtcy5wcmVsb2FkSWNyZkZpeGVkID0gZnVuY3Rpb24odGltZUludGVydmFsKSB7CiAgICAgICAgY29uc3Qgc3RhcnREYXlUVCA9IHRpbWVJbnRlcnZhbC5zdGFydC5kYXlOdW1iZXI7CiAgICAgICAgY29uc3Qgc3RhcnRTZWNvbmRUVCA9IHRpbWVJbnRlcnZhbC5zdGFydC5zZWNvbmRzT2ZEYXkgKyB0dE1pbnVzVGFpOwogICAgICAgIGNvbnN0IHN0b3BEYXlUVCA9IHRpbWVJbnRlcnZhbC5zdG9wLmRheU51bWJlcjsKICAgICAgICBjb25zdCBzdG9wU2Vjb25kVFQgPSB0aW1lSW50ZXJ2YWwuc3RvcC5zZWNvbmRzT2ZEYXkgKyB0dE1pbnVzVGFpOwogICAgICAgIHJldHVybiBUcmFuc2Zvcm1zLmlhdTIwMDZYeXNEYXRhLnByZWxvYWQoCiAgICAgICAgICBzdGFydERheVRULAogICAgICAgICAgc3RhcnRTZWNvbmRUVCwKICAgICAgICAgIHN0b3BEYXlUVCwKICAgICAgICAgIHN0b3BTZWNvbmRUVAogICAgICAgICk7CiAgICAgIH07CiAgICAgIFRyYW5zZm9ybXMuY29tcHV0ZUljcmZUb0ZpeGVkTWF0cml4ID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZpeGVkVG9JY3JmTXR4ID0gVHJhbnNmb3Jtcy5jb21wdXRlRml4ZWRUb0ljcmZNYXRyaXgoZGF0ZSwgcmVzdWx0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChmaXhlZFRvSWNyZk10eCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRyaXgzX2RlZmF1bHQudHJhbnNwb3NlKGZpeGVkVG9JY3JmTXR4LCByZXN1bHQpOwogICAgICB9OwogICAgICBUZHRNaW51c1RhaSA9IDMyLjE4NDsKICAgICAgSjIwMDBkID0gMjQ1MTU0NTsKICAgICAgc2NyYXRjaEhwciA9IG5ldyBIZWFkaW5nUGl0Y2hSb2xsX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJvdGF0aW9uTWF0cml4ID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBkYXRlU2NyYXRjaCA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5jb21wdXRlTW9vbkZpeGVkVG9JY3JmTWF0cml4ID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNlY29uZHNUVCA9IEp1bGlhbkRhdGVfZGVmYXVsdC5hZGRTZWNvbmRzKGRhdGUsIFRkdE1pbnVzVGFpLCBkYXRlU2NyYXRjaCk7CiAgICAgICAgY29uc3QgZCA9IEp1bGlhbkRhdGVfZGVmYXVsdC50b3RhbERheXMoc2Vjb25kc1RUKSAtIEoyMDAwZDsKICAgICAgICBjb25zdCBlMSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMTIuMTEyKSAtIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMC4wNTI5OTIpICogZDsKICAgICAgICBjb25zdCBlMiA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMjQuMjI0KSAtIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMC4xMDU5ODQpICogZDsKICAgICAgICBjb25zdCBlMyA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMjI3LjY0NSkgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDEzLjAxMikgKiBkOwogICAgICAgIGNvbnN0IGU0ID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucygyNjEuMTA1KSArIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMTMuMzQwNzE2KSAqIGQ7CiAgICAgICAgY29uc3QgZTUgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDM1OCkgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDAuOTg1NikgKiBkOwogICAgICAgIHNjcmF0Y2hIcHIucGl0Y2ggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDI3MCAtIDkwKSAtIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMy44NzgpICogTWF0aC5zaW4oZTEpIC0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucygwLjEyKSAqIE1hdGguc2luKGUyKSArIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMC4wNykgKiBNYXRoLnNpbihlMykgLSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDAuMDE3KSAqIE1hdGguc2luKGU0KTsKICAgICAgICBzY3JhdGNoSHByLnJvbGwgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDY2LjUzIC0gOTApICsgTWF0aF9kZWZhdWx0LnRvUmFkaWFucygxLjU0MykgKiBNYXRoLmNvcyhlMSkgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDAuMjQpICogTWF0aC5jb3MoZTIpIC0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucygwLjAyOCkgKiBNYXRoLmNvcyhlMykgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDdlLTMpICogTWF0aC5jb3MoZTQpOwogICAgICAgIHNjcmF0Y2hIcHIuaGVhZGluZyA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMjQ0LjM3NSAtIDkwKSArIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMTMuMTc2MzU4MzEpICogZCArIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMy41NTgpICogTWF0aC5zaW4oZTEpICsgTWF0aF9kZWZhdWx0LnRvUmFkaWFucygwLjEyMSkgKiBNYXRoLnNpbihlMikgLSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDAuMDY0KSAqIE1hdGguc2luKGUzKSArIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMC4wMTYpICogTWF0aC5zaW4oZTQpICsgTWF0aF9kZWZhdWx0LnRvUmFkaWFucygwLjAyNSkgKiBNYXRoLnNpbihlNSk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDNfZGVmYXVsdC5mcm9tSGVhZGluZ1BpdGNoUm9sbChzY3JhdGNoSHByLCBzY3JhdGNoUm90YXRpb25NYXRyaXgpOwogICAgICB9OwogICAgICBUcmFuc2Zvcm1zLmNvbXB1dGVJY3JmVG9Nb29uRml4ZWRNYXRyaXggPSBmdW5jdGlvbihkYXRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZml4ZWRUb0ljcmZNdHggPSBUcmFuc2Zvcm1zLmNvbXB1dGVNb29uRml4ZWRUb0ljcmZNYXRyaXgoZGF0ZSwgcmVzdWx0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChmaXhlZFRvSWNyZk10eCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRyaXgzX2RlZmF1bHQudHJhbnNwb3NlKGZpeGVkVG9JY3JmTXR4LCByZXN1bHQpOwogICAgICB9OwogICAgICB4eXNTY3JhdGNoID0gbmV3IElhdTIwMDZYeXNTYW1wbGVfZGVmYXVsdCgwLCAwLCAwKTsKICAgICAgZW9wU2NyYXRjaCA9IG5ldyBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZV9kZWZhdWx0KAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwCiAgICAgICk7CiAgICAgIHJvdGF0aW9uMVNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHJvdGF0aW9uMlNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuY29tcHV0ZUZpeGVkVG9JY3JmTWF0cml4ID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVvcCA9IFRyYW5zZm9ybXMuZWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuY29tcHV0ZShkYXRlLCBlb3BTY3JhdGNoKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlb3ApKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBkYXlUVCA9IGRhdGUuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IHNlY29uZFRUID0gZGF0ZS5zZWNvbmRzT2ZEYXkgKyB0dE1pbnVzVGFpOwogICAgICAgIGNvbnN0IHh5cyA9IFRyYW5zZm9ybXMuaWF1MjAwNlh5c0RhdGEuY29tcHV0ZVh5c1JhZGlhbnMoCiAgICAgICAgICBkYXlUVCwKICAgICAgICAgIHNlY29uZFRULAogICAgICAgICAgeHlzU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeHlzKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgeCA9IHh5cy54ICsgZW9wLnhQb2xlT2Zmc2V0OwogICAgICAgIGNvbnN0IHkgPSB4eXMueSArIGVvcC55UG9sZU9mZnNldDsKICAgICAgICBjb25zdCBhMyA9IDEgLyAoMSArIE1hdGguc3FydCgxIC0geCAqIHggLSB5ICogeSkpOwogICAgICAgIGNvbnN0IHJvdGF0aW9uMSA9IHJvdGF0aW9uMVNjcmF0Y2g7CiAgICAgICAgcm90YXRpb24xWzBdID0gMSAtIGEzICogeCAqIHg7CiAgICAgICAgcm90YXRpb24xWzNdID0gLWEzICogeCAqIHk7CiAgICAgICAgcm90YXRpb24xWzZdID0geDsKICAgICAgICByb3RhdGlvbjFbMV0gPSAtYTMgKiB4ICogeTsKICAgICAgICByb3RhdGlvbjFbNF0gPSAxIC0gYTMgKiB5ICogeTsKICAgICAgICByb3RhdGlvbjFbN10gPSB5OwogICAgICAgIHJvdGF0aW9uMVsyXSA9IC14OwogICAgICAgIHJvdGF0aW9uMVs1XSA9IC15OwogICAgICAgIHJvdGF0aW9uMVs4XSA9IDEgLSBhMyAqICh4ICogeCArIHkgKiB5KTsKICAgICAgICBjb25zdCByb3RhdGlvbjIgPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVJvdGF0aW9uWigteHlzLnMsIHJvdGF0aW9uMlNjcmF0Y2gpOwogICAgICAgIGNvbnN0IG1hdHJpeFEgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHkocm90YXRpb24xLCByb3RhdGlvbjIsIHJvdGF0aW9uMVNjcmF0Y2gpOwogICAgICAgIGNvbnN0IGRhdGVVdDFkYXkgPSBkYXRlLmRheU51bWJlcjsKICAgICAgICBjb25zdCBkYXRlVXQxc2VjID0gZGF0ZS5zZWNvbmRzT2ZEYXkgLSBKdWxpYW5EYXRlX2RlZmF1bHQuY29tcHV0ZVRhaU1pbnVzVXRjKGRhdGUpICsgZW9wLnV0MU1pbnVzVXRjOwogICAgICAgIGNvbnN0IGRheXNTaW5jZUoyMDAwID0gZGF0ZVV0MWRheSAtIDI0NTE1NDU7CiAgICAgICAgY29uc3QgZnJhY3Rpb25PZkRheSA9IGRhdGVVdDFzZWMgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZOwogICAgICAgIGxldCBlcmEgPSAwLjc3OTA1NzI3MzI2NCArIGZyYWN0aW9uT2ZEYXkgKyAwLjAwMjczNzgxMTkxMTM1NDQ4ICogKGRheXNTaW5jZUoyMDAwICsgZnJhY3Rpb25PZkRheSk7CiAgICAgICAgZXJhID0gZXJhICUgMSAqIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgY29uc3QgZWFydGhSb3RhdGlvbiA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUm90YXRpb25aKGVyYSwgcm90YXRpb24yU2NyYXRjaCk7CiAgICAgICAgY29uc3QgcGZUb0ljcmYgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHkobWF0cml4USwgZWFydGhSb3RhdGlvbiwgcm90YXRpb24xU2NyYXRjaCk7CiAgICAgICAgY29uc3QgY29zeHAgPSBNYXRoLmNvcyhlb3AueFBvbGVXYW5kZXIpOwogICAgICAgIGNvbnN0IGNvc3lwID0gTWF0aC5jb3MoZW9wLnlQb2xlV2FuZGVyKTsKICAgICAgICBjb25zdCBzaW54cCA9IE1hdGguc2luKGVvcC54UG9sZVdhbmRlcik7CiAgICAgICAgY29uc3Qgc2lueXAgPSBNYXRoLnNpbihlb3AueVBvbGVXYW5kZXIpOwogICAgICAgIGxldCB0dHQgPSBkYXlUVCAtIGoyMDAwdHREYXlzICsgc2Vjb25kVFQgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZOwogICAgICAgIHR0dCAvPSAzNjUyNTsKICAgICAgICBjb25zdCBzcCA9IC00N2UtNiAqIHR0dCAqIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUgLyAzNjAwOwogICAgICAgIGNvbnN0IGNvc3NwID0gTWF0aC5jb3Moc3ApOwogICAgICAgIGNvbnN0IHNpbnNwID0gTWF0aC5zaW4oc3ApOwogICAgICAgIGNvbnN0IGZUb1BmTXR4ID0gcm90YXRpb24yU2NyYXRjaDsKICAgICAgICBmVG9QZk10eFswXSA9IGNvc3hwICogY29zc3A7CiAgICAgICAgZlRvUGZNdHhbMV0gPSBjb3N4cCAqIHNpbnNwOwogICAgICAgIGZUb1BmTXR4WzJdID0gc2lueHA7CiAgICAgICAgZlRvUGZNdHhbM10gPSAtY29zeXAgKiBzaW5zcCArIHNpbnlwICogc2lueHAgKiBjb3NzcDsKICAgICAgICBmVG9QZk10eFs0XSA9IGNvc3lwICogY29zc3AgKyBzaW55cCAqIHNpbnhwICogc2luc3A7CiAgICAgICAgZlRvUGZNdHhbNV0gPSAtc2lueXAgKiBjb3N4cDsKICAgICAgICBmVG9QZk10eFs2XSA9IC1zaW55cCAqIHNpbnNwIC0gY29zeXAgKiBzaW54cCAqIGNvc3NwOwogICAgICAgIGZUb1BmTXR4WzddID0gc2lueXAgKiBjb3NzcCAtIGNvc3lwICogc2lueHAgKiBzaW5zcDsKICAgICAgICBmVG9QZk10eFs4XSA9IGNvc3lwICogY29zeHA7CiAgICAgICAgcmV0dXJuIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseShwZlRvSWNyZiwgZlRvUGZNdHgsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHBvaW50VG9XaW5kb3dDb29yZGluYXRlc1RlbXAgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMucG9pbnRUb1dpbmRvd0Nvb3JkaW5hdGVzID0gZnVuY3Rpb24obW9kZWxWaWV3UHJvamVjdGlvbk1hdHJpeCwgdmlld3BvcnRUcmFuc2Zvcm1hdGlvbiwgcG9pbnQsIHJlc3VsdCkgewogICAgICAgIHJlc3VsdCA9IFRyYW5zZm9ybXMucG9pbnRUb0dMV2luZG93Q29vcmRpbmF0ZXMoCiAgICAgICAgICBtb2RlbFZpZXdQcm9qZWN0aW9uTWF0cml4LAogICAgICAgICAgdmlld3BvcnRUcmFuc2Zvcm1hdGlvbiwKICAgICAgICAgIHBvaW50LAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICByZXN1bHQueSA9IDIgKiB2aWV3cG9ydFRyYW5zZm9ybWF0aW9uWzVdIC0gcmVzdWx0Lnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVHJhbnNmb3Jtcy5wb2ludFRvR0xXaW5kb3dDb29yZGluYXRlcyA9IGZ1bmN0aW9uKG1vZGVsVmlld1Byb2plY3Rpb25NYXRyaXgsIHZpZXdwb3J0VHJhbnNmb3JtYXRpb24sIHBvaW50LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtb2RlbFZpZXdQcm9qZWN0aW9uTWF0cml4KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1vZGVsVmlld1Byb2plY3Rpb25NYXRyaXggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZpZXdwb3J0VHJhbnNmb3JtYXRpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmlld3BvcnRUcmFuc2Zvcm1hdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9pbnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9pbnQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdG1wMiA9IHBvaW50VG9XaW5kb3dDb29yZGluYXRlc1RlbXA7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICBtb2RlbFZpZXdQcm9qZWN0aW9uTWF0cml4LAogICAgICAgICAgQ2FydGVzaWFuNF9kZWZhdWx0LmZyb21FbGVtZW50cyhwb2ludC54LCBwb2ludC55LCBwb2ludC56LCAxLCB0bXAyKSwKICAgICAgICAgIHRtcDIKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjRfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHRtcDIsIDEgLyB0bXAyLncsIHRtcDIpOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHZpZXdwb3J0VHJhbnNmb3JtYXRpb24sIHRtcDIsIHRtcDIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQodG1wMiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgbm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcmlnaHRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1cFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMucm90YXRpb25NYXRyaXhGcm9tUG9zaXRpb25WZWxvY2l0eSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCB2ZWxvY2l0eSwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwb3NpdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmVsb2NpdHkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmVsb2NpdHkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQKICAgICAgICApLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsU2NyYXRjaCk7CiAgICAgICAgbGV0IHJpZ2h0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHZlbG9jaXR5LCBub3JtYWwyLCByaWdodFNjcmF0Y2gpOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihyaWdodCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIE1hdGhfZGVmYXVsdC5FUFNJTE9ONikpIHsKICAgICAgICAgIHJpZ2h0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIHJpZ2h0KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdXAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocmlnaHQsIHZlbG9jaXR5LCB1cFNjcmF0Y2gpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodXAsIHVwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModmVsb2NpdHksIHVwLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShyaWdodCwgcmlnaHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmlnaHQsIHJpZ2h0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHZlbG9jaXR5Lng7CiAgICAgICAgcmVzdWx0WzFdID0gdmVsb2NpdHkueTsKICAgICAgICByZXN1bHRbMl0gPSB2ZWxvY2l0eS56OwogICAgICAgIHJlc3VsdFszXSA9IHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0WzRdID0gcmlnaHQueTsKICAgICAgICByZXN1bHRbNV0gPSByaWdodC56OwogICAgICAgIHJlc3VsdFs2XSA9IHVwLng7CiAgICAgICAgcmVzdWx0WzddID0gdXAueTsKICAgICAgICByZXN1bHRbOF0gPSB1cC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHN3aXp6bGVNYXRyaXggPSBuZXcgTWF0cml4NF9kZWZhdWx0KAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEKICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Byb2plY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSb3RhdGlvbiA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEZyb21FTlUgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUb0VOVSA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5iYXNpc1RvMkQgPSBmdW5jdGlvbihwcm9qZWN0aW9uLCBtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHByb2plY3Rpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicHJvamVjdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWF0cml4KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1hdHJpeCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlc3VsdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcnRjQ2VudGVyID0gTWF0cml4NF9kZWZhdWx0LmdldFRyYW5zbGF0aW9uKG1hdHJpeCwgc2NyYXRjaENlbnRlcik7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcHJvamVjdGlvbi5lbGxpcHNvaWQ7CiAgICAgICAgbGV0IHByb2plY3RlZFBvc2l0aW9uOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKHJ0Y0NlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUHJvamVjdGlvbgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgICAgcnRjQ2VudGVyLAogICAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljCiAgICAgICAgICApOwogICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24gPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzIsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUHJvamVjdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLnosCiAgICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLngsCiAgICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLnksCiAgICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBmcm9tRU5VID0gVHJhbnNmb3Jtcy5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSgKICAgICAgICAgIHJ0Y0NlbnRlciwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hGcm9tRU5VCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgc2NyYXRjaFRvRU5VKTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5nZXRNYXRyaXgzKG1hdHJpeCwgc2NyYXRjaFJvdGF0aW9uKTsKICAgICAgICBjb25zdCBsb2NhbCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5TWF0cml4Myh0b0VOVSwgcm90YXRpb24sIHJlc3VsdCk7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KHN3aXp6bGVNYXRyaXgsIGxvY2FsLCByZXN1bHQpOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5zZXRUcmFuc2xhdGlvbihyZXN1bHQsIHByb2plY3RlZFBvc2l0aW9uLCByZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRyYW5zZm9ybXMuZWxsaXBzb2lkVG8yRE1vZGVsTWF0cml4ID0gZnVuY3Rpb24ocHJvamVjdGlvbiwgY2VudGVyLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9qZWN0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInByb2plY3Rpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNlbnRlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjZW50ZXIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZXN1bHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHByb2plY3Rpb24uZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGZyb21FTlUgPSBUcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKAogICAgICAgICAgY2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaEZyb21FTlUKICAgICAgICApOwogICAgICAgIGNvbnN0IHRvRU5VID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2VUcmFuc2Zvcm1hdGlvbihmcm9tRU5VLCBzY3JhdGNoVG9FTlUpOwogICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljCiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcm9qZWN0ZWRQb3NpdGlvbiA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIsCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Byb2plY3Rpb24KICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbi56LAogICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24ueCwKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLnksCiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgY29uc3QgdHJhbnNsYXRpb24yID0gTWF0cml4NF9kZWZhdWx0LmZyb21UcmFuc2xhdGlvbigKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaEZyb21FTlUKICAgICAgICApOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShzd2l6emxlTWF0cml4LCB0b0VOVSwgcmVzdWx0KTsKICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkodHJhbnNsYXRpb24yLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVHJhbnNmb3Jtc19kZWZhdWx0ID0gVHJhbnNmb3JtczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlY3RhbmdsZS5qcwogIGZ1bmN0aW9uIFJlY3RhbmdsZSh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpIHsKICAgIHRoaXMud2VzdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHdlc3QsIDApOwogICAgdGhpcy5zb3V0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNvdXRoLCAwKTsKICAgIHRoaXMuZWFzdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVhc3QsIDApOwogICAgdGhpcy5ub3J0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG5vcnRoLCAwKTsKICB9CiAgdmFyIGZyb21Cb3VuZGluZ1NwaGVyZU1hdHJpeFNjcmF0Y2gsIGZyb21Cb3VuZGluZ1NwaGVyZUVhc3RTY3JhdGNoLCBmcm9tQm91bmRpbmdTcGhlcmVOb3J0aFNjcmF0Y2gsIGZyb21Cb3VuZGluZ1NwaGVyZVdlc3RTY3JhdGNoLCBmcm9tQm91bmRpbmdTcGhlcmVTb3V0aFNjcmF0Y2gsIGZyb21Cb3VuZGluZ1NwaGVyZVBvc2l0aW9uc1NjcmF0Y2gsIHN1YnNhbXBsZUxsYVNjcmF0Y2gsIFJlY3RhbmdsZV9kZWZhdWx0OwogIHZhciBpbml0X1JlY3RhbmdsZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFJlY3RhbmdsZS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSB3aWR0aCBvZiB0aGUgcmVjdGFuZ2xlIGluIHJhZGlhbnMuCiAgICAgICAgICogQG1lbWJlcm9mIFJlY3RhbmdsZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHdpZHRoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gUmVjdGFuZ2xlLmNvbXB1dGVXaWR0aCh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGhlaWdodCBvZiB0aGUgcmVjdGFuZ2xlIGluIHJhZGlhbnMuCiAgICAgICAgICogQG1lbWJlcm9mIFJlY3RhbmdsZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGhlaWdodDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5jb21wdXRlSGVpZ2h0KHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIFJlY3RhbmdsZS5wYWNrZWRMZW5ndGggPSA0OwogICAgICBSZWN0YW5nbGUucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLndlc3Q7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnNvdXRoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5lYXN0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUubm9ydGg7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBSZWN0YW5nbGUudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBSZWN0YW5nbGUoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5zb3V0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmVhc3QgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5ub3J0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5jb21wdXRlV2lkdGggPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICBjb25zdCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBlYXN0IC0gd2VzdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmNvbXB1dGVIZWlnaHQgPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgcmV0dXJuIHJlY3RhbmdsZS5ub3J0aCAtIHJlY3RhbmdsZS5zb3V0aDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmZyb21EZWdyZWVzID0gZnVuY3Rpb24od2VzdCwgc291dGgsIGVhc3QsIG5vcnRoLCByZXN1bHQpIHsKICAgICAgICB3ZXN0ID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhkZWZhdWx0VmFsdWVfZGVmYXVsdCh3ZXN0LCAwKSk7CiAgICAgICAgc291dGggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNvdXRoLCAwKSk7CiAgICAgICAgZWFzdCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWFzdCwgMCkpOwogICAgICAgIG5vcnRoID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhkZWZhdWx0VmFsdWVfZGVmYXVsdChub3J0aCwgMCkpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gd2VzdDsKICAgICAgICByZXN1bHQuc291dGggPSBzb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IGVhc3Q7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gbm9ydGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmZyb21SYWRpYW5zID0gZnVuY3Rpb24od2VzdCwgc291dGgsIGVhc3QsIG5vcnRoLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZSh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHdlc3QsIDApOwogICAgICAgIHJlc3VsdC5zb3V0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNvdXRoLCAwKTsKICAgICAgICByZXN1bHQuZWFzdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVhc3QsIDApOwogICAgICAgIHJlc3VsdC5ub3J0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG5vcnRoLCAwKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZnJvbUNhcnRvZ3JhcGhpY0FycmF5ID0gZnVuY3Rpb24oY2FydG9ncmFwaGljcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0b2dyYXBoaWNzIiwgY2FydG9ncmFwaGljcyk7CiAgICAgICAgbGV0IHdlc3QgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBlYXN0ID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IHdlc3RPdmVySURMID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgZWFzdE92ZXJJREwgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgc291dGggPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBub3J0aCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBjYXJ0b2dyYXBoaWNzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwb3NpdGlvbiA9IGNhcnRvZ3JhcGhpY3NbaV07CiAgICAgICAgICB3ZXN0ID0gTWF0aC5taW4od2VzdCwgcG9zaXRpb24ubG9uZ2l0dWRlKTsKICAgICAgICAgIGVhc3QgPSBNYXRoLm1heChlYXN0LCBwb3NpdGlvbi5sb25naXR1ZGUpOwogICAgICAgICAgc291dGggPSBNYXRoLm1pbihzb3V0aCwgcG9zaXRpb24ubGF0aXR1ZGUpOwogICAgICAgICAgbm9ydGggPSBNYXRoLm1heChub3J0aCwgcG9zaXRpb24ubGF0aXR1ZGUpOwogICAgICAgICAgY29uc3QgbG9uQWRqdXN0ZWQgPSBwb3NpdGlvbi5sb25naXR1ZGUgPj0gMCA/IHBvc2l0aW9uLmxvbmdpdHVkZSA6IHBvc2l0aW9uLmxvbmdpdHVkZSArIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB3ZXN0T3ZlcklETCA9IE1hdGgubWluKHdlc3RPdmVySURMLCBsb25BZGp1c3RlZCk7CiAgICAgICAgICBlYXN0T3ZlcklETCA9IE1hdGgubWF4KGVhc3RPdmVySURMLCBsb25BZGp1c3RlZCk7CiAgICAgICAgfQogICAgICAgIGlmIChlYXN0IC0gd2VzdCA+IGVhc3RPdmVySURMIC0gd2VzdE92ZXJJREwpIHsKICAgICAgICAgIHdlc3QgPSB3ZXN0T3ZlcklETDsKICAgICAgICAgIGVhc3QgPSBlYXN0T3ZlcklETDsKICAgICAgICAgIGlmIChlYXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIGVhc3QgPSBlYXN0IC0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3ZXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIHdlc3QgPSB3ZXN0IC0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZnJvbUNhcnRlc2lhbkFycmF5ID0gZnVuY3Rpb24oY2FydGVzaWFucywgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgICAgIGxldCB3ZXN0ID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgZWFzdCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCB3ZXN0T3ZlcklETCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGVhc3RPdmVySURMID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IHNvdXRoID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgbm9ydGggPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gY2FydGVzaWFucy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoY2FydGVzaWFuc1tpXSk7CiAgICAgICAgICB3ZXN0ID0gTWF0aC5taW4od2VzdCwgcG9zaXRpb24ubG9uZ2l0dWRlKTsKICAgICAgICAgIGVhc3QgPSBNYXRoLm1heChlYXN0LCBwb3NpdGlvbi5sb25naXR1ZGUpOwogICAgICAgICAgc291dGggPSBNYXRoLm1pbihzb3V0aCwgcG9zaXRpb24ubGF0aXR1ZGUpOwogICAgICAgICAgbm9ydGggPSBNYXRoLm1heChub3J0aCwgcG9zaXRpb24ubGF0aXR1ZGUpOwogICAgICAgICAgY29uc3QgbG9uQWRqdXN0ZWQgPSBwb3NpdGlvbi5sb25naXR1ZGUgPj0gMCA/IHBvc2l0aW9uLmxvbmdpdHVkZSA6IHBvc2l0aW9uLmxvbmdpdHVkZSArIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB3ZXN0T3ZlcklETCA9IE1hdGgubWluKHdlc3RPdmVySURMLCBsb25BZGp1c3RlZCk7CiAgICAgICAgICBlYXN0T3ZlcklETCA9IE1hdGgubWF4KGVhc3RPdmVySURMLCBsb25BZGp1c3RlZCk7CiAgICAgICAgfQogICAgICAgIGlmIChlYXN0IC0gd2VzdCA+IGVhc3RPdmVySURMIC0gd2VzdE92ZXJJREwpIHsKICAgICAgICAgIHdlc3QgPSB3ZXN0T3ZlcklETDsKICAgICAgICAgIGVhc3QgPSBlYXN0T3ZlcklETDsKICAgICAgICAgIGlmIChlYXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIGVhc3QgPSBlYXN0IC0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3ZXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIHdlc3QgPSB3ZXN0IC0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tQm91bmRpbmdTcGhlcmVNYXRyaXhTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tQm91bmRpbmdTcGhlcmVFYXN0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbUJvdW5kaW5nU3BoZXJlTm9ydGhTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tQm91bmRpbmdTcGhlcmVXZXN0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbUJvdW5kaW5nU3BoZXJlU291dGhTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tQm91bmRpbmdTcGhlcmVQb3NpdGlvbnNTY3JhdGNoID0gbmV3IEFycmF5KDUpOwogICAgICBmb3IgKGxldCBuID0gMDsgbiA8IGZyb21Cb3VuZGluZ1NwaGVyZVBvc2l0aW9uc1NjcmF0Y2gubGVuZ3RoOyArK24pIHsKICAgICAgICBmcm9tQm91bmRpbmdTcGhlcmVQb3NpdGlvbnNTY3JhdGNoW25dID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB9CiAgICAgIFJlY3RhbmdsZS5mcm9tQm91bmRpbmdTcGhlcmUgPSBmdW5jdGlvbihib3VuZGluZ1NwaGVyZSwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImJvdW5kaW5nU3BoZXJlIiwgYm91bmRpbmdTcGhlcmUpOwogICAgICAgIGNvbnN0IGNlbnRlciA9IGJvdW5kaW5nU3BoZXJlLmNlbnRlcjsKICAgICAgICBjb25zdCByYWRpdXMgPSBib3VuZGluZ1NwaGVyZS5yYWRpdXM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSkgewogICAgICAgICAgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFJlY3RhbmdsZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhjZW50ZXIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgUmVjdGFuZ2xlLmNsb25lKFJlY3RhbmdsZS5NQVhfVkFMVUUsIHJlc3VsdCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBmcm9tRU5VID0gVHJhbnNmb3Jtc19kZWZhdWx0LmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKAogICAgICAgICAgY2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZnJvbUJvdW5kaW5nU3BoZXJlTWF0cml4U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgZWFzdCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvcigKICAgICAgICAgIGZyb21FTlUsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLAogICAgICAgICAgZnJvbUJvdW5kaW5nU3BoZXJlRWFzdFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZWFzdCwgZWFzdCk7CiAgICAgICAgY29uc3Qgbm9ydGggPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50QXNWZWN0b3IoCiAgICAgICAgICBmcm9tRU5VLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwKICAgICAgICAgIGZyb21Cb3VuZGluZ1NwaGVyZU5vcnRoU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3J0aCwgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcnRoLCByYWRpdXMsIG5vcnRoKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihlYXN0LCByYWRpdXMsIGVhc3QpOwogICAgICAgIGNvbnN0IHNvdXRoID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShub3J0aCwgZnJvbUJvdW5kaW5nU3BoZXJlU291dGhTY3JhdGNoKTsKICAgICAgICBjb25zdCB3ZXN0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShlYXN0LCBmcm9tQm91bmRpbmdTcGhlcmVXZXN0U2NyYXRjaCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gZnJvbUJvdW5kaW5nU3BoZXJlUG9zaXRpb25zU2NyYXRjaDsKICAgICAgICBsZXQgY29ybmVyID0gcG9zaXRpb25zWzBdOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMV07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHdlc3QsIGNvcm5lcik7CiAgICAgICAgY29ybmVyID0gcG9zaXRpb25zWzJdOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbM107CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIGVhc3QsIGNvcm5lcik7CiAgICAgICAgcG9zaXRpb25zWzRdID0gY2VudGVyOwogICAgICAgIHJldHVybiBSZWN0YW5nbGUuZnJvbUNhcnRlc2lhbkFycmF5KHBvc2l0aW9ucywgZWxsaXBzb2lkLCByZXN1bHQpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY2xvbmUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgICAgICByZWN0YW5nbGUuZWFzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBhYnNvbHV0ZUVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0Lndlc3QgLSByaWdodC53ZXN0KSA8PSBhYnNvbHV0ZUVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5zb3V0aCAtIHJpZ2h0LnNvdXRoKSA8PSBhYnNvbHV0ZUVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5lYXN0IC0gcmlnaHQuZWFzdCkgPD0gYWJzb2x1dGVFcHNpbG9uICYmIE1hdGguYWJzKGxlZnQubm9ydGggLSByaWdodC5ub3J0aCkgPD0gYWJzb2x1dGVFcHNpbG9uOwogICAgICB9OwogICAgICBSZWN0YW5nbGUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5lcXVhbHModGhpcywgb3RoZXIpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC53ZXN0ID09PSByaWdodC53ZXN0ICYmIGxlZnQuc291dGggPT09IHJpZ2h0LnNvdXRoICYmIGxlZnQuZWFzdCA9PT0gcmlnaHQuZWFzdCAmJiBsZWZ0Lm5vcnRoID09PSByaWdodC5ub3J0aDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gUmVjdGFuZ2xlLmVxdWFsc0Vwc2lsb24odGhpcywgb3RoZXIsIGVwc2lsb24pOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuX3ZhbGlkYXRlID0gZnVuY3Rpb24ocmVjdGFuZ2xlKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IG5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKAogICAgICAgICAgIm5vcnRoIiwKICAgICAgICAgIG5vcnRoLAogICAgICAgICAgLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTwogICAgICAgICk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoIm5vcnRoIiwgbm9ydGgsIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyk7CiAgICAgICAgY29uc3Qgc291dGggPSByZWN0YW5nbGUuc291dGg7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICAgICAic291dGgiLAogICAgICAgICAgc291dGgsCiAgICAgICAgICAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygic291dGgiLCBzb3V0aCwgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPKTsKICAgICAgICBjb25zdCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIndlc3QiLCB3ZXN0LCAtTWF0aC5QSSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoIndlc3QiLCB3ZXN0LCBNYXRoLlBJKTsKICAgICAgICBjb25zdCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImVhc3QiLCBlYXN0LCAtTWF0aC5QSSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImVhc3QiLCBlYXN0LCBNYXRoLlBJKTsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnNvdXRod2VzdCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSByZWN0YW5nbGUuc291dGg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLm5vcnRod2VzdCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLm5vcnRoZWFzdCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQocmVjdGFuZ2xlLmVhc3QsIHJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnNvdXRoZWFzdCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQocmVjdGFuZ2xlLmVhc3QsIHJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSByZWN0YW5nbGUuc291dGg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmNlbnRlciA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGlmIChlYXN0IDwgd2VzdCkgewogICAgICAgICAgZWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoKHdlc3QgKyBlYXN0KSAqIDAuNSk7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSAocmVjdGFuZ2xlLnNvdXRoICsgcmVjdGFuZ2xlLm5vcnRoKSAqIDAuNTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KGxvbmdpdHVkZSwgbGF0aXR1ZGUpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IGxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5pbnRlcnNlY3Rpb24gPSBmdW5jdGlvbihyZWN0YW5nbGUsIG90aGVyUmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvdGhlclJlY3RhbmdsZSIsIG90aGVyUmVjdGFuZ2xlKTsKICAgICAgICBsZXQgcmVjdGFuZ2xlRWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGxldCByZWN0YW5nbGVXZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgbGV0IG90aGVyUmVjdGFuZ2xlRWFzdCA9IG90aGVyUmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IG90aGVyUmVjdGFuZ2xlV2VzdCA9IG90aGVyUmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgaWYgKHJlY3RhbmdsZUVhc3QgPCByZWN0YW5nbGVXZXN0ICYmIG90aGVyUmVjdGFuZ2xlRWFzdCA+IDApIHsKICAgICAgICAgIHJlY3RhbmdsZUVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9IGVsc2UgaWYgKG90aGVyUmVjdGFuZ2xlRWFzdCA8IG90aGVyUmVjdGFuZ2xlV2VzdCAmJiByZWN0YW5nbGVFYXN0ID4gMCkgewogICAgICAgICAgb3RoZXJSZWN0YW5nbGVFYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGlmIChyZWN0YW5nbGVFYXN0IDwgcmVjdGFuZ2xlV2VzdCAmJiBvdGhlclJlY3RhbmdsZVdlc3QgPCAwKSB7CiAgICAgICAgICBvdGhlclJlY3RhbmdsZVdlc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9IGVsc2UgaWYgKG90aGVyUmVjdGFuZ2xlRWFzdCA8IG90aGVyUmVjdGFuZ2xlV2VzdCAmJiByZWN0YW5nbGVXZXN0IDwgMCkgewogICAgICAgICAgcmVjdGFuZ2xlV2VzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICBjb25zdCB3ZXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKAogICAgICAgICAgTWF0aC5tYXgocmVjdGFuZ2xlV2VzdCwgb3RoZXJSZWN0YW5nbGVXZXN0KQogICAgICAgICk7CiAgICAgICAgY29uc3QgZWFzdCA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaSgKICAgICAgICAgIE1hdGgubWluKHJlY3RhbmdsZUVhc3QsIG90aGVyUmVjdGFuZ2xlRWFzdCkKICAgICAgICApOwogICAgICAgIGlmICgocmVjdGFuZ2xlLndlc3QgPCByZWN0YW5nbGUuZWFzdCB8fCBvdGhlclJlY3RhbmdsZS53ZXN0IDwgb3RoZXJSZWN0YW5nbGUuZWFzdCkgJiYgZWFzdCA8PSB3ZXN0KSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBzb3V0aCA9IE1hdGgubWF4KHJlY3RhbmdsZS5zb3V0aCwgb3RoZXJSZWN0YW5nbGUuc291dGgpOwogICAgICAgIGNvbnN0IG5vcnRoID0gTWF0aC5taW4ocmVjdGFuZ2xlLm5vcnRoLCBvdGhlclJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgaWYgKHNvdXRoID49IG5vcnRoKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZSh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBlYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5zaW1wbGVJbnRlcnNlY3Rpb24gPSBmdW5jdGlvbihyZWN0YW5nbGUsIG90aGVyUmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvdGhlclJlY3RhbmdsZSIsIG90aGVyUmVjdGFuZ2xlKTsKICAgICAgICBjb25zdCB3ZXN0ID0gTWF0aC5tYXgocmVjdGFuZ2xlLndlc3QsIG90aGVyUmVjdGFuZ2xlLndlc3QpOwogICAgICAgIGNvbnN0IHNvdXRoID0gTWF0aC5tYXgocmVjdGFuZ2xlLnNvdXRoLCBvdGhlclJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgY29uc3QgZWFzdCA9IE1hdGgubWluKHJlY3RhbmdsZS5lYXN0LCBvdGhlclJlY3RhbmdsZS5lYXN0KTsKICAgICAgICBjb25zdCBub3J0aCA9IE1hdGgubWluKHJlY3RhbmdsZS5ub3J0aCwgb3RoZXJSZWN0YW5nbGUubm9ydGgpOwogICAgICAgIGlmIChzb3V0aCA+PSBub3J0aCB8fCB3ZXN0ID49IGVhc3QpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gd2VzdDsKICAgICAgICByZXN1bHQuc291dGggPSBzb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IGVhc3Q7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gbm9ydGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnVuaW9uID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBvdGhlclJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3RoZXJSZWN0YW5nbGUiLCBvdGhlclJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFJlY3RhbmdsZSgpOwogICAgICAgIH0KICAgICAgICBsZXQgcmVjdGFuZ2xlRWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGxldCByZWN0YW5nbGVXZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgbGV0IG90aGVyUmVjdGFuZ2xlRWFzdCA9IG90aGVyUmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IG90aGVyUmVjdGFuZ2xlV2VzdCA9IG90aGVyUmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgaWYgKHJlY3RhbmdsZUVhc3QgPCByZWN0YW5nbGVXZXN0ICYmIG90aGVyUmVjdGFuZ2xlRWFzdCA+IDApIHsKICAgICAgICAgIHJlY3RhbmdsZUVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9IGVsc2UgaWYgKG90aGVyUmVjdGFuZ2xlRWFzdCA8IG90aGVyUmVjdGFuZ2xlV2VzdCAmJiByZWN0YW5nbGVFYXN0ID4gMCkgewogICAgICAgICAgb3RoZXJSZWN0YW5nbGVFYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGlmIChyZWN0YW5nbGVFYXN0IDwgcmVjdGFuZ2xlV2VzdCAmJiBvdGhlclJlY3RhbmdsZVdlc3QgPCAwKSB7CiAgICAgICAgICBvdGhlclJlY3RhbmdsZVdlc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9IGVsc2UgaWYgKG90aGVyUmVjdGFuZ2xlRWFzdCA8IG90aGVyUmVjdGFuZ2xlV2VzdCAmJiByZWN0YW5nbGVXZXN0IDwgMCkgewogICAgICAgICAgcmVjdGFuZ2xlV2VzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICBjb25zdCB3ZXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKAogICAgICAgICAgTWF0aC5taW4ocmVjdGFuZ2xlV2VzdCwgb3RoZXJSZWN0YW5nbGVXZXN0KQogICAgICAgICk7CiAgICAgICAgY29uc3QgZWFzdCA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaSgKICAgICAgICAgIE1hdGgubWF4KHJlY3RhbmdsZUVhc3QsIG90aGVyUmVjdGFuZ2xlRWFzdCkKICAgICAgICApOwogICAgICAgIHJlc3VsdC53ZXN0ID0gd2VzdDsKICAgICAgICByZXN1bHQuc291dGggPSBNYXRoLm1pbihyZWN0YW5nbGUuc291dGgsIG90aGVyUmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICByZXN1bHQuZWFzdCA9IGVhc3Q7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gTWF0aC5tYXgocmVjdGFuZ2xlLm5vcnRoLCBvdGhlclJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmV4cGFuZCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgY2FydG9ncmFwaGljMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydG9ncmFwaGljIiwgY2FydG9ncmFwaGljMik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFJlY3RhbmdsZSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IE1hdGgubWluKHJlY3RhbmdsZS53ZXN0LCBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSk7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gTWF0aC5taW4ocmVjdGFuZ2xlLnNvdXRoLCBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlKTsKICAgICAgICByZXN1bHQuZWFzdCA9IE1hdGgubWF4KHJlY3RhbmdsZS5lYXN0LCBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSk7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gTWF0aC5tYXgocmVjdGFuZ2xlLm5vcnRoLCBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY29udGFpbnMgPSBmdW5jdGlvbihyZWN0YW5nbGUsIGNhcnRvZ3JhcGhpYzIpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0b2dyYXBoaWMiLCBjYXJ0b2dyYXBoaWMyKTsKICAgICAgICBsZXQgbG9uZ2l0dWRlID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGU7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlOwogICAgICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGlmIChlYXN0IDwgd2VzdCkgewogICAgICAgICAgZWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgaWYgKGxvbmdpdHVkZSA8IDApIHsKICAgICAgICAgICAgbG9uZ2l0dWRlICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAobG9uZ2l0dWRlID4gd2VzdCB8fCBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihsb25naXR1ZGUsIHdlc3QsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSAmJiAobG9uZ2l0dWRlIDwgZWFzdCB8fCBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihsb25naXR1ZGUsIGVhc3QsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSAmJiBsYXRpdHVkZSA+PSByZWN0YW5nbGUuc291dGggJiYgbGF0aXR1ZGUgPD0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICB9OwogICAgICBzdWJzYW1wbGVMbGFTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFJlY3RhbmdsZS5zdWJzYW1wbGUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIGVsbGlwc29pZCwgc3VyZmFjZUhlaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCk7CiAgICAgICAgc3VyZmFjZUhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN1cmZhY2VIZWlnaHQsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBsZXQgbGVuZ3RoID0gMDsKICAgICAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICBjb25zdCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGNvbnN0IGxsYSA9IHN1YnNhbXBsZUxsYVNjcmF0Y2g7CiAgICAgICAgbGxhLmhlaWdodCA9IHN1cmZhY2VIZWlnaHQ7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgbGxhLmxhdGl0dWRlID0gbm9ydGg7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IGVhc3Q7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxhdGl0dWRlID0gc291dGg7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgaWYgKG5vcnRoIDwgMCkgewogICAgICAgICAgbGxhLmxhdGl0dWRlID0gbm9ydGg7CiAgICAgICAgfSBlbHNlIGlmIChzb3V0aCA+IDApIHsKICAgICAgICAgIGxsYS5sYXRpdHVkZSA9IHNvdXRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsbGEubGF0aXR1ZGUgPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IDg7ICsraSkgewogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IC1NYXRoLlBJICsgaSAqIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIGlmIChSZWN0YW5nbGUuY29udGFpbnMocmVjdGFuZ2xlLCBsbGEpKSB7CiAgICAgICAgICAgIHJlc3VsdFtsZW5ndGhdID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGxsYSwgcmVzdWx0W2xlbmd0aF0pOwogICAgICAgICAgICBsZW5ndGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGxsYS5sYXRpdHVkZSA9PT0gMCkgewogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihsbGEsIHJlc3VsdFtsZW5ndGhdKTsKICAgICAgICAgIGxlbmd0aCsrOwogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IGVhc3Q7CiAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihsbGEsIHJlc3VsdFtsZW5ndGhdKTsKICAgICAgICAgIGxlbmd0aCsrOwogICAgICAgIH0KICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5zdWJzZWN0aW9uID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCB3ZXN0TGVycCwgc291dGhMZXJwLCBlYXN0TGVycCwgbm9ydGhMZXJwLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIndlc3RMZXJwIiwgd2VzdExlcnAsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJ3ZXN0TGVycCIsIHdlc3RMZXJwLCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygic291dGhMZXJwIiwgc291dGhMZXJwLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygic291dGhMZXJwIiwgc291dGhMZXJwLCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZWFzdExlcnAiLCBlYXN0TGVycCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImVhc3RMZXJwIiwgZWFzdExlcnAsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJub3J0aExlcnAiLCBub3J0aExlcnAsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJub3J0aExlcnAiLCBub3J0aExlcnAsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJ3ZXN0TGVycCIsIHdlc3RMZXJwLCBlYXN0TGVycCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoInNvdXRoTGVycCIsIHNvdXRoTGVycCwgbm9ydGhMZXJwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGlmIChyZWN0YW5nbGUud2VzdCA8PSByZWN0YW5nbGUuZWFzdCkgewogICAgICAgICAgY29uc3Qgd2lkdGggPSByZWN0YW5nbGUuZWFzdCAtIHJlY3RhbmdsZS53ZXN0OwogICAgICAgICAgcmVzdWx0Lndlc3QgPSByZWN0YW5nbGUud2VzdCArIHdlc3RMZXJwICogd2lkdGg7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IHJlY3RhbmdsZS53ZXN0ICsgZWFzdExlcnAgKiB3aWR0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3Qgd2lkdGggPSBNYXRoX2RlZmF1bHQuVFdPX1BJICsgcmVjdGFuZ2xlLmVhc3QgLSByZWN0YW5nbGUud2VzdDsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHJlY3RhbmdsZS53ZXN0ICsgd2VzdExlcnAgKiB3aWR0aCk7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShyZWN0YW5nbGUud2VzdCArIGVhc3RMZXJwICogd2lkdGgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSByZWN0YW5nbGUubm9ydGggLSByZWN0YW5nbGUuc291dGg7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoICsgc291dGhMZXJwICogaGVpZ2h0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IHJlY3RhbmdsZS5zb3V0aCArIG5vcnRoTGVycCAqIGhlaWdodDsKICAgICAgICBpZiAod2VzdExlcnAgPT09IDEpIHsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgfQogICAgICAgIGlmIChlYXN0TGVycCA9PT0gMSkgewogICAgICAgICAgcmVzdWx0LmVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICB9CiAgICAgICAgaWYgKHNvdXRoTGVycCA9PT0gMSkgewogICAgICAgICAgcmVzdWx0LnNvdXRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIH0KICAgICAgICBpZiAobm9ydGhMZXJwID09PSAxKSB7CiAgICAgICAgICByZXN1bHQubm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5NQVhfVkFMVUUgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBSZWN0YW5nbGUoCiAgICAgICAgICAtTWF0aC5QSSwKICAgICAgICAgIC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08sCiAgICAgICAgICBNYXRoLlBJLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgKQogICAgICApOwogICAgICBSZWN0YW5nbGVfZGVmYXVsdCA9IFJlY3RhbmdsZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JvdW5kaW5nU3BoZXJlLmpzCiAgZnVuY3Rpb24gQm91bmRpbmdTcGhlcmUoY2VudGVyLCByYWRpdXMpIHsKICAgIHRoaXMuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKTsKICAgIHRoaXMucmFkaXVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocmFkaXVzLCAwKTsKICB9CiAgdmFyIGZyb21Qb2ludHNYTWluLCBmcm9tUG9pbnRzWU1pbiwgZnJvbVBvaW50c1pNaW4sIGZyb21Qb2ludHNYTWF4LCBmcm9tUG9pbnRzWU1heCwgZnJvbVBvaW50c1pNYXgsIGZyb21Qb2ludHNDdXJyZW50UG9zLCBmcm9tUG9pbnRzU2NyYXRjaCwgZnJvbVBvaW50c1JpdHRlckNlbnRlciwgZnJvbVBvaW50c01pbkJveFB0LCBmcm9tUG9pbnRzTWF4Qm94UHQsIGZyb21Qb2ludHNOYWl2ZUNlbnRlclNjcmF0Y2gsIHZvbHVtZUNvbnN0YW50LCBkZWZhdWx0UHJvamVjdGlvbiwgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0LCBmcm9tUmVjdGFuZ2xlMkRVcHBlclJpZ2h0LCBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QsIGZyb21SZWN0YW5nbGUyRE5vcnRoZWFzdCwgZnJvbVJlY3RhbmdsZTNEU2NyYXRjaCwgZnJvbUJvdW5kaW5nU3BoZXJlc1NjcmF0Y2gsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFUsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFYsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFcsIHNjcmF0Y2hGcm9tVHJhbnNmb3JtYXRpb25DZW50ZXIsIHNjcmF0Y2hGcm9tVHJhbnNmb3JtYXRpb25TY2FsZSwgdW5pb25TY3JhdGNoLCB1bmlvblNjcmF0Y2hDZW50ZXIsIGV4cGFuZFNjcmF0Y2gsIGRpc3RhbmNlU3F1YXJlZFRvU2NyYXRjaCwgc2NyYXRjaENhcnRlc2lhbjMsIHByb2plY3RUbzJETm9ybWFsU2NyYXRjaCwgcHJvamVjdFRvMkRFYXN0U2NyYXRjaCwgcHJvamVjdFRvMkROb3J0aFNjcmF0Y2gsIHByb2plY3RUbzJEV2VzdFNjcmF0Y2gsIHByb2plY3RUbzJEU291dGhTY3JhdGNoLCBwcm9qZWN0VG8yRENhcnRvZ3JhcGhpY1NjcmF0Y2gsIHByb2plY3RUbzJEUG9zaXRpb25zU2NyYXRjaCwgcHJvamVjdFRvMkRQcm9qZWN0aW9uLCBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0OwogIHZhciBpbml0X0JvdW5kaW5nU3BoZXJlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3VuZGluZ1NwaGVyZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIGluaXRfSW50ZXJ2YWwoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgZnJvbVBvaW50c1hNaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNZTWluID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzWk1pbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c1hNYXggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNZTWF4ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzWk1heCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c0N1cnJlbnRQb3MgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzUml0dGVyQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzTWluQm94UHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNNYXhCb3hQdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdm9sdW1lQ29uc3RhbnQgPSA0IC8gMyAqIE1hdGhfZGVmYXVsdC5QSTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbVBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN1cnJlbnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb25zWzBdLCBmcm9tUG9pbnRzQ3VycmVudFBvcyk7CiAgICAgICAgY29uc3QgeE1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1pbik7CiAgICAgICAgY29uc3QgeU1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1pbik7CiAgICAgICAgY29uc3Qgek1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1pbik7CiAgICAgICAgY29uc3QgeE1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1heCk7CiAgICAgICAgY29uc3QgeU1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1heCk7CiAgICAgICAgY29uc3Qgek1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1heCk7CiAgICAgICAgY29uc3QgbnVtUG9zaXRpb25zID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUG9zaXRpb25zOyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbaV0sIGN1cnJlbnRQb3MpOwogICAgICAgICAgY29uc3QgeCA9IGN1cnJlbnRQb3MueDsKICAgICAgICAgIGNvbnN0IHkgPSBjdXJyZW50UG9zLnk7CiAgICAgICAgICBjb25zdCB6ID0gY3VycmVudFBvcy56OwogICAgICAgICAgaWYgKHggPCB4TWluLngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHggPiB4TWF4LngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPCB5TWluLnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPiB5TWF4LnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPCB6TWluLnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPiB6TWF4LnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNYXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB4U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHhNYXgsIHhNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgeVNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh5TWF4LCB5TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHpTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoek1heCwgek1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBsZXQgZGlhbWV0ZXIxID0geE1pbjsKICAgICAgICBsZXQgZGlhbWV0ZXIyID0geE1heDsKICAgICAgICBsZXQgbWF4U3BhbiA9IHhTcGFuOwogICAgICAgIGlmICh5U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB5U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHlNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB5TWF4OwogICAgICAgIH0KICAgICAgICBpZiAoelNwYW4gPiBtYXhTcGFuKSB7CiAgICAgICAgICBtYXhTcGFuID0gelNwYW47CiAgICAgICAgICBkaWFtZXRlcjEgPSB6TWluOwogICAgICAgICAgZGlhbWV0ZXIyID0gek1heDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgcml0dGVyQ2VudGVyID0gZnJvbVBvaW50c1JpdHRlckNlbnRlcjsKICAgICAgICByaXR0ZXJDZW50ZXIueCA9IChkaWFtZXRlcjEueCArIGRpYW1ldGVyMi54KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChkaWFtZXRlcjEueSArIGRpYW1ldGVyMi55KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChkaWFtZXRlcjEueiArIGRpYW1ldGVyMi56KSAqIDAuNTsKICAgICAgICBsZXQgcmFkaXVzU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGRpYW1ldGVyMiwgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCByaXR0ZXJSYWRpdXMgPSBNYXRoLnNxcnQocmFkaXVzU3F1YXJlZCk7CiAgICAgICAgY29uc3QgbWluQm94UHQgPSBmcm9tUG9pbnRzTWluQm94UHQ7CiAgICAgICAgbWluQm94UHQueCA9IHhNaW4ueDsKICAgICAgICBtaW5Cb3hQdC55ID0geU1pbi55OwogICAgICAgIG1pbkJveFB0LnogPSB6TWluLno7CiAgICAgICAgY29uc3QgbWF4Qm94UHQgPSBmcm9tUG9pbnRzTWF4Qm94UHQ7CiAgICAgICAgbWF4Qm94UHQueCA9IHhNYXgueDsKICAgICAgICBtYXhCb3hQdC55ID0geU1heC55OwogICAgICAgIG1heEJveFB0LnogPSB6TWF4Lno7CiAgICAgICAgY29uc3QgbmFpdmVDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoCiAgICAgICAgICBtaW5Cb3hQdCwKICAgICAgICAgIG1heEJveFB0LAogICAgICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IG5haXZlUmFkaXVzID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9zaXRpb25zOyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbaV0sIGN1cnJlbnRQb3MpOwogICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjdXJyZW50UG9zLCBuYWl2ZUNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHIgPiBuYWl2ZVJhZGl1cykgewogICAgICAgICAgICBuYWl2ZVJhZGl1cyA9IHI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPiByYWRpdXNTcXVhcmVkKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZENlbnRlclRvUG9pbnQgPSBNYXRoLnNxcnQob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQpOwogICAgICAgICAgICByaXR0ZXJSYWRpdXMgPSAocml0dGVyUmFkaXVzICsgb2xkQ2VudGVyVG9Qb2ludCkgKiAwLjU7CiAgICAgICAgICAgIHJhZGl1c1NxdWFyZWQgPSByaXR0ZXJSYWRpdXMgKiByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIGNvbnN0IG9sZFRvTmV3ID0gb2xkQ2VudGVyVG9Qb2ludCAtIHJpdHRlclJhZGl1czsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnggPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnggKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueCkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueSArIG9sZFRvTmV3ICogY3VycmVudFBvcy55KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci56ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci56ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLnopIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJpdHRlclJhZGl1cyA8IG5haXZlUmFkaXVzKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocml0dGVyQ2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByaXR0ZXJSYWRpdXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShuYWl2ZUNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gbmFpdmVSYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGRlZmF1bHRQcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlMkRVcHBlclJpZ2h0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGUyRCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcHJvamVjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGVXaXRoSGVpZ2h0czJEKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbVJlY3RhbmdsZVdpdGhIZWlnaHRzMkQgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHByb2plY3Rpb24sIG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdFByb2plY3Rpb24uX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQ7CiAgICAgICAgcHJvamVjdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHByb2plY3Rpb24sIGRlZmF1bHRQcm9qZWN0aW9uKTsKICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5zb3V0aHdlc3QocmVjdGFuZ2xlLCBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QpOwogICAgICAgIGZyb21SZWN0YW5nbGUyRFNvdXRod2VzdC5oZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0Lm5vcnRoZWFzdChyZWN0YW5nbGUsIGZyb21SZWN0YW5nbGUyRE5vcnRoZWFzdCk7CiAgICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0LmhlaWdodCA9IG1heGltdW1IZWlnaHQ7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJEU291dGh3ZXN0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0CiAgICAgICAgKTsKICAgICAgICBjb25zdCB1cHBlclJpZ2h0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJEVXBwZXJSaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3Qgd2lkdGggPSB1cHBlclJpZ2h0LnggLSBsb3dlckxlZnQueDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB1cHBlclJpZ2h0LnkgLSBsb3dlckxlZnQueTsKICAgICAgICBjb25zdCBlbGV2YXRpb24gPSB1cHBlclJpZ2h0LnogLSBsb3dlckxlZnQuejsKICAgICAgICByZXN1bHQucmFkaXVzID0gTWF0aC5zcXJ0KHdpZHRoICogd2lkdGggKyBoZWlnaHQgKiBoZWlnaHQgKyBlbGV2YXRpb24gKiBlbGV2YXRpb24pICogMC41OwogICAgICAgIGNvbnN0IGNlbnRlciA9IHJlc3VsdC5jZW50ZXI7CiAgICAgICAgY2VudGVyLnggPSBsb3dlckxlZnQueCArIHdpZHRoICogMC41OwogICAgICAgIGNlbnRlci55ID0gbG93ZXJMZWZ0LnkgKyBoZWlnaHQgKiAwLjU7CiAgICAgICAgY2VudGVyLnogPSBsb3dlckxlZnQueiArIGVsZXZhdGlvbiAqIDAuNTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tUmVjdGFuZ2xlM0RTY3JhdGNoID0gW107CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGUzRCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBzdXJmYWNlSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgICAgIHN1cmZhY2VIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdXJmYWNlSGVpZ2h0LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IFJlY3RhbmdsZV9kZWZhdWx0LnN1YnNhbXBsZSgKICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN1cmZhY2VIZWlnaHQsCiAgICAgICAgICBmcm9tUmVjdGFuZ2xlM0RTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQm91bmRpbmdTcGhlcmUuZnJvbVBvaW50cyhwb3NpdGlvbnMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21WZXJ0aWNlcyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgY2VudGVyLCBzdHJpZGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpIHx8IHBvc2l0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjZW50ZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjZW50ZXIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKTsKICAgICAgICBzdHJpZGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdHJpZGUsIDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJzdHJpZGUiLCBzdHJpZGUsIDMpOwogICAgICAgIGNvbnN0IGN1cnJlbnRQb3MgPSBmcm9tUG9pbnRzQ3VycmVudFBvczsKICAgICAgICBjdXJyZW50UG9zLnggPSBwb3NpdGlvbnNbMF0gKyBjZW50ZXIueDsKICAgICAgICBjdXJyZW50UG9zLnkgPSBwb3NpdGlvbnNbMV0gKyBjZW50ZXIueTsKICAgICAgICBjdXJyZW50UG9zLnogPSBwb3NpdGlvbnNbMl0gKyBjZW50ZXIuejsKICAgICAgICBjb25zdCB4TWluID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIGZyb21Qb2ludHNYTWluKTsKICAgICAgICBjb25zdCB5TWluID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIGZyb21Qb2ludHNZTWluKTsKICAgICAgICBjb25zdCB6TWluID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIGZyb21Qb2ludHNaTWluKTsKICAgICAgICBjb25zdCB4TWF4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIGZyb21Qb2ludHNYTWF4KTsKICAgICAgICBjb25zdCB5TWF4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIGZyb21Qb2ludHNZTWF4KTsKICAgICAgICBjb25zdCB6TWF4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIGZyb21Qb2ludHNaTWF4KTsKICAgICAgICBjb25zdCBudW1FbGVtZW50cyA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bUVsZW1lbnRzOyBpICs9IHN0cmlkZSkgewogICAgICAgICAgY29uc3QgeCA9IHBvc2l0aW9uc1tpXSArIGNlbnRlci54OwogICAgICAgICAgY29uc3QgeSA9IHBvc2l0aW9uc1tpICsgMV0gKyBjZW50ZXIueTsKICAgICAgICAgIGNvbnN0IHogPSBwb3NpdGlvbnNbaSArIDJdICsgY2VudGVyLno7CiAgICAgICAgICBjdXJyZW50UG9zLnggPSB4OwogICAgICAgICAgY3VycmVudFBvcy55ID0geTsKICAgICAgICAgIGN1cnJlbnRQb3MueiA9IHo7CiAgICAgICAgICBpZiAoeCA8IHhNaW4ueCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeE1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeCA+IHhNYXgueCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeE1heCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeSA8IHlNaW4ueSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeU1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeSA+IHlNYXgueSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeU1heCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeiA8IHpNaW4ueikgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgek1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeiA+IHpNYXgueikgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgek1heCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHhTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoeE1heCwgeE1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBjb25zdCB5U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHlNYXgsIHlNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgelNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh6TWF4LCB6TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCBkaWFtZXRlcjEgPSB4TWluOwogICAgICAgIGxldCBkaWFtZXRlcjIgPSB4TWF4OwogICAgICAgIGxldCBtYXhTcGFuID0geFNwYW47CiAgICAgICAgaWYgKHlTcGFuID4gbWF4U3BhbikgewogICAgICAgICAgbWF4U3BhbiA9IHlTcGFuOwogICAgICAgICAgZGlhbWV0ZXIxID0geU1pbjsKICAgICAgICAgIGRpYW1ldGVyMiA9IHlNYXg7CiAgICAgICAgfQogICAgICAgIGlmICh6U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB6U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHpNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB6TWF4OwogICAgICAgIH0KICAgICAgICBjb25zdCByaXR0ZXJDZW50ZXIgPSBmcm9tUG9pbnRzUml0dGVyQ2VudGVyOwogICAgICAgIHJpdHRlckNlbnRlci54ID0gKGRpYW1ldGVyMS54ICsgZGlhbWV0ZXIyLngpICogMC41OwogICAgICAgIHJpdHRlckNlbnRlci55ID0gKGRpYW1ldGVyMS55ICsgZGlhbWV0ZXIyLnkpICogMC41OwogICAgICAgIHJpdHRlckNlbnRlci56ID0gKGRpYW1ldGVyMS56ICsgZGlhbWV0ZXIyLnopICogMC41OwogICAgICAgIGxldCByYWRpdXNTcXVhcmVkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZGlhbWV0ZXIyLCByaXR0ZXJDZW50ZXIsIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgbGV0IHJpdHRlclJhZGl1cyA9IE1hdGguc3FydChyYWRpdXNTcXVhcmVkKTsKICAgICAgICBjb25zdCBtaW5Cb3hQdCA9IGZyb21Qb2ludHNNaW5Cb3hQdDsKICAgICAgICBtaW5Cb3hQdC54ID0geE1pbi54OwogICAgICAgIG1pbkJveFB0LnkgPSB5TWluLnk7CiAgICAgICAgbWluQm94UHQueiA9IHpNaW4uejsKICAgICAgICBjb25zdCBtYXhCb3hQdCA9IGZyb21Qb2ludHNNYXhCb3hQdDsKICAgICAgICBtYXhCb3hQdC54ID0geE1heC54OwogICAgICAgIG1heEJveFB0LnkgPSB5TWF4Lnk7CiAgICAgICAgbWF4Qm94UHQueiA9IHpNYXguejsKICAgICAgICBjb25zdCBuYWl2ZUNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludCgKICAgICAgICAgIG1pbkJveFB0LAogICAgICAgICAgbWF4Qm94UHQsCiAgICAgICAgICBmcm9tUG9pbnRzTmFpdmVDZW50ZXJTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBsZXQgbmFpdmVSYWRpdXMgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1FbGVtZW50czsgaSArPSBzdHJpZGUpIHsKICAgICAgICAgIGN1cnJlbnRQb3MueCA9IHBvc2l0aW9uc1tpXSArIGNlbnRlci54OwogICAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zW2kgKyAxXSArIGNlbnRlci55OwogICAgICAgICAgY3VycmVudFBvcy56ID0gcG9zaXRpb25zW2kgKyAyXSArIGNlbnRlci56OwogICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjdXJyZW50UG9zLCBuYWl2ZUNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHIgPiBuYWl2ZVJhZGl1cykgewogICAgICAgICAgICBuYWl2ZVJhZGl1cyA9IHI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPiByYWRpdXNTcXVhcmVkKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZENlbnRlclRvUG9pbnQgPSBNYXRoLnNxcnQob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQpOwogICAgICAgICAgICByaXR0ZXJSYWRpdXMgPSAocml0dGVyUmFkaXVzICsgb2xkQ2VudGVyVG9Qb2ludCkgKiAwLjU7CiAgICAgICAgICAgIHJhZGl1c1NxdWFyZWQgPSByaXR0ZXJSYWRpdXMgKiByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIGNvbnN0IG9sZFRvTmV3ID0gb2xkQ2VudGVyVG9Qb2ludCAtIHJpdHRlclJhZGl1czsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnggPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnggKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueCkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueSArIG9sZFRvTmV3ICogY3VycmVudFBvcy55KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci56ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci56ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLnopIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJpdHRlclJhZGl1cyA8IG5haXZlUmFkaXVzKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocml0dGVyQ2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByaXR0ZXJSYWRpdXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShuYWl2ZUNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gbmFpdmVSYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21FbmNvZGVkQ2FydGVzaWFuVmVydGljZXMgPSBmdW5jdGlvbihwb3NpdGlvbnNIaWdoLCBwb3NpdGlvbnNMb3csIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnNIaWdoKSB8fCAhZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9uc0xvdykgfHwgcG9zaXRpb25zSGlnaC5sZW5ndGggIT09IHBvc2l0aW9uc0xvdy5sZW5ndGggfHwgcG9zaXRpb25zSGlnaC5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBjdXJyZW50UG9zID0gZnJvbVBvaW50c0N1cnJlbnRQb3M7CiAgICAgICAgY3VycmVudFBvcy54ID0gcG9zaXRpb25zSGlnaFswXSArIHBvc2l0aW9uc0xvd1swXTsKICAgICAgICBjdXJyZW50UG9zLnkgPSBwb3NpdGlvbnNIaWdoWzFdICsgcG9zaXRpb25zTG93WzFdOwogICAgICAgIGN1cnJlbnRQb3MueiA9IHBvc2l0aW9uc0hpZ2hbMl0gKyBwb3NpdGlvbnNMb3dbMl07CiAgICAgICAgY29uc3QgeE1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1pbik7CiAgICAgICAgY29uc3QgeU1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1pbik7CiAgICAgICAgY29uc3Qgek1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1pbik7CiAgICAgICAgY29uc3QgeE1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1heCk7CiAgICAgICAgY29uc3QgeU1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1heCk7CiAgICAgICAgY29uc3Qgek1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1heCk7CiAgICAgICAgY29uc3QgbnVtRWxlbWVudHMgPSBwb3NpdGlvbnNIaWdoLmxlbmd0aDsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtRWxlbWVudHM7IGkgKz0gMykgewogICAgICAgICAgY29uc3QgeCA9IHBvc2l0aW9uc0hpZ2hbaV0gKyBwb3NpdGlvbnNMb3dbaV07CiAgICAgICAgICBjb25zdCB5ID0gcG9zaXRpb25zSGlnaFtpICsgMV0gKyBwb3NpdGlvbnNMb3dbaSArIDFdOwogICAgICAgICAgY29uc3QgeiA9IHBvc2l0aW9uc0hpZ2hbaSArIDJdICsgcG9zaXRpb25zTG93W2kgKyAyXTsKICAgICAgICAgIGN1cnJlbnRQb3MueCA9IHg7CiAgICAgICAgICBjdXJyZW50UG9zLnkgPSB5OwogICAgICAgICAgY3VycmVudFBvcy56ID0gejsKICAgICAgICAgIGlmICh4IDwgeE1pbi54KSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCB4TWluKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh4ID4geE1heC54KSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCB4TWF4KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh5IDwgeU1pbi55KSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCB5TWluKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh5ID4geU1heC55KSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCB5TWF4KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh6IDwgek1pbi56KSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCB6TWluKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh6ID4gek1heC56KSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCB6TWF4KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgeFNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh4TWF4LCB4TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHlTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoeU1heCwgeU1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBjb25zdCB6U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHpNYXgsIHpNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgbGV0IGRpYW1ldGVyMSA9IHhNaW47CiAgICAgICAgbGV0IGRpYW1ldGVyMiA9IHhNYXg7CiAgICAgICAgbGV0IG1heFNwYW4gPSB4U3BhbjsKICAgICAgICBpZiAoeVNwYW4gPiBtYXhTcGFuKSB7CiAgICAgICAgICBtYXhTcGFuID0geVNwYW47CiAgICAgICAgICBkaWFtZXRlcjEgPSB5TWluOwogICAgICAgICAgZGlhbWV0ZXIyID0geU1heDsKICAgICAgICB9CiAgICAgICAgaWYgKHpTcGFuID4gbWF4U3BhbikgewogICAgICAgICAgbWF4U3BhbiA9IHpTcGFuOwogICAgICAgICAgZGlhbWV0ZXIxID0gek1pbjsKICAgICAgICAgIGRpYW1ldGVyMiA9IHpNYXg7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJpdHRlckNlbnRlciA9IGZyb21Qb2ludHNSaXR0ZXJDZW50ZXI7CiAgICAgICAgcml0dGVyQ2VudGVyLnggPSAoZGlhbWV0ZXIxLnggKyBkaWFtZXRlcjIueCkgKiAwLjU7CiAgICAgICAgcml0dGVyQ2VudGVyLnkgPSAoZGlhbWV0ZXIxLnkgKyBkaWFtZXRlcjIueSkgKiAwLjU7CiAgICAgICAgcml0dGVyQ2VudGVyLnogPSAoZGlhbWV0ZXIxLnogKyBkaWFtZXRlcjIueikgKiAwLjU7CiAgICAgICAgbGV0IHJhZGl1c1NxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChkaWFtZXRlcjIsIHJpdHRlckNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBsZXQgcml0dGVyUmFkaXVzID0gTWF0aC5zcXJ0KHJhZGl1c1NxdWFyZWQpOwogICAgICAgIGNvbnN0IG1pbkJveFB0ID0gZnJvbVBvaW50c01pbkJveFB0OwogICAgICAgIG1pbkJveFB0LnggPSB4TWluLng7CiAgICAgICAgbWluQm94UHQueSA9IHlNaW4ueTsKICAgICAgICBtaW5Cb3hQdC56ID0gek1pbi56OwogICAgICAgIGNvbnN0IG1heEJveFB0ID0gZnJvbVBvaW50c01heEJveFB0OwogICAgICAgIG1heEJveFB0LnggPSB4TWF4Lng7CiAgICAgICAgbWF4Qm94UHQueSA9IHlNYXgueTsKICAgICAgICBtYXhCb3hQdC56ID0gek1heC56OwogICAgICAgIGNvbnN0IG5haXZlQ2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KAogICAgICAgICAgbWluQm94UHQsCiAgICAgICAgICBtYXhCb3hQdCwKICAgICAgICAgIGZyb21Qb2ludHNOYWl2ZUNlbnRlclNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGxldCBuYWl2ZVJhZGl1cyA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bUVsZW1lbnRzOyBpICs9IDMpIHsKICAgICAgICAgIGN1cnJlbnRQb3MueCA9IHBvc2l0aW9uc0hpZ2hbaV0gKyBwb3NpdGlvbnNMb3dbaV07CiAgICAgICAgICBjdXJyZW50UG9zLnkgPSBwb3NpdGlvbnNIaWdoW2kgKyAxXSArIHBvc2l0aW9uc0xvd1tpICsgMV07CiAgICAgICAgICBjdXJyZW50UG9zLnogPSBwb3NpdGlvbnNIaWdoW2kgKyAyXSArIHBvc2l0aW9uc0xvd1tpICsgMl07CiAgICAgICAgICBjb25zdCByID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGN1cnJlbnRQb3MsIG5haXZlQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBpZiAociA+IG5haXZlUmFkaXVzKSB7CiAgICAgICAgICAgIG5haXZlUmFkaXVzID0gcjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IG9sZENlbnRlclRvUG9pbnRTcXVhcmVkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjdXJyZW50UG9zLCByaXR0ZXJDZW50ZXIsIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCA+IHJhZGl1c1NxdWFyZWQpIHsKICAgICAgICAgICAgY29uc3Qgb2xkQ2VudGVyVG9Qb2ludCA9IE1hdGguc3FydChvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCk7CiAgICAgICAgICAgIHJpdHRlclJhZGl1cyA9IChyaXR0ZXJSYWRpdXMgKyBvbGRDZW50ZXJUb1BvaW50KSAqIDAuNTsKICAgICAgICAgICAgcmFkaXVzU3F1YXJlZCA9IHJpdHRlclJhZGl1cyAqIHJpdHRlclJhZGl1czsKICAgICAgICAgICAgY29uc3Qgb2xkVG9OZXcgPSBvbGRDZW50ZXJUb1BvaW50IC0gcml0dGVyUmFkaXVzOwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueCA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueCArIG9sZFRvTmV3ICogY3VycmVudFBvcy54KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci55ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci55ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLnkpIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnogPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnogKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueikgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocml0dGVyUmFkaXVzIDwgbmFpdmVSYWRpdXMpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyaXR0ZXJDZW50ZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IHJpdHRlclJhZGl1czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG5haXZlQ2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSBuYWl2ZVJhZGl1czsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbUNvcm5lclBvaW50cyA9IGZ1bmN0aW9uKGNvcm5lciwgb3Bwb3NpdGVDb3JuZXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29ybmVyIiwgY29ybmVyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wcG9zaXRlQ29ybmVyIiwgb3Bwb3NpdGVDb3JuZXIpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoY29ybmVyLCBvcHBvc2l0ZUNvcm5lciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShjZW50ZXIsIG9wcG9zaXRlQ29ybmVyKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tRWxsaXBzb2lkID0gZnVuY3Rpb24oZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVsbGlwc29pZCIsIGVsbGlwc29pZCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGZyb21Cb3VuZGluZ1NwaGVyZXNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tQm91bmRpbmdTcGhlcmVzID0gZnVuY3Rpb24oYm91bmRpbmdTcGhlcmVzLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm91bmRpbmdTcGhlcmVzKSB8fCBib3VuZGluZ1NwaGVyZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYm91bmRpbmdTcGhlcmVzLmxlbmd0aDsKICAgICAgICBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gQm91bmRpbmdTcGhlcmUuY2xvbmUoYm91bmRpbmdTcGhlcmVzWzBdLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICBpZiAobGVuZ3RoID09PSAyKSB7CiAgICAgICAgICByZXR1cm4gQm91bmRpbmdTcGhlcmUudW5pb24oYm91bmRpbmdTcGhlcmVzWzBdLCBib3VuZGluZ1NwaGVyZXNbMV0sIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IFtdOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgcG9zaXRpb25zLnB1c2goYm91bmRpbmdTcGhlcmVzW2ldLmNlbnRlcik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9IEJvdW5kaW5nU3BoZXJlLmZyb21Qb2ludHMocG9zaXRpb25zLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGNlbnRlciA9IHJlc3VsdC5jZW50ZXI7CiAgICAgICAgbGV0IHJhZGl1cyA9IHJlc3VsdC5yYWRpdXM7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCB0bXAyID0gYm91bmRpbmdTcGhlcmVzW2ldOwogICAgICAgICAgcmFkaXVzID0gTWF0aC5tYXgoCiAgICAgICAgICAgIHJhZGl1cywKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKGNlbnRlciwgdG1wMi5jZW50ZXIsIGZyb21Cb3VuZGluZ1NwaGVyZXNTY3JhdGNoKSArIHRtcDIucmFkaXVzCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmFkaXVzID0gcmFkaXVzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21PcmllbnRlZEJvdW5kaW5nQm94ID0gZnVuY3Rpb24ob3JpZW50ZWRCb3VuZGluZ0JveCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcmllbnRlZEJvdW5kaW5nQm94Iiwgb3JpZW50ZWRCb3VuZGluZ0JveCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gb3JpZW50ZWRCb3VuZGluZ0JveC5oYWxmQXhlczsKICAgICAgICBjb25zdCB1MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFUpOwogICAgICAgIGNvbnN0IHYzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMSwgZnJvbU9yaWVudGVkQm91bmRpbmdCb3hTY3JhdGNoVik7CiAgICAgICAgY29uc3QgdyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFcpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodTMsIHYzLCB1Myk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZCh1MywgdywgdTMpOwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUob3JpZW50ZWRCb3VuZGluZ0JveC5jZW50ZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHUzKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoRnJvbVRyYW5zZm9ybWF0aW9uQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRnJvbVRyYW5zZm9ybWF0aW9uU2NhbGUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21UcmFuc2Zvcm1hdGlvbiA9IGZ1bmN0aW9uKHRyYW5zZm9ybWF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zZm9ybWF0aW9uIiwgdHJhbnNmb3JtYXRpb24pOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjZW50ZXIgPSBNYXRyaXg0X2RlZmF1bHQuZ2V0VHJhbnNsYXRpb24oCiAgICAgICAgICB0cmFuc2Zvcm1hdGlvbiwKICAgICAgICAgIHNjcmF0Y2hGcm9tVHJhbnNmb3JtYXRpb25DZW50ZXIKICAgICAgICApOwogICAgICAgIGNvbnN0IHNjYWxlID0gTWF0cml4NF9kZWZhdWx0LmdldFNjYWxlKAogICAgICAgICAgdHJhbnNmb3JtYXRpb24sCiAgICAgICAgICBzY3JhdGNoRnJvbVRyYW5zZm9ybWF0aW9uU2NhbGUKICAgICAgICApOwogICAgICAgIGNvbnN0IHJhZGl1cyA9IDAuNSAqIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoc2NhbGUpOwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gcmFkaXVzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmNsb25lID0gZnVuY3Rpb24oc3BoZXJlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzcGhlcmUpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEJvdW5kaW5nU3BoZXJlKHNwaGVyZS5jZW50ZXIsIHNwaGVyZS5yYWRpdXMpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHNwaGVyZS5jZW50ZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBzcGhlcmUucmFkaXVzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnBhY2tlZExlbmd0aCA9IDQ7CiAgICAgIEJvdW5kaW5nU3BoZXJlLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGNlbnRlciA9IHZhbHVlLmNlbnRlcjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gY2VudGVyLng7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGNlbnRlci55OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBjZW50ZXIuejsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnJhZGl1czsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gcmVzdWx0LmNlbnRlcjsKICAgICAgICBjZW50ZXIueCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY2VudGVyLnkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNlbnRlci56ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQucmFkaXVzID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgdW5pb25TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1bmlvblNjcmF0Y2hDZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLnVuaW9uID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlZnRDZW50ZXIgPSBsZWZ0LmNlbnRlcjsKICAgICAgICBjb25zdCBsZWZ0UmFkaXVzID0gbGVmdC5yYWRpdXM7CiAgICAgICAgY29uc3QgcmlnaHRDZW50ZXIgPSByaWdodC5jZW50ZXI7CiAgICAgICAgY29uc3QgcmlnaHRSYWRpdXMgPSByaWdodC5yYWRpdXM7CiAgICAgICAgY29uc3QgdG9SaWdodENlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIHJpZ2h0Q2VudGVyLAogICAgICAgICAgbGVmdENlbnRlciwKICAgICAgICAgIHVuaW9uU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgY2VudGVyU2VwYXJhdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUodG9SaWdodENlbnRlcik7CiAgICAgICAgaWYgKGxlZnRSYWRpdXMgPj0gY2VudGVyU2VwYXJhdGlvbiArIHJpZ2h0UmFkaXVzKSB7CiAgICAgICAgICBsZWZ0LmNsb25lKHJlc3VsdCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBpZiAocmlnaHRSYWRpdXMgPj0gY2VudGVyU2VwYXJhdGlvbiArIGxlZnRSYWRpdXMpIHsKICAgICAgICAgIHJpZ2h0LmNsb25lKHJlc3VsdCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBoYWxmRGlzdGFuY2VCZXR3ZWVuVGFuZ2VudFBvaW50cyA9IChsZWZ0UmFkaXVzICsgY2VudGVyU2VwYXJhdGlvbiArIHJpZ2h0UmFkaXVzKSAqIDAuNTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIHRvUmlnaHRDZW50ZXIsCiAgICAgICAgICAoLWxlZnRSYWRpdXMgKyBoYWxmRGlzdGFuY2VCZXR3ZWVuVGFuZ2VudFBvaW50cykgLyBjZW50ZXJTZXBhcmF0aW9uLAogICAgICAgICAgdW5pb25TY3JhdGNoQ2VudGVyCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgbGVmdENlbnRlciwgY2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gaGFsZkRpc3RhbmNlQmV0d2VlblRhbmdlbnRQb2ludHM7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZXhwYW5kU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUuZXhwYW5kID0gZnVuY3Rpb24oc3BoZXJlLCBwb2ludCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9pbnQiLCBwb2ludCk7CiAgICAgICAgcmVzdWx0ID0gQm91bmRpbmdTcGhlcmUuY2xvbmUoc3BoZXJlLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHJhZGl1cyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9pbnQsIHJlc3VsdC5jZW50ZXIsIGV4cGFuZFNjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBpZiAocmFkaXVzID4gcmVzdWx0LnJhZGl1cykgewogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IHJhZGl1czsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUuaW50ZXJzZWN0UGxhbmUgPSBmdW5jdGlvbihzcGhlcmUsIHBsYW5lKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicGxhbmUiLCBwbGFuZSk7CiAgICAgICAgY29uc3QgY2VudGVyID0gc3BoZXJlLmNlbnRlcjsKICAgICAgICBjb25zdCByYWRpdXMgPSBzcGhlcmUucmFkaXVzOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgZGlzdGFuY2VUb1BsYW5lID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBjZW50ZXIpICsgcGxhbmUuZGlzdGFuY2U7CiAgICAgICAgaWYgKGRpc3RhbmNlVG9QbGFuZSA8IC1yYWRpdXMpIHsKICAgICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5PVVRTSURFOwogICAgICAgIH0gZWxzZSBpZiAoZGlzdGFuY2VUb1BsYW5lIDwgcmFkaXVzKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HOwogICAgICAgIH0KICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuSU5TSURFOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS50cmFuc2Zvcm0gPSBmdW5jdGlvbihzcGhlcmUsIHRyYW5zZm9ybTIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zZm9ybSIsIHRyYW5zZm9ybTIpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuY2VudGVyID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCgKICAgICAgICAgIHRyYW5zZm9ybTIsCiAgICAgICAgICBzcGhlcmUuY2VudGVyLAogICAgICAgICAgcmVzdWx0LmNlbnRlcgogICAgICAgICk7CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IE1hdHJpeDRfZGVmYXVsdC5nZXRNYXhpbXVtU2NhbGUodHJhbnNmb3JtMikgKiBzcGhlcmUucmFkaXVzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGRpc3RhbmNlU3F1YXJlZFRvU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUuZGlzdGFuY2VTcXVhcmVkVG8gPSBmdW5jdGlvbihzcGhlcmUsIGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIGNvbnN0IGRpZmYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBzcGhlcmUuY2VudGVyLAogICAgICAgICAgY2FydGVzaWFuMTEsCiAgICAgICAgICBkaXN0YW5jZVNxdWFyZWRUb1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGRpc3RhbmNlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShkaWZmKSAtIHNwaGVyZS5yYWRpdXM7CiAgICAgICAgaWYgKGRpc3RhbmNlIDw9IDApIHsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGlzdGFuY2UgKiBkaXN0YW5jZTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUudHJhbnNmb3JtV2l0aG91dFNjYWxlID0gZnVuY3Rpb24oc3BoZXJlLCB0cmFuc2Zvcm0yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNwaGVyZSIsIHNwaGVyZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2Zvcm0iLCB0cmFuc2Zvcm0yKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICB0cmFuc2Zvcm0yLAogICAgICAgICAgc3BoZXJlLmNlbnRlciwKICAgICAgICAgIHJlc3VsdC5jZW50ZXIKICAgICAgICApOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBzcGhlcmUucmFkaXVzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS5jb21wdXRlUGxhbmVEaXN0YW5jZXMgPSBmdW5jdGlvbihzcGhlcmUsIHBvc2l0aW9uLCBkaXJlY3Rpb24yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNwaGVyZSIsIHNwaGVyZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwb3NpdGlvbiIsIHBvc2l0aW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpcmVjdGlvbiIsIGRpcmVjdGlvbjIpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBJbnRlcnZhbF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRvQ2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgc3BoZXJlLmNlbnRlciwKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjMKICAgICAgICApOwogICAgICAgIGNvbnN0IG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIHJlc3VsdC5zdGFydCA9IG1hZyAtIHNwaGVyZS5yYWRpdXM7CiAgICAgICAgcmVzdWx0LnN0b3AgPSBtYWcgKyBzcGhlcmUucmFkaXVzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHByb2plY3RUbzJETm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcHJvamVjdFRvMkRFYXN0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcHJvamVjdFRvMkROb3J0aFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJEV2VzdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJEU291dGhTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcm9qZWN0VG8yRENhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgcHJvamVjdFRvMkRQb3NpdGlvbnNTY3JhdGNoID0gbmV3IEFycmF5KDgpOwogICAgICBmb3IgKGxldCBuID0gMDsgbiA8IDg7ICsrbikgewogICAgICAgIHByb2plY3RUbzJEUG9zaXRpb25zU2NyYXRjaFtuXSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgfQogICAgICBwcm9qZWN0VG8yRFByb2plY3Rpb24gPSBuZXcgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS5wcm9qZWN0VG8yRCA9IGZ1bmN0aW9uKHNwaGVyZSwgcHJvamVjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIHByb2plY3RUbzJEUHJvamVjdGlvbi5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdDsKICAgICAgICBwcm9qZWN0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocHJvamVjdGlvbiwgcHJvamVjdFRvMkRQcm9qZWN0aW9uKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLmVsbGlwc29pZDsKICAgICAgICBsZXQgY2VudGVyID0gc3BoZXJlLmNlbnRlcjsKICAgICAgICBjb25zdCByYWRpdXMgPSBzcGhlcmUucmFkaXVzOwogICAgICAgIGxldCBub3JtYWwyOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGNlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIHByb2plY3RUbzJETm9ybWFsU2NyYXRjaCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgcHJvamVjdFRvMkROb3JtYWxTY3JhdGNoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWFzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcHJvamVjdFRvMkRFYXN0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShlYXN0LCBlYXN0KTsKICAgICAgICBjb25zdCBub3J0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCBlYXN0LCBwcm9qZWN0VG8yRE5vcnRoU2NyYXRjaCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3J0aCwgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcm1hbDIsIHJhZGl1cywgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobm9ydGgsIHJhZGl1cywgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGVhc3QsIHJhZGl1cywgZWFzdCk7CiAgICAgICAgY29uc3Qgc291dGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcnRoLCBwcm9qZWN0VG8yRFNvdXRoU2NyYXRjaCk7CiAgICAgICAgY29uc3Qgd2VzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZWFzdCwgcHJvamVjdFRvMkRXZXN0U2NyYXRjaCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gcHJvamVjdFRvMkRQb3NpdGlvbnNTY3JhdGNoOwogICAgICAgIGxldCBjb3JuZXIgPSBwb3NpdGlvbnNbMF07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgZWFzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMV07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgd2VzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMl07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgd2VzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbM107CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgZWFzdCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s0XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIG5vcnRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBlYXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s1XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIG5vcnRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3ZXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s2XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIHNvdXRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3ZXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s3XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIHNvdXRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBlYXN0LCBjb3JuZXIpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgcG9zaXRpb24sIHBvc2l0aW9uKTsKICAgICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBwcm9qZWN0VG8yRENhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBwcm9qZWN0aW9uLnByb2plY3QoY2FydG9ncmFwaGljMiwgcG9zaXRpb24pOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBCb3VuZGluZ1NwaGVyZS5mcm9tUG9pbnRzKHBvc2l0aW9ucywgcmVzdWx0KTsKICAgICAgICBjZW50ZXIgPSByZXN1bHQuY2VudGVyOwogICAgICAgIGNvbnN0IHggPSBjZW50ZXIueDsKICAgICAgICBjb25zdCB5ID0gY2VudGVyLnk7CiAgICAgICAgY29uc3QgeiA9IGNlbnRlci56OwogICAgICAgIGNlbnRlci54ID0gejsKICAgICAgICBjZW50ZXIueSA9IHg7CiAgICAgICAgY2VudGVyLnogPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihzcGhlcmUsIG9jY2x1ZGVyKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib2NjbHVkZXIiLCBvY2NsdWRlcik7CiAgICAgICAgcmV0dXJuICFvY2NsdWRlci5pc0JvdW5kaW5nU3BoZXJlVmlzaWJsZShzcGhlcmUpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGxlZnQuY2VudGVyLCByaWdodC5jZW50ZXIpICYmIGxlZnQucmFkaXVzID09PSByaWdodC5yYWRpdXM7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnByb3RvdHlwZS5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKHBsYW5lKSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmludGVyc2VjdFBsYW5lKHRoaXMsIHBsYW5lKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmRpc3RhbmNlU3F1YXJlZFRvID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gQm91bmRpbmdTcGhlcmUuZGlzdGFuY2VTcXVhcmVkVG8odGhpcywgY2FydGVzaWFuMTEpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wcm90b3R5cGUuY29tcHV0ZVBsYW5lRGlzdGFuY2VzID0gZnVuY3Rpb24ocG9zaXRpb24sIGRpcmVjdGlvbjIsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5jb21wdXRlUGxhbmVEaXN0YW5jZXMoCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBkaXJlY3Rpb24yLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihvY2NsdWRlcikgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5pc09jY2x1ZGVkKHRoaXMsIG9jY2x1ZGVyKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wcm90b3R5cGUudm9sdW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgcmFkaXVzID0gdGhpcy5yYWRpdXM7CiAgICAgICAgcmV0dXJuIHZvbHVtZUNvbnN0YW50ICogcmFkaXVzICogcmFkaXVzICogcmFkaXVzOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0ID0gQm91bmRpbmdTcGhlcmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XZWJHTENvbnN0YW50cy5qcwogIHZhciBXZWJHTENvbnN0YW50cywgV2ViR0xDb25zdGFudHNfZGVmYXVsdDsKICB2YXIgaW5pdF9XZWJHTENvbnN0YW50cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2ViR0xDb25zdGFudHMuanMiKCkgewogICAgICBXZWJHTENvbnN0YW50cyA9IHsKICAgICAgICBERVBUSF9CVUZGRVJfQklUOiAyNTYsCiAgICAgICAgU1RFTkNJTF9CVUZGRVJfQklUOiAxMDI0LAogICAgICAgIENPTE9SX0JVRkZFUl9CSVQ6IDE2Mzg0LAogICAgICAgIFBPSU5UUzogMCwKICAgICAgICBMSU5FUzogMSwKICAgICAgICBMSU5FX0xPT1A6IDIsCiAgICAgICAgTElORV9TVFJJUDogMywKICAgICAgICBUUklBTkdMRVM6IDQsCiAgICAgICAgVFJJQU5HTEVfU1RSSVA6IDUsCiAgICAgICAgVFJJQU5HTEVfRkFOOiA2LAogICAgICAgIFpFUk86IDAsCiAgICAgICAgT05FOiAxLAogICAgICAgIFNSQ19DT0xPUjogNzY4LAogICAgICAgIE9ORV9NSU5VU19TUkNfQ09MT1I6IDc2OSwKICAgICAgICBTUkNfQUxQSEE6IDc3MCwKICAgICAgICBPTkVfTUlOVVNfU1JDX0FMUEhBOiA3NzEsCiAgICAgICAgRFNUX0FMUEhBOiA3NzIsCiAgICAgICAgT05FX01JTlVTX0RTVF9BTFBIQTogNzczLAogICAgICAgIERTVF9DT0xPUjogNzc0LAogICAgICAgIE9ORV9NSU5VU19EU1RfQ09MT1I6IDc3NSwKICAgICAgICBTUkNfQUxQSEFfU0FUVVJBVEU6IDc3NiwKICAgICAgICBGVU5DX0FERDogMzI3NzQsCiAgICAgICAgQkxFTkRfRVFVQVRJT046IDMyNzc3LAogICAgICAgIEJMRU5EX0VRVUFUSU9OX1JHQjogMzI3NzcsCiAgICAgICAgLy8gc2FtZSBhcyBCTEVORF9FUVVBVElPTgogICAgICAgIEJMRU5EX0VRVUFUSU9OX0FMUEhBOiAzNDg3NywKICAgICAgICBGVU5DX1NVQlRSQUNUOiAzMjc3OCwKICAgICAgICBGVU5DX1JFVkVSU0VfU1VCVFJBQ1Q6IDMyNzc5LAogICAgICAgIEJMRU5EX0RTVF9SR0I6IDMyOTY4LAogICAgICAgIEJMRU5EX1NSQ19SR0I6IDMyOTY5LAogICAgICAgIEJMRU5EX0RTVF9BTFBIQTogMzI5NzAsCiAgICAgICAgQkxFTkRfU1JDX0FMUEhBOiAzMjk3MSwKICAgICAgICBDT05TVEFOVF9DT0xPUjogMzI3NjksCiAgICAgICAgT05FX01JTlVTX0NPTlNUQU5UX0NPTE9SOiAzMjc3MCwKICAgICAgICBDT05TVEFOVF9BTFBIQTogMzI3NzEsCiAgICAgICAgT05FX01JTlVTX0NPTlNUQU5UX0FMUEhBOiAzMjc3MiwKICAgICAgICBCTEVORF9DT0xPUjogMzI3NzMsCiAgICAgICAgQVJSQVlfQlVGRkVSOiAzNDk2MiwKICAgICAgICBFTEVNRU5UX0FSUkFZX0JVRkZFUjogMzQ5NjMsCiAgICAgICAgQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTY0LAogICAgICAgIEVMRU1FTlRfQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTY1LAogICAgICAgIFNUUkVBTV9EUkFXOiAzNTA0MCwKICAgICAgICBTVEFUSUNfRFJBVzogMzUwNDQsCiAgICAgICAgRFlOQU1JQ19EUkFXOiAzNTA0OCwKICAgICAgICBCVUZGRVJfU0laRTogMzQ2NjAsCiAgICAgICAgQlVGRkVSX1VTQUdFOiAzNDY2MSwKICAgICAgICBDVVJSRU5UX1ZFUlRFWF9BVFRSSUI6IDM0MzQyLAogICAgICAgIEZST05UOiAxMDI4LAogICAgICAgIEJBQ0s6IDEwMjksCiAgICAgICAgRlJPTlRfQU5EX0JBQ0s6IDEwMzIsCiAgICAgICAgQ1VMTF9GQUNFOiAyODg0LAogICAgICAgIEJMRU5EOiAzMDQyLAogICAgICAgIERJVEhFUjogMzAyNCwKICAgICAgICBTVEVOQ0lMX1RFU1Q6IDI5NjAsCiAgICAgICAgREVQVEhfVEVTVDogMjkyOSwKICAgICAgICBTQ0lTU09SX1RFU1Q6IDMwODksCiAgICAgICAgUE9MWUdPTl9PRkZTRVRfRklMTDogMzI4MjMsCiAgICAgICAgU0FNUExFX0FMUEhBX1RPX0NPVkVSQUdFOiAzMjkyNiwKICAgICAgICBTQU1QTEVfQ09WRVJBR0U6IDMyOTI4LAogICAgICAgIE5PX0VSUk9SOiAwLAogICAgICAgIElOVkFMSURfRU5VTTogMTI4MCwKICAgICAgICBJTlZBTElEX1ZBTFVFOiAxMjgxLAogICAgICAgIElOVkFMSURfT1BFUkFUSU9OOiAxMjgyLAogICAgICAgIE9VVF9PRl9NRU1PUlk6IDEyODUsCiAgICAgICAgQ1c6IDIzMDQsCiAgICAgICAgQ0NXOiAyMzA1LAogICAgICAgIExJTkVfV0lEVEg6IDI4NDksCiAgICAgICAgQUxJQVNFRF9QT0lOVF9TSVpFX1JBTkdFOiAzMzkwMSwKICAgICAgICBBTElBU0VEX0xJTkVfV0lEVEhfUkFOR0U6IDMzOTAyLAogICAgICAgIENVTExfRkFDRV9NT0RFOiAyODg1LAogICAgICAgIEZST05UX0ZBQ0U6IDI4ODYsCiAgICAgICAgREVQVEhfUkFOR0U6IDI5MjgsCiAgICAgICAgREVQVEhfV1JJVEVNQVNLOiAyOTMwLAogICAgICAgIERFUFRIX0NMRUFSX1ZBTFVFOiAyOTMxLAogICAgICAgIERFUFRIX0ZVTkM6IDI5MzIsCiAgICAgICAgU1RFTkNJTF9DTEVBUl9WQUxVRTogMjk2MSwKICAgICAgICBTVEVOQ0lMX0ZVTkM6IDI5NjIsCiAgICAgICAgU1RFTkNJTF9GQUlMOiAyOTY0LAogICAgICAgIFNURU5DSUxfUEFTU19ERVBUSF9GQUlMOiAyOTY1LAogICAgICAgIFNURU5DSUxfUEFTU19ERVBUSF9QQVNTOiAyOTY2LAogICAgICAgIFNURU5DSUxfUkVGOiAyOTY3LAogICAgICAgIFNURU5DSUxfVkFMVUVfTUFTSzogMjk2MywKICAgICAgICBTVEVOQ0lMX1dSSVRFTUFTSzogMjk2OCwKICAgICAgICBTVEVOQ0lMX0JBQ0tfRlVOQzogMzQ4MTYsCiAgICAgICAgU1RFTkNJTF9CQUNLX0ZBSUw6IDM0ODE3LAogICAgICAgIFNURU5DSUxfQkFDS19QQVNTX0RFUFRIX0ZBSUw6IDM0ODE4LAogICAgICAgIFNURU5DSUxfQkFDS19QQVNTX0RFUFRIX1BBU1M6IDM0ODE5LAogICAgICAgIFNURU5DSUxfQkFDS19SRUY6IDM2MDAzLAogICAgICAgIFNURU5DSUxfQkFDS19WQUxVRV9NQVNLOiAzNjAwNCwKICAgICAgICBTVEVOQ0lMX0JBQ0tfV1JJVEVNQVNLOiAzNjAwNSwKICAgICAgICBWSUVXUE9SVDogMjk3OCwKICAgICAgICBTQ0lTU09SX0JPWDogMzA4OCwKICAgICAgICBDT0xPUl9DTEVBUl9WQUxVRTogMzEwNiwKICAgICAgICBDT0xPUl9XUklURU1BU0s6IDMxMDcsCiAgICAgICAgVU5QQUNLX0FMSUdOTUVOVDogMzMxNywKICAgICAgICBQQUNLX0FMSUdOTUVOVDogMzMzMywKICAgICAgICBNQVhfVEVYVFVSRV9TSVpFOiAzMzc5LAogICAgICAgIE1BWF9WSUVXUE9SVF9ESU1TOiAzMzg2LAogICAgICAgIFNVQlBJWEVMX0JJVFM6IDM0MDgsCiAgICAgICAgUkVEX0JJVFM6IDM0MTAsCiAgICAgICAgR1JFRU5fQklUUzogMzQxMSwKICAgICAgICBCTFVFX0JJVFM6IDM0MTIsCiAgICAgICAgQUxQSEFfQklUUzogMzQxMywKICAgICAgICBERVBUSF9CSVRTOiAzNDE0LAogICAgICAgIFNURU5DSUxfQklUUzogMzQxNSwKICAgICAgICBQT0xZR09OX09GRlNFVF9VTklUUzogMTA3NTIsCiAgICAgICAgUE9MWUdPTl9PRkZTRVRfRkFDVE9SOiAzMjgyNCwKICAgICAgICBURVhUVVJFX0JJTkRJTkdfMkQ6IDMyODczLAogICAgICAgIFNBTVBMRV9CVUZGRVJTOiAzMjkzNiwKICAgICAgICBTQU1QTEVTOiAzMjkzNywKICAgICAgICBTQU1QTEVfQ09WRVJBR0VfVkFMVUU6IDMyOTM4LAogICAgICAgIFNBTVBMRV9DT1ZFUkFHRV9JTlZFUlQ6IDMyOTM5LAogICAgICAgIENPTVBSRVNTRURfVEVYVFVSRV9GT1JNQVRTOiAzNDQ2NywKICAgICAgICBET05UX0NBUkU6IDQzNTIsCiAgICAgICAgRkFTVEVTVDogNDM1MywKICAgICAgICBOSUNFU1Q6IDQzNTQsCiAgICAgICAgR0VORVJBVEVfTUlQTUFQX0hJTlQ6IDMzMTcwLAogICAgICAgIEJZVEU6IDUxMjAsCiAgICAgICAgVU5TSUdORURfQllURTogNTEyMSwKICAgICAgICBTSE9SVDogNTEyMiwKICAgICAgICBVTlNJR05FRF9TSE9SVDogNTEyMywKICAgICAgICBJTlQ6IDUxMjQsCiAgICAgICAgVU5TSUdORURfSU5UOiA1MTI1LAogICAgICAgIEZMT0FUOiA1MTI2LAogICAgICAgIERFUFRIX0NPTVBPTkVOVDogNjQwMiwKICAgICAgICBBTFBIQTogNjQwNiwKICAgICAgICBSR0I6IDY0MDcsCiAgICAgICAgUkdCQTogNjQwOCwKICAgICAgICBMVU1JTkFOQ0U6IDY0MDksCiAgICAgICAgTFVNSU5BTkNFX0FMUEhBOiA2NDEwLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzRfNF80XzQ6IDMyODE5LAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNV81XzE6IDMyODIwLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNl81OiAzMzYzNSwKICAgICAgICBGUkFHTUVOVF9TSEFERVI6IDM1NjMyLAogICAgICAgIFZFUlRFWF9TSEFERVI6IDM1NjMzLAogICAgICAgIE1BWF9WRVJURVhfQVRUUklCUzogMzQ5MjEsCiAgICAgICAgTUFYX1ZFUlRFWF9VTklGT1JNX1ZFQ1RPUlM6IDM2MzQ3LAogICAgICAgIE1BWF9WQVJZSU5HX1ZFQ1RPUlM6IDM2MzQ4LAogICAgICAgIE1BWF9DT01CSU5FRF9URVhUVVJFX0lNQUdFX1VOSVRTOiAzNTY2MSwKICAgICAgICBNQVhfVkVSVEVYX1RFWFRVUkVfSU1BR0VfVU5JVFM6IDM1NjYwLAogICAgICAgIE1BWF9URVhUVVJFX0lNQUdFX1VOSVRTOiAzNDkzMCwKICAgICAgICBNQVhfRlJBR01FTlRfVU5JRk9STV9WRUNUT1JTOiAzNjM0OSwKICAgICAgICBTSEFERVJfVFlQRTogMzU2NjMsCiAgICAgICAgREVMRVRFX1NUQVRVUzogMzU3MTIsCiAgICAgICAgTElOS19TVEFUVVM6IDM1NzE0LAogICAgICAgIFZBTElEQVRFX1NUQVRVUzogMzU3MTUsCiAgICAgICAgQVRUQUNIRURfU0hBREVSUzogMzU3MTcsCiAgICAgICAgQUNUSVZFX1VOSUZPUk1TOiAzNTcxOCwKICAgICAgICBBQ1RJVkVfQVRUUklCVVRFUzogMzU3MjEsCiAgICAgICAgU0hBRElOR19MQU5HVUFHRV9WRVJTSU9OOiAzNTcyNCwKICAgICAgICBDVVJSRU5UX1BST0dSQU06IDM1NzI1LAogICAgICAgIE5FVkVSOiA1MTIsCiAgICAgICAgTEVTUzogNTEzLAogICAgICAgIEVRVUFMOiA1MTQsCiAgICAgICAgTEVRVUFMOiA1MTUsCiAgICAgICAgR1JFQVRFUjogNTE2LAogICAgICAgIE5PVEVRVUFMOiA1MTcsCiAgICAgICAgR0VRVUFMOiA1MTgsCiAgICAgICAgQUxXQVlTOiA1MTksCiAgICAgICAgS0VFUDogNzY4MCwKICAgICAgICBSRVBMQUNFOiA3NjgxLAogICAgICAgIElOQ1I6IDc2ODIsCiAgICAgICAgREVDUjogNzY4MywKICAgICAgICBJTlZFUlQ6IDUzODYsCiAgICAgICAgSU5DUl9XUkFQOiAzNDA1NSwKICAgICAgICBERUNSX1dSQVA6IDM0MDU2LAogICAgICAgIFZFTkRPUjogNzkzNiwKICAgICAgICBSRU5ERVJFUjogNzkzNywKICAgICAgICBWRVJTSU9OOiA3OTM4LAogICAgICAgIE5FQVJFU1Q6IDk3MjgsCiAgICAgICAgTElORUFSOiA5NzI5LAogICAgICAgIE5FQVJFU1RfTUlQTUFQX05FQVJFU1Q6IDk5ODQsCiAgICAgICAgTElORUFSX01JUE1BUF9ORUFSRVNUOiA5OTg1LAogICAgICAgIE5FQVJFU1RfTUlQTUFQX0xJTkVBUjogOTk4NiwKICAgICAgICBMSU5FQVJfTUlQTUFQX0xJTkVBUjogOTk4NywKICAgICAgICBURVhUVVJFX01BR19GSUxURVI6IDEwMjQwLAogICAgICAgIFRFWFRVUkVfTUlOX0ZJTFRFUjogMTAyNDEsCiAgICAgICAgVEVYVFVSRV9XUkFQX1M6IDEwMjQyLAogICAgICAgIFRFWFRVUkVfV1JBUF9UOiAxMDI0MywKICAgICAgICBURVhUVVJFXzJEOiAzNTUzLAogICAgICAgIFRFWFRVUkU6IDU4OTAsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUDogMzQwNjcsCiAgICAgICAgVEVYVFVSRV9CSU5ESU5HX0NVQkVfTUFQOiAzNDA2OCwKICAgICAgICBURVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1g6IDM0MDY5LAogICAgICAgIFRFWFRVUkVfQ1VCRV9NQVBfTkVHQVRJVkVfWDogMzQwNzAsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9ZOiAzNDA3MSwKICAgICAgICBURVhUVVJFX0NVQkVfTUFQX05FR0FUSVZFX1k6IDM0MDcyLAogICAgICAgIFRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWjogMzQwNzMsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUF9ORUdBVElWRV9aOiAzNDA3NCwKICAgICAgICBNQVhfQ1VCRV9NQVBfVEVYVFVSRV9TSVpFOiAzNDA3NiwKICAgICAgICBURVhUVVJFMDogMzM5ODQsCiAgICAgICAgVEVYVFVSRTE6IDMzOTg1LAogICAgICAgIFRFWFRVUkUyOiAzMzk4NiwKICAgICAgICBURVhUVVJFMzogMzM5ODcsCiAgICAgICAgVEVYVFVSRTQ6IDMzOTg4LAogICAgICAgIFRFWFRVUkU1OiAzMzk4OSwKICAgICAgICBURVhUVVJFNjogMzM5OTAsCiAgICAgICAgVEVYVFVSRTc6IDMzOTkxLAogICAgICAgIFRFWFRVUkU4OiAzMzk5MiwKICAgICAgICBURVhUVVJFOTogMzM5OTMsCiAgICAgICAgVEVYVFVSRTEwOiAzMzk5NCwKICAgICAgICBURVhUVVJFMTE6IDMzOTk1LAogICAgICAgIFRFWFRVUkUxMjogMzM5OTYsCiAgICAgICAgVEVYVFVSRTEzOiAzMzk5NywKICAgICAgICBURVhUVVJFMTQ6IDMzOTk4LAogICAgICAgIFRFWFRVUkUxNTogMzM5OTksCiAgICAgICAgVEVYVFVSRTE2OiAzNGUzLAogICAgICAgIFRFWFRVUkUxNzogMzQwMDEsCiAgICAgICAgVEVYVFVSRTE4OiAzNDAwMiwKICAgICAgICBURVhUVVJFMTk6IDM0MDAzLAogICAgICAgIFRFWFRVUkUyMDogMzQwMDQsCiAgICAgICAgVEVYVFVSRTIxOiAzNDAwNSwKICAgICAgICBURVhUVVJFMjI6IDM0MDA2LAogICAgICAgIFRFWFRVUkUyMzogMzQwMDcsCiAgICAgICAgVEVYVFVSRTI0OiAzNDAwOCwKICAgICAgICBURVhUVVJFMjU6IDM0MDA5LAogICAgICAgIFRFWFRVUkUyNjogMzQwMTAsCiAgICAgICAgVEVYVFVSRTI3OiAzNDAxMSwKICAgICAgICBURVhUVVJFMjg6IDM0MDEyLAogICAgICAgIFRFWFRVUkUyOTogMzQwMTMsCiAgICAgICAgVEVYVFVSRTMwOiAzNDAxNCwKICAgICAgICBURVhUVVJFMzE6IDM0MDE1LAogICAgICAgIEFDVElWRV9URVhUVVJFOiAzNDAxNiwKICAgICAgICBSRVBFQVQ6IDEwNDk3LAogICAgICAgIENMQU1QX1RPX0VER0U6IDMzMDcxLAogICAgICAgIE1JUlJPUkVEX1JFUEVBVDogMzM2NDgsCiAgICAgICAgRkxPQVRfVkVDMjogMzU2NjQsCiAgICAgICAgRkxPQVRfVkVDMzogMzU2NjUsCiAgICAgICAgRkxPQVRfVkVDNDogMzU2NjYsCiAgICAgICAgSU5UX1ZFQzI6IDM1NjY3LAogICAgICAgIElOVF9WRUMzOiAzNTY2OCwKICAgICAgICBJTlRfVkVDNDogMzU2NjksCiAgICAgICAgQk9PTDogMzU2NzAsCiAgICAgICAgQk9PTF9WRUMyOiAzNTY3MSwKICAgICAgICBCT09MX1ZFQzM6IDM1NjcyLAogICAgICAgIEJPT0xfVkVDNDogMzU2NzMsCiAgICAgICAgRkxPQVRfTUFUMjogMzU2NzQsCiAgICAgICAgRkxPQVRfTUFUMzogMzU2NzUsCiAgICAgICAgRkxPQVRfTUFUNDogMzU2NzYsCiAgICAgICAgU0FNUExFUl8yRDogMzU2NzgsCiAgICAgICAgU0FNUExFUl9DVUJFOiAzNTY4MCwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX0VOQUJMRUQ6IDM0MzM4LAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfU0laRTogMzQzMzksCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9TVFJJREU6IDM0MzQwLAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfVFlQRTogMzQzNDEsCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9OT1JNQUxJWkVEOiAzNDkyMiwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX1BPSU5URVI6IDM0MzczLAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTc1LAogICAgICAgIElNUExFTUVOVEFUSU9OX0NPTE9SX1JFQURfVFlQRTogMzU3MzgsCiAgICAgICAgSU1QTEVNRU5UQVRJT05fQ09MT1JfUkVBRF9GT1JNQVQ6IDM1NzM5LAogICAgICAgIENPTVBJTEVfU1RBVFVTOiAzNTcxMywKICAgICAgICBMT1dfRkxPQVQ6IDM2MzM2LAogICAgICAgIE1FRElVTV9GTE9BVDogMzYzMzcsCiAgICAgICAgSElHSF9GTE9BVDogMzYzMzgsCiAgICAgICAgTE9XX0lOVDogMzYzMzksCiAgICAgICAgTUVESVVNX0lOVDogMzYzNDAsCiAgICAgICAgSElHSF9JTlQ6IDM2MzQxLAogICAgICAgIEZSQU1FQlVGRkVSOiAzNjE2MCwKICAgICAgICBSRU5ERVJCVUZGRVI6IDM2MTYxLAogICAgICAgIFJHQkE0OiAzMjg1NCwKICAgICAgICBSR0I1X0ExOiAzMjg1NSwKICAgICAgICBSR0I1NjU6IDM2MTk0LAogICAgICAgIERFUFRIX0NPTVBPTkVOVDE2OiAzMzE4OSwKICAgICAgICBTVEVOQ0lMX0lOREVYOiA2NDAxLAogICAgICAgIFNURU5DSUxfSU5ERVg4OiAzNjE2OCwKICAgICAgICBERVBUSF9TVEVOQ0lMOiAzNDA0MSwKICAgICAgICBSRU5ERVJCVUZGRVJfV0lEVEg6IDM2MTYyLAogICAgICAgIFJFTkRFUkJVRkZFUl9IRUlHSFQ6IDM2MTYzLAogICAgICAgIFJFTkRFUkJVRkZFUl9JTlRFUk5BTF9GT1JNQVQ6IDM2MTY0LAogICAgICAgIFJFTkRFUkJVRkZFUl9SRURfU0laRTogMzYxNzYsCiAgICAgICAgUkVOREVSQlVGRkVSX0dSRUVOX1NJWkU6IDM2MTc3LAogICAgICAgIFJFTkRFUkJVRkZFUl9CTFVFX1NJWkU6IDM2MTc4LAogICAgICAgIFJFTkRFUkJVRkZFUl9BTFBIQV9TSVpFOiAzNjE3OSwKICAgICAgICBSRU5ERVJCVUZGRVJfREVQVEhfU0laRTogMzYxODAsCiAgICAgICAgUkVOREVSQlVGRkVSX1NURU5DSUxfU0laRTogMzYxODEsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9PQkpFQ1RfVFlQRTogMzYwNDgsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9PQkpFQ1RfTkFNRTogMzYwNDksCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9URVhUVVJFX0xFVkVMOiAzNjA1MCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX1RFWFRVUkVfQ1VCRV9NQVBfRkFDRTogMzYwNTEsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDA6IDM2MDY0LAogICAgICAgIERFUFRIX0FUVEFDSE1FTlQ6IDM2MDk2LAogICAgICAgIFNURU5DSUxfQVRUQUNITUVOVDogMzYxMjgsCiAgICAgICAgREVQVEhfU1RFTkNJTF9BVFRBQ0hNRU5UOiAzMzMwNiwKICAgICAgICBOT05FOiAwLAogICAgICAgIEZSQU1FQlVGRkVSX0NPTVBMRVRFOiAzNjA1MywKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0FUVEFDSE1FTlQ6IDM2MDU0LAogICAgICAgIEZSQU1FQlVGRkVSX0lOQ09NUExFVEVfTUlTU0lOR19BVFRBQ0hNRU5UOiAzNjA1NSwKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0RJTUVOU0lPTlM6IDM2MDU3LAogICAgICAgIEZSQU1FQlVGRkVSX1VOU1VQUE9SVEVEOiAzNjA2MSwKICAgICAgICBGUkFNRUJVRkZFUl9CSU5ESU5HOiAzNjAwNiwKICAgICAgICBSRU5ERVJCVUZGRVJfQklORElORzogMzYwMDcsCiAgICAgICAgTUFYX1JFTkRFUkJVRkZFUl9TSVpFOiAzNDAyNCwKICAgICAgICBJTlZBTElEX0ZSQU1FQlVGRkVSX09QRVJBVElPTjogMTI4NiwKICAgICAgICBVTlBBQ0tfRkxJUF9ZX1dFQkdMOiAzNzQ0MCwKICAgICAgICBVTlBBQ0tfUFJFTVVMVElQTFlfQUxQSEFfV0VCR0w6IDM3NDQxLAogICAgICAgIENPTlRFWFRfTE9TVF9XRUJHTDogMzc0NDIsCiAgICAgICAgVU5QQUNLX0NPTE9SU1BBQ0VfQ09OVkVSU0lPTl9XRUJHTDogMzc0NDMsCiAgICAgICAgQlJPV1NFUl9ERUZBVUxUX1dFQkdMOiAzNzQ0NCwKICAgICAgICAvLyBXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0YwogICAgICAgIENPTVBSRVNTRURfUkdCX1MzVENfRFhUMV9FWFQ6IDMzNzc2LAogICAgICAgIENPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDFfRVhUOiAzMzc3NywKICAgICAgICBDT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQzX0VYVDogMzM3NzgsCiAgICAgICAgQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUNV9FWFQ6IDMzNzc5LAogICAgICAgIC8vIFdFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9wdnJ0YwogICAgICAgIENPTVBSRVNTRURfUkdCX1BWUlRDXzRCUFBWMV9JTUc6IDM1ODQwLAogICAgICAgIENPTVBSRVNTRURfUkdCX1BWUlRDXzJCUFBWMV9JTUc6IDM1ODQxLAogICAgICAgIENPTVBSRVNTRURfUkdCQV9QVlJUQ180QlBQVjFfSU1HOiAzNTg0MiwKICAgICAgICBDT01QUkVTU0VEX1JHQkFfUFZSVENfMkJQUFYxX0lNRzogMzU4NDMsCiAgICAgICAgLy8gV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX2FzdGMKICAgICAgICBDT01QUkVTU0VEX1JHQkFfQVNUQ180eDRfV0VCR0w6IDM3ODA4LAogICAgICAgIC8vIFdFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9ldGMxCiAgICAgICAgQ09NUFJFU1NFRF9SR0JfRVRDMV9XRUJHTDogMzYxOTYsCiAgICAgICAgLy8gRVhUX3RleHR1cmVfY29tcHJlc3Npb25fYnB0YwogICAgICAgIENPTVBSRVNTRURfUkdCQV9CUFRDX1VOT1JNOiAzNjQ5MiwKICAgICAgICAvLyBFWFRfY29sb3JfYnVmZmVyX2hhbGZfZmxvYXQKICAgICAgICBIQUxGX0ZMT0FUX09FUzogMzYxOTMsCiAgICAgICAgLy8gRGVza3RvcCBPcGVuR0wKICAgICAgICBET1VCTEU6IDUxMzAsCiAgICAgICAgLy8gV2ViR0wgMgogICAgICAgIFJFQURfQlVGRkVSOiAzMDc0LAogICAgICAgIFVOUEFDS19ST1dfTEVOR1RIOiAzMzE0LAogICAgICAgIFVOUEFDS19TS0lQX1JPV1M6IDMzMTUsCiAgICAgICAgVU5QQUNLX1NLSVBfUElYRUxTOiAzMzE2LAogICAgICAgIFBBQ0tfUk9XX0xFTkdUSDogMzMzMCwKICAgICAgICBQQUNLX1NLSVBfUk9XUzogMzMzMSwKICAgICAgICBQQUNLX1NLSVBfUElYRUxTOiAzMzMyLAogICAgICAgIENPTE9SOiA2MTQ0LAogICAgICAgIERFUFRIOiA2MTQ1LAogICAgICAgIFNURU5DSUw6IDYxNDYsCiAgICAgICAgUkVEOiA2NDAzLAogICAgICAgIFJHQjg6IDMyODQ5LAogICAgICAgIFJHQkE4OiAzMjg1NiwKICAgICAgICBSR0IxMF9BMjogMzI4NTcsCiAgICAgICAgVEVYVFVSRV9CSU5ESU5HXzNEOiAzMjg3NCwKICAgICAgICBVTlBBQ0tfU0tJUF9JTUFHRVM6IDMyODc3LAogICAgICAgIFVOUEFDS19JTUFHRV9IRUlHSFQ6IDMyODc4LAogICAgICAgIFRFWFRVUkVfM0Q6IDMyODc5LAogICAgICAgIFRFWFRVUkVfV1JBUF9SOiAzMjg4MiwKICAgICAgICBNQVhfM0RfVEVYVFVSRV9TSVpFOiAzMjg4MywKICAgICAgICBVTlNJR05FRF9JTlRfMl8xMF8xMF8xMF9SRVY6IDMzNjQwLAogICAgICAgIE1BWF9FTEVNRU5UU19WRVJUSUNFUzogMzNlMywKICAgICAgICBNQVhfRUxFTUVOVFNfSU5ESUNFUzogMzMwMDEsCiAgICAgICAgVEVYVFVSRV9NSU5fTE9EOiAzMzA4MiwKICAgICAgICBURVhUVVJFX01BWF9MT0Q6IDMzMDgzLAogICAgICAgIFRFWFRVUkVfQkFTRV9MRVZFTDogMzMwODQsCiAgICAgICAgVEVYVFVSRV9NQVhfTEVWRUw6IDMzMDg1LAogICAgICAgIE1JTjogMzI3NzUsCiAgICAgICAgTUFYOiAzMjc3NiwKICAgICAgICBERVBUSF9DT01QT05FTlQyNDogMzMxOTAsCiAgICAgICAgTUFYX1RFWFRVUkVfTE9EX0JJQVM6IDM0MDQ1LAogICAgICAgIFRFWFRVUkVfQ09NUEFSRV9NT0RFOiAzNDg5MiwKICAgICAgICBURVhUVVJFX0NPTVBBUkVfRlVOQzogMzQ4OTMsCiAgICAgICAgQ1VSUkVOVF9RVUVSWTogMzQ5MTcsCiAgICAgICAgUVVFUllfUkVTVUxUOiAzNDkxOCwKICAgICAgICBRVUVSWV9SRVNVTFRfQVZBSUxBQkxFOiAzNDkxOSwKICAgICAgICBTVFJFQU1fUkVBRDogMzUwNDEsCiAgICAgICAgU1RSRUFNX0NPUFk6IDM1MDQyLAogICAgICAgIFNUQVRJQ19SRUFEOiAzNTA0NSwKICAgICAgICBTVEFUSUNfQ09QWTogMzUwNDYsCiAgICAgICAgRFlOQU1JQ19SRUFEOiAzNTA0OSwKICAgICAgICBEWU5BTUlDX0NPUFk6IDM1MDUwLAogICAgICAgIE1BWF9EUkFXX0JVRkZFUlM6IDM0ODUyLAogICAgICAgIERSQVdfQlVGRkVSMDogMzQ4NTMsCiAgICAgICAgRFJBV19CVUZGRVIxOiAzNDg1NCwKICAgICAgICBEUkFXX0JVRkZFUjI6IDM0ODU1LAogICAgICAgIERSQVdfQlVGRkVSMzogMzQ4NTYsCiAgICAgICAgRFJBV19CVUZGRVI0OiAzNDg1NywKICAgICAgICBEUkFXX0JVRkZFUjU6IDM0ODU4LAogICAgICAgIERSQVdfQlVGRkVSNjogMzQ4NTksCiAgICAgICAgRFJBV19CVUZGRVI3OiAzNDg2MCwKICAgICAgICBEUkFXX0JVRkZFUjg6IDM0ODYxLAogICAgICAgIERSQVdfQlVGRkVSOTogMzQ4NjIsCiAgICAgICAgRFJBV19CVUZGRVIxMDogMzQ4NjMsCiAgICAgICAgRFJBV19CVUZGRVIxMTogMzQ4NjQsCiAgICAgICAgRFJBV19CVUZGRVIxMjogMzQ4NjUsCiAgICAgICAgRFJBV19CVUZGRVIxMzogMzQ4NjYsCiAgICAgICAgRFJBV19CVUZGRVIxNDogMzQ4NjcsCiAgICAgICAgRFJBV19CVUZGRVIxNTogMzQ4NjgsCiAgICAgICAgTUFYX0ZSQUdNRU5UX1VOSUZPUk1fQ09NUE9ORU5UUzogMzU2NTcsCiAgICAgICAgTUFYX1ZFUlRFWF9VTklGT1JNX0NPTVBPTkVOVFM6IDM1NjU4LAogICAgICAgIFNBTVBMRVJfM0Q6IDM1Njc5LAogICAgICAgIFNBTVBMRVJfMkRfU0hBRE9XOiAzNTY4MiwKICAgICAgICBGUkFHTUVOVF9TSEFERVJfREVSSVZBVElWRV9ISU5UOiAzNTcyMywKICAgICAgICBQSVhFTF9QQUNLX0JVRkZFUjogMzUwNTEsCiAgICAgICAgUElYRUxfVU5QQUNLX0JVRkZFUjogMzUwNTIsCiAgICAgICAgUElYRUxfUEFDS19CVUZGRVJfQklORElORzogMzUwNTMsCiAgICAgICAgUElYRUxfVU5QQUNLX0JVRkZFUl9CSU5ESU5HOiAzNTA1NSwKICAgICAgICBGTE9BVF9NQVQyeDM6IDM1Njg1LAogICAgICAgIEZMT0FUX01BVDJ4NDogMzU2ODYsCiAgICAgICAgRkxPQVRfTUFUM3gyOiAzNTY4NywKICAgICAgICBGTE9BVF9NQVQzeDQ6IDM1Njg4LAogICAgICAgIEZMT0FUX01BVDR4MjogMzU2ODksCiAgICAgICAgRkxPQVRfTUFUNHgzOiAzNTY5MCwKICAgICAgICBTUkdCOiAzNTkwNCwKICAgICAgICBTUkdCODogMzU5MDUsCiAgICAgICAgU1JHQjhfQUxQSEE4OiAzNTkwNywKICAgICAgICBDT01QQVJFX1JFRl9UT19URVhUVVJFOiAzNDg5NCwKICAgICAgICBSR0JBMzJGOiAzNDgzNiwKICAgICAgICBSR0IzMkY6IDM0ODM3LAogICAgICAgIFJHQkExNkY6IDM0ODQyLAogICAgICAgIFJHQjE2RjogMzQ4NDMsCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9JTlRFR0VSOiAzNTA2OSwKICAgICAgICBNQVhfQVJSQVlfVEVYVFVSRV9MQVlFUlM6IDM1MDcxLAogICAgICAgIE1JTl9QUk9HUkFNX1RFWEVMX09GRlNFVDogMzUwNzYsCiAgICAgICAgTUFYX1BST0dSQU1fVEVYRUxfT0ZGU0VUOiAzNTA3NywKICAgICAgICBNQVhfVkFSWUlOR19DT01QT05FTlRTOiAzNTY1OSwKICAgICAgICBURVhUVVJFXzJEX0FSUkFZOiAzNTg2NiwKICAgICAgICBURVhUVVJFX0JJTkRJTkdfMkRfQVJSQVk6IDM1ODY5LAogICAgICAgIFIxMUZfRzExRl9CMTBGOiAzNTg5OCwKICAgICAgICBVTlNJR05FRF9JTlRfMTBGXzExRl8xMUZfUkVWOiAzNTg5OSwKICAgICAgICBSR0I5X0U1OiAzNTkwMSwKICAgICAgICBVTlNJR05FRF9JTlRfNV85XzlfOV9SRVY6IDM1OTAyLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfTU9ERTogMzU5NjcsCiAgICAgICAgTUFYX1RSQU5TRk9STV9GRUVEQkFDS19TRVBBUkFURV9DT01QT05FTlRTOiAzNTk2OCwKICAgICAgICBUUkFOU0ZPUk1fRkVFREJBQ0tfVkFSWUlOR1M6IDM1OTcxLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfU1RBUlQ6IDM1OTcyLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfU0laRTogMzU5NzMsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX1BSSU1JVElWRVNfV1JJVFRFTjogMzU5NzYsCiAgICAgICAgUkFTVEVSSVpFUl9ESVNDQVJEOiAzNTk3NywKICAgICAgICBNQVhfVFJBTlNGT1JNX0ZFRURCQUNLX0lOVEVSTEVBVkVEX0NPTVBPTkVOVFM6IDM1OTc4LAogICAgICAgIE1BWF9UUkFOU0ZPUk1fRkVFREJBQ0tfU0VQQVJBVEVfQVRUUklCUzogMzU5NzksCiAgICAgICAgSU5URVJMRUFWRURfQVRUUklCUzogMzU5ODAsCiAgICAgICAgU0VQQVJBVEVfQVRUUklCUzogMzU5ODEsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JVRkZFUjogMzU5ODIsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JVRkZFUl9CSU5ESU5HOiAzNTk4MywKICAgICAgICBSR0JBMzJVSTogMzYyMDgsCiAgICAgICAgUkdCMzJVSTogMzYyMDksCiAgICAgICAgUkdCQTE2VUk6IDM2MjE0LAogICAgICAgIFJHQjE2VUk6IDM2MjE1LAogICAgICAgIFJHQkE4VUk6IDM2MjIwLAogICAgICAgIFJHQjhVSTogMzYyMjEsCiAgICAgICAgUkdCQTMySTogMzYyMjYsCiAgICAgICAgUkdCMzJJOiAzNjIyNywKICAgICAgICBSR0JBMTZJOiAzNjIzMiwKICAgICAgICBSR0IxNkk6IDM2MjMzLAogICAgICAgIFJHQkE4STogMzYyMzgsCiAgICAgICAgUkdCOEk6IDM2MjM5LAogICAgICAgIFJFRF9JTlRFR0VSOiAzNjI0NCwKICAgICAgICBSR0JfSU5URUdFUjogMzYyNDgsCiAgICAgICAgUkdCQV9JTlRFR0VSOiAzNjI0OSwKICAgICAgICBTQU1QTEVSXzJEX0FSUkFZOiAzNjI4OSwKICAgICAgICBTQU1QTEVSXzJEX0FSUkFZX1NIQURPVzogMzYyOTIsCiAgICAgICAgU0FNUExFUl9DVUJFX1NIQURPVzogMzYyOTMsCiAgICAgICAgVU5TSUdORURfSU5UX1ZFQzI6IDM2Mjk0LAogICAgICAgIFVOU0lHTkVEX0lOVF9WRUMzOiAzNjI5NSwKICAgICAgICBVTlNJR05FRF9JTlRfVkVDNDogMzYyOTYsCiAgICAgICAgSU5UX1NBTVBMRVJfMkQ6IDM2Mjk4LAogICAgICAgIElOVF9TQU1QTEVSXzNEOiAzNjI5OSwKICAgICAgICBJTlRfU0FNUExFUl9DVUJFOiAzNjMwMCwKICAgICAgICBJTlRfU0FNUExFUl8yRF9BUlJBWTogMzYzMDMsCiAgICAgICAgVU5TSUdORURfSU5UX1NBTVBMRVJfMkQ6IDM2MzA2LAogICAgICAgIFVOU0lHTkVEX0lOVF9TQU1QTEVSXzNEOiAzNjMwNywKICAgICAgICBVTlNJR05FRF9JTlRfU0FNUExFUl9DVUJFOiAzNjMwOCwKICAgICAgICBVTlNJR05FRF9JTlRfU0FNUExFUl8yRF9BUlJBWTogMzYzMTEsCiAgICAgICAgREVQVEhfQ09NUE9ORU5UMzJGOiAzNjAxMiwKICAgICAgICBERVBUSDMyRl9TVEVOQ0lMODogMzYwMTMsCiAgICAgICAgRkxPQVRfMzJfVU5TSUdORURfSU5UXzI0XzhfUkVWOiAzNjI2OSwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0NPTE9SX0VOQ09ESU5HOiAzMzI5NiwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0NPTVBPTkVOVF9UWVBFOiAzMzI5NywKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX1JFRF9TSVpFOiAzMzI5OCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0dSRUVOX1NJWkU6IDMzMjk5LAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfQkxVRV9TSVpFOiAzMzMwMCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0FMUEhBX1NJWkU6IDMzMzAxLAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfREVQVEhfU0laRTogMzMzMDIsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9TVEVOQ0lMX1NJWkU6IDMzMzAzLAogICAgICAgIEZSQU1FQlVGRkVSX0RFRkFVTFQ6IDMzMzA0LAogICAgICAgIFVOU0lHTkVEX0lOVF8yNF84OiAzNDA0MiwKICAgICAgICBERVBUSDI0X1NURU5DSUw4OiAzNTA1NiwKICAgICAgICBVTlNJR05FRF9OT1JNQUxJWkVEOiAzNTg2MywKICAgICAgICBEUkFXX0ZSQU1FQlVGRkVSX0JJTkRJTkc6IDM2MDA2LAogICAgICAgIC8vIFNhbWUgYXMgRlJBTUVCVUZGRVJfQklORElORwogICAgICAgIFJFQURfRlJBTUVCVUZGRVI6IDM2MDA4LAogICAgICAgIERSQVdfRlJBTUVCVUZGRVI6IDM2MDA5LAogICAgICAgIFJFQURfRlJBTUVCVUZGRVJfQklORElORzogMzYwMTAsCiAgICAgICAgUkVOREVSQlVGRkVSX1NBTVBMRVM6IDM2MDExLAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfVEVYVFVSRV9MQVlFUjogMzYwNTIsCiAgICAgICAgTUFYX0NPTE9SX0FUVEFDSE1FTlRTOiAzNjA2MywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTogMzYwNjUsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDI6IDM2MDY2LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQzOiAzNjA2NywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UNDogMzYwNjgsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDU6IDM2MDY5LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQ2OiAzNjA3MCwKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UNzogMzYwNzEsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDg6IDM2MDcyLAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQ5OiAzNjA3MywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTA6IDM2MDc0LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQxMTogMzYwNzUsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDEyOiAzNjA3NiwKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTM6IDM2MDc3LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQxNDogMzYwNzgsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDE1OiAzNjA3OSwKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX01VTFRJU0FNUExFOiAzNjE4MiwKICAgICAgICBNQVhfU0FNUExFUzogMzYxODMsCiAgICAgICAgSEFMRl9GTE9BVDogNTEzMSwKICAgICAgICBSRzogMzMzMTksCiAgICAgICAgUkdfSU5URUdFUjogMzMzMjAsCiAgICAgICAgUjg6IDMzMzIxLAogICAgICAgIFJHODogMzMzMjMsCiAgICAgICAgUjE2RjogMzMzMjUsCiAgICAgICAgUjMyRjogMzMzMjYsCiAgICAgICAgUkcxNkY6IDMzMzI3LAogICAgICAgIFJHMzJGOiAzMzMyOCwKICAgICAgICBSOEk6IDMzMzI5LAogICAgICAgIFI4VUk6IDMzMzMwLAogICAgICAgIFIxNkk6IDMzMzMxLAogICAgICAgIFIxNlVJOiAzMzMzMiwKICAgICAgICBSMzJJOiAzMzMzMywKICAgICAgICBSMzJVSTogMzMzMzQsCiAgICAgICAgUkc4STogMzMzMzUsCiAgICAgICAgUkc4VUk6IDMzMzM2LAogICAgICAgIFJHMTZJOiAzMzMzNywKICAgICAgICBSRzE2VUk6IDMzMzM4LAogICAgICAgIFJHMzJJOiAzMzMzOSwKICAgICAgICBSRzMyVUk6IDMzMzQwLAogICAgICAgIFZFUlRFWF9BUlJBWV9CSU5ESU5HOiAzNDIyOSwKICAgICAgICBSOF9TTk9STTogMzY3NTYsCiAgICAgICAgUkc4X1NOT1JNOiAzNjc1NywKICAgICAgICBSR0I4X1NOT1JNOiAzNjc1OCwKICAgICAgICBSR0JBOF9TTk9STTogMzY3NTksCiAgICAgICAgU0lHTkVEX05PUk1BTElaRUQ6IDM2NzY0LAogICAgICAgIENPUFlfUkVBRF9CVUZGRVI6IDM2NjYyLAogICAgICAgIENPUFlfV1JJVEVfQlVGRkVSOiAzNjY2MywKICAgICAgICBDT1BZX1JFQURfQlVGRkVSX0JJTkRJTkc6IDM2NjYyLAogICAgICAgIC8vIFNhbWUgYXMgQ09QWV9SRUFEX0JVRkZFUgogICAgICAgIENPUFlfV1JJVEVfQlVGRkVSX0JJTkRJTkc6IDM2NjYzLAogICAgICAgIC8vIFNhbWUgYXMgQ09QWV9XUklURV9CVUZGRVIKICAgICAgICBVTklGT1JNX0JVRkZFUjogMzUzNDUsCiAgICAgICAgVU5JRk9STV9CVUZGRVJfQklORElORzogMzUzNjgsCiAgICAgICAgVU5JRk9STV9CVUZGRVJfU1RBUlQ6IDM1MzY5LAogICAgICAgIFVOSUZPUk1fQlVGRkVSX1NJWkU6IDM1MzcwLAogICAgICAgIE1BWF9WRVJURVhfVU5JRk9STV9CTE9DS1M6IDM1MzcxLAogICAgICAgIE1BWF9GUkFHTUVOVF9VTklGT1JNX0JMT0NLUzogMzUzNzMsCiAgICAgICAgTUFYX0NPTUJJTkVEX1VOSUZPUk1fQkxPQ0tTOiAzNTM3NCwKICAgICAgICBNQVhfVU5JRk9STV9CVUZGRVJfQklORElOR1M6IDM1Mzc1LAogICAgICAgIE1BWF9VTklGT1JNX0JMT0NLX1NJWkU6IDM1Mzc2LAogICAgICAgIE1BWF9DT01CSU5FRF9WRVJURVhfVU5JRk9STV9DT01QT05FTlRTOiAzNTM3NywKICAgICAgICBNQVhfQ09NQklORURfRlJBR01FTlRfVU5JRk9STV9DT01QT05FTlRTOiAzNTM3OSwKICAgICAgICBVTklGT1JNX0JVRkZFUl9PRkZTRVRfQUxJR05NRU5UOiAzNTM4MCwKICAgICAgICBBQ1RJVkVfVU5JRk9STV9CTE9DS1M6IDM1MzgyLAogICAgICAgIFVOSUZPUk1fVFlQRTogMzUzODMsCiAgICAgICAgVU5JRk9STV9TSVpFOiAzNTM4NCwKICAgICAgICBVTklGT1JNX0JMT0NLX0lOREVYOiAzNTM4NiwKICAgICAgICBVTklGT1JNX09GRlNFVDogMzUzODcsCiAgICAgICAgVU5JRk9STV9BUlJBWV9TVFJJREU6IDM1Mzg4LAogICAgICAgIFVOSUZPUk1fTUFUUklYX1NUUklERTogMzUzODksCiAgICAgICAgVU5JRk9STV9JU19ST1dfTUFKT1I6IDM1MzkwLAogICAgICAgIFVOSUZPUk1fQkxPQ0tfQklORElORzogMzUzOTEsCiAgICAgICAgVU5JRk9STV9CTE9DS19EQVRBX1NJWkU6IDM1MzkyLAogICAgICAgIFVOSUZPUk1fQkxPQ0tfQUNUSVZFX1VOSUZPUk1TOiAzNTM5NCwKICAgICAgICBVTklGT1JNX0JMT0NLX0FDVElWRV9VTklGT1JNX0lORElDRVM6IDM1Mzk1LAogICAgICAgIFVOSUZPUk1fQkxPQ0tfUkVGRVJFTkNFRF9CWV9WRVJURVhfU0hBREVSOiAzNTM5NiwKICAgICAgICBVTklGT1JNX0JMT0NLX1JFRkVSRU5DRURfQllfRlJBR01FTlRfU0hBREVSOiAzNTM5OCwKICAgICAgICBJTlZBTElEX0lOREVYOiA0Mjk0OTY3Mjk1LAogICAgICAgIE1BWF9WRVJURVhfT1VUUFVUX0NPTVBPTkVOVFM6IDM3MTU0LAogICAgICAgIE1BWF9GUkFHTUVOVF9JTlBVVF9DT01QT05FTlRTOiAzNzE1NywKICAgICAgICBNQVhfU0VSVkVSX1dBSVRfVElNRU9VVDogMzcxMzcsCiAgICAgICAgT0JKRUNUX1RZUEU6IDM3MTM4LAogICAgICAgIFNZTkNfQ09ORElUSU9OOiAzNzEzOSwKICAgICAgICBTWU5DX1NUQVRVUzogMzcxNDAsCiAgICAgICAgU1lOQ19GTEFHUzogMzcxNDEsCiAgICAgICAgU1lOQ19GRU5DRTogMzcxNDIsCiAgICAgICAgU1lOQ19HUFVfQ09NTUFORFNfQ09NUExFVEU6IDM3MTQzLAogICAgICAgIFVOU0lHTkFMRUQ6IDM3MTQ0LAogICAgICAgIFNJR05BTEVEOiAzNzE0NSwKICAgICAgICBBTFJFQURZX1NJR05BTEVEOiAzNzE0NiwKICAgICAgICBUSU1FT1VUX0VYUElSRUQ6IDM3MTQ3LAogICAgICAgIENPTkRJVElPTl9TQVRJU0ZJRUQ6IDM3MTQ4LAogICAgICAgIFdBSVRfRkFJTEVEOiAzNzE0OSwKICAgICAgICBTWU5DX0ZMVVNIX0NPTU1BTkRTX0JJVDogMSwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX0RJVklTT1I6IDM1MDcwLAogICAgICAgIEFOWV9TQU1QTEVTX1BBU1NFRDogMzU4ODcsCiAgICAgICAgQU5ZX1NBTVBMRVNfUEFTU0VEX0NPTlNFUlZBVElWRTogMzYyMDIsCiAgICAgICAgU0FNUExFUl9CSU5ESU5HOiAzNTA5NywKICAgICAgICBSR0IxMF9BMlVJOiAzNjk3NSwKICAgICAgICBJTlRfMl8xMF8xMF8xMF9SRVY6IDM2MjU1LAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDSzogMzYzODYsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX1BBVVNFRDogMzYzODcsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0FDVElWRTogMzYzODgsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JJTkRJTkc6IDM2Mzg5LAogICAgICAgIENPTVBSRVNTRURfUjExX0VBQzogMzc0ODgsCiAgICAgICAgQ09NUFJFU1NFRF9TSUdORURfUjExX0VBQzogMzc0ODksCiAgICAgICAgQ09NUFJFU1NFRF9SRzExX0VBQzogMzc0OTAsCiAgICAgICAgQ09NUFJFU1NFRF9TSUdORURfUkcxMV9FQUM6IDM3NDkxLAogICAgICAgIENPTVBSRVNTRURfUkdCOF9FVEMyOiAzNzQ5MiwKICAgICAgICBDT01QUkVTU0VEX1NSR0I4X0VUQzI6IDM3NDkzLAogICAgICAgIENPTVBSRVNTRURfUkdCOF9QVU5DSFRIUk9VR0hfQUxQSEExX0VUQzI6IDM3NDk0LAogICAgICAgIENPTVBSRVNTRURfU1JHQjhfUFVOQ0hUSFJPVUdIX0FMUEhBMV9FVEMyOiAzNzQ5NSwKICAgICAgICBDT01QUkVTU0VEX1JHQkE4X0VUQzJfRUFDOiAzNzQ5NiwKICAgICAgICBDT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9FVEMyX0VBQzogMzc0OTcsCiAgICAgICAgVEVYVFVSRV9JTU1VVEFCTEVfRk9STUFUOiAzNzE2NywKICAgICAgICBNQVhfRUxFTUVOVF9JTkRFWDogMzYyMDMsCiAgICAgICAgVEVYVFVSRV9JTU1VVEFCTEVfTEVWRUxTOiAzMzUwMywKICAgICAgICAvLyBFeHRlbnNpb25zCiAgICAgICAgTUFYX1RFWFRVUkVfTUFYX0FOSVNPVFJPUFlfRVhUOiAzNDA0NwogICAgICB9OwogICAgICBXZWJHTENvbnN0YW50c19kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShXZWJHTENvbnN0YW50cyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db21wb25lbnREYXRhdHlwZS5qcwogIHZhciBDb21wb25lbnREYXRhdHlwZSwgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9Db21wb25lbnREYXRhdHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29tcG9uZW50RGF0YXR5cGUuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIENvbXBvbmVudERhdGF0eXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIDgtYml0IHNpZ25lZCBieXRlIGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+Z2wuQllURTwvY29kZT4gYW5kIHRoZSB0eXBlCiAgICAgICAgICogb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5JbnQ4QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBCWVRFOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkJZVEUsCiAgICAgICAgLyoqCiAgICAgICAgICogOC1iaXQgdW5zaWduZWQgYnl0ZSBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX0JZVEU8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+VWludDhBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVOU0lHTkVEX0JZVEU6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAvKioKICAgICAgICAgKiAxNi1iaXQgc2lnbmVkIHNob3J0IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+U0hPUlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+SW50MTZBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNIT1JUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlNIT1JULAogICAgICAgIC8qKgogICAgICAgICAqIDE2LWJpdCB1bnNpZ25lZCBzaG9ydCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX1NIT1JUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQxNkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVU5TSUdORURfU0hPUlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlQsCiAgICAgICAgLyoqCiAgICAgICAgICogMzItYml0IHNpZ25lZCBpbnQgY29ycmVzcG9uZGluZyB0byA8Y29kZT5JTlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+SW50MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyT2YgQ29tcG9uZW50RGF0YXR5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSU5UOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LklOVCwKICAgICAgICAvKioKICAgICAgICAgKiAzMi1iaXQgdW5zaWduZWQgaW50IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+VU5TSUdORURfSU5UPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQzMkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJPZiBDb21wb25lbnREYXRhdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTlNJR05FRF9JTlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICAgIC8qKgogICAgICAgICAqIDMyLWJpdCBmbG9hdGluZy1wb2ludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPkZMT0FUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPkZsb2F0MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEZMT0FUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkZMT0FULAogICAgICAgIC8qKgogICAgICAgICAqIDY0LWJpdCBmbG9hdGluZy1wb2ludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPmdsLkRPVUJMRTwvY29kZT4gKGluIERlc2t0b3AgT3BlbkdMOwogICAgICAgICAqIHRoaXMgaXMgbm90IHN1cHBvcnRlZCBpbiBXZWJHTCwgYW5kIGlzIGVtdWxhdGVkIGluIENlc2l1bSB2aWEge0BsaW5rIEdlb21ldHJ5UGlwZWxpbmUuZW5jb2RlQXR0cmlidXRlfSkKICAgICAgICAgKiBhbmQgdGhlIHR5cGUgb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5GbG9hdDY0QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIENvbXBvbmVudERhdGF0eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqIEBkZWZhdWx0IDB4MTQwQQogICAgICAgICAqLwogICAgICAgIERPVUJMRTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ET1VCTEUKICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuZ2V0U2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNvbXBvbmVudERhdGF0eXBlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKGNvbXBvbmVudERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkJZVEU6CiAgICAgICAgICAgIHJldHVybiBJbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIEludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLklOVDoKICAgICAgICAgICAgcmV0dXJuIEludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIEZsb2F0MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOgogICAgICAgICAgICByZXR1cm4gRmxvYXQ2NEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgLy8+PmluY2x1ZGVTdGFydCgnZGVidWcnLCBwcmFnbWFzLmRlYnVnKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb21wb25lbnREYXRhdHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENvbXBvbmVudERhdGF0eXBlLmZyb21UeXBlZEFycmF5ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBJbnQ4QXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5CWVRFOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfQllURTsKICAgICAgICB9CiAgICAgICAgaWYgKGFycmF5IGluc3RhbmNlb2YgSW50MTZBcnJheSkgewogICAgICAgICAgcmV0dXJuIENvbXBvbmVudERhdGF0eXBlLlNIT1JUOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBVaW50MTZBcnJheSkgewogICAgICAgICAgcmV0dXJuIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBJbnQzMkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuSU5UOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBVaW50MzJBcnJheSkgewogICAgICAgICAgcmV0dXJuIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVDsKICAgICAgICB9CiAgICAgICAgaWYgKGFycmF5IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRkxPQVQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIEZsb2F0NjRBcnJheSkgewogICAgICAgICAgcmV0dXJuIENvbXBvbmVudERhdGF0eXBlLkRPVUJMRTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiYXJyYXkgbXVzdCBiZSBhbiBJbnQ4QXJyYXksIFVpbnQ4QXJyYXksIEludDE2QXJyYXksIFVpbnQxNkFycmF5LCBJbnQzMkFycmF5LCBVaW50MzJBcnJheSwgRmxvYXQzMkFycmF5LCBvciBGbG9hdDY0QXJyYXkuIgogICAgICAgICk7CiAgICAgIH07CiAgICAgIENvbXBvbmVudERhdGF0eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24oY29tcG9uZW50RGF0YXR5cGUpIHsKICAgICAgICByZXR1cm4gZGVmaW5lZF9kZWZhdWx0KGNvbXBvbmVudERhdGF0eXBlKSAmJiAoY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLkJZVEUgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0JZVEUgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLlNIT1JUIHx8IGNvbXBvbmVudERhdGF0eXBlID09PSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9TSE9SVCB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuSU5UIHx8IGNvbXBvbmVudERhdGF0eXBlID09PSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9JTlQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLkZMT0FUIHx8IGNvbXBvbmVudERhdGF0eXBlID09PSBDb21wb25lbnREYXRhdHlwZS5ET1VCTEUpOwogICAgICB9OwogICAgICBDb21wb25lbnREYXRhdHlwZS5jcmVhdGVUeXBlZEFycmF5ID0gZnVuY3Rpb24oY29tcG9uZW50RGF0YXR5cGUsIHZhbHVlc09yTGVuZ3RoKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29tcG9uZW50RGF0YXR5cGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY29tcG9uZW50RGF0YXR5cGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlc09yTGVuZ3RoKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlc09yTGVuZ3RoIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKGNvbXBvbmVudERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkJZVEU6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50OEFycmF5KHZhbHVlc09yTGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfQllURToKICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHZhbHVlc09yTGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50MTZBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KHZhbHVlc09yTGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuSU5UOgogICAgICAgICAgICByZXR1cm4gbmV3IEludDMyQXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9JTlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgVWludDMyQXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDMyQXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5ET1VCTEU6CiAgICAgICAgICAgIHJldHVybiBuZXcgRmxvYXQ2NEFycmF5KHZhbHVlc09yTGVuZ3RoKTsKICAgICAgICAgIC8vPj5pbmNsdWRlU3RhcnQoJ2RlYnVnJywgcHJhZ21hcy5kZWJ1Zyk7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY29tcG9uZW50RGF0YXR5cGUgaXMgbm90IGEgdmFsaWQgdmFsdWUuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICBDb21wb25lbnREYXRhdHlwZS5jcmVhdGVBcnJheUJ1ZmZlclZpZXcgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSwgYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb21wb25lbnREYXRhdHlwZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb21wb25lbnREYXRhdHlwZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnVmZmVyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImJ1ZmZlciBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgYnl0ZU9mZnNldCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGJ5dGVPZmZzZXQsIDApOwogICAgICAgIGxlbmd0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgKGJ1ZmZlci5ieXRlTGVuZ3RoIC0gYnl0ZU9mZnNldCkgLyBDb21wb25lbnREYXRhdHlwZS5nZXRTaXplSW5CeXRlcyhjb21wb25lbnREYXRhdHlwZSkKICAgICAgICApOwogICAgICAgIHN3aXRjaCAoY29tcG9uZW50RGF0YXR5cGUpIHsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuQllURToKICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQ4QXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOgogICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQxNkFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5JTlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50MzJBcnJheShidWZmZXIsIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheShidWZmZXIsIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkZMT0FUOgogICAgICAgICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheShidWZmZXIsIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkRPVUJMRToKICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDY0QXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgLy8+PmluY2x1ZGVTdGFydCgnZGVidWcnLCBwcmFnbWFzLmRlYnVnKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb21wb25lbnREYXRhdHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENvbXBvbmVudERhdGF0eXBlLmZyb21OYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgY2FzZSAiQllURSI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5CWVRFOwogICAgICAgICAgY2FzZSAiVU5TSUdORURfQllURSI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOwogICAgICAgICAgY2FzZSAiU0hPUlQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ7CiAgICAgICAgICBjYXNlICJVTlNJR05FRF9TSE9SVCI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9TSE9SVDsKICAgICAgICAgIGNhc2UgIklOVCI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5JTlQ7CiAgICAgICAgICBjYXNlICJVTlNJR05FRF9JTlQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfSU5UOwogICAgICAgICAgY2FzZSAiRkxPQVQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRkxPQVQ7CiAgICAgICAgICBjYXNlICJET1VCTEUiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOwogICAgICAgICAgLy8+PmluY2x1ZGVTdGFydCgnZGVidWcnLCBwcmFnbWFzLmRlYnVnKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJuYW1lIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoQ29tcG9uZW50RGF0YXR5cGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlUeXBlLmpzCiAgdmFyIEdlb21ldHJ5VHlwZSwgR2VvbWV0cnlUeXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvbWV0cnlUeXBlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeVR5cGUuanMiKCkgewogICAgICBHZW9tZXRyeVR5cGUgPSB7CiAgICAgICAgTk9ORTogMCwKICAgICAgICBUUklBTkdMRVM6IDEsCiAgICAgICAgTElORVM6IDIsCiAgICAgICAgUE9MWUxJTkVTOiAzCiAgICAgIH07CiAgICAgIEdlb21ldHJ5VHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShHZW9tZXRyeVR5cGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0cml4Mi5qcwogIGZ1bmN0aW9uIE1hdHJpeDIoY29sdW1uMFJvdzAsIGNvbHVtbjFSb3cwLCBjb2x1bW4wUm93MSwgY29sdW1uMVJvdzEpIHsKICAgIHRoaXNbMF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MCwgMCk7CiAgICB0aGlzWzFdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzEsIDApOwogICAgdGhpc1syXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cwLCAwKTsKICAgIHRoaXNbM10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MSwgMCk7CiAgfQogIHZhciBzY2FsZVNjcmF0Y2gxMywgc2NhbGVTY3JhdGNoMjMsIHNjcmF0Y2hDb2x1bW4zLCBzY2FsZVNjcmF0Y2gzMywgc2NhbGVTY3JhdGNoNDMsIHNjYWxlU2NyYXRjaDUzLCBNYXRyaXgyX2RlZmF1bHQ7CiAgdmFyIGluaXRfTWF0cml4MiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0cml4Mi5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIE1hdHJpeDIucGFja2VkTGVuZ3RoID0gNDsKICAgICAgTWF0cml4Mi5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzFdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsyXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbM107CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBNYXRyaXgyLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4MigpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzJdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbM10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGNvbnN0IHJlc3VsdExlbmd0aCA9IGxlbmd0aCAqIDQ7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KHJlc3VsdExlbmd0aCk7CiAgICAgICAgfSBlbHNlIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHQpICYmIHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJJZiByZXN1bHQgaXMgYSB0eXBlZCBhcnJheSwgaXQgbXVzdCBoYXZlIGV4YWN0bHkgYXJyYXkubGVuZ3RoICogNCBlbGVtZW50cyIKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSByZXN1bHRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIE1hdHJpeDIucGFjayhhcnJheVtpXSwgcmVzdWx0LCBpICogNCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIudW5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiYXJyYXkubGVuZ3RoIiwgYXJyYXkubGVuZ3RoLCA0KTsKICAgICAgICBpZiAoYXJyYXkubGVuZ3RoICUgNCAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyA0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aCAvIDQ7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDQpIHsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAvIDQ7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gTWF0cml4Mi51bnBhY2soYXJyYXksIGksIHJlc3VsdFtpbmRleF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLmNsb25lID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtYXRyaXgpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDIobWF0cml4WzBdLCBtYXRyaXhbMl0sIG1hdHJpeFsxXSwgbWF0cml4WzNdKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZnJvbUFycmF5ID0gTWF0cml4Mi51bnBhY2s7CiAgICAgIE1hdHJpeDIuZnJvbUNvbHVtbk1ham9yQXJyYXkgPSBmdW5jdGlvbih2YWx1ZXMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmFsdWVzIiwgdmFsdWVzKTsKICAgICAgICByZXR1cm4gTWF0cml4Mi5jbG9uZSh2YWx1ZXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZnJvbVJvd01ham9yQXJyYXkgPSBmdW5jdGlvbih2YWx1ZXMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmFsdWVzIiwgdmFsdWVzKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDIodmFsdWVzWzBdLCB2YWx1ZXNbMV0sIHZhbHVlc1syXSwgdmFsdWVzWzNdKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gdmFsdWVzWzBdOwogICAgICAgIHJlc3VsdFsxXSA9IHZhbHVlc1syXTsKICAgICAgICByZXN1bHRbMl0gPSB2YWx1ZXNbMV07CiAgICAgICAgcmVzdWx0WzNdID0gdmFsdWVzWzNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZnJvbVNjYWxlID0gZnVuY3Rpb24oc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgyKHNjYWxlLngsIDAsIDAsIHNjYWxlLnkpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSBzY2FsZS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZnJvbVVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MihzY2FsZSwgMCwgMCwgc2NhbGUpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBzY2FsZTsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gc2NhbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tUm90YXRpb24gPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDIoY29zQW5nbGUsIC1zaW5BbmdsZSwgc2luQW5nbGUsIGNvc0FuZ2xlKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzFdID0gc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzJdID0gLXNpbkFuZ2xlOwogICAgICAgIHJlc3VsdFszXSA9IGNvc0FuZ2xlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIudG9BcnJheSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBbbWF0cml4WzBdLCBtYXRyaXhbMV0sIG1hdHJpeFsyXSwgbWF0cml4WzNdXTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZ2V0RWxlbWVudEluZGV4ID0gZnVuY3Rpb24oY29sdW1uLCByb3cpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygicm93Iiwgcm93LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygicm93Iiwgcm93LCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAxKTsKICAgICAgICByZXR1cm4gY29sdW1uICogMiArIHJvdzsKICAgICAgfTsKICAgICAgTWF0cml4Mi5nZXRDb2x1bW4gPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMjsKICAgICAgICBjb25zdCB4ID0gbWF0cml4W3N0YXJ0SW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbc3RhcnRJbmRleCArIDFdOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5zZXRDb2x1bW4gPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdCA9IE1hdHJpeDIuY2xvbmUobWF0cml4LCByZXN1bHQpOwogICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBpbmRleCAqIDI7CiAgICAgICAgcmVzdWx0W3N0YXJ0SW5kZXhdID0gY2FydGVzaWFuMTEueDsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleCArIDFdID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLmdldFJvdyA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB4ID0gbWF0cml4W2luZGV4XTsKICAgICAgICBjb25zdCB5ID0gbWF0cml4W2luZGV4ICsgMl07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLnNldFJvdyA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4Mi5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0W2luZGV4ICsgMl0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDEzID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLnNldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nU2NhbGUgPSBNYXRyaXgyLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMTMpOwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9YID0gc2NhbGUueCAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlLnkgLyBleGlzdGluZ1NjYWxlLnk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMjMgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDIuc2V0VW5pZm9ybVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nU2NhbGUgPSBNYXRyaXgyLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMjMpOwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9YID0gc2NhbGUgLyBleGlzdGluZ1NjYWxlLng7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1kgPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoQ29sdW1uMyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgTWF0cml4Mi5nZXRTY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IENhcnRlc2lhbjJfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFswXSwgbWF0cml4WzFdLCBzY3JhdGNoQ29sdW1uMykKICAgICAgICApOwogICAgICAgIHJlc3VsdC55ID0gQ2FydGVzaWFuMl9kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzJdLCBtYXRyaXhbM10sIHNjcmF0Y2hDb2x1bW4zKQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMzMgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDIuZ2V0TWF4aW11bVNjYWxlID0gZnVuY3Rpb24obWF0cml4KSB7CiAgICAgICAgTWF0cml4Mi5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDMzKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMl9kZWZhdWx0Lm1heGltdW1Db21wb25lbnQoc2NhbGVTY3JhdGNoMzMpOwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2g0MyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgTWF0cml4Mi5zZXRSb3RhdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgcm90YXRpb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBNYXRyaXgyLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoNDMpOwogICAgICAgIHJlc3VsdFswXSA9IHJvdGF0aW9uWzBdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzJdID0gcm90YXRpb25bMl0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFszXSA9IHJvdGF0aW9uWzNdICogc2NhbGUueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2g1MyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgTWF0cml4Mi5nZXRSb3RhdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2g1Myk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdIC8gc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAvIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdIC8gc2NhbGUueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLm11bHRpcGx5ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gbGVmdFswXSAqIHJpZ2h0WzBdICsgbGVmdFsyXSAqIHJpZ2h0WzFdOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbGVmdFswXSAqIHJpZ2h0WzJdICsgbGVmdFsyXSAqIHJpZ2h0WzNdOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cxID0gbGVmdFsxXSAqIHJpZ2h0WzBdICsgbGVmdFszXSAqIHJpZ2h0WzFdOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbGVmdFsxXSAqIHJpZ2h0WzJdICsgbGVmdFszXSAqIHJpZ2h0WzNdOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IGNvbHVtbjBSb3cxOwogICAgICAgIHJlc3VsdFsyXSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFszXSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gKyByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdICsgcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSArIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gKyByaWdodFszXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gLSByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdIC0gcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSAtIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gLSByaWdodFszXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLm11bHRpcGx5QnlWZWN0b3IgPSBmdW5jdGlvbihtYXRyaXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbMF0gKiBjYXJ0ZXNpYW4xMS54ICsgbWF0cml4WzJdICogY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogY2FydGVzaWFuMTEueCArIG1hdHJpeFszXSAqIGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLm11bHRpcGx5QnlTY2FsYXIgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHlCeVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5tdWx0aXBseUJ5VW5pZm9ybVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubmVnYXRlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IC1tYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gLW1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSAtbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IC1tYXRyaXhbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi50cmFuc3Bvc2UgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSBtYXRyaXhbMF07CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzEgPSBtYXRyaXhbMl07CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzAgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gY29sdW1uMFJvdzE7CiAgICAgICAgcmVzdWx0WzJdID0gY29sdW1uMVJvdzA7CiAgICAgICAgcmVzdWx0WzNdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5hYnMgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gTWF0aC5hYnMobWF0cml4WzBdKTsKICAgICAgICByZXN1bHRbMV0gPSBNYXRoLmFicyhtYXRyaXhbMV0pOwogICAgICAgIHJlc3VsdFsyXSA9IE1hdGguYWJzKG1hdHJpeFsyXSk7CiAgICAgICAgcmVzdWx0WzNdID0gTWF0aC5hYnMobWF0cml4WzNdKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnRbMF0gPT09IHJpZ2h0WzBdICYmIGxlZnRbMV0gPT09IHJpZ2h0WzFdICYmIGxlZnRbMl0gPT09IHJpZ2h0WzJdICYmIGxlZnRbM10gPT09IHJpZ2h0WzNdOwogICAgICB9OwogICAgICBNYXRyaXgyLmVxdWFsc0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIG1hdHJpeFswXSA9PT0gYXJyYXlbb2Zmc2V0XSAmJiBtYXRyaXhbMV0gPT09IGFycmF5W29mZnNldCArIDFdICYmIG1hdHJpeFsyXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMl0gJiYgbWF0cml4WzNdID09PSBhcnJheVtvZmZzZXQgKyAzXTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIGVwc2lsb24pIHsKICAgICAgICBlcHNpbG9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZXBzaWxvbiwgMCk7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIE1hdGguYWJzKGxlZnRbMF0gLSByaWdodFswXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzFdIC0gcmlnaHRbMV0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFsyXSAtIHJpZ2h0WzJdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbM10gLSByaWdodFszXSkgPD0gZXBzaWxvbjsKICAgICAgfTsKICAgICAgTWF0cml4Mi5JREVOVElUWSA9IE9iamVjdC5mcmVlemUobmV3IE1hdHJpeDIoMSwgMCwgMCwgMSkpOwogICAgICBNYXRyaXgyLlpFUk8gPSBPYmplY3QuZnJlZXplKG5ldyBNYXRyaXgyKDAsIDAsIDAsIDApKTsKICAgICAgTWF0cml4Mi5DT0xVTU4wUk9XMCA9IDA7CiAgICAgIE1hdHJpeDIuQ09MVU1OMFJPVzEgPSAxOwogICAgICBNYXRyaXgyLkNPTFVNTjFST1cwID0gMjsKICAgICAgTWF0cml4Mi5DT0xVTU4xUk9XMSA9IDM7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKE1hdHJpeDIucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbnVtYmVyIG9mIGl0ZW1zIGluIHRoZSBjb2xsZWN0aW9uLgogICAgICAgICAqIEBtZW1iZXJvZiBNYXRyaXgyLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICBsZW5ndGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRyaXgyLnBhY2tlZExlbmd0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBNYXRyaXgyLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBNYXRyaXgyLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIE1hdHJpeDIucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDIuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDIuZXF1YWxzRXBzaWxvbih0aGlzLCByaWdodCwgZXBzaWxvbik7CiAgICAgIH07CiAgICAgIE1hdHJpeDIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzWzBdfSwgJHt0aGlzWzJdfSkKKCR7dGhpc1sxXX0sICR7dGhpc1szXX0pYDsKICAgICAgfTsKICAgICAgTWF0cml4Ml9kZWZhdWx0ID0gTWF0cml4MjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1ByaW1pdGl2ZVR5cGUuanMKICB2YXIgUHJpbWl0aXZlVHlwZSwgUHJpbWl0aXZlVHlwZV9kZWZhdWx0OwogIHZhciBpbml0X1ByaW1pdGl2ZVR5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1ByaW1pdGl2ZVR5cGUuanMiKCkgewogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIFByaW1pdGl2ZVR5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogUG9pbnRzIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHZlcnRleCAob3IgaW5kZXgpIGlzIGEgc2VwYXJhdGUgcG9pbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFBPSU5UUzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5QT0lOVFMsCiAgICAgICAgLyoqCiAgICAgICAgICogTGluZXMgcHJpbWl0aXZlIHdoZXJlIGVhY2ggdHdvIHZlcnRpY2VzIChvciBpbmRpY2VzKSBpcyBhIGxpbmUgc2VnbWVudC4gIExpbmUgc2VnbWVudHMgYXJlIG5vdCBuZWNlc3NhcmlseSBjb25uZWN0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIExJTkVTOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkxJTkVTLAogICAgICAgIC8qKgogICAgICAgICAqIExpbmUgbG9vcCBwcmltaXRpdmUgd2hlcmUgZWFjaCB2ZXJ0ZXggKG9yIGluZGV4KSBhZnRlciB0aGUgZmlyc3QgY29ubmVjdHMgYSBsaW5lIHRvCiAgICAgICAgICogdGhlIHByZXZpb3VzIHZlcnRleCwgYW5kIHRoZSBsYXN0IHZlcnRleCBpbXBsaWNpdGx5IGNvbm5lY3RzIHRvIHRoZSBmaXJzdC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTElORV9MT09QOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkxJTkVfTE9PUCwKICAgICAgICAvKioKICAgICAgICAgKiBMaW5lIHN0cmlwIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHZlcnRleCAob3IgaW5kZXgpIGFmdGVyIHRoZSBmaXJzdCBjb25uZWN0cyBhIGxpbmUgdG8gdGhlIHByZXZpb3VzIHZlcnRleC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTElORV9TVFJJUDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5MSU5FX1NUUklQLAogICAgICAgIC8qKgogICAgICAgICAqIFRyaWFuZ2xlcyBwcmltaXRpdmUgd2hlcmUgZWFjaCB0aHJlZSB2ZXJ0aWNlcyAob3IgaW5kaWNlcykgaXMgYSB0cmlhbmdsZS4gIFRyaWFuZ2xlcyBkbyBub3QgbmVjZXNzYXJpbHkgc2hhcmUgZWRnZXMuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRSSUFOR0xFUzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpYW5nbGUgc3RyaXAgcHJpbWl0aXZlIHdoZXJlIGVhY2ggdmVydGV4IChvciBpbmRleCkgYWZ0ZXIgdGhlIGZpcnN0IHR3byBjb25uZWN0IHRvCiAgICAgICAgICogdGhlIHByZXZpb3VzIHR3byB2ZXJ0aWNlcyBmb3JtaW5nIGEgdHJpYW5nbGUuICBGb3IgZXhhbXBsZSwgdGhpcyBjYW4gYmUgdXNlZCB0byBtb2RlbCBhIHdhbGwuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRSSUFOR0xFX1NUUklQOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlRSSUFOR0xFX1NUUklQLAogICAgICAgIC8qKgogICAgICAgICAqIFRyaWFuZ2xlIGZhbiBwcmltaXRpdmUgd2hlcmUgZWFjaCB2ZXJ0ZXggKG9yIGluZGV4KSBhZnRlciB0aGUgZmlyc3QgdHdvIGNvbm5lY3QgdG8KICAgICAgICAgKiB0aGUgcHJldmlvdXMgdmVydGV4IGFuZCB0aGUgZmlyc3QgdmVydGV4IGZvcm1pbmcgYSB0cmlhbmdsZS4gIEZvciBleGFtcGxlLCB0aGlzIGNhbiBiZSB1c2VkCiAgICAgICAgICogdG8gbW9kZWwgYSBjb25lIG9yIGNpcmNsZS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVFJJQU5HTEVfRkFOOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlRSSUFOR0xFX0ZBTgogICAgICB9OwogICAgICBQcmltaXRpdmVUeXBlLmlzTGluZXMgPSBmdW5jdGlvbihwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgcmV0dXJuIHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuTElORVMgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FX0xPT1AgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FX1NUUklQOwogICAgICB9OwogICAgICBQcmltaXRpdmVUeXBlLmlzVHJpYW5nbGVzID0gZnVuY3Rpb24ocHJpbWl0aXZlVHlwZSkgewogICAgICAgIHJldHVybiBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLlRSSUFOR0xFUyB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLlRSSUFOR0xFX1NUUklQIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVfRkFOOwogICAgICB9OwogICAgICBQcmltaXRpdmVUeXBlLnZhbGlkYXRlID0gZnVuY3Rpb24ocHJpbWl0aXZlVHlwZSkgewogICAgICAgIHJldHVybiBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLlBPSU5UUyB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLkxJTkVTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuTElORV9MT09QIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuTElORV9TVFJJUCB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLlRSSUFOR0xFUyB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLlRSSUFOR0xFX1NUUklQIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVfRkFOOwogICAgICB9OwogICAgICBQcmltaXRpdmVUeXBlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFByaW1pdGl2ZVR5cGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnkuanMKICBmdW5jdGlvbiBHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5hdHRyaWJ1dGVzIiwgb3B0aW9ucy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlczsKICAgIHRoaXMuaW5kaWNlcyA9IG9wdGlvbnMuaW5kaWNlczsKICAgIHRoaXMucHJpbWl0aXZlVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLnByaW1pdGl2ZVR5cGUsCiAgICAgIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgICk7CiAgICB0aGlzLmJvdW5kaW5nU3BoZXJlID0gb3B0aW9ucy5ib3VuZGluZ1NwaGVyZTsKICAgIHRoaXMuZ2VvbWV0cnlUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5nZW9tZXRyeVR5cGUsIEdlb21ldHJ5VHlwZV9kZWZhdWx0Lk5PTkUpOwogICAgdGhpcy5ib3VuZGluZ1NwaGVyZUNWID0gb3B0aW9ucy5ib3VuZGluZ1NwaGVyZUNWOwogICAgdGhpcy5vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICB9CiAgdmFyIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2gsIGVudUNlbnRlclNjcmF0Y2gsIGZpeGVkRnJhbWVUb0VudVNjcmF0Y2gsIGJvdW5kaW5nUmVjdGFuZ2xlUG9pbnRzQ2FydG9ncmFwaGljU2NyYXRjaCwgYm91bmRpbmdSZWN0YW5nbGVQb2ludHNFbnVTY3JhdGNoLCBwb2ludHMyRFNjcmF0Y2gsIHBvaW50RW51U2NyYXRjaCwgZW51Um90YXRpb25TY3JhdGNoLCBlbnVSb3RhdGlvbk1hdHJpeFNjcmF0Y2gsIHJvdGF0aW9uMkRTY3JhdGNoLCBHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0dlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb21ldHJ5VHlwZSgpOwogICAgICBpbml0X01hdHJpeDIoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBHZW9tZXRyeS5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyA9IGZ1bmN0aW9uKGdlb21ldHJ5KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJnZW9tZXRyeSIsIGdlb21ldHJ5KTsKICAgICAgICBsZXQgbnVtYmVyT2ZWZXJ0aWNlcyA9IC0xOwogICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gZ2VvbWV0cnkuYXR0cmlidXRlcykgewogICAgICAgICAgaWYgKGdlb21ldHJ5LmF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpICYmIGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzW3Byb3BlcnR5XSkgJiYgZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXNbcHJvcGVydHldLnZhbHVlcykpIHsKICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlc1twcm9wZXJ0eV07CiAgICAgICAgICAgIGNvbnN0IG51bSA9IGF0dHJpYnV0ZS52YWx1ZXMubGVuZ3RoIC8gYXR0cmlidXRlLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7CiAgICAgICAgICAgIGlmIChudW1iZXJPZlZlcnRpY2VzICE9PSBudW0gJiYgbnVtYmVyT2ZWZXJ0aWNlcyAhPT0gLTEpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICAgICJBbGwgYXR0cmlidXRlIGxpc3RzIG11c3QgaGF2ZSB0aGUgc2FtZSBudW1iZXIgb2YgYXR0cmlidXRlcy4iCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBudW1iZXJPZlZlcnRpY2VzID0gbnVtOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVtYmVyT2ZWZXJ0aWNlczsKICAgICAgfTsKICAgICAgcmVjdGFuZ2xlQ2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBlbnVDZW50ZXJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmaXhlZEZyYW1lVG9FbnVTY3JhdGNoID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBib3VuZGluZ1JlY3RhbmdsZVBvaW50c0NhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBbCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCkKICAgICAgXTsKICAgICAgYm91bmRpbmdSZWN0YW5nbGVQb2ludHNFbnVTY3JhdGNoID0gWwogICAgICAgIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpCiAgICAgIF07CiAgICAgIHBvaW50czJEU2NyYXRjaCA9IFtuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpXTsKICAgICAgcG9pbnRFbnVTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbnVSb3RhdGlvblNjcmF0Y2ggPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIGVudVJvdGF0aW9uTWF0cml4U2NyYXRjaCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgcm90YXRpb24yRFNjcmF0Y2ggPSBuZXcgTWF0cml4Ml9kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5Ll90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gZnVuY3Rpb24ocG9zaXRpb25zLCBzdFJvdGF0aW9uLCBlbGxpcHNvaWQsIGJvdW5kaW5nUmVjdGFuZ2xlKSB7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlQ2VudGVyID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2VudGVyKAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICByZWN0YW5nbGVDZW50ZXJTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlbnVDZW50ZXIgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC50b0NhcnRlc2lhbigKICAgICAgICAgIHJlY3RhbmdsZUNlbnRlciwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGVudUNlbnRlclNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGVudVRvRml4ZWRGcmFtZSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSgKICAgICAgICAgIGVudUNlbnRlciwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGZpeGVkRnJhbWVUb0VudVNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGZpeGVkRnJhbWVUb0VudSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlKAogICAgICAgICAgZW51VG9GaXhlZEZyYW1lLAogICAgICAgICAgZml4ZWRGcmFtZVRvRW51U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgYm91bmRpbmdQb2ludHNFbnUgPSBib3VuZGluZ1JlY3RhbmdsZVBvaW50c0VudVNjcmF0Y2g7CiAgICAgICAgY29uc3QgYm91bmRpbmdQb2ludHNDYXJ0byA9IGJvdW5kaW5nUmVjdGFuZ2xlUG9pbnRzQ2FydG9ncmFwaGljU2NyYXRjaDsKICAgICAgICBib3VuZGluZ1BvaW50c0NhcnRvWzBdLmxvbmdpdHVkZSA9IGJvdW5kaW5nUmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgYm91bmRpbmdQb2ludHNDYXJ0b1swXS5sYXRpdHVkZSA9IGJvdW5kaW5nUmVjdGFuZ2xlLnNvdXRoOwogICAgICAgIGJvdW5kaW5nUG9pbnRzQ2FydG9bMV0ubG9uZ2l0dWRlID0gYm91bmRpbmdSZWN0YW5nbGUud2VzdDsKICAgICAgICBib3VuZGluZ1BvaW50c0NhcnRvWzFdLmxhdGl0dWRlID0gYm91bmRpbmdSZWN0YW5nbGUubm9ydGg7CiAgICAgICAgYm91bmRpbmdQb2ludHNDYXJ0b1syXS5sb25naXR1ZGUgPSBib3VuZGluZ1JlY3RhbmdsZS5lYXN0OwogICAgICAgIGJvdW5kaW5nUG9pbnRzQ2FydG9bMl0ubGF0aXR1ZGUgPSBib3VuZGluZ1JlY3RhbmdsZS5zb3V0aDsKICAgICAgICBsZXQgcG9zRW51ID0gcG9pbnRFbnVTY3JhdGNoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LnRvQ2FydGVzaWFuKGJvdW5kaW5nUG9pbnRzQ2FydG9baV0sIGVsbGlwc29pZCwgcG9zRW51KTsKICAgICAgICAgIHBvc0VudSA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvcihmaXhlZEZyYW1lVG9FbnUsIHBvc0VudSwgcG9zRW51KTsKICAgICAgICAgIGJvdW5kaW5nUG9pbnRzRW51W2ldLnggPSBwb3NFbnUueDsKICAgICAgICAgIGJvdW5kaW5nUG9pbnRzRW51W2ldLnkgPSBwb3NFbnUueTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICAtc3RSb3RhdGlvbiwKICAgICAgICAgIGVudVJvdGF0aW9uU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgZW51Um90YXRpb25NYXRyaXhTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBlbnVNaW5YID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBlbnVNaW5ZID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBlbnVNYXhYID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBlbnVNYXhZID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkrKykgewogICAgICAgICAgcG9zRW51ID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludEFzVmVjdG9yKAogICAgICAgICAgICBmaXhlZEZyYW1lVG9FbnUsCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zRW51CiAgICAgICAgICApOwogICAgICAgICAgcG9zRW51ID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IodGV4dHVyZU1hdHJpeCwgcG9zRW51LCBwb3NFbnUpOwogICAgICAgICAgZW51TWluWCA9IE1hdGgubWluKGVudU1pblgsIHBvc0VudS54KTsKICAgICAgICAgIGVudU1pblkgPSBNYXRoLm1pbihlbnVNaW5ZLCBwb3NFbnUueSk7CiAgICAgICAgICBlbnVNYXhYID0gTWF0aC5tYXgoZW51TWF4WCwgcG9zRW51LngpOwogICAgICAgICAgZW51TWF4WSA9IE1hdGgubWF4KGVudU1heFksIHBvc0VudS55KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdG9EZXNpcmVkSW5Db21wdXRlZCA9IE1hdHJpeDJfZGVmYXVsdC5mcm9tUm90YXRpb24oCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgcm90YXRpb24yRFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IHBvaW50czJEID0gcG9pbnRzMkRTY3JhdGNoOwogICAgICAgIHBvaW50czJEWzBdLnggPSBlbnVNaW5YOwogICAgICAgIHBvaW50czJEWzBdLnkgPSBlbnVNaW5ZOwogICAgICAgIHBvaW50czJEWzFdLnggPSBlbnVNaW5YOwogICAgICAgIHBvaW50czJEWzFdLnkgPSBlbnVNYXhZOwogICAgICAgIHBvaW50czJEWzJdLnggPSBlbnVNYXhYOwogICAgICAgIHBvaW50czJEWzJdLnkgPSBlbnVNaW5ZOwogICAgICAgIGNvbnN0IGJvdW5kaW5nRW51TWluID0gYm91bmRpbmdQb2ludHNFbnVbMF07CiAgICAgICAgY29uc3QgYm91bmRpbmdQb2ludHNXaWR0aCA9IGJvdW5kaW5nUG9pbnRzRW51WzJdLnggLSBib3VuZGluZ0VudU1pbi54OwogICAgICAgIGNvbnN0IGJvdW5kaW5nUG9pbnRzSGVpZ2h0ID0gYm91bmRpbmdQb2ludHNFbnVbMV0ueSAtIGJvdW5kaW5nRW51TWluLnk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgICAgY29uc3QgcG9pbnQyRCA9IHBvaW50czJEW2ldOwogICAgICAgICAgTWF0cml4Ml9kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IodG9EZXNpcmVkSW5Db21wdXRlZCwgcG9pbnQyRCwgcG9pbnQyRCk7CiAgICAgICAgICBwb2ludDJELnggPSAocG9pbnQyRC54IC0gYm91bmRpbmdFbnVNaW4ueCkgLyBib3VuZGluZ1BvaW50c1dpZHRoOwogICAgICAgICAgcG9pbnQyRC55ID0gKHBvaW50MkQueSAtIGJvdW5kaW5nRW51TWluLnkpIC8gYm91bmRpbmdQb2ludHNIZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pblhZQ29ybmVyID0gcG9pbnRzMkRbMF07CiAgICAgICAgY29uc3QgbWF4WUNvcm5lciA9IHBvaW50czJEWzFdOwogICAgICAgIGNvbnN0IG1heFhDb3JuZXIgPSBwb2ludHMyRFsyXTsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkoNik7CiAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2sobWluWFlDb3JuZXIsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2sobWF4WUNvcm5lciwgcmVzdWx0LCAyKTsKICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhtYXhYQ29ybmVyLCByZXN1bHQsIDQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5X2RlZmF1bHQgPSBHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5QXR0cmlidXRlLmpzCiAgZnVuY3Rpb24gR2VvbWV0cnlBdHRyaWJ1dGUob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLmNvbXBvbmVudERhdGF0eXBlKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5jb21wb25lbnREYXRhdHlwZSBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmIChvcHRpb25zLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPCAxIHx8IG9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSA+IDQpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSBtdXN0IGJlIGJldHdlZW4gMSBhbmQgNC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLnZhbHVlcykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMudmFsdWVzIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgdGhpcy5jb21wb25lbnREYXRhdHlwZSA9IG9wdGlvbnMuY29tcG9uZW50RGF0YXR5cGU7CiAgICB0aGlzLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBvcHRpb25zLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7CiAgICB0aGlzLm5vcm1hbGl6ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubm9ybWFsaXplLCBmYWxzZSk7CiAgICB0aGlzLnZhbHVlcyA9IG9wdGlvbnMudmFsdWVzOwogIH0KICB2YXIgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlBdHRyaWJ1dGUuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0ID0gR2VvbWV0cnlBdHRyaWJ1dGU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeUF0dHJpYnV0ZXMuanMKICBmdW5jdGlvbiBHZW9tZXRyeUF0dHJpYnV0ZXMob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLnBvc2l0aW9uID0gb3B0aW9ucy5wb3NpdGlvbjsKICAgIHRoaXMubm9ybWFsID0gb3B0aW9ucy5ub3JtYWw7CiAgICB0aGlzLnN0ID0gb3B0aW9ucy5zdDsKICAgIHRoaXMuYml0YW5nZW50ID0gb3B0aW9ucy5iaXRhbmdlbnQ7CiAgICB0aGlzLnRhbmdlbnQgPSBvcHRpb25zLnRhbmdlbnQ7CiAgICB0aGlzLmNvbG9yID0gb3B0aW9ucy5jb2xvcjsKICB9CiAgdmFyIEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0OwogIHZhciBpbml0X0dlb21ldHJ5QXR0cmlidXRlcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlBdHRyaWJ1dGVzLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQgPSBHZW9tZXRyeUF0dHJpYnV0ZXM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvU2NlbmUvQXR0cmlidXRlVHlwZS5qcwogIHZhciBBdHRyaWJ1dGVUeXBlLCBBdHRyaWJ1dGVUeXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfQXR0cmlidXRlVHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1NjZW5lL0F0dHJpYnV0ZVR5cGUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRyaXgyKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgQXR0cmlidXRlVHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgc2luZ2xlIGNvbXBvbmVudC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgU0NBTEFSOiAiU0NBTEFSIiwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgdHdvLWNvbXBvbmVudCB2ZWN0b3IuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFZFQzI6ICJWRUMyIiwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgdGhyZWUtY29tcG9uZW50IHZlY3Rvci4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVkVDMzogIlZFQzMiLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBhdHRyaWJ1dGUgaXMgYSBmb3VyLWNvbXBvbmVudCB2ZWN0b3IuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFZFQzQ6ICJWRUM0IiwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgMngyIG1hdHJpeC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTUFUMjogIk1BVDIiLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBhdHRyaWJ1dGUgaXMgYSAzeDMgbWF0cml4LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNQVQzOiAiTUFUMyIsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGF0dHJpYnV0ZSBpcyBhIDR4NCBtYXRyaXguCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE1BVDQ6ICJNQVQ0IgogICAgICB9OwogICAgICBBdHRyaWJ1dGVUeXBlLmdldE1hdGhUeXBlID0gZnVuY3Rpb24oYXR0cmlidXRlVHlwZSkgewogICAgICAgIHN3aXRjaCAoYXR0cmlidXRlVHlwZSkgewogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlNDQUxBUjoKICAgICAgICAgICAgcmV0dXJuIE51bWJlcjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMyOgogICAgICAgICAgICByZXR1cm4gQ2FydGVzaWFuMl9kZWZhdWx0OwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzM6CiAgICAgICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQ7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDNDoKICAgICAgICAgICAgcmV0dXJuIENhcnRlc2lhbjRfZGVmYXVsdDsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQyOgogICAgICAgICAgICByZXR1cm4gTWF0cml4Ml9kZWZhdWx0OwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDM6CiAgICAgICAgICAgIHJldHVybiBNYXRyaXgzX2RlZmF1bHQ7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUNDoKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDRfZGVmYXVsdDsKICAgICAgICAgIC8vPj5pbmNsdWRlU3RhcnQoJ2RlYnVnJywgcHJhZ21hcy5kZWJ1Zyk7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXR0cmlidXRlVHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZVR5cGUuZ2V0TnVtYmVyT2ZDb21wb25lbnRzID0gZnVuY3Rpb24oYXR0cmlidXRlVHlwZSkgewogICAgICAgIHN3aXRjaCAoYXR0cmlidXRlVHlwZSkgewogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlNDQUxBUjoKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMjoKICAgICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMzoKICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDNDoKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQyOgogICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQzOgogICAgICAgICAgICByZXR1cm4gOTsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQ0OgogICAgICAgICAgICByZXR1cm4gMTY7CiAgICAgICAgICAvLz4+aW5jbHVkZVN0YXJ0KCdkZWJ1ZycsIHByYWdtYXMuZGVidWcpOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZVR5cGUgaXMgbm90IGEgdmFsaWQgdmFsdWUuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICBBdHRyaWJ1dGVUeXBlLmdldEF0dHJpYnV0ZUxvY2F0aW9uQ291bnQgPSBmdW5jdGlvbihhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgc3dpdGNoIChhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuU0NBTEFSOgogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzI6CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMzoKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUM0OgogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQyOgogICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQzOgogICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQ0OgogICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgIC8vPj5pbmNsdWRlU3RhcnQoJ2RlYnVnJywgcHJhZ21hcy5kZWJ1Zyk7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXR0cmlidXRlVHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZVR5cGUuZ2V0R2xzbFR5cGUgPSBmdW5jdGlvbihhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yuc3RyaW5nKCJhdHRyaWJ1dGVUeXBlIiwgYXR0cmlidXRlVHlwZSk7CiAgICAgICAgc3dpdGNoIChhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuU0NBTEFSOgogICAgICAgICAgICByZXR1cm4gImZsb2F0IjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMyOgogICAgICAgICAgICByZXR1cm4gInZlYzIiOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzM6CiAgICAgICAgICAgIHJldHVybiAidmVjMyI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDNDoKICAgICAgICAgICAgcmV0dXJuICJ2ZWM0IjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQyOgogICAgICAgICAgICByZXR1cm4gIm1hdDIiOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDM6CiAgICAgICAgICAgIHJldHVybiAibWF0MyI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUNDoKICAgICAgICAgICAgcmV0dXJuICJtYXQ0IjsKICAgICAgICAgIC8vPj5pbmNsdWRlU3RhcnQoJ2RlYnVnJywgcHJhZ21hcy5kZWJ1Zyk7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXR0cmlidXRlVHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZVR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoQXR0cmlidXRlVHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BdHRyaWJ1dGVDb21wcmVzc2lvbi5qcwogIGZ1bmN0aW9uIGZvcmNlVWludDgodmFsdWUpIHsKICAgIHVpbnQ4Rm9yY2VBcnJheVswXSA9IHZhbHVlOwogICAgcmV0dXJuIHVpbnQ4Rm9yY2VBcnJheVswXTsKICB9CiAgZnVuY3Rpb24gemlnWmFnRGVjb2RlKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPj4gMSBeIC0odmFsdWUgJiAxKTsKICB9CiAgdmFyIFJJR0hUX1NISUZULCBMRUZUX1NISUZULCBBdHRyaWJ1dGVDb21wcmVzc2lvbiwgb2N0RW5jb2RlU2NyYXRjaCwgdWludDhGb3JjZUFycmF5LCBzY3JhdGNoRW5jb2RlQ2FydDIsIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfQXR0cmlidXRlQ29tcHJlc3Npb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0F0dHJpYnV0ZUNvbXByZXNzaW9uLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfQXR0cmlidXRlVHlwZSgpOwogICAgICBSSUdIVF9TSElGVCA9IDEgLyAyNTY7CiAgICAgIExFRlRfU0hJRlQgPSAyNTY7CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uID0ge307CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUluUmFuZ2UgPSBmdW5jdGlvbih2ZWN0b3IsIHJhbmdlTWF4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZlY3RvciIsIHZlY3Rvcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG1hZ1NxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCh2ZWN0b3IpOwogICAgICAgIGlmIChNYXRoLmFicyhtYWdTcXVhcmVkIC0gMSkgPiBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2ZWN0b3IgbXVzdCBiZSBub3JtYWxpemVkLiIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHZlY3Rvci54IC8gKE1hdGguYWJzKHZlY3Rvci54KSArIE1hdGguYWJzKHZlY3Rvci55KSArIE1hdGguYWJzKHZlY3Rvci56KSk7CiAgICAgICAgcmVzdWx0LnkgPSB2ZWN0b3IueSAvIChNYXRoLmFicyh2ZWN0b3IueCkgKyBNYXRoLmFicyh2ZWN0b3IueSkgKyBNYXRoLmFicyh2ZWN0b3IueikpOwogICAgICAgIGlmICh2ZWN0b3IueiA8IDApIHsKICAgICAgICAgIGNvbnN0IHggPSByZXN1bHQueDsKICAgICAgICAgIGNvbnN0IHkgPSByZXN1bHQueTsKICAgICAgICAgIHJlc3VsdC54ID0gKDEgLSBNYXRoLmFicyh5KSkgKiBNYXRoX2RlZmF1bHQuc2lnbk5vdFplcm8oeCk7CiAgICAgICAgICByZXN1bHQueSA9ICgxIC0gTWF0aC5hYnMoeCkpICogTWF0aF9kZWZhdWx0LnNpZ25Ob3RaZXJvKHkpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IE1hdGhfZGVmYXVsdC50b1NOb3JtKHJlc3VsdC54LCByYW5nZU1heCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoX2RlZmF1bHQudG9TTm9ybShyZXN1bHQueSwgcmFuZ2VNYXgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZSA9IGZ1bmN0aW9uKHZlY3RvciwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUluUmFuZ2UodmVjdG9yLCAyNTUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIG9jdEVuY29kZVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHVpbnQ4Rm9yY2VBcnJheSA9IG5ldyBVaW50OEFycmF5KDEpOwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGVUb0NhcnRlc2lhbjQgPSBmdW5jdGlvbih2ZWN0b3IsIHJlc3VsdCkgewogICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUluUmFuZ2UodmVjdG9yLCA2NTUzNSwgb2N0RW5jb2RlU2NyYXRjaCk7CiAgICAgICAgcmVzdWx0LnggPSBmb3JjZVVpbnQ4KG9jdEVuY29kZVNjcmF0Y2gueCAqIFJJR0hUX1NISUZUKTsKICAgICAgICByZXN1bHQueSA9IGZvcmNlVWludDgob2N0RW5jb2RlU2NyYXRjaC54KTsKICAgICAgICByZXN1bHQueiA9IGZvcmNlVWludDgob2N0RW5jb2RlU2NyYXRjaC55ICogUklHSFRfU0hJRlQpOwogICAgICAgIHJlc3VsdC53ID0gZm9yY2VVaW50OChvY3RFbmNvZGVTY3JhdGNoLnkpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUluUmFuZ2UgPSBmdW5jdGlvbih4LCB5LCByYW5nZU1heCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGlmICh4IDwgMCB8fCB4ID4gcmFuZ2VNYXggfHwgeSA8IDAgfHwgeSA+IHJhbmdlTWF4KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYHggYW5kIHkgbXVzdCBiZSB1bnNpZ25lZCBub3JtYWxpemVkIGludGVnZXJzIGJldHdlZW4gMCBhbmQgJHtyYW5nZU1heH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IE1hdGhfZGVmYXVsdC5mcm9tU05vcm0oeCwgcmFuZ2VNYXgpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aF9kZWZhdWx0LmZyb21TTm9ybSh5LCByYW5nZU1heCk7CiAgICAgICAgcmVzdWx0LnogPSAxIC0gKE1hdGguYWJzKHJlc3VsdC54KSArIE1hdGguYWJzKHJlc3VsdC55KSk7CiAgICAgICAgaWYgKHJlc3VsdC56IDwgMCkgewogICAgICAgICAgY29uc3Qgb2xkVlggPSByZXN1bHQueDsKICAgICAgICAgIHJlc3VsdC54ID0gKDEgLSBNYXRoLmFicyhyZXN1bHQueSkpICogTWF0aF9kZWZhdWx0LnNpZ25Ob3RaZXJvKG9sZFZYKTsKICAgICAgICAgIHJlc3VsdC55ID0gKDEgLSBNYXRoLmFicyhvbGRWWCkpICogTWF0aF9kZWZhdWx0LnNpZ25Ob3RaZXJvKHJlc3VsdC55KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGUgPSBmdW5jdGlvbih4LCB5LCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlSW5SYW5nZSh4LCB5LCAyNTUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUZyb21DYXJ0ZXNpYW40ID0gZnVuY3Rpb24oZW5jb2RlZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmNvZGVkIiwgZW5jb2RlZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBlbmNvZGVkLng7CiAgICAgICAgY29uc3QgeSA9IGVuY29kZWQueTsKICAgICAgICBjb25zdCB6ID0gZW5jb2RlZC56OwogICAgICAgIGNvbnN0IHcgPSBlbmNvZGVkLnc7CiAgICAgICAgaWYgKHggPCAwIHx8IHggPiAyNTUgfHwgeSA8IDAgfHwgeSA+IDI1NSB8fCB6IDwgMCB8fCB6ID4gMjU1IHx8IHcgPCAwIHx8IHcgPiAyNTUpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAieCwgeSwgeiwgYW5kIHcgbXVzdCBiZSB1bnNpZ25lZCBub3JtYWxpemVkIGludGVnZXJzIGJldHdlZW4gMCBhbmQgMjU1IgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgeE9jdDE2ID0geCAqIExFRlRfU0hJRlQgKyB5OwogICAgICAgIGNvbnN0IHlPY3QxNiA9IHogKiBMRUZUX1NISUZUICsgdzsKICAgICAgICByZXR1cm4gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlSW5SYW5nZSh4T2N0MTYsIHlPY3QxNiwgNjU1MzUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdFBhY2tGbG9hdCA9IGZ1bmN0aW9uKGVuY29kZWQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImVuY29kZWQiLCBlbmNvZGVkKTsKICAgICAgICByZXR1cm4gMjU2ICogZW5jb2RlZC54ICsgZW5jb2RlZC55OwogICAgICB9OwogICAgICBzY3JhdGNoRW5jb2RlQ2FydDIgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUZsb2F0ID0gZnVuY3Rpb24odmVjdG9yKSB7CiAgICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlKHZlY3Rvciwgc2NyYXRjaEVuY29kZUNhcnQyKTsKICAgICAgICByZXR1cm4gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0UGFja0Zsb2F0KHNjcmF0Y2hFbmNvZGVDYXJ0Mik7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUZsb2F0ID0gZnVuY3Rpb24odmFsdWUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgY29uc3QgdGVtcCA9IHZhbHVlIC8gMjU2OwogICAgICAgIGNvbnN0IHggPSBNYXRoLmZsb29yKHRlbXApOwogICAgICAgIGNvbnN0IHkgPSAodGVtcCAtIHgpICogMjU2OwogICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGUoeCwgeSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0UGFjayA9IGZ1bmN0aW9uKHYxMiwgdjIyLCB2MywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MSIsIHYxMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MiIsIHYyMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MyIsIHYzKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZW5jb2RlZDEgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGVGbG9hdCh2MTIpOwogICAgICAgIGNvbnN0IGVuY29kZWQyID0gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlRmxvYXQodjIyKTsKICAgICAgICBjb25zdCBlbmNvZGVkMyA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZSh2Mywgc2NyYXRjaEVuY29kZUNhcnQyKTsKICAgICAgICByZXN1bHQueCA9IDY1NTM2ICogZW5jb2RlZDMueCArIGVuY29kZWQxOwogICAgICAgIHJlc3VsdC55ID0gNjU1MzYgKiBlbmNvZGVkMy55ICsgZW5jb2RlZDI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0VW5wYWNrID0gZnVuY3Rpb24ocGFja2VkLCB2MTIsIHYyMiwgdjMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBhY2tlZCIsIHBhY2tlZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MSIsIHYxMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MiIsIHYyMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MyIsIHYzKTsKICAgICAgICBsZXQgdGVtcCA9IHBhY2tlZC54IC8gNjU1MzY7CiAgICAgICAgY29uc3QgeCA9IE1hdGguZmxvb3IodGVtcCk7CiAgICAgICAgY29uc3QgZW5jb2RlZEZsb2F0MSA9ICh0ZW1wIC0geCkgKiA2NTUzNjsKICAgICAgICB0ZW1wID0gcGFja2VkLnkgLyA2NTUzNjsKICAgICAgICBjb25zdCB5ID0gTWF0aC5mbG9vcih0ZW1wKTsKICAgICAgICBjb25zdCBlbmNvZGVkRmxvYXQyID0gKHRlbXAgLSB5KSAqIDY1NTM2OwogICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUZsb2F0KGVuY29kZWRGbG9hdDEsIHYxMik7CiAgICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlRmxvYXQoZW5jb2RlZEZsb2F0MiwgdjIyKTsKICAgICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGUoeCwgeSwgdjMpOwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcyA9IGZ1bmN0aW9uKHRleHR1cmVDb29yZGluYXRlcykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidGV4dHVyZUNvb3JkaW5hdGVzIiwgdGV4dHVyZUNvb3JkaW5hdGVzKTsKICAgICAgICBjb25zdCB4ID0gdGV4dHVyZUNvb3JkaW5hdGVzLnggKiA0MDk1IHwgMDsKICAgICAgICBjb25zdCB5ID0gdGV4dHVyZUNvb3JkaW5hdGVzLnkgKiA0MDk1IHwgMDsKICAgICAgICByZXR1cm4gNDA5NiAqIHggKyB5OwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5kZWNvbXByZXNzVGV4dHVyZUNvb3JkaW5hdGVzID0gZnVuY3Rpb24oY29tcHJlc3NlZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjb21wcmVzc2VkIiwgY29tcHJlc3NlZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHRlbXAgPSBjb21wcmVzc2VkIC8gNDA5NjsKICAgICAgICBjb25zdCB4WmVyb1RvNDA5NSA9IE1hdGguZmxvb3IodGVtcCk7CiAgICAgICAgcmVzdWx0LnggPSB4WmVyb1RvNDA5NSAvIDQwOTU7CiAgICAgICAgcmVzdWx0LnkgPSAoY29tcHJlc3NlZCAtIHhaZXJvVG80MDk1ICogNDA5NikgLyA0MDk1OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLnppZ1phZ0RlbHRhRGVjb2RlID0gZnVuY3Rpb24odUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ1QnVmZmVyIiwgdUJ1ZmZlcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2QnVmZmVyIiwgdkJ1ZmZlcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmVxdWFscygKICAgICAgICAgICJ1QnVmZmVyLmxlbmd0aCIsCiAgICAgICAgICAidkJ1ZmZlci5sZW5ndGgiLAogICAgICAgICAgdUJ1ZmZlci5sZW5ndGgsCiAgICAgICAgICB2QnVmZmVyLmxlbmd0aAogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChoZWlnaHRCdWZmZXIpKSB7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZXF1YWxzKAogICAgICAgICAgICAidUJ1ZmZlci5sZW5ndGgiLAogICAgICAgICAgICAiaGVpZ2h0QnVmZmVyLmxlbmd0aCIsCiAgICAgICAgICAgIHVCdWZmZXIubGVuZ3RoLAogICAgICAgICAgICBoZWlnaHRCdWZmZXIubGVuZ3RoCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb3VudCA9IHVCdWZmZXIubGVuZ3RoOwogICAgICAgIGxldCB1MyA9IDA7CiAgICAgICAgbGV0IHYzID0gMDsKICAgICAgICBsZXQgaGVpZ2h0ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyArK2kpIHsKICAgICAgICAgIHUzICs9IHppZ1phZ0RlY29kZSh1QnVmZmVyW2ldKTsKICAgICAgICAgIHYzICs9IHppZ1phZ0RlY29kZSh2QnVmZmVyW2ldKTsKICAgICAgICAgIHVCdWZmZXJbaV0gPSB1MzsKICAgICAgICAgIHZCdWZmZXJbaV0gPSB2MzsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGVpZ2h0QnVmZmVyKSkgewogICAgICAgICAgICBoZWlnaHQgKz0gemlnWmFnRGVjb2RlKGhlaWdodEJ1ZmZlcltpXSk7CiAgICAgICAgICAgIGhlaWdodEJ1ZmZlcltpXSA9IGhlaWdodDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLmRlcXVhbnRpemUgPSBmdW5jdGlvbih0eXBlZEFycmF5LCBjb21wb25lbnREYXRhdHlwZSwgdHlwZSwgY291bnQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInR5cGVkQXJyYXkiLCB0eXBlZEFycmF5KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvbXBvbmVudERhdGF0eXBlIiwgY29tcG9uZW50RGF0YXR5cGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidHlwZSIsIHR5cGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY291bnQiLCBjb3VudCk7CiAgICAgICAgY29uc3QgY29tcG9uZW50c1BlckF0dHJpYnV0ZSA9IEF0dHJpYnV0ZVR5cGVfZGVmYXVsdC5nZXROdW1iZXJPZkNvbXBvbmVudHModHlwZSk7CiAgICAgICAgbGV0IGRpdmlzb3I7CiAgICAgICAgc3dpdGNoIChjb21wb25lbnREYXRhdHlwZSkgewogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkJZVEU6CiAgICAgICAgICAgIGRpdmlzb3IgPSAxMjc7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIGRpdmlzb3IgPSAyNTU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlNIT1JUOgogICAgICAgICAgICBkaXZpc29yID0gMzI3Njc7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICBkaXZpc29yID0gNjU1MzU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LklOVDoKICAgICAgICAgICAgZGl2aXNvciA9IDIxNDc0ODM2NDc7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgZGl2aXNvciA9IDQyOTQ5NjcyOTU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgLy8+PmluY2x1ZGVTdGFydCgnZGVidWcnLCBwcmFnbWFzLmRlYnVnKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgIGBDYW5ub3QgZGVxdWFudGl6ZSBjb21wb25lbnQgZGF0YXR5cGU6ICR7Y29tcG9uZW50RGF0YXR5cGV9YAogICAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBkZXF1YW50aXplZFR5cGVkQXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KAogICAgICAgICAgY291bnQgKiBjb21wb25lbnRzUGVyQXR0cmlidXRlCiAgICAgICAgKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgY29tcG9uZW50c1BlckF0dHJpYnV0ZTsgaisrKSB7CiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAqIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgKyBqOwogICAgICAgICAgICBkZXF1YW50aXplZFR5cGVkQXJyYXlbaW5kZXhdID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgdHlwZWRBcnJheVtpbmRleF0gLyBkaXZpc29yLAogICAgICAgICAgICAgIC0xCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZXF1YW50aXplZFR5cGVkQXJyYXk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLmRlY29kZVJHQjU2NSA9IGZ1bmN0aW9uKHR5cGVkQXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidHlwZWRBcnJheSIsIHR5cGVkQXJyYXkpOwogICAgICAgIGNvbnN0IGV4cGVjdGVkTGVuZ3RoID0gdHlwZWRBcnJheS5sZW5ndGggKiAzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmVxdWFscygKICAgICAgICAgICAgInJlc3VsdC5sZW5ndGgiLAogICAgICAgICAgICAidHlwZWRBcnJheS5sZW5ndGggKiAzIiwKICAgICAgICAgICAgcmVzdWx0Lmxlbmd0aCwKICAgICAgICAgICAgZXhwZWN0ZWRMZW5ndGgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvdW50ID0gdHlwZWRBcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEZsb2F0MzJBcnJheShjb3VudCAqIDMpOwogICAgICAgIH0KICAgICAgICBjb25zdCBtYXNrNSA9ICgxIDw8IDUpIC0gMTsKICAgICAgICBjb25zdCBtYXNrNiA9ICgxIDw8IDYpIC0gMTsKICAgICAgICBjb25zdCBub3JtYWxpemU1ID0gMSAvIDMxOwogICAgICAgIGNvbnN0IG5vcm1hbGl6ZTYgPSAxIC8gNjM7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHR5cGVkQXJyYXlbaV07CiAgICAgICAgICBjb25zdCByZWQgPSB2YWx1ZSA+PiAxMTsKICAgICAgICAgIGNvbnN0IGdyZWVuID0gdmFsdWUgPj4gNSAmIG1hc2s2OwogICAgICAgICAgY29uc3QgYmx1ZSA9IHZhbHVlICYgbWFzazU7CiAgICAgICAgICBjb25zdCBvZmZzZXQgPSAzICogaTsKICAgICAgICAgIHJlc3VsdFtvZmZzZXRdID0gcmVkICogbm9ybWFsaXplNTsKICAgICAgICAgIHJlc3VsdFtvZmZzZXQgKyAxXSA9IGdyZWVuICogbm9ybWFsaXplNjsKICAgICAgICAgIHJlc3VsdFtvZmZzZXQgKyAyXSA9IGJsdWUgKiBub3JtYWxpemU1OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0ID0gQXR0cmlidXRlQ29tcHJlc3Npb247CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9iYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzLmpzCiAgZnVuY3Rpb24gYmFyeWNlbnRyaWNDb29yZGluYXRlcyhwb2ludCwgcDAsIHAxLCBwMiwgcmVzdWx0KSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvaW50IiwgcG9pbnQpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwMCIsIHAwKTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicDEiLCBwMSk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInAyIiwgcDIpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICB9CiAgICBsZXQgdjAyOwogICAgbGV0IHYxMjsKICAgIGxldCB2MjI7CiAgICBsZXQgZG90MDA7CiAgICBsZXQgZG90MDE7CiAgICBsZXQgZG90MDI7CiAgICBsZXQgZG90MTE7CiAgICBsZXQgZG90MTI7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMC56KSkgewogICAgICBpZiAoQ2FydGVzaWFuMl9kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocG9pbnQsIHAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgcmVzdWx0KTsKICAgICAgfQogICAgICBpZiAoQ2FydGVzaWFuMl9kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocG9pbnQsIHAxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwgcmVzdWx0KTsKICAgICAgfQogICAgICBpZiAoQ2FydGVzaWFuMl9kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocG9pbnQsIHAyLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgcmVzdWx0KTsKICAgICAgfQogICAgICB2MDIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3QocDEsIHAwLCBzY3JhdGNoQ2FydGVzaWFuMSk7CiAgICAgIHYxMiA9IENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcDAsIHNjcmF0Y2hDYXJ0ZXNpYW4yKTsKICAgICAgdjIyID0gQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KHBvaW50LCBwMCwgc2NyYXRjaENhcnRlc2lhbjMyKTsKICAgICAgZG90MDAgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYwMiwgdjAyKTsKICAgICAgZG90MDEgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYwMiwgdjEyKTsKICAgICAgZG90MDIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYwMiwgdjIyKTsKICAgICAgZG90MTEgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYxMiwgdjEyKTsKICAgICAgZG90MTIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYxMiwgdjIyKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwb2ludCwgcDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCByZXN1bHQpOwogICAgICB9CiAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwb2ludCwgcDEsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLCByZXN1bHQpOwogICAgICB9CiAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwb2ludCwgcDIsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCByZXN1bHQpOwogICAgICB9CiAgICAgIHYwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcDAsIHNjcmF0Y2hDYXJ0ZXNpYW4xKTsKICAgICAgdjEyID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAyLCBwMCwgc2NyYXRjaENhcnRlc2lhbjIpOwogICAgICB2MjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9pbnQsIHAwLCBzY3JhdGNoQ2FydGVzaWFuMzIpOwogICAgICBkb3QwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjAyLCB2MDIpOwogICAgICBkb3QwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjAyLCB2MTIpOwogICAgICBkb3QwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjAyLCB2MjIpOwogICAgICBkb3QxMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjEyLCB2MTIpOwogICAgICBkb3QxMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjEyLCB2MjIpOwogICAgfQogICAgcmVzdWx0LnkgPSBkb3QxMSAqIGRvdDAyIC0gZG90MDEgKiBkb3QxMjsKICAgIHJlc3VsdC56ID0gZG90MDAgKiBkb3QxMiAtIGRvdDAxICogZG90MDI7CiAgICBjb25zdCBxID0gZG90MDAgKiBkb3QxMSAtIGRvdDAxICogZG90MDE7CiAgICBpZiAocSA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgcmVzdWx0LnkgLz0gcTsKICAgIHJlc3VsdC56IC89IHE7CiAgICByZXN1bHQueCA9IDEgLSByZXN1bHQueSAtIHJlc3VsdC56OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xLCBzY3JhdGNoQ2FydGVzaWFuMiwgc2NyYXRjaENhcnRlc2lhbjMyLCBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfYmFyeWNlbnRyaWNDb29yZGluYXRlcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYmFyeWNlbnRyaWNDb29yZGluYXRlcy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzX2RlZmF1bHQgPSBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRW5jb2RlZENhcnRlc2lhbjMuanMKICBmdW5jdGlvbiBFbmNvZGVkQ2FydGVzaWFuMygpIHsKICAgIHRoaXMuaGlnaCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICB0aGlzLmxvdyA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgfQogIHZhciBzY3JhdGNoRW5jb2RlLCBlbmNvZGVkUCwgRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdDsKICB2YXIgaW5pdF9FbmNvZGVkQ2FydGVzaWFuMyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRW5jb2RlZENhcnRlc2lhbjMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgRW5jb2RlZENhcnRlc2lhbjMuZW5jb2RlID0gZnVuY3Rpb24odmFsdWUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgICBoaWdoOiAwLAogICAgICAgICAgICBsb3c6IDAKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGxldCBkb3VibGVIaWdoOwogICAgICAgIGlmICh2YWx1ZSA+PSAwKSB7CiAgICAgICAgICBkb3VibGVIaWdoID0gTWF0aC5mbG9vcih2YWx1ZSAvIDY1NTM2KSAqIDY1NTM2OwogICAgICAgICAgcmVzdWx0LmhpZ2ggPSBkb3VibGVIaWdoOwogICAgICAgICAgcmVzdWx0LmxvdyA9IHZhbHVlIC0gZG91YmxlSGlnaDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG91YmxlSGlnaCA9IE1hdGguZmxvb3IoLXZhbHVlIC8gNjU1MzYpICogNjU1MzY7CiAgICAgICAgICByZXN1bHQuaGlnaCA9IC1kb3VibGVIaWdoOwogICAgICAgICAgcmVzdWx0LmxvdyA9IHZhbHVlICsgZG91YmxlSGlnaDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEVuY29kZSA9IHsKICAgICAgICBoaWdoOiAwLAogICAgICAgIGxvdzogMAogICAgICB9OwogICAgICBFbmNvZGVkQ2FydGVzaWFuMy5mcm9tQ2FydGVzaWFuID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBFbmNvZGVkQ2FydGVzaWFuMygpOwogICAgICAgIH0KICAgICAgICBjb25zdCBoaWdoID0gcmVzdWx0LmhpZ2g7CiAgICAgICAgY29uc3QgbG93ID0gcmVzdWx0LmxvdzsKICAgICAgICBFbmNvZGVkQ2FydGVzaWFuMy5lbmNvZGUoY2FydGVzaWFuMTEueCwgc2NyYXRjaEVuY29kZSk7CiAgICAgICAgaGlnaC54ID0gc2NyYXRjaEVuY29kZS5oaWdoOwogICAgICAgIGxvdy54ID0gc2NyYXRjaEVuY29kZS5sb3c7CiAgICAgICAgRW5jb2RlZENhcnRlc2lhbjMuZW5jb2RlKGNhcnRlc2lhbjExLnksIHNjcmF0Y2hFbmNvZGUpOwogICAgICAgIGhpZ2gueSA9IHNjcmF0Y2hFbmNvZGUuaGlnaDsKICAgICAgICBsb3cueSA9IHNjcmF0Y2hFbmNvZGUubG93OwogICAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zLmVuY29kZShjYXJ0ZXNpYW4xMS56LCBzY3JhdGNoRW5jb2RlKTsKICAgICAgICBoaWdoLnogPSBzY3JhdGNoRW5jb2RlLmhpZ2g7CiAgICAgICAgbG93LnogPSBzY3JhdGNoRW5jb2RlLmxvdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBlbmNvZGVkUCA9IG5ldyBFbmNvZGVkQ2FydGVzaWFuMygpOwogICAgICBFbmNvZGVkQ2FydGVzaWFuMy53cml0ZUVsZW1lbnRzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIGNhcnRlc2lhbkFycmF5LCBpbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFuQXJyYXkiLCBjYXJ0ZXNpYW5BcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJpbmRleCIsIGluZGV4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgRW5jb2RlZENhcnRlc2lhbjMuZnJvbUNhcnRlc2lhbihjYXJ0ZXNpYW4xMSwgZW5jb2RlZFApOwogICAgICAgIGNvbnN0IGhpZ2ggPSBlbmNvZGVkUC5oaWdoOwogICAgICAgIGNvbnN0IGxvdyA9IGVuY29kZWRQLmxvdzsKICAgICAgICBjYXJ0ZXNpYW5BcnJheVtpbmRleF0gPSBoaWdoLng7CiAgICAgICAgY2FydGVzaWFuQXJyYXlbaW5kZXggKyAxXSA9IGhpZ2gueTsKICAgICAgICBjYXJ0ZXNpYW5BcnJheVtpbmRleCArIDJdID0gaGlnaC56OwogICAgICAgIGNhcnRlc2lhbkFycmF5W2luZGV4ICsgM10gPSBsb3cueDsKICAgICAgICBjYXJ0ZXNpYW5BcnJheVtpbmRleCArIDRdID0gbG93Lnk7CiAgICAgICAgY2FydGVzaWFuQXJyYXlbaW5kZXggKyA1XSA9IGxvdy56OwogICAgICB9OwogICAgICBFbmNvZGVkQ2FydGVzaWFuM19kZWZhdWx0ID0gRW5jb2RlZENhcnRlc2lhbjM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbmRleERhdGF0eXBlLmpzCiAgdmFyIEluZGV4RGF0YXR5cGUsIEluZGV4RGF0YXR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9JbmRleERhdGF0eXBlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbmRleERhdGF0eXBlLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfV2ViR0xDb25zdGFudHMoKTsKICAgICAgSW5kZXhEYXRhdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiA4LWJpdCB1bnNpZ25lZCBieXRlIGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+VU5TSUdORURfQllURTwvY29kZT4gYW5kIHRoZSB0eXBlCiAgICAgICAgICogb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5VaW50OEFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVU5TSUdORURfQllURTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIC8qKgogICAgICAgICAqIDE2LWJpdCB1bnNpZ25lZCBzaG9ydCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX1NIT1JUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQxNkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVU5TSUdORURfU0hPUlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlQsCiAgICAgICAgLyoqCiAgICAgICAgICogMzItYml0IHVuc2lnbmVkIGludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX0lOVDwvY29kZT4gYW5kIHRoZSB0eXBlCiAgICAgICAgICogb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5VaW50MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVOU0lHTkVEX0lOVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9JTlQKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZS5nZXRTaXplSW5CeXRlcyA9IGZ1bmN0aW9uKGluZGV4RGF0YXR5cGUpIHsKICAgICAgICBzd2l0Y2ggKGluZGV4RGF0YXR5cGUpIHsKICAgICAgICAgIGNhc2UgSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9CWVRFOgogICAgICAgICAgICByZXR1cm4gVWludDhBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgICAgIGNhc2UgSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIFVpbnQxNkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJpbmRleERhdGF0eXBlIGlzIHJlcXVpcmVkIGFuZCBtdXN0IGJlIGEgdmFsaWQgSW5kZXhEYXRhdHlwZSBjb25zdGFudC4iCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZS5mcm9tU2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihzaXplSW5CeXRlcykgewogICAgICAgIHN3aXRjaCAoc2l6ZUluQnl0ZXMpIHsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0lOVDsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfQllURTsKICAgICAgICAgIC8vPj5pbmNsdWRlU3RhcnQoJ2RlYnVnJywgcHJhZ21hcy5kZWJ1Zyk7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICAiU2l6ZSBpbiBieXRlcyBjYW5ub3QgYmUgbWFwcGVkIHRvIGFuIEluZGV4RGF0YXR5cGUiCiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9OwogICAgICBJbmRleERhdGF0eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24oaW5kZXhEYXRhdHlwZSkgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoaW5kZXhEYXRhdHlwZSkgJiYgKGluZGV4RGF0YXR5cGUgPT09IEluZGV4RGF0YXR5cGUuVU5TSUdORURfQllURSB8fCBpbmRleERhdGF0eXBlID09PSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUIHx8IGluZGV4RGF0YXR5cGUgPT09IEluZGV4RGF0YXR5cGUuVU5TSUdORURfSU5UKTsKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZS5jcmVhdGVUeXBlZEFycmF5ID0gZnVuY3Rpb24obnVtYmVyT2ZWZXJ0aWNlcywgaW5kaWNlc0xlbmd0aE9yQXJyYXkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChudW1iZXJPZlZlcnRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm51bWJlck9mVmVydGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChudW1iZXJPZlZlcnRpY2VzID49IE1hdGhfZGVmYXVsdC5TSVhUWV9GT1VSX0tJTE9CWVRFUykgewogICAgICAgICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheShpbmRpY2VzTGVuZ3RoT3JBcnJheSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkoaW5kaWNlc0xlbmd0aE9yQXJyYXkpOwogICAgICB9OwogICAgICBJbmRleERhdGF0eXBlLmNyZWF0ZVR5cGVkQXJyYXlGcm9tQXJyYXlCdWZmZXIgPSBmdW5jdGlvbihudW1iZXJPZlZlcnRpY2VzLCBzb3VyY2VBcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobnVtYmVyT2ZWZXJ0aWNlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJudW1iZXJPZlZlcnRpY2VzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzb3VyY2VBcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzb3VyY2VBcnJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnl0ZU9mZnNldCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJieXRlT2Zmc2V0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA+PSBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgIHJldHVybiBuZXcgVWludDMyQXJyYXkoc291cmNlQXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkoc291cmNlQXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgIH07CiAgICAgIEluZGV4RGF0YXR5cGUuZnJvbVR5cGVkQXJyYXkgPSBmdW5jdGlvbihhcnJheSkgewogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0JZVEU7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQxNkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9TSE9SVDsKICAgICAgICB9CiAgICAgICAgaWYgKGFycmF5IGluc3RhbmNlb2YgVWludDMyQXJyYXkpIHsKICAgICAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0lOVDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiYXJyYXkgbXVzdCBiZSBhIFVpbnQ4QXJyYXksIFVpbnQxNkFycmF5LCBvciBVaW50MzJBcnJheS4iCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShJbmRleERhdGF0eXBlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmpzCiAgZnVuY3Rpb24gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrKGxlZnQsIHJpZ2h0LCB0b2xlcmFuY2UpIHsKICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBsZWZ0ICsgcmlnaHQ7CiAgICBpZiAoTWF0aF9kZWZhdWx0LnNpZ24obGVmdCkgIT09IE1hdGhfZGVmYXVsdC5zaWduKHJpZ2h0KSAmJiBNYXRoLmFicyhkaWZmZXJlbmNlIC8gTWF0aC5tYXgoTWF0aC5hYnMobGVmdCksIE1hdGguYWJzKHJpZ2h0KSkpIDwgdG9sZXJhbmNlKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgcmV0dXJuIGRpZmZlcmVuY2U7CiAgfQogIHZhciBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbCwgUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdDsKICB2YXIgaW5pdF9RdWFkcmF0aWNSZWFsUG9seW5vbWlhbCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhZHJhdGljUmVhbFBvbHlub21pYWwuanMiKCkgewogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbCA9IHt9OwogICAgICBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlRGlzY3JpbWluYW50ID0gZnVuY3Rpb24oYTMsIGIsIGMpIHsKICAgICAgICBpZiAodHlwZW9mIGEzICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYyBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGlzY3JpbWluYW50ID0gYiAqIGIgLSA0ICogYTMgKiBjOwogICAgICAgIHJldHVybiBkaXNjcmltaW5hbnQ7CiAgICAgIH07CiAgICAgIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMgPSBmdW5jdGlvbihhMywgYiwgYykgewogICAgICAgIGlmICh0eXBlb2YgYTMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgcmF0aW87CiAgICAgICAgaWYgKGEzID09PSAwKSB7CiAgICAgICAgICBpZiAoYiA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gWy1jIC8gYl07CiAgICAgICAgfSBlbHNlIGlmIChiID09PSAwKSB7CiAgICAgICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gWzAsIDBdOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgY01hZ25pdHVkZSA9IE1hdGguYWJzKGMpOwogICAgICAgICAgY29uc3QgYU1hZ25pdHVkZSA9IE1hdGguYWJzKGEzKTsKICAgICAgICAgIGlmIChjTWFnbml0dWRlIDwgYU1hZ25pdHVkZSAmJiBjTWFnbml0dWRlIC8gYU1hZ25pdHVkZSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpIHsKICAgICAgICAgICAgcmV0dXJuIFswLCAwXTsKICAgICAgICAgIH0gZWxzZSBpZiAoY01hZ25pdHVkZSA+IGFNYWduaXR1ZGUgJiYgYU1hZ25pdHVkZSAvIGNNYWduaXR1ZGUgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgIH0KICAgICAgICAgIHJhdGlvID0gLWMgLyBhMzsKICAgICAgICAgIGlmIChyYXRpbyA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgcm9vdCA9IE1hdGguc3FydChyYXRpbyk7CiAgICAgICAgICByZXR1cm4gWy1yb290LCByb290XTsKICAgICAgICB9IGVsc2UgaWYgKGMgPT09IDApIHsKICAgICAgICAgIHJhdGlvID0gLWIgLyBhMzsKICAgICAgICAgIGlmIChyYXRpbyA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIFtyYXRpbywgMF07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gWzAsIHJhdGlvXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYjIgPSBiICogYjsKICAgICAgICBjb25zdCBmb3VyX2FjID0gNCAqIGEzICogYzsKICAgICAgICBjb25zdCByYWRpY2FuZCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjayhiMiwgLWZvdXJfYWMsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpOwogICAgICAgIGlmIChyYWRpY2FuZCA8IDApIHsKICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcSA9IC0wLjUgKiBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2soCiAgICAgICAgICBiLAogICAgICAgICAgTWF0aF9kZWZhdWx0LnNpZ24oYikgKiBNYXRoLnNxcnQocmFkaWNhbmQpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xNAogICAgICAgICk7CiAgICAgICAgaWYgKGIgPiAwKSB7CiAgICAgICAgICByZXR1cm4gW3EgLyBhMywgYyAvIHFdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW2MgLyBxLCBxIC8gYTNdOwogICAgICB9OwogICAgICBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0ID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWw7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DdWJpY1JlYWxQb2x5bm9taWFsLmpzCiAgZnVuY3Rpb24gY29tcHV0ZVJlYWxSb290cyhhMywgYiwgYywgZCkgewogICAgY29uc3QgQSA9IGEzOwogICAgY29uc3QgQiA9IGIgLyAzOwogICAgY29uc3QgQyA9IGMgLyAzOwogICAgY29uc3QgRCA9IGQ7CiAgICBjb25zdCBBQyA9IEEgKiBDOwogICAgY29uc3QgQkQgPSBCICogRDsKICAgIGNvbnN0IEIyID0gQiAqIEI7CiAgICBjb25zdCBDMiA9IEMgKiBDOwogICAgY29uc3QgZGVsdGExID0gQSAqIEMgLSBCMjsKICAgIGNvbnN0IGRlbHRhMiA9IEEgKiBEIC0gQiAqIEM7CiAgICBjb25zdCBkZWx0YTMgPSBCICogRCAtIEMyOwogICAgY29uc3QgZGlzY3JpbWluYW50ID0gNCAqIGRlbHRhMSAqIGRlbHRhMyAtIGRlbHRhMiAqIGRlbHRhMjsKICAgIGxldCB0ZW1wOwogICAgbGV0IHRlbXAxOwogICAgaWYgKGRpc2NyaW1pbmFudCA8IDApIHsKICAgICAgbGV0IEFCYXI7CiAgICAgIGxldCBDQmFyOwogICAgICBsZXQgREJhcjsKICAgICAgaWYgKEIyICogQkQgPj0gQUMgKiBDMikgewogICAgICAgIEFCYXIgPSBBOwogICAgICAgIENCYXIgPSBkZWx0YTE7CiAgICAgICAgREJhciA9IC0yICogQiAqIGRlbHRhMSArIEEgKiBkZWx0YTI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgQUJhciA9IEQ7CiAgICAgICAgQ0JhciA9IGRlbHRhMzsKICAgICAgICBEQmFyID0gLUQgKiBkZWx0YTIgKyAyICogQyAqIGRlbHRhMzsKICAgICAgfQogICAgICBjb25zdCBzID0gREJhciA8IDAgPyAtMSA6IDE7CiAgICAgIGNvbnN0IHRlbXAwID0gLXMgKiBNYXRoLmFicyhBQmFyKSAqIE1hdGguc3FydCgtZGlzY3JpbWluYW50KTsKICAgICAgdGVtcDEgPSAtREJhciArIHRlbXAwOwogICAgICBjb25zdCB4ID0gdGVtcDEgLyAyOwogICAgICBjb25zdCBwID0geCA8IDAgPyAtTWF0aC5wb3coLXgsIDEgLyAzKSA6IE1hdGgucG93KHgsIDEgLyAzKTsKICAgICAgY29uc3QgcSA9IHRlbXAxID09PSB0ZW1wMCA/IC1wIDogLUNCYXIgLyBwOwogICAgICB0ZW1wID0gQ0JhciA8PSAwID8gcCArIHEgOiAtREJhciAvIChwICogcCArIHEgKiBxICsgQ0Jhcik7CiAgICAgIGlmIChCMiAqIEJEID49IEFDICogQzIpIHsKICAgICAgICByZXR1cm4gWyh0ZW1wIC0gQikgLyBBXTsKICAgICAgfQogICAgICByZXR1cm4gWy1EIC8gKHRlbXAgKyBDKV07CiAgICB9CiAgICBjb25zdCBDQmFyQSA9IGRlbHRhMTsKICAgIGNvbnN0IERCYXJBID0gLTIgKiBCICogZGVsdGExICsgQSAqIGRlbHRhMjsKICAgIGNvbnN0IENCYXJEID0gZGVsdGEzOwogICAgY29uc3QgREJhckQgPSAtRCAqIGRlbHRhMiArIDIgKiBDICogZGVsdGEzOwogICAgY29uc3Qgc3F1YXJlUm9vdE9mRGlzY3JpbWluYW50ID0gTWF0aC5zcXJ0KGRpc2NyaW1pbmFudCk7CiAgICBjb25zdCBoYWxmU3F1YXJlUm9vdE9mMyA9IE1hdGguc3FydCgzKSAvIDI7CiAgICBsZXQgdGhldGEgPSBNYXRoLmFicyhNYXRoLmF0YW4yKEEgKiBzcXVhcmVSb290T2ZEaXNjcmltaW5hbnQsIC1EQmFyQSkgLyAzKTsKICAgIHRlbXAgPSAyICogTWF0aC5zcXJ0KC1DQmFyQSk7CiAgICBsZXQgY29zaW5lID0gTWF0aC5jb3ModGhldGEpOwogICAgdGVtcDEgPSB0ZW1wICogY29zaW5lOwogICAgbGV0IHRlbXAzID0gdGVtcCAqICgtY29zaW5lIC8gMiAtIGhhbGZTcXVhcmVSb290T2YzICogTWF0aC5zaW4odGhldGEpKTsKICAgIGNvbnN0IG51bWVyYXRvckxhcmdlID0gdGVtcDEgKyB0ZW1wMyA+IDIgKiBCID8gdGVtcDEgLSBCIDogdGVtcDMgLSBCOwogICAgY29uc3QgZGVub21pbmF0b3JMYXJnZSA9IEE7CiAgICBjb25zdCByb290MSA9IG51bWVyYXRvckxhcmdlIC8gZGVub21pbmF0b3JMYXJnZTsKICAgIHRoZXRhID0gTWF0aC5hYnMoTWF0aC5hdGFuMihEICogc3F1YXJlUm9vdE9mRGlzY3JpbWluYW50LCAtREJhckQpIC8gMyk7CiAgICB0ZW1wID0gMiAqIE1hdGguc3FydCgtQ0JhckQpOwogICAgY29zaW5lID0gTWF0aC5jb3ModGhldGEpOwogICAgdGVtcDEgPSB0ZW1wICogY29zaW5lOwogICAgdGVtcDMgPSB0ZW1wICogKC1jb3NpbmUgLyAyIC0gaGFsZlNxdWFyZVJvb3RPZjMgKiBNYXRoLnNpbih0aGV0YSkpOwogICAgY29uc3QgbnVtZXJhdG9yU21hbGwgPSAtRDsKICAgIGNvbnN0IGRlbm9taW5hdG9yU21hbGwgPSB0ZW1wMSArIHRlbXAzIDwgMiAqIEMgPyB0ZW1wMSArIEMgOiB0ZW1wMyArIEM7CiAgICBjb25zdCByb290MyA9IG51bWVyYXRvclNtYWxsIC8gZGVub21pbmF0b3JTbWFsbDsKICAgIGNvbnN0IEUgPSBkZW5vbWluYXRvckxhcmdlICogZGVub21pbmF0b3JTbWFsbDsKICAgIGNvbnN0IEYgPSAtbnVtZXJhdG9yTGFyZ2UgKiBkZW5vbWluYXRvclNtYWxsIC0gZGVub21pbmF0b3JMYXJnZSAqIG51bWVyYXRvclNtYWxsOwogICAgY29uc3QgRyA9IG51bWVyYXRvckxhcmdlICogbnVtZXJhdG9yU21hbGw7CiAgICBjb25zdCByb290MiA9IChDICogRiAtIEIgKiBHKSAvICgtQiAqIEYgKyBDICogRSk7CiAgICBpZiAocm9vdDEgPD0gcm9vdDIpIHsKICAgICAgaWYgKHJvb3QxIDw9IHJvb3QzKSB7CiAgICAgICAgaWYgKHJvb3QyIDw9IHJvb3QzKSB7CiAgICAgICAgICByZXR1cm4gW3Jvb3QxLCByb290Miwgcm9vdDNdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW3Jvb3QxLCByb290Mywgcm9vdDJdOwogICAgICB9CiAgICAgIHJldHVybiBbcm9vdDMsIHJvb3QxLCByb290Ml07CiAgICB9CiAgICBpZiAocm9vdDEgPD0gcm9vdDMpIHsKICAgICAgcmV0dXJuIFtyb290Miwgcm9vdDEsIHJvb3QzXTsKICAgIH0KICAgIGlmIChyb290MiA8PSByb290MykgewogICAgICByZXR1cm4gW3Jvb3QyLCByb290Mywgcm9vdDFdOwogICAgfQogICAgcmV0dXJuIFtyb290Mywgcm9vdDIsIHJvb3QxXTsKICB9CiAgdmFyIEN1YmljUmVhbFBvbHlub21pYWwsIEN1YmljUmVhbFBvbHlub21pYWxfZGVmYXVsdDsKICB2YXIgaW5pdF9DdWJpY1JlYWxQb2x5bm9taWFsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DdWJpY1JlYWxQb2x5bm9taWFsLmpzIigpIHsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X1F1YWRyYXRpY1JlYWxQb2x5bm9taWFsKCk7CiAgICAgIEN1YmljUmVhbFBvbHlub21pYWwgPSB7fTsKICAgICAgQ3ViaWNSZWFsUG9seW5vbWlhbC5jb21wdXRlRGlzY3JpbWluYW50ID0gZnVuY3Rpb24oYTMsIGIsIGMsIGQpIHsKICAgICAgICBpZiAodHlwZW9mIGEzICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYyBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBkICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImQgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGEyMiA9IGEzICogYTM7CiAgICAgICAgY29uc3QgYjIgPSBiICogYjsKICAgICAgICBjb25zdCBjMiA9IGMgKiBjOwogICAgICAgIGNvbnN0IGQyID0gZCAqIGQ7CiAgICAgICAgY29uc3QgZGlzY3JpbWluYW50ID0gMTggKiBhMyAqIGIgKiBjICogZCArIGIyICogYzIgLSAyNyAqIGEyMiAqIGQyIC0gNCAqIChhMyAqIGMyICogYyArIGIyICogYiAqIGQpOwogICAgICAgIHJldHVybiBkaXNjcmltaW5hbnQ7CiAgICAgIH07CiAgICAgIEN1YmljUmVhbFBvbHlub21pYWwuY29tcHV0ZVJlYWxSb290cyA9IGZ1bmN0aW9uKGEzLCBiLCBjLCBkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBhMyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGIgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYiBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZCAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgcm9vdHM7CiAgICAgICAgbGV0IHJhdGlvOwogICAgICAgIGlmIChhMyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cyhiLCBjLCBkKTsKICAgICAgICB9IGVsc2UgaWYgKGIgPT09IDApIHsKICAgICAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgICAgIGlmIChkID09PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFswLCAwLCAwXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByYXRpbyA9IC1kIC8gYTM7CiAgICAgICAgICAgIGNvbnN0IHJvb3QgPSByYXRpbyA8IDAgPyAtTWF0aC5wb3coLXJhdGlvLCAxIC8gMykgOiBNYXRoLnBvdyhyYXRpbywgMSAvIDMpOwogICAgICAgICAgICByZXR1cm4gW3Jvb3QsIHJvb3QsIHJvb3RdOwogICAgICAgICAgfSBlbHNlIGlmIChkID09PSAwKSB7CiAgICAgICAgICAgIHJvb3RzID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKGEzLCAwLCBjKTsKICAgICAgICAgICAgaWYgKHJvb3RzLkxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIHJldHVybiBbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFtyb290c1swXSwgMCwgcm9vdHNbMV1dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbXB1dGVSZWFsUm9vdHMoYTMsIDAsIGMsIGQpOwogICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gMCkgewogICAgICAgICAgaWYgKGQgPT09IDApIHsKICAgICAgICAgICAgcmF0aW8gPSAtYiAvIGEzOwogICAgICAgICAgICBpZiAocmF0aW8gPCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyYXRpbywgMCwgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFswLCAwLCByYXRpb107CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29tcHV0ZVJlYWxSb290cyhhMywgYiwgMCwgZCk7CiAgICAgICAgfSBlbHNlIGlmIChkID09PSAwKSB7CiAgICAgICAgICByb290cyA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cyhhMywgYiwgYyk7CiAgICAgICAgICBpZiAocm9vdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBbMF07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzWzFdIDw9IDApIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290c1swXSwgcm9vdHNbMV0sIDBdOwogICAgICAgICAgfSBlbHNlIGlmIChyb290c1swXSA+PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBbMCwgcm9vdHNbMF0sIHJvb3RzWzFdXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbcm9vdHNbMF0sIDAsIHJvb3RzWzFdXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXB1dGVSZWFsUm9vdHMoYTMsIGIsIGMsIGQpOwogICAgICB9OwogICAgICBDdWJpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQgPSBDdWJpY1JlYWxQb2x5bm9taWFsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhcnRpY1JlYWxQb2x5bm9taWFsLmpzCiAgZnVuY3Rpb24gb3JpZ2luYWwoYTMsIGEyMiwgYTEsIGEwKSB7CiAgICBjb25zdCBhM1NxdWFyZWQgPSBhMyAqIGEzOwogICAgY29uc3QgcCA9IGEyMiAtIDMgKiBhM1NxdWFyZWQgLyA4OwogICAgY29uc3QgcSA9IGExIC0gYTIyICogYTMgLyAyICsgYTNTcXVhcmVkICogYTMgLyA4OwogICAgY29uc3QgciA9IGEwIC0gYTEgKiBhMyAvIDQgKyBhMjIgKiBhM1NxdWFyZWQgLyAxNiAtIDMgKiBhM1NxdWFyZWQgKiBhM1NxdWFyZWQgLyAyNTY7CiAgICBjb25zdCBjdWJpY1Jvb3RzID0gQ3ViaWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoCiAgICAgIDEsCiAgICAgIDIgKiBwLAogICAgICBwICogcCAtIDQgKiByLAogICAgICAtcSAqIHEKICAgICk7CiAgICBpZiAoY3ViaWNSb290cy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHRlbXAgPSAtYTMgLyA0OwogICAgICBjb25zdCBoU3F1YXJlZCA9IGN1YmljUm9vdHNbY3ViaWNSb290cy5sZW5ndGggLSAxXTsKICAgICAgaWYgKE1hdGguYWJzKGhTcXVhcmVkKSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpIHsKICAgICAgICBjb25zdCByb290cyA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cygxLCBwLCByKTsKICAgICAgICBpZiAocm9vdHMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICBjb25zdCByb290MCA9IHJvb3RzWzBdOwogICAgICAgICAgY29uc3Qgcm9vdDEgPSByb290c1sxXTsKICAgICAgICAgIGxldCB5OwogICAgICAgICAgaWYgKHJvb3QwID49IDAgJiYgcm9vdDEgPj0gMCkgewogICAgICAgICAgICBjb25zdCB5MCA9IE1hdGguc3FydChyb290MCk7CiAgICAgICAgICAgIGNvbnN0IHkxID0gTWF0aC5zcXJ0KHJvb3QxKTsKICAgICAgICAgICAgcmV0dXJuIFt0ZW1wIC0geTEsIHRlbXAgLSB5MCwgdGVtcCArIHkwLCB0ZW1wICsgeTFdOwogICAgICAgICAgfSBlbHNlIGlmIChyb290MCA+PSAwICYmIHJvb3QxIDwgMCkgewogICAgICAgICAgICB5ID0gTWF0aC5zcXJ0KHJvb3QwKTsKICAgICAgICAgICAgcmV0dXJuIFt0ZW1wIC0geSwgdGVtcCArIHldOwogICAgICAgICAgfSBlbHNlIGlmIChyb290MCA8IDAgJiYgcm9vdDEgPj0gMCkgewogICAgICAgICAgICB5ID0gTWF0aC5zcXJ0KHJvb3QxKTsKICAgICAgICAgICAgcmV0dXJuIFt0ZW1wIC0geSwgdGVtcCArIHldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gW107CiAgICAgIH0gZWxzZSBpZiAoaFNxdWFyZWQgPiAwKSB7CiAgICAgICAgY29uc3QgaCA9IE1hdGguc3FydChoU3F1YXJlZCk7CiAgICAgICAgY29uc3QgbSA9IChwICsgaFNxdWFyZWQgLSBxIC8gaCkgLyAyOwogICAgICAgIGNvbnN0IG4gPSAocCArIGhTcXVhcmVkICsgcSAvIGgpIC8gMjsKICAgICAgICBjb25zdCByb290czEgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoMSwgaCwgbSk7CiAgICAgICAgY29uc3Qgcm9vdHMyID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKDEsIC1oLCBuKTsKICAgICAgICBpZiAocm9vdHMxLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgcm9vdHMxWzBdICs9IHRlbXA7CiAgICAgICAgICByb290czFbMV0gKz0gdGVtcDsKICAgICAgICAgIGlmIChyb290czIubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHJvb3RzMlswXSArPSB0ZW1wOwogICAgICAgICAgICByb290czJbMV0gKz0gdGVtcDsKICAgICAgICAgICAgaWYgKHJvb3RzMVsxXSA8PSByb290czJbMF0pIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMxWzFdLCByb290czJbMF0sIHJvb3RzMlsxXV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMyWzFdIDw9IHJvb3RzMVswXSkgewogICAgICAgICAgICAgIHJldHVybiBbcm9vdHMyWzBdLCByb290czJbMV0sIHJvb3RzMVswXSwgcm9vdHMxWzFdXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb290czFbMF0gPj0gcm9vdHMyWzBdICYmIHJvb3RzMVsxXSA8PSByb290czJbMV0pIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMxWzBdLCByb290czFbMV0sIHJvb3RzMlsxXV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMyWzBdID49IHJvb3RzMVswXSAmJiByb290czJbMV0gPD0gcm9vdHMxWzFdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMlswXSwgcm9vdHMyWzFdLCByb290czFbMV1dOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMVswXSA+IHJvb3RzMlswXSAmJiByb290czFbMF0gPCByb290czJbMV0pIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMxWzBdLCByb290czJbMV0sIHJvb3RzMVsxXV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMlswXSwgcm9vdHMxWzFdLCByb290czJbMV1dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3RzMTsKICAgICAgICB9CiAgICAgICAgaWYgKHJvb3RzMi5sZW5ndGggIT09IDApIHsKICAgICAgICAgIHJvb3RzMlswXSArPSB0ZW1wOwogICAgICAgICAgcm9vdHMyWzFdICs9IHRlbXA7CiAgICAgICAgICByZXR1cm4gcm9vdHMyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbXTsKICB9CiAgZnVuY3Rpb24gbmV1bWFyayhhMywgYTIyLCBhMSwgYTApIHsKICAgIGNvbnN0IGExU3F1YXJlZCA9IGExICogYTE7CiAgICBjb25zdCBhMlNxdWFyZWQgPSBhMjIgKiBhMjI7CiAgICBjb25zdCBhM1NxdWFyZWQgPSBhMyAqIGEzOwogICAgY29uc3QgcCA9IC0yICogYTIyOwogICAgY29uc3QgcSA9IGExICogYTMgKyBhMlNxdWFyZWQgLSA0ICogYTA7CiAgICBjb25zdCByID0gYTNTcXVhcmVkICogYTAgLSBhMSAqIGEyMiAqIGEzICsgYTFTcXVhcmVkOwogICAgY29uc3QgY3ViaWNSb290cyA9IEN1YmljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKDEsIHAsIHEsIHIpOwogICAgaWYgKGN1YmljUm9vdHMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCB5ID0gY3ViaWNSb290c1swXTsKICAgICAgY29uc3QgdGVtcCA9IGEyMiAtIHk7CiAgICAgIGNvbnN0IHRlbXBTcXVhcmVkID0gdGVtcCAqIHRlbXA7CiAgICAgIGNvbnN0IGcxID0gYTMgLyAyOwogICAgICBjb25zdCBoMSA9IHRlbXAgLyAyOwogICAgICBjb25zdCBtID0gdGVtcFNxdWFyZWQgLSA0ICogYTA7CiAgICAgIGNvbnN0IG1FcnJvciA9IHRlbXBTcXVhcmVkICsgNCAqIE1hdGguYWJzKGEwKTsKICAgICAgY29uc3QgbiA9IGEzU3F1YXJlZCAtIDQgKiB5OwogICAgICBjb25zdCBuRXJyb3IgPSBhM1NxdWFyZWQgKyA0ICogTWF0aC5hYnMoeSk7CiAgICAgIGxldCBnMjsKICAgICAgbGV0IGgyOwogICAgICBpZiAoeSA8IDAgfHwgbSAqIG5FcnJvciA8IG4gKiBtRXJyb3IpIHsKICAgICAgICBjb25zdCBzcXVhcmVSb290T2ZOID0gTWF0aC5zcXJ0KG4pOwogICAgICAgIGcyID0gc3F1YXJlUm9vdE9mTiAvIDI7CiAgICAgICAgaDIgPSBzcXVhcmVSb290T2ZOID09PSAwID8gMCA6IChhMyAqIGgxIC0gYTEpIC8gc3F1YXJlUm9vdE9mTjsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzcXVhcmVSb290T2ZNID0gTWF0aC5zcXJ0KG0pOwogICAgICAgIGcyID0gc3F1YXJlUm9vdE9mTSA9PT0gMCA/IDAgOiAoYTMgKiBoMSAtIGExKSAvIHNxdWFyZVJvb3RPZk07CiAgICAgICAgaDIgPSBzcXVhcmVSb290T2ZNIC8gMjsKICAgICAgfQogICAgICBsZXQgRzsKICAgICAgbGV0IGc7CiAgICAgIGlmIChnMSA9PT0gMCAmJiBnMiA9PT0gMCkgewogICAgICAgIEcgPSAwOwogICAgICAgIGcgPSAwOwogICAgICB9IGVsc2UgaWYgKE1hdGhfZGVmYXVsdC5zaWduKGcxKSA9PT0gTWF0aF9kZWZhdWx0LnNpZ24oZzIpKSB7CiAgICAgICAgRyA9IGcxICsgZzI7CiAgICAgICAgZyA9IHkgLyBHOwogICAgICB9IGVsc2UgewogICAgICAgIGcgPSBnMSAtIGcyOwogICAgICAgIEcgPSB5IC8gZzsKICAgICAgfQogICAgICBsZXQgSDsKICAgICAgbGV0IGg7CiAgICAgIGlmIChoMSA9PT0gMCAmJiBoMiA9PT0gMCkgewogICAgICAgIEggPSAwOwogICAgICAgIGggPSAwOwogICAgICB9IGVsc2UgaWYgKE1hdGhfZGVmYXVsdC5zaWduKGgxKSA9PT0gTWF0aF9kZWZhdWx0LnNpZ24oaDIpKSB7CiAgICAgICAgSCA9IGgxICsgaDI7CiAgICAgICAgaCA9IGEwIC8gSDsKICAgICAgfSBlbHNlIHsKICAgICAgICBoID0gaDEgLSBoMjsKICAgICAgICBIID0gYTAgLyBoOwogICAgICB9CiAgICAgIGNvbnN0IHJvb3RzMSA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cygxLCBHLCBIKTsKICAgICAgY29uc3Qgcm9vdHMyID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKDEsIGcsIGgpOwogICAgICBpZiAocm9vdHMxLmxlbmd0aCAhPT0gMCkgewogICAgICAgIGlmIChyb290czIubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICBpZiAocm9vdHMxWzFdIDw9IHJvb3RzMlswXSkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMxWzFdLCByb290czJbMF0sIHJvb3RzMlsxXV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMlsxXSA8PSByb290czFbMF0pIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMlsxXSwgcm9vdHMxWzBdLCByb290czFbMV1dOwogICAgICAgICAgfSBlbHNlIGlmIChyb290czFbMF0gPj0gcm9vdHMyWzBdICYmIHJvb3RzMVsxXSA8PSByb290czJbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMVswXSwgcm9vdHMxWzFdLCByb290czJbMV1dOwogICAgICAgICAgfSBlbHNlIGlmIChyb290czJbMF0gPj0gcm9vdHMxWzBdICYmIHJvb3RzMlsxXSA8PSByb290czFbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMlswXSwgcm9vdHMyWzFdLCByb290czFbMV1dOwogICAgICAgICAgfSBlbHNlIGlmIChyb290czFbMF0gPiByb290czJbMF0gJiYgcm9vdHMxWzBdIDwgcm9vdHMyWzFdKSB7CiAgICAgICAgICAgIHJldHVybiBbcm9vdHMyWzBdLCByb290czFbMF0sIHJvb3RzMlsxXSwgcm9vdHMxWzFdXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbcm9vdHMxWzBdLCByb290czJbMF0sIHJvb3RzMVsxXSwgcm9vdHMyWzFdXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvb3RzMTsKICAgICAgfQogICAgICBpZiAocm9vdHMyLmxlbmd0aCAhPT0gMCkgewogICAgICAgIHJldHVybiByb290czI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbXTsKICB9CiAgdmFyIFF1YXJ0aWNSZWFsUG9seW5vbWlhbCwgUXVhcnRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQ7CiAgdmFyIGluaXRfUXVhcnRpY1JlYWxQb2x5bm9taWFsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9RdWFydGljUmVhbFBvbHlub21pYWwuanMiKCkgewogICAgICBpbml0X0N1YmljUmVhbFBvbHlub21pYWwoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9RdWFkcmF0aWNSZWFsUG9seW5vbWlhbCgpOwogICAgICBRdWFydGljUmVhbFBvbHlub21pYWwgPSB7fTsKICAgICAgUXVhcnRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVEaXNjcmltaW5hbnQgPSBmdW5jdGlvbihhMywgYiwgYywgZCwgZSkgewogICAgICAgIGlmICh0eXBlb2YgYTMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZCBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBlICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImUgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGEyMiA9IGEzICogYTM7CiAgICAgICAgY29uc3QgYTMyID0gYTIyICogYTM7CiAgICAgICAgY29uc3QgYjIgPSBiICogYjsKICAgICAgICBjb25zdCBiMyA9IGIyICogYjsKICAgICAgICBjb25zdCBjMiA9IGMgKiBjOwogICAgICAgIGNvbnN0IGMzMiA9IGMyICogYzsKICAgICAgICBjb25zdCBkMiA9IGQgKiBkOwogICAgICAgIGNvbnN0IGQzID0gZDIgKiBkOwogICAgICAgIGNvbnN0IGUyID0gZSAqIGU7CiAgICAgICAgY29uc3QgZTMgPSBlMiAqIGU7CiAgICAgICAgY29uc3QgZGlzY3JpbWluYW50ID0gYjIgKiBjMiAqIGQyIC0gNCAqIGIzICogZDMgLSA0ICogYTMgKiBjMzIgKiBkMiArIDE4ICogYTMgKiBiICogYyAqIGQzIC0gMjcgKiBhMjIgKiBkMiAqIGQyICsgMjU2ICogYTMyICogZTMgKyBlICogKDE4ICogYjMgKiBjICogZCAtIDQgKiBiMiAqIGMzMiArIDE2ICogYTMgKiBjMiAqIGMyIC0gODAgKiBhMyAqIGIgKiBjMiAqIGQgLSA2ICogYTMgKiBiMiAqIGQyICsgMTQ0ICogYTIyICogYyAqIGQyKSArIGUyICogKDE0NCAqIGEzICogYjIgKiBjIC0gMjcgKiBiMiAqIGIyIC0gMTI4ICogYTIyICogYzIgLSAxOTIgKiBhMjIgKiBiICogZCk7CiAgICAgICAgcmV0dXJuIGRpc2NyaW1pbmFudDsKICAgICAgfTsKICAgICAgUXVhcnRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMgPSBmdW5jdGlvbihhMywgYiwgYywgZCwgZSkgewogICAgICAgIGlmICh0eXBlb2YgYTMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZCBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBlICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImUgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmIChNYXRoLmFicyhhMykgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1KSB7CiAgICAgICAgICByZXR1cm4gQ3ViaWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoYiwgYywgZCwgZSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGEzMiA9IGIgLyBhMzsKICAgICAgICBjb25zdCBhMjIgPSBjIC8gYTM7CiAgICAgICAgY29uc3QgYTEgPSBkIC8gYTM7CiAgICAgICAgY29uc3QgYTAgPSBlIC8gYTM7CiAgICAgICAgbGV0IGsgPSBhMzIgPCAwID8gMSA6IDA7CiAgICAgICAgayArPSBhMjIgPCAwID8gayArIDEgOiBrOwogICAgICAgIGsgKz0gYTEgPCAwID8gayArIDEgOiBrOwogICAgICAgIGsgKz0gYTAgPCAwID8gayArIDEgOiBrOwogICAgICAgIHN3aXRjaCAoaykgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIHJldHVybiBuZXVtYXJrKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gbmV1bWFyayhhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHJldHVybiBuZXVtYXJrKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgcmV0dXJuIG5ldW1hcmsoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgIHJldHVybiBuZXVtYXJrKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxMzoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxNToKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFF1YXJ0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0ID0gUXVhcnRpY1JlYWxQb2x5bm9taWFsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmF5LmpzCiAgZnVuY3Rpb24gUmF5KG9yaWdpbiwgZGlyZWN0aW9uMikgewogICAgZGlyZWN0aW9uMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShkZWZhdWx0VmFsdWVfZGVmYXVsdChkaXJlY3Rpb24yLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpOwogICAgaWYgKCFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGRpcmVjdGlvbjIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGRpcmVjdGlvbjIsIGRpcmVjdGlvbjIpOwogICAgfQogICAgdGhpcy5vcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZGVmYXVsdFZhbHVlX2RlZmF1bHQob3JpZ2luLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpOwogICAgdGhpcy5kaXJlY3Rpb24gPSBkaXJlY3Rpb24yOwogIH0KICB2YXIgUmF5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUmF5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SYXkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgUmF5LmNsb25lID0gZnVuY3Rpb24ocmF5LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYXkpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJheShyYXkub3JpZ2luLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lm9yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyYXkub3JpZ2luKTsKICAgICAgICByZXN1bHQuZGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJheS5kaXJlY3Rpb24pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJheS5nZXRQb2ludCA9IGZ1bmN0aW9uKHJheSwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyYXkiLCByYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIocmF5LmRpcmVjdGlvbiwgdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyYXkub3JpZ2luLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFJheV9kZWZhdWx0ID0gUmF5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW50ZXJzZWN0aW9uVGVzdHMuanMKICBmdW5jdGlvbiBzb2x2ZVF1YWRyYXRpYyhhMywgYiwgYywgcmVzdWx0KSB7CiAgICBjb25zdCBkZXQgPSBiICogYiAtIDQgKiBhMyAqIGM7CiAgICBpZiAoZGV0IDwgMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfSBlbHNlIGlmIChkZXQgPiAwKSB7CiAgICAgIGNvbnN0IGRlbm9tID0gMSAvICgyICogYTMpOwogICAgICBjb25zdCBkaXNjID0gTWF0aC5zcXJ0KGRldCk7CiAgICAgIGNvbnN0IHJvb3QwID0gKC1iICsgZGlzYykgKiBkZW5vbTsKICAgICAgY29uc3Qgcm9vdDEgPSAoLWIgLSBkaXNjKSAqIGRlbm9tOwogICAgICBpZiAocm9vdDAgPCByb290MSkgewogICAgICAgIHJlc3VsdC5yb290MCA9IHJvb3QwOwogICAgICAgIHJlc3VsdC5yb290MSA9IHJvb3QxOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5yb290MCA9IHJvb3QxOwogICAgICAgIHJlc3VsdC5yb290MSA9IHJvb3QwOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBjb25zdCByb290ID0gLWIgLyAoMiAqIGEzKTsKICAgIGlmIChyb290ID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXN1bHQucm9vdDAgPSByZXN1bHQucm9vdDEgPSByb290OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gcmF5U3BoZXJlKHJheSwgc3BoZXJlLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IEludGVydmFsX2RlZmF1bHQoKTsKICAgIH0KICAgIGNvbnN0IG9yaWdpbiA9IHJheS5vcmlnaW47CiAgICBjb25zdCBkaXJlY3Rpb24yID0gcmF5LmRpcmVjdGlvbjsKICAgIGNvbnN0IGNlbnRlciA9IHNwaGVyZS5jZW50ZXI7CiAgICBjb25zdCByYWRpdXNTcXVhcmVkID0gc3BoZXJlLnJhZGl1cyAqIHNwaGVyZS5yYWRpdXM7CiAgICBjb25zdCBkaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG9yaWdpbiwgY2VudGVyLCBzY3JhdGNoUFZlYyk7CiAgICBjb25zdCBhMyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgZGlyZWN0aW9uMik7CiAgICBjb25zdCBiID0gMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgZGlmZik7CiAgICBjb25zdCBjID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoZGlmZikgLSByYWRpdXNTcXVhcmVkOwogICAgY29uc3Qgcm9vdHMgPSBzb2x2ZVF1YWRyYXRpYyhhMywgYiwgYywgcmF5U3BoZXJlUm9vdHMpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocm9vdHMpKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXN1bHQuc3RhcnQgPSByb290cy5yb290MDsKICAgIHJlc3VsdC5zdG9wID0gcm9vdHMucm9vdDE7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKGxlZnQsIHJpZ2h0LCB0b2xlcmFuY2UpIHsKICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBsZWZ0ICsgcmlnaHQ7CiAgICBpZiAoTWF0aF9kZWZhdWx0LnNpZ24obGVmdCkgIT09IE1hdGhfZGVmYXVsdC5zaWduKHJpZ2h0KSAmJiBNYXRoLmFicyhkaWZmZXJlbmNlIC8gTWF0aC5tYXgoTWF0aC5hYnMobGVmdCksIE1hdGguYWJzKHJpZ2h0KSkpIDwgdG9sZXJhbmNlKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgcmV0dXJuIGRpZmZlcmVuY2U7CiAgfQogIHZhciBJbnRlcnNlY3Rpb25UZXN0cywgc2NyYXRjaEVkZ2UwLCBzY3JhdGNoRWRnZTEsIHNjcmF0Y2hQVmVjLCBzY3JhdGNoVFZlYywgc2NyYXRjaFFWZWMsIHNjcmF0Y2hMaW5lU2VnbWVudFRyaWFuZ2xlUmF5LCByYXlTcGhlcmVSb290cywgc2NyYXRjaExpbmVTZWdtZW50UmF5LCBzY3JhdGNoUSwgc2NyYXRjaFcsIGZpcnN0QXhpc1NjcmF0Y2gsIHNlY29uZEF4aXNTY3JhdGNoLCB0aGlyZEF4aXNTY3JhdGNoLCByZWZlcmVuY2VTY3JhdGNoLCBiQ2FydCwgYlNjcmF0Y2gsIGJ0U2NyYXRjaCwgZGlTY3JhdGNoLCBkU2NyYXRjaCwgY1NjcmF0Y2gsIHRlbXBNYXRyaXgsIGFTY3JhdGNoLCBzU2NyYXRjaCwgY2xvc2VzdFNjcmF0Y2gsIHN1cmZQb2ludFNjcmF0Y2gsIGxpbmVTZWdtZW50UGxhbmVEaWZmZXJlbmNlLCBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0OwogIHZhciBpbml0X0ludGVyc2VjdGlvblRlc3RzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnNlY3Rpb25UZXN0cy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0ludGVydmFsKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9RdWFkcmF0aWNSZWFsUG9seW5vbWlhbCgpOwogICAgICBpbml0X1F1YXJ0aWNSZWFsUG9seW5vbWlhbCgpOwogICAgICBpbml0X1JheSgpOwogICAgICBJbnRlcnNlY3Rpb25UZXN0cyA9IHt9OwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5yYXlQbGFuZSA9IGZ1bmN0aW9uKHJheSwgcGxhbmUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyYXkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBsYW5lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9yaWdpbiA9IHJheS5vcmlnaW47CiAgICAgICAgY29uc3QgZGlyZWN0aW9uMiA9IHJheS5kaXJlY3Rpb247CiAgICAgICAgY29uc3Qgbm9ybWFsMiA9IHBsYW5lLm5vcm1hbDsKICAgICAgICBjb25zdCBkZW5vbWluYXRvciA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgZGlyZWN0aW9uMik7CiAgICAgICAgaWYgKE1hdGguYWJzKGRlbm9taW5hdG9yKSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTUpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHQgPSAoLXBsYW5lLmRpc3RhbmNlIC0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBvcmlnaW4pKSAvIGRlbm9taW5hdG9yOwogICAgICAgIGlmICh0IDwgMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGlyZWN0aW9uMiwgdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChvcmlnaW4sIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVkZ2UwID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWRnZTEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQVmVjID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVFZlYyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFFWZWMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEludGVyc2VjdGlvblRlc3RzLnJheVRyaWFuZ2xlUGFyYW1ldHJpYyA9IGZ1bmN0aW9uKHJheSwgcDAsIHAxLCBwMiwgY3VsbEJhY2tGYWNlcykgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyYXkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGN1bGxCYWNrRmFjZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjdWxsQmFja0ZhY2VzLCBmYWxzZSk7CiAgICAgICAgY29uc3Qgb3JpZ2luID0gcmF5Lm9yaWdpbjsKICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gcmF5LmRpcmVjdGlvbjsKICAgICAgICBjb25zdCBlZGdlMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcDAsIHNjcmF0Y2hFZGdlMCk7CiAgICAgICAgY29uc3QgZWRnZTEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDIsIHAwLCBzY3JhdGNoRWRnZTEpOwogICAgICAgIGNvbnN0IHAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZGlyZWN0aW9uMiwgZWRnZTEsIHNjcmF0Y2hQVmVjKTsKICAgICAgICBjb25zdCBkZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGVkZ2UwLCBwKTsKICAgICAgICBsZXQgdHZlYzsKICAgICAgICBsZXQgcTsKICAgICAgICBsZXQgdTM7CiAgICAgICAgbGV0IHYzOwogICAgICAgIGxldCB0OwogICAgICAgIGlmIChjdWxsQmFja0ZhY2VzKSB7CiAgICAgICAgICBpZiAoZGV0IDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICB0dmVjID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG9yaWdpbiwgcDAsIHNjcmF0Y2hUVmVjKTsKICAgICAgICAgIHUzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0dmVjLCBwKTsKICAgICAgICAgIGlmICh1MyA8IDAgfHwgdTMgPiBkZXQpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModHZlYywgZWRnZTAsIHNjcmF0Y2hRVmVjKTsKICAgICAgICAgIHYzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCBxKTsKICAgICAgICAgIGlmICh2MyA8IDAgfHwgdTMgKyB2MyA+IGRldCkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZWRnZTEsIHEpIC8gZGV0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9ONikgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaW52RGV0ID0gMSAvIGRldDsKICAgICAgICAgIHR2ZWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qob3JpZ2luLCBwMCwgc2NyYXRjaFRWZWMpOwogICAgICAgICAgdTMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHR2ZWMsIHApICogaW52RGV0OwogICAgICAgICAgaWYgKHUzIDwgMCB8fCB1MyA+IDEpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModHZlYywgZWRnZTAsIHNjcmF0Y2hRVmVjKTsKICAgICAgICAgIHYzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCBxKSAqIGludkRldDsKICAgICAgICAgIGlmICh2MyA8IDAgfHwgdTMgKyB2MyA+IDEpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGVkZ2UxLCBxKSAqIGludkRldDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHQ7CiAgICAgIH07CiAgICAgIEludGVyc2VjdGlvblRlc3RzLnJheVRyaWFuZ2xlID0gZnVuY3Rpb24ocmF5LCBwMCwgcDEsIHAyLCBjdWxsQmFja0ZhY2VzLCByZXN1bHQpIHsKICAgICAgICBjb25zdCB0ID0gSW50ZXJzZWN0aW9uVGVzdHMucmF5VHJpYW5nbGVQYXJhbWV0cmljKAogICAgICAgICAgcmF5LAogICAgICAgICAgcDAsCiAgICAgICAgICBwMSwKICAgICAgICAgIHAyLAogICAgICAgICAgY3VsbEJhY2tGYWNlcwogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodCkgfHwgdCA8IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIocmF5LmRpcmVjdGlvbiwgdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyYXkub3JpZ2luLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hMaW5lU2VnbWVudFRyaWFuZ2xlUmF5ID0gbmV3IFJheV9kZWZhdWx0KCk7CiAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50VHJpYW5nbGUgPSBmdW5jdGlvbih2MDIsIHYxMiwgcDAsIHAxLCBwMiwgY3VsbEJhY2tGYWNlcywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodjAyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInYwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2MTIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidjEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJheSA9IHNjcmF0Y2hMaW5lU2VnbWVudFRyaWFuZ2xlUmF5OwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSh2MDIsIHJheS5vcmlnaW4pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh2MTIsIHYwMiwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyYXkuZGlyZWN0aW9uLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBjb25zdCB0ID0gSW50ZXJzZWN0aW9uVGVzdHMucmF5VHJpYW5nbGVQYXJhbWV0cmljKAogICAgICAgICAgcmF5LAogICAgICAgICAgcDAsCiAgICAgICAgICBwMSwKICAgICAgICAgIHAyLAogICAgICAgICAgY3VsbEJhY2tGYWNlcwogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodCkgfHwgdCA8IDAgfHwgdCA+IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZSh2MDIsIHYxMikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIocmF5LmRpcmVjdGlvbiwgdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyYXkub3JpZ2luLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHJheVNwaGVyZVJvb3RzID0gewogICAgICAgIHJvb3QwOiAwLAogICAgICAgIHJvb3QxOiAwCiAgICAgIH07CiAgICAgIEludGVyc2VjdGlvblRlc3RzLnJheVNwaGVyZSA9IGZ1bmN0aW9uKHJheSwgc3BoZXJlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmF5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzcGhlcmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic3BoZXJlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSByYXlTcGhlcmUocmF5LCBzcGhlcmUsIHJlc3VsdCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSB8fCByZXN1bHQuc3RvcCA8IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5zdGFydCA9IE1hdGgubWF4KHJlc3VsdC5zdGFydCwgMCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaExpbmVTZWdtZW50UmF5ID0gbmV3IFJheV9kZWZhdWx0KCk7CiAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50U3BoZXJlID0gZnVuY3Rpb24ocDAsIHAxLCBzcGhlcmUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3BoZXJlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNwaGVyZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmF5ID0gc2NyYXRjaExpbmVTZWdtZW50UmF5OwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwMCwgcmF5Lm9yaWdpbik7CiAgICAgICAgY29uc3QgZGlyZWN0aW9uMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcDAsIHJheS5kaXJlY3Rpb24pOwogICAgICAgIGNvbnN0IG1heFQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGRpcmVjdGlvbjIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZGlyZWN0aW9uMik7CiAgICAgICAgcmVzdWx0ID0gcmF5U3BoZXJlKHJheSwgc3BoZXJlLCByZXN1bHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkgfHwgcmVzdWx0LnN0b3AgPCAwIHx8IHJlc3VsdC5zdGFydCA+IG1heFQpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5zdGFydCA9IE1hdGgubWF4KHJlc3VsdC5zdGFydCwgMCk7CiAgICAgICAgcmVzdWx0LnN0b3AgPSBNYXRoLm1pbihyZXN1bHQuc3RvcCwgbWF4VCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaFEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hXID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5yYXlFbGxpcHNvaWQgPSBmdW5jdGlvbihyYXksIGVsbGlwc29pZCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyYXkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJlbGxpcHNvaWQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGludmVyc2VSYWRpaSA9IGVsbGlwc29pZC5vbmVPdmVyUmFkaWk7CiAgICAgICAgY29uc3QgcSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUNvbXBvbmVudHMoaW52ZXJzZVJhZGlpLCByYXkub3JpZ2luLCBzY3JhdGNoUSk7CiAgICAgICAgY29uc3QgdyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUNvbXBvbmVudHMoCiAgICAgICAgICBpbnZlcnNlUmFkaWksCiAgICAgICAgICByYXkuZGlyZWN0aW9uLAogICAgICAgICAgc2NyYXRjaFcKICAgICAgICApOwogICAgICAgIGNvbnN0IHEyMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKHEpOwogICAgICAgIGNvbnN0IHF3ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChxLCB3KTsKICAgICAgICBsZXQgZGlmZmVyZW5jZSwgdzIsIHByb2R1Y3QsIGRpc2NyaW1pbmFudCwgdGVtcDsKICAgICAgICBpZiAocTIyID4gMSkgewogICAgICAgICAgaWYgKHF3ID49IDApIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHF3MiA9IHF3ICogcXc7CiAgICAgICAgICBkaWZmZXJlbmNlID0gcTIyIC0gMTsKICAgICAgICAgIHcyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQodyk7CiAgICAgICAgICBwcm9kdWN0ID0gdzIgKiBkaWZmZXJlbmNlOwogICAgICAgICAgaWYgKHF3MiA8IHByb2R1Y3QpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0gZWxzZSBpZiAocXcyID4gcHJvZHVjdCkgewogICAgICAgICAgICBkaXNjcmltaW5hbnQgPSBxdyAqIHF3IC0gcHJvZHVjdDsKICAgICAgICAgICAgdGVtcCA9IC1xdyArIE1hdGguc3FydChkaXNjcmltaW5hbnQpOwogICAgICAgICAgICBjb25zdCByb290MCA9IHRlbXAgLyB3MjsKICAgICAgICAgICAgY29uc3Qgcm9vdDEgPSBkaWZmZXJlbmNlIC8gdGVtcDsKICAgICAgICAgICAgaWYgKHJvb3QwIDwgcm9vdDEpIHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IEludGVydmFsX2RlZmF1bHQocm9vdDAsIHJvb3QxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHN0YXJ0OiByb290MSwKICAgICAgICAgICAgICBzdG9wOiByb290MAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgcm9vdCA9IE1hdGguc3FydChkaWZmZXJlbmNlIC8gdzIpOwogICAgICAgICAgcmV0dXJuIG5ldyBJbnRlcnZhbF9kZWZhdWx0KHJvb3QsIHJvb3QpOwogICAgICAgIH0gZWxzZSBpZiAocTIyIDwgMSkgewogICAgICAgICAgZGlmZmVyZW5jZSA9IHEyMiAtIDE7CiAgICAgICAgICB3MiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKHcpOwogICAgICAgICAgcHJvZHVjdCA9IHcyICogZGlmZmVyZW5jZTsKICAgICAgICAgIGRpc2NyaW1pbmFudCA9IHF3ICogcXcgLSBwcm9kdWN0OwogICAgICAgICAgdGVtcCA9IC1xdyArIE1hdGguc3FydChkaXNjcmltaW5hbnQpOwogICAgICAgICAgcmV0dXJuIG5ldyBJbnRlcnZhbF9kZWZhdWx0KDAsIHRlbXAgLyB3Mik7CiAgICAgICAgfQogICAgICAgIGlmIChxdyA8IDApIHsKICAgICAgICAgIHcyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQodyk7CiAgICAgICAgICByZXR1cm4gbmV3IEludGVydmFsX2RlZmF1bHQoMCwgLXF3IC8gdzIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9OwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5xdWFkcmF0aWNWZWN0b3JFeHByZXNzaW9uID0gZnVuY3Rpb24oQSwgYiwgYywgeCwgdykgewogICAgICAgIGNvbnN0IHhTcXVhcmVkID0geCAqIHg7CiAgICAgICAgY29uc3Qgd1NxdWFyZWQgPSB3ICogdzsKICAgICAgICBjb25zdCBsMiA9IChBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMV0gLSBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMl0pICogd1NxdWFyZWQ7CiAgICAgICAgY29uc3QgbDEgPSB3ICogKHggKiBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKAogICAgICAgICAgQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMVJPVzBdLAogICAgICAgICAgQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzFdLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xNQogICAgICAgICkgKyBiLnkpOwogICAgICAgIGNvbnN0IGwwID0gQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzBdICogeFNxdWFyZWQgKyBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMl0gKiB3U3F1YXJlZCArIHggKiBiLnggKyBjOwogICAgICAgIGNvbnN0IHIxID0gd1NxdWFyZWQgKiBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKAogICAgICAgICAgQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzFdLAogICAgICAgICAgQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMVJPVzJdLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xNQogICAgICAgICk7CiAgICAgICAgY29uc3QgcjAgPSB3ICogKHggKiBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cwXSwgQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzJdKSArIGIueik7CiAgICAgICAgbGV0IGNvc2luZXM7CiAgICAgICAgY29uc3Qgc29sdXRpb25zID0gW107CiAgICAgICAgaWYgKHIwID09PSAwICYmIHIxID09PSAwKSB7CiAgICAgICAgICBjb3NpbmVzID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKGwyLCBsMSwgbDApOwogICAgICAgICAgaWYgKGNvc2luZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBzb2x1dGlvbnM7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBjb3NpbmUwID0gY29zaW5lc1swXTsKICAgICAgICAgIGNvbnN0IHNpbmUwID0gTWF0aC5zcXJ0KE1hdGgubWF4KDEgLSBjb3NpbmUwICogY29zaW5lMCwgMCkpOwogICAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lMCwgdyAqIC1zaW5lMCkpOwogICAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lMCwgdyAqIHNpbmUwKSk7CiAgICAgICAgICBpZiAoY29zaW5lcy5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgY29uc3QgY29zaW5lMSA9IGNvc2luZXNbMV07CiAgICAgICAgICAgIGNvbnN0IHNpbmUxID0gTWF0aC5zcXJ0KE1hdGgubWF4KDEgLSBjb3NpbmUxICogY29zaW5lMSwgMCkpOwogICAgICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUxLCB3ICogLXNpbmUxKSk7CiAgICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZTEsIHcgKiBzaW5lMSkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNvbHV0aW9uczsKICAgICAgICB9CiAgICAgICAgY29uc3QgcjBTcXVhcmVkID0gcjAgKiByMDsKICAgICAgICBjb25zdCByMVNxdWFyZWQgPSByMSAqIHIxOwogICAgICAgIGNvbnN0IGwyU3F1YXJlZCA9IGwyICogbDI7CiAgICAgICAgY29uc3QgcjByMSA9IHIwICogcjE7CiAgICAgICAgY29uc3QgYzQgPSBsMlNxdWFyZWQgKyByMVNxdWFyZWQ7CiAgICAgICAgY29uc3QgYzMyID0gMiAqIChsMSAqIGwyICsgcjByMSk7CiAgICAgICAgY29uc3QgYzIgPSAyICogbDAgKiBsMiArIGwxICogbDEgLSByMVNxdWFyZWQgKyByMFNxdWFyZWQ7CiAgICAgICAgY29uc3QgYzEgPSAyICogKGwwICogbDEgLSByMHIxKTsKICAgICAgICBjb25zdCBjMCA9IGwwICogbDAgLSByMFNxdWFyZWQ7CiAgICAgICAgaWYgKGM0ID09PSAwICYmIGMzMiA9PT0gMCAmJiBjMiA9PT0gMCAmJiBjMSA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHNvbHV0aW9uczsKICAgICAgICB9CiAgICAgICAgY29zaW5lcyA9IFF1YXJ0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoYzQsIGMzMiwgYzIsIGMxLCBjMCk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY29zaW5lcy5sZW5ndGg7CiAgICAgICAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHNvbHV0aW9uczsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgY29zaW5lID0gY29zaW5lc1tpXTsKICAgICAgICAgIGNvbnN0IGNvc2luZVNxdWFyZWQgPSBjb3NpbmUgKiBjb3NpbmU7CiAgICAgICAgICBjb25zdCBzaW5lU3F1YXJlZCA9IE1hdGgubWF4KDEgLSBjb3NpbmVTcXVhcmVkLCAwKTsKICAgICAgICAgIGNvbnN0IHNpbmUgPSBNYXRoLnNxcnQoc2luZVNxdWFyZWQpOwogICAgICAgICAgbGV0IGxlZnQ7CiAgICAgICAgICBpZiAoTWF0aF9kZWZhdWx0LnNpZ24obDIpID09PSBNYXRoX2RlZmF1bHQuc2lnbihsMCkpIHsKICAgICAgICAgICAgbGVmdCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgICAgICAgICAgbDIgKiBjb3NpbmVTcXVhcmVkICsgbDAsCiAgICAgICAgICAgICAgbDEgKiBjb3NpbmUsCiAgICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMgogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIGlmIChNYXRoX2RlZmF1bHQuc2lnbihsMCkgPT09IE1hdGhfZGVmYXVsdC5zaWduKGwxICogY29zaW5lKSkgewogICAgICAgICAgICBsZWZ0ID0gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrMigKICAgICAgICAgICAgICBsMiAqIGNvc2luZVNxdWFyZWQsCiAgICAgICAgICAgICAgbDEgKiBjb3NpbmUgKyBsMCwKICAgICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyCiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZWZ0ID0gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrMigKICAgICAgICAgICAgICBsMiAqIGNvc2luZVNxdWFyZWQgKyBsMSAqIGNvc2luZSwKICAgICAgICAgICAgICBsMCwKICAgICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByaWdodCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgICAgICAgIHIxICogY29zaW5lLAogICAgICAgICAgICByMCwKICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xNQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHByb2R1Y3QgPSBsZWZ0ICogcmlnaHQ7CiAgICAgICAgICBpZiAocHJvZHVjdCA8IDApIHsKICAgICAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lLCB3ICogc2luZSkpOwogICAgICAgICAgfSBlbHNlIGlmIChwcm9kdWN0ID4gMCkgewogICAgICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUsIHcgKiAtc2luZSkpOwogICAgICAgICAgfSBlbHNlIGlmIChzaW5lICE9PSAwKSB7CiAgICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZSwgdyAqIC1zaW5lKSk7CiAgICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZSwgdyAqIHNpbmUpKTsKICAgICAgICAgICAgKytpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lLCB3ICogc2luZSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc29sdXRpb25zOwogICAgICB9OwogICAgICBmaXJzdEF4aXNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWNvbmRBeGlzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdGhpcmRBeGlzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcmVmZXJlbmNlU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYkNhcnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBidFNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGRpU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgZFNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGNTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICB0ZW1wTWF0cml4ID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBhU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNsb3Nlc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdXJmUG9pbnRTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIEludGVyc2VjdGlvblRlc3RzLmdyYXppbmdBbHRpdHVkZUxvY2F0aW9uID0gZnVuY3Rpb24ocmF5LCBlbGxpcHNvaWQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmF5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZWxsaXBzb2lkIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbiA9IHJheS5vcmlnaW47CiAgICAgICAgY29uc3QgZGlyZWN0aW9uMiA9IHJheS5kaXJlY3Rpb247CiAgICAgICAgaWYgKCFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKHBvc2l0aW9uLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpIHsKICAgICAgICAgIGNvbnN0IG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBmaXJzdEF4aXNTY3JhdGNoKTsKICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIG5vcm1hbDIpID49IDApIHsKICAgICAgICAgICAgcmV0dXJuIHBvc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBpbnRlcnNlY3RzMiA9IGRlZmluZWRfZGVmYXVsdCh0aGlzLnJheUVsbGlwc29pZChyYXksIGVsbGlwc29pZCkpOwogICAgICAgIGNvbnN0IGYgPSBlbGxpcHNvaWQudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlKAogICAgICAgICAgZGlyZWN0aW9uMiwKICAgICAgICAgIGZpcnN0QXhpc1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGZpcnN0QXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZiwgZik7CiAgICAgICAgY29uc3QgcmVmZXJlbmNlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1vc3RPcnRob2dvbmFsQXhpcyhmLCByZWZlcmVuY2VTY3JhdGNoKTsKICAgICAgICBjb25zdCBzZWNvbmRBeGlzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhyZWZlcmVuY2UsIGZpcnN0QXhpcywgc2Vjb25kQXhpc1NjcmF0Y2gpLAogICAgICAgICAgc2Vjb25kQXhpc1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IHRoaXJkQXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZmlyc3RBeGlzLCBzZWNvbmRBeGlzLCB0aGlyZEF4aXNTY3JhdGNoKSwKICAgICAgICAgIHRoaXJkQXhpc1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IEIgPSBiU2NyYXRjaDsKICAgICAgICBCWzBdID0gZmlyc3RBeGlzLng7CiAgICAgICAgQlsxXSA9IGZpcnN0QXhpcy55OwogICAgICAgIEJbMl0gPSBmaXJzdEF4aXMuejsKICAgICAgICBCWzNdID0gc2Vjb25kQXhpcy54OwogICAgICAgIEJbNF0gPSBzZWNvbmRBeGlzLnk7CiAgICAgICAgQls1XSA9IHNlY29uZEF4aXMuejsKICAgICAgICBCWzZdID0gdGhpcmRBeGlzLng7CiAgICAgICAgQls3XSA9IHRoaXJkQXhpcy55OwogICAgICAgIEJbOF0gPSB0aGlyZEF4aXMuejsKICAgICAgICBjb25zdCBCX1QgPSBNYXRyaXgzX2RlZmF1bHQudHJhbnNwb3NlKEIsIGJ0U2NyYXRjaCk7CiAgICAgICAgY29uc3QgRF9JID0gTWF0cml4M19kZWZhdWx0LmZyb21TY2FsZShlbGxpcHNvaWQucmFkaWksIGRpU2NyYXRjaCk7CiAgICAgICAgY29uc3QgRCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tU2NhbGUoZWxsaXBzb2lkLm9uZU92ZXJSYWRpaSwgZFNjcmF0Y2gpOwogICAgICAgIGNvbnN0IEMgPSBjU2NyYXRjaDsKICAgICAgICBDWzBdID0gMDsKICAgICAgICBDWzFdID0gLWRpcmVjdGlvbjIuejsKICAgICAgICBDWzJdID0gZGlyZWN0aW9uMi55OwogICAgICAgIENbM10gPSBkaXJlY3Rpb24yLno7CiAgICAgICAgQ1s0XSA9IDA7CiAgICAgICAgQ1s1XSA9IC1kaXJlY3Rpb24yLng7CiAgICAgICAgQ1s2XSA9IC1kaXJlY3Rpb24yLnk7CiAgICAgICAgQ1s3XSA9IGRpcmVjdGlvbjIueDsKICAgICAgICBDWzhdID0gMDsKICAgICAgICBjb25zdCB0ZW1wID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5KAogICAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5KEJfVCwgRCwgdGVtcE1hdHJpeCksCiAgICAgICAgICBDLAogICAgICAgICAgdGVtcE1hdHJpeAogICAgICAgICk7CiAgICAgICAgY29uc3QgQSA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseSgKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseSh0ZW1wLCBEX0ksIGFTY3JhdGNoKSwKICAgICAgICAgIEIsCiAgICAgICAgICBhU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgYiA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRlbXAsIHBvc2l0aW9uLCBiQ2FydCk7CiAgICAgICAgY29uc3Qgc29sdXRpb25zID0gSW50ZXJzZWN0aW9uVGVzdHMucXVhZHJhdGljVmVjdG9yRXhwcmVzc2lvbigKICAgICAgICAgIEEsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGIsIGZpcnN0QXhpc1NjcmF0Y2gpLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICBsZXQgczsKICAgICAgICBsZXQgYWx0aXR1ZGU7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gc29sdXRpb25zLmxlbmd0aDsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgbGV0IGNsb3Nlc3QgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGNsb3Nlc3RTY3JhdGNoKTsKICAgICAgICAgIGxldCBtYXhpbXVtVmFsdWUgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIHMgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICAgICAgICBEX0ksCiAgICAgICAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoQiwgc29sdXRpb25zW2ldLCBzU2NyYXRjaCksCiAgICAgICAgICAgICAgc1NjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzLCBwb3NpdGlvbiwgcmVmZXJlbmNlU2NyYXRjaCksCiAgICAgICAgICAgICAgcmVmZXJlbmNlU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgICBjb25zdCBkb3RQcm9kdWN0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MywgZGlyZWN0aW9uMik7CiAgICAgICAgICAgIGlmIChkb3RQcm9kdWN0ID4gbWF4aW11bVZhbHVlKSB7CiAgICAgICAgICAgICAgbWF4aW11bVZhbHVlID0gZG90UHJvZHVjdDsKICAgICAgICAgICAgICBjbG9zZXN0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHMsIGNsb3Nlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBzdXJmYWNlUG9pbnQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIGNsb3Nlc3QsCiAgICAgICAgICAgIHN1cmZQb2ludFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBtYXhpbXVtVmFsdWUgPSBNYXRoX2RlZmF1bHQuY2xhbXAobWF4aW11bVZhbHVlLCAwLCAxKTsKICAgICAgICAgIGFsdGl0dWRlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNsb3Nlc3QsIHBvc2l0aW9uLCByZWZlcmVuY2VTY3JhdGNoKQogICAgICAgICAgKSAqIE1hdGguc3FydCgxIC0gbWF4aW11bVZhbHVlICogbWF4aW11bVZhbHVlKTsKICAgICAgICAgIGFsdGl0dWRlID0gaW50ZXJzZWN0czIgPyAtYWx0aXR1ZGUgOiBhbHRpdHVkZTsKICAgICAgICAgIHN1cmZhY2VQb2ludC5oZWlnaHQgPSBhbHRpdHVkZTsKICAgICAgICAgIHJldHVybiBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3VyZmFjZVBvaW50LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9OwogICAgICBsaW5lU2VnbWVudFBsYW5lRGlmZmVyZW5jZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZSA9IGZ1bmN0aW9uKGVuZFBvaW50MCwgZW5kUG9pbnQxLCBwbGFuZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZW5kUG9pbnQwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImVuZFBvaW50MCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZW5kUG9pbnQxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImVuZFBvaW50MSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGxhbmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGlmZmVyZW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGVuZFBvaW50MSwKICAgICAgICAgIGVuZFBvaW50MCwKICAgICAgICAgIGxpbmVTZWdtZW50UGxhbmVEaWZmZXJlbmNlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IG5Eb3REaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBkaWZmZXJlbmNlKTsKICAgICAgICBpZiAoTWF0aC5hYnMobkRvdERpZmYpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBuRG90UDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIGVuZFBvaW50MCk7CiAgICAgICAgY29uc3QgdCA9IC0ocGxhbmUuZGlzdGFuY2UgKyBuRG90UDApIC8gbkRvdERpZmY7CiAgICAgICAgaWYgKHQgPCAwIHx8IHQgPiAxKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaWZmZXJlbmNlLCB0LCByZXN1bHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZW5kUG9pbnQwLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMudHJpYW5nbGVQbGFuZUludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHAwLCBwMSwgcDIsIHBsYW5lKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDApIHx8ICFkZWZpbmVkX2RlZmF1bHQocDEpIHx8ICFkZWZpbmVkX2RlZmF1bHQocDIpIHx8ICFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDAsIHAxLCBwMiwgYW5kIHBsYW5lIGFyZSByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGxhbmVOb3JtYWwgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgcGxhbmVEID0gcGxhbmUuZGlzdGFuY2U7CiAgICAgICAgY29uc3QgcDBCZWhpbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHBsYW5lTm9ybWFsLCBwMCkgKyBwbGFuZUQgPCAwOwogICAgICAgIGNvbnN0IHAxQmVoaW5kID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChwbGFuZU5vcm1hbCwgcDEpICsgcGxhbmVEIDwgMDsKICAgICAgICBjb25zdCBwMkJlaGluZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QocGxhbmVOb3JtYWwsIHAyKSArIHBsYW5lRCA8IDA7CiAgICAgICAgbGV0IG51bUJlaGluZCA9IDA7CiAgICAgICAgbnVtQmVoaW5kICs9IHAwQmVoaW5kID8gMSA6IDA7CiAgICAgICAgbnVtQmVoaW5kICs9IHAxQmVoaW5kID8gMSA6IDA7CiAgICAgICAgbnVtQmVoaW5kICs9IHAyQmVoaW5kID8gMSA6IDA7CiAgICAgICAgbGV0IHUxMiwgdTIyOwogICAgICAgIGlmIChudW1CZWhpbmQgPT09IDEgfHwgbnVtQmVoaW5kID09PSAyKSB7CiAgICAgICAgICB1MTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgICB1MjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGlmIChudW1CZWhpbmQgPT09IDEpIHsKICAgICAgICAgIGlmIChwMEJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAwLCBwMSwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDAsIHAyLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChwMUJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAxLCBwMiwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDEsIHAwLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMiwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMiwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChwMkJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAyLCBwMCwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDIsIHAxLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobnVtQmVoaW5kID09PSAyKSB7CiAgICAgICAgICBpZiAoIXAwQmVoaW5kKSB7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDEsIHAwLCBwbGFuZSwgdTEyKTsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMiwgcDAsIHBsYW5lLCB1MjIpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHBvc2l0aW9uczogW3AwLCBwMSwgcDIsIHUxMiwgdTIyXSwKICAgICAgICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAgICAgICAvLyBCZWhpbmQKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIC8vIEluIGZyb250CiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKCFwMUJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAyLCBwMSwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDAsIHAxLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDMsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDMsCiAgICAgICAgICAgICAgICA0CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmICghcDJCZWhpbmQpIHsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMCwgcDIsIHBsYW5lLCB1MTIpOwogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAxLCBwMiwgcGxhbmUsIHUyMik7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgcG9zaXRpb25zOiBbcDAsIHAxLCBwMiwgdTEyLCB1MjJdLAogICAgICAgICAgICAgIGluZGljZXM6IFsKICAgICAgICAgICAgICAgIC8vIEJlaGluZAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgLy8gSW4gZnJvbnQKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgNAogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdCA9IEludGVyc2VjdGlvblRlc3RzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGxhbmUuanMKICBmdW5jdGlvbiBQbGFuZShub3JtYWwyLCBkaXN0YW5jZSkgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJub3JtYWwiLCBub3JtYWwyKTsKICAgIGlmICghTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUobm9ybWFsMiksCiAgICAgIDEsCiAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONgogICAgKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsIG11c3QgYmUgbm9ybWFsaXplZC4iKTsKICAgIH0KICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiZGlzdGFuY2UiLCBkaXN0YW5jZSk7CiAgICB0aGlzLm5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShub3JtYWwyKTsKICAgIHRoaXMuZGlzdGFuY2UgPSBkaXN0YW5jZTsKICB9CiAgdmFyIHNjcmF0Y2hOb3JtYWwsIHNjcmF0Y2hDYXJ0ZXNpYW4sIHNjcmF0Y2hJbnZlcnNlVHJhbnNwb3NlLCBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40LCBzY3JhdGNoVHJhbnNmb3JtTm9ybWFsLCBQbGFuZV9kZWZhdWx0OwogIHZhciBpbml0X1BsYW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QbGFuZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIFBsYW5lLmZyb21Qb2ludE5vcm1hbCA9IGZ1bmN0aW9uKHBvaW50LCBub3JtYWwyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibm9ybWFsIiwgbm9ybWFsMik7CiAgICAgICAgaWYgKCFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUobm9ybWFsMiksCiAgICAgICAgICAxLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT042CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5vcm1hbCBtdXN0IGJlIG5vcm1hbGl6ZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRpc3RhbmNlID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgcG9pbnQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGxhbmUobm9ybWFsMiwgZGlzdGFuY2UpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobm9ybWFsMiwgcmVzdWx0Lm5vcm1hbCk7CiAgICAgICAgcmVzdWx0LmRpc3RhbmNlID0gZGlzdGFuY2U7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaE5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUGxhbmUuZnJvbUNhcnRlc2lhbjQgPSBmdW5jdGlvbihjb2VmZmljaWVudHMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29lZmZpY2llbnRzIiwgY29lZmZpY2llbnRzKTsKICAgICAgICBjb25zdCBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KGNvZWZmaWNpZW50cywgc2NyYXRjaE5vcm1hbCk7CiAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBjb2VmZmljaWVudHMudzsKICAgICAgICBpZiAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShub3JtYWwyKSwKICAgICAgICAgIDEsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjYKICAgICAgICApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsIG11c3QgYmUgbm9ybWFsaXplZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBQbGFuZShub3JtYWwyLCBkaXN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShub3JtYWwyLCByZXN1bHQubm9ybWFsKTsKICAgICAgICByZXN1bHQuZGlzdGFuY2UgPSBkaXN0YW5jZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQbGFuZS5nZXRQb2ludERpc3RhbmNlID0gZnVuY3Rpb24ocGxhbmUsIHBvaW50KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHBsYW5lLm5vcm1hbCwgcG9pbnQpICsgcGxhbmUuZGlzdGFuY2U7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBsYW5lLnByb2plY3RQb2ludE9udG9QbGFuZSA9IGZ1bmN0aW9uKHBsYW5lLCBwb2ludCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9pbnREaXN0YW5jZSA9IFBsYW5lLmdldFBvaW50RGlzdGFuY2UocGxhbmUsIHBvaW50KTsKICAgICAgICBjb25zdCBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIHBsYW5lLm5vcm1hbCwKICAgICAgICAgIHBvaW50RGlzdGFuY2UsCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvaW50LCBzY2FsZWROb3JtYWwsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hJbnZlcnNlVHJhbnNwb3NlID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40ID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVHJhbnNmb3JtTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQbGFuZS50cmFuc2Zvcm0gPSBmdW5jdGlvbihwbGFuZSwgdHJhbnNmb3JtMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zZm9ybSIsIHRyYW5zZm9ybTIpOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBwbGFuZS5kaXN0YW5jZTsKICAgICAgICBjb25zdCBpbnZlcnNlVHJhbnNwb3NlMiA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNwb3NlKAogICAgICAgICAgdHJhbnNmb3JtMiwKICAgICAgICAgIHNjcmF0Y2hJbnZlcnNlVHJhbnNwb3NlCiAgICAgICAgKTsKICAgICAgICBsZXQgcGxhbmVBc0NhcnRlc2lhbjQgPSBDYXJ0ZXNpYW40X2RlZmF1bHQuZnJvbUVsZW1lbnRzKAogICAgICAgICAgbm9ybWFsMi54LAogICAgICAgICAgbm9ybWFsMi55LAogICAgICAgICAgbm9ybWFsMi56LAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40CiAgICAgICAgKTsKICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgaW52ZXJzZVRyYW5zcG9zZTIsCiAgICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCwKICAgICAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40CiAgICAgICAgKTsKICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuNCgKICAgICAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40LAogICAgICAgICAgc2NyYXRjaFRyYW5zZm9ybU5vcm1hbAogICAgICAgICk7CiAgICAgICAgcGxhbmVBc0NhcnRlc2lhbjQgPSBDYXJ0ZXNpYW40X2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIoCiAgICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUodHJhbnNmb3JtZWROb3JtYWwpLAogICAgICAgICAgcGxhbmVBc0NhcnRlc2lhbjQKICAgICAgICApOwogICAgICAgIHJldHVybiBQbGFuZS5mcm9tQ2FydGVzaWFuNChwbGFuZUFzQ2FydGVzaWFuNCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUGxhbmUuY2xvbmUgPSBmdW5jdGlvbihwbGFuZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBsYW5lKHBsYW5lLm5vcm1hbCwgcGxhbmUuZGlzdGFuY2UpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocGxhbmUubm9ybWFsLCByZXN1bHQubm9ybWFsKTsKICAgICAgICByZXN1bHQuZGlzdGFuY2UgPSBwbGFuZS5kaXN0YW5jZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQbGFuZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQuZGlzdGFuY2UgPT09IHJpZ2h0LmRpc3RhbmNlICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobGVmdC5ub3JtYWwsIHJpZ2h0Lm5vcm1hbCk7CiAgICAgIH07CiAgICAgIFBsYW5lLk9SSUdJTl9YWV9QTEFORSA9IE9iamVjdC5mcmVlemUobmV3IFBsYW5lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIDApKTsKICAgICAgUGxhbmUuT1JJR0lOX1laX1BMQU5FID0gT2JqZWN0LmZyZWV6ZShuZXcgUGxhbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgMCkpOwogICAgICBQbGFuZS5PUklHSU5fWlhfUExBTkUgPSBPYmplY3QuZnJlZXplKG5ldyBQbGFuZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLCAwKSk7CiAgICAgIFBsYW5lX2RlZmF1bHQgPSBQbGFuZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpcHNpZnkuanMKICB2YXIgVGlwc2lmeSwgVGlwc2lmeV9kZWZhdWx0OwogIHZhciBpbml0X1RpcHNpZnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpcHNpZnkuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBUaXBzaWZ5ID0ge307CiAgICAgIFRpcHNpZnkuY2FsY3VsYXRlQUNNUiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gb3B0aW9ucy5pbmRpY2VzOwogICAgICAgIGxldCBtYXhpbXVtSW5kZXggPSBvcHRpb25zLm1heGltdW1JbmRleDsKICAgICAgICBjb25zdCBjYWNoZVNpemUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNhY2hlU2l6ZSwgMjQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaW5kaWNlcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGlmIChudW1JbmRpY2VzIDwgMyB8fCBudW1JbmRpY2VzICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImluZGljZXMgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiB0aHJlZS4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1heGltdW1JbmRleCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF4aW11bUluZGV4IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmIChjYWNoZVNpemUgPCAzKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FjaGVTaXplIG11c3QgYmUgZ3JlYXRlciB0aGFuIHR3by4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWF4aW11bUluZGV4KSkgewogICAgICAgICAgbWF4aW11bUluZGV4ID0gMDsKICAgICAgICAgIGxldCBjdXJyZW50SW5kZXggPSAwOwogICAgICAgICAgbGV0IGludG9JbmRpY2VzID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRJbmRleCA8IG51bUluZGljZXMpIHsKICAgICAgICAgICAgaWYgKGludG9JbmRpY2VzID4gbWF4aW11bUluZGV4KSB7CiAgICAgICAgICAgICAgbWF4aW11bUluZGV4ID0gaW50b0luZGljZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytjdXJyZW50SW5kZXg7CiAgICAgICAgICAgIGludG9JbmRpY2VzID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJ0ZXhUaW1lU3RhbXBzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhpbXVtSW5kZXggKyAxOyBpKyspIHsKICAgICAgICAgIHZlcnRleFRpbWVTdGFtcHNbaV0gPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgcyA9IGNhY2hlU2l6ZSArIDE7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBudW1JbmRpY2VzOyArK2opIHsKICAgICAgICAgIGlmIChzIC0gdmVydGV4VGltZVN0YW1wc1tpbmRpY2VzW2pdXSA+IGNhY2hlU2l6ZSkgewogICAgICAgICAgICB2ZXJ0ZXhUaW1lU3RhbXBzW2luZGljZXNbal1dID0gczsKICAgICAgICAgICAgKytzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gKHMgLSBjYWNoZVNpemUgKyAxKSAvIChudW1JbmRpY2VzIC8gMyk7CiAgICAgIH07CiAgICAgIFRpcHNpZnkudGlwc2lmeSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gb3B0aW9ucy5pbmRpY2VzOwogICAgICAgIGNvbnN0IG1heGltdW1JbmRleCA9IG9wdGlvbnMubWF4aW11bUluZGV4OwogICAgICAgIGNvbnN0IGNhY2hlU2l6ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY2FjaGVTaXplLCAyNCk7CiAgICAgICAgbGV0IGN1cnNvcjsKICAgICAgICBmdW5jdGlvbiBza2lwRGVhZEVuZCh2ZXJ0aWNlczIsIGRlYWRFbmQyLCBpbmRpY2VzMiwgbWF4aW11bUluZGV4UGx1c09uZTIpIHsKICAgICAgICAgIHdoaWxlIChkZWFkRW5kMi5sZW5ndGggPj0gMSkgewogICAgICAgICAgICBjb25zdCBkID0gZGVhZEVuZDJbZGVhZEVuZDIubGVuZ3RoIC0gMV07CiAgICAgICAgICAgIGRlYWRFbmQyLnNwbGljZShkZWFkRW5kMi5sZW5ndGggLSAxLCAxKTsKICAgICAgICAgICAgaWYgKHZlcnRpY2VzMltkXS5udW1MaXZlVHJpYW5nbGVzID4gMCkgewogICAgICAgICAgICAgIHJldHVybiBkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoY3Vyc29yIDwgbWF4aW11bUluZGV4UGx1c09uZTIpIHsKICAgICAgICAgICAgaWYgKHZlcnRpY2VzMltjdXJzb3JdLm51bUxpdmVUcmlhbmdsZXMgPiAwKSB7CiAgICAgICAgICAgICAgKytjdXJzb3I7CiAgICAgICAgICAgICAgcmV0dXJuIGN1cnNvciAtIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytjdXJzb3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRWZXJ0ZXgoaW5kaWNlczIsIGNhY2hlU2l6ZTIsIG9uZVJpbmcyLCB2ZXJ0aWNlczIsIHMyLCBkZWFkRW5kMiwgbWF4aW11bUluZGV4UGx1c09uZTIpIHsKICAgICAgICAgIGxldCBuID0gLTE7CiAgICAgICAgICBsZXQgcDsKICAgICAgICAgIGxldCBtID0gLTE7CiAgICAgICAgICBsZXQgaXRPbmVSaW5nID0gMDsKICAgICAgICAgIHdoaWxlIChpdE9uZVJpbmcgPCBvbmVSaW5nMi5sZW5ndGgpIHsKICAgICAgICAgICAgY29uc3QgaW5kZXgyID0gb25lUmluZzJbaXRPbmVSaW5nXTsKICAgICAgICAgICAgaWYgKHZlcnRpY2VzMltpbmRleDJdLm51bUxpdmVUcmlhbmdsZXMpIHsKICAgICAgICAgICAgICBwID0gMDsKICAgICAgICAgICAgICBpZiAoczIgLSB2ZXJ0aWNlczJbaW5kZXgyXS50aW1lU3RhbXAgKyAyICogdmVydGljZXMyW2luZGV4Ml0ubnVtTGl2ZVRyaWFuZ2xlcyA8PSBjYWNoZVNpemUyKSB7CiAgICAgICAgICAgICAgICBwID0gczIgLSB2ZXJ0aWNlczJbaW5kZXgyXS50aW1lU3RhbXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwID4gbSB8fCBtID09PSAtMSkgewogICAgICAgICAgICAgICAgbSA9IHA7CiAgICAgICAgICAgICAgICBuID0gaW5kZXgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICArK2l0T25lUmluZzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gc2tpcERlYWRFbmQodmVydGljZXMyLCBkZWFkRW5kMiwgaW5kaWNlczIsIG1heGltdW1JbmRleFBsdXNPbmUyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImluZGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSBpbmRpY2VzLmxlbmd0aDsKICAgICAgICBpZiAobnVtSW5kaWNlcyA8IDMgfHwgbnVtSW5kaWNlcyAlIDMgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbmRpY2VzIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgdGhyZWUuIik7CiAgICAgICAgfQogICAgICAgIGlmIChtYXhpbXVtSW5kZXggPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1heGltdW1JbmRleCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoY2FjaGVTaXplIDwgMykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNhY2hlU2l6ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB0d28uIik7CiAgICAgICAgfQogICAgICAgIGxldCBtYXhpbXVtSW5kZXhQbHVzT25lID0gMDsKICAgICAgICBsZXQgY3VycmVudEluZGV4ID0gMDsKICAgICAgICBsZXQgaW50b0luZGljZXMgPSBpbmRpY2VzW2N1cnJlbnRJbmRleF07CiAgICAgICAgY29uc3QgZW5kSW5kZXggPSBudW1JbmRpY2VzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUluZGV4KSkgewogICAgICAgICAgbWF4aW11bUluZGV4UGx1c09uZSA9IG1heGltdW1JbmRleCArIDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdoaWxlIChjdXJyZW50SW5kZXggPCBlbmRJbmRleCkgewogICAgICAgICAgICBpZiAoaW50b0luZGljZXMgPiBtYXhpbXVtSW5kZXhQbHVzT25lKSB7CiAgICAgICAgICAgICAgbWF4aW11bUluZGV4UGx1c09uZSA9IGludG9JbmRpY2VzOwogICAgICAgICAgICB9CiAgICAgICAgICAgICsrY3VycmVudEluZGV4OwogICAgICAgICAgICBpbnRvSW5kaWNlcyA9IGluZGljZXNbY3VycmVudEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXhpbXVtSW5kZXhQbHVzT25lID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgICsrbWF4aW11bUluZGV4UGx1c09uZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBbXTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbWF4aW11bUluZGV4UGx1c09uZTsgaSsrKSB7CiAgICAgICAgICB2ZXJ0aWNlc1tpXSA9IHsKICAgICAgICAgICAgbnVtTGl2ZVRyaWFuZ2xlczogMCwKICAgICAgICAgICAgdGltZVN0YW1wOiAwLAogICAgICAgICAgICB2ZXJ0ZXhUcmlhbmdsZXM6IFtdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBjdXJyZW50SW5kZXggPSAwOwogICAgICAgIGxldCB0cmlhbmdsZSA9IDA7CiAgICAgICAgd2hpbGUgKGN1cnJlbnRJbmRleCA8IGVuZEluZGV4KSB7CiAgICAgICAgICB2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleF1dLnZlcnRleFRyaWFuZ2xlcy5wdXNoKHRyaWFuZ2xlKTsKICAgICAgICAgICsrdmVydGljZXNbaW5kaWNlc1tjdXJyZW50SW5kZXhdXS5udW1MaXZlVHJpYW5nbGVzOwogICAgICAgICAgdmVydGljZXNbaW5kaWNlc1tjdXJyZW50SW5kZXggKyAxXV0udmVydGV4VHJpYW5nbGVzLnB1c2godHJpYW5nbGUpOwogICAgICAgICAgKyt2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleCArIDFdXS5udW1MaXZlVHJpYW5nbGVzOwogICAgICAgICAgdmVydGljZXNbaW5kaWNlc1tjdXJyZW50SW5kZXggKyAyXV0udmVydGV4VHJpYW5nbGVzLnB1c2godHJpYW5nbGUpOwogICAgICAgICAgKyt2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleCArIDJdXS5udW1MaXZlVHJpYW5nbGVzOwogICAgICAgICAgKyt0cmlhbmdsZTsKICAgICAgICAgIGN1cnJlbnRJbmRleCArPSAzOwogICAgICAgIH0KICAgICAgICBsZXQgZiA9IDA7CiAgICAgICAgbGV0IHMgPSBjYWNoZVNpemUgKyAxOwogICAgICAgIGN1cnNvciA9IDE7CiAgICAgICAgbGV0IG9uZVJpbmcgPSBbXTsKICAgICAgICBjb25zdCBkZWFkRW5kID0gW107CiAgICAgICAgbGV0IHZlcnRleDsKICAgICAgICBsZXQgaW50b1ZlcnRpY2VzOwogICAgICAgIGxldCBjdXJyZW50T3V0cHV0SW5kZXggPSAwOwogICAgICAgIGNvbnN0IG91dHB1dEluZGljZXMgPSBbXTsKICAgICAgICBjb25zdCBudW1UcmlhbmdsZXMgPSBudW1JbmRpY2VzIC8gMzsKICAgICAgICBjb25zdCB0cmlhbmdsZUVtaXR0ZWQgPSBbXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVHJpYW5nbGVzOyBpKyspIHsKICAgICAgICAgIHRyaWFuZ2xlRW1pdHRlZFtpXSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBsZXQgaW5kZXg7CiAgICAgICAgbGV0IGxpbWl0OwogICAgICAgIHdoaWxlIChmICE9PSAtMSkgewogICAgICAgICAgb25lUmluZyA9IFtdOwogICAgICAgICAgaW50b1ZlcnRpY2VzID0gdmVydGljZXNbZl07CiAgICAgICAgICBsaW1pdCA9IGludG9WZXJ0aWNlcy52ZXJ0ZXhUcmlhbmdsZXMubGVuZ3RoOwogICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBsaW1pdDsgKytrKSB7CiAgICAgICAgICAgIHRyaWFuZ2xlID0gaW50b1ZlcnRpY2VzLnZlcnRleFRyaWFuZ2xlc1trXTsKICAgICAgICAgICAgaWYgKCF0cmlhbmdsZUVtaXR0ZWRbdHJpYW5nbGVdKSB7CiAgICAgICAgICAgICAgdHJpYW5nbGVFbWl0dGVkW3RyaWFuZ2xlXSA9IHRydWU7CiAgICAgICAgICAgICAgY3VycmVudEluZGV4ID0gdHJpYW5nbGUgKyB0cmlhbmdsZSArIHRyaWFuZ2xlOwogICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMzsgKytqKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IGluZGljZXNbY3VycmVudEluZGV4XTsKICAgICAgICAgICAgICAgIG9uZVJpbmcucHVzaChpbmRleCk7CiAgICAgICAgICAgICAgICBkZWFkRW5kLnB1c2goaW5kZXgpOwogICAgICAgICAgICAgICAgb3V0cHV0SW5kaWNlc1tjdXJyZW50T3V0cHV0SW5kZXhdID0gaW5kZXg7CiAgICAgICAgICAgICAgICArK2N1cnJlbnRPdXRwdXRJbmRleDsKICAgICAgICAgICAgICAgIHZlcnRleCA9IHZlcnRpY2VzW2luZGV4XTsKICAgICAgICAgICAgICAgIC0tdmVydGV4Lm51bUxpdmVUcmlhbmdsZXM7CiAgICAgICAgICAgICAgICBpZiAocyAtIHZlcnRleC50aW1lU3RhbXAgPiBjYWNoZVNpemUpIHsKICAgICAgICAgICAgICAgICAgdmVydGV4LnRpbWVTdGFtcCA9IHM7CiAgICAgICAgICAgICAgICAgICsrczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICsrY3VycmVudEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZiA9IGdldE5leHRWZXJ0ZXgoCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIGNhY2hlU2l6ZSwKICAgICAgICAgICAgb25lUmluZywKICAgICAgICAgICAgdmVydGljZXMsCiAgICAgICAgICAgIHMsCiAgICAgICAgICAgIGRlYWRFbmQsCiAgICAgICAgICAgIG1heGltdW1JbmRleFBsdXNPbmUKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXRwdXRJbmRpY2VzOwogICAgICB9OwogICAgICBUaXBzaWZ5X2RlZmF1bHQgPSBUaXBzaWZ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlQaXBlbGluZS5qcwogIGZ1bmN0aW9uIGFkZFRyaWFuZ2xlKGxpbmVzLCBpbmRleCwgaTAsIGkxLCBpMikgewogICAgbGluZXNbaW5kZXgrK10gPSBpMDsKICAgIGxpbmVzW2luZGV4KytdID0gaTE7CiAgICBsaW5lc1tpbmRleCsrXSA9IGkxOwogICAgbGluZXNbaW5kZXgrK10gPSBpMjsKICAgIGxpbmVzW2luZGV4KytdID0gaTI7CiAgICBsaW5lc1tpbmRleF0gPSBpMDsKICB9CiAgZnVuY3Rpb24gdHJpYW5nbGVzVG9MaW5lcyh0cmlhbmdsZXMpIHsKICAgIGNvbnN0IGNvdW50ID0gdHJpYW5nbGVzLmxlbmd0aDsKICAgIGNvbnN0IHNpemUgPSBjb3VudCAvIDMgKiA2OwogICAgY29uc3QgbGluZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShjb3VudCwgc2l6ZSk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSArPSAzLCBpbmRleCArPSA2KSB7CiAgICAgIGFkZFRyaWFuZ2xlKGxpbmVzLCBpbmRleCwgdHJpYW5nbGVzW2ldLCB0cmlhbmdsZXNbaSArIDFdLCB0cmlhbmdsZXNbaSArIDJdKTsKICAgIH0KICAgIHJldHVybiBsaW5lczsKICB9CiAgZnVuY3Rpb24gdHJpYW5nbGVTdHJpcFRvTGluZXModHJpYW5nbGVzKSB7CiAgICBjb25zdCBjb3VudCA9IHRyaWFuZ2xlcy5sZW5ndGg7CiAgICBpZiAoY291bnQgPj0gMykgewogICAgICBjb25zdCBzaXplID0gKGNvdW50IC0gMikgKiA2OwogICAgICBjb25zdCBsaW5lcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGNvdW50LCBzaXplKTsKICAgICAgYWRkVHJpYW5nbGUobGluZXMsIDAsIHRyaWFuZ2xlc1swXSwgdHJpYW5nbGVzWzFdLCB0cmlhbmdsZXNbMl0pOwogICAgICBsZXQgaW5kZXggPSA2OwogICAgICBmb3IgKGxldCBpID0gMzsgaSA8IGNvdW50OyArK2ksIGluZGV4ICs9IDYpIHsKICAgICAgICBhZGRUcmlhbmdsZSgKICAgICAgICAgIGxpbmVzLAogICAgICAgICAgaW5kZXgsCiAgICAgICAgICB0cmlhbmdsZXNbaSAtIDFdLAogICAgICAgICAgdHJpYW5nbGVzW2ldLAogICAgICAgICAgdHJpYW5nbGVzW2kgLSAyXQogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpbmVzOwogICAgfQogICAgcmV0dXJuIG5ldyBVaW50MTZBcnJheSgpOwogIH0KICBmdW5jdGlvbiB0cmlhbmdsZUZhblRvTGluZXModHJpYW5nbGVzKSB7CiAgICBpZiAodHJpYW5nbGVzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgY291bnQgPSB0cmlhbmdsZXMubGVuZ3RoIC0gMTsKICAgICAgY29uc3Qgc2l6ZSA9IChjb3VudCAtIDEpICogNjsKICAgICAgY29uc3QgbGluZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShjb3VudCwgc2l6ZSk7CiAgICAgIGNvbnN0IGJhc2UgPSB0cmlhbmdsZXNbMF07CiAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgY291bnQ7ICsraSwgaW5kZXggKz0gNikgewogICAgICAgIGFkZFRyaWFuZ2xlKGxpbmVzLCBpbmRleCwgYmFzZSwgdHJpYW5nbGVzW2ldLCB0cmlhbmdsZXNbaSArIDFdKTsKICAgICAgfQogICAgICByZXR1cm4gbGluZXM7CiAgICB9CiAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KCk7CiAgfQogIGZ1bmN0aW9uIGNvcHlBdHRyaWJ1dGVzRGVzY3JpcHRpb25zKGF0dHJpYnV0ZXMpIHsKICAgIGNvbnN0IG5ld0F0dHJpYnV0ZXMgPSB7fTsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cmlidXRlKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1thdHRyaWJ1dGVdKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1thdHRyaWJ1dGVdLnZhbHVlcykpIHsKICAgICAgICBjb25zdCBhdHRyID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdOwogICAgICAgIG5ld0F0dHJpYnV0ZXNbYXR0cmlidXRlXSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBhdHRyLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogYXR0ci5jb21wb25lbnRzUGVyQXR0cmlidXRlLAogICAgICAgICAgbm9ybWFsaXplOiBhdHRyLm5vcm1hbGl6ZSwKICAgICAgICAgIHZhbHVlczogW10KICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ld0F0dHJpYnV0ZXM7CiAgfQogIGZ1bmN0aW9uIGNvcHlWZXJ0ZXgoZGVzdGluYXRpb25BdHRyaWJ1dGVzLCBzb3VyY2VBdHRyaWJ1dGVzLCBpbmRleCkgewogICAgZm9yIChjb25zdCBhdHRyaWJ1dGUgaW4gc291cmNlQXR0cmlidXRlcykgewogICAgICBpZiAoc291cmNlQXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShhdHRyaWJ1dGUpICYmIGRlZmluZWRfZGVmYXVsdChzb3VyY2VBdHRyaWJ1dGVzW2F0dHJpYnV0ZV0pICYmIGRlZmluZWRfZGVmYXVsdChzb3VyY2VBdHRyaWJ1dGVzW2F0dHJpYnV0ZV0udmFsdWVzKSkgewogICAgICAgIGNvbnN0IGF0dHIgPSBzb3VyY2VBdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CiAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBhdHRyLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7ICsraykgewogICAgICAgICAgZGVzdGluYXRpb25BdHRyaWJ1dGVzW2F0dHJpYnV0ZV0udmFsdWVzLnB1c2goCiAgICAgICAgICAgIGF0dHIudmFsdWVzW2luZGV4ICogYXR0ci5jb21wb25lbnRzUGVyQXR0cmlidXRlICsga10KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zZm9ybVBvaW50KG1hdHJpeCwgYXR0cmlidXRlKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZSkpIHsKICAgICAgY29uc3QgdmFsdWVzID0gYXR0cmlidXRlLnZhbHVlczsKICAgICAgY29uc3QgbGVuZ3RoID0gdmFsdWVzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sodmFsdWVzLCBpLCBzY3JhdGNoQ2FydGVzaWFuMzMpOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQobWF0cml4LCBzY3JhdGNoQ2FydGVzaWFuMzMsIHNjcmF0Y2hDYXJ0ZXNpYW4zMyk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc2NyYXRjaENhcnRlc2lhbjMzLCB2YWx1ZXMsIGkpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zZm9ybVZlY3RvcihtYXRyaXgsIGF0dHJpYnV0ZSkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGUpKSB7CiAgICAgIGNvbnN0IHZhbHVlcyA9IGF0dHJpYnV0ZS52YWx1ZXM7CiAgICAgIGNvbnN0IGxlbmd0aCA9IHZhbHVlcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHZhbHVlcywgaSwgc2NyYXRjaENhcnRlc2lhbjMzKTsKICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihtYXRyaXgsIHNjcmF0Y2hDYXJ0ZXNpYW4zMywgc2NyYXRjaENhcnRlc2lhbjMzKTsKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjMzLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjMzCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhzY3JhdGNoQ2FydGVzaWFuMzMsIHZhbHVlcywgaSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZmluZEF0dHJpYnV0ZXNJbkFsbEdlb21ldHJpZXMoaW5zdGFuY2VzLCBwcm9wZXJ0eU5hbWUpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBjb25zdCBhdHRyaWJ1dGVzSW5BbGxHZW9tZXRyaWVzID0ge307CiAgICBjb25zdCBhdHRyaWJ1dGVzMCA9IGluc3RhbmNlc1swXVtwcm9wZXJ0eU5hbWVdLmF0dHJpYnV0ZXM7CiAgICBsZXQgbmFtZTsKICAgIGZvciAobmFtZSBpbiBhdHRyaWJ1dGVzMCkgewogICAgICBpZiAoYXR0cmlidXRlczAuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMwW25hbWVdKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlczBbbmFtZV0udmFsdWVzKSkgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXMwW25hbWVdOwogICAgICAgIGxldCBudW1iZXJPZkNvbXBvbmVudHMgPSBhdHRyaWJ1dGUudmFsdWVzLmxlbmd0aDsKICAgICAgICBsZXQgaW5BbGxHZW9tZXRyaWVzID0gdHJ1ZTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBvdGhlckF0dHJpYnV0ZSA9IGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdLmF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvdGhlckF0dHJpYnV0ZSkgfHwgYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlICE9PSBvdGhlckF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSB8fCBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZSAhPT0gb3RoZXJBdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZSB8fCBhdHRyaWJ1dGUubm9ybWFsaXplICE9PSBvdGhlckF0dHJpYnV0ZS5ub3JtYWxpemUpIHsKICAgICAgICAgICAgaW5BbGxHZW9tZXRyaWVzID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgbnVtYmVyT2ZDb21wb25lbnRzICs9IG90aGVyQXR0cmlidXRlLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGlmIChpbkFsbEdlb21ldHJpZXMpIHsKICAgICAgICAgIGF0dHJpYnV0ZXNJbkFsbEdlb21ldHJpZXNbbmFtZV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBhdHRyaWJ1dGUuY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlLAogICAgICAgICAgICBub3JtYWxpemU6IGF0dHJpYnV0ZS5ub3JtYWxpemUsCiAgICAgICAgICAgIHZhbHVlczogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgICAgIGF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSwKICAgICAgICAgICAgICBudW1iZXJPZkNvbXBvbmVudHMKICAgICAgICAgICAgKQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gYXR0cmlidXRlc0luQWxsR2VvbWV0cmllczsKICB9CiAgZnVuY3Rpb24gY29tYmluZUdlb21ldHJpZXMoaW5zdGFuY2VzLCBwcm9wZXJ0eU5hbWUpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBsZXQgbmFtZTsKICAgIGxldCBpOwogICAgbGV0IGo7CiAgICBsZXQgazsKICAgIGNvbnN0IG0gPSBpbnN0YW5jZXNbMF0ubW9kZWxNYXRyaXg7CiAgICBjb25zdCBoYXZlSW5kaWNlcyA9IGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbMF1bcHJvcGVydHlOYW1lXS5pbmRpY2VzKTsKICAgIGNvbnN0IHByaW1pdGl2ZVR5cGUgPSBpbnN0YW5jZXNbMF1bcHJvcGVydHlOYW1lXS5wcmltaXRpdmVUeXBlOwogICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmICghTWF0cml4NF9kZWZhdWx0LmVxdWFscyhpbnN0YW5jZXNbaV0ubW9kZWxNYXRyaXgsIG0pKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkFsbCBpbnN0YW5jZXMgbXVzdCBoYXZlIHRoZSBzYW1lIG1vZGVsTWF0cml4LiIpOwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uaW5kaWNlcykgIT09IGhhdmVJbmRpY2VzKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiQWxsIGluc3RhbmNlIGdlb21ldHJpZXMgbXVzdCBoYXZlIGFuIGluZGljZXMgb3Igbm90IGhhdmUgb25lLiIKICAgICAgICApOwogICAgICB9CiAgICAgIGlmIChpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5wcmltaXRpdmVUeXBlICE9PSBwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiQWxsIGluc3RhbmNlIGdlb21ldHJpZXMgbXVzdCBoYXZlIHRoZSBzYW1lIHByaW1pdGl2ZVR5cGUuIgogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBmaW5kQXR0cmlidXRlc0luQWxsR2VvbWV0cmllcyhpbnN0YW5jZXMsIHByb3BlcnR5TmFtZSk7CiAgICBsZXQgdmFsdWVzOwogICAgbGV0IHNvdXJjZVZhbHVlczsKICAgIGxldCBzb3VyY2VWYWx1ZXNMZW5ndGg7CiAgICBmb3IgKG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIHZhbHVlcyA9IGF0dHJpYnV0ZXNbbmFtZV0udmFsdWVzOwogICAgICAgIGsgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgc291cmNlVmFsdWVzID0gaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uYXR0cmlidXRlc1tuYW1lXS52YWx1ZXM7CiAgICAgICAgICBzb3VyY2VWYWx1ZXNMZW5ndGggPSBzb3VyY2VWYWx1ZXMubGVuZ3RoOwogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHNvdXJjZVZhbHVlc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICAgIHZhbHVlc1trKytdID0gc291cmNlVmFsdWVzW2pdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IGluZGljZXM7CiAgICBpZiAoaGF2ZUluZGljZXMpIHsKICAgICAgbGV0IG51bWJlck9mSW5kaWNlcyA9IDA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIG51bWJlck9mSW5kaWNlcyArPSBpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5pbmRpY2VzLmxlbmd0aDsKICAgICAgfQogICAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcygKICAgICAgICBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlBPSU5UUwogICAgICAgIH0pCiAgICAgICk7CiAgICAgIGNvbnN0IGRlc3RJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgbnVtYmVyT2ZWZXJ0aWNlcywKICAgICAgICBudW1iZXJPZkluZGljZXMKICAgICAgKTsKICAgICAgbGV0IGRlc3RPZmZzZXQgPSAwOwogICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgY29uc3Qgc291cmNlSW5kaWNlcyA9IGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdLmluZGljZXM7CiAgICAgICAgY29uc3Qgc291cmNlSW5kaWNlc0xlbiA9IHNvdXJjZUluZGljZXMubGVuZ3RoOwogICAgICAgIGZvciAoayA9IDA7IGsgPCBzb3VyY2VJbmRpY2VzTGVuOyArK2spIHsKICAgICAgICAgIGRlc3RJbmRpY2VzW2Rlc3RPZmZzZXQrK10gPSBvZmZzZXQgKyBzb3VyY2VJbmRpY2VzW2tdOwogICAgICAgIH0KICAgICAgICBvZmZzZXQgKz0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXSk7CiAgICAgIH0KICAgICAgaW5kaWNlcyA9IGRlc3RJbmRpY2VzOwogICAgfQogICAgbGV0IGNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIGxldCByYWRpdXMgPSAwOwogICAgbGV0IGJzOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGJzID0gaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uYm91bmRpbmdTcGhlcmU7CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJzKSkgewogICAgICAgIGNlbnRlciA9IHZvaWQgMDsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGJzLmNlbnRlciwgY2VudGVyLCBjZW50ZXIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChjZW50ZXIpKSB7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcihjZW50ZXIsIGxlbmd0aCwgY2VudGVyKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgYnMgPSBpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5ib3VuZGluZ1NwaGVyZTsKICAgICAgICBjb25zdCB0ZW1wUmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChicy5jZW50ZXIsIGNlbnRlciwgdGVtcFNjcmF0Y2gpCiAgICAgICAgKSArIGJzLnJhZGl1czsKICAgICAgICBpZiAodGVtcFJhZGl1cyA+IHJhZGl1cykgewogICAgICAgICAgcmFkaXVzID0gdGVtcFJhZGl1czsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMsCiAgICAgIHByaW1pdGl2ZVR5cGUsCiAgICAgIGJvdW5kaW5nU3BoZXJlOiBkZWZpbmVkX2RlZmF1bHQoY2VudGVyKSA/IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KGNlbnRlciwgcmFkaXVzKSA6IHZvaWQgMAogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGluZGV4VHJpYW5nbGVzKGdlb21ldHJ5KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpKSB7CiAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgIH0KICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgIGlmIChudW1iZXJPZlZlcnRpY2VzIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiVGhlIG51bWJlciBvZiB2ZXJ0aWNlcyBtdXN0IGJlIGF0IGxlYXN0IHRocmVlLiIpOwogICAgfQogICAgaWYgKG51bWJlck9mVmVydGljZXMgJSAzICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYSBtdWx0aXBsZSBvZiB0aHJlZS4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIG51bWJlck9mVmVydGljZXMKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mVmVydGljZXM7ICsraSkgewogICAgICBpbmRpY2VzW2ldID0gaTsKICAgIH0KICAgIGdlb21ldHJ5LmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleFRyaWFuZ2xlRmFuKGdlb21ldHJ5KSB7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCB0aHJlZS4iKTsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbnVtYmVyT2ZWZXJ0aWNlcywKICAgICAgKG51bWJlck9mVmVydGljZXMgLSAyKSAqIDMKICAgICk7CiAgICBpbmRpY2VzWzBdID0gMTsKICAgIGluZGljZXNbMV0gPSAwOwogICAgaW5kaWNlc1syXSA9IDI7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMzsKICAgIGZvciAobGV0IGkgPSAzOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gMDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgfQogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzsKICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gaW5kZXhUcmlhbmdsZVN0cmlwKGdlb21ldHJ5KSB7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCAzLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICAobnVtYmVyT2ZWZXJ0aWNlcyAtIDIpICogMwogICAgKTsKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CiAgICBpbmRpY2VzWzJdID0gMjsKICAgIGlmIChudW1iZXJPZlZlcnRpY2VzID4gMykgewogICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgaW5kaWNlc1s0XSA9IDI7CiAgICAgIGluZGljZXNbNV0gPSAzOwogICAgfQogICAgbGV0IGluZGljZXNJbmRleCA9IDY7CiAgICBmb3IgKGxldCBpID0gMzsgaSA8IG51bWJlck9mVmVydGljZXMgLSAxOyBpICs9IDIpIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkgLSAxOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkgKyAxOwogICAgICBpZiAoaSArIDIgPCBudW1iZXJPZlZlcnRpY2VzKSB7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpICsgMjsKICAgICAgfQogICAgfQogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzsKICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gaW5kZXhMaW5lcyhnZW9tZXRyeSkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSkgewogICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICB9CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCB0d28uIik7CiAgICB9CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyAlIDIgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIuIik7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIG51bWJlck9mVmVydGljZXMKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mVmVydGljZXM7ICsraSkgewogICAgICBpbmRpY2VzW2ldID0gaTsKICAgIH0KICAgIGdlb21ldHJ5LmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleExpbmVTdHJpcChnZW9tZXRyeSkgewogICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgaWYgKG51bWJlck9mVmVydGljZXMgPCAyKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYXQgbGVhc3QgdHdvLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICAobnVtYmVyT2ZWZXJ0aWNlcyAtIDEpICogMgogICAgKTsKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMjsKICAgIGZvciAobGV0IGkgPSAyOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTsKICAgIH0KICAgIGdlb21ldHJ5LmluZGljZXMgPSBpbmRpY2VzOwogICAgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUzsKICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gaW5kZXhMaW5lTG9vcChnZW9tZXRyeSkgewogICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgaWYgKG51bWJlck9mVmVydGljZXMgPCAyKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYXQgbGVhc3QgdHdvLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICBudW1iZXJPZlZlcnRpY2VzICogMgogICAgKTsKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMjsKICAgIGZvciAobGV0IGkgPSAyOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTsKICAgIH0KICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gbnVtYmVyT2ZWZXJ0aWNlcyAtIDE7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleF0gPSAwOwogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleFByaW1pdGl2ZShnZW9tZXRyeSkgewogICAgc3dpdGNoIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlKSB7CiAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFX0ZBTjoKICAgICAgICByZXR1cm4gaW5kZXhUcmlhbmdsZUZhbihnZW9tZXRyeSk7CiAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFX1NUUklQOgogICAgICAgIHJldHVybiBpbmRleFRyaWFuZ2xlU3RyaXAoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVM6CiAgICAgICAgcmV0dXJuIGluZGV4VHJpYW5nbGVzKGdlb21ldHJ5KTsKICAgICAgY2FzZSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORV9TVFJJUDoKICAgICAgICByZXR1cm4gaW5kZXhMaW5lU3RyaXAoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FX0xPT1A6CiAgICAgICAgcmV0dXJuIGluZGV4TGluZUxvb3AoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUzoKICAgICAgICByZXR1cm4gaW5kZXhMaW5lcyhnZW9tZXRyeSk7CiAgICB9CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocCwgaXNCZWhpbmQpIHsKICAgIGlmIChNYXRoLmFicyhwLnkpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgIGlmIChpc0JlaGluZCkgewogICAgICAgIHAueSA9IC1NYXRoX2RlZmF1bHQuRVBTSUxPTjY7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcC55ID0gTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIG9mZnNldFRyaWFuZ2xlRnJvbVhaUGxhbmUocDAsIHAxLCBwMikgewogICAgaWYgKHAwLnkgIT09IDAgJiYgcDEueSAhPT0gMCAmJiBwMi55ICE9PSAwKSB7CiAgICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDAsIHAwLnkgPCAwKTsKICAgICAgb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZShwMSwgcDEueSA8IDApOwogICAgICBvZmZzZXRQb2ludEZyb21YWlBsYW5lKHAyLCBwMi55IDwgMCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHAweSA9IE1hdGguYWJzKHAwLnkpOwogICAgY29uc3QgcDF5ID0gTWF0aC5hYnMocDEueSk7CiAgICBjb25zdCBwMnkgPSBNYXRoLmFicyhwMi55KTsKICAgIGxldCBzaWduMzsKICAgIGlmIChwMHkgPiBwMXkpIHsKICAgICAgaWYgKHAweSA+IHAyeSkgewogICAgICAgIHNpZ24zID0gTWF0aF9kZWZhdWx0LnNpZ24ocDAueSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2lnbjMgPSBNYXRoX2RlZmF1bHQuc2lnbihwMi55KTsKICAgICAgfQogICAgfSBlbHNlIGlmIChwMXkgPiBwMnkpIHsKICAgICAgc2lnbjMgPSBNYXRoX2RlZmF1bHQuc2lnbihwMS55KTsKICAgIH0gZWxzZSB7CiAgICAgIHNpZ24zID0gTWF0aF9kZWZhdWx0LnNpZ24ocDIueSk7CiAgICB9CiAgICBjb25zdCBpc0JlaGluZCA9IHNpZ24zIDwgMDsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDAsIGlzQmVoaW5kKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDEsIGlzQmVoaW5kKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDIsIGlzQmVoaW5kKTsKICB9CiAgZnVuY3Rpb24gZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocCwgcDEsIHUxMiwgdjEyKSB7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBwLAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDEsIHAsIGMzKSwKICAgICAgICBwLnkgLyAocC55IC0gcDEueSksCiAgICAgICAgYzMKICAgICAgKSwKICAgICAgdTEyCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHUxMiwgdjEyKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUodTEyLCB0cnVlKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUodjEyLCBmYWxzZSk7CiAgfQogIGZ1bmN0aW9uIHNwbGl0VHJpYW5nbGUocDAsIHAxLCBwMikgewogICAgaWYgKHAwLnggPj0gMCB8fCBwMS54ID49IDAgfHwgcDIueCA+PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBvZmZzZXRUcmlhbmdsZUZyb21YWlBsYW5lKHAwLCBwMSwgcDIpOwogICAgY29uc3QgcDBCZWhpbmQgPSBwMC55IDwgMDsKICAgIGNvbnN0IHAxQmVoaW5kID0gcDEueSA8IDA7CiAgICBjb25zdCBwMkJlaGluZCA9IHAyLnkgPCAwOwogICAgbGV0IG51bUJlaGluZCA9IDA7CiAgICBudW1CZWhpbmQgKz0gcDBCZWhpbmQgPyAxIDogMDsKICAgIG51bUJlaGluZCArPSBwMUJlaGluZCA/IDEgOiAwOwogICAgbnVtQmVoaW5kICs9IHAyQmVoaW5kID8gMSA6IDA7CiAgICBjb25zdCBpbmRpY2VzID0gc3BsaXRUcmlhbmdsZVJlc3VsdC5pbmRpY2VzOwogICAgaWYgKG51bUJlaGluZCA9PT0gMSkgewogICAgICBpbmRpY2VzWzFdID0gMzsKICAgICAgaW5kaWNlc1syXSA9IDQ7CiAgICAgIGluZGljZXNbNV0gPSA2OwogICAgICBpbmRpY2VzWzddID0gNjsKICAgICAgaW5kaWNlc1s4XSA9IDU7CiAgICAgIGlmIChwMEJlaGluZCkgewogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAwLCBwMSwgdTEsIHExKTsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMCwgcDIsIHUyLCBxMik7CiAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgaW5kaWNlc1szXSA9IDE7CiAgICAgICAgaW5kaWNlc1s0XSA9IDI7CiAgICAgICAgaW5kaWNlc1s2XSA9IDE7CiAgICAgIH0gZWxzZSBpZiAocDFCZWhpbmQpIHsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMSwgcDIsIHUxLCBxMSk7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDEsIHAwLCB1MiwgcTIpOwogICAgICAgIGluZGljZXNbMF0gPSAxOwogICAgICAgIGluZGljZXNbM10gPSAyOwogICAgICAgIGluZGljZXNbNF0gPSAwOwogICAgICAgIGluZGljZXNbNl0gPSAyOwogICAgICB9IGVsc2UgaWYgKHAyQmVoaW5kKSB7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDIsIHAwLCB1MSwgcTEpOwogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAyLCBwMSwgdTIsIHEyKTsKICAgICAgICBpbmRpY2VzWzBdID0gMjsKICAgICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgICBpbmRpY2VzWzRdID0gMTsKICAgICAgICBpbmRpY2VzWzZdID0gMDsKICAgICAgfQogICAgfSBlbHNlIGlmIChudW1CZWhpbmQgPT09IDIpIHsKICAgICAgaW5kaWNlc1syXSA9IDQ7CiAgICAgIGluZGljZXNbNF0gPSA0OwogICAgICBpbmRpY2VzWzVdID0gMzsKICAgICAgaW5kaWNlc1s3XSA9IDU7CiAgICAgIGluZGljZXNbOF0gPSA2OwogICAgICBpZiAoIXAwQmVoaW5kKSB7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDAsIHAxLCB1MSwgcTEpOwogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAwLCBwMiwgdTIsIHEyKTsKICAgICAgICBpbmRpY2VzWzBdID0gMTsKICAgICAgICBpbmRpY2VzWzFdID0gMjsKICAgICAgICBpbmRpY2VzWzNdID0gMTsKICAgICAgICBpbmRpY2VzWzZdID0gMDsKICAgICAgfSBlbHNlIGlmICghcDFCZWhpbmQpIHsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMSwgcDIsIHUxLCBxMSk7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDEsIHAwLCB1MiwgcTIpOwogICAgICAgIGluZGljZXNbMF0gPSAyOwogICAgICAgIGluZGljZXNbMV0gPSAwOwogICAgICAgIGluZGljZXNbM10gPSAyOwogICAgICAgIGluZGljZXNbNl0gPSAxOwogICAgICB9IGVsc2UgaWYgKCFwMkJlaGluZCkgewogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAyLCBwMCwgdTEsIHExKTsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMiwgcDEsIHUyLCBxMik7CiAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgaW5kaWNlc1sxXSA9IDE7CiAgICAgICAgaW5kaWNlc1szXSA9IDA7CiAgICAgICAgaW5kaWNlc1s2XSA9IDI7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHBvc2l0aW9ucyA9IHNwbGl0VHJpYW5nbGVSZXN1bHQucG9zaXRpb25zOwogICAgcG9zaXRpb25zWzBdID0gcDA7CiAgICBwb3NpdGlvbnNbMV0gPSBwMTsKICAgIHBvc2l0aW9uc1syXSA9IHAyOwogICAgcG9zaXRpb25zLmxlbmd0aCA9IDM7CiAgICBpZiAobnVtQmVoaW5kID09PSAxIHx8IG51bUJlaGluZCA9PT0gMikgewogICAgICBwb3NpdGlvbnNbM10gPSB1MTsKICAgICAgcG9zaXRpb25zWzRdID0gdTI7CiAgICAgIHBvc2l0aW9uc1s1XSA9IHExOwogICAgICBwb3NpdGlvbnNbNl0gPSBxMjsKICAgICAgcG9zaXRpb25zLmxlbmd0aCA9IDc7CiAgICB9CiAgICByZXR1cm4gc3BsaXRUcmlhbmdsZVJlc3VsdDsKICB9CiAgZnVuY3Rpb24gdXBkYXRlR2VvbWV0cnlBZnRlclNwbGl0KGdlb21ldHJ5LCBjb21wdXRlQm91bmRpbmdTcGhlcmUpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgaWYgKGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XS52YWx1ZXMpKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1twcm9wZXJ0eV07CiAgICAgICAgYXR0cmlidXRlLnZhbHVlcyA9IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIGF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSwKICAgICAgICAgIGF0dHJpYnV0ZS52YWx1ZXMKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBnZW9tZXRyeS5pbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIGdlb21ldHJ5LmluZGljZXMKICAgICk7CiAgICBpZiAoY29tcHV0ZUJvdW5kaW5nU3BoZXJlKSB7CiAgICAgIGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgY29waWVkQXR0cmlidXRlcyA9IHt9OwogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XS52YWx1ZXMpKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1twcm9wZXJ0eV07CiAgICAgICAgY29waWVkQXR0cmlidXRlc1twcm9wZXJ0eV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogYXR0cmlidXRlLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICBub3JtYWxpemU6IGF0dHJpYnV0ZS5ub3JtYWxpemUsCiAgICAgICAgICB2YWx1ZXM6IFtdCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IGNvcGllZEF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IFtdLAogICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gdXBkYXRlSW5zdGFuY2VBZnRlclNwbGl0KGluc3RhbmNlLCB3ZXN0R2VvbWV0cnksIGVhc3RHZW9tZXRyeSkgewogICAgY29uc3QgY29tcHV0ZUJvdW5kaW5nU3BoZXJlID0gZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlKTsKICAgIHdlc3RHZW9tZXRyeSA9IHVwZGF0ZUdlb21ldHJ5QWZ0ZXJTcGxpdCh3ZXN0R2VvbWV0cnksIGNvbXB1dGVCb3VuZGluZ1NwaGVyZSk7CiAgICBlYXN0R2VvbWV0cnkgPSB1cGRhdGVHZW9tZXRyeUFmdGVyU3BsaXQoZWFzdEdlb21ldHJ5LCBjb21wdXRlQm91bmRpbmdTcGhlcmUpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChlYXN0R2VvbWV0cnkpICYmICFkZWZpbmVkX2RlZmF1bHQod2VzdEdlb21ldHJ5KSkgewogICAgICBpbnN0YW5jZS5nZW9tZXRyeSA9IGVhc3RHZW9tZXRyeTsKICAgIH0gZWxzZSBpZiAoIWRlZmluZWRfZGVmYXVsdChlYXN0R2VvbWV0cnkpICYmIGRlZmluZWRfZGVmYXVsdCh3ZXN0R2VvbWV0cnkpKSB7CiAgICAgIGluc3RhbmNlLmdlb21ldHJ5ID0gd2VzdEdlb21ldHJ5OwogICAgfSBlbHNlIHsKICAgICAgaW5zdGFuY2Uud2VzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IHdlc3RHZW9tZXRyeTsKICAgICAgaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IGVhc3RHZW9tZXRyeTsKICAgICAgaW5zdGFuY2UuZ2VvbWV0cnkgPSB2b2lkIDA7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlQmFyeWNlbnRyaWNJbnRlcnBvbGF0ZUZ1bmN0aW9uKENhcnRlc2lhblR5cGUsIG51bWJlck9mQ29tcG9uZW50cykgewogICAgY29uc3QgdjBTY3JhdGNoID0gbmV3IENhcnRlc2lhblR5cGUoKTsKICAgIGNvbnN0IHYxU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuVHlwZSgpOwogICAgY29uc3QgdjJTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW5UeXBlKCk7CiAgICByZXR1cm4gZnVuY3Rpb24oaTAsIGkxLCBpMiwgY29vcmRzLCBzb3VyY2VWYWx1ZXMsIGN1cnJlbnRWYWx1ZXMsIGluc2VydGVkSW5kZXgsIG5vcm1hbGl6ZSkgewogICAgICBjb25zdCB2MDIgPSBDYXJ0ZXNpYW5UeXBlLmZyb21BcnJheSgKICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgaTAgKiBudW1iZXJPZkNvbXBvbmVudHMsCiAgICAgICAgdjBTY3JhdGNoCiAgICAgICk7CiAgICAgIGNvbnN0IHYxMiA9IENhcnRlc2lhblR5cGUuZnJvbUFycmF5KAogICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICBpMSAqIG51bWJlck9mQ29tcG9uZW50cywKICAgICAgICB2MVNjcmF0Y2gyCiAgICAgICk7CiAgICAgIGNvbnN0IHYyMiA9IENhcnRlc2lhblR5cGUuZnJvbUFycmF5KAogICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICBpMiAqIG51bWJlck9mQ29tcG9uZW50cywKICAgICAgICB2MlNjcmF0Y2gyCiAgICAgICk7CiAgICAgIENhcnRlc2lhblR5cGUubXVsdGlwbHlCeVNjYWxhcih2MDIsIGNvb3Jkcy54LCB2MDIpOwogICAgICBDYXJ0ZXNpYW5UeXBlLm11bHRpcGx5QnlTY2FsYXIodjEyLCBjb29yZHMueSwgdjEyKTsKICAgICAgQ2FydGVzaWFuVHlwZS5tdWx0aXBseUJ5U2NhbGFyKHYyMiwgY29vcmRzLnosIHYyMik7CiAgICAgIGNvbnN0IHZhbHVlID0gQ2FydGVzaWFuVHlwZS5hZGQodjAyLCB2MTIsIHYwMik7CiAgICAgIENhcnRlc2lhblR5cGUuYWRkKHZhbHVlLCB2MjIsIHZhbHVlKTsKICAgICAgaWYgKG5vcm1hbGl6ZSkgewogICAgICAgIENhcnRlc2lhblR5cGUubm9ybWFsaXplKHZhbHVlLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgQ2FydGVzaWFuVHlwZS5wYWNrKAogICAgICAgIHZhbHVlLAogICAgICAgIGN1cnJlbnRWYWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleCAqIG51bWJlck9mQ29tcG9uZW50cwogICAgICApOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVRyaWFuZ2xlQXR0cmlidXRlcyhpMCwgaTEsIGkyLCBwb2ludCwgcG9zaXRpb25zLCBub3JtYWxzLCB0YW5nZW50cywgYml0YW5nZW50cywgdGV4Q29vcmRzLCBleHRydWRlRGlyZWN0aW9ucywgYXBwbHlPZmZzZXQsIGN1cnJlbnRBdHRyaWJ1dGVzLCBjdXN0b21BdHRyaWJ1dGVOYW1lcywgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCwgYWxsQXR0cmlidXRlcywgaW5zZXJ0ZWRJbmRleCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobm9ybWFscykgJiYgIWRlZmluZWRfZGVmYXVsdCh0YW5nZW50cykgJiYgIWRlZmluZWRfZGVmYXVsdChiaXRhbmdlbnRzKSAmJiAhZGVmaW5lZF9kZWZhdWx0KHRleENvb3JkcykgJiYgIWRlZmluZWRfZGVmYXVsdChleHRydWRlRGlyZWN0aW9ucykgJiYgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMCAqIDMsIHAwU2NyYXRjaCk7CiAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMSAqIDMsIHAxU2NyYXRjaCk7CiAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMiAqIDMsIHAyU2NyYXRjaCk7CiAgICBjb25zdCBjb29yZHMgPSBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzX2RlZmF1bHQocG9pbnQsIHAwLCBwMSwgcDIsIGJhcnljZW50cmljU2NyYXRjaCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb29yZHMpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMygKICAgICAgICBpMCwKICAgICAgICBpMSwKICAgICAgICBpMiwKICAgICAgICBjb29yZHMsCiAgICAgICAgbm9ybWFscywKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5ub3JtYWwudmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXgsCiAgICAgICAgdHJ1ZQogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChleHRydWRlRGlyZWN0aW9ucykpIHsKICAgICAgY29uc3QgZDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGV4dHJ1ZGVEaXJlY3Rpb25zLCBpMCAqIDMsIHAwU2NyYXRjaCk7CiAgICAgIGNvbnN0IGQxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShleHRydWRlRGlyZWN0aW9ucywgaTEgKiAzLCBwMVNjcmF0Y2gpOwogICAgICBjb25zdCBkMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZXh0cnVkZURpcmVjdGlvbnMsIGkyICogMywgcDJTY3JhdGNoKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZDAsIGNvb3Jkcy54LCBkMCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGQxLCBjb29yZHMueSwgZDEpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkMiwgY29vcmRzLnosIGQyKTsKICAgICAgbGV0IGRpcmVjdGlvbjI7CiAgICAgIGlmICghQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhkMCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pIHx8ICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGQxLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykgfHwgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoZDIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgIGRpcmVjdGlvbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGQwLCBkMSwgZDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZGlyZWN0aW9uMiwgZDIsIGRpcmVjdGlvbjIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZGlyZWN0aW9uMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGlyZWN0aW9uMiA9IHAwU2NyYXRjaDsKICAgICAgICBkaXJlY3Rpb24yLnggPSAwOwogICAgICAgIGRpcmVjdGlvbjIueSA9IDA7CiAgICAgICAgZGlyZWN0aW9uMi56ID0gMDsKICAgICAgfQogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICBkaXJlY3Rpb24yLAogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmV4dHJ1ZGVEaXJlY3Rpb24udmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXggKiAzCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGFwcGx5T2Zmc2V0KSkgewogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tCb29sZWFuKAogICAgICAgIGkwLAogICAgICAgIGkxLAogICAgICAgIGkyLAogICAgICAgIGNvb3JkcywKICAgICAgICBhcHBseU9mZnNldCwKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5hcHBseU9mZnNldC52YWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0YW5nZW50cykpIHsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMygKICAgICAgICBpMCwKICAgICAgICBpMSwKICAgICAgICBpMiwKICAgICAgICBjb29yZHMsCiAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMudGFuZ2VudC52YWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICB0cnVlCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudHMpKSB7CiAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjMoCiAgICAgICAgaTAsCiAgICAgICAgaTEsCiAgICAgICAgaTIsCiAgICAgICAgY29vcmRzLAogICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuYml0YW5nZW50LnZhbHVlcywKICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgIHRydWUKICAgICAgKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSkgewogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4yKAogICAgICAgIGkwLAogICAgICAgIGkxLAogICAgICAgIGkyLAogICAgICAgIGNvb3JkcywKICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuc3QudmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXgKICAgICAgKTsKICAgIH0KICAgIGlmIChjdXN0b21BdHRyaWJ1dGVzTGVuZ3RoID4gMCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZU5hbWUgPSBjdXN0b21BdHRyaWJ1dGVOYW1lc1tpXTsKICAgICAgICBnZW5lcmljSW50ZXJwb2xhdGUoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgICAgYWxsQXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXSwKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdCiAgICAgICAgKTsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBnZW5lcmljSW50ZXJwb2xhdGUoaTAsIGkxLCBpMiwgY29vcmRzLCBpbnNlcnRlZEluZGV4LCBzb3VyY2VBdHRyaWJ1dGUsIGN1cnJlbnRBdHRyaWJ1dGUpIHsKICAgIGNvbnN0IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBzb3VyY2VBdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgIGNvbnN0IHNvdXJjZVZhbHVlcyA9IHNvdXJjZUF0dHJpYnV0ZS52YWx1ZXM7CiAgICBjb25zdCBjdXJyZW50VmFsdWVzID0gY3VycmVudEF0dHJpYnV0ZS52YWx1ZXM7CiAgICBzd2l0Y2ggKGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUpIHsKICAgICAgY2FzZSA0OgogICAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjQoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgICBjdXJyZW50VmFsdWVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgICBjdXJyZW50VmFsdWVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjIoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgICBjdXJyZW50VmFsdWVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBjdXJyZW50VmFsdWVzW2luc2VydGVkSW5kZXhdID0gc291cmNlVmFsdWVzW2kwXSAqIGNvb3Jkcy54ICsgc291cmNlVmFsdWVzW2kxXSAqIGNvb3Jkcy55ICsgc291cmNlVmFsdWVzW2kyXSAqIGNvb3Jkcy56OwogICAgfQogIH0KICBmdW5jdGlvbiBpbnNlcnRTcGxpdFBvaW50KGN1cnJlbnRBdHRyaWJ1dGVzLCBjdXJyZW50SW5kaWNlcywgY3VycmVudEluZGV4TWFwLCBpbmRpY2VzLCBjdXJyZW50SW5kZXgsIHBvaW50KSB7CiAgICBjb25zdCBpbnNlcnRJbmRleCA9IGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgaWYgKGN1cnJlbnRJbmRleCAhPT0gLTEpIHsKICAgICAgY29uc3QgcHJldkluZGV4ID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICBjb25zdCBuZXdJbmRleCA9IGN1cnJlbnRJbmRleE1hcFtwcmV2SW5kZXhdOwogICAgICBpZiAobmV3SW5kZXggPT09IC0xKSB7CiAgICAgICAgY3VycmVudEluZGV4TWFwW3ByZXZJbmRleF0gPSBpbnNlcnRJbmRleDsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwb2ludC54LCBwb2ludC55LCBwb2ludC56KTsKICAgICAgICBjdXJyZW50SW5kaWNlcy5wdXNoKGluc2VydEluZGV4KTsKICAgICAgICByZXR1cm4gaW5zZXJ0SW5kZXg7CiAgICAgIH0KICAgICAgY3VycmVudEluZGljZXMucHVzaChuZXdJbmRleCk7CiAgICAgIHJldHVybiBuZXdJbmRleDsKICAgIH0KICAgIGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKHBvaW50LngsIHBvaW50LnksIHBvaW50LnopOwogICAgY3VycmVudEluZGljZXMucHVzaChpbnNlcnRJbmRleCk7CiAgICByZXR1cm4gaW5zZXJ0SW5kZXg7CiAgfQogIGZ1bmN0aW9uIHNwbGl0TG9uZ2l0dWRlVHJpYW5nbGVzKGluc3RhbmNlKSB7CiAgICBjb25zdCBnZW9tZXRyeSA9IGluc3RhbmNlLmdlb21ldHJ5OwogICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IG5vcm1hbHMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5ub3JtYWwpID8gYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmJpdGFuZ2VudCkgPyBhdHRyaWJ1dGVzLmJpdGFuZ2VudC52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnRhbmdlbnQpID8gYXR0cmlidXRlcy50YW5nZW50LnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IHRleENvb3JkcyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnN0KSA/IGF0dHJpYnV0ZXMuc3QudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgZXh0cnVkZURpcmVjdGlvbnMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uKSA/IGF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbi52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCBhcHBseU9mZnNldCA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0KSA/IGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBjdXN0b21BdHRyaWJ1dGVOYW1lcyA9IFtdOwogICAgZm9yIChjb25zdCBhdHRyaWJ1dGVOYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cmlidXRlTmFtZSkgJiYgIU5BTUVEX0FUVFJJQlVURVNbYXR0cmlidXRlTmFtZV0gJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICAgICAgY3VzdG9tQXR0cmlidXRlTmFtZXMucHVzaChhdHRyaWJ1dGVOYW1lKTsKICAgICAgfQogICAgfQogICAgY29uc3QgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCA9IGN1c3RvbUF0dHJpYnV0ZU5hbWVzLmxlbmd0aDsKICAgIGNvbnN0IGVhc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGNvbnN0IHdlc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGxldCBjdXJyZW50QXR0cmlidXRlczsKICAgIGxldCBjdXJyZW50SW5kaWNlczsKICAgIGxldCBjdXJyZW50SW5kZXhNYXA7CiAgICBsZXQgaW5zZXJ0ZWRJbmRleDsKICAgIGxldCBpOwogICAgY29uc3Qgd2VzdEdlb21ldHJ5SW5kZXhNYXAgPSBbXTsKICAgIHdlc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgZWFzdEdlb21ldHJ5SW5kZXhNYXAgPSBbXTsKICAgIGVhc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgZm9yIChpID0gMDsgaSA8IHdlc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aDsgKytpKSB7CiAgICAgIHdlc3RHZW9tZXRyeUluZGV4TWFwW2ldID0gLTE7CiAgICAgIGVhc3RHZW9tZXRyeUluZGV4TWFwW2ldID0gLTE7CiAgICB9CiAgICBjb25zdCBsZW4gPSBpbmRpY2VzLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkgKz0gMykgewogICAgICBjb25zdCBpMCA9IGluZGljZXNbaV07CiAgICAgIGNvbnN0IGkxID0gaW5kaWNlc1tpICsgMV07CiAgICAgIGNvbnN0IGkyID0gaW5kaWNlc1tpICsgMl07CiAgICAgIGxldCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMCAqIDMpOwogICAgICBsZXQgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTEgKiAzKTsKICAgICAgbGV0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkyICogMyk7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHNwbGl0VHJpYW5nbGUocDAsIHAxLCBwMik7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSAmJiByZXN1bHQucG9zaXRpb25zLmxlbmd0aCA+IDMpIHsKICAgICAgICBjb25zdCByZXN1bHRQb3NpdGlvbnMgPSByZXN1bHQucG9zaXRpb25zOwogICAgICAgIGNvbnN0IHJlc3VsdEluZGljZXMgPSByZXN1bHQuaW5kaWNlczsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSByZXN1bHRJbmRpY2VzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdExlbmd0aDsgKytqKSB7CiAgICAgICAgICBjb25zdCByZXN1bHRJbmRleCA9IHJlc3VsdEluZGljZXNbal07CiAgICAgICAgICBjb25zdCBwb2ludCA9IHJlc3VsdFBvc2l0aW9uc1tyZXN1bHRJbmRleF07CiAgICAgICAgICBpZiAocG9pbnQueSA8IDApIHsKICAgICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgICAgY3VycmVudEluZGljZXMgPSB3ZXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICAgICAgY3VycmVudEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcyA9IGVhc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgICBjdXJyZW50SW5kZXhNYXAgPSBlYXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICAgIH0KICAgICAgICAgIGluc2VydGVkSW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICAgIGN1cnJlbnRJbmRleE1hcCwKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgcmVzdWx0SW5kZXggPCAzID8gaSArIHJlc3VsdEluZGV4IDogLTEsCiAgICAgICAgICAgIHBvaW50CiAgICAgICAgICApOwogICAgICAgICAgY29tcHV0ZVRyaWFuZ2xlQXR0cmlidXRlcygKICAgICAgICAgICAgaTAsCiAgICAgICAgICAgIGkxLAogICAgICAgICAgICBpMiwKICAgICAgICAgICAgcG9pbnQsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgbm9ybWFscywKICAgICAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgIHRleENvb3JkcywKICAgICAgICAgICAgZXh0cnVkZURpcmVjdGlvbnMsCiAgICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgICAgY3VzdG9tQXR0cmlidXRlTmFtZXMsCiAgICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICAgIGluc2VydGVkSW5kZXgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcDAgPSByZXN1bHQucG9zaXRpb25zWzBdOwogICAgICAgICAgcDEgPSByZXN1bHQucG9zaXRpb25zWzFdOwogICAgICAgICAgcDIgPSByZXN1bHQucG9zaXRpb25zWzJdOwogICAgICAgIH0KICAgICAgICBpZiAocDAueSA8IDApIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gd2VzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gZWFzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfQogICAgICAgIGluc2VydGVkSW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXJyZW50SW5kaWNlcywKICAgICAgICAgIGN1cnJlbnRJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBpLAogICAgICAgICAgcDAKICAgICAgICApOwogICAgICAgIGNvbXB1dGVUcmlhbmdsZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBwMCwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0ZWRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzLAogICAgICAgICAgY3VycmVudEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGkgKyAxLAogICAgICAgICAgcDEKICAgICAgICApOwogICAgICAgIGNvbXB1dGVUcmlhbmdsZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBwMSwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0ZWRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzLAogICAgICAgICAgY3VycmVudEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGkgKyAyLAogICAgICAgICAgcDIKICAgICAgICApOwogICAgICAgIGNvbXB1dGVUcmlhbmdsZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBwMiwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHVwZGF0ZUluc3RhbmNlQWZ0ZXJTcGxpdChpbnN0YW5jZSwgd2VzdEdlb21ldHJ5LCBlYXN0R2VvbWV0cnkpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlTGluZUF0dHJpYnV0ZXMoaTAsIGkxLCBwb2ludCwgcG9zaXRpb25zLCBpbnNlcnRJbmRleCwgY3VycmVudEF0dHJpYnV0ZXMsIGFwcGx5T2Zmc2V0KSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcHBseU9mZnNldCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTAgKiAzLCBwMFNjcmF0Y2gpOwogICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHAwLCBwb2ludCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgY3VycmVudEF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQudmFsdWVzW2luc2VydEluZGV4XSA9IGFwcGx5T2Zmc2V0W2kwXTsKICAgIH0gZWxzZSB7CiAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0LnZhbHVlc1tpbnNlcnRJbmRleF0gPSBhcHBseU9mZnNldFtpMV07CiAgICB9CiAgfQogIGZ1bmN0aW9uIHNwbGl0TG9uZ2l0dWRlTGluZXMoaW5zdGFuY2UpIHsKICAgIGNvbnN0IGdlb21ldHJ5ID0gaW5zdGFuY2UuZ2VvbWV0cnk7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgYXBwbHlPZmZzZXQgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5hcHBseU9mZnNldCkgPyBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0LnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IGluZGljZXMgPSBnZW9tZXRyeS5pbmRpY2VzOwogICAgY29uc3QgZWFzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgY29uc3Qgd2VzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgbGV0IGk7CiAgICBjb25zdCBsZW5ndGggPSBpbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IHdlc3RHZW9tZXRyeUluZGV4TWFwID0gW107CiAgICB3ZXN0R2VvbWV0cnlJbmRleE1hcC5sZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IGVhc3RHZW9tZXRyeUluZGV4TWFwID0gW107CiAgICBlYXN0R2VvbWV0cnlJbmRleE1hcC5sZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGZvciAoaSA9IDA7IGkgPCB3ZXN0R2VvbWV0cnlJbmRleE1hcC5sZW5ndGg7ICsraSkgewogICAgICB3ZXN0R2VvbWV0cnlJbmRleE1hcFtpXSA9IC0xOwogICAgICBlYXN0R2VvbWV0cnlJbmRleE1hcFtpXSA9IC0xOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgIGNvbnN0IGkwID0gaW5kaWNlc1tpXTsKICAgICAgY29uc3QgaTEgPSBpbmRpY2VzW2kgKyAxXTsKICAgICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTAgKiAzLCBwMFNjcmF0Y2gpOwogICAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMSAqIDMsIHAxU2NyYXRjaCk7CiAgICAgIGxldCBpbnNlcnRJbmRleDsKICAgICAgaWYgKE1hdGguYWJzKHAwLnkpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgaWYgKHAwLnkgPCAwKSB7CiAgICAgICAgICBwMC55ID0gLU1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcDAueSA9IE1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKE1hdGguYWJzKHAxLnkpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgaWYgKHAxLnkgPCAwKSB7CiAgICAgICAgICBwMS55ID0gLU1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcDEueSA9IE1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9CiAgICAgIH0KICAgICAgbGV0IHAwQXR0cmlidXRlcyA9IGVhc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICBsZXQgcDBJbmRpY2VzID0gZWFzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgIGxldCBwMEluZGV4TWFwID0gZWFzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgIGxldCBwMUF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgbGV0IHAxSW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICBsZXQgcDFJbmRleE1hcCA9IHdlc3RHZW9tZXRyeUluZGV4TWFwOwogICAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LmxpbmVTZWdtZW50UGxhbmUoCiAgICAgICAgcDAsCiAgICAgICAgcDEsCiAgICAgICAgeHpQbGFuZSwKICAgICAgICBwMlNjcmF0Y2gKICAgICAgKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pKSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLAogICAgICAgICAgNSAqIE1hdGhfZGVmYXVsdC5FUFNJTE9OOSwKICAgICAgICAgIG9mZnNldFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShvZmZzZXQsIG9mZnNldCk7CiAgICAgICAgICBwMEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIHAwSW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgcDBJbmRleE1hcCA9IHdlc3RHZW9tZXRyeUluZGV4TWFwOwogICAgICAgICAgcDFBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBwMUluZGljZXMgPSBlYXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICAgIHAxSW5kZXhNYXAgPSBlYXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2Zmc2V0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgaW50ZXJzZWN0aW9uLAogICAgICAgICAgb2Zmc2V0LAogICAgICAgICAgb2Zmc2V0UG9pbnRTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBpbnNlcnRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBwMEF0dHJpYnV0ZXMsCiAgICAgICAgICBwMEluZGljZXMsCiAgICAgICAgICBwMEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGksCiAgICAgICAgICBwMAogICAgICAgICk7CiAgICAgICAgY29tcHV0ZUxpbmVBdHRyaWJ1dGVzKAogICAgICAgICAgaTAsCiAgICAgICAgICBpMSwKICAgICAgICAgIHAwLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaW5zZXJ0SW5kZXgsCiAgICAgICAgICBwMEF0dHJpYnV0ZXMsCiAgICAgICAgICBhcHBseU9mZnNldAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0SW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgcDBBdHRyaWJ1dGVzLAogICAgICAgICAgcDBJbmRpY2VzLAogICAgICAgICAgcDBJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAtMSwKICAgICAgICAgIG9mZnNldFBvaW50CiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgb2Zmc2V0UG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIHAwQXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGludGVyc2VjdGlvbiwgb2Zmc2V0LCBvZmZzZXRQb2ludCk7CiAgICAgICAgaW5zZXJ0SW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgcDFBdHRyaWJ1dGVzLAogICAgICAgICAgcDFJbmRpY2VzLAogICAgICAgICAgcDFJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAtMSwKICAgICAgICAgIG9mZnNldFBvaW50CiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgb2Zmc2V0UG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIHAxQXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBpbnNlcnRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBwMUF0dHJpYnV0ZXMsCiAgICAgICAgICBwMUluZGljZXMsCiAgICAgICAgICBwMUluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGkgKyAxLAogICAgICAgICAgcDEKICAgICAgICApOwogICAgICAgIGNvbXB1dGVMaW5lQXR0cmlidXRlcygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBwMSwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIGluc2VydEluZGV4LAogICAgICAgICAgcDFBdHRyaWJ1dGVzLAogICAgICAgICAgYXBwbHlPZmZzZXQKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCBjdXJyZW50QXR0cmlidXRlczsKICAgICAgICBsZXQgY3VycmVudEluZGljZXM7CiAgICAgICAgbGV0IGN1cnJlbnRJbmRleE1hcDsKICAgICAgICBpZiAocDAueSA8IDApIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gd2VzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gZWFzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfQogICAgICAgIGluc2VydEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSwKICAgICAgICAgIHAwCiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgcDAsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgYXBwbHlPZmZzZXQKICAgICAgICApOwogICAgICAgIGluc2VydEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSArIDEsCiAgICAgICAgICBwMQogICAgICAgICk7CiAgICAgICAgY29tcHV0ZUxpbmVBdHRyaWJ1dGVzKAogICAgICAgICAgaTAsCiAgICAgICAgICBpMSwKICAgICAgICAgIHAxLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaW5zZXJ0SW5kZXgsCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgdXBkYXRlSW5zdGFuY2VBZnRlclNwbGl0KGluc3RhbmNlLCB3ZXN0R2VvbWV0cnksIGVhc3RHZW9tZXRyeSk7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZUFkamFjZW5jeUFmdGVyU3BsaXQoZ2VvbWV0cnkpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gYXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxlbmd0aDsgaiArPSAzKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwb3NpdGlvbnMsIGosIGNhcnRlc2lhbjNTY3JhdGNoMCk7CiAgICAgIGlmIChwb3NpdGlvbi54ID4gMCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IHByZXZQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgcHJldlBvc2l0aW9ucywKICAgICAgICBqLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMgogICAgICApOwogICAgICBpZiAocG9zaXRpb24ueSA8IDAgJiYgcHJldlBvc2l0aW9uLnkgPiAwIHx8IHBvc2l0aW9uLnkgPiAwICYmIHByZXZQb3NpdGlvbi55IDwgMCkgewogICAgICAgIGlmIChqIC0gMyA+IDApIHsKICAgICAgICAgIHByZXZQb3NpdGlvbnNbal0gPSBwb3NpdGlvbnNbaiAtIDNdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMV0gPSBwb3NpdGlvbnNbaiAtIDJdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMl0gPSBwb3NpdGlvbnNbaiAtIDFdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbiwgcHJldlBvc2l0aW9ucywgaik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IG5leHRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgbmV4dFBvc2l0aW9ucywKICAgICAgICBqLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMwogICAgICApOwogICAgICBpZiAocG9zaXRpb24ueSA8IDAgJiYgbmV4dFBvc2l0aW9uLnkgPiAwIHx8IHBvc2l0aW9uLnkgPiAwICYmIG5leHRQb3NpdGlvbi55IDwgMCkgewogICAgICAgIGlmIChqICsgMyA8IGxlbmd0aCkgewogICAgICAgICAgbmV4dFBvc2l0aW9uc1tqXSA9IHBvc2l0aW9uc1tqICsgM107CiAgICAgICAgICBuZXh0UG9zaXRpb25zW2ogKyAxXSA9IHBvc2l0aW9uc1tqICsgNF07CiAgICAgICAgICBuZXh0UG9zaXRpb25zW2ogKyAyXSA9IHBvc2l0aW9uc1tqICsgNV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uLCBuZXh0UG9zaXRpb25zLCBqKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gc3BsaXRMb25naXR1ZGVQb2x5bGluZShpbnN0YW5jZSkgewogICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZS5nZW9tZXRyeTsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gYXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGV4cGFuZEFuZFdpZHRocyA9IGF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzOwogICAgY29uc3QgdGV4Q29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuc3QpID8gYXR0cmlidXRlcy5zdC52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCBjb2xvcnMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5jb2xvcikgPyBhdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IGVhc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGNvbnN0IHdlc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGxldCBpOwogICAgbGV0IGo7CiAgICBsZXQgaW5kZXg7CiAgICBsZXQgaW50ZXJzZWN0aW9uRm91bmQgPSBmYWxzZTsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSA0KSB7CiAgICAgIGNvbnN0IGkwID0gaTsKICAgICAgY29uc3QgaTIgPSBpICsgMjsKICAgICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTAgKiAzLCBjYXJ0ZXNpYW4zU2NyYXRjaDApOwogICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMiAqIDMsIGNhcnRlc2lhbjNTY3JhdGNoMik7CiAgICAgIGlmIChNYXRoLmFicyhwMC55KSA8IGNvcGxhbmFyT2Zmc2V0KSB7CiAgICAgICAgcDAueSA9IGNvcGxhbmFyT2Zmc2V0ICogKHAyLnkgPCAwID8gLTEgOiAxKTsKICAgICAgICBwb3NpdGlvbnNbaSAqIDMgKyAxXSA9IHAwLnk7CiAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgKiAzICsgMV0gPSBwMC55OwogICAgICAgIGZvciAoaiA9IGkwICogMzsgaiA8IGkwICogMyArIDQgKiAzOyBqICs9IDMpIHsKICAgICAgICAgIHByZXZQb3NpdGlvbnNbal0gPSBwb3NpdGlvbnNbaSAqIDNdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMV0gPSBwb3NpdGlvbnNbaSAqIDMgKyAxXTsKICAgICAgICAgIHByZXZQb3NpdGlvbnNbaiArIDJdID0gcG9zaXRpb25zW2kgKiAzICsgMl07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChNYXRoLmFicyhwMi55KSA8IGNvcGxhbmFyT2Zmc2V0KSB7CiAgICAgICAgcDIueSA9IGNvcGxhbmFyT2Zmc2V0ICogKHAwLnkgPCAwID8gLTEgOiAxKTsKICAgICAgICBwb3NpdGlvbnNbKGkgKyAyKSAqIDMgKyAxXSA9IHAyLnk7CiAgICAgICAgcG9zaXRpb25zWyhpICsgMykgKiAzICsgMV0gPSBwMi55OwogICAgICAgIGZvciAoaiA9IGkwICogMzsgaiA8IGkwICogMyArIDQgKiAzOyBqICs9IDMpIHsKICAgICAgICAgIG5leHRQb3NpdGlvbnNbal0gPSBwb3NpdGlvbnNbKGkgKyAyKSAqIDNdOwogICAgICAgICAgbmV4dFBvc2l0aW9uc1tqICsgMV0gPSBwb3NpdGlvbnNbKGkgKyAyKSAqIDMgKyAxXTsKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaiArIDJdID0gcG9zaXRpb25zWyhpICsgMikgKiAzICsgMl07CiAgICAgICAgfQogICAgICB9CiAgICAgIGxldCBwMEF0dHJpYnV0ZXMgPSBlYXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgbGV0IHAwSW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICBsZXQgcDJBdHRyaWJ1dGVzID0gd2VzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgIGxldCBwMkluZGljZXMgPSB3ZXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5saW5lU2VnbWVudFBsYW5lKAogICAgICAgIHAwLAogICAgICAgIHAyLAogICAgICAgIHh6UGxhbmUsCiAgICAgICAgY2FydGVzaWFuM1NjcmF0Y2g0CiAgICAgICk7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICAgIGludGVyc2VjdGlvbkZvdW5kID0gdHJ1ZTsKICAgICAgICBjb25zdCBvZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksCiAgICAgICAgICBvZmZzZXRTY2FsYXIsCiAgICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDUKICAgICAgICApOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShvZmZzZXQsIG9mZnNldCk7CiAgICAgICAgICBwMEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIHAwSW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgcDJBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBwMkluZGljZXMgPSBlYXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2Zmc2V0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgaW50ZXJzZWN0aW9uLAogICAgICAgICAgb2Zmc2V0LAogICAgICAgICAgY2FydGVzaWFuM1NjcmF0Y2g2CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2gocDAueCwgcDAueSwgcDAueiwgcDAueCwgcDAueSwgcDAueik7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAwQXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogM10sCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogMyArIDFdLAogICAgICAgICAgcHJldlBvc2l0aW9uc1tpMCAqIDMgKyAyXQogICAgICAgICk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnByZXZQb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIHByZXZQb3NpdGlvbnNbaTAgKiAzICsgM10sCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogMyArIDRdLAogICAgICAgICAgcHJldlBvc2l0aW9uc1tpMCAqIDMgKyA1XQogICAgICAgICk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnByZXZQb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56LCBwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGludGVyc2VjdGlvbiwgb2Zmc2V0LCBvZmZzZXRQb2ludCk7CiAgICAgICAgcDJBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAyQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMi54LCBwMi55LCBwMi56LCBwMi54LCBwMi55LCBwMi56KTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKHAyLngsIHAyLnksIHAyLnosIHAyLngsIHAyLnksIHAyLnopOwogICAgICAgIHAyQXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogM10sCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogMyArIDFdLAogICAgICAgICAgbmV4dFBvc2l0aW9uc1tpMiAqIDMgKyAyXQogICAgICAgICk7CiAgICAgICAgcDJBdHRyaWJ1dGVzLm5leHRQb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaTIgKiAzICsgM10sCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogMyArIDRdLAogICAgICAgICAgbmV4dFBvc2l0aW9uc1tpMiAqIDMgKyA1XQogICAgICAgICk7CiAgICAgICAgY29uc3QgZXcwID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGV4cGFuZEFuZFdpZHRocywKICAgICAgICAgIGkwICogMiwKICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoMAogICAgICAgICk7CiAgICAgICAgY29uc3Qgd2lkdGggPSBNYXRoLmFicyhldzAueSk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLmV4cGFuZEFuZFdpZHRoLnZhbHVlcy5wdXNoKC0xLCB3aWR0aCwgMSwgd2lkdGgpOwogICAgICAgIHAwQXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aC52YWx1ZXMucHVzaCgtMSwgLXdpZHRoLCAxLCAtd2lkdGgpOwogICAgICAgIHAyQXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aC52YWx1ZXMucHVzaCgtMSwgd2lkdGgsIDEsIHdpZHRoKTsKICAgICAgICBwMkF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzLnB1c2goLTEsIC13aWR0aCwgMSwgLXdpZHRoKTsKICAgICAgICBsZXQgdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGludGVyc2VjdGlvbiwgcDAsIGNhcnRlc2lhbjNTY3JhdGNoMykKICAgICAgICApOwogICAgICAgIHQgLz0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDIsIHAwLCBjYXJ0ZXNpYW4zU2NyYXRjaDMpCiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgIGNvbnN0IGMwID0gQ2FydGVzaWFuNF9kZWZhdWx0LmZyb21BcnJheShjb2xvcnMsIGkwICogNCwgY2FydGVzaWFuNFNjcmF0Y2gwKTsKICAgICAgICAgIGNvbnN0IGMyID0gQ2FydGVzaWFuNF9kZWZhdWx0LmZyb21BcnJheShjb2xvcnMsIGkyICogNCwgY2FydGVzaWFuNFNjcmF0Y2gwKTsKICAgICAgICAgIGNvbnN0IHIgPSBNYXRoX2RlZmF1bHQubGVycChjMC54LCBjMi54LCB0KTsKICAgICAgICAgIGNvbnN0IGcgPSBNYXRoX2RlZmF1bHQubGVycChjMC55LCBjMi55LCB0KTsKICAgICAgICAgIGNvbnN0IGIgPSBNYXRoX2RlZmF1bHQubGVycChjMC56LCBjMi56LCB0KTsKICAgICAgICAgIGNvbnN0IGEzID0gTWF0aF9kZWZhdWx0LmxlcnAoYzAudywgYzIudywgdCk7CiAgICAgICAgICBmb3IgKGogPSBpMCAqIDQ7IGogPCBpMCAqIDQgKyAyICogNDsgKytqKSB7CiAgICAgICAgICAgIHAwQXR0cmlidXRlcy5jb2xvci52YWx1ZXMucHVzaChjb2xvcnNbal0pOwogICAgICAgICAgfQogICAgICAgICAgcDBBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKHIsIGcsIGIsIGEzKTsKICAgICAgICAgIHAwQXR0cmlidXRlcy5jb2xvci52YWx1ZXMucHVzaChyLCBnLCBiLCBhMyk7CiAgICAgICAgICBwMkF0dHJpYnV0ZXMuY29sb3IudmFsdWVzLnB1c2gociwgZywgYiwgYTMpOwogICAgICAgICAgcDJBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKHIsIGcsIGIsIGEzKTsKICAgICAgICAgIGZvciAoaiA9IGkyICogNDsgaiA8IGkyICogNCArIDIgKiA0OyArK2opIHsKICAgICAgICAgICAgcDJBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKGNvbG9yc1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSkgewogICAgICAgICAgY29uc3QgczAgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KHRleENvb3JkcywgaTAgKiAyLCBjYXJ0ZXNpYW4yU2NyYXRjaDApOwogICAgICAgICAgY29uc3QgczMgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICAgIChpICsgMykgKiAyLAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaDEKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzeCA9IE1hdGhfZGVmYXVsdC5sZXJwKHMwLngsIHMzLngsIHQpOwogICAgICAgICAgZm9yIChqID0gaTAgKiAyOyBqIDwgaTAgKiAyICsgMiAqIDI7ICsraikgewogICAgICAgICAgICBwMEF0dHJpYnV0ZXMuc3QudmFsdWVzLnB1c2godGV4Q29vcmRzW2pdKTsKICAgICAgICAgIH0KICAgICAgICAgIHAwQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaChzeCwgczAueSk7CiAgICAgICAgICBwMEF0dHJpYnV0ZXMuc3QudmFsdWVzLnB1c2goc3gsIHMzLnkpOwogICAgICAgICAgcDJBdHRyaWJ1dGVzLnN0LnZhbHVlcy5wdXNoKHN4LCBzMC55KTsKICAgICAgICAgIHAyQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaChzeCwgczMueSk7CiAgICAgICAgICBmb3IgKGogPSBpMiAqIDI7IGogPCBpMiAqIDIgKyAyICogMjsgKytqKSB7CiAgICAgICAgICAgIHAyQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaCh0ZXhDb29yZHNbal0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbmRleCA9IHAwQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMyAtIDQ7CiAgICAgICAgcDBJbmRpY2VzLnB1c2goaW5kZXgsIGluZGV4ICsgMiwgaW5kZXggKyAxKTsKICAgICAgICBwMEluZGljZXMucHVzaChpbmRleCArIDEsIGluZGV4ICsgMiwgaW5kZXggKyAzKTsKICAgICAgICBpbmRleCA9IHAyQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMyAtIDQ7CiAgICAgICAgcDJJbmRpY2VzLnB1c2goaW5kZXgsIGluZGV4ICsgMiwgaW5kZXggKyAxKTsKICAgICAgICBwMkluZGljZXMucHVzaChpbmRleCArIDEsIGluZGV4ICsgMiwgaW5kZXggKyAzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgY3VycmVudEF0dHJpYnV0ZXM7CiAgICAgICAgbGV0IGN1cnJlbnRJbmRpY2VzOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzID0gd2VzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgIH0KICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMi54LCBwMi55LCBwMi56KTsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMi54LCBwMi55LCBwMi56KTsKICAgICAgICBmb3IgKGogPSBpICogMzsgaiA8IGkgKiAzICsgNCAqIDM7ICsraikgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKHByZXZQb3NpdGlvbnNbal0pOwogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKG5leHRQb3NpdGlvbnNbal0pOwogICAgICAgIH0KICAgICAgICBmb3IgKGogPSBpICogMjsgaiA8IGkgKiAyICsgNCAqIDI7ICsraikgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzLnB1c2goZXhwYW5kQW5kV2lkdGhzW2pdKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSkgewogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaCh0ZXhDb29yZHNbal0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgIGZvciAoaiA9IGkgKiA0OyBqIDwgaSAqIDQgKyA0ICogNDsgKytqKSB7CiAgICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKGNvbG9yc1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gY3VycmVudEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDMgLSA0OwogICAgICAgIGN1cnJlbnRJbmRpY2VzLnB1c2goaW5kZXgsIGluZGV4ICsgMiwgaW5kZXggKyAxKTsKICAgICAgICBjdXJyZW50SW5kaWNlcy5wdXNoKGluZGV4ICsgMSwgaW5kZXggKyAyLCBpbmRleCArIDMpOwogICAgICB9CiAgICB9CiAgICBpZiAoaW50ZXJzZWN0aW9uRm91bmQpIHsKICAgICAgdXBkYXRlQWRqYWNlbmN5QWZ0ZXJTcGxpdCh3ZXN0R2VvbWV0cnkpOwogICAgICB1cGRhdGVBZGphY2VuY3lBZnRlclNwbGl0KGVhc3RHZW9tZXRyeSk7CiAgICB9CiAgICB1cGRhdGVJbnN0YW5jZUFmdGVyU3BsaXQoaW5zdGFuY2UsIHdlc3RHZW9tZXRyeSwgZWFzdEdlb21ldHJ5KTsKICB9CiAgdmFyIEdlb21ldHJ5UGlwZWxpbmUsIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMsIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRvZ3JhcGhpYywgZW5jb2RlZFJlc3VsdCwgc2NyYXRjaENhcnRlc2lhbjMzLCBpbnZlcnNlVHJhbnNwb3NlLCBub3JtYWxNYXRyaXgsIHRlbXBTY3JhdGNoLCBub3JtYWwsIHYwLCB2MSwgdjIsIG5vcm1hbFNjcmF0Y2gyLCBub3JtYWxTY2FsZSwgdFNjcmF0Y2gsIHNjcmF0Y2hDYXJ0ZXNpYW4yMiwgdG9FbmNvZGUxLCB0b0VuY29kZTIsIHRvRW5jb2RlMywgZW5jb2RlUmVzdWx0MiwgYzMsIHUxLCB1MiwgcTEsIHEyLCBzcGxpdFRyaWFuZ2xlUmVzdWx0LCBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW40LCBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4zLCBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4yLCBpbnRlcnBvbGF0ZUFuZFBhY2tCb29sZWFuLCBwMFNjcmF0Y2gsIHAxU2NyYXRjaCwgcDJTY3JhdGNoLCBiYXJ5Y2VudHJpY1NjcmF0Y2gsIE5BTUVEX0FUVFJJQlVURVMsIHh6UGxhbmUsIG9mZnNldFNjcmF0Y2gsIG9mZnNldFBvaW50U2NyYXRjaCwgY2FydGVzaWFuMlNjcmF0Y2gwLCBjYXJ0ZXNpYW4yU2NyYXRjaDEsIGNhcnRlc2lhbjNTY3JhdGNoMCwgY2FydGVzaWFuM1NjcmF0Y2gyLCBjYXJ0ZXNpYW4zU2NyYXRjaDMsIGNhcnRlc2lhbjNTY3JhdGNoNCwgY2FydGVzaWFuM1NjcmF0Y2g1LCBjYXJ0ZXNpYW4zU2NyYXRjaDYsIGNhcnRlc2lhbjRTY3JhdGNoMCwgb2Zmc2V0U2NhbGFyLCBjb3BsYW5hck9mZnNldCwgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0OwogIHZhciBpbml0X0dlb21ldHJ5UGlwZWxpbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5UGlwZWxpbmUuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfYmFyeWNlbnRyaWNDb29yZGluYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbmNvZGVkQ2FydGVzaWFuMygpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5VHlwZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3QoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1BsYW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1RpcHNpZnkoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZSA9IHt9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLnRvV2lyZWZyYW1lID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgc3dpdGNoIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzoKICAgICAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzID0gdHJpYW5nbGVzVG9MaW5lcyhpbmRpY2VzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVfU1RSSVA6CiAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IHRyaWFuZ2xlU3RyaXBUb0xpbmVzKGluZGljZXMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRV9GQU46CiAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IHRyaWFuZ2xlRmFuVG9MaW5lcyhpbmRpY2VzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgLy8+PmluY2x1ZGVTdGFydCgnZGVidWcnLCBwcmFnbWFzLmRlYnVnKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgYmUgVFJJQU5HTEVTLCBUUklBTkdMRV9TVFJJUCwgb3IgVFJJQU5HTEVfRkFOLiIKICAgICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNyZWF0ZUxpbmVTZWdtZW50c0ZvclZlY3RvcnMgPSBmdW5jdGlvbihnZW9tZXRyeSwgYXR0cmlidXRlTmFtZSwgbGVuZ3RoKSB7CiAgICAgICAgYXR0cmlidXRlTmFtZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUsICJub3JtYWwiKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBnZW9tZXRyeS5hdHRyaWJ1dGVzIG11c3QgaGF2ZSBhbiBhdHRyaWJ1dGUgd2l0aCB0aGUgc2FtZSBuYW1lIGFzIHRoZSBhdHRyaWJ1dGVOYW1lIHBhcmFtZXRlciwgJHthdHRyaWJ1dGVOYW1lfS5gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsZW5ndGgsIDFlNCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICAgICAgY29uc3QgdmVjdG9ycyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0udmFsdWVzOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgbmV3UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSgyICogcG9zaXRpb25zTGVuZ3RoKTsKICAgICAgICBsZXQgaiA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgbmV3UG9zaXRpb25zW2orK10gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpICsgMl07CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpXSArIHZlY3RvcnNbaV0gKiBsZW5ndGg7CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpICsgMV0gKyB2ZWN0b3JzW2kgKyAxXSAqIGxlbmd0aDsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tqKytdID0gcG9zaXRpb25zW2kgKyAyXSArIHZlY3RvcnNbaSArIDJdICogbGVuZ3RoOwogICAgICAgIH0KICAgICAgICBsZXQgbmV3Qm91bmRpbmdTcGhlcmU7CiAgICAgICAgY29uc3QgYnMgPSBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJzKSkgewogICAgICAgICAgbmV3Qm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdChicy5jZW50ZXIsIGJzLnJhZGl1cyArIGxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBuZXdQb3NpdGlvbnMKICAgICAgICAgICAgfSkKICAgICAgICAgIH0sCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogbmV3Qm91bmRpbmdTcGhlcmUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5jcmVhdGVBdHRyaWJ1dGVMb2NhdGlvbnMgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzZW1hbnRpY3MgPSBbCiAgICAgICAgICAicG9zaXRpb24iLAogICAgICAgICAgInBvc2l0aW9uSGlnaCIsCiAgICAgICAgICAicG9zaXRpb25Mb3ciLAogICAgICAgICAgLy8gRnJvbSBWZXJ0ZXhGb3JtYXQucG9zaXRpb24gLSBhZnRlciAyRCBwcm9qZWN0aW9uIGFuZCBoaWdoLXByZWNpc2lvbiBlbmNvZGluZwogICAgICAgICAgInBvc2l0aW9uM0RIaWdoIiwKICAgICAgICAgICJwb3NpdGlvbjNETG93IiwKICAgICAgICAgICJwb3NpdGlvbjJESGlnaCIsCiAgICAgICAgICAicG9zaXRpb24yRExvdyIsCiAgICAgICAgICAvLyBGcm9tIFByaW1pdGl2ZQogICAgICAgICAgInBpY2tDb2xvciIsCiAgICAgICAgICAvLyBGcm9tIFZlcnRleEZvcm1hdAogICAgICAgICAgIm5vcm1hbCIsCiAgICAgICAgICAic3QiLAogICAgICAgICAgInRhbmdlbnQiLAogICAgICAgICAgImJpdGFuZ2VudCIsCiAgICAgICAgICAvLyBGb3Igc2hhZG93IHZvbHVtZXMKICAgICAgICAgICJleHRydWRlRGlyZWN0aW9uIiwKICAgICAgICAgIC8vIEZyb20gY29tcHJlc3NpbmcgdGV4dHVyZSBjb29yZGluYXRlcyBhbmQgbm9ybWFscwogICAgICAgICAgImNvbXByZXNzZWRBdHRyaWJ1dGVzIgogICAgICAgIF07CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IHt9OwogICAgICAgIGxldCBqID0gMDsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW4gPSBzZW1hbnRpY3MubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgY29uc3Qgc2VtYW50aWMgPSBzZW1hbnRpY3NbaV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbc2VtYW50aWNdKSkgewogICAgICAgICAgICBpbmRpY2VzW3NlbWFudGljXSA9IGorKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KG5hbWUpICYmICFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlc1tuYW1lXSkpIHsKICAgICAgICAgICAgaW5kaWNlc1tuYW1lXSA9IGorKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluZGljZXM7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUucmVvcmRlckZvclByZVZlcnRleENhY2hlID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICBjb25zdCBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXcgPSBuZXcgSW50MzJBcnJheShudW1WZXJ0aWNlcyk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgICAgaW5kZXhDcm9zc1JlZmVyZW5jZU9sZFRvTmV3W2ldID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpbmRpY2VzSW4gPSBpbmRpY2VzOwogICAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXNJbi5sZW5ndGg7CiAgICAgICAgICBjb25zdCBpbmRpY2VzT3V0ID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIG51bUluZGljZXMpOwogICAgICAgICAgbGV0IGludG9JbmRpY2VzSW4gPSAwOwogICAgICAgICAgbGV0IGludG9JbmRpY2VzT3V0ID0gMDsKICAgICAgICAgIGxldCBuZXh0SW5kZXggPSAwOwogICAgICAgICAgbGV0IHRlbXBJbmRleDsKICAgICAgICAgIHdoaWxlIChpbnRvSW5kaWNlc0luIDwgbnVtSW5kaWNlcykgewogICAgICAgICAgICB0ZW1wSW5kZXggPSBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXdbaW5kaWNlc0luW2ludG9JbmRpY2VzSW5dXTsKICAgICAgICAgICAgaWYgKHRlbXBJbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICBpbmRpY2VzT3V0W2ludG9JbmRpY2VzT3V0XSA9IHRlbXBJbmRleDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0ZW1wSW5kZXggPSBpbmRpY2VzSW5baW50b0luZGljZXNJbl07CiAgICAgICAgICAgICAgaW5kZXhDcm9zc1JlZmVyZW5jZU9sZFRvTmV3W3RlbXBJbmRleF0gPSBuZXh0SW5kZXg7CiAgICAgICAgICAgICAgaW5kaWNlc091dFtpbnRvSW5kaWNlc091dF0gPSBuZXh0SW5kZXg7CiAgICAgICAgICAgICAgKytuZXh0SW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytpbnRvSW5kaWNlc0luOwogICAgICAgICAgICArK2ludG9JbmRpY2VzT3V0OwogICAgICAgICAgfQogICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXNPdXQ7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbcHJvcGVydHldKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0udmFsdWVzKSkgewogICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbcHJvcGVydHldOwogICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzSW4gPSBhdHRyaWJ1dGUudmFsdWVzOwogICAgICAgICAgICAgIGxldCBpbnRvRWxlbWVudHNJbiA9IDA7CiAgICAgICAgICAgICAgY29uc3QgbnVtQ29tcG9uZW50cyA9IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzT3V0ID0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgICAgICAgYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgICAgICAgbmV4dEluZGV4ICogbnVtQ29tcG9uZW50cwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgd2hpbGUgKGludG9FbGVtZW50c0luIDwgbnVtVmVydGljZXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRlbXAgPSBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXdbaW50b0VsZW1lbnRzSW5dOwogICAgICAgICAgICAgICAgaWYgKHRlbXAgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtQ29tcG9uZW50czsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudHNPdXRbbnVtQ29tcG9uZW50cyAqIHRlbXAgKyBqXSA9IGVsZW1lbnRzSW5bbnVtQ29tcG9uZW50cyAqIGludG9FbGVtZW50c0luICsgal07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICsraW50b0VsZW1lbnRzSW47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGF0dHJpYnV0ZS52YWx1ZXMgPSBlbGVtZW50c091dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUucmVvcmRlckZvclBvc3RWZXJ0ZXhDYWNoZSA9IGZ1bmN0aW9uKGdlb21ldHJ5LCBjYWNoZUNhcGFjaXR5KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGluZGljZXMgPSBnZW9tZXRyeS5pbmRpY2VzOwogICAgICAgIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTICYmIGRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgICAgbGV0IG1heGltdW1JbmRleCA9IDA7CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG51bUluZGljZXM7IGorKykgewogICAgICAgICAgICBpZiAoaW5kaWNlc1tqXSA+IG1heGltdW1JbmRleCkgewogICAgICAgICAgICAgIG1heGltdW1JbmRleCA9IGluZGljZXNbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMgPSBUaXBzaWZ5X2RlZmF1bHQudGlwc2lmeSh7CiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIG1heGltdW1JbmRleCwKICAgICAgICAgICAgY2FjaGVTaXplOiBjYWNoZUNhcGFjaXR5CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmZpdFRvVW5zaWduZWRTaG9ydEluZGljZXMgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpICYmIGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgIT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMgJiYgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTICYmIGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgIT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5QT0lOVFMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSBtdXN0IGVxdWFsIHRvIFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVTLCBQcmltaXRpdmVUeXBlLkxJTkVTLCBvciBQcmltaXRpdmVUeXBlLlBPSU5UUy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuaW5kaWNlcykgJiYgbnVtYmVyT2ZWZXJ0aWNlcyA+PSBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgIGxldCBvbGRUb05ld0luZGV4ID0gW107CiAgICAgICAgICBsZXQgbmV3SW5kaWNlcyA9IFtdOwogICAgICAgICAgbGV0IGN1cnJlbnRJbmRleCA9IDA7CiAgICAgICAgICBsZXQgbmV3QXR0cmlidXRlcyA9IGNvcHlBdHRyaWJ1dGVzRGVzY3JpcHRpb25zKGdlb21ldHJ5LmF0dHJpYnV0ZXMpOwogICAgICAgICAgY29uc3Qgb3JpZ2luYWxJbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICAgIGNvbnN0IG51bWJlck9mSW5kaWNlcyA9IG9yaWdpbmFsSW5kaWNlcy5sZW5ndGg7CiAgICAgICAgICBsZXQgaW5kaWNlc1BlclByaW1pdGl2ZTsKICAgICAgICAgIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTKSB7CiAgICAgICAgICAgIGluZGljZXNQZXJQcmltaXRpdmUgPSAzOwogICAgICAgICAgfSBlbHNlIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMpIHsKICAgICAgICAgICAgaW5kaWNlc1BlclByaW1pdGl2ZSA9IDI7CiAgICAgICAgICB9IGVsc2UgaWYgKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5QT0lOVFMpIHsKICAgICAgICAgICAgaW5kaWNlc1BlclByaW1pdGl2ZSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG51bWJlck9mSW5kaWNlczsgaiArPSBpbmRpY2VzUGVyUHJpbWl0aXZlKSB7CiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgaW5kaWNlc1BlclByaW1pdGl2ZTsgKytrKSB7CiAgICAgICAgICAgICAgY29uc3QgeCA9IG9yaWdpbmFsSW5kaWNlc1tqICsga107CiAgICAgICAgICAgICAgbGV0IGkgPSBvbGRUb05ld0luZGV4W3hdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBpID0gY3VycmVudEluZGV4Kys7CiAgICAgICAgICAgICAgICBvbGRUb05ld0luZGV4W3hdID0gaTsKICAgICAgICAgICAgICAgIGNvcHlWZXJ0ZXgobmV3QXR0cmlidXRlcywgZ2VvbWV0cnkuYXR0cmlidXRlcywgeCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5ld0luZGljZXMucHVzaChpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY3VycmVudEluZGV4ICsgaW5kaWNlc1BlclByaW1pdGl2ZSA+PSBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goCiAgICAgICAgICAgICAgICBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IG5ld0F0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAgIGluZGljZXM6IG5ld0luZGljZXMsCiAgICAgICAgICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwKICAgICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVDVjogZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIG9sZFRvTmV3SW5kZXggPSBbXTsKICAgICAgICAgICAgICBuZXdJbmRpY2VzID0gW107CiAgICAgICAgICAgICAgY3VycmVudEluZGV4ID0gMDsKICAgICAgICAgICAgICBuZXdBdHRyaWJ1dGVzID0gY29weUF0dHJpYnV0ZXNEZXNjcmlwdGlvbnMoZ2VvbWV0cnkuYXR0cmlidXRlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdJbmRpY2VzLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goCiAgICAgICAgICAgICAgbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgICAgICAgYXR0cmlidXRlczogbmV3QXR0cmlidXRlcywKICAgICAgICAgICAgICAgIGluZGljZXM6IG5ld0luZGljZXMsCiAgICAgICAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmU6IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVDVjogZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVgogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZW9tZXRyaWVzOwogICAgICB9OwogICAgICBzY3JhdGNoUHJvamVjdFRvMkRDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJvamVjdFRvMkRDYXJ0b2dyYXBoaWMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5wcm9qZWN0VG8yRCA9IGZ1bmN0aW9uKGdlb21ldHJ5LCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lM0QsIGF0dHJpYnV0ZU5hbWUyRCwgcHJvamVjdGlvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZU5hbWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUzRCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVOYW1lM0QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUyRCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVOYW1lMkQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYGdlb21ldHJ5IG11c3QgaGF2ZSBhdHRyaWJ1dGUgbWF0Y2hpbmcgdGhlIGF0dHJpYnV0ZU5hbWUgYXJndW1lbnQ6ICR7YXR0cmlidXRlTmFtZX0uYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0uY29tcG9uZW50RGF0YXR5cGUgIT09IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIlRoZSBhdHRyaWJ1dGUgY29tcG9uZW50RGF0YXR5cGUgbXVzdCBiZSBDb21wb25lbnREYXRhdHlwZS5ET1VCTEUuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICBwcm9qZWN0aW9uID0gZGVmaW5lZF9kZWZhdWx0KHByb2plY3Rpb24pID8gcHJvamVjdGlvbiA6IG5ldyBHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0KCk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcHJvamVjdGlvbi5lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgdmFsdWVzM0QgPSBhdHRyaWJ1dGUudmFsdWVzOwogICAgICAgIGNvbnN0IHByb2plY3RlZFZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkodmFsdWVzM0QubGVuZ3RoKTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVzM0QubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgdmFsdWVzM0QsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBsb25MYXQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzY3JhdGNoUHJvamVjdFRvMkRDYXJ0b2dyYXBoaWMKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsb25MYXQpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgIGBDb3VsZCBub3QgcHJvamVjdCBwb2ludCAoJHt2YWx1ZS54fSwgJHt2YWx1ZS55fSwgJHt2YWx1ZS56fSkgdG8gMkQuYAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcHJvamVjdGVkTG9uTGF0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgICBsb25MYXQsCiAgICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMKICAgICAgICAgICk7CiAgICAgICAgICBwcm9qZWN0ZWRWYWx1ZXNbaW5kZXgrK10gPSBwcm9qZWN0ZWRMb25MYXQueDsKICAgICAgICAgIHByb2plY3RlZFZhbHVlc1tpbmRleCsrXSA9IHByb2plY3RlZExvbkxhdC55OwogICAgICAgICAgcHJvamVjdGVkVmFsdWVzW2luZGV4KytdID0gcHJvamVjdGVkTG9uTGF0Lno7CiAgICAgICAgfQogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZTNEXSA9IGF0dHJpYnV0ZTsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWUyRF0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBwcm9qZWN0ZWRWYWx1ZXMKICAgICAgICB9KTsKICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIGVuY29kZWRSZXN1bHQgPSB7CiAgICAgICAgaGlnaDogMCwKICAgICAgICBsb3c6IDAKICAgICAgfTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5lbmNvZGVBdHRyaWJ1dGUgPSBmdW5jdGlvbihnZW9tZXRyeSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlSGlnaE5hbWUsIGF0dHJpYnV0ZUxvd05hbWUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVOYW1lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVIaWdoTmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVIaWdoTmFtZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlTG93TmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVMb3dOYW1lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBnZW9tZXRyeSBtdXN0IGhhdmUgYXR0cmlidXRlIG1hdGNoaW5nIHRoZSBhdHRyaWJ1dGVOYW1lIGFyZ3VtZW50OiAke2F0dHJpYnV0ZU5hbWV9LmAKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdLmNvbXBvbmVudERhdGF0eXBlICE9PSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJUaGUgYXR0cmlidXRlIGNvbXBvbmVudERhdGF0eXBlIG11c3QgYmUgQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV07CiAgICAgICAgY29uc3QgdmFsdWVzID0gYXR0cmlidXRlLnZhbHVlczsKICAgICAgICBjb25zdCBsZW5ndGggPSB2YWx1ZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IGhpZ2hWYWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCk7CiAgICAgICAgY29uc3QgbG93VmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQuZW5jb2RlKHZhbHVlc1tpXSwgZW5jb2RlZFJlc3VsdCk7CiAgICAgICAgICBoaWdoVmFsdWVzW2ldID0gZW5jb2RlZFJlc3VsdC5oaWdoOwogICAgICAgICAgbG93VmFsdWVzW2ldID0gZW5jb2RlZFJlc3VsdC5sb3c7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZUhpZ2hOYW1lXSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgIHZhbHVlczogaGlnaFZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTG93TmFtZV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICB2YWx1ZXM6IGxvd1ZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjMzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBpbnZlcnNlVHJhbnNwb3NlID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBub3JtYWxNYXRyaXggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUudHJhbnNmb3JtVG9Xb3JsZENvb3JkaW5hdGVzID0gZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnN0YW5jZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbnN0YW5jZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbW9kZWxNYXRyaXggPSBpbnN0YW5jZS5tb2RlbE1hdHJpeDsKICAgICAgICBpZiAoTWF0cml4NF9kZWZhdWx0LmVxdWFscyhtb2RlbE1hdHJpeCwgTWF0cml4NF9kZWZhdWx0LklERU5USVRZKSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gaW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICB0cmFuc2Zvcm1Qb2ludChtb2RlbE1hdHJpeCwgYXR0cmlidXRlcy5wb3NpdGlvbik7CiAgICAgICAgdHJhbnNmb3JtUG9pbnQobW9kZWxNYXRyaXgsIGF0dHJpYnV0ZXMucHJldlBvc2l0aW9uKTsKICAgICAgICB0cmFuc2Zvcm1Qb2ludChtb2RlbE1hdHJpeCwgYXR0cmlidXRlcy5uZXh0UG9zaXRpb24pOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5ub3JtYWwpIHx8IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnRhbmdlbnQpIHx8IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmJpdGFuZ2VudCkpIHsKICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlKG1vZGVsTWF0cml4LCBpbnZlcnNlVHJhbnNwb3NlKTsKICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC50cmFuc3Bvc2UoaW52ZXJzZVRyYW5zcG9zZSwgaW52ZXJzZVRyYW5zcG9zZSk7CiAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF0cml4MyhpbnZlcnNlVHJhbnNwb3NlLCBub3JtYWxNYXRyaXgpOwogICAgICAgICAgdHJhbnNmb3JtVmVjdG9yKG5vcm1hbE1hdHJpeCwgYXR0cmlidXRlcy5ub3JtYWwpOwogICAgICAgICAgdHJhbnNmb3JtVmVjdG9yKG5vcm1hbE1hdHJpeCwgYXR0cmlidXRlcy50YW5nZW50KTsKICAgICAgICAgIHRyYW5zZm9ybVZlY3Rvcihub3JtYWxNYXRyaXgsIGF0dHJpYnV0ZXMuYml0YW5nZW50KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBpbnN0YW5jZS5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJvdW5kaW5nU3BoZXJlKSkgewogICAgICAgICAgaW5zdGFuY2UuZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnRyYW5zZm9ybSgKICAgICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICAgIG1vZGVsTWF0cml4LAogICAgICAgICAgICBib3VuZGluZ1NwaGVyZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaW5zdGFuY2UubW9kZWxNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoTWF0cml4NF9kZWZhdWx0LklERU5USVRZKTsKICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgIH07CiAgICAgIHRlbXBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNvbWJpbmVJbnN0YW5jZXMgPSBmdW5jdGlvbihpbnN0YW5jZXMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXMpIHx8IGluc3RhbmNlcy5sZW5ndGggPCAxKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImluc3RhbmNlcyBpcyByZXF1aXJlZCBhbmQgbXVzdCBoYXZlIGxlbmd0aCBncmVhdGVyIHRoYW4gemVyby4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnN0YW5jZUdlb21ldHJ5ID0gW107CiAgICAgICAgY29uc3QgaW5zdGFuY2VTcGxpdEdlb21ldHJ5ID0gW107CiAgICAgICAgY29uc3QgbGVuZ3RoID0gaW5zdGFuY2VzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZ2VvbWV0cnkpKSB7CiAgICAgICAgICAgIGluc3RhbmNlR2VvbWV0cnkucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSkpIHsKICAgICAgICAgICAgaW5zdGFuY2VTcGxpdEdlb21ldHJ5LnB1c2goaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgaWYgKGluc3RhbmNlR2VvbWV0cnkubGVuZ3RoID4gMCkgewogICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKGNvbWJpbmVHZW9tZXRyaWVzKGluc3RhbmNlR2VvbWV0cnksICJnZW9tZXRyeSIpKTsKICAgICAgICB9CiAgICAgICAgaWYgKGluc3RhbmNlU3BsaXRHZW9tZXRyeS5sZW5ndGggPiAwKSB7CiAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goCiAgICAgICAgICAgIGNvbWJpbmVHZW9tZXRyaWVzKGluc3RhbmNlU3BsaXRHZW9tZXRyeSwgIndlc3RIZW1pc3BoZXJlR2VvbWV0cnkiKQogICAgICAgICAgKTsKICAgICAgICAgIGdlb21ldHJpZXMucHVzaCgKICAgICAgICAgICAgY29tYmluZUdlb21ldHJpZXMoaW5zdGFuY2VTcGxpdEdlb21ldHJ5LCAiZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSIpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cmllczsKICAgICAgfTsKICAgICAgbm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2MCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdjEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHYyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNvbXB1dGVOb3JtYWwgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmluZGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChnZW9tZXRyeS5pbmRpY2VzLmxlbmd0aCA8IDIgfHwgZ2VvbWV0cnkuaW5kaWNlcy5sZW5ndGggJSAzICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LmluZGljZXMgbGVuZ3RoIG11c3QgYmUgZ3JlYXRlciB0aGFuIDAgYW5kIGJlIGEgbXVsdGlwbGUgb2YgMy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgYmUgUHJpbWl0aXZlVHlwZS5UUklBTkdMRVMuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IG5vcm1hbHNQZXJWZXJ0ZXggPSBuZXcgQXJyYXkobnVtVmVydGljZXMpOwogICAgICAgIGNvbnN0IG5vcm1hbHNQZXJUcmlhbmdsZSA9IG5ldyBBcnJheShudW1JbmRpY2VzIC8gMyk7CiAgICAgICAgY29uc3Qgbm9ybWFsSW5kaWNlcyA9IG5ldyBBcnJheShudW1JbmRpY2VzKTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgbm9ybWFsc1BlclZlcnRleFtpXSA9IHsKICAgICAgICAgICAgaW5kZXhPZmZzZXQ6IDAsCiAgICAgICAgICAgIGNvdW50OiAwLAogICAgICAgICAgICBjdXJyZW50Q291bnQ6IDAKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGxldCBqID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW5kaWNlczsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBpMCA9IGluZGljZXNbaV07CiAgICAgICAgICBjb25zdCBpMSA9IGluZGljZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaTIgPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgICAgIGNvbnN0IGkwMyA9IGkwICogMzsKICAgICAgICAgIGNvbnN0IGkxMyA9IGkxICogMzsKICAgICAgICAgIGNvbnN0IGkyMyA9IGkyICogMzsKICAgICAgICAgIHYwLnggPSB2ZXJ0aWNlc1tpMDNdOwogICAgICAgICAgdjAueSA9IHZlcnRpY2VzW2kwMyArIDFdOwogICAgICAgICAgdjAueiA9IHZlcnRpY2VzW2kwMyArIDJdOwogICAgICAgICAgdjEueCA9IHZlcnRpY2VzW2kxM107CiAgICAgICAgICB2MS55ID0gdmVydGljZXNbaTEzICsgMV07CiAgICAgICAgICB2MS56ID0gdmVydGljZXNbaTEzICsgMl07CiAgICAgICAgICB2Mi54ID0gdmVydGljZXNbaTIzXTsKICAgICAgICAgIHYyLnkgPSB2ZXJ0aWNlc1tpMjMgKyAxXTsKICAgICAgICAgIHYyLnogPSB2ZXJ0aWNlc1tpMjMgKyAyXTsKICAgICAgICAgIG5vcm1hbHNQZXJWZXJ0ZXhbaTBdLmNvdW50Kys7CiAgICAgICAgICBub3JtYWxzUGVyVmVydGV4W2kxXS5jb3VudCsrOwogICAgICAgICAgbm9ybWFsc1BlclZlcnRleFtpMl0uY291bnQrKzsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh2MSwgdjAsIHYxKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh2MiwgdjAsIHYyKTsKICAgICAgICAgIG5vcm1hbHNQZXJUcmlhbmdsZVtqXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh2MSwgdjIsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSk7CiAgICAgICAgICBqKys7CiAgICAgICAgfQogICAgICAgIGxldCBpbmRleE9mZnNldCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgIG5vcm1hbHNQZXJWZXJ0ZXhbaV0uaW5kZXhPZmZzZXQgKz0gaW5kZXhPZmZzZXQ7CiAgICAgICAgICBpbmRleE9mZnNldCArPSBub3JtYWxzUGVyVmVydGV4W2ldLmNvdW50OwogICAgICAgIH0KICAgICAgICBqID0gMDsKICAgICAgICBsZXQgdmVydGV4Tm9ybWFsRGF0YTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW5kaWNlczsgaSArPSAzKSB7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWxEYXRhID0gbm9ybWFsc1BlclZlcnRleFtpbmRpY2VzW2ldXTsKICAgICAgICAgIGxldCBpbmRleCA9IHZlcnRleE5vcm1hbERhdGEuaW5kZXhPZmZzZXQgKyB2ZXJ0ZXhOb3JtYWxEYXRhLmN1cnJlbnRDb3VudDsKICAgICAgICAgIG5vcm1hbEluZGljZXNbaW5kZXhdID0gajsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50Kys7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWxEYXRhID0gbm9ybWFsc1BlclZlcnRleFtpbmRpY2VzW2kgKyAxXV07CiAgICAgICAgICBpbmRleCA9IHZlcnRleE5vcm1hbERhdGEuaW5kZXhPZmZzZXQgKyB2ZXJ0ZXhOb3JtYWxEYXRhLmN1cnJlbnRDb3VudDsKICAgICAgICAgIG5vcm1hbEluZGljZXNbaW5kZXhdID0gajsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50Kys7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWxEYXRhID0gbm9ybWFsc1BlclZlcnRleFtpbmRpY2VzW2kgKyAyXV07CiAgICAgICAgICBpbmRleCA9IHZlcnRleE5vcm1hbERhdGEuaW5kZXhPZmZzZXQgKyB2ZXJ0ZXhOb3JtYWxEYXRhLmN1cnJlbnRDb3VudDsKICAgICAgICAgIG5vcm1hbEluZGljZXNbaW5kZXhdID0gajsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50Kys7CiAgICAgICAgICBqKys7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5vcm1hbFZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydGljZXMgKiAzKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEgPSBub3JtYWxzUGVyVmVydGV4W2ldOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBub3JtYWwpOwogICAgICAgICAgaWYgKHZlcnRleE5vcm1hbERhdGEuY291bnQgPiAwKSB7CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCB2ZXJ0ZXhOb3JtYWxEYXRhLmNvdW50OyBqKyspIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgbm9ybWFsLAogICAgICAgICAgICAgICAgbm9ybWFsc1BlclRyaWFuZ2xlW25vcm1hbEluZGljZXNbdmVydGV4Tm9ybWFsRGF0YS5pbmRleE9mZnNldCArIGpdXSwKICAgICAgICAgICAgICAgIG5vcm1hbAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBub3JtYWwsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICAgICAgbm9ybWFsc1BlclRyaWFuZ2xlW25vcm1hbEluZGljZXNbdmVydGV4Tm9ybWFsRGF0YS5pbmRleE9mZnNldF1dLAogICAgICAgICAgICAgICAgbm9ybWFsCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBub3JtYWwsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgIG5vcm1hbC56ID0gMTsKICAgICAgICAgIH0KICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsLCBub3JtYWwpOwogICAgICAgICAgbm9ybWFsVmFsdWVzW2kzXSA9IG5vcm1hbC54OwogICAgICAgICAgbm9ybWFsVmFsdWVzW2kzICsgMV0gPSBub3JtYWwueTsKICAgICAgICAgIG5vcm1hbFZhbHVlc1tpMyArIDJdID0gbm9ybWFsLno7CiAgICAgICAgfQogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBub3JtYWxWYWx1ZXMKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIG5vcm1hbFNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3JtYWxTY2FsZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUuY29tcHV0ZVRhbmdlbnRBbmRCaXRhbmdlbnQgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICBjb25zdCBpbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnBvc2l0aW9uKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLm5vcm1hbCkgfHwgIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkuYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnN0KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuc3QudmFsdWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmF0dHJpYnV0ZXMuc3QudmFsdWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmluZGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChpbmRpY2VzLmxlbmd0aCA8IDIgfHwgaW5kaWNlcy5sZW5ndGggJSAzICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LmluZGljZXMgbGVuZ3RoIG11c3QgYmUgZ3JlYXRlciB0aGFuIDAgYW5kIGJlIGEgbXVsdGlwbGUgb2YgMy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgYmUgUHJpbWl0aXZlVHlwZS5UUklBTkdMRVMuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgICBjb25zdCBub3JtYWxzID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzOwogICAgICAgIGNvbnN0IHN0ID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5zdC52YWx1ZXM7CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSBpbmRpY2VzLmxlbmd0aDsKICAgICAgICBjb25zdCB0YW4xID0gbmV3IEFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRhbjEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHRhbjFbaV0gPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgaTAzOwogICAgICAgIGxldCBpMTM7CiAgICAgICAgbGV0IGkyMzsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW5kaWNlczsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBpMCA9IGluZGljZXNbaV07CiAgICAgICAgICBjb25zdCBpMSA9IGluZGljZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaTIgPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgICAgIGkwMyA9IGkwICogMzsKICAgICAgICAgIGkxMyA9IGkxICogMzsKICAgICAgICAgIGkyMyA9IGkyICogMzsKICAgICAgICAgIGNvbnN0IGkwMiA9IGkwICogMjsKICAgICAgICAgIGNvbnN0IGkxMiA9IGkxICogMjsKICAgICAgICAgIGNvbnN0IGkyMiA9IGkyICogMjsKICAgICAgICAgIGNvbnN0IHV4ID0gdmVydGljZXNbaTAzXTsKICAgICAgICAgIGNvbnN0IHV5ID0gdmVydGljZXNbaTAzICsgMV07CiAgICAgICAgICBjb25zdCB1eiA9IHZlcnRpY2VzW2kwMyArIDJdOwogICAgICAgICAgY29uc3Qgd3ggPSBzdFtpMDJdOwogICAgICAgICAgY29uc3Qgd3kgPSBzdFtpMDIgKyAxXTsKICAgICAgICAgIGNvbnN0IHQxID0gc3RbaTEyICsgMV0gLSB3eTsKICAgICAgICAgIGNvbnN0IHQyID0gc3RbaTIyICsgMV0gLSB3eTsKICAgICAgICAgIGNvbnN0IHIgPSAxIC8gKChzdFtpMTJdIC0gd3gpICogdDIgLSAoc3RbaTIyXSAtIHd4KSAqIHQxKTsKICAgICAgICAgIGNvbnN0IHNkaXJ4ID0gKHQyICogKHZlcnRpY2VzW2kxM10gLSB1eCkgLSB0MSAqICh2ZXJ0aWNlc1tpMjNdIC0gdXgpKSAqIHI7CiAgICAgICAgICBjb25zdCBzZGlyeSA9ICh0MiAqICh2ZXJ0aWNlc1tpMTMgKyAxXSAtIHV5KSAtIHQxICogKHZlcnRpY2VzW2kyMyArIDFdIC0gdXkpKSAqIHI7CiAgICAgICAgICBjb25zdCBzZGlyeiA9ICh0MiAqICh2ZXJ0aWNlc1tpMTMgKyAyXSAtIHV6KSAtIHQxICogKHZlcnRpY2VzW2kyMyArIDJdIC0gdXopKSAqIHI7CiAgICAgICAgICB0YW4xW2kwM10gKz0gc2Rpcng7CiAgICAgICAgICB0YW4xW2kwMyArIDFdICs9IHNkaXJ5OwogICAgICAgICAgdGFuMVtpMDMgKyAyXSArPSBzZGlyejsKICAgICAgICAgIHRhbjFbaTEzXSArPSBzZGlyeDsKICAgICAgICAgIHRhbjFbaTEzICsgMV0gKz0gc2Rpcnk7CiAgICAgICAgICB0YW4xW2kxMyArIDJdICs9IHNkaXJ6OwogICAgICAgICAgdGFuMVtpMjNdICs9IHNkaXJ4OwogICAgICAgICAgdGFuMVtpMjMgKyAxXSArPSBzZGlyeTsKICAgICAgICAgIHRhbjFbaTIzICsgMl0gKz0gc2Rpcno7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRhbmdlbnRWYWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgICAgY29uc3QgYml0YW5nZW50VmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgaSsrKSB7CiAgICAgICAgICBpMDMgPSBpICogMzsKICAgICAgICAgIGkxMyA9IGkwMyArIDE7CiAgICAgICAgICBpMjMgPSBpMDMgKyAyOwogICAgICAgICAgY29uc3QgbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobm9ybWFscywgaTAzLCBub3JtYWxTY3JhdGNoMik7CiAgICAgICAgICBjb25zdCB0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0YW4xLCBpMDMsIHRTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IHNjYWxhciA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QobiwgdCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBzY2FsYXIsIG5vcm1hbFNjYWxlKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHQsIG5vcm1hbFNjYWxlLCB0KSwgdCk7CiAgICAgICAgICB0YW5nZW50VmFsdWVzW2kwM10gPSB0Lng7CiAgICAgICAgICB0YW5nZW50VmFsdWVzW2kxM10gPSB0Lnk7CiAgICAgICAgICB0YW5nZW50VmFsdWVzW2kyM10gPSB0Lno7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhuLCB0LCB0KSwgdCk7CiAgICAgICAgICBiaXRhbmdlbnRWYWx1ZXNbaTAzXSA9IHQueDsKICAgICAgICAgIGJpdGFuZ2VudFZhbHVlc1tpMTNdID0gdC55OwogICAgICAgICAgYml0YW5nZW50VmFsdWVzW2kyM10gPSB0Lno7CiAgICAgICAgfQogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogdGFuZ2VudFZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRWYWx1ZXMKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgdG9FbmNvZGUxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b0VuY29kZTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRvRW5jb2RlMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZW5jb2RlUmVzdWx0MiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5jb21wcmVzc1ZlcnRpY2VzID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZXh0cnVkZUF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbjsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbnVtVmVydGljZXM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChleHRydWRlQXR0cmlidXRlKSkgewogICAgICAgICAgY29uc3QgZXh0cnVkZURpcmVjdGlvbnMgPSBleHRydWRlQXR0cmlidXRlLnZhbHVlczsKICAgICAgICAgIG51bVZlcnRpY2VzID0gZXh0cnVkZURpcmVjdGlvbnMubGVuZ3RoIC8gMzsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWREaXJlY3Rpb25zID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDIpOwogICAgICAgICAgbGV0IGkyID0gMDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgKytpKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZXh0cnVkZURpcmVjdGlvbnMsIGkgKiAzLCB0b0VuY29kZTEpOwogICAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyh0b0VuY29kZTEsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgICAgIGkyICs9IDI7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5jb2RlUmVzdWx0MiA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RW5jb2RlSW5SYW5nZSgKICAgICAgICAgICAgICB0b0VuY29kZTEsCiAgICAgICAgICAgICAgNjU1MzUsCiAgICAgICAgICAgICAgZW5jb2RlUmVzdWx0MgogICAgICAgICAgICApOwogICAgICAgICAgICBjb21wcmVzc2VkRGlyZWN0aW9uc1tpMisrXSA9IGVuY29kZVJlc3VsdDIueDsKICAgICAgICAgICAgY29tcHJlc3NlZERpcmVjdGlvbnNbaTIrK10gPSBlbmNvZGVSZXN1bHQyLnk7CiAgICAgICAgICB9CiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbXByZXNzZWRBdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBjb21wcmVzc2VkRGlyZWN0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uOwogICAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICAgIH0KICAgICAgICBjb25zdCBub3JtYWxBdHRyaWJ1dGUgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLm5vcm1hbDsKICAgICAgICBjb25zdCBzdEF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3Q7CiAgICAgICAgY29uc3QgaGFzTm9ybWFsID0gZGVmaW5lZF9kZWZhdWx0KG5vcm1hbEF0dHJpYnV0ZSk7CiAgICAgICAgY29uc3QgaGFzU3QgPSBkZWZpbmVkX2RlZmF1bHQoc3RBdHRyaWJ1dGUpOwogICAgICAgIGlmICghaGFzTm9ybWFsICYmICFoYXNTdCkgewogICAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICAgIH0KICAgICAgICBjb25zdCB0YW5nZW50QXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50OwogICAgICAgIGNvbnN0IGJpdGFuZ2VudEF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMuYml0YW5nZW50OwogICAgICAgIGNvbnN0IGhhc1RhbmdlbnQgPSBkZWZpbmVkX2RlZmF1bHQodGFuZ2VudEF0dHJpYnV0ZSk7CiAgICAgICAgY29uc3QgaGFzQml0YW5nZW50ID0gZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudEF0dHJpYnV0ZSk7CiAgICAgICAgbGV0IG5vcm1hbHM7CiAgICAgICAgbGV0IHN0OwogICAgICAgIGxldCB0YW5nZW50czsKICAgICAgICBsZXQgYml0YW5nZW50czsKICAgICAgICBpZiAoaGFzTm9ybWFsKSB7CiAgICAgICAgICBub3JtYWxzID0gbm9ybWFsQXR0cmlidXRlLnZhbHVlczsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc1N0KSB7CiAgICAgICAgICBzdCA9IHN0QXR0cmlidXRlLnZhbHVlczsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc1RhbmdlbnQpIHsKICAgICAgICAgIHRhbmdlbnRzID0gdGFuZ2VudEF0dHJpYnV0ZS52YWx1ZXM7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNCaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudHMgPSBiaXRhbmdlbnRBdHRyaWJ1dGUudmFsdWVzOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBoYXNOb3JtYWwgPyBub3JtYWxzLmxlbmd0aCA6IHN0Lmxlbmd0aDsKICAgICAgICBjb25zdCBudW1Db21wb25lbnRzID0gaGFzTm9ybWFsID8gMyA6IDI7CiAgICAgICAgbnVtVmVydGljZXMgPSBsZW5ndGggLyBudW1Db21wb25lbnRzOwogICAgICAgIGxldCBjb21wcmVzc2VkTGVuZ3RoID0gbnVtVmVydGljZXM7CiAgICAgICAgbGV0IG51bUNvbXByZXNzZWRDb21wb25lbnRzID0gaGFzU3QgJiYgaGFzTm9ybWFsID8gMiA6IDE7CiAgICAgICAgbnVtQ29tcHJlc3NlZENvbXBvbmVudHMgKz0gaGFzVGFuZ2VudCB8fCBoYXNCaXRhbmdlbnQgPyAxIDogMDsKICAgICAgICBjb21wcmVzc2VkTGVuZ3RoICo9IG51bUNvbXByZXNzZWRDb21wb25lbnRzOwogICAgICAgIGNvbnN0IGNvbXByZXNzZWRBdHRyaWJ1dGVzID0gbmV3IEZsb2F0MzJBcnJheShjb21wcmVzc2VkTGVuZ3RoKTsKICAgICAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgKytpKSB7CiAgICAgICAgICBpZiAoaGFzU3QpIHsKICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheShzdCwgaSAqIDIsIHNjcmF0Y2hDYXJ0ZXNpYW4yMik7CiAgICAgICAgICAgIGNvbXByZXNzZWRBdHRyaWJ1dGVzW25vcm1hbEluZGV4KytdID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcyhzY3JhdGNoQ2FydGVzaWFuMjIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaW5kZXggPSBpICogMzsKICAgICAgICAgIGlmIChoYXNOb3JtYWwgJiYgZGVmaW5lZF9kZWZhdWx0KHRhbmdlbnRzKSAmJiBkZWZpbmVkX2RlZmF1bHQoYml0YW5nZW50cykpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShub3JtYWxzLCBpbmRleCwgdG9FbmNvZGUxKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoYml0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMyk7CiAgICAgICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0UGFjaygKICAgICAgICAgICAgICB0b0VuY29kZTEsCiAgICAgICAgICAgICAgdG9FbmNvZGUyLAogICAgICAgICAgICAgIHRvRW5jb2RlMywKICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMjIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBzY3JhdGNoQ2FydGVzaWFuMjIueDsKICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBzY3JhdGNoQ2FydGVzaWFuMjIueTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChoYXNOb3JtYWwpIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KG5vcm1hbHMsIGluZGV4LCB0b0VuY29kZTEpOwogICAgICAgICAgICAgIGNvbXByZXNzZWRBdHRyaWJ1dGVzW25vcm1hbEluZGV4KytdID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5vY3RFbmNvZGVGbG9hdCh0b0VuY29kZTEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNUYW5nZW50KSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMSk7CiAgICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdEVuY29kZUZsb2F0KHRvRW5jb2RlMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc0JpdGFuZ2VudCkgewogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoYml0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMSk7CiAgICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdEVuY29kZUZsb2F0KHRvRW5jb2RlMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5jb21wcmVzc2VkQXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogbnVtQ29tcHJlc3NlZENvbXBvbmVudHMsCiAgICAgICAgICB2YWx1ZXM6IGNvbXByZXNzZWRBdHRyaWJ1dGVzCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGhhc05vcm1hbCkgewogICAgICAgICAgZGVsZXRlIGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzU3QpIHsKICAgICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0OwogICAgICAgIH0KICAgICAgICBpZiAoaGFzQml0YW5nZW50KSB7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy5iaXRhbmdlbnQ7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNUYW5nZW50KSB7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIGMzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1MSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHExID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBxMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3BsaXRUcmlhbmdsZVJlc3VsdCA9IHsKICAgICAgICBwb3NpdGlvbnM6IG5ldyBBcnJheSg3KSwKICAgICAgICBpbmRpY2VzOiBuZXcgQXJyYXkoMyAqIDMpCiAgICAgIH07CiAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjQgPSBnZW5lcmF0ZUJhcnljZW50cmljSW50ZXJwb2xhdGVGdW5jdGlvbigKICAgICAgICBDYXJ0ZXNpYW40X2RlZmF1bHQsCiAgICAgICAgNAogICAgICApOwogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4zID0gZ2VuZXJhdGVCYXJ5Y2VudHJpY0ludGVycG9sYXRlRnVuY3Rpb24oCiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LAogICAgICAgIDMKICAgICAgKTsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMiA9IGdlbmVyYXRlQmFyeWNlbnRyaWNJbnRlcnBvbGF0ZUZ1bmN0aW9uKAogICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdCwKICAgICAgICAyCiAgICAgICk7CiAgICAgIGludGVycG9sYXRlQW5kUGFja0Jvb2xlYW4gPSBmdW5jdGlvbihpMCwgaTEsIGkyLCBjb29yZHMsIHNvdXJjZVZhbHVlcywgY3VycmVudFZhbHVlcywgaW5zZXJ0ZWRJbmRleCkgewogICAgICAgIGNvbnN0IHYxMiA9IHNvdXJjZVZhbHVlc1tpMF0gKiBjb29yZHMueDsKICAgICAgICBjb25zdCB2MjIgPSBzb3VyY2VWYWx1ZXNbaTFdICogY29vcmRzLnk7CiAgICAgICAgY29uc3QgdjMgPSBzb3VyY2VWYWx1ZXNbaTJdICogY29vcmRzLno7CiAgICAgICAgY3VycmVudFZhbHVlc1tpbnNlcnRlZEluZGV4XSA9IHYxMiArIHYyMiArIHYzID4gTWF0aF9kZWZhdWx0LkVQU0lMT042ID8gMSA6IDA7CiAgICAgIH07CiAgICAgIHAwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcDFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwMlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJhcnljZW50cmljU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTkFNRURfQVRUUklCVVRFUyA9IHsKICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICBub3JtYWw6IHRydWUsCiAgICAgICAgYml0YW5nZW50OiB0cnVlLAogICAgICAgIHRhbmdlbnQ6IHRydWUsCiAgICAgICAgc3Q6IHRydWUsCiAgICAgICAgZXh0cnVkZURpcmVjdGlvbjogdHJ1ZSwKICAgICAgICBhcHBseU9mZnNldDogdHJ1ZQogICAgICB9OwogICAgICB4elBsYW5lID0gUGxhbmVfZGVmYXVsdC5mcm9tUG9pbnROb3JtYWwoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1kpOwogICAgICBvZmZzZXRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBvZmZzZXRQb2ludFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjJTY3JhdGNoMCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMlNjcmF0Y2gxID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2g2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW40U2NyYXRjaDAgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIG9mZnNldFNjYWxhciA9IDUgKiBNYXRoX2RlZmF1bHQuRVBTSUxPTjk7CiAgICAgIGNvcGxhbmFyT2Zmc2V0ID0gTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLnNwbGl0TG9uZ2l0dWRlID0gZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnN0YW5jZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbnN0YW5jZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZS5nZW9tZXRyeTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYm91bmRpbmdTcGhlcmUpKSB7CiAgICAgICAgICBjb25zdCBtaW5YID0gYm91bmRpbmdTcGhlcmUuY2VudGVyLnggLSBib3VuZGluZ1NwaGVyZS5yYWRpdXM7CiAgICAgICAgICBpZiAobWluWCA+IDAgfHwgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5pbnRlcnNlY3RQbGFuZShib3VuZGluZ1NwaGVyZSwgUGxhbmVfZGVmYXVsdC5PUklHSU5fWlhfUExBTkUpICE9PSBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkcpIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkuZ2VvbWV0cnlUeXBlICE9PSBHZW9tZXRyeVR5cGVfZGVmYXVsdC5OT05FKSB7CiAgICAgICAgICBzd2l0Y2ggKGdlb21ldHJ5Lmdlb21ldHJ5VHlwZSkgewogICAgICAgICAgICBjYXNlIEdlb21ldHJ5VHlwZV9kZWZhdWx0LlBPTFlMSU5FUzoKICAgICAgICAgICAgICBzcGxpdExvbmdpdHVkZVBvbHlsaW5lKGluc3RhbmNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBHZW9tZXRyeVR5cGVfZGVmYXVsdC5UUklBTkdMRVM6CiAgICAgICAgICAgICAgc3BsaXRMb25naXR1ZGVUcmlhbmdsZXMoaW5zdGFuY2UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEdlb21ldHJ5VHlwZV9kZWZhdWx0LkxJTkVTOgogICAgICAgICAgICAgIHNwbGl0TG9uZ2l0dWRlTGluZXMoaW5zdGFuY2UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbmRleFByaW1pdGl2ZShnZW9tZXRyeSk7CiAgICAgICAgICBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUykgewogICAgICAgICAgICBzcGxpdExvbmdpdHVkZVRyaWFuZ2xlcyhpbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUykgewogICAgICAgICAgICBzcGxpdExvbmdpdHVkZUxpbmVzKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQgPSBHZW9tZXRyeVBpcGVsaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5qcwogIGZ1bmN0aW9uIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUoeCwgeSwgeikgewogICAgeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgeSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHksIDApOwogICAgeiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgdGhpcy52YWx1ZSA9IG5ldyBGbG9hdDMyQXJyYXkoW3gsIHksIHpdKTsKICB9CiAgdmFyIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGVfZGVmYXVsdDsKICB2YXIgaW5pdF9PZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBkYXRhdHlwZSBvZiBlYWNoIGNvbXBvbmVudCBpbiB0aGUgYXR0cmlidXRlLCBlLmcuLCBpbmRpdmlkdWFsIGVsZW1lbnRzIGluCiAgICAgICAgICoge0BsaW5rIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUjdmFsdWV9LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7Q29tcG9uZW50RGF0YXR5cGV9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAZGVmYXVsdCB7QGxpbmsgQ29tcG9uZW50RGF0YXR5cGUuRkxPQVR9CiAgICAgICAgICovCiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FUOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBjb21wb25lbnRzIGluIHRoZSBhdHRyaWJ1dGVzLCBpLmUuLCB7QGxpbmsgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZSN2YWx1ZX0uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAZGVmYXVsdCAzCiAgICAgICAgICovCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBXaGVuIDxjb2RlPnRydWU8L2NvZGU+IGFuZCA8Y29kZT5jb21wb25lbnREYXRhdHlwZTwvY29kZT4gaXMgYW4gaW50ZWdlciBmb3JtYXQsCiAgICAgICAgICogaW5kaWNhdGUgdGhhdCB0aGUgY29tcG9uZW50cyBzaG91bGQgYmUgbWFwcGVkIHRvIHRoZSByYW5nZSBbMCwgMV0gKHVuc2lnbmVkKQogICAgICAgICAqIG9yIFstMSwgMV0gKHNpZ25lZCkgd2hlbiB0aGV5IGFyZSBhY2Nlc3NlZCBhcyBmbG9hdGluZy1wb2ludCBmb3IgcmVuZGVyaW5nLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgICovCiAgICAgICAgbm9ybWFsaXplOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5mcm9tQ2FydGVzaWFuMyA9IGZ1bmN0aW9uKG9mZnNldCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib2Zmc2V0Iiwgb2Zmc2V0KTsKICAgICAgICByZXR1cm4gbmV3IE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUob2Zmc2V0LngsIG9mZnNldC55LCBvZmZzZXQueik7CiAgICAgIH07CiAgICAgIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUudG9WYWx1ZSA9IGZ1bmN0aW9uKG9mZnNldCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvZmZzZXQiLCBvZmZzZXQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBGbG9hdDMyQXJyYXkoW29mZnNldC54LCBvZmZzZXQueSwgb2Zmc2V0LnpdKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gb2Zmc2V0Lng7CiAgICAgICAgcmVzdWx0WzFdID0gb2Zmc2V0Lnk7CiAgICAgICAgcmVzdWx0WzJdID0gb2Zmc2V0Lno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZV9kZWZhdWx0ID0gT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dlYk1lcmNhdG9yUHJvamVjdGlvbi5qcwogIGZ1bmN0aW9uIFdlYk1lcmNhdG9yUHJvamVjdGlvbihlbGxpcHNvaWQpIHsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fc2VtaW1ham9yQXhpcyA9IHRoaXMuX2VsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgdGhpcy5fb25lT3ZlclNlbWltYWpvckF4aXMgPSAxIC8gdGhpcy5fc2VtaW1ham9yQXhpczsKICB9CiAgdmFyIFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2ViTWVyY2F0b3JQcm9qZWN0aW9uLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhXZWJNZXJjYXRvclByb2plY3Rpb24ucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUge0BsaW5rIEVsbGlwc29pZH0uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLm1lcmNhdG9yQW5nbGVUb0dlb2RldGljTGF0aXR1ZGUgPSBmdW5jdGlvbihtZXJjYXRvckFuZ2xlKSB7CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIDIgKiBNYXRoLmF0YW4oTWF0aC5leHAoLW1lcmNhdG9yQW5nbGUpKTsKICAgICAgfTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUgPSBmdW5jdGlvbihsYXRpdHVkZSkgewogICAgICAgIGlmIChsYXRpdHVkZSA+IFdlYk1lcmNhdG9yUHJvamVjdGlvbi5NYXhpbXVtTGF0aXR1ZGUpIHsKICAgICAgICAgIGxhdGl0dWRlID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uLk1heGltdW1MYXRpdHVkZTsKICAgICAgICB9IGVsc2UgaWYgKGxhdGl0dWRlIDwgLVdlYk1lcmNhdG9yUHJvamVjdGlvbi5NYXhpbXVtTGF0aXR1ZGUpIHsKICAgICAgICAgIGxhdGl0dWRlID0gLVdlYk1lcmNhdG9yUHJvamVjdGlvbi5NYXhpbXVtTGF0aXR1ZGU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNpbkxhdGl0dWRlID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgICAgIHJldHVybiAwLjUgKiBNYXRoLmxvZygoMSArIHNpbkxhdGl0dWRlKSAvICgxIC0gc2luTGF0aXR1ZGUpKTsKICAgICAgfTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLk1heGltdW1MYXRpdHVkZSA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbi5tZXJjYXRvckFuZ2xlVG9HZW9kZXRpY0xhdGl0dWRlKE1hdGguUEkpOwogICAgICBXZWJNZXJjYXRvclByb2plY3Rpb24ucHJvdG90eXBlLnByb2plY3QgPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBzZW1pbWFqb3JBeGlzID0gdGhpcy5fc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB4ID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGUgKiBzZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IHkgPSBXZWJNZXJjYXRvclByb2plY3Rpb24uZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZSgKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUKICAgICAgICApICogc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB6ID0gY2FydG9ncmFwaGljMi5oZWlnaHQ7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgeSwgeik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFdlYk1lcmNhdG9yUHJvamVjdGlvbi5wcm90b3R5cGUudW5wcm9qZWN0ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRlc2lhbjExKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNhcnRlc2lhbiBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzID0gdGhpcy5fb25lT3ZlclNlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY2FydGVzaWFuMTEueCAqIG9uZU92ZXJFYXJ0aFNlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBXZWJNZXJjYXRvclByb2plY3Rpb24ubWVyY2F0b3JBbmdsZVRvR2VvZGV0aWNMYXRpdHVkZSgKICAgICAgICAgIGNhcnRlc2lhbjExLnkgKiBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGxvbmdpdHVkZTsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0ID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1NjZW5lL1ByaW1pdGl2ZVBpcGVsaW5lLmpzCiAgZnVuY3Rpb24gdHJhbnNmb3JtVG9Xb3JsZENvb3JkaW5hdGVzKGluc3RhbmNlcywgcHJpbWl0aXZlTW9kZWxNYXRyaXgsIHNjZW5lM0RPbmx5KSB7CiAgICBsZXQgdG9Xb3JsZCA9ICFzY2VuZTNET25seTsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBsZXQgaTsKICAgIGlmICghdG9Xb3JsZCAmJiBsZW5ndGggPiAxKSB7CiAgICAgIGNvbnN0IG1vZGVsTWF0cml4ID0gaW5zdGFuY2VzWzBdLm1vZGVsTWF0cml4OwogICAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBpZiAoIU1hdHJpeDRfZGVmYXVsdC5lcXVhbHMobW9kZWxNYXRyaXgsIGluc3RhbmNlc1tpXS5tb2RlbE1hdHJpeCkpIHsKICAgICAgICAgIHRvV29ybGQgPSB0cnVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodG9Xb3JsZCkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlc1tpXS5nZW9tZXRyeSkpIHsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC50cmFuc2Zvcm1Ub1dvcmxkQ29vcmRpbmF0ZXMoaW5zdGFuY2VzW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseVRyYW5zZm9ybWF0aW9uKAogICAgICAgIHByaW1pdGl2ZU1vZGVsTWF0cml4LAogICAgICAgIGluc3RhbmNlc1swXS5tb2RlbE1hdHJpeCwKICAgICAgICBwcmltaXRpdmVNb2RlbE1hdHJpeAogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiBhZGRHZW9tZXRyeUJhdGNoSWQoZ2VvbWV0cnksIGJhdGNoSWQpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgcG9zaXRpb25BdHRyID0gYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgIGNvbnN0IG51bWJlck9mQ29tcG9uZW50cyA9IHBvc2l0aW9uQXR0ci52YWx1ZXMubGVuZ3RoIC8gcG9zaXRpb25BdHRyLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7CiAgICBhdHRyaWJ1dGVzLmJhdGNoSWQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICB2YWx1ZXM6IG5ldyBGbG9hdDMyQXJyYXkobnVtYmVyT2ZDb21wb25lbnRzKQogICAgfSk7CiAgICBjb25zdCB2YWx1ZXMgPSBhdHRyaWJ1dGVzLmJhdGNoSWQudmFsdWVzOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBudW1iZXJPZkNvbXBvbmVudHM7ICsraikgewogICAgICB2YWx1ZXNbal0gPSBiYXRjaElkOwogICAgfQogIH0KICBmdW5jdGlvbiBhZGRCYXRjaElkcyhpbnN0YW5jZXMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLmdlb21ldHJ5KSkgewogICAgICAgIGFkZEdlb21ldHJ5QmF0Y2hJZChpbnN0YW5jZS5nZW9tZXRyeSwgaSk7CiAgICAgIH0gZWxzZSBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLndlc3RIZW1pc3BoZXJlR2VvbWV0cnkpICYmIGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5KSkgewogICAgICAgIGFkZEdlb21ldHJ5QmF0Y2hJZChpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5LCBpKTsKICAgICAgICBhZGRHZW9tZXRyeUJhdGNoSWQoaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSwgaSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VvbWV0cnlQaXBlbGluZShwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBpbnN0YW5jZXMgPSBwYXJhbWV0ZXJzLmluc3RhbmNlczsKICAgIGNvbnN0IHByb2plY3Rpb24gPSBwYXJhbWV0ZXJzLnByb2plY3Rpb247CiAgICBjb25zdCB1aW50SW5kZXhTdXBwb3J0ID0gcGFyYW1ldGVycy5lbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkOwogICAgY29uc3Qgc2NlbmUzRE9ubHkgPSBwYXJhbWV0ZXJzLnNjZW5lM0RPbmx5OwogICAgY29uc3QgdmVydGV4Q2FjaGVPcHRpbWl6ZSA9IHBhcmFtZXRlcnMudmVydGV4Q2FjaGVPcHRpbWl6ZTsKICAgIGNvbnN0IGNvbXByZXNzVmVydGljZXMgPSBwYXJhbWV0ZXJzLmNvbXByZXNzVmVydGljZXM7CiAgICBjb25zdCBtb2RlbE1hdHJpeCA9IHBhcmFtZXRlcnMubW9kZWxNYXRyaXg7CiAgICBsZXQgaTsKICAgIGxldCBnZW9tZXRyeTsKICAgIGxldCBwcmltaXRpdmVUeXBlOwogICAgbGV0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbaV0uZ2VvbWV0cnkpKSB7CiAgICAgICAgcHJpbWl0aXZlVHlwZSA9IGluc3RhbmNlc1tpXS5nZW9tZXRyeS5wcmltaXRpdmVUeXBlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbaV0uZ2VvbWV0cnkpICYmIGluc3RhbmNlc1tpXS5nZW9tZXRyeS5wcmltaXRpdmVUeXBlICE9PSBwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiQWxsIGluc3RhbmNlIGdlb21ldHJpZXMgbXVzdCBoYXZlIHRoZSBzYW1lIHByaW1pdGl2ZVR5cGUuIgogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHRyYW5zZm9ybVRvV29ybGRDb29yZGluYXRlcyhpbnN0YW5jZXMsIG1vZGVsTWF0cml4LCBzY2VuZTNET25seSk7CiAgICBpZiAoIXNjZW5lM0RPbmx5KSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzW2ldLmdlb21ldHJ5KSkgewogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnNwbGl0TG9uZ2l0dWRlKGluc3RhbmNlc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBhZGRCYXRjaElkcyhpbnN0YW5jZXMpOwogICAgaWYgKHZlcnRleENhY2hlT3B0aW1pemUpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBpbnN0YW5jZXNbaV07CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5nZW9tZXRyeSkpIHsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5yZW9yZGVyRm9yUG9zdFZlcnRleENhY2hlKGluc3RhbmNlLmdlb21ldHJ5KTsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5yZW9yZGVyRm9yUHJlVmVydGV4Q2FjaGUoaW5zdGFuY2UuZ2VvbWV0cnkpOwogICAgICAgIH0gZWxzZSBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLndlc3RIZW1pc3BoZXJlR2VvbWV0cnkpICYmIGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5KSkgewogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnJlb3JkZXJGb3JQb3N0VmVydGV4Q2FjaGUoCiAgICAgICAgICAgIGluc3RhbmNlLndlc3RIZW1pc3BoZXJlR2VvbWV0cnkKICAgICAgICAgICk7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucmVvcmRlckZvclByZVZlcnRleENhY2hlKAogICAgICAgICAgICBpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5CiAgICAgICAgICApOwogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnJlb3JkZXJGb3JQb3N0VmVydGV4Q2FjaGUoCiAgICAgICAgICAgIGluc3RhbmNlLmVhc3RIZW1pc3BoZXJlR2VvbWV0cnkKICAgICAgICAgICk7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucmVvcmRlckZvclByZVZlcnRleENhY2hlKAogICAgICAgICAgICBpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IGdlb21ldHJpZXMgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhpbnN0YW5jZXMpOwogICAgbGVuZ3RoID0gZ2VvbWV0cmllcy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgZ2VvbWV0cnkgPSBnZW9tZXRyaWVzW2ldOwogICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgaWYgKCFzY2VuZTNET25seSkgewogICAgICAgIGZvciAoY29uc3QgbmFtZSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiBhdHRyaWJ1dGVzW25hbWVdLmNvbXBvbmVudERhdGF0eXBlID09PSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSkgewogICAgICAgICAgICBjb25zdCBuYW1lM0QgPSBgJHtuYW1lfTNEYDsKICAgICAgICAgICAgY29uc3QgbmFtZTJEID0gYCR7bmFtZX0yRGA7CiAgICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5wcm9qZWN0VG8yRCgKICAgICAgICAgICAgICBnZW9tZXRyeSwKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIG5hbWUzRCwKICAgICAgICAgICAgICBuYW1lMkQsCiAgICAgICAgICAgICAgcHJvamVjdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlKSAmJiBuYW1lID09PSAicG9zaXRpb24iKSB7CiAgICAgICAgICAgICAgZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDViA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjJELnZhbHVlcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmVuY29kZUF0dHJpYnV0ZSgKICAgICAgICAgICAgICBnZW9tZXRyeSwKICAgICAgICAgICAgICBuYW1lM0QsCiAgICAgICAgICAgICAgYCR7bmFtZTNEfUhpZ2hgLAogICAgICAgICAgICAgIGAke25hbWUzRH1Mb3dgCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5lbmNvZGVBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgZ2VvbWV0cnksCiAgICAgICAgICAgICAgbmFtZTJELAogICAgICAgICAgICAgIGAke25hbWUyRH1IaWdoYCwKICAgICAgICAgICAgICBgJHtuYW1lMkR9TG93YAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGNvbnN0IG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgYXR0cmlidXRlc1tuYW1lXS5jb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUpIHsKICAgICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmVuY29kZUF0dHJpYnV0ZSgKICAgICAgICAgICAgICBnZW9tZXRyeSwKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIGAke25hbWV9M0RIaWdoYCwKICAgICAgICAgICAgICBgJHtuYW1lfTNETG93YAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY29tcHJlc3NWZXJ0aWNlcykgewogICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21wcmVzc1ZlcnRpY2VzKGdlb21ldHJ5KTsKICAgICAgfQogICAgfQogICAgaWYgKCF1aW50SW5kZXhTdXBwb3J0KSB7CiAgICAgIGxldCBzcGxpdEdlb21ldHJpZXMgPSBbXTsKICAgICAgbGVuZ3RoID0gZ2VvbWV0cmllcy5sZW5ndGg7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGdlb21ldHJ5ID0gZ2VvbWV0cmllc1tpXTsKICAgICAgICBzcGxpdEdlb21ldHJpZXMgPSBzcGxpdEdlb21ldHJpZXMuY29uY2F0KAogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmZpdFRvVW5zaWduZWRTaG9ydEluZGljZXMoZ2VvbWV0cnkpCiAgICAgICAgKTsKICAgICAgfQogICAgICBnZW9tZXRyaWVzID0gc3BsaXRHZW9tZXRyaWVzOwogICAgfQogICAgcmV0dXJuIGdlb21ldHJpZXM7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVBpY2tPZmZzZXRzKGluc3RhbmNlcywgZ2VvbWV0cnlOYW1lLCBnZW9tZXRyaWVzLCBwaWNrT2Zmc2V0cykgewogICAgbGV0IG9mZnNldDsKICAgIGxldCBpbmRleENvdW50OwogICAgbGV0IGdlb21ldHJ5SW5kZXg7CiAgICBjb25zdCBvZmZzZXRJbmRleCA9IHBpY2tPZmZzZXRzLmxlbmd0aCAtIDE7CiAgICBpZiAob2Zmc2V0SW5kZXggPj0gMCkgewogICAgICBjb25zdCBwaWNrT2Zmc2V0ID0gcGlja09mZnNldHNbb2Zmc2V0SW5kZXhdOwogICAgICBvZmZzZXQgPSBwaWNrT2Zmc2V0Lm9mZnNldCArIHBpY2tPZmZzZXQuY291bnQ7CiAgICAgIGdlb21ldHJ5SW5kZXggPSBwaWNrT2Zmc2V0LmluZGV4OwogICAgICBpbmRleENvdW50ID0gZ2VvbWV0cmllc1tnZW9tZXRyeUluZGV4XS5pbmRpY2VzLmxlbmd0aDsKICAgIH0gZWxzZSB7CiAgICAgIG9mZnNldCA9IDA7CiAgICAgIGdlb21ldHJ5SW5kZXggPSAwOwogICAgICBpbmRleENvdW50ID0gZ2VvbWV0cmllc1tnZW9tZXRyeUluZGV4XS5pbmRpY2VzLmxlbmd0aDsKICAgIH0KICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICBjb25zdCBnZW9tZXRyeSA9IGluc3RhbmNlW2dlb21ldHJ5TmFtZV07CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGNvdW50ID0gZ2VvbWV0cnkuaW5kaWNlcy5sZW5ndGg7CiAgICAgIGlmIChvZmZzZXQgKyBjb3VudCA+IGluZGV4Q291bnQpIHsKICAgICAgICBvZmZzZXQgPSAwOwogICAgICAgIGluZGV4Q291bnQgPSBnZW9tZXRyaWVzWysrZ2VvbWV0cnlJbmRleF0uaW5kaWNlcy5sZW5ndGg7CiAgICAgIH0KICAgICAgcGlja09mZnNldHMucHVzaCh7CiAgICAgICAgaW5kZXg6IGdlb21ldHJ5SW5kZXgsCiAgICAgICAgb2Zmc2V0LAogICAgICAgIGNvdW50CiAgICAgIH0pOwogICAgICBvZmZzZXQgKz0gY291bnQ7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlUGlja09mZnNldHMoaW5zdGFuY2VzLCBnZW9tZXRyaWVzKSB7CiAgICBjb25zdCBwaWNrT2Zmc2V0cyA9IFtdOwogICAgY3JlYXRlUGlja09mZnNldHMoaW5zdGFuY2VzLCAiZ2VvbWV0cnkiLCBnZW9tZXRyaWVzLCBwaWNrT2Zmc2V0cyk7CiAgICBjcmVhdGVQaWNrT2Zmc2V0cygKICAgICAgaW5zdGFuY2VzLAogICAgICAid2VzdEhlbWlzcGhlcmVHZW9tZXRyeSIsCiAgICAgIGdlb21ldHJpZXMsCiAgICAgIHBpY2tPZmZzZXRzCiAgICApOwogICAgY3JlYXRlUGlja09mZnNldHMoCiAgICAgIGluc3RhbmNlcywKICAgICAgImVhc3RIZW1pc3BoZXJlR2VvbWV0cnkiLAogICAgICBnZW9tZXRyaWVzLAogICAgICBwaWNrT2Zmc2V0cwogICAgKTsKICAgIHJldHVybiBwaWNrT2Zmc2V0czsKICB9CiAgZnVuY3Rpb24gdHJhbnNmZXJHZW9tZXRyeShnZW9tZXRyeSwgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGUpICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGUudmFsdWVzKSkgewogICAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnV0ZS52YWx1ZXMuYnVmZmVyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuaW5kaWNlcykpIHsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGdlb21ldHJ5LmluZGljZXMuYnVmZmVyKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJhbnNmZXJHZW9tZXRyaWVzKGdlb21ldHJpZXMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJpZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICB0cmFuc2Zlckdlb21ldHJ5KGdlb21ldHJpZXNbaV0sIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgfQogIH0KICBmdW5jdGlvbiBjb3VudENyZWF0ZUdlb21ldHJ5UmVzdWx0cyhpdGVtcykgewogICAgbGV0IGNvdW50ID0gMTsKICAgIGNvbnN0IGxlbmd0aCA9IGl0ZW1zLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpdGVtc1tpXTsKICAgICAgKytjb3VudDsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgIGNvdW50ICs9IDcgKyAyICogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpID8gZ2VvbWV0cnkuaW5kaWNlcy5sZW5ndGggOiAwKTsKICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XSkpIHsKICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbcHJvcGVydHldOwogICAgICAgICAgY291bnQgKz0gNSArIGF0dHJpYnV0ZS52YWx1ZXMubGVuZ3RoOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNvdW50OwogIH0KICBmdW5jdGlvbiBwYWNrSW5zdGFuY2VzRm9yQ29tYmluZShpbnN0YW5jZXMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBjb25zdCBwYWNrZWREYXRhID0gbmV3IEZsb2F0NjRBcnJheSgxICsgbGVuZ3RoICogMTkpOwogICAgbGV0IGNvdW50ID0gMDsKICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBsZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICBNYXRyaXg0X2RlZmF1bHQucGFjayhpbnN0YW5jZS5tb2RlbE1hdHJpeCwgcGFja2VkRGF0YSwgY291bnQpOwogICAgICBjb3VudCArPSBNYXRyaXg0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLmF0dHJpYnV0ZXMpICYmIGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5hdHRyaWJ1dGVzLm9mZnNldCkpIHsKICAgICAgICBjb25zdCB2YWx1ZXMgPSBpbnN0YW5jZS5hdHRyaWJ1dGVzLm9mZnNldC52YWx1ZTsKICAgICAgICBwYWNrZWREYXRhW2NvdW50XSA9IHZhbHVlc1swXTsKICAgICAgICBwYWNrZWREYXRhW2NvdW50ICsgMV0gPSB2YWx1ZXNbMV07CiAgICAgICAgcGFja2VkRGF0YVtjb3VudCArIDJdID0gdmFsdWVzWzJdOwogICAgICB9CiAgICAgIGNvdW50ICs9IDM7CiAgICB9CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocGFja2VkRGF0YS5idWZmZXIpOwogICAgcmV0dXJuIHBhY2tlZERhdGE7CiAgfQogIGZ1bmN0aW9uIHVucGFja0luc3RhbmNlc0ZvckNvbWJpbmUoZGF0YSkgewogICAgY29uc3QgcGFja2VkSW5zdGFuY2VzID0gZGF0YTsKICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheShwYWNrZWRJbnN0YW5jZXNbMF0pOwogICAgbGV0IGNvdW50ID0gMDsKICAgIGxldCBpID0gMTsKICAgIHdoaWxlIChpIDwgcGFja2VkSW5zdGFuY2VzLmxlbmd0aCkgewogICAgICBjb25zdCBtb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC51bnBhY2socGFja2VkSW5zdGFuY2VzLCBpKTsKICAgICAgbGV0IGF0dHJpYnV0ZXM7CiAgICAgIGkgKz0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwYWNrZWRJbnN0YW5jZXNbaV0pKSB7CiAgICAgICAgYXR0cmlidXRlcyA9IHsKICAgICAgICAgIG9mZnNldDogbmV3IE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGVfZGVmYXVsdCgKICAgICAgICAgICAgcGFja2VkSW5zdGFuY2VzW2ldLAogICAgICAgICAgICBwYWNrZWRJbnN0YW5jZXNbaSArIDFdLAogICAgICAgICAgICBwYWNrZWRJbnN0YW5jZXNbaSArIDJdCiAgICAgICAgICApCiAgICAgICAgfTsKICAgICAgfQogICAgICBpICs9IDM7CiAgICAgIHJlc3VsdFtjb3VudCsrXSA9IHsKICAgICAgICBtb2RlbE1hdHJpeCwKICAgICAgICBhdHRyaWJ1dGVzCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBwYWNrQm91bmRpbmdTcGhlcmVzKGJvdW5kaW5nU3BoZXJlcykgewogICAgY29uc3QgbGVuZ3RoID0gYm91bmRpbmdTcGhlcmVzLmxlbmd0aDsKICAgIGNvbnN0IGJ1ZmZlckxlbmd0aCA9IDEgKyAoQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxKSAqIGxlbmd0aDsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyTGVuZ3RoKTsKICAgIGxldCBidWZmZXJJbmRleCA9IDA7CiAgICBidWZmZXJbYnVmZmVySW5kZXgrK10gPSBsZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGJzID0gYm91bmRpbmdTcGhlcmVzW2ldOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChicykpIHsKICAgICAgICBidWZmZXJbYnVmZmVySW5kZXgrK10gPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIGJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IDE7CiAgICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrKGJvdW5kaW5nU3BoZXJlc1tpXSwgYnVmZmVyLCBidWZmZXJJbmRleCk7CiAgICAgIH0KICAgICAgYnVmZmVySW5kZXggKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICBmdW5jdGlvbiB1bnBhY2tCb3VuZGluZ1NwaGVyZXMoYnVmZmVyKSB7CiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkoYnVmZmVyWzBdKTsKICAgIGxldCBjb3VudCA9IDA7CiAgICBsZXQgaSA9IDE7CiAgICB3aGlsZSAoaSA8IGJ1ZmZlci5sZW5ndGgpIHsKICAgICAgaWYgKGJ1ZmZlcltpKytdID09PSAxKSB7CiAgICAgICAgcmVzdWx0W2NvdW50XSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5wYWNrKGJ1ZmZlciwgaSk7CiAgICAgIH0KICAgICAgKytjb3VudDsKICAgICAgaSArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBQcmltaXRpdmVQaXBlbGluZSwgUHJpbWl0aXZlUGlwZWxpbmVfZGVmYXVsdDsKICB2YXIgaW5pdF9QcmltaXRpdmVQaXBlbGluZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1NjZW5lL1ByaW1pdGl2ZVBpcGVsaW5lLmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvZ3JhcGhpY1Byb2plY3Rpb24oKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZSgpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBQcmltaXRpdmVQaXBlbGluZSA9IHt9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS5jb21iaW5lR2VvbWV0cnkgPSBmdW5jdGlvbihwYXJhbWV0ZXJzKSB7CiAgICAgICAgbGV0IGdlb21ldHJpZXM7CiAgICAgICAgbGV0IGF0dHJpYnV0ZUxvY2F0aW9uczsKICAgICAgICBjb25zdCBpbnN0YW5jZXMgPSBwYXJhbWV0ZXJzLmluc3RhbmNlczsKICAgICAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgICAgIGxldCBwaWNrT2Zmc2V0czsKICAgICAgICBsZXQgb2Zmc2V0SW5zdGFuY2VFeHRlbmQ7CiAgICAgICAgbGV0IGhhc09mZnNldCA9IGZhbHNlOwogICAgICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgICAgICBnZW9tZXRyaWVzID0gZ2VvbWV0cnlQaXBlbGluZShwYXJhbWV0ZXJzKTsKICAgICAgICAgIGlmIChnZW9tZXRyaWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgYXR0cmlidXRlTG9jYXRpb25zID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNyZWF0ZUF0dHJpYnV0ZUxvY2F0aW9ucygKICAgICAgICAgICAgICBnZW9tZXRyaWVzWzBdCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChwYXJhbWV0ZXJzLmNyZWF0ZVBpY2tPZmZzZXRzKSB7CiAgICAgICAgICAgICAgcGlja09mZnNldHMgPSBjcmVhdGVJbnN0YW5jZVBpY2tPZmZzZXRzKGluc3RhbmNlcywgZ2VvbWV0cmllcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzWzBdLmF0dHJpYnV0ZXMpICYmIGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbMF0uYXR0cmlidXRlcy5vZmZzZXQpKSB7CiAgICAgICAgICAgIG9mZnNldEluc3RhbmNlRXh0ZW5kID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIGhhc09mZnNldCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlcyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlc0NWID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBpbnN0YW5jZXNbaV07CiAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IGluc3RhbmNlLmdlb21ldHJ5OwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVzW2ldID0gZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmU7CiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlc0NWW2ldID0gZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVjsKICAgICAgICAgICAgaWYgKGhhc09mZnNldCkgewogICAgICAgICAgICAgIG9mZnNldEluc3RhbmNlRXh0ZW5kW2ldID0gaW5zdGFuY2UuZ2VvbWV0cnkub2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBlYXN0SGVtaXNwaGVyZUdlb21ldHJ5ID0gaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeTsKICAgICAgICAgIGNvbnN0IHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkgPSBpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5OwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlYXN0SGVtaXNwaGVyZUdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQod2VzdEhlbWlzcGhlcmVHZW9tZXRyeSkpIHsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlYXN0SGVtaXNwaGVyZUdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlKSAmJiBkZWZpbmVkX2RlZmF1bHQod2VzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSkpIHsKICAgICAgICAgICAgICBib3VuZGluZ1NwaGVyZXNbaV0gPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnVuaW9uKAogICAgICAgICAgICAgICAgZWFzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwKICAgICAgICAgICAgICAgIHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWFzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWKSAmJiBkZWZpbmVkX2RlZmF1bHQod2VzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWKSkgewogICAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlc0NWW2ldID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbigKICAgICAgICAgICAgICAgIGVhc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDViwKICAgICAgICAgICAgICAgIHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGdlb21ldHJpZXMsCiAgICAgICAgICBtb2RlbE1hdHJpeDogcGFyYW1ldGVycy5tb2RlbE1hdHJpeCwKICAgICAgICAgIGF0dHJpYnV0ZUxvY2F0aW9ucywKICAgICAgICAgIHBpY2tPZmZzZXRzLAogICAgICAgICAgb2Zmc2V0SW5zdGFuY2VFeHRlbmQsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZXMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVgogICAgICAgIH07CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVBpcGVsaW5lLnBhY2tDcmVhdGVHZW9tZXRyeVJlc3VsdHMgPSBmdW5jdGlvbihpdGVtcywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgICAgIGNvbnN0IHBhY2tlZERhdGEgPSBuZXcgRmxvYXQ2NEFycmF5KGNvdW50Q3JlYXRlR2VvbWV0cnlSZXN1bHRzKGl0ZW1zKSk7CiAgICAgICAgY29uc3Qgc3RyaW5nVGFibGUgPSBbXTsKICAgICAgICBjb25zdCBzdHJpbmdIYXNoID0ge307CiAgICAgICAgY29uc3QgbGVuZ3RoID0gaXRlbXMubGVuZ3RoOwogICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IGl0ZW1zW2ldOwogICAgICAgICAgY29uc3QgdmFsaWRHZW9tZXRyeSA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSk7CiAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gdmFsaWRHZW9tZXRyeSA/IDEgOiAwOwogICAgICAgICAgaWYgKCF2YWxpZEdlb21ldHJ5KSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGU7CiAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gZ2VvbWV0cnkuZ2VvbWV0cnlUeXBlOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGdlb21ldHJ5Lm9mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgICAgY29uc3QgdmFsaWRCb3VuZGluZ1NwaGVyZSA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSkgPyAxIDogMDsKICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSB2YWxpZEJvdW5kaW5nU3BoZXJlOwogICAgICAgICAgaWYgKHZhbGlkQm91bmRpbmdTcGhlcmUpIHsKICAgICAgICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrKGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLCBwYWNrZWREYXRhLCBjb3VudCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb3VudCArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICAgIGNvbnN0IHZhbGlkQm91bmRpbmdTcGhlcmVDViA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWKSA/IDEgOiAwOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IHZhbGlkQm91bmRpbmdTcGhlcmVDVjsKICAgICAgICAgIGlmICh2YWxpZEJvdW5kaW5nU3BoZXJlQ1YpIHsKICAgICAgICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrKGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1YsIHBhY2tlZERhdGEsIGNvdW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGNvdW50ICs9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzVG9Xcml0ZSA9IFtdOwogICAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pKSB7CiAgICAgICAgICAgICAgYXR0cmlidXRlc1RvV3JpdGUucHVzaChwcm9wZXJ0eSk7CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3RyaW5nSGFzaFtwcm9wZXJ0eV0pKSB7CiAgICAgICAgICAgICAgICBzdHJpbmdIYXNoW3Byb3BlcnR5XSA9IHN0cmluZ1RhYmxlLmxlbmd0aDsKICAgICAgICAgICAgICAgIHN0cmluZ1RhYmxlLnB1c2gocHJvcGVydHkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZXNUb1dyaXRlLmxlbmd0aDsKICAgICAgICAgIGZvciAobGV0IHEgPSAwOyBxIDwgYXR0cmlidXRlc1RvV3JpdGUubGVuZ3RoOyBxKyspIHsKICAgICAgICAgICAgY29uc3QgbmFtZSA9IGF0dHJpYnV0ZXNUb1dyaXRlW3FdOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW25hbWVdOwogICAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gc3RyaW5nSGFzaFtuYW1lXTsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZTsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gYXR0cmlidXRlLm5vcm1hbGl6ZSA/IDEgOiAwOwogICAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gYXR0cmlidXRlLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgIHBhY2tlZERhdGEuc2V0KGF0dHJpYnV0ZS52YWx1ZXMsIGNvdW50KTsKICAgICAgICAgICAgY291bnQgKz0gYXR0cmlidXRlLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpbmRpY2VzTGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpID8gZ2VvbWV0cnkuaW5kaWNlcy5sZW5ndGggOiAwOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGluZGljZXNMZW5ndGg7CiAgICAgICAgICBpZiAoaW5kaWNlc0xlbmd0aCA+IDApIHsKICAgICAgICAgICAgcGFja2VkRGF0YS5zZXQoZ2VvbWV0cnkuaW5kaWNlcywgY291bnQpOwogICAgICAgICAgICBjb3VudCArPSBpbmRpY2VzTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocGFja2VkRGF0YS5idWZmZXIpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBzdHJpbmdUYWJsZSwKICAgICAgICAgIHBhY2tlZERhdGEKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS51bnBhY2tDcmVhdGVHZW9tZXRyeVJlc3VsdHMgPSBmdW5jdGlvbihjcmVhdGVHZW9tZXRyeVJlc3VsdCkgewogICAgICAgIGNvbnN0IHN0cmluZ1RhYmxlID0gY3JlYXRlR2VvbWV0cnlSZXN1bHQuc3RyaW5nVGFibGU7CiAgICAgICAgY29uc3QgcGFja2VkR2VvbWV0cnkgPSBjcmVhdGVHZW9tZXRyeVJlc3VsdC5wYWNrZWREYXRhOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheShwYWNrZWRHZW9tZXRyeVswXSk7CiAgICAgICAgbGV0IHJlc3VsdEluZGV4ID0gMDsKICAgICAgICBsZXQgcGFja2VkR2VvbWV0cnlJbmRleCA9IDE7CiAgICAgICAgd2hpbGUgKHBhY2tlZEdlb21ldHJ5SW5kZXggPCBwYWNrZWRHZW9tZXRyeS5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IHZhbGlkID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXSA9PT0gMTsKICAgICAgICAgIGlmICghdmFsaWQpIHsKICAgICAgICAgICAgcmVzdWx0W3Jlc3VsdEluZGV4KytdID0gdm9pZCAwOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHByaW1pdGl2ZVR5cGUgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgY29uc3QgZ2VvbWV0cnlUeXBlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgaWYgKG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEpIHsKICAgICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgbGV0IGJvdW5kaW5nU3BoZXJlOwogICAgICAgICAgbGV0IGJvdW5kaW5nU3BoZXJlQ1Y7CiAgICAgICAgICBjb25zdCB2YWxpZEJvdW5kaW5nU3BoZXJlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXSA9PT0gMTsKICAgICAgICAgIGlmICh2YWxpZEJvdW5kaW5nU3BoZXJlKSB7CiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgcGFja2VkR2VvbWV0cnksCiAgICAgICAgICAgICAgcGFja2VkR2VvbWV0cnlJbmRleAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgcGFja2VkR2VvbWV0cnlJbmRleCArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICAgIGNvbnN0IHZhbGlkQm91bmRpbmdTcGhlcmVDViA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK10gPT09IDE7CiAgICAgICAgICBpZiAodmFsaWRCb3VuZGluZ1NwaGVyZUNWKSB7CiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlQ1YgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICBwYWNrZWRHZW9tZXRyeSwKICAgICAgICAgICAgICBwYWNrZWRHZW9tZXRyeUluZGV4CiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBwYWNrZWRHZW9tZXRyeUluZGV4ICs9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgICAgbGV0IGxlbmd0aDsKICAgICAgICAgIGxldCB2YWx1ZXM7CiAgICAgICAgICBsZXQgY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICAgIGNvbnN0IG51bUF0dHJpYnV0ZXMgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bUF0dHJpYnV0ZXM7IGkrKykgewogICAgICAgICAgICBjb25zdCBuYW1lID0gc3RyaW5nVGFibGVbcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXV07CiAgICAgICAgICAgIGNvbnN0IGNvbXBvbmVudERhdGF0eXBlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbGl6ZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK10gIT09IDA7CiAgICAgICAgICAgIGxlbmd0aCA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICAgIHZhbHVlcyA9IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShjb21wb25lbnREYXRhdHlwZSwgbGVuZ3RoKTsKICAgICAgICAgICAgZm9yIChsZXQgdmFsdWVzSW5kZXggPSAwOyB2YWx1ZXNJbmRleCA8IGxlbmd0aDsgdmFsdWVzSW5kZXgrKykgewogICAgICAgICAgICAgIHZhbHVlc1t2YWx1ZXNJbmRleF0gPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGF0dHJpYnV0ZXNbbmFtZV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgICAgICBub3JtYWxpemUsCiAgICAgICAgICAgICAgdmFsdWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgbGV0IGluZGljZXM7CiAgICAgICAgICBsZW5ndGggPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IHZhbHVlcy5sZW5ndGggLyBjb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgICAgICAgICBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtYmVyT2ZWZXJ0aWNlcywgbGVuZ3RoKTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpXSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdFtyZXN1bHRJbmRleCsrXSA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgICAgcHJpbWl0aXZlVHlwZSwKICAgICAgICAgICAgZ2VvbWV0cnlUeXBlLAogICAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVDViwKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgICAgb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUucGFja0NvbWJpbmVHZW9tZXRyeVBhcmFtZXRlcnMgPSBmdW5jdGlvbihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICAgICAgY29uc3QgY3JlYXRlR2VvbWV0cnlSZXN1bHRzID0gcGFyYW1ldGVycy5jcmVhdGVHZW9tZXRyeVJlc3VsdHM7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY3JlYXRlR2VvbWV0cnlSZXN1bHRzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goY3JlYXRlR2VvbWV0cnlSZXN1bHRzW2ldLnBhY2tlZERhdGEuYnVmZmVyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5UmVzdWx0czogcGFyYW1ldGVycy5jcmVhdGVHZW9tZXRyeVJlc3VsdHMsCiAgICAgICAgICBwYWNrZWRJbnN0YW5jZXM6IHBhY2tJbnN0YW5jZXNGb3JDb21iaW5lKAogICAgICAgICAgICBwYXJhbWV0ZXJzLmluc3RhbmNlcywKICAgICAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cwogICAgICAgICAgKSwKICAgICAgICAgIGVsbGlwc29pZDogcGFyYW1ldGVycy5lbGxpcHNvaWQsCiAgICAgICAgICBpc0dlb2dyYXBoaWM6IHBhcmFtZXRlcnMucHJvamVjdGlvbiBpbnN0YW5jZW9mIEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQsCiAgICAgICAgICBlbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkOiBwYXJhbWV0ZXJzLmVsZW1lbnRJbmRleFVpbnRTdXBwb3J0ZWQsCiAgICAgICAgICBzY2VuZTNET25seTogcGFyYW1ldGVycy5zY2VuZTNET25seSwKICAgICAgICAgIHZlcnRleENhY2hlT3B0aW1pemU6IHBhcmFtZXRlcnMudmVydGV4Q2FjaGVPcHRpbWl6ZSwKICAgICAgICAgIGNvbXByZXNzVmVydGljZXM6IHBhcmFtZXRlcnMuY29tcHJlc3NWZXJ0aWNlcywKICAgICAgICAgIG1vZGVsTWF0cml4OiBwYXJhbWV0ZXJzLm1vZGVsTWF0cml4LAogICAgICAgICAgY3JlYXRlUGlja09mZnNldHM6IHBhcmFtZXRlcnMuY3JlYXRlUGlja09mZnNldHMKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS51bnBhY2tDb21iaW5lR2VvbWV0cnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFja2VkUGFyYW1ldGVycykgewogICAgICAgIGNvbnN0IGluc3RhbmNlcyA9IHVucGFja0luc3RhbmNlc0ZvckNvbWJpbmUocGFja2VkUGFyYW1ldGVycy5wYWNrZWRJbnN0YW5jZXMpOwogICAgICAgIGNvbnN0IGNyZWF0ZUdlb21ldHJ5UmVzdWx0cyA9IHBhY2tlZFBhcmFtZXRlcnMuY3JlYXRlR2VvbWV0cnlSZXN1bHRzOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNyZWF0ZUdlb21ldHJ5UmVzdWx0cy5sZW5ndGg7CiAgICAgICAgbGV0IGluc3RhbmNlSW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IHJlc3VsdEluZGV4ID0gMDsgcmVzdWx0SW5kZXggPCBsZW5ndGg7IHJlc3VsdEluZGV4KyspIHsKICAgICAgICAgIGNvbnN0IGdlb21ldHJpZXMgPSBQcmltaXRpdmVQaXBlbGluZS51bnBhY2tDcmVhdGVHZW9tZXRyeVJlc3VsdHMoCiAgICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5UmVzdWx0c1tyZXN1bHRJbmRleF0KICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBnZW9tZXRyaWVzTGVuZ3RoID0gZ2VvbWV0cmllcy5sZW5ndGg7CiAgICAgICAgICBmb3IgKGxldCBnZW9tZXRyeUluZGV4ID0gMDsgZ2VvbWV0cnlJbmRleCA8IGdlb21ldHJpZXNMZW5ndGg7IGdlb21ldHJ5SW5kZXgrKykgewogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IGdlb21ldHJpZXNbZ2VvbWV0cnlJbmRleF07CiAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2luc3RhbmNlSW5kZXhdOwogICAgICAgICAgICBpbnN0YW5jZS5nZW9tZXRyeSA9IGdlb21ldHJ5OwogICAgICAgICAgICArK2luc3RhbmNlSW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhY2tlZFBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBwcm9qZWN0aW9uID0gcGFja2VkUGFyYW1ldGVycy5pc0dlb2dyYXBoaWMgPyBuZXcgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdChlbGxpcHNvaWQpIDogbmV3IFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0KGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGluc3RhbmNlcywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICBlbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkOiBwYWNrZWRQYXJhbWV0ZXJzLmVsZW1lbnRJbmRleFVpbnRTdXBwb3J0ZWQsCiAgICAgICAgICBzY2VuZTNET25seTogcGFja2VkUGFyYW1ldGVycy5zY2VuZTNET25seSwKICAgICAgICAgIHZlcnRleENhY2hlT3B0aW1pemU6IHBhY2tlZFBhcmFtZXRlcnMudmVydGV4Q2FjaGVPcHRpbWl6ZSwKICAgICAgICAgIGNvbXByZXNzVmVydGljZXM6IHBhY2tlZFBhcmFtZXRlcnMuY29tcHJlc3NWZXJ0aWNlcywKICAgICAgICAgIG1vZGVsTWF0cml4OiBNYXRyaXg0X2RlZmF1bHQuY2xvbmUocGFja2VkUGFyYW1ldGVycy5tb2RlbE1hdHJpeCksCiAgICAgICAgICBjcmVhdGVQaWNrT2Zmc2V0czogcGFja2VkUGFyYW1ldGVycy5jcmVhdGVQaWNrT2Zmc2V0cwogICAgICAgIH07CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVBpcGVsaW5lLnBhY2tDb21iaW5lR2VvbWV0cnlSZXN1bHRzID0gZnVuY3Rpb24ocmVzdWx0cywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0cy5nZW9tZXRyaWVzKSkgewogICAgICAgICAgdHJhbnNmZXJHZW9tZXRyaWVzKHJlc3VsdHMuZ2VvbWV0cmllcywgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBhY2tlZEJvdW5kaW5nU3BoZXJlcyA9IHBhY2tCb3VuZGluZ1NwaGVyZXMocmVzdWx0cy5ib3VuZGluZ1NwaGVyZXMpOwogICAgICAgIGNvbnN0IHBhY2tlZEJvdW5kaW5nU3BoZXJlc0NWID0gcGFja0JvdW5kaW5nU3BoZXJlcygKICAgICAgICAgIHJlc3VsdHMuYm91bmRpbmdTcGhlcmVzQ1YKICAgICAgICApOwogICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgICAgIHBhY2tlZEJvdW5kaW5nU3BoZXJlcy5idWZmZXIsCiAgICAgICAgICBwYWNrZWRCb3VuZGluZ1NwaGVyZXNDVi5idWZmZXIKICAgICAgICApOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBnZW9tZXRyaWVzOiByZXN1bHRzLmdlb21ldHJpZXMsCiAgICAgICAgICBhdHRyaWJ1dGVMb2NhdGlvbnM6IHJlc3VsdHMuYXR0cmlidXRlTG9jYXRpb25zLAogICAgICAgICAgbW9kZWxNYXRyaXg6IHJlc3VsdHMubW9kZWxNYXRyaXgsCiAgICAgICAgICBwaWNrT2Zmc2V0czogcmVzdWx0cy5waWNrT2Zmc2V0cywKICAgICAgICAgIG9mZnNldEluc3RhbmNlRXh0ZW5kOiByZXN1bHRzLm9mZnNldEluc3RhbmNlRXh0ZW5kLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzOiBwYWNrZWRCb3VuZGluZ1NwaGVyZXMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVjogcGFja2VkQm91bmRpbmdTcGhlcmVzQ1YKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS51bnBhY2tDb21iaW5lR2VvbWV0cnlSZXN1bHRzID0gZnVuY3Rpb24ocGFja2VkUmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGdlb21ldHJpZXM6IHBhY2tlZFJlc3VsdC5nZW9tZXRyaWVzLAogICAgICAgICAgYXR0cmlidXRlTG9jYXRpb25zOiBwYWNrZWRSZXN1bHQuYXR0cmlidXRlTG9jYXRpb25zLAogICAgICAgICAgbW9kZWxNYXRyaXg6IHBhY2tlZFJlc3VsdC5tb2RlbE1hdHJpeCwKICAgICAgICAgIHBpY2tPZmZzZXRzOiBwYWNrZWRSZXN1bHQucGlja09mZnNldHMsCiAgICAgICAgICBvZmZzZXRJbnN0YW5jZUV4dGVuZDogcGFja2VkUmVzdWx0Lm9mZnNldEluc3RhbmNlRXh0ZW5kLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzOiB1bnBhY2tCb3VuZGluZ1NwaGVyZXMocGFja2VkUmVzdWx0LmJvdW5kaW5nU3BoZXJlcyksCiAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVjogdW5wYWNrQm91bmRpbmdTcGhlcmVzKHBhY2tlZFJlc3VsdC5ib3VuZGluZ1NwaGVyZXNDVikKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZV9kZWZhdWx0ID0gUHJpbWl0aXZlUGlwZWxpbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9mb3JtYXRFcnJvci5qcwogIGZ1bmN0aW9uIGZvcm1hdEVycm9yKG9iamVjdCkgewogICAgbGV0IHJlc3VsdDsKICAgIGNvbnN0IG5hbWUgPSBvYmplY3QubmFtZTsKICAgIGNvbnN0IG1lc3NhZ2UgPSBvYmplY3QubWVzc2FnZTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobmFtZSkgJiYgZGVmaW5lZF9kZWZhdWx0KG1lc3NhZ2UpKSB7CiAgICAgIHJlc3VsdCA9IGAke25hbWV9OiAke21lc3NhZ2V9YDsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IG9iamVjdC50b1N0cmluZygpOwogICAgfQogICAgY29uc3Qgc3RhY2sgPSBvYmplY3Quc3RhY2s7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0YWNrKSkgewogICAgICByZXN1bHQgKz0gYAoke3N0YWNrfWA7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgZm9ybWF0RXJyb3JfZGVmYXVsdDsKICB2YXIgaW5pdF9mb3JtYXRFcnJvciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZm9ybWF0RXJyb3IuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgZm9ybWF0RXJyb3JfZGVmYXVsdCA9IGZvcm1hdEVycm9yOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlci5qcwogIHZhciBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIod29ya2VyRnVuY3Rpb24pIHsKICAgIGFzeW5jIGZ1bmN0aW9uIG9uTWVzc2FnZUhhbmRsZXIoeyBkYXRhIH0pIHsKICAgICAgY29uc3QgdHJhbnNmZXJhYmxlT2JqZWN0cyA9IFtdOwogICAgICBjb25zdCByZXNwb25zZU1lc3NhZ2UgPSB7CiAgICAgICAgaWQ6IGRhdGEuaWQsCiAgICAgICAgcmVzdWx0OiB2b2lkIDAsCiAgICAgICAgZXJyb3I6IHZvaWQgMAogICAgICB9OwogICAgICBzZWxmLkNFU0lVTV9CQVNFX1VSTCA9IGRhdGEuYmFzZVVybDsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB3b3JrZXJGdW5jdGlvbihkYXRhLnBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgICAgIHJlc3BvbnNlTWVzc2FnZS5yZXN1bHQgPSByZXN1bHQ7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgIHJlc3BvbnNlTWVzc2FnZS5lcnJvciA9IHsKICAgICAgICAgICAgbmFtZTogZXJyb3IubmFtZSwKICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSwKICAgICAgICAgICAgc3RhY2s6IGVycm9yLnN0YWNrCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNwb25zZU1lc3NhZ2UuZXJyb3IgPSBlcnJvcjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFkYXRhLmNhblRyYW5zZmVyQXJyYXlCdWZmZXIpIHsKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLmxlbmd0aCA9IDA7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICBwb3N0TWVzc2FnZShyZXNwb25zZU1lc3NhZ2UsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIHJlc3BvbnNlTWVzc2FnZS5yZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgcmVzcG9uc2VNZXNzYWdlLmVycm9yID0gYHBvc3RNZXNzYWdlIGZhaWxlZCB3aXRoIGVycm9yOiAke2Zvcm1hdEVycm9yX2RlZmF1bHQoCiAgICAgICAgICBlcnJvcgogICAgICAgICl9CiAgd2l0aCByZXNwb25zZU1lc3NhZ2U6ICR7SlNPTi5zdHJpbmdpZnkocmVzcG9uc2VNZXNzYWdlKX1gOwogICAgICAgIHBvc3RNZXNzYWdlKHJlc3BvbnNlTWVzc2FnZSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG9uTWVzc2FnZUVycm9ySGFuZGxlcihldmVudCkgewogICAgICBwb3N0TWVzc2FnZSh7CiAgICAgICAgaWQ6IGV2ZW50LmRhdGE/LmlkLAogICAgICAgIGVycm9yOiBgcG9zdE1lc3NhZ2UgZmFpbGVkIHdpdGggZXJyb3I6ICR7SlNPTi5zdHJpbmdpZnkoZXZlbnQpfWAKICAgICAgfSk7CiAgICB9CiAgICBzZWxmLm9ubWVzc2FnZSA9IG9uTWVzc2FnZUhhbmRsZXI7CiAgICBzZWxmLm9ubWVzc2FnZWVycm9yID0gb25NZXNzYWdlRXJyb3JIYW5kbGVyOwogICAgcmV0dXJuIHNlbGY7CiAgfQogIHZhciBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlci5qcyIoKSB7CiAgICAgIGluaXRfZm9ybWF0RXJyb3IoKTsKICAgICAgY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NvbWJpbmVHZW9tZXRyeS5qcwogIHZhciBjb21iaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNvbWJpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjb21iaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNvbWJpbmVHZW9tZXRyeShwYWNrZWRQYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBwYXJhbWV0ZXJzID0gUHJpbWl0aXZlUGlwZWxpbmVfZGVmYXVsdC51bnBhY2tDb21iaW5lR2VvbWV0cnlQYXJhbWV0ZXJzKHBhY2tlZFBhcmFtZXRlcnMpOwogICAgY29uc3QgcmVzdWx0cyA9IFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUdlb21ldHJ5KHBhcmFtZXRlcnMpOwogICAgcmV0dXJuIFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQucGFja0NvbWJpbmVHZW9tZXRyeVJlc3VsdHMoCiAgICAgIHJlc3VsdHMsCiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMKICAgICk7CiAgfQogIHZhciBjb21iaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jb21iaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NvbWJpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfUHJpbWl0aXZlUGlwZWxpbmUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGNvbWJpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGNvbWJpbmVHZW9tZXRyeSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5qcwogIHZhciBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSwgR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUuanMiKCkgewogICAgICBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSA9IHsKICAgICAgICBOT05FOiAwLAogICAgICAgIFRPUDogMSwKICAgICAgICBBTEw6IDIKICAgICAgfTsKICAgICAgR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVmVydGV4Rm9ybWF0LmpzCiAgZnVuY3Rpb24gVmVydGV4Rm9ybWF0KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5wb3NpdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucG9zaXRpb24sIGZhbHNlKTsKICAgIHRoaXMubm9ybWFsID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5ub3JtYWwsIGZhbHNlKTsKICAgIHRoaXMuc3QgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0LCBmYWxzZSk7CiAgICB0aGlzLmJpdGFuZ2VudCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuYml0YW5nZW50LCBmYWxzZSk7CiAgICB0aGlzLnRhbmdlbnQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnRhbmdlbnQsIGZhbHNlKTsKICAgIHRoaXMuY29sb3IgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvbG9yLCBmYWxzZSk7CiAgfQogIHZhciBWZXJ0ZXhGb3JtYXRfZGVmYXVsdDsKICB2YXIgaW5pdF9WZXJ0ZXhGb3JtYXQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1ZlcnRleEZvcm1hdC5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIFZlcnRleEZvcm1hdC5QT1NJVElPTl9PTkxZID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgVmVydGV4Rm9ybWF0KHsKICAgICAgICAgIHBvc2l0aW9uOiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LlBPU0lUSU9OX0FORF9OT1JNQUwgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBub3JtYWw6IHRydWUKICAgICAgICB9KQogICAgICApOwogICAgICBWZXJ0ZXhGb3JtYXQuUE9TSVRJT05fTk9STUFMX0FORF9TVCA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICAgIG5vcm1hbDogdHJ1ZSwKICAgICAgICAgIHN0OiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LlBPU0lUSU9OX0FORF9TVCA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICAgIHN0OiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LlBPU0lUSU9OX0FORF9DT0xPUiA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICAgIGNvbG9yOiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LkFMTCA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICAgIG5vcm1hbDogdHJ1ZSwKICAgICAgICAgIHN0OiB0cnVlLAogICAgICAgICAgdGFuZ2VudDogdHJ1ZSwKICAgICAgICAgIGJpdGFuZ2VudDogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5ERUZBVUxUID0gVmVydGV4Rm9ybWF0LlBPU0lUSU9OX05PUk1BTF9BTkRfU1Q7CiAgICAgIFZlcnRleEZvcm1hdC5wYWNrZWRMZW5ndGggPSA2OwogICAgICBWZXJ0ZXhGb3JtYXQucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUucG9zaXRpb24gPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUubm9ybWFsID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnN0ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnRhbmdlbnQgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuYml0YW5nZW50ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5jb2xvciA/IDEgOiAwOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgVmVydGV4Rm9ybWF0LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFZlcnRleEZvcm1hdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucG9zaXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC5ub3JtYWwgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC5zdCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgcmVzdWx0LnRhbmdlbnQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC5iaXRhbmdlbnQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC5jb2xvciA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdID09PSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFZlcnRleEZvcm1hdC5jbG9uZSA9IGZ1bmN0aW9uKHZlcnRleEZvcm1hdCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFZlcnRleEZvcm1hdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucG9zaXRpb24gPSB2ZXJ0ZXhGb3JtYXQucG9zaXRpb247CiAgICAgICAgcmVzdWx0Lm5vcm1hbCA9IHZlcnRleEZvcm1hdC5ub3JtYWw7CiAgICAgICAgcmVzdWx0LnN0ID0gdmVydGV4Rm9ybWF0LnN0OwogICAgICAgIHJlc3VsdC50YW5nZW50ID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQ7CiAgICAgICAgcmVzdWx0LmJpdGFuZ2VudCA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQ7CiAgICAgICAgcmVzdWx0LmNvbG9yID0gdmVydGV4Rm9ybWF0LmNvbG9yOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0ID0gVmVydGV4Rm9ybWF0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQm94R2VvbWV0cnkuanMKICBmdW5jdGlvbiBCb3hHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IG1pbjMgPSBvcHRpb25zLm1pbmltdW07CiAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtaW4iLCBtaW4zKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF4IiwgbWF4Myk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSAmJiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLlRPUCBpcyBub3QgYSBzdXBwb3J0ZWQgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgZm9yIHRoaXMgZ2VvbWV0cnkuIgogICAgICApOwogICAgfQogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgdGhpcy5fbWluaW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW4zKTsKICAgIHRoaXMuX21heGltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobWF4Myk7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSB2ZXJ0ZXhGb3JtYXQ7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQm94R2VvbWV0cnkiOwogIH0KICB2YXIgZGlmZlNjcmF0Y2gsIHNjcmF0Y2hNaW4sIHNjcmF0Y2hNYXgsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQsIHNjcmF0Y2hPcHRpb25zLCB1bml0Qm94R2VvbWV0cnksIEJveEdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQm94R2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JveEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBkaWZmU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm94R2VvbWV0cnkuZnJvbURpbWVuc2lvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgZGltZW5zaW9ucyA9IG9wdGlvbnMuZGltZW5zaW9uczsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpbWVuc2lvbnMiLCBkaW1lbnNpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy54IiwgZGltZW5zaW9ucy54LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy55IiwgZGltZW5zaW9ucy55LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy56IiwgZGltZW5zaW9ucy56LCAwKTsKICAgICAgICBjb25zdCBjb3JuZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaW1lbnNpb25zLCAwLjUsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSk7CiAgICAgICAgcmV0dXJuIG5ldyBCb3hHZW9tZXRyeSh7CiAgICAgICAgICBtaW5pbXVtOiBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGNvcm5lciwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpKSwKICAgICAgICAgIG1heGltdW06IGNvcm5lciwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LmZyb21BeGlzQWxpZ25lZEJvdW5kaW5nQm94ID0gZnVuY3Rpb24oYm91bmRpbmdCb3gpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImJvdW5kaW5nQm94IiwgYm91bmRpbmdCb3gpOwogICAgICAgIHJldHVybiBuZXcgQm94R2VvbWV0cnkoewogICAgICAgICAgbWluaW11bTogYm91bmRpbmdCb3gubWluaW11bSwKICAgICAgICAgIG1heGltdW06IGJvdW5kaW5nQm94Lm1heGltdW0KICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQm94R2VvbWV0cnkucGFja2VkTGVuZ3RoID0gMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxOwogICAgICBCb3hHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fbWluaW11bSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgICAgdmFsdWUuX21heGltdW0sCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoCiAgICAgICAgKTsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKAogICAgICAgICAgdmFsdWUuX3ZlcnRleEZvcm1hdCwKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCArIDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoCiAgICAgICAgKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4ICsgMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaE1pbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdCA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9ucyA9IHsKICAgICAgICBtaW5pbXVtOiBzY3JhdGNoTWluLAogICAgICAgIG1heGltdW06IHNjcmF0Y2hNYXgsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0LAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBtaW4zID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaE1pbik7CiAgICAgICAgY29uc3QgbWF4MyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoLAogICAgICAgICAgc2NyYXRjaE1heAogICAgICAgICk7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4ICsgMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4ICsgMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IEJveEdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1pbjMsIHJlc3VsdC5fbWluaW11bSk7CiAgICAgICAgcmVzdWx0Ll9tYXhpbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1heDMsIHJlc3VsdC5fbWF4aW11bSk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm94R2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihib3hHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IG1pbjMgPSBib3hHZW9tZXRyeS5fbWluaW11bTsKICAgICAgICBjb25zdCBtYXgzID0gYm94R2VvbWV0cnkuX21heGltdW07CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gYm94R2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhtaW4zLCBtYXgzKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgbGV0IGluZGljZXM7CiAgICAgICAgbGV0IHBvc2l0aW9uczsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uICYmICh2ZXJ0ZXhGb3JtYXQuc3QgfHwgdmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSkgewogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgICBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDYgKiA0ICogMyk7CiAgICAgICAgICAgIHBvc2l0aW9uc1swXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzFdID0gbWluMy55OwogICAgICAgICAgICBwb3NpdGlvbnNbMl0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzRdID0gbWluMy55OwogICAgICAgICAgICBwb3NpdGlvbnNbNV0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzddID0gbWF4My55OwogICAgICAgICAgICBwb3NpdGlvbnNbOF0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s5XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzEwXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzExXSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzEyXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzEzXSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzE0XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzE1XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzE2XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzE3XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzE4XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzE5XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzIwXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzIxXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzIyXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzIzXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzI0XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzI1XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzI2XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzI3XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzI4XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzI5XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzMwXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzMxXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzMyXSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzMzXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzM0XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzM1XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzM2XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzM3XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzM4XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzM5XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzQwXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzQxXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzQyXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzQzXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzQ0XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzQ1XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzQ2XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzQ3XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzQ4XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzQ5XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzUwXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzUxXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzUyXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzUzXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzU0XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzU1XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzU2XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzU3XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzU4XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzU5XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzYwXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzYxXSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzYyXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzYzXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzY0XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzY1XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzY2XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzY3XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzY4XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzY5XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzcwXSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzcxXSA9IG1heDMuejsKICAgICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KDYgKiA0ICogMyk7CiAgICAgICAgICAgIG5vcm1hbHNbMF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzFdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbM10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzRdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s1XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzddID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s4XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbOV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzEwXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTFdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1sxMl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzEzXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTRdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbMTVdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxNl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzE3XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzE4XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTldID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syMF0gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1syMV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzIyXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMjNdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbMjRdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1syNV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzI2XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMjddID0gMTsKICAgICAgICAgICAgbm9ybWFsc1syOF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzI5XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMzBdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1szMV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzMyXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMzNdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1szNF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzM1XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMzZdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbMzddID0gMDsKICAgICAgICAgICAgbm9ybWFsc1szOF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzM5XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzQwXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDFdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0Ml0gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1s0M10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQ0XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDVdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNDZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0N10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQ4XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDldID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s1MF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzUxXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNTJdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s1M10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzU0XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNTVdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s1Nl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzU3XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNThdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s1OV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzYwXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNjFdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNjJdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2M10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzY0XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzY1XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNjZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2N10gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1s2OF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzY5XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNzBdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNzFdID0gMDsKICAgICAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICAgIGNvbnN0IHRleENvb3JkcyA9IG5ldyBGbG9hdDMyQXJyYXkoNiAqIDQgKiAyKTsKICAgICAgICAgICAgdGV4Q29vcmRzWzBdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzFdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzJdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzNdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzRdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzVdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzZdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzddID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzhdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzldID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzEwXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxMV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMTJdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzEzXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1sxNF0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMTVdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzE2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxN10gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMThdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzE5XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syMF0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMjFdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzIyXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syM10gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMjRdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzI1XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syNl0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjddID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzI4XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syOV0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzBdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzMxXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szMl0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzNdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzM0XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1szNV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMzZdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzM3XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szOF0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzldID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzQwXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0MV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbNDJdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzQzXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0NF0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbNDVdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzQ2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0N10gPSAxOwogICAgICAgICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgICAgdmFsdWVzOiB0ZXhDb29yZHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgY29uc3QgdGFuZ2VudHMgPSBuZXcgRmxvYXQzMkFycmF5KDYgKiA0ICogMyk7CiAgICAgICAgICAgIHRhbmdlbnRzWzBdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbMV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzNdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzZdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbN10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s4XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzldID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbMTBdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMTFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMTJdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzEzXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzE0XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzE1XSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1sxNl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1sxN10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1sxOF0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbMTldID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMjBdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMjFdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzIyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzIzXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzI0XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzI1XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzI2XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzI3XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzI4XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzI5XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzMwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzMxXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzMyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzMzXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzM0XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzM1XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzM2XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzM3XSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1szOF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szOV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s0MF0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNDFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNDJdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNDNdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzQ0XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzQ1XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzQ2XSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1s0N10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s0OF0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNDldID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTBdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTFdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzUyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzUzXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzU0XSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1s1NV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1Nl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1N10gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNThdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTldID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjBdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNjFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjJdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjNdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNjRdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjVdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjZdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNjddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjhdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjldID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNzBdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNzFdID0gMDsKICAgICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGNvbnN0IGJpdGFuZ2VudHMgPSBuZXcgRmxvYXQzMkFycmF5KDYgKiA0ICogMyk7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzFdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1syXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbM10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzRdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzddID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s4XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbOV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzEwXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTFdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxMl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzEzXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTRdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxNV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzE2XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTddID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxOF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzE5XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjBdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syMV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzIyXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjNdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syNF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzI1XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjZdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1syN10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzI4XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjldID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1szMF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzMxXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzJdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1szM10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzM0XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzVdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1szNl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzM3XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzhdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1szOV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQwXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDFdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s0Ml0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQzXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDRdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s0NV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQ2XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDddID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s0OF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQ5XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTBdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1MV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzUyXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTNdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1NF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzU1XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTZdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1N10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzU4XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTldID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s2MF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzYxXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjJdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s2M10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzY0XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjVdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s2Nl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzY3XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjhdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s2OV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzcwXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNzFdID0gMTsKICAgICAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDYgKiAyICogMyk7CiAgICAgICAgICBpbmRpY2VzWzBdID0gMDsKICAgICAgICAgIGluZGljZXNbMV0gPSAxOwogICAgICAgICAgaW5kaWNlc1syXSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgICAgIGluZGljZXNbNF0gPSAyOwogICAgICAgICAgaW5kaWNlc1s1XSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzZdID0gNCArIDI7CiAgICAgICAgICBpbmRpY2VzWzddID0gNCArIDE7CiAgICAgICAgICBpbmRpY2VzWzhdID0gNCArIDA7CiAgICAgICAgICBpbmRpY2VzWzldID0gNCArIDM7CiAgICAgICAgICBpbmRpY2VzWzEwXSA9IDQgKyAyOwogICAgICAgICAgaW5kaWNlc1sxMV0gPSA0ICsgMDsKICAgICAgICAgIGluZGljZXNbMTJdID0gOCArIDA7CiAgICAgICAgICBpbmRpY2VzWzEzXSA9IDggKyAxOwogICAgICAgICAgaW5kaWNlc1sxNF0gPSA4ICsgMjsKICAgICAgICAgIGluZGljZXNbMTVdID0gOCArIDA7CiAgICAgICAgICBpbmRpY2VzWzE2XSA9IDggKyAyOwogICAgICAgICAgaW5kaWNlc1sxN10gPSA4ICsgMzsKICAgICAgICAgIGluZGljZXNbMThdID0gMTIgKyAyOwogICAgICAgICAgaW5kaWNlc1sxOV0gPSAxMiArIDE7CiAgICAgICAgICBpbmRpY2VzWzIwXSA9IDEyICsgMDsKICAgICAgICAgIGluZGljZXNbMjFdID0gMTIgKyAzOwogICAgICAgICAgaW5kaWNlc1syMl0gPSAxMiArIDI7CiAgICAgICAgICBpbmRpY2VzWzIzXSA9IDEyICsgMDsKICAgICAgICAgIGluZGljZXNbMjRdID0gMTYgKyAyOwogICAgICAgICAgaW5kaWNlc1syNV0gPSAxNiArIDE7CiAgICAgICAgICBpbmRpY2VzWzI2XSA9IDE2ICsgMDsKICAgICAgICAgIGluZGljZXNbMjddID0gMTYgKyAzOwogICAgICAgICAgaW5kaWNlc1syOF0gPSAxNiArIDI7CiAgICAgICAgICBpbmRpY2VzWzI5XSA9IDE2ICsgMDsKICAgICAgICAgIGluZGljZXNbMzBdID0gMjAgKyAwOwogICAgICAgICAgaW5kaWNlc1szMV0gPSAyMCArIDE7CiAgICAgICAgICBpbmRpY2VzWzMyXSA9IDIwICsgMjsKICAgICAgICAgIGluZGljZXNbMzNdID0gMjAgKyAwOwogICAgICAgICAgaW5kaWNlc1szNF0gPSAyMCArIDI7CiAgICAgICAgICBpbmRpY2VzWzM1XSA9IDIwICsgMzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSg4ICogMyk7CiAgICAgICAgICBwb3NpdGlvbnNbMF0gPSBtaW4zLng7CiAgICAgICAgICBwb3NpdGlvbnNbMV0gPSBtaW4zLnk7CiAgICAgICAgICBwb3NpdGlvbnNbMl0gPSBtaW4zLno7CiAgICAgICAgICBwb3NpdGlvbnNbM10gPSBtYXgzLng7CiAgICAgICAgICBwb3NpdGlvbnNbNF0gPSBtaW4zLnk7CiAgICAgICAgICBwb3NpdGlvbnNbNV0gPSBtaW4zLno7CiAgICAgICAgICBwb3NpdGlvbnNbNl0gPSBtYXgzLng7CiAgICAgICAgICBwb3NpdGlvbnNbN10gPSBtYXgzLnk7CiAgICAgICAgICBwb3NpdGlvbnNbOF0gPSBtaW4zLno7CiAgICAgICAgICBwb3NpdGlvbnNbOV0gPSBtaW4zLng7CiAgICAgICAgICBwb3NpdGlvbnNbMTBdID0gbWF4My55OwogICAgICAgICAgcG9zaXRpb25zWzExXSA9IG1pbjMuejsKICAgICAgICAgIHBvc2l0aW9uc1sxMl0gPSBtaW4zLng7CiAgICAgICAgICBwb3NpdGlvbnNbMTNdID0gbWluMy55OwogICAgICAgICAgcG9zaXRpb25zWzE0XSA9IG1heDMuejsKICAgICAgICAgIHBvc2l0aW9uc1sxNV0gPSBtYXgzLng7CiAgICAgICAgICBwb3NpdGlvbnNbMTZdID0gbWluMy55OwogICAgICAgICAgcG9zaXRpb25zWzE3XSA9IG1heDMuejsKICAgICAgICAgIHBvc2l0aW9uc1sxOF0gPSBtYXgzLng7CiAgICAgICAgICBwb3NpdGlvbnNbMTldID0gbWF4My55OwogICAgICAgICAgcG9zaXRpb25zWzIwXSA9IG1heDMuejsKICAgICAgICAgIHBvc2l0aW9uc1syMV0gPSBtaW4zLng7CiAgICAgICAgICBwb3NpdGlvbnNbMjJdID0gbWF4My55OwogICAgICAgICAgcG9zaXRpb25zWzIzXSA9IG1heDMuejsKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pOwogICAgICAgICAgaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSg2ICogMiAqIDMpOwogICAgICAgICAgaW5kaWNlc1swXSA9IDQ7CiAgICAgICAgICBpbmRpY2VzWzFdID0gNTsKICAgICAgICAgIGluZGljZXNbMl0gPSA2OwogICAgICAgICAgaW5kaWNlc1szXSA9IDQ7CiAgICAgICAgICBpbmRpY2VzWzRdID0gNjsKICAgICAgICAgIGluZGljZXNbNV0gPSA3OwogICAgICAgICAgaW5kaWNlc1s2XSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzddID0gMDsKICAgICAgICAgIGluZGljZXNbOF0gPSAzOwogICAgICAgICAgaW5kaWNlc1s5XSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzEwXSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzExXSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzEyXSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzEzXSA9IDY7CiAgICAgICAgICBpbmRpY2VzWzE0XSA9IDU7CiAgICAgICAgICBpbmRpY2VzWzE1XSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzE2XSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzE3XSA9IDY7CiAgICAgICAgICBpbmRpY2VzWzE4XSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzE5XSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzIwXSA9IDc7CiAgICAgICAgICBpbmRpY2VzWzIxXSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzIyXSA9IDc7CiAgICAgICAgICBpbmRpY2VzWzIzXSA9IDY7CiAgICAgICAgICBpbmRpY2VzWzI0XSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzI1XSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzI2XSA9IDQ7CiAgICAgICAgICBpbmRpY2VzWzI3XSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzI4XSA9IDQ7CiAgICAgICAgICBpbmRpY2VzWzI5XSA9IDc7CiAgICAgICAgICBpbmRpY2VzWzMwXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzMxXSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzMyXSA9IDU7CiAgICAgICAgICBpbmRpY2VzWzMzXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzM0XSA9IDU7CiAgICAgICAgICBpbmRpY2VzWzM1XSA9IDQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRpZmYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobWF4MywgbWluMywgZGlmZlNjcmF0Y2gpOwogICAgICAgIGNvbnN0IHJhZGl1cyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoZGlmZikgKiAwLjU7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChib3hHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gYm94R2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJhZGl1cyksCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQm94R2VvbWV0cnkuZ2V0VW5pdEJveCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHVuaXRCb3hHZW9tZXRyeSkpIHsKICAgICAgICAgIHVuaXRCb3hHZW9tZXRyeSA9IEJveEdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5KAogICAgICAgICAgICBCb3hHZW9tZXRyeS5mcm9tRGltZW5zaW9ucyh7CiAgICAgICAgICAgICAgZGltZW5zaW9uczogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKSwKICAgICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFkKICAgICAgICAgICAgfSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bml0Qm94R2VvbWV0cnk7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5X2RlZmF1bHQgPSBCb3hHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUJveEdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUJveEdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVCb3hHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVCb3hHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQm94R2VvbWV0cnkoYm94R2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGJveEdlb21ldHJ5ID0gQm94R2VvbWV0cnlfZGVmYXVsdC51bnBhY2soYm94R2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gQm94R2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShib3hHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVCb3hHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUJveEdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVCb3hHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm94R2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNyZWF0ZUJveEdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVCb3hHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JveE91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEJveE91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IG1pbjMgPSBvcHRpb25zLm1pbmltdW07CiAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtaW4iLCBtaW4zKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF4IiwgbWF4Myk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSAmJiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLlRPUCBpcyBub3QgYSBzdXBwb3J0ZWQgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgZm9yIHRoaXMgZ2VvbWV0cnkuIgogICAgICApOwogICAgfQogICAgdGhpcy5fbWluID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1pbjMpOwogICAgdGhpcy5fbWF4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1heDMpOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBkaWZmU2NyYXRjaDIsIHNjcmF0Y2hNaW4yLCBzY3JhdGNoTWF4Miwgc2NyYXRjaE9wdGlvbnMyLCBCb3hPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Cb3hPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JveE91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgZGlmZlNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkuZnJvbURpbWVuc2lvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgZGltZW5zaW9ucyA9IG9wdGlvbnMuZGltZW5zaW9uczsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpbWVuc2lvbnMiLCBkaW1lbnNpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy54IiwgZGltZW5zaW9ucy54LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy55IiwgZGltZW5zaW9ucy55LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy56IiwgZGltZW5zaW9ucy56LCAwKTsKICAgICAgICBjb25zdCBjb3JuZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaW1lbnNpb25zLCAwLjUsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSk7CiAgICAgICAgcmV0dXJuIG5ldyBCb3hPdXRsaW5lR2VvbWV0cnkoewogICAgICAgICAgbWluaW11bTogQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjb3JuZXIsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSksCiAgICAgICAgICBtYXhpbXVtOiBjb3JuZXIsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveE91dGxpbmVHZW9tZXRyeS5mcm9tQXhpc0FsaWduZWRCb3VuZGluZ0JveCA9IGZ1bmN0aW9uKGJvdW5kaW5nQm94KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJib3VuZGluZEJveCIsIGJvdW5kaW5nQm94KTsKICAgICAgICByZXR1cm4gbmV3IEJveE91dGxpbmVHZW9tZXRyeSh7CiAgICAgICAgICBtaW5pbXVtOiBib3VuZGluZ0JveC5taW5pbXVtLAogICAgICAgICAgbWF4aW11bTogYm91bmRpbmdCb3gubWF4aW11bQogICAgICAgIH0pOwogICAgICB9OwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxOwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX21pbiwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9tYXgsIGFycmF5LCBzdGFydGluZ0luZGV4ICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKiAyXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgdmFsdWUuX29mZnNldEF0dHJpYnV0ZSwKICAgICAgICAgIC0xCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hNaW4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWF4MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMyID0gewogICAgICAgIG1pbmltdW06IHNjcmF0Y2hNaW4yLAogICAgICAgIG1heGltdW06IHNjcmF0Y2hNYXgyLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEJveE91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgbWluMyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hNaW4yKTsKICAgICAgICBjb25zdCBtYXgzID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgsCiAgICAgICAgICBzY3JhdGNoTWF4MgogICAgICAgICk7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKiAyXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgQm94T3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fbWluID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1pbjMsIHJlc3VsdC5fbWluKTsKICAgICAgICByZXN1bHQuX21heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtYXgzLCByZXN1bHQuX21heCk7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJveE91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGJveEdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgbWluMyA9IGJveEdlb21ldHJ5Ll9taW47CiAgICAgICAgY29uc3QgbWF4MyA9IGJveEdlb21ldHJ5Ll9tYXg7CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobWluMywgbWF4MykpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoMTIgKiAyKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDggKiAzKTsKICAgICAgICBwb3NpdGlvbnNbMF0gPSBtaW4zLng7CiAgICAgICAgcG9zaXRpb25zWzFdID0gbWluMy55OwogICAgICAgIHBvc2l0aW9uc1syXSA9IG1pbjMuejsKICAgICAgICBwb3NpdGlvbnNbM10gPSBtYXgzLng7CiAgICAgICAgcG9zaXRpb25zWzRdID0gbWluMy55OwogICAgICAgIHBvc2l0aW9uc1s1XSA9IG1pbjMuejsKICAgICAgICBwb3NpdGlvbnNbNl0gPSBtYXgzLng7CiAgICAgICAgcG9zaXRpb25zWzddID0gbWF4My55OwogICAgICAgIHBvc2l0aW9uc1s4XSA9IG1pbjMuejsKICAgICAgICBwb3NpdGlvbnNbOV0gPSBtaW4zLng7CiAgICAgICAgcG9zaXRpb25zWzEwXSA9IG1heDMueTsKICAgICAgICBwb3NpdGlvbnNbMTFdID0gbWluMy56OwogICAgICAgIHBvc2l0aW9uc1sxMl0gPSBtaW4zLng7CiAgICAgICAgcG9zaXRpb25zWzEzXSA9IG1pbjMueTsKICAgICAgICBwb3NpdGlvbnNbMTRdID0gbWF4My56OwogICAgICAgIHBvc2l0aW9uc1sxNV0gPSBtYXgzLng7CiAgICAgICAgcG9zaXRpb25zWzE2XSA9IG1pbjMueTsKICAgICAgICBwb3NpdGlvbnNbMTddID0gbWF4My56OwogICAgICAgIHBvc2l0aW9uc1sxOF0gPSBtYXgzLng7CiAgICAgICAgcG9zaXRpb25zWzE5XSA9IG1heDMueTsKICAgICAgICBwb3NpdGlvbnNbMjBdID0gbWF4My56OwogICAgICAgIHBvc2l0aW9uc1syMV0gPSBtaW4zLng7CiAgICAgICAgcG9zaXRpb25zWzIyXSA9IG1heDMueTsKICAgICAgICBwb3NpdGlvbnNbMjNdID0gbWF4My56OwogICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICB9KTsKICAgICAgICBpbmRpY2VzWzBdID0gNDsKICAgICAgICBpbmRpY2VzWzFdID0gNTsKICAgICAgICBpbmRpY2VzWzJdID0gNTsKICAgICAgICBpbmRpY2VzWzNdID0gNjsKICAgICAgICBpbmRpY2VzWzRdID0gNjsKICAgICAgICBpbmRpY2VzWzVdID0gNzsKICAgICAgICBpbmRpY2VzWzZdID0gNzsKICAgICAgICBpbmRpY2VzWzddID0gNDsKICAgICAgICBpbmRpY2VzWzhdID0gMDsKICAgICAgICBpbmRpY2VzWzldID0gMTsKICAgICAgICBpbmRpY2VzWzEwXSA9IDE7CiAgICAgICAgaW5kaWNlc1sxMV0gPSAyOwogICAgICAgIGluZGljZXNbMTJdID0gMjsKICAgICAgICBpbmRpY2VzWzEzXSA9IDM7CiAgICAgICAgaW5kaWNlc1sxNF0gPSAzOwogICAgICAgIGluZGljZXNbMTVdID0gMDsKICAgICAgICBpbmRpY2VzWzE2XSA9IDA7CiAgICAgICAgaW5kaWNlc1sxN10gPSA0OwogICAgICAgIGluZGljZXNbMThdID0gMTsKICAgICAgICBpbmRpY2VzWzE5XSA9IDU7CiAgICAgICAgaW5kaWNlc1syMF0gPSAyOwogICAgICAgIGluZGljZXNbMjFdID0gNjsKICAgICAgICBpbmRpY2VzWzIyXSA9IDM7CiAgICAgICAgaW5kaWNlc1syM10gPSA3OwogICAgICAgIGNvbnN0IGRpZmYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobWF4MywgbWluMywgZGlmZlNjcmF0Y2gyKTsKICAgICAgICBjb25zdCByYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGRpZmYpICogMC41OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYm94R2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJhZGl1cyksCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQm94T3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBCb3hPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkoYm94R2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGJveEdlb21ldHJ5ID0gQm94T3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGJveEdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIEJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGJveEdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUJveE91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3hPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzZUdlb21ldHJ5TGlicmFyeS5qcwogIGZ1bmN0aW9uIHBvaW50T25FbGxpcHNvaWQodGhldGEsIHJvdGF0aW9uLCBub3J0aFZlYywgZWFzdFZlYywgYVNxciwgYWIsIGJTcXIsIG1hZywgdW5pdFBvcywgcmVzdWx0KSB7CiAgICBjb25zdCBhemltdXRoID0gdGhldGEgKyByb3RhdGlvbjsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGVhc3RWZWMsIE1hdGguY29zKGF6aW11dGgpLCByb3RBeGlzKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcnRoVmVjLCBNYXRoLnNpbihhemltdXRoKSwgdGVtcFZlYyk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJvdEF4aXMsIHRlbXBWZWMsIHJvdEF4aXMpOwogICAgbGV0IGNvc1RoZXRhU3F1YXJlZCA9IE1hdGguY29zKHRoZXRhKTsKICAgIGNvc1RoZXRhU3F1YXJlZCA9IGNvc1RoZXRhU3F1YXJlZCAqIGNvc1RoZXRhU3F1YXJlZDsKICAgIGxldCBzaW5UaGV0YVNxdWFyZWQgPSBNYXRoLnNpbih0aGV0YSk7CiAgICBzaW5UaGV0YVNxdWFyZWQgPSBzaW5UaGV0YVNxdWFyZWQgKiBzaW5UaGV0YVNxdWFyZWQ7CiAgICBjb25zdCByYWRpdXMgPSBhYiAvIE1hdGguc3FydChiU3FyICogY29zVGhldGFTcXVhcmVkICsgYVNxciAqIHNpblRoZXRhU3F1YXJlZCk7CiAgICBjb25zdCBhbmdsZSA9IHJhZGl1cyAvIG1hZzsKICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKHJvdEF4aXMsIGFuZ2xlLCB1bml0UXVhdCk7CiAgICBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24odW5pdFF1YXQsIHJvdE10eCk7CiAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcihyb3RNdHgsIHVuaXRQb3MsIHJlc3VsdCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJlc3VsdCwgbWFnLCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnksIHJvdEF4aXMsIHRlbXBWZWMsIHVuaXRRdWF0LCByb3RNdHgsIHNjcmF0Y2hDYXJ0ZXNpYW4xMiwgc2NyYXRjaENhcnRlc2lhbjIzLCBzY3JhdGNoQ2FydGVzaWFuMzQsIHNjcmF0Y2hOb3JtYWwyLCB1bml0UG9zU2NyYXRjaCwgZWFzdFZlY1NjcmF0Y2gsIG5vcnRoVmVjU2NyYXRjaCwgRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc2VHZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc2VHZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgRWxsaXBzZUdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICByb3RBeGlzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0ZW1wVmVjID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1bml0UXVhdCA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgcm90TXR4ID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzZUdlb21ldHJ5TGlicmFyeS5yYWlzZVBvc2l0aW9uc1RvSGVpZ2h0ID0gZnVuY3Rpb24ocG9zaXRpb25zLCBvcHRpb25zLCBleHRydWRlKSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IHNpemUgPSBleHRydWRlID8gcG9zaXRpb25zLmxlbmd0aCAvIDMgKiAyIDogcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgZmluYWxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGJvdHRvbU9mZnNldCA9IGV4dHJ1ZGUgPyBsZW5ndGggOiAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGkxID0gaSArIDE7CiAgICAgICAgICBjb25zdCBpMiA9IGkgKyAyOwogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgc2NyYXRjaENhcnRlc2lhbjEyKTsKICAgICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uLCBwb3NpdGlvbik7CiAgICAgICAgICBjb25zdCBleHRydWRlZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY3JhdGNoQ2FydGVzaWFuMjMpOwogICAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIHNjcmF0Y2hOb3JtYWwyKTsKICAgICAgICAgIGNvbnN0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNAogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIHNjYWxlZE5vcm1hbCwgcG9zaXRpb24pOwogICAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobm9ybWFsMiwgZXh0cnVkZWRIZWlnaHQsIHNjYWxlZE5vcm1hbCk7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZXh0cnVkZWRQb3NpdGlvbiwgc2NhbGVkTm9ybWFsLCBleHRydWRlZFBvc2l0aW9uKTsKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnNbaSArIGJvdHRvbU9mZnNldF0gPSBleHRydWRlZFBvc2l0aW9uLng7CiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kxICsgYm90dG9tT2Zmc2V0XSA9IGV4dHJ1ZGVkUG9zaXRpb24ueTsKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnNbaTIgKyBib3R0b21PZmZzZXRdID0gZXh0cnVkZWRQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgZmluYWxQb3NpdGlvbnNbaV0gPSBwb3NpdGlvbi54OwogICAgICAgICAgZmluYWxQb3NpdGlvbnNbaTFdID0gcG9zaXRpb24ueTsKICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kyXSA9IHBvc2l0aW9uLno7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmaW5hbFBvc2l0aW9uczsKICAgICAgfTsKICAgICAgdW5pdFBvc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVhc3RWZWNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3J0aFZlY1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zLCBhZGRGaWxsUG9zaXRpb25zLCBhZGRFZGdlUG9zaXRpb25zKSB7CiAgICAgICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgICAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gb3B0aW9ucy5yb3RhdGlvbjsKICAgICAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IG9wdGlvbnMuZ3JhbnVsYXJpdHkgKiA4OwogICAgICAgIGNvbnN0IGFTcXIgPSBzZW1pTWlub3JBeGlzICogc2VtaU1pbm9yQXhpczsKICAgICAgICBjb25zdCBiU3FyID0gc2VtaU1ham9yQXhpcyAqIHNlbWlNYWpvckF4aXM7CiAgICAgICAgY29uc3QgYWIgPSBzZW1pTWFqb3JBeGlzICogc2VtaU1pbm9yQXhpczsKICAgICAgICBjb25zdCBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGNlbnRlcik7CiAgICAgICAgY29uc3QgdW5pdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoY2VudGVyLCB1bml0UG9zU2NyYXRjaCk7CiAgICAgICAgbGV0IGVhc3RWZWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgY2VudGVyLCBlYXN0VmVjU2NyYXRjaCk7CiAgICAgICAgZWFzdFZlYyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZWFzdFZlYywgZWFzdFZlYyk7CiAgICAgICAgY29uc3Qgbm9ydGhWZWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModW5pdFBvcywgZWFzdFZlYywgbm9ydGhWZWNTY3JhdGNoKTsKICAgICAgICBsZXQgbnVtUHRzID0gMSArIE1hdGguY2VpbChNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLyBncmFudWxhcml0eSk7CiAgICAgICAgY29uc3QgZGVsdGFUaGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAvIChudW1QdHMgLSAxKTsKICAgICAgICBsZXQgdGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBudW1QdHMgKiBkZWx0YVRoZXRhOwogICAgICAgIGlmICh0aGV0YSA8IDApIHsKICAgICAgICAgIG51bVB0cyAtPSBNYXRoLmNlaWwoTWF0aC5hYnModGhldGEpIC8gZGVsdGFUaGV0YSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNpemUgPSAyICogKG51bVB0cyAqIChudW1QdHMgKyAyKSk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gYWRkRmlsbFBvc2l0aW9ucyA/IG5ldyBBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICAgICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgICAgIGxldCBwb3NpdGlvbiA9IHNjcmF0Y2hDYXJ0ZXNpYW4xMjsKICAgICAgICBsZXQgcmVmbGVjdGVkUG9zaXRpb24gPSBzY3JhdGNoQ2FydGVzaWFuMjM7CiAgICAgICAgY29uc3Qgb3V0ZXJQb3NpdGlvbnNMZW5ndGggPSBudW1QdHMgKiA0ICogMzsKICAgICAgICBsZXQgb3V0ZXJSaWdodEluZGV4ID0gb3V0ZXJQb3NpdGlvbnNMZW5ndGggLSAxOwogICAgICAgIGxldCBvdXRlckxlZnRJbmRleCA9IDA7CiAgICAgICAgY29uc3Qgb3V0ZXJQb3NpdGlvbnMgPSBhZGRFZGdlUG9zaXRpb25zID8gbmV3IEFycmF5KG91dGVyUG9zaXRpb25zTGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgajsKICAgICAgICBsZXQgbnVtSW50ZXJpb3I7CiAgICAgICAgbGV0IHQ7CiAgICAgICAgbGV0IGludGVyaW9yUG9zaXRpb247CiAgICAgICAgdGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgcG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgdGhldGEsCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgZWFzdFZlYywKICAgICAgICAgIGFTcXIsCiAgICAgICAgICBhYiwKICAgICAgICAgIGJTcXIsCiAgICAgICAgICBtYWcsCiAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgcG9zaXRpb24KICAgICAgICApOwogICAgICAgIGlmIChhZGRGaWxsUG9zaXRpb25zKSB7CiAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgICAgfQogICAgICAgIGlmIChhZGRFZGdlUG9zaXRpb25zKSB7CiAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi56OwogICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueTsKICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLng7CiAgICAgICAgfQogICAgICAgIHRoZXRhID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gZGVsdGFUaGV0YTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUHRzICsgMTsgKytpKSB7CiAgICAgICAgICBwb3NpdGlvbiA9IHBvaW50T25FbGxpcHNvaWQoCiAgICAgICAgICAgIHRoZXRhLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgbm9ydGhWZWMsCiAgICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICAgIGFTcXIsCiAgICAgICAgICAgIGFiLAogICAgICAgICAgICBiU3FyLAogICAgICAgICAgICBtYWcsCiAgICAgICAgICAgIHVuaXRQb3MsCiAgICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgICApOwogICAgICAgICAgcmVmbGVjdGVkUG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgICBNYXRoLlBJIC0gdGhldGEsCiAgICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgICBub3J0aFZlYywKICAgICAgICAgICAgZWFzdFZlYywKICAgICAgICAgICAgYVNxciwKICAgICAgICAgICAgYWIsCiAgICAgICAgICAgIGJTcXIsCiAgICAgICAgICAgIG1hZywKICAgICAgICAgICAgdW5pdFBvcywKICAgICAgICAgICAgcmVmbGVjdGVkUG9zaXRpb24KICAgICAgICAgICk7CiAgICAgICAgICBpZiAoYWRkRmlsbFBvc2l0aW9ucykgewogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICAgICAgICBudW1JbnRlcmlvciA9IDIgKiBpICsgMjsKICAgICAgICAgICAgZm9yIChqID0gMTsgaiA8IG51bUludGVyaW9yIC0gMTsgKytqKSB7CiAgICAgICAgICAgICAgdCA9IGogLyAobnVtSW50ZXJpb3IgLSAxKTsKICAgICAgICAgICAgICBpbnRlcmlvclBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmxlcnAoCiAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uLAogICAgICAgICAgICAgICAgdCwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBpbnRlcmlvclBvc2l0aW9uLng7CiAgICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBpbnRlcmlvclBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBpbnRlcmlvclBvc2l0aW9uLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi54OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24uejsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhZGRFZGdlUG9zaXRpb25zKSB7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLno7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyTGVmdEluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueDsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJMZWZ0SW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi55OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlckxlZnRJbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLno7CiAgICAgICAgICB9CiAgICAgICAgICB0aGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIChpICsgMSkgKiBkZWx0YVRoZXRhOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSBudW1QdHM7IGkgPiAxOyAtLWkpIHsKICAgICAgICAgIHRoZXRhID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gKGkgLSAxKSAqIGRlbHRhVGhldGE7CiAgICAgICAgICBwb3NpdGlvbiA9IHBvaW50T25FbGxpcHNvaWQoCiAgICAgICAgICAgIC10aGV0YSwKICAgICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgICBlYXN0VmVjLAogICAgICAgICAgICBhU3FyLAogICAgICAgICAgICBhYiwKICAgICAgICAgICAgYlNxciwKICAgICAgICAgICAgbWFnLAogICAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgICBwb3NpdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uID0gcG9pbnRPbkVsbGlwc29pZCgKICAgICAgICAgICAgdGhldGEgKyBNYXRoLlBJLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgbm9ydGhWZWMsCiAgICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICAgIGFTcXIsCiAgICAgICAgICAgIGFiLAogICAgICAgICAgICBiU3FyLAogICAgICAgICAgICBtYWcsCiAgICAgICAgICAgIHVuaXRQb3MsCiAgICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGFkZEZpbGxQb3NpdGlvbnMpIHsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgICAgICAgbnVtSW50ZXJpb3IgPSAyICogKGkgLSAxKSArIDI7CiAgICAgICAgICAgIGZvciAoaiA9IDE7IGogPCBudW1JbnRlcmlvciAtIDE7ICsraikgewogICAgICAgICAgICAgIHQgPSBqIC8gKG51bUludGVyaW9yIC0gMSk7CiAgICAgICAgICAgICAgaW50ZXJpb3JQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5sZXJwKAogICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICByZWZsZWN0ZWRQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHQsCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi54OwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi55OwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueDsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi55OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLno7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYWRkRWRnZVBvc2l0aW9ucykgewogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi56OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi55OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi54OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlckxlZnRJbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLng7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyTGVmdEluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueTsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJMZWZ0SW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICBwb3NpdGlvbiA9IHBvaW50T25FbGxpcHNvaWQoCiAgICAgICAgICAtdGhldGEsCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgZWFzdFZlYywKICAgICAgICAgIGFTcXIsCiAgICAgICAgICBhYiwKICAgICAgICAgIGJTcXIsCiAgICAgICAgICBtYWcsCiAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgcG9zaXRpb24KICAgICAgICApOwogICAgICAgIGNvbnN0IHIgPSB7fTsKICAgICAgICBpZiAoYWRkRmlsbFBvc2l0aW9ucykgewogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICAgICAgci5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICByLm51bVB0cyA9IG51bVB0czsKICAgICAgICB9CiAgICAgICAgaWYgKGFkZEVkZ2VQb3NpdGlvbnMpIHsKICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLno7CiAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi55OwogICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueDsKICAgICAgICAgIHIub3V0ZXJQb3NpdGlvbnMgPSBvdXRlclBvc2l0aW9uczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH07CiAgICAgIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeUluc3RhbmNlLmpzCiAgZnVuY3Rpb24gR2VvbWV0cnlJbnN0YW5jZShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuZ2VvbWV0cnkpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLmdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgdGhpcy5nZW9tZXRyeSA9IG9wdGlvbnMuZ2VvbWV0cnk7CiAgICB0aGlzLm1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1vZGVsTWF0cml4LCBNYXRyaXg0X2RlZmF1bHQuSURFTlRJVFkpCiAgICApOwogICAgdGhpcy5pZCA9IG9wdGlvbnMuaWQ7CiAgICB0aGlzLnBpY2tQcmltaXRpdmUgPSBvcHRpb25zLnBpY2tQcmltaXRpdmU7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmF0dHJpYnV0ZXMsIHt9KTsKICAgIHRoaXMud2VzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IHZvaWQgMDsKICAgIHRoaXMuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IHZvaWQgMDsKICB9CiAgdmFyIEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeUluc3RhbmNlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeUluc3RhbmNlLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCA9IEdlb21ldHJ5SW5zdGFuY2U7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNlR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjb21wdXRlVG9wQm90dG9tQXR0cmlidXRlcyhwb3NpdGlvbnMsIG9wdGlvbnMsIGV4dHJ1ZGUpIHsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IG9wdGlvbnMudmVydGV4Rm9ybWF0OwogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgIGNvbnN0IGVsbGlwc29pZCA9IG9wdGlvbnMuZWxsaXBzb2lkOwogICAgY29uc3Qgc3RSb3RhdGlvbiA9IG9wdGlvbnMuc3RSb3RhdGlvbjsKICAgIGNvbnN0IHNpemUgPSBleHRydWRlID8gcG9zaXRpb25zLmxlbmd0aCAvIDMgKiAyIDogcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSBvcHRpb25zLnNoYWRvd1ZvbHVtZTsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpIDogdm9pZCAwOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCBleHRydWRlTm9ybWFscyA9IHNoYWRvd1ZvbHVtZSA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgbGV0IHRleHR1cmVDb29yZEluZGV4ID0gMDsKICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDM7CiAgICBsZXQgdGFuZ2VudCA9IHNjcmF0Y2hUYW5nZW50OwogICAgbGV0IGJpdGFuZ2VudCA9IHNjcmF0Y2hCaXRhbmdlbnQ7CiAgICBjb25zdCBwcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgIGNvbnN0IHByb2plY3RlZENlbnRlciA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGNlbnRlciwgc2NyYXRjaENhcnRvZ3JhcGhpYzIpLAogICAgICBwcm9qZWN0ZWRDZW50ZXJTY3JhdGNoCiAgICApOwogICAgY29uc3QgZ2VvZGV0aWNOb3JtYWwgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgY2VudGVyLAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTMKICAgICk7CiAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGdlb2RldGljTm9ybWFsLCBnZW9kZXRpY05vcm1hbCk7CiAgICBsZXQgdGV4dHVyZU1hdHJpeCA9IHRleHR1cmVNYXRyaXhTY3JhdGNoOwogICAgbGV0IHRhbmdlbnRNYXRyaXggPSB0YW5nZW50TWF0cml4U2NyYXRjaDsKICAgIGlmIChzdFJvdGF0aW9uICE9PSAwKSB7CiAgICAgIGxldCByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgIGdlb2RldGljTm9ybWFsLAogICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgcXVhdGVybmlvblNjcmF0Y2gKICAgICAgKTsKICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihyb3RhdGlvbiwgdGV4dHVyZU1hdHJpeCk7CiAgICAgIHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgZ2VvZGV0aWNOb3JtYWwsCiAgICAgICAgLXN0Um90YXRpb24sCiAgICAgICAgcXVhdGVybmlvblNjcmF0Y2gKICAgICAgKTsKICAgICAgdGFuZ2VudE1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihyb3RhdGlvbiwgdGFuZ2VudE1hdHJpeCk7CiAgICB9IGVsc2UgewogICAgICB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmNsb25lKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdGV4dHVyZU1hdHJpeCk7CiAgICAgIHRhbmdlbnRNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuY2xvbmUoTWF0cml4M19kZWZhdWx0LklERU5USVRZLCB0YW5nZW50TWF0cml4KTsKICAgIH0KICAgIGNvbnN0IG1pblRleENvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksCiAgICAgIHNjcmF0Y2hNaW5UZXhDb29yZAogICAgKTsKICAgIGNvbnN0IG1heFRleENvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksCiAgICAgIHNjcmF0Y2hNYXhUZXhDb29yZAogICAgKTsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3QgYm90dG9tT2Zmc2V0ID0gZXh0cnVkZSA/IGxlbmd0aCA6IDA7CiAgICBjb25zdCBzdE9mZnNldCA9IGJvdHRvbU9mZnNldCAvIDMgKiAyOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCBpMSA9IGkgKyAxOwogICAgICBjb25zdCBpMiA9IGkgKyAyOwogICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCBzY3JhdGNoQ2FydGVzaWFuMTMpOwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgY29uc3Qgcm90YXRlZFBvaW50ID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICB0ZXh0dXJlTWF0cml4LAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMjQKICAgICAgICApOwogICAgICAgIGNvbnN0IHByb2plY3RlZFBvaW50ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHJvdGF0ZWRQb2ludCwgc2NyYXRjaENhcnRvZ3JhcGhpYzIpLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjM1CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocHJvamVjdGVkUG9pbnQsIHByb2plY3RlZENlbnRlciwgcHJvamVjdGVkUG9pbnQpOwogICAgICAgIHRleENvb3JkU2NyYXRjaC54ID0gKHByb2plY3RlZFBvaW50LnggKyBzZW1pTWFqb3JBeGlzKSAvICgyICogc2VtaU1ham9yQXhpcyk7CiAgICAgICAgdGV4Q29vcmRTY3JhdGNoLnkgPSAocHJvamVjdGVkUG9pbnQueSArIHNlbWlNaW5vckF4aXMpIC8gKDIgKiBzZW1pTWlub3JBeGlzKTsKICAgICAgICBtaW5UZXhDb29yZC54ID0gTWF0aC5taW4odGV4Q29vcmRTY3JhdGNoLngsIG1pblRleENvb3JkLngpOwogICAgICAgIG1pblRleENvb3JkLnkgPSBNYXRoLm1pbih0ZXhDb29yZFNjcmF0Y2gueSwgbWluVGV4Q29vcmQueSk7CiAgICAgICAgbWF4VGV4Q29vcmQueCA9IE1hdGgubWF4KHRleENvb3JkU2NyYXRjaC54LCBtYXhUZXhDb29yZC54KTsKICAgICAgICBtYXhUZXhDb29yZC55ID0gTWF0aC5tYXgodGV4Q29vcmRTY3JhdGNoLnksIG1heFRleENvb3JkLnkpOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyBzdE9mZnNldF0gPSB0ZXhDb29yZFNjcmF0Y2gueDsKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIDEgKyBzdE9mZnNldF0gPSB0ZXhDb29yZFNjcmF0Y2gueTsKICAgICAgICB9CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4KytdID0gdGV4Q29vcmRTY3JhdGNoLng7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4KytdID0gdGV4Q29vcmRTY3JhdGNoLnk7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCB8fCBzaGFkb3dWb2x1bWUpIHsKICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgICAgZXh0cnVkZU5vcm1hbHNbaSArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi54OwogICAgICAgICAgZXh0cnVkZU5vcm1hbHNbaTEgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueTsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kyICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRhbmdlbnRNYXRyaXgsIHRhbmdlbnQsIHRhbmdlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgbm9ybWFsc1tpXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgbm9ybWFsc1tpMV0gPSBub3JtYWwyLnk7CiAgICAgICAgICAgIG5vcm1hbHNbaTJdID0gbm9ybWFsMi56OwogICAgICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgICAgIG5vcm1hbHNbaSArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi54OwogICAgICAgICAgICAgIG5vcm1hbHNbaTEgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueTsKICAgICAgICAgICAgICBub3JtYWxzW2kyICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLno7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICB0YW5nZW50c1tpXSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgdGFuZ2VudHNbaTFdID0gdGFuZ2VudC55OwogICAgICAgICAgICB0YW5nZW50c1tpMl0gPSB0YW5nZW50Lno7CiAgICAgICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbaSArIGJvdHRvbU9mZnNldF0gPSAtdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW2kxICsgYm90dG9tT2Zmc2V0XSA9IC10YW5nZW50Lnk7CiAgICAgICAgICAgICAgdGFuZ2VudHNbaTIgKyBib3R0b21PZmZzZXRdID0gLXRhbmdlbnQuejsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgdGFuZ2VudCwgYml0YW5nZW50KSwKICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgYml0YW5nZW50c1tpXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgICBiaXRhbmdlbnRzW2kxXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICBiaXRhbmdlbnRzW2kyXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgICAgIGJpdGFuZ2VudHNbaSArIGJvdHRvbU9mZnNldF0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2kxICsgYm90dG9tT2Zmc2V0XSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbaTIgKyBib3R0b21PZmZzZXRdID0gYml0YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgbGVuZ3RoID0gdGV4dHVyZUNvb3JkaW5hdGVzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBsZW5ndGg7IGsgKz0gMikgewogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1trXSA9ICh0ZXh0dXJlQ29vcmRpbmF0ZXNba10gLSBtaW5UZXhDb29yZC54KSAvIChtYXhUZXhDb29yZC54IC0gbWluVGV4Q29vcmQueCk7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW2sgKyAxXSA9ICh0ZXh0dXJlQ29vcmRpbmF0ZXNbayArIDFdIC0gbWluVGV4Q29vcmQueSkgLyAobWF4VGV4Q29vcmQueSAtIG1pblRleENvb3JkLnkpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnJhaXNlUG9zaXRpb25zVG9IZWlnaHQoCiAgICAgICAgcG9zaXRpb25zLAogICAgICAgIG9wdGlvbnMsCiAgICAgICAgZXh0cnVkZQogICAgICApOwogICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZmluYWxQb3NpdGlvbnMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBleHRydWRlTm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmIChleHRydWRlICYmIGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgbGV0IG9mZnNldEF0dHJpYnV0ZSA9IG5ldyBVaW50OEFycmF5KHNpemUpOwogICAgICBpZiAob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwoMSwgMCwgc2l6ZSAvIDIpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgfQogICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICB2YWx1ZXM6IG9mZnNldEF0dHJpYnV0ZQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBhdHRyaWJ1dGVzOwogIH0KICBmdW5jdGlvbiB0b3BJbmRpY2VzKG51bVB0cykgewogICAgY29uc3QgaW5kaWNlcyA9IG5ldyBBcnJheSgxMiAqIChudW1QdHMgKiAobnVtUHRzICsgMSkpIC0gNik7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMDsKICAgIGxldCBwcmV2SW5kZXg7CiAgICBsZXQgbnVtSW50ZXJpb3I7CiAgICBsZXQgcG9zaXRpb25JbmRleDsKICAgIGxldCBpOwogICAgbGV0IGo7CiAgICBwcmV2SW5kZXggPSAwOwogICAgcG9zaXRpb25JbmRleCA9IDE7CiAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgfQogICAgZm9yIChpID0gMjsgaSA8IG51bVB0cyArIDE7ICsraSkgewogICAgICBwb3NpdGlvbkluZGV4ID0gaSAqIChpICsgMSkgLSAxOwogICAgICBwcmV2SW5kZXggPSAoaSAtIDEpICogaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICBudW1JbnRlcmlvciA9IDIgKiBpOwogICAgICBmb3IgKGogPSAwOyBqIDwgbnVtSW50ZXJpb3IgLSAxOyArK2opIHsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgIH0KICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICB9CiAgICBudW1JbnRlcmlvciA9IG51bVB0cyAqIDI7CiAgICArK3Bvc2l0aW9uSW5kZXg7CiAgICArK3ByZXZJbmRleDsKICAgIGZvciAoaSA9IDA7IGkgPCBudW1JbnRlcmlvciAtIDE7ICsraSkgewogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgIH0KICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgKytwcmV2SW5kZXg7CiAgICBmb3IgKGkgPSBudW1QdHMgLSAxOyBpID4gMTsgLS1pKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgIG51bUludGVyaW9yID0gMiAqIGk7CiAgICAgIGZvciAoaiA9IDA7IGogPCBudW1JbnRlcmlvciAtIDE7ICsraikgewogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgICAgfQogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgIH0KICAgIHJldHVybiBpbmRpY2VzOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRWxsaXBzZShvcHRpb25zKSB7CiAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIG9wdGlvbnMuZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChjZW50ZXIsIGJvdW5kaW5nU3BoZXJlQ2VudGVyKSwKICAgICAgb3B0aW9ucy5oZWlnaHQsCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyCiAgICApOwogICAgYm91bmRpbmdTcGhlcmVDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBjZW50ZXIsCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyLAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcgogICAgKTsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyLAogICAgICBvcHRpb25zLnNlbWlNYWpvckF4aXMKICAgICk7CiAgICBjb25zdCBjZXAgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMoCiAgICAgIG9wdGlvbnMsCiAgICAgIHRydWUsCiAgICAgIGZhbHNlCiAgICApOwogICAgY29uc3QgcG9zaXRpb25zID0gY2VwLnBvc2l0aW9uczsKICAgIGNvbnN0IG51bVB0cyA9IGNlcC5udW1QdHM7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gY29tcHV0ZVRvcEJvdHRvbUF0dHJpYnV0ZXMocG9zaXRpb25zLCBvcHRpb25zLCBmYWxzZSk7CiAgICBsZXQgaW5kaWNlcyA9IHRvcEluZGljZXMobnVtUHRzKTsKICAgIGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShwb3NpdGlvbnMubGVuZ3RoIC8gMywgaW5kaWNlcyk7CiAgICByZXR1cm4gewogICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVdhbGxBdHRyaWJ1dGVzKHBvc2l0aW9ucywgb3B0aW9ucykgewogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gb3B0aW9ucy52ZXJ0ZXhGb3JtYXQ7CiAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gb3B0aW9ucy5zZW1pTWlub3JBeGlzOwogICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICBjb25zdCBoZWlnaHQgPSBvcHRpb25zLmhlaWdodDsKICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gb3B0aW9ucy5leHRydWRlZEhlaWdodDsKICAgIGNvbnN0IHN0Um90YXRpb24gPSBvcHRpb25zLnN0Um90YXRpb247CiAgICBjb25zdCBzaXplID0gcG9zaXRpb25zLmxlbmd0aCAvIDMgKiAyOwogICAgY29uc3QgZmluYWxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpIDogdm9pZCAwOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSBvcHRpb25zLnNoYWRvd1ZvbHVtZTsKICAgIGNvbnN0IGV4dHJ1ZGVOb3JtYWxzID0gc2hhZG93Vm9sdW1lID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBsZXQgdGV4dHVyZUNvb3JkSW5kZXggPSAwOwogICAgbGV0IG5vcm1hbDIgPSBzY3JhdGNoTm9ybWFsMzsKICAgIGxldCB0YW5nZW50ID0gc2NyYXRjaFRhbmdlbnQ7CiAgICBsZXQgYml0YW5nZW50ID0gc2NyYXRjaEJpdGFuZ2VudDsKICAgIGNvbnN0IHByb2plY3Rpb24gPSBuZXcgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdChlbGxpcHNvaWQpOwogICAgY29uc3QgcHJvamVjdGVkQ2VudGVyID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoY2VudGVyLCBzY3JhdGNoQ2FydG9ncmFwaGljMiksCiAgICAgIHByb2plY3RlZENlbnRlclNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBnZW9kZXRpY05vcm1hbCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKAogICAgICBjZW50ZXIsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMwogICAgKTsKICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoZ2VvZGV0aWNOb3JtYWwsIGdlb2RldGljTm9ybWFsKTsKICAgIGNvbnN0IHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgIGdlb2RldGljTm9ybWFsLAogICAgICBzdFJvdGF0aW9uLAogICAgICBxdWF0ZXJuaW9uU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocm90YXRpb24sIHRleHR1cmVNYXRyaXhTY3JhdGNoKTsKICAgIGNvbnN0IG1pblRleENvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksCiAgICAgIHNjcmF0Y2hNaW5UZXhDb29yZAogICAgKTsKICAgIGNvbnN0IG1heFRleENvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksCiAgICAgIHNjcmF0Y2hNYXhUZXhDb29yZAogICAgKTsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgc3RPZmZzZXQgPSBsZW5ndGggLyAzICogMjsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgaTEgPSBpICsgMTsKICAgICAgY29uc3QgaTIgPSBpICsgMjsKICAgICAgbGV0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHNjcmF0Y2hDYXJ0ZXNpYW4xMyk7CiAgICAgIGxldCBleHRydWRlZFBvc2l0aW9uOwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgY29uc3Qgcm90YXRlZFBvaW50ID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICB0ZXh0dXJlTWF0cml4LAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMjQKICAgICAgICApOwogICAgICAgIGNvbnN0IHByb2plY3RlZFBvaW50ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHJvdGF0ZWRQb2ludCwgc2NyYXRjaENhcnRvZ3JhcGhpYzIpLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjM1CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocHJvamVjdGVkUG9pbnQsIHByb2plY3RlZENlbnRlciwgcHJvamVjdGVkUG9pbnQpOwogICAgICAgIHRleENvb3JkU2NyYXRjaC54ID0gKHByb2plY3RlZFBvaW50LnggKyBzZW1pTWFqb3JBeGlzKSAvICgyICogc2VtaU1ham9yQXhpcyk7CiAgICAgICAgdGV4Q29vcmRTY3JhdGNoLnkgPSAocHJvamVjdGVkUG9pbnQueSArIHNlbWlNaW5vckF4aXMpIC8gKDIgKiBzZW1pTWlub3JBeGlzKTsKICAgICAgICBtaW5UZXhDb29yZC54ID0gTWF0aC5taW4odGV4Q29vcmRTY3JhdGNoLngsIG1pblRleENvb3JkLngpOwogICAgICAgIG1pblRleENvb3JkLnkgPSBNYXRoLm1pbih0ZXhDb29yZFNjcmF0Y2gueSwgbWluVGV4Q29vcmQueSk7CiAgICAgICAgbWF4VGV4Q29vcmQueCA9IE1hdGgubWF4KHRleENvb3JkU2NyYXRjaC54LCBtYXhUZXhDb29yZC54KTsKICAgICAgICBtYXhUZXhDb29yZC55ID0gTWF0aC5tYXgodGV4Q29vcmRTY3JhdGNoLnksIG1heFRleENvb3JkLnkpOwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIHN0T2Zmc2V0XSA9IHRleENvb3JkU2NyYXRjaC54OwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIDEgKyBzdE9mZnNldF0gPSB0ZXhDb29yZFNjcmF0Y2gueTsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXgrK10gPSB0ZXhDb29yZFNjcmF0Y2gueDsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXgrK10gPSB0ZXhDb29yZFNjcmF0Y2gueTsKICAgICAgfQogICAgICBwb3NpdGlvbiA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uLCBwb3NpdGlvbik7CiAgICAgIGV4dHJ1ZGVkUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHNjcmF0Y2hDYXJ0ZXNpYW4yNCk7CiAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kgKyBsZW5ndGhdID0gLW5vcm1hbDIueDsKICAgICAgICBleHRydWRlTm9ybWFsc1tpMSArIGxlbmd0aF0gPSAtbm9ybWFsMi55OwogICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kyICsgbGVuZ3RoXSA9IC1ub3JtYWwyLno7CiAgICAgIH0KICAgICAgbGV0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIG5vcm1hbDIsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW40CiAgICAgICk7CiAgICAgIHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgc2NhbGVkTm9ybWFsLCBwb3NpdGlvbik7CiAgICAgIHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIG5vcm1hbDIsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgc2NhbGVkTm9ybWFsCiAgICAgICk7CiAgICAgIGV4dHJ1ZGVkUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgIGV4dHJ1ZGVkUG9zaXRpb24sCiAgICAgICAgc2NhbGVkTm9ybWFsLAogICAgICAgIGV4dHJ1ZGVkUG9zaXRpb24KICAgICAgKTsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgIGZpbmFsUG9zaXRpb25zW2kgKyBsZW5ndGhdID0gZXh0cnVkZWRQb3NpdGlvbi54OwogICAgICAgIGZpbmFsUG9zaXRpb25zW2kxICsgbGVuZ3RoXSA9IGV4dHJ1ZGVkUG9zaXRpb24ueTsKICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMiArIGxlbmd0aF0gPSBleHRydWRlZFBvc2l0aW9uLno7CiAgICAgICAgZmluYWxQb3NpdGlvbnNbaV0gPSBwb3NpdGlvbi54OwogICAgICAgIGZpbmFsUG9zaXRpb25zW2kxXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgZmluYWxQb3NpdGlvbnNbaTJdID0gcG9zaXRpb24uejsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG5vcm1hbDIsIGJpdGFuZ2VudCk7CiAgICAgICAgY29uc3QgbmV4dCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAoaSArIDMpICUgbGVuZ3RoLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjQKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChuZXh0LCBwb3NpdGlvbiwgbmV4dCk7CiAgICAgICAgY29uc3QgYm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgZXh0cnVkZWRQb3NpdGlvbiwKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjM1CiAgICAgICAgKTsKICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhib3R0b20sIG5leHQsIG5vcm1hbDIpLAogICAgICAgICAgbm9ybWFsMgogICAgICAgICk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgIG5vcm1hbHNbaV0gPSBub3JtYWwyLng7CiAgICAgICAgICBub3JtYWxzW2kxXSA9IG5vcm1hbDIueTsKICAgICAgICAgIG5vcm1hbHNbaTJdID0gbm9ybWFsMi56OwogICAgICAgICAgbm9ybWFsc1tpICsgbGVuZ3RoXSA9IG5vcm1hbDIueDsKICAgICAgICAgIG5vcm1hbHNbaTEgKyBsZW5ndGhdID0gbm9ybWFsMi55OwogICAgICAgICAgbm9ybWFsc1tpMiArIGxlbmd0aF0gPSBub3JtYWwyLno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhiaXRhbmdlbnQsIG5vcm1hbDIsIHRhbmdlbnQpLAogICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICApOwogICAgICAgICAgdGFuZ2VudHNbaV0gPSB0YW5nZW50Lng7CiAgICAgICAgICB0YW5nZW50c1tpMV0gPSB0YW5nZW50Lnk7CiAgICAgICAgICB0YW5nZW50c1tpMl0gPSB0YW5nZW50Lno7CiAgICAgICAgICB0YW5nZW50c1tpICsgbGVuZ3RoXSA9IHRhbmdlbnQueDsKICAgICAgICAgIHRhbmdlbnRzW2kgKyAxICsgbGVuZ3RoXSA9IHRhbmdlbnQueTsKICAgICAgICAgIHRhbmdlbnRzW2kgKyAyICsgbGVuZ3RoXSA9IHRhbmdlbnQuejsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudHNbaV0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgIGJpdGFuZ2VudHNbaTFdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICBiaXRhbmdlbnRzW2kyXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgYml0YW5nZW50c1tpICsgbGVuZ3RoXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgYml0YW5nZW50c1tpMSArIGxlbmd0aF0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgIGJpdGFuZ2VudHNbaTIgKyBsZW5ndGhdID0gYml0YW5nZW50Lno7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGxlbmd0aCA9IHRleHR1cmVDb29yZGluYXRlcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbGVuZ3RoOyBrICs9IDIpIHsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNba10gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2tdIC0gbWluVGV4Q29vcmQueCkgLyAobWF4VGV4Q29vcmQueCAtIG1pblRleENvb3JkLngpOwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1trICsgMV0gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2sgKyAxXSAtIG1pblRleENvb3JkLnkpIC8gKG1heFRleENvb3JkLnkgLSBtaW5UZXhDb29yZC55KTsKICAgICAgfQogICAgfQogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZmluYWxQb3NpdGlvbnMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBleHRydWRlTm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBuZXcgVWludDhBcnJheShzaXplKTsKICAgICAgaWYgKG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKDEsIDAsIHNpemUgLyAyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVdhbGxJbmRpY2VzKHBvc2l0aW9ucykgewogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobGVuZ3RoLCBsZW5ndGggKiA2KTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IFVMID0gaTsKICAgICAgY29uc3QgTEwgPSBpICsgbGVuZ3RoOwogICAgICBjb25zdCBVUiA9IChVTCArIDEpICUgbGVuZ3RoOwogICAgICBjb25zdCBMUiA9IFVSICsgbGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgfQogICAgcmV0dXJuIGluZGljZXM7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVFeHRydWRlZEVsbGlwc2Uob3B0aW9ucykgewogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBvcHRpb25zLmVsbGlwc29pZDsKICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICBsZXQgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2VudGVyLCBzY3JhdGNoQ2FydGVzaWFuMTMpLAogICAgICBvcHRpb25zLmhlaWdodCwKICAgICAgc2NyYXRjaENhcnRlc2lhbjEzCiAgICApOwogICAgdG9wQm91bmRpbmdTcGhlcmUuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgY2VudGVyLAogICAgICBzY2FsZWROb3JtYWwsCiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlLmNlbnRlcgogICAgKTsKICAgIHRvcEJvdW5kaW5nU3BoZXJlLnJhZGl1cyA9IHNlbWlNYWpvckF4aXM7CiAgICBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChjZW50ZXIsIHNjYWxlZE5vcm1hbCksCiAgICAgIG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgIHNjYWxlZE5vcm1hbAogICAgKTsKICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlLmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgIGNlbnRlciwKICAgICAgc2NhbGVkTm9ybWFsLAogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZS5jZW50ZXIKICAgICk7CiAgICBib3R0b21Cb3VuZGluZ1NwaGVyZS5yYWRpdXMgPSBzZW1pTWFqb3JBeGlzOwogICAgY29uc3QgY2VwID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zKAogICAgICBvcHRpb25zLAogICAgICB0cnVlLAogICAgICB0cnVlCiAgICApOwogICAgY29uc3QgcG9zaXRpb25zID0gY2VwLnBvc2l0aW9uczsKICAgIGNvbnN0IG51bVB0cyA9IGNlcC5udW1QdHM7CiAgICBjb25zdCBvdXRlclBvc2l0aW9ucyA9IGNlcC5vdXRlclBvc2l0aW9uczsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbigKICAgICAgdG9wQm91bmRpbmdTcGhlcmUsCiAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlCiAgICApOwogICAgY29uc3QgdG9wQm90dG9tQXR0cmlidXRlcyA9IGNvbXB1dGVUb3BCb3R0b21BdHRyaWJ1dGVzKAogICAgICBwb3NpdGlvbnMsCiAgICAgIG9wdGlvbnMsCiAgICAgIHRydWUKICAgICk7CiAgICBsZXQgaW5kaWNlcyA9IHRvcEluZGljZXMobnVtUHRzKTsKICAgIGNvbnN0IGxlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgaW5kaWNlcy5sZW5ndGggPSBsZW5ndGggKiAyOwogICAgY29uc3QgcG9zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGluZGljZXNbaSArIGxlbmd0aF0gPSBpbmRpY2VzW2kgKyAyXSArIHBvc0xlbmd0aDsKICAgICAgaW5kaWNlc1tpICsgMSArIGxlbmd0aF0gPSBpbmRpY2VzW2kgKyAxXSArIHBvc0xlbmd0aDsKICAgICAgaW5kaWNlc1tpICsgMiArIGxlbmd0aF0gPSBpbmRpY2VzW2ldICsgcG9zTGVuZ3RoOwogICAgfQogICAgY29uc3QgdG9wQm90dG9tSW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBwb3NMZW5ndGggKiAyIC8gMywKICAgICAgaW5kaWNlcwogICAgKTsKICAgIGNvbnN0IHRvcEJvdHRvbUdlbyA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlczogdG9wQm90dG9tQXR0cmlidXRlcywKICAgICAgaW5kaWNlczogdG9wQm90dG9tSW5kaWNlcywKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgfSk7CiAgICBjb25zdCB3YWxsQXR0cmlidXRlcyA9IGNvbXB1dGVXYWxsQXR0cmlidXRlcyhvdXRlclBvc2l0aW9ucywgb3B0aW9ucyk7CiAgICBpbmRpY2VzID0gY29tcHV0ZVdhbGxJbmRpY2VzKG91dGVyUG9zaXRpb25zKTsKICAgIGNvbnN0IHdhbGxJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG91dGVyUG9zaXRpb25zLmxlbmd0aCAqIDIgLyAzLAogICAgICBpbmRpY2VzCiAgICApOwogICAgY29uc3Qgd2FsbEdlbyA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlczogd2FsbEF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IHdhbGxJbmRpY2VzLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICB9KTsKICAgIGNvbnN0IGdlbyA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21iaW5lSW5zdGFuY2VzKFsKICAgICAgbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IHRvcEJvdHRvbUdlbwogICAgICB9KSwKICAgICAgbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IHdhbGxHZW8KICAgICAgfSkKICAgIF0pOwogICAgcmV0dXJuIHsKICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgIGF0dHJpYnV0ZXM6IGdlb1swXS5hdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiBnZW9bMF0uaW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVJlY3RhbmdsZShjZW50ZXIsIHNlbWlNYWpvckF4aXMsIHNlbWlNaW5vckF4aXMsIHJvdGF0aW9uLCBncmFudWxhcml0eSwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgIGNvbnN0IGNlcCA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlRWxsaXBzZVBvc2l0aW9ucygKICAgICAgewogICAgICAgIGNlbnRlciwKICAgICAgICBzZW1pTWFqb3JBeGlzLAogICAgICAgIHNlbWlNaW5vckF4aXMsCiAgICAgICAgcm90YXRpb24sCiAgICAgICAgZ3JhbnVsYXJpdHkKICAgICAgfSwKICAgICAgZmFsc2UsCiAgICAgIHRydWUKICAgICk7CiAgICBjb25zdCBwb3NpdGlvbnNGbGF0ID0gY2VwLm91dGVyUG9zaXRpb25zOwogICAgY29uc3QgcG9zaXRpb25zQ291bnQgPSBwb3NpdGlvbnNGbGF0Lmxlbmd0aCAvIDM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkocG9zaXRpb25zQ291bnQpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNDb3VudDsgKytpKSB7CiAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zRmxhdCwgaSAqIDMpOwogICAgfQogICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuZnJvbUNhcnRlc2lhbkFycmF5KHBvc2l0aW9ucywgZWxsaXBzb2lkLCByZXN1bHQpOwogICAgaWYgKHJlY3RhbmdsZS53aWR0aCA+IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICByZWN0YW5nbGUubm9ydGggPSByZWN0YW5nbGUubm9ydGggPiAwID8gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gTWF0aF9kZWZhdWx0LkVQU0lMT043IDogcmVjdGFuZ2xlLm5vcnRoOwogICAgICByZWN0YW5nbGUuc291dGggPSByZWN0YW5nbGUuc291dGggPCAwID8gTWF0aF9kZWZhdWx0LkVQU0lMT043IC0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIDogcmVjdGFuZ2xlLnNvdXRoOwogICAgICByZWN0YW5nbGUuZWFzdCA9IE1hdGhfZGVmYXVsdC5QSTsKICAgICAgcmVjdGFuZ2xlLndlc3QgPSAtTWF0aF9kZWZhdWx0LlBJOwogICAgfQogICAgcmV0dXJuIHJlY3RhbmdsZTsKICB9CiAgZnVuY3Rpb24gRWxsaXBzZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCk7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMuY2VudGVyIiwgY2VudGVyKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigib3B0aW9ucy5zZW1pTWFqb3JBeGlzIiwgc2VtaU1ham9yQXhpcyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMuc2VtaU1pbm9yQXhpcyIsIHNlbWlNaW5vckF4aXMpOwogICAgaWYgKHNlbWlNYWpvckF4aXMgPCBzZW1pTWlub3JBeGlzKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJzZW1pTWFqb3JBeGlzIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBzZW1pTWlub3JBeGlzLiIKICAgICAgKTsKICAgIH0KICAgIGlmIChncmFudWxhcml0eSA8PSAwKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJncmFudWxhcml0eSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgfQogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB0aGlzLl9zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgIHRoaXMuX3NlbWlNaW5vckF4aXMgPSBzZW1pTWlub3JBeGlzOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX3JvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICB0aGlzLl9zdFJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdFJvdGF0aW9uLCAwKTsKICAgIHRoaXMuX2hlaWdodCA9IE1hdGgubWF4KGV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fc2hhZG93Vm9sdW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zaGFkb3dWb2x1bWUsIGZhbHNlKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlRWxsaXBzZUdlb21ldHJ5IjsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fcmVjdGFuZ2xlID0gdm9pZCAwOwogICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyhlbGxpcHNlR2VvbWV0cnkpIHsKICAgIGNvbnN0IHN0Um90YXRpb24gPSAtZWxsaXBzZUdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgaWYgKHN0Um90YXRpb24gPT09IDApIHsKICAgICAgcmV0dXJuIFswLCAwLCAwLCAxLCAxLCAwXTsKICAgIH0KICAgIGNvbnN0IGNlcCA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlRWxsaXBzZVBvc2l0aW9ucygKICAgICAgewogICAgICAgIGNlbnRlcjogZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgc2VtaU1ham9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzLAogICAgICAgIHNlbWlNaW5vckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpcywKICAgICAgICByb3RhdGlvbjogZWxsaXBzZUdlb21ldHJ5Ll9yb3RhdGlvbiwKICAgICAgICBncmFudWxhcml0eTogZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eQogICAgICB9LAogICAgICBmYWxzZSwKICAgICAgdHJ1ZQogICAgKTsKICAgIGNvbnN0IHBvc2l0aW9uc0ZsYXQgPSBjZXAub3V0ZXJQb3NpdGlvbnM7CiAgICBjb25zdCBwb3NpdGlvbnNDb3VudCA9IHBvc2l0aW9uc0ZsYXQubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShwb3NpdGlvbnNDb3VudCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0NvdW50OyArK2kpIHsKICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnNGbGF0LCBpICogMyk7CiAgICB9CiAgICBjb25zdCBlbGxpcHNvaWQgPSBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gZWxsaXBzZUdlb21ldHJ5LnJlY3RhbmdsZTsKICAgIHJldHVybiBHZW9tZXRyeV9kZWZhdWx0Ll90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzKAogICAgICBwb3NpdGlvbnMsCiAgICAgIHN0Um90YXRpb24sCiAgICAgIGVsbGlwc29pZCwKICAgICAgYm91bmRpbmdSZWN0YW5nbGUKICAgICk7CiAgfQogIHZhciBzY3JhdGNoQ2FydGVzaWFuMTMsIHNjcmF0Y2hDYXJ0ZXNpYW4yNCwgc2NyYXRjaENhcnRlc2lhbjM1LCBzY3JhdGNoQ2FydGVzaWFuNCwgdGV4Q29vcmRTY3JhdGNoLCB0ZXh0dXJlTWF0cml4U2NyYXRjaCwgdGFuZ2VudE1hdHJpeFNjcmF0Y2gsIHF1YXRlcm5pb25TY3JhdGNoLCBzY3JhdGNoTm9ybWFsMywgc2NyYXRjaFRhbmdlbnQsIHNjcmF0Y2hCaXRhbmdlbnQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyLCBwcm9qZWN0ZWRDZW50ZXJTY3JhdGNoLCBzY3JhdGNoTWluVGV4Q29vcmQsIHNjcmF0Y2hNYXhUZXhDb29yZCwgYm91bmRpbmdTcGhlcmVDZW50ZXIsIHRvcEJvdW5kaW5nU3BoZXJlLCBib3R0b21Cb3VuZGluZ1NwaGVyZSwgc2NyYXRjaENlbnRlcjIsIHNjcmF0Y2hFbGxpcHNvaWQsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQyLCBzY3JhdGNoT3B0aW9uczMsIEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc2VHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc2VHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeUluc3RhbmNlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjEzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRleENvb3JkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgdGV4dHVyZU1hdHJpeFNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHRhbmdlbnRNYXRyaXhTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBxdWF0ZXJuaW9uU2NyYXRjaCA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUYW5nZW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQml0YW5nZW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBwcm9qZWN0ZWRDZW50ZXJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluVGV4Q29vcmQgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNYXhUZXhDb29yZCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBFbGxpcHNlR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fY2VudGVyLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2VtaU1ham9yQXhpczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NlbWlNaW5vckF4aXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9yb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0Um90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9oZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2hhZG93Vm9sdW1lID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoQ2VudGVyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZCA9IG5ldyBFbGxpcHNvaWRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MiA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczMgPSB7CiAgICAgICAgY2VudGVyOiBzY3JhdGNoQ2VudGVyMiwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0MiwKICAgICAgICBzZW1pTWFqb3JBeGlzOiB2b2lkIDAsCiAgICAgICAgc2VtaU1pbm9yQXhpczogdm9pZCAwLAogICAgICAgIHJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgc3RSb3RhdGlvbjogdm9pZCAwLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBzaGFkb3dWb2x1bWU6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBFbGxpcHNlR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hDZW50ZXIyKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MgogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3Qgc2VtaU1ham9yQXhpcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLnN0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLnJvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMuc2VtaU1ham9yQXhpcyA9IHNlbWlNYWpvckF4aXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMuc2VtaU1pbm9yQXhpcyA9IHNlbWlNaW5vckF4aXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMuc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IEVsbGlwc2VHZW9tZXRyeShzY3JhdGNoT3B0aW9uczMpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdC5fY2VudGVyKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgICAgICByZXN1bHQuX3NlbWlNaW5vckF4aXMgPSBzZW1pTWlub3JBeGlzOwogICAgICAgIHJlc3VsdC5fcm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICByZXN1bHQuX3N0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5faGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9zaGFkb3dWb2x1bWUgPSBzaGFkb3dWb2x1bWU7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc2VHZW9tZXRyeS5jb21wdXRlUmVjdGFuZ2xlID0gZnVuY3Rpb24ob3B0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICAgICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICAgICApOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLmNlbnRlciIsIGNlbnRlcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLnNlbWlNYWpvckF4aXMiLCBzZW1pTWFqb3JBeGlzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMuc2VtaU1pbm9yQXhpcyIsIHNlbWlNaW5vckF4aXMpOwogICAgICAgIGlmIChzZW1pTWFqb3JBeGlzIDwgc2VtaU1pbm9yQXhpcykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJzZW1pTWFqb3JBeGlzIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBzZW1pTWlub3JBeGlzLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChncmFudWxhcml0eSA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ3JhbnVsYXJpdHkgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXB1dGVSZWN0YW5nbGUoCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICBzZW1pTWFqb3JBeGlzLAogICAgICAgICAgc2VtaU1pbm9yQXhpcywKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNlR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihlbGxpcHNlR2VvbWV0cnkpIHsKICAgICAgICBpZiAoZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzIDw9IDAgfHwgZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzIDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gZWxsaXBzZUdlb21ldHJ5Ll9oZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgIDAsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjIKICAgICAgICApOwogICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyID0gZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIKICAgICAgICApOwogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICBjZW50ZXI6IGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgc2VtaU1ham9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzLAogICAgICAgICAgc2VtaU1pbm9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzLAogICAgICAgICAgZWxsaXBzb2lkOiBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCwKICAgICAgICAgIHJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgZ3JhbnVsYXJpdHk6IGVsbGlwc2VHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IGVsbGlwc2VHZW9tZXRyeS5fdmVydGV4Rm9ybWF0LAogICAgICAgICAgc3RSb3RhdGlvbjogZWxsaXBzZUdlb21ldHJ5Ll9zdFJvdGF0aW9uCiAgICAgICAgfTsKICAgICAgICBsZXQgZ2VvbWV0cnk7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIG9wdGlvbnMuc2hhZG93Vm9sdW1lID0gZWxsaXBzZUdlb21ldHJ5Ll9zaGFkb3dWb2x1bWU7CiAgICAgICAgICBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgZ2VvbWV0cnkgPSBjb21wdXRlRXh0cnVkZWRFbGxpcHNlKG9wdGlvbnMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW9tZXRyeSA9IGNvbXB1dGVFbGxpcHNlKG9wdGlvbnMpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogZWxsaXBzZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRWxsaXBzZUdlb21ldHJ5LmNyZWF0ZVNoYWRvd1ZvbHVtZSA9IGZ1bmN0aW9uKGVsbGlwc2VHZW9tZXRyeSwgbWluSGVpZ2h0RnVuYywgbWF4SGVpZ2h0RnVuYykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5IZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1heEhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNlR2VvbWV0cnkoewogICAgICAgICAgY2VudGVyOiBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICAgIHNlbWlNYWpvckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpcywKICAgICAgICAgIHNlbWlNaW5vckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpcywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgc3RSb3RhdGlvbjogZWxsaXBzZUdlb21ldHJ5Ll9zdFJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBleHRydWRlZEhlaWdodDogbWluSGVpZ2h0LAogICAgICAgICAgaGVpZ2h0OiBtYXhIZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFksCiAgICAgICAgICBzaGFkb3dWb2x1bWU6IHRydWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRWxsaXBzZUdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9yZWN0YW5nbGUpKSB7CiAgICAgICAgICAgICAgdGhpcy5fcmVjdGFuZ2xlID0gY29tcHV0ZVJlY3RhbmdsZSgKICAgICAgICAgICAgICAgIHRoaXMuX2NlbnRlciwKICAgICAgICAgICAgICAgIHRoaXMuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgICAgICAgICB0aGlzLl9zZW1pTWlub3JBeGlzLAogICAgICAgICAgICAgICAgdGhpcy5fcm90YXRpb24sCiAgICAgICAgICAgICAgICB0aGlzLl9ncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIHRoaXMuX2VsbGlwc29pZAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEZvciByZW1hcHBpbmcgdGV4dHVyZSBjb29yZGluYXRlcyB3aGVuIHJlbmRlcmluZyBFbGxpcHNlR2VvbWV0cmllcyBhcyBHcm91bmRQcmltaXRpdmVzLgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cykpIHsKICAgICAgICAgICAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdCA9IEVsbGlwc2VHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NpcmNsZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gQ2lyY2xlR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCByYWRpdXMgPSBvcHRpb25zLnJhZGl1czsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigicmFkaXVzIiwgcmFkaXVzKTsKICAgIGNvbnN0IGVsbGlwc2VHZW9tZXRyeU9wdGlvbnMgPSB7CiAgICAgIGNlbnRlcjogb3B0aW9ucy5jZW50ZXIsCiAgICAgIHNlbWlNYWpvckF4aXM6IHJhZGl1cywKICAgICAgc2VtaU1pbm9yQXhpczogcmFkaXVzLAogICAgICBlbGxpcHNvaWQ6IG9wdGlvbnMuZWxsaXBzb2lkLAogICAgICBoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LAogICAgICBleHRydWRlZEhlaWdodDogb3B0aW9ucy5leHRydWRlZEhlaWdodCwKICAgICAgZ3JhbnVsYXJpdHk6IG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQsCiAgICAgIHN0Um90YXRpb246IG9wdGlvbnMuc3RSb3RhdGlvbiwKICAgICAgc2hhZG93Vm9sdW1lOiBvcHRpb25zLnNoYWRvd1ZvbHVtZQogICAgfTsKICAgIHRoaXMuX2VsbGlwc2VHZW9tZXRyeSA9IG5ldyBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnlPcHRpb25zKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ2lyY2xlR2VvbWV0cnkiOwogIH0KICB2YXIgc2NyYXRjaEVsbGlwc2VHZW9tZXRyeSwgc2NyYXRjaE9wdGlvbnM0LCBDaXJjbGVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0NpcmNsZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DaXJjbGVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc2VHZW9tZXRyeSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBDaXJjbGVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIENpcmNsZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIHJldHVybiBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNlR2VvbWV0cnksIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc2VHZW9tZXRyeSA9IG5ldyBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgY2VudGVyOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgc2VtaU1ham9yQXhpczogMSwKICAgICAgICBzZW1pTWlub3JBeGlzOiAxCiAgICAgIH0pOwogICAgICBzY3JhdGNoT3B0aW9uczQgPSB7CiAgICAgICAgY2VudGVyOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgcmFkaXVzOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KSwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKSwKICAgICAgICBzdFJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgc2VtaU1ham9yQXhpczogdm9pZCAwLAogICAgICAgIHNlbWlNaW5vckF4aXM6IHZvaWQgMCwKICAgICAgICBzaGFkb3dWb2x1bWU6IHZvaWQgMAogICAgICB9OwogICAgICBDaXJjbGVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzZUdlb21ldHJ5ID0gRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaEVsbGlwc2VHZW9tZXRyeQogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmNlbnRlcgogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczQuZWxsaXBzb2lkCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZAogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmhlaWdodCA9IGVsbGlwc2VHZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIHNjcmF0Y2hPcHRpb25zNC5leHRydWRlZEhlaWdodCA9IGVsbGlwc2VHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmdyYW51bGFyaXR5ID0gZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBzY3JhdGNoT3B0aW9uczQudmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX3ZlcnRleEZvcm1hdCwKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNC52ZXJ0ZXhGb3JtYXQKICAgICAgICApOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNC5zdFJvdGF0aW9uID0gZWxsaXBzZUdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNC5zaGFkb3dWb2x1bWUgPSBlbGxpcHNlR2VvbWV0cnkuX3NoYWRvd1ZvbHVtZTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczQucmFkaXVzID0gZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzOwogICAgICAgICAgcmV0dXJuIG5ldyBDaXJjbGVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczQpOwogICAgICAgIH0KICAgICAgICBzY3JhdGNoT3B0aW9uczQuc2VtaU1ham9yQXhpcyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpczsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuc2VtaU1pbm9yQXhpcyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpczsKICAgICAgICByZXN1bHQuX2VsbGlwc2VHZW9tZXRyeSA9IG5ldyBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdChzY3JhdGNoT3B0aW9uczQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENpcmNsZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oY2lyY2xlR2VvbWV0cnkpIHsKICAgICAgICByZXR1cm4gRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeSk7CiAgICAgIH07CiAgICAgIENpcmNsZUdlb21ldHJ5LmNyZWF0ZVNoYWRvd1ZvbHVtZSA9IGZ1bmN0aW9uKGNpcmNsZUdlb21ldHJ5LCBtaW5IZWlnaHRGdW5jLCBtYXhIZWlnaHRGdW5jKSB7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0ID0gbWluSGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSBtYXhIZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIHJldHVybiBuZXcgQ2lyY2xlR2VvbWV0cnkoewogICAgICAgICAgY2VudGVyOiBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICByYWRpdXM6IGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdFJvdGF0aW9uOiBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9zdFJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBleHRydWRlZEhlaWdodDogbWluSGVpZ2h0LAogICAgICAgICAgaGVpZ2h0OiBtYXhIZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFksCiAgICAgICAgICBzaGFkb3dWb2x1bWU6IHRydWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ2lyY2xlR2VvbWV0cnkucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICByZWN0YW5nbGU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNlR2VvbWV0cnkucmVjdGFuZ2xlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogRm9yIHJlbWFwcGluZyB0ZXh0dXJlIGNvb3JkaW5hdGVzIHdoZW4gcmVuZGVyaW5nIENpcmNsZUdlb21ldHJpZXMgYXMgR3JvdW5kUHJpbWl0aXZlcy4KICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNlR2VvbWV0cnkudGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBDaXJjbGVHZW9tZXRyeV9kZWZhdWx0ID0gQ2lyY2xlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDaXJjbGVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVDaXJjbGVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ2lyY2xlR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ2lyY2xlR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUNpcmNsZUdlb21ldHJ5KGNpcmNsZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjaXJjbGVHZW9tZXRyeSA9IENpcmNsZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGNpcmNsZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIKICAgICk7CiAgICBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkCiAgICApOwogICAgcmV0dXJuIENpcmNsZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY2lyY2xlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQ2lyY2xlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDaXJjbGVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ2lyY2xlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaXJjbGVHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlQ2lyY2xlR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUNpcmNsZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNvbXB1dGVFbGxpcHNlMihvcHRpb25zKSB7CiAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBvcHRpb25zLmVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2VudGVyLCBib3VuZGluZ1NwaGVyZUNlbnRlcjIpLAogICAgICBvcHRpb25zLmhlaWdodCwKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyCiAgICApOwogICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgY2VudGVyLAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcjIsCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyMgogICAgKTsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiwKICAgICAgb3B0aW9ucy5zZW1pTWFqb3JBeGlzCiAgICApOwogICAgY29uc3QgcG9zaXRpb25zID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zKAogICAgICBvcHRpb25zLAogICAgICBmYWxzZSwKICAgICAgdHJ1ZQogICAgKS5vdXRlclBvc2l0aW9uczsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnJhaXNlUG9zaXRpb25zVG9IZWlnaHQoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBvcHRpb25zLAogICAgICAgICAgZmFsc2UKICAgICAgICApCiAgICAgIH0pCiAgICB9KTsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGxlbmd0aCwgbGVuZ3RoICogMik7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IChpICsgMSkgJSBsZW5ndGg7CiAgICB9CiAgICByZXR1cm4gewogICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUV4dHJ1ZGVkRWxsaXBzZTIob3B0aW9ucykgewogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBvcHRpb25zLmVsbGlwc29pZDsKICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICBsZXQgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2VudGVyLCBzY3JhdGNoQ2FydGVzaWFuMTQpLAogICAgICBvcHRpb25zLmhlaWdodCwKICAgICAgc2NyYXRjaENhcnRlc2lhbjE0CiAgICApOwogICAgdG9wQm91bmRpbmdTcGhlcmUyLmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgIGNlbnRlciwKICAgICAgc2NhbGVkTm9ybWFsLAogICAgICB0b3BCb3VuZGluZ1NwaGVyZTIuY2VudGVyCiAgICApOwogICAgdG9wQm91bmRpbmdTcGhlcmUyLnJhZGl1cyA9IHNlbWlNYWpvckF4aXM7CiAgICBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChjZW50ZXIsIHNjYWxlZE5vcm1hbCksCiAgICAgIG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgIHNjYWxlZE5vcm1hbAogICAgKTsKICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlMi5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBjZW50ZXIsCiAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmUyLmNlbnRlcgogICAgKTsKICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlMi5yYWRpdXMgPSBzZW1pTWFqb3JBeGlzOwogICAgbGV0IHBvc2l0aW9ucyA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlRWxsaXBzZVBvc2l0aW9ucygKICAgICAgb3B0aW9ucywKICAgICAgZmFsc2UsCiAgICAgIHRydWUKICAgICkub3V0ZXJQb3NpdGlvbnM7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KHsKICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5yYWlzZVBvc2l0aW9uc1RvSGVpZ2h0KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgb3B0aW9ucywKICAgICAgICAgIHRydWUKICAgICAgICApCiAgICAgIH0pCiAgICB9KTsKICAgIHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnVuaW9uKAogICAgICB0b3BCb3VuZGluZ1NwaGVyZTIsCiAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlMgogICAgKTsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgIGxldCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCk7CiAgICAgIGlmIChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICBhcHBseU9mZnNldCA9IGFwcGx5T2Zmc2V0LmZpbGwoMSwgMCwgbGVuZ3RoIC8gMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgYXBwbHlPZmZzZXQgPSBhcHBseU9mZnNldC5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgfQogICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgIH0pOwogICAgfQogICAgbGV0IG51bWJlck9mVmVydGljYWxMaW5lcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubnVtYmVyT2ZWZXJ0aWNhbExpbmVzLCAxNik7CiAgICBudW1iZXJPZlZlcnRpY2FsTGluZXMgPSBNYXRoX2RlZmF1bHQuY2xhbXAoCiAgICAgIG51bWJlck9mVmVydGljYWxMaW5lcywKICAgICAgMCwKICAgICAgbGVuZ3RoIC8gMgogICAgKTsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbGVuZ3RoLAogICAgICBsZW5ndGggKiAyICsgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzICogMgogICAgKTsKICAgIGxlbmd0aCAvPSAyOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBsZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSAoaSArIDEpICUgbGVuZ3RoICsgbGVuZ3RoOwogICAgfQogICAgbGV0IG51bVNpZGU7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNhbExpbmVzID4gMCkgewogICAgICBjb25zdCBudW1TaWRlTGluZXMgPSBNYXRoLm1pbihudW1iZXJPZlZlcnRpY2FsTGluZXMsIGxlbmd0aCk7CiAgICAgIG51bVNpZGUgPSBNYXRoLnJvdW5kKGxlbmd0aCAvIG51bVNpZGVMaW5lcyk7CiAgICAgIGNvbnN0IG1heEkgPSBNYXRoLm1pbihudW1TaWRlICogbnVtYmVyT2ZWZXJ0aWNhbExpbmVzLCBsZW5ndGgpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbWF4STsgaSArPSBudW1TaWRlKSB7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBsZW5ndGg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBFbGxpcHNlT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCk7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjZW50ZXIpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjZW50ZXIgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzZW1pTWFqb3JBeGlzKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2VtaU1ham9yQXhpcyBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlbWlNaW5vckF4aXMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZW1pTWlub3JBeGlzIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKHNlbWlNYWpvckF4aXMgPCBzZW1pTWlub3JBeGlzKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJzZW1pTWFqb3JBeGlzIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBzZW1pTWlub3JBeGlzLiIKICAgICAgKTsKICAgIH0KICAgIGlmIChncmFudWxhcml0eSA8PSAwKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJncmFudWxhcml0eSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgfQogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB0aGlzLl9zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgIHRoaXMuX3NlbWlNaW5vckF4aXMgPSBzZW1pTWlub3JBeGlzOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX3JvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICB0aGlzLl9oZWlnaHQgPSBNYXRoLm1heChleHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gTWF0aC5tYXgoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubnVtYmVyT2ZWZXJ0aWNhbExpbmVzLCAxNiksCiAgICAgIDAKICAgICk7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBzY3JhdGNoQ2FydGVzaWFuMTQsIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiwgdG9wQm91bmRpbmdTcGhlcmUyLCBib3R0b21Cb3VuZGluZ1NwaGVyZTIsIHNjcmF0Y2hDZW50ZXIzLCBzY3JhdGNoRWxsaXBzb2lkMiwgc2NyYXRjaE9wdGlvbnM1LCBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNlR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b3BCb3VuZGluZ1NwaGVyZTIgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTIgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA4OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX2NlbnRlciwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zZW1pTWlub3JBeGlzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcm90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9oZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaENlbnRlcjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQyID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zNSA9IHsKICAgICAgICBjZW50ZXI6IHNjcmF0Y2hDZW50ZXIzLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDIsCiAgICAgICAgc2VtaU1ham9yQXhpczogdm9pZCAwLAogICAgICAgIHNlbWlNaW5vckF4aXM6IHZvaWQgMCwKICAgICAgICByb3RhdGlvbjogdm9pZCAwLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaENlbnRlcjMpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQyKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG51bWJlck9mVmVydGljYWxMaW5lcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1LmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczUucm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5udW1iZXJPZlZlcnRpY2FsTGluZXMgPSBudW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczUub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgRWxsaXBzZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczUpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdC5fY2VudGVyKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fc2VtaU1ham9yQXhpcyA9IHNlbWlNYWpvckF4aXM7CiAgICAgICAgcmVzdWx0Ll9zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgICAgICByZXN1bHQuX3JvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX251bWJlck9mVmVydGljYWxMaW5lcyA9IG51bWJlck9mVmVydGljYWxMaW5lczsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGVsbGlwc2VHZW9tZXRyeSkgewogICAgICAgIGlmIChlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMgPD0gMCB8fCBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXMgPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGVsbGlwc2VHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIgPSBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlcgogICAgICAgICk7CiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICAgIGNlbnRlcjogZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBzZW1pTWFqb3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgICBzZW1pTWlub3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXMsCiAgICAgICAgICBlbGxpcHNvaWQ6IGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkLAogICAgICAgICAgcm90YXRpb246IGVsbGlwc2VHZW9tZXRyeS5fcm90YXRpb24sCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBncmFudWxhcml0eTogZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eSwKICAgICAgICAgIG51bWJlck9mVmVydGljYWxMaW5lczogZWxsaXBzZUdlb21ldHJ5Ll9udW1iZXJPZlZlcnRpY2FsTGluZXMKICAgICAgICB9OwogICAgICAgIGxldCBnZW9tZXRyeTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgb3B0aW9ucy5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPSBlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIGdlb21ldHJ5ID0gY29tcHV0ZUV4dHJ1ZGVkRWxsaXBzZTIob3B0aW9ucyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGdlb21ldHJ5ID0gY29tcHV0ZUVsbGlwc2UyKG9wdGlvbnMpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBFbGxpcHNlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gQ2lyY2xlT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmFkaXVzID0gb3B0aW9ucy5yYWRpdXM7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInJhZGl1cyIsIHJhZGl1cyk7CiAgICBjb25zdCBlbGxpcHNlR2VvbWV0cnlPcHRpb25zID0gewogICAgICBjZW50ZXI6IG9wdGlvbnMuY2VudGVyLAogICAgICBzZW1pTWFqb3JBeGlzOiByYWRpdXMsCiAgICAgIHNlbWlNaW5vckF4aXM6IHJhZGl1cywKICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgaGVpZ2h0OiBvcHRpb25zLmhlaWdodCwKICAgICAgZXh0cnVkZWRIZWlnaHQ6IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgIGdyYW51bGFyaXR5OiBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IG9wdGlvbnMubnVtYmVyT2ZWZXJ0aWNhbExpbmVzCiAgICB9OwogICAgdGhpcy5fZWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnlPcHRpb25zKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnkyLCBzY3JhdGNoT3B0aW9uczYsIENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0NpcmNsZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBDaXJjbGVPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgQ2lyY2xlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIHJldHVybiBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQucGFjaygKICAgICAgICAgIHZhbHVlLl9lbGxpcHNlR2VvbWV0cnksCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgKICAgICAgICApOwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzZUdlb21ldHJ5MiA9IG5ldyBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGNlbnRlcjogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHNlbWlNYWpvckF4aXM6IDEsCiAgICAgICAgc2VtaU1pbm9yQXhpczogMQogICAgICB9KTsKICAgICAgc2NyYXRjaE9wdGlvbnM2ID0gewogICAgICAgIGNlbnRlcjogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHJhZGl1czogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IHZvaWQgMCwKICAgICAgICBzZW1pTWFqb3JBeGlzOiB2b2lkIDAsCiAgICAgICAgc2VtaU1pbm9yQXhpczogdm9pZCAwCiAgICAgIH07CiAgICAgIENpcmNsZU91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzZUdlb21ldHJ5ID0gRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnkyCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczYuY2VudGVyCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNi5lbGxpcHNvaWQKICAgICAgICApOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5oZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuZXh0cnVkZWRIZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5ncmFudWxhcml0eSA9IGVsbGlwc2VHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM2Lm51bWJlck9mVmVydGljYWxMaW5lcyA9IGVsbGlwc2VHZW9tZXRyeS5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNi5yYWRpdXMgPSBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgICByZXR1cm4gbmV3IENpcmNsZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczYpOwogICAgICAgIH0KICAgICAgICBzY3JhdGNoT3B0aW9uczYuc2VtaU1ham9yQXhpcyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpczsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuc2VtaU1pbm9yQXhpcyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpczsKICAgICAgICByZXN1bHQuX2VsbGlwc2VHZW9tZXRyeSA9IG5ldyBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoc2NyYXRjaE9wdGlvbnM2KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDaXJjbGVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjaXJjbGVHZW9tZXRyeSkgewogICAgICAgIHJldHVybiBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeSk7CiAgICAgIH07CiAgICAgIENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gQ2lyY2xlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5KGNpcmNsZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjaXJjbGVHZW9tZXRyeSA9IENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhjaXJjbGVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fY2VudGVyCiAgICApOwogICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBDaXJjbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjaXJjbGVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NpcmNsZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9hcnJheVJlbW92ZUR1cGxpY2F0ZXMuanMKICBmdW5jdGlvbiBhcnJheVJlbW92ZUR1cGxpY2F0ZXModmFsdWVzLCBlcXVhbHNFcHNpbG9uLCB3cmFwQXJvdW5kLCByZW1vdmVkSW5kaWNlcykgewogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJlcXVhbHNFcHNpbG9uIiwgZXF1YWxzRXBzaWxvbik7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZXMpKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICB3cmFwQXJvdW5kID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod3JhcEFyb3VuZCwgZmFsc2UpOwogICAgY29uc3Qgc3RvcmVSZW1vdmVkSW5kaWNlcyA9IGRlZmluZWRfZGVmYXVsdChyZW1vdmVkSW5kaWNlcyk7CiAgICBjb25zdCBsZW5ndGggPSB2YWx1ZXMubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0KICAgIGxldCBpOwogICAgbGV0IHYwMiA9IHZhbHVlc1swXTsKICAgIGxldCB2MTI7CiAgICBsZXQgY2xlYW5lZFZhbHVlczsKICAgIGxldCBsYXN0Q2xlYW5JbmRleCA9IDA7CiAgICBsZXQgcmVtb3ZlZEluZGV4TENJID0gLTE7CiAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgdjEyID0gdmFsdWVzW2ldOwogICAgICBpZiAoZXF1YWxzRXBzaWxvbih2MDIsIHYxMiwgcmVtb3ZlRHVwbGljYXRlc0Vwc2lsb24pKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykpIHsKICAgICAgICAgIGNsZWFuZWRWYWx1ZXMgPSB2YWx1ZXMuc2xpY2UoMCwgaSk7CiAgICAgICAgICBsYXN0Q2xlYW5JbmRleCA9IGkgLSAxOwogICAgICAgICAgcmVtb3ZlZEluZGV4TENJID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKHN0b3JlUmVtb3ZlZEluZGljZXMpIHsKICAgICAgICAgIHJlbW92ZWRJbmRpY2VzLnB1c2goaSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykpIHsKICAgICAgICAgIGNsZWFuZWRWYWx1ZXMucHVzaCh2MTIpOwogICAgICAgICAgbGFzdENsZWFuSW5kZXggPSBpOwogICAgICAgICAgaWYgKHN0b3JlUmVtb3ZlZEluZGljZXMpIHsKICAgICAgICAgICAgcmVtb3ZlZEluZGV4TENJID0gcmVtb3ZlZEluZGljZXMubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2MDIgPSB2MTI7CiAgICAgIH0KICAgIH0KICAgIGlmICh3cmFwQXJvdW5kICYmIGVxdWFsc0Vwc2lsb24odmFsdWVzWzBdLCB2YWx1ZXNbbGVuZ3RoIC0gMV0sIHJlbW92ZUR1cGxpY2F0ZXNFcHNpbG9uKSkgewogICAgICBpZiAoc3RvcmVSZW1vdmVkSW5kaWNlcykgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykpIHsKICAgICAgICAgIHJlbW92ZWRJbmRpY2VzLnNwbGljZShyZW1vdmVkSW5kZXhMQ0ksIDAsIGxhc3RDbGVhbkluZGV4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVtb3ZlZEluZGljZXMucHVzaChsZW5ndGggLSAxKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjbGVhbmVkVmFsdWVzKSkgewogICAgICAgIGNsZWFuZWRWYWx1ZXMubGVuZ3RoIC09IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2xlYW5lZFZhbHVlcyA9IHZhbHVlcy5zbGljZSgwLCAtMSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykgPyBjbGVhbmVkVmFsdWVzIDogdmFsdWVzOwogIH0KICB2YXIgcmVtb3ZlRHVwbGljYXRlc0Vwc2lsb24sIGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0OwogIHZhciBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYXJyYXlSZW1vdmVEdXBsaWNhdGVzLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHJlbW92ZUR1cGxpY2F0ZXNFcHNpbG9uID0gTWF0aF9kZWZhdWx0LkVQU0lMT04xMDsKICAgICAgYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3VuZGluZ1JlY3RhbmdsZS5qcwogIGZ1bmN0aW9uIEJvdW5kaW5nUmVjdGFuZ2xlKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKICAgIHRoaXMueCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgdGhpcy55ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeSwgMCk7CiAgICB0aGlzLndpZHRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod2lkdGgsIDApOwogICAgdGhpcy5oZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoZWlnaHQsIDApOwogIH0KICB2YXIgZGVmYXVsdFByb2plY3Rpb24yLCBmcm9tUmVjdGFuZ2xlTG93ZXJMZWZ0LCBmcm9tUmVjdGFuZ2xlVXBwZXJSaWdodCwgQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdDsKICB2YXIgaW5pdF9Cb3VuZGluZ1JlY3RhbmdsZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQm91bmRpbmdSZWN0YW5nbGUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X0ludGVyc2VjdCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wYWNrZWRMZW5ndGggPSA0OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUud2lkdGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5oZWlnaHQ7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LndpZHRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUuZnJvbVBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LnggPSAwOwogICAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgICAgcmVzdWx0LndpZHRoID0gMDsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgbWluaW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWluaW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBsZXQgbWF4aW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWF4aW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgY29uc3QgeCA9IHAueDsKICAgICAgICAgIGNvbnN0IHkgPSBwLnk7CiAgICAgICAgICBtaW5pbXVtWCA9IE1hdGgubWluKHgsIG1pbmltdW1YKTsKICAgICAgICAgIG1heGltdW1YID0gTWF0aC5tYXgoeCwgbWF4aW11bVgpOwogICAgICAgICAgbWluaW11bVkgPSBNYXRoLm1pbih5LCBtaW5pbXVtWSk7CiAgICAgICAgICBtYXhpbXVtWSA9IE1hdGgubWF4KHksIG1heGltdW1ZKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBtaW5pbXVtWDsKICAgICAgICByZXN1bHQueSA9IG1pbmltdW1ZOwogICAgICAgIHJlc3VsdC53aWR0aCA9IG1heGltdW1YIC0gbWluaW11bVg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IG1heGltdW1ZIC0gbWluaW11bVk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZGVmYXVsdFByb2plY3Rpb24yID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZUxvd2VyTGVmdCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlVXBwZXJSaWdodCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5mcm9tUmVjdGFuZ2xlID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBwcm9qZWN0aW9uLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICAgICAgcmVzdWx0LnggPSAwOwogICAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgICAgcmVzdWx0LndpZHRoID0gMDsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdFByb2plY3Rpb24yLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0OwogICAgICAgIHByb2plY3Rpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChwcm9qZWN0aW9uLCBkZWZhdWx0UHJvamVjdGlvbjIpOwogICAgICAgIGNvbnN0IGxvd2VyTGVmdCA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0LnNvdXRod2VzdChyZWN0YW5nbGUsIGZyb21SZWN0YW5nbGVMb3dlckxlZnQpCiAgICAgICAgKTsKICAgICAgICBjb25zdCB1cHBlclJpZ2h0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQubm9ydGhlYXN0KHJlY3RhbmdsZSwgZnJvbVJlY3RhbmdsZVVwcGVyUmlnaHQpCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3QodXBwZXJSaWdodCwgbG93ZXJMZWZ0LCB1cHBlclJpZ2h0KTsKICAgICAgICByZXN1bHQueCA9IGxvd2VyTGVmdC54OwogICAgICAgIHJlc3VsdC55ID0gbG93ZXJMZWZ0Lnk7CiAgICAgICAgcmVzdWx0LndpZHRoID0gdXBwZXJSaWdodC54OwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSB1cHBlclJpZ2h0Lnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUuY2xvbmUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQm91bmRpbmdSZWN0YW5nbGUoCiAgICAgICAgICAgIHJlY3RhbmdsZS54LAogICAgICAgICAgICByZWN0YW5nbGUueSwKICAgICAgICAgICAgcmVjdGFuZ2xlLndpZHRoLAogICAgICAgICAgICByZWN0YW5nbGUuaGVpZ2h0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHJlY3RhbmdsZS54OwogICAgICAgIHJlc3VsdC55ID0gcmVjdGFuZ2xlLnk7CiAgICAgICAgcmVzdWx0LndpZHRoID0gcmVjdGFuZ2xlLndpZHRoOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSByZWN0YW5nbGUuaGVpZ2h0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLnVuaW9uID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxvd2VyTGVmdFggPSBNYXRoLm1pbihsZWZ0LngsIHJpZ2h0LngpOwogICAgICAgIGNvbnN0IGxvd2VyTGVmdFkgPSBNYXRoLm1pbihsZWZ0LnksIHJpZ2h0LnkpOwogICAgICAgIGNvbnN0IHVwcGVyUmlnaHRYID0gTWF0aC5tYXgobGVmdC54ICsgbGVmdC53aWR0aCwgcmlnaHQueCArIHJpZ2h0LndpZHRoKTsKICAgICAgICBjb25zdCB1cHBlclJpZ2h0WSA9IE1hdGgubWF4KGxlZnQueSArIGxlZnQuaGVpZ2h0LCByaWdodC55ICsgcmlnaHQuaGVpZ2h0KTsKICAgICAgICByZXN1bHQueCA9IGxvd2VyTGVmdFg7CiAgICAgICAgcmVzdWx0LnkgPSBsb3dlckxlZnRZOwogICAgICAgIHJlc3VsdC53aWR0aCA9IHVwcGVyUmlnaHRYIC0gbG93ZXJMZWZ0WDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gdXBwZXJSaWdodFkgLSBsb3dlckxlZnRZOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLmV4cGFuZCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcG9pbnQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIHJlc3VsdCA9IEJvdW5kaW5nUmVjdGFuZ2xlLmNsb25lKHJlY3RhbmdsZSwgcmVzdWx0KTsKICAgICAgICBjb25zdCB3aWR0aCA9IHBvaW50LnggLSByZXN1bHQueDsKICAgICAgICBjb25zdCBoZWlnaHQgPSBwb2ludC55IC0gcmVzdWx0Lnk7CiAgICAgICAgaWYgKHdpZHRoID4gcmVzdWx0LndpZHRoKSB7CiAgICAgICAgICByZXN1bHQud2lkdGggPSB3aWR0aDsKICAgICAgICB9IGVsc2UgaWYgKHdpZHRoIDwgMCkgewogICAgICAgICAgcmVzdWx0LndpZHRoIC09IHdpZHRoOwogICAgICAgICAgcmVzdWx0LnggPSBwb2ludC54OwogICAgICAgIH0KICAgICAgICBpZiAoaGVpZ2h0ID4gcmVzdWx0LmhlaWdodCkgewogICAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICB9IGVsc2UgaWYgKGhlaWdodCA8IDApIHsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgLT0gaGVpZ2h0OwogICAgICAgICAgcmVzdWx0LnkgPSBwb2ludC55OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5pbnRlcnNlY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgY29uc3QgbGVmdFggPSBsZWZ0Lng7CiAgICAgICAgY29uc3QgbGVmdFkgPSBsZWZ0Lnk7CiAgICAgICAgY29uc3QgcmlnaHRYID0gcmlnaHQueDsKICAgICAgICBjb25zdCByaWdodFkgPSByaWdodC55OwogICAgICAgIGlmICghKGxlZnRYID4gcmlnaHRYICsgcmlnaHQud2lkdGggfHwgbGVmdFggKyBsZWZ0LndpZHRoIDwgcmlnaHRYIHx8IGxlZnRZICsgbGVmdC5oZWlnaHQgPCByaWdodFkgfHwgbGVmdFkgPiByaWdodFkgKyByaWdodC5oZWlnaHQpKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HOwogICAgICAgIH0KICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERTsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC54ID09PSByaWdodC54ICYmIGxlZnQueSA9PT0gcmlnaHQueSAmJiBsZWZ0LndpZHRoID09PSByaWdodC53aWR0aCAmJiBsZWZ0LmhlaWdodCA9PT0gcmlnaHQuaGVpZ2h0OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gQm91bmRpbmdSZWN0YW5nbGUuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUucHJvdG90eXBlLmludGVyc2VjdCA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nUmVjdGFuZ2xlLmludGVyc2VjdCh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1JlY3RhbmdsZS5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0ID0gQm91bmRpbmdSZWN0YW5nbGU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BeGlzQWxpZ25lZEJvdW5kaW5nQm94LmpzCiAgZnVuY3Rpb24gQXhpc0FsaWduZWRCb3VuZGluZ0JveChtaW5pbXVtLCBtYXhpbXVtLCBjZW50ZXIpIHsKICAgIHRoaXMubWluaW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShkZWZhdWx0VmFsdWVfZGVmYXVsdChtaW5pbXVtLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpOwogICAgdGhpcy5tYXhpbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1heGltdW0sIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjZW50ZXIpKSB7CiAgICAgIGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludCh0aGlzLm1pbmltdW0sIHRoaXMubWF4aW11bSwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpKTsKICAgIH0gZWxzZSB7CiAgICAgIGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIpOwogICAgfQogICAgdGhpcy5jZW50ZXIgPSBjZW50ZXI7CiAgfQogIHZhciBpbnRlcnNlY3RTY3JhdGNoLCBBeGlzQWxpZ25lZEJvdW5kaW5nQm94X2RlZmF1bHQ7CiAgdmFyIGluaXRfQXhpc0FsaWduZWRCb3VuZGluZ0JveCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQXhpc0FsaWduZWRCb3VuZGluZ0JveC5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0ludGVyc2VjdCgpOwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmZyb21Db3JuZXJzID0gZnVuY3Rpb24obWluaW11bSwgbWF4aW11bSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJtaW5pbXVtIiwgbWluaW11bSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJtYXhpbXVtIiwgbWF4aW11bSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEF4aXNBbGlnbmVkQm91bmRpbmdCb3goKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lm1pbmltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobWluaW11bSwgcmVzdWx0Lm1pbmltdW0pOwogICAgICAgIHJlc3VsdC5tYXhpbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1heGltdW0sIHJlc3VsdC5tYXhpbXVtKTsKICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KG1pbmltdW0sIG1heGltdW0sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guZnJvbVBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEF4aXNBbGlnbmVkQm91bmRpbmdCb3goKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQubWluaW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0Lm1pbmltdW0pOwogICAgICAgICAgcmVzdWx0Lm1heGltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5tYXhpbXVtKTsKICAgICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbmltdW1YID0gcG9zaXRpb25zWzBdLng7CiAgICAgICAgbGV0IG1pbmltdW1ZID0gcG9zaXRpb25zWzBdLnk7CiAgICAgICAgbGV0IG1pbmltdW1aID0gcG9zaXRpb25zWzBdLno7CiAgICAgICAgbGV0IG1heGltdW1YID0gcG9zaXRpb25zWzBdLng7CiAgICAgICAgbGV0IG1heGltdW1ZID0gcG9zaXRpb25zWzBdLnk7CiAgICAgICAgbGV0IG1heGltdW1aID0gcG9zaXRpb25zWzBdLno7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgY29uc3QgeCA9IHAueDsKICAgICAgICAgIGNvbnN0IHkgPSBwLnk7CiAgICAgICAgICBjb25zdCB6ID0gcC56OwogICAgICAgICAgbWluaW11bVggPSBNYXRoLm1pbih4LCBtaW5pbXVtWCk7CiAgICAgICAgICBtYXhpbXVtWCA9IE1hdGgubWF4KHgsIG1heGltdW1YKTsKICAgICAgICAgIG1pbmltdW1ZID0gTWF0aC5taW4oeSwgbWluaW11bVkpOwogICAgICAgICAgbWF4aW11bVkgPSBNYXRoLm1heCh5LCBtYXhpbXVtWSk7CiAgICAgICAgICBtaW5pbXVtWiA9IE1hdGgubWluKHosIG1pbmltdW1aKTsKICAgICAgICAgIG1heGltdW1aID0gTWF0aC5tYXgoeiwgbWF4aW11bVopOwogICAgICAgIH0KICAgICAgICBjb25zdCBtaW5pbXVtID0gcmVzdWx0Lm1pbmltdW07CiAgICAgICAgbWluaW11bS54ID0gbWluaW11bVg7CiAgICAgICAgbWluaW11bS55ID0gbWluaW11bVk7CiAgICAgICAgbWluaW11bS56ID0gbWluaW11bVo7CiAgICAgICAgY29uc3QgbWF4aW11bSA9IHJlc3VsdC5tYXhpbXVtOwogICAgICAgIG1heGltdW0ueCA9IG1heGltdW1YOwogICAgICAgIG1heGltdW0ueSA9IG1heGltdW1ZOwogICAgICAgIG1heGltdW0ueiA9IG1heGltdW1aOwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQobWluaW11bSwgbWF4aW11bSwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5jbG9uZSA9IGZ1bmN0aW9uKGJveCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm94KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBBeGlzQWxpZ25lZEJvdW5kaW5nQm94KGJveC5taW5pbXVtLCBib3gubWF4aW11bSwgYm94LmNlbnRlcik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5taW5pbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGJveC5taW5pbXVtLCByZXN1bHQubWluaW11bSk7CiAgICAgICAgcmVzdWx0Lm1heGltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYm94Lm1heGltdW0sIHJlc3VsdC5tYXhpbXVtKTsKICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGJveC5jZW50ZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhsZWZ0LmNlbnRlciwgcmlnaHQuY2VudGVyKSAmJiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGxlZnQubWluaW11bSwgcmlnaHQubWluaW11bSkgJiYgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhsZWZ0Lm1heGltdW0sIHJpZ2h0Lm1heGltdW0pOwogICAgICB9OwogICAgICBpbnRlcnNlY3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24oYm94LCBwbGFuZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYm94IiwgYm94KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBsYW5lIiwgcGxhbmUpOwogICAgICAgIGludGVyc2VjdFNjcmF0Y2ggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBib3gubWF4aW11bSwKICAgICAgICAgIGJveC5taW5pbXVtLAogICAgICAgICAgaW50ZXJzZWN0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgaCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgaW50ZXJzZWN0U2NyYXRjaCwKICAgICAgICAgIDAuNSwKICAgICAgICAgIGludGVyc2VjdFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgZSA9IGgueCAqIE1hdGguYWJzKG5vcm1hbDIueCkgKyBoLnkgKiBNYXRoLmFicyhub3JtYWwyLnkpICsgaC56ICogTWF0aC5hYnMobm9ybWFsMi56KTsKICAgICAgICBjb25zdCBzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChib3guY2VudGVyLCBub3JtYWwyKSArIHBsYW5lLmRpc3RhbmNlOwogICAgICAgIGlmIChzIC0gZSA+IDApIHsKICAgICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5JTlNJREU7CiAgICAgICAgfQogICAgICAgIGlmIChzICsgZSA8IDApIHsKICAgICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5PVVRTSURFOwogICAgICAgIH0KICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HOwogICAgICB9OwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3gucHJvdG90eXBlLmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24ocGxhbmUpIHsKICAgICAgICByZXR1cm4gQXhpc0FsaWduZWRCb3VuZGluZ0JveC5pbnRlcnNlY3RQbGFuZSh0aGlzLCBwbGFuZSk7CiAgICAgIH07CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3gucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0ID0gQXhpc0FsaWduZWRCb3VuZGluZ0JveDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZFRhbmdlbnRQbGFuZS5qcwogIGZ1bmN0aW9uIEVsbGlwc29pZFRhbmdlbnRQbGFuZShvcmlnaW4sIGVsbGlwc29pZCkgewogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcmlnaW4iLCBvcmlnaW4pOwogICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KTsKICAgIG9yaWdpbiA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKG9yaWdpbik7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcmlnaW4pKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcmlnaW4gbXVzdCBub3QgYmUgYXQgdGhlIGNlbnRlciBvZiB0aGUgZWxsaXBzb2lkLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGVhc3ROb3J0aFVwID0gVHJhbnNmb3Jtc19kZWZhdWx0LmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKG9yaWdpbiwgZWxsaXBzb2lkKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgIHRoaXMuX29yaWdpbiA9IG9yaWdpbjsKICAgIHRoaXMuX3hBeGlzID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KAogICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0Q29sdW1uKGVhc3ROb3J0aFVwLCAwLCBzY3JhdGNoQ2FydDQpCiAgICApOwogICAgdGhpcy5feUF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQoCiAgICAgIE1hdHJpeDRfZGVmYXVsdC5nZXRDb2x1bW4oZWFzdE5vcnRoVXAsIDEsIHNjcmF0Y2hDYXJ0NCkKICAgICk7CiAgICBjb25zdCBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KAogICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0Q29sdW1uKGVhc3ROb3J0aFVwLCAyLCBzY3JhdGNoQ2FydDQpCiAgICApOwogICAgdGhpcy5fcGxhbmUgPSBQbGFuZV9kZWZhdWx0LmZyb21Qb2ludE5vcm1hbChvcmlnaW4sIG5vcm1hbDIpOwogIH0KICB2YXIgc2NyYXRjaENhcnQ0LCB0bXAsIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXksIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zLCBwcm9qZWN0UG9pbnRzT250b0VsbGlwc29pZFNjcmF0Y2gsIEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkVGFuZ2VudFBsYW5lLmpzIigpIHsKICAgICAgaW5pdF9BeGlzQWxpZ25lZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9QbGFuZSgpOwogICAgICBpbml0X1JheSgpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgc2NyYXRjaENhcnQ0ID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcmlnaW4uCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICBvcmlnaW46IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vcmlnaW47CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBwbGFuZSB3aGljaCBpcyB0YW5nZW50IHRvIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7UGxhbmV9CiAgICAgICAgICovCiAgICAgICAgcGxhbmU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wbGFuZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGxvY2FsIFgtYXhpcyAoZWFzdCkgb2YgdGhlIHRhbmdlbnQgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICB4QXhpczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3hBeGlzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbG9jYWwgWS1heGlzIChub3J0aCkgb2YgdGhlIHRhbmdlbnQgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICB5QXhpczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3lBeGlzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbG9jYWwgWi1heGlzICh1cCkgb2YgdGhlIHRhbmdlbnQgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICB6QXhpczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BsYW5lLm5vcm1hbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICB0bXAgPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5mcm9tUG9pbnRzID0gZnVuY3Rpb24oY2FydGVzaWFucywgZWxsaXBzb2lkKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgY29uc3QgYm94ID0gQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21Qb2ludHMoY2FydGVzaWFucywgdG1wKTsKICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZShib3guY2VudGVyLCBlbGxpcHNvaWQpOwogICAgICB9OwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5ID0gbmV3IFJheV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludE9udG9QbGFuZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBjb25zdCByYXkgPSBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5OwogICAgICAgIHJheS5vcmlnaW4gPSBjYXJ0ZXNpYW4xMTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNhcnRlc2lhbjExLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgcmF5LAogICAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uUG9pbnQpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgICByYXksCiAgICAgICAgICAgIHRoaXMuX3BsYW5lLAogICAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb25Qb2ludCkpIHsKICAgICAgICAgIGNvbnN0IHYzID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludCwKICAgICAgICAgICAgdGhpcy5fb3JpZ2luLAogICAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRoaXMuX3hBeGlzLCB2Myk7CiAgICAgICAgICBjb25zdCB5ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0aGlzLl95QXhpcywgdjMpOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4LCB5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUucHJvamVjdFBvaW50c09udG9QbGFuZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbnMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFucyIsIGNhcnRlc2lhbnMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRlc2lhbnMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnByb2plY3RQb2ludE9udG9QbGFuZShjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbY291bnRdKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocCkpIHsKICAgICAgICAgICAgcmVzdWx0W2NvdW50XSA9IHA7CiAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sZW5ndGggPSBjb3VudDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCByYXkgPSBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5OwogICAgICAgIHJheS5vcmlnaW4gPSBjYXJ0ZXNpYW4xMTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUodGhpcy5fcGxhbmUubm9ybWFsLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgcmF5LAogICAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uUG9pbnQpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgICByYXksCiAgICAgICAgICAgIHRoaXMuX3BsYW5lLAogICAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludCwKICAgICAgICAgIHRoaXMuX29yaWdpbiwKICAgICAgICAgIGludGVyc2VjdGlvblBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCB4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0aGlzLl94QXhpcywgdjMpOwogICAgICAgIGNvbnN0IHkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRoaXMuX3lBeGlzLCB2Myk7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludHNUb05lYXJlc3RPblBsYW5lID0gZnVuY3Rpb24oY2FydGVzaWFucywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRlc2lhbnMubGVuZ3RoOwogICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKGNhcnRlc2lhbnNbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHByb2plY3RQb2ludHNPbnRvRWxsaXBzb2lkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZS5wcm9qZWN0UG9pbnRPbnRvRWxsaXBzb2lkID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IHRoaXMuX29yaWdpbjsKICAgICAgICBjb25zdCB4QXhpcyA9IHRoaXMuX3hBeGlzOwogICAgICAgIGNvbnN0IHlBeGlzID0gdGhpcy5feUF4aXM7CiAgICAgICAgY29uc3QgdG1wMiA9IHByb2plY3RQb2ludHNPbnRvRWxsaXBzb2lkU2NyYXRjaDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih4QXhpcywgY2FydGVzaWFuMTEueCwgdG1wMik7CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChvcmlnaW4sIHRtcDIsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoeUF4aXMsIGNhcnRlc2lhbjExLnksIHRtcDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0LCB0bXAyLCByZXN1bHQpOwogICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvY2VudHJpY1N1cmZhY2UocmVzdWx0LCByZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUucHJvamVjdFBvaW50c09udG9FbGxpcHNvaWQgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBjYXJ0ZXNpYW5zLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5wcm9qZWN0UG9pbnRPbnRvRWxsaXBzb2lkKGNhcnRlc2lhbnNbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0ID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT3JpZW50ZWRCb3VuZGluZ0JveC5qcwogIGZ1bmN0aW9uIE9yaWVudGVkQm91bmRpbmdCb3goY2VudGVyLCBoYWxmQXhlcykgewogICAgdGhpcy5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpOwogICAgdGhpcy5oYWxmQXhlcyA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShkZWZhdWx0VmFsdWVfZGVmYXVsdChoYWxmQXhlcywgTWF0cml4M19kZWZhdWx0LlpFUk8pKTsKICB9CiAgZnVuY3Rpb24gZnJvbVBsYW5lRXh0ZW50cyhwbGFuZU9yaWdpbiwgcGxhbmVYQXhpcywgcGxhbmVZQXhpcywgcGxhbmVaQXhpcywgbWluaW11bVgsIG1heGltdW1YLCBtaW5pbXVtWSwgbWF4aW11bVksIG1pbmltdW1aLCBtYXhpbXVtWiwgcmVzdWx0KSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtaW5pbXVtWCkgfHwgIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtWCkgfHwgIWRlZmluZWRfZGVmYXVsdChtaW5pbXVtWSkgfHwgIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtWSkgfHwgIWRlZmluZWRfZGVmYXVsdChtaW5pbXVtWikgfHwgIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtWikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgImFsbCBleHRlbnRzIChtaW5pbXVtL21heGltdW0gWC9ZL1opIGFyZSByZXF1aXJlZC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICB9CiAgICBjb25zdCBoYWxmQXhlcyA9IHJlc3VsdC5oYWxmQXhlczsKICAgIE1hdHJpeDNfZGVmYXVsdC5zZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHBsYW5lWEF4aXMsIGhhbGZBeGVzKTsKICAgIE1hdHJpeDNfZGVmYXVsdC5zZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHBsYW5lWUF4aXMsIGhhbGZBeGVzKTsKICAgIE1hdHJpeDNfZGVmYXVsdC5zZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHBsYW5lWkF4aXMsIGhhbGZBeGVzKTsKICAgIGxldCBjZW50ZXJPZmZzZXQgPSBzY3JhdGNoT2Zmc2V0OwogICAgY2VudGVyT2Zmc2V0LnggPSAobWluaW11bVggKyBtYXhpbXVtWCkgLyAyOwogICAgY2VudGVyT2Zmc2V0LnkgPSAobWluaW11bVkgKyBtYXhpbXVtWSkgLyAyOwogICAgY2VudGVyT2Zmc2V0LnogPSAobWluaW11bVogKyBtYXhpbXVtWikgLyAyOwogICAgY29uc3Qgc2NhbGUgPSBzY3JhdGNoU2NhbGUyOwogICAgc2NhbGUueCA9IChtYXhpbXVtWCAtIG1pbmltdW1YKSAvIDI7CiAgICBzY2FsZS55ID0gKG1heGltdW1ZIC0gbWluaW11bVkpIC8gMjsKICAgIHNjYWxlLnogPSAobWF4aW11bVogLSBtaW5pbXVtWikgLyAyOwogICAgY29uc3QgY2VudGVyID0gcmVzdWx0LmNlbnRlcjsKICAgIGNlbnRlck9mZnNldCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKGhhbGZBeGVzLCBjZW50ZXJPZmZzZXQsIGNlbnRlck9mZnNldCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBsYW5lT3JpZ2luLCBjZW50ZXJPZmZzZXQsIGNlbnRlcik7CiAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKGhhbGZBeGVzLCBzY2FsZSwgaGFsZkF4ZXMpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xNSwgc2NyYXRjaENhcnRlc2lhbjI1LCBzY3JhdGNoQ2FydGVzaWFuMzYsIHNjcmF0Y2hDYXJ0ZXNpYW40Miwgc2NyYXRjaENhcnRlc2lhbjUsIHNjcmF0Y2hDYXJ0ZXNpYW42LCBzY3JhdGNoQ292YXJpYW5jZVJlc3VsdCwgc2NyYXRjaEVpZ2VuUmVzdWx0LCBzY3JhdGNoT2Zmc2V0LCBzY3JhdGNoU2NhbGUyLCBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyQ2FydG9ncmFwaGljLCBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyLCBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljTkMsIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVywgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY0NXLCBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljU1csIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQywgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5DLCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTlcsIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5DVywgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhblNXLCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU0MsIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWROQywgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5XLCBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkQ1csIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRTVywgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNDLCBzY3JhdGNoUGxhbmVPcmlnaW4sIHNjcmF0Y2hQbGFuZU5vcm1hbCwgc2NyYXRjaFBsYW5lWEF4aXMsIHNjcmF0Y2hIb3Jpem9uQ2FydGVzaWFuLCBzY3JhdGNoSG9yaXpvblByb2plY3RlZCwgc2NyYXRjaE1heFksIHNjcmF0Y2hNaW5ZLCBzY3JhdGNoWiwgc2NyYXRjaFBsYW5lLCBzY3JhdGNoQ2FydGVzaWFuVSwgc2NyYXRjaENhcnRlc2lhblYsIHNjcmF0Y2hDYXJ0ZXNpYW5XLCBzY3JhdGNoVmFsaWRBeGlzMiwgc2NyYXRjaFZhbGlkQXhpczMsIHNjcmF0Y2hQUHJpbWUsIHNjcmF0Y2hDb3JuZXIsIHNjcmF0Y2hUb0NlbnRlciwgc2NyYXRjaFhBeGlzLCBzY3JhdGNoWUF4aXMsIHNjcmF0Y2haQXhpcywgc2NyYXRjaFJvdGF0aW9uU2NhbGUsIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZSwgT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0OwogIHZhciBpbml0X09yaWVudGVkQm91bmRpbmdCb3ggPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09yaWVudGVkQm91bmRpbmdCb3guanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSgpOwogICAgICBpbml0X0ludGVyc2VjdCgpOwogICAgICBpbml0X0ludGVydmFsKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wYWNrZWRMZW5ndGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgTWF0cml4M19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5jZW50ZXIsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBNYXRyaXgzX2RlZmF1bHQucGFjayh2YWx1ZS5oYWxmQXhlcywgYXJyYXksIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIE1hdHJpeDNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoLAogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW41ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENvdmFyaWFuY2VSZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFaWdlblJlc3VsdCA9IHsKICAgICAgICB1bml0YXJ5OiBuZXcgTWF0cml4M19kZWZhdWx0KCksCiAgICAgICAgZGlhZ29uYWw6IG5ldyBNYXRyaXgzX2RlZmF1bHQoKQogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmZyb21Qb2ludHMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzID0gTWF0cml4M19kZWZhdWx0LlpFUk87CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LlpFUk87CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IG1lYW5Qb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbMF0sIHNjcmF0Y2hDYXJ0ZXNpYW4xNSk7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG1lYW5Qb2ludCwgcG9zaXRpb25zW2ldLCBtZWFuUG9pbnQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnZMZW5ndGggPSAxIC8gbGVuZ3RoOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1lYW5Qb2ludCwgaW52TGVuZ3RoLCBtZWFuUG9pbnQpOwogICAgICAgIGxldCBleHggPSAwOwogICAgICAgIGxldCBleHkgPSAwOwogICAgICAgIGxldCBleHogPSAwOwogICAgICAgIGxldCBleXkgPSAwOwogICAgICAgIGxldCBleXogPSAwOwogICAgICAgIGxldCBlenogPSAwOwogICAgICAgIGxldCBwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbnNbaV0sIG1lYW5Qb2ludCwgc2NyYXRjaENhcnRlc2lhbjI1KTsKICAgICAgICAgIGV4eCArPSBwLnggKiBwLng7CiAgICAgICAgICBleHkgKz0gcC54ICogcC55OwogICAgICAgICAgZXh6ICs9IHAueCAqIHAuejsKICAgICAgICAgIGV5eSArPSBwLnkgKiBwLnk7CiAgICAgICAgICBleXogKz0gcC55ICogcC56OwogICAgICAgICAgZXp6ICs9IHAueiAqIHAuejsKICAgICAgICB9CiAgICAgICAgZXh4ICo9IGludkxlbmd0aDsKICAgICAgICBleHkgKj0gaW52TGVuZ3RoOwogICAgICAgIGV4eiAqPSBpbnZMZW5ndGg7CiAgICAgICAgZXl5ICo9IGludkxlbmd0aDsKICAgICAgICBleXogKj0gaW52TGVuZ3RoOwogICAgICAgIGV6eiAqPSBpbnZMZW5ndGg7CiAgICAgICAgY29uc3QgY292YXJpYW5jZU1hdHJpeCA9IHNjcmF0Y2hDb3ZhcmlhbmNlUmVzdWx0OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbMF0gPSBleHg7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFsxXSA9IGV4eTsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzJdID0gZXh6OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbM10gPSBleHk7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFs0XSA9IGV5eTsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzVdID0gZXl6OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbNl0gPSBleHo7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFs3XSA9IGV5ejsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzhdID0gZXp6OwogICAgICAgIGNvbnN0IGVpZ2VuRGVjb21wb3NpdGlvbiA9IE1hdHJpeDNfZGVmYXVsdC5jb21wdXRlRWlnZW5EZWNvbXBvc2l0aW9uKAogICAgICAgICAgY292YXJpYW5jZU1hdHJpeCwKICAgICAgICAgIHNjcmF0Y2hFaWdlblJlc3VsdAogICAgICAgICk7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBNYXRyaXgzX2RlZmF1bHQuY2xvbmUoZWlnZW5EZWNvbXBvc2l0aW9uLnVuaXRhcnksIHJlc3VsdC5oYWxmQXhlcyk7CiAgICAgICAgbGV0IHYxMiA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb24sIDAsIHNjcmF0Y2hDYXJ0ZXNpYW40Mik7CiAgICAgICAgbGV0IHYyMiA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb24sIDEsIHNjcmF0Y2hDYXJ0ZXNpYW41KTsKICAgICAgICBsZXQgdjMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKHJvdGF0aW9uLCAyLCBzY3JhdGNoQ2FydGVzaWFuNik7CiAgICAgICAgbGV0IHUxMiA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCB1MjIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgdTMgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgbDEgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBsMiA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGwzID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICB1MTIgPSBNYXRoLm1heChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYxMiwgcCksIHUxMik7CiAgICAgICAgICB1MjIgPSBNYXRoLm1heChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYyMiwgcCksIHUyMik7CiAgICAgICAgICB1MyA9IE1hdGgubWF4KENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjMsIHApLCB1Myk7CiAgICAgICAgICBsMSA9IE1hdGgubWluKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjEyLCBwKSwgbDEpOwogICAgICAgICAgbDIgPSBNYXRoLm1pbihDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYyMiwgcCksIGwyKTsKICAgICAgICAgIGwzID0gTWF0aC5taW4oQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MywgcCksIGwzKTsKICAgICAgICB9CiAgICAgICAgdjEyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodjEyLCAwLjUgKiAobDEgKyB1MTIpLCB2MTIpOwogICAgICAgIHYyMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHYyMiwgMC41ICogKGwyICsgdTIyKSwgdjIyKTsKICAgICAgICB2MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHYzLCAwLjUgKiAobDMgKyB1MyksIHYzKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHYxMiwgdjIyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgdjMsIGNlbnRlcik7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBzY3JhdGNoQ2FydGVzaWFuMzY7CiAgICAgICAgc2NhbGUueCA9IHUxMiAtIGwxOwogICAgICAgIHNjYWxlLnkgPSB1MjIgLSBsMjsKICAgICAgICBzY2FsZS56ID0gdTMgLSBsMzsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihzY2FsZSwgMC41LCBzY2FsZSk7CiAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsZShyZXN1bHQuaGFsZkF4ZXMsIHNjYWxlLCByZXN1bHQuaGFsZkF4ZXMpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hPZmZzZXQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTY2FsZTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXJDYXJ0b2dyYXBoaWMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZUNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05DID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljQ1cgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NXID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTkMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5OVyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbkNXID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU1cgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TQyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5DID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkTlcgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRDVyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNXID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkU0MgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQbGFuZU9yaWdpbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBsYW5lTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmVYQXhpcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEhvcml6b25DYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hIb3Jpem9uUHJvamVjdGVkID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWF4WSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1pblkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2haID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmUgPSBuZXcgUGxhbmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCAwKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5mcm9tUmVjdGFuZ2xlID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZWN0YW5nbGUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZS53aWR0aCA8IDAgfHwgcmVjdGFuZ2xlLndpZHRoID4gTWF0aF9kZWZhdWx0LlRXT19QSSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlJlY3RhbmdsZSB3aWR0aCBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMiAqIHBpIik7CiAgICAgICAgfQogICAgICAgIGlmIChyZWN0YW5nbGUuaGVpZ2h0IDwgMCB8fCByZWN0YW5nbGUuaGVpZ2h0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiUmVjdGFuZ2xlIGhlaWdodCBtdXN0IGJlIGJldHdlZW4gMCBhbmQgcGkiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpICYmICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGVsbGlwc29pZC5yYWRpaS54LAogICAgICAgICAgZWxsaXBzb2lkLnJhZGlpLnksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJFbGxpcHNvaWQgbXVzdCBiZSBhbiBlbGxpcHNvaWQgb2YgcmV2b2x1dGlvbiAocmFkaWkueCA9PSByYWRpaS55KSIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIG1pbmltdW1IZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtaW5pbXVtSGVpZ2h0LCAwKTsKICAgICAgICBtYXhpbXVtSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF4aW11bUhlaWdodCwgMCk7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KTsKICAgICAgICBsZXQgbWluWCwgbWF4WCwgbWluWSwgbWF4WSwgbWluWiwgbWF4WiwgcGxhbmU7CiAgICAgICAgaWYgKHJlY3RhbmdsZS53aWR0aCA8PSBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgIGNvbnN0IHRhbmdlbnRQb2ludENhcnRvZ3JhcGhpYyA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcigKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyQ2FydG9ncmFwaGljCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdGFuZ2VudFBvaW50ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXIKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBuZXcgRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQodGFuZ2VudFBvaW50LCBlbGxpcHNvaWQpOwogICAgICAgICAgcGxhbmUgPSB0YW5nZW50UGxhbmUucGxhbmU7CiAgICAgICAgICBjb25zdCBsb25DZW50ZXIgPSB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlOwogICAgICAgICAgY29uc3QgbGF0Q2VudGVyID0gcmVjdGFuZ2xlLnNvdXRoIDwgMCAmJiByZWN0YW5nbGUubm9ydGggPiAwID8gMCA6IHRhbmdlbnRQb2ludENhcnRvZ3JhcGhpYy5sYXRpdHVkZTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlckNhcnRvZ3JhcGhpY05DID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgIGxvbkNlbnRlciwKICAgICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoLAogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljTkMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoLAogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljTlcKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNDVyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgbGF0Q2VudGVyLAogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljQ1cKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTVyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljU1cKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICBsb25DZW50ZXIsCiAgICAgICAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NDCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydGVzaWFuTkMgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY05DLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTkMKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgcGVyaW1ldGVyQ2FydGVzaWFuTlcgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY05XLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTlcKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0ZXNpYW5DVyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljQ1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5DVwogICAgICAgICAgKTsKICAgICAgICAgIGxldCBwZXJpbWV0ZXJDYXJ0ZXNpYW5TVyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljU1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TVwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlckNhcnRlc2lhblNDID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhblNDCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyUHJvamVjdGVkTkMgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50VG9OZWFyZXN0T25QbGFuZSgKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuTkMsCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWROQwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlclByb2plY3RlZE5XID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhbk5XLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkTlcKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJQcm9qZWN0ZWRDVyA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5DVywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZENXCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyUHJvamVjdGVkU1cgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50VG9OZWFyZXN0T25QbGFuZSgKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuU1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRTVwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlclByb2plY3RlZFNDID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhblNDLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkU0MKICAgICAgICAgICk7CiAgICAgICAgICBtaW5YID0gTWF0aC5taW4oCiAgICAgICAgICAgIHBlcmltZXRlclByb2plY3RlZE5XLngsCiAgICAgICAgICAgIHBlcmltZXRlclByb2plY3RlZENXLngsCiAgICAgICAgICAgIHBlcmltZXRlclByb2plY3RlZFNXLngKICAgICAgICAgICk7CiAgICAgICAgICBtYXhYID0gLW1pblg7CiAgICAgICAgICBtYXhZID0gTWF0aC5tYXgocGVyaW1ldGVyUHJvamVjdGVkTlcueSwgcGVyaW1ldGVyUHJvamVjdGVkTkMueSk7CiAgICAgICAgICBtaW5ZID0gTWF0aC5taW4ocGVyaW1ldGVyUHJvamVjdGVkU1cueSwgcGVyaW1ldGVyUHJvamVjdGVkU0MueSk7CiAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVy5oZWlnaHQgPSBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTVy5oZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuTlcgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY05XLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTlcKICAgICAgICAgICk7CiAgICAgICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5TVyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljU1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TVwogICAgICAgICAgKTsKICAgICAgICAgIG1pblogPSBNYXRoLm1pbigKICAgICAgICAgICAgUGxhbmVfZGVmYXVsdC5nZXRQb2ludERpc3RhbmNlKHBsYW5lLCBwZXJpbWV0ZXJDYXJ0ZXNpYW5OVyksCiAgICAgICAgICAgIFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZShwbGFuZSwgcGVyaW1ldGVyQ2FydGVzaWFuU1cpCiAgICAgICAgICApOwogICAgICAgICAgbWF4WiA9IG1heGltdW1IZWlnaHQ7CiAgICAgICAgICByZXR1cm4gZnJvbVBsYW5lRXh0ZW50cygKICAgICAgICAgICAgdGFuZ2VudFBsYW5lLm9yaWdpbiwKICAgICAgICAgICAgdGFuZ2VudFBsYW5lLnhBeGlzLAogICAgICAgICAgICB0YW5nZW50UGxhbmUueUF4aXMsCiAgICAgICAgICAgIHRhbmdlbnRQbGFuZS56QXhpcywKICAgICAgICAgICAgbWluWCwKICAgICAgICAgICAgbWF4WCwKICAgICAgICAgICAgbWluWSwKICAgICAgICAgICAgbWF4WSwKICAgICAgICAgICAgbWluWiwKICAgICAgICAgICAgbWF4WiwKICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBmdWxseUFib3ZlRXF1YXRvciA9IHJlY3RhbmdsZS5zb3V0aCA+IDA7CiAgICAgICAgY29uc3QgZnVsbHlCZWxvd0VxdWF0b3IgPSByZWN0YW5nbGUubm9ydGggPCAwOwogICAgICAgIGNvbnN0IGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciA9IGZ1bGx5QWJvdmVFcXVhdG9yID8gcmVjdGFuZ2xlLnNvdXRoIDogZnVsbHlCZWxvd0VxdWF0b3IgPyByZWN0YW5nbGUubm9ydGggOiAwOwogICAgICAgIGNvbnN0IGNlbnRlckxvbmdpdHVkZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcigKICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXJDYXJ0b2dyYXBoaWMKICAgICAgICApLmxvbmdpdHVkZTsKICAgICAgICBjb25zdCBwbGFuZU9yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNlbnRlckxvbmdpdHVkZSwKICAgICAgICAgIGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoUGxhbmVPcmlnaW4KICAgICAgICApOwogICAgICAgIHBsYW5lT3JpZ2luLnogPSAwOwogICAgICAgIGNvbnN0IGlzUG9sZSA9IE1hdGguYWJzKHBsYW5lT3JpZ2luLngpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCAmJiBNYXRoLmFicyhwbGFuZU9yaWdpbi55KSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTA7CiAgICAgICAgY29uc3QgcGxhbmVOb3JtYWwgPSAhaXNQb2xlID8gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShwbGFuZU9yaWdpbiwgc2NyYXRjaFBsYW5lTm9ybWFsKSA6IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1g7CiAgICAgICAgY29uc3QgcGxhbmVZQXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1o7CiAgICAgICAgY29uc3QgcGxhbmVYQXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgIHBsYW5lTm9ybWFsLAogICAgICAgICAgcGxhbmVZQXhpcywKICAgICAgICAgIHNjcmF0Y2hQbGFuZVhBeGlzCiAgICAgICAgKTsKICAgICAgICBwbGFuZSA9IFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50Tm9ybWFsKHBsYW5lT3JpZ2luLCBwbGFuZU5vcm1hbCwgc2NyYXRjaFBsYW5lKTsKICAgICAgICBjb25zdCBob3Jpem9uQ2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgY2VudGVyTG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPLAogICAgICAgICAgbGF0aXR1ZGVOZWFyZXN0VG9FcXVhdG9yLAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hIb3Jpem9uQ2FydGVzaWFuCiAgICAgICAgKTsKICAgICAgICBtYXhYID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCgKICAgICAgICAgIFBsYW5lX2RlZmF1bHQucHJvamVjdFBvaW50T250b1BsYW5lKAogICAgICAgICAgICBwbGFuZSwKICAgICAgICAgICAgaG9yaXpvbkNhcnRlc2lhbiwKICAgICAgICAgICAgc2NyYXRjaEhvcml6b25Qcm9qZWN0ZWQKICAgICAgICAgICksCiAgICAgICAgICBwbGFuZVhBeGlzCiAgICAgICAgKTsKICAgICAgICBtaW5YID0gLW1heFg7CiAgICAgICAgbWF4WSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIDAsCiAgICAgICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgICAgICBmdWxseUJlbG93RXF1YXRvciA/IG1pbmltdW1IZWlnaHQgOiBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaE1heFkKICAgICAgICApLno7CiAgICAgICAgbWluWSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIDAsCiAgICAgICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgICAgICBmdWxseUFib3ZlRXF1YXRvciA/IG1pbmltdW1IZWlnaHQgOiBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaE1pblkKICAgICAgICApLno7CiAgICAgICAgY29uc3QgZmFyWiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIHJlY3RhbmdsZS5lYXN0LAogICAgICAgICAgbGF0aXR1ZGVOZWFyZXN0VG9FcXVhdG9yLAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2haCiAgICAgICAgKTsKICAgICAgICBtaW5aID0gUGxhbmVfZGVmYXVsdC5nZXRQb2ludERpc3RhbmNlKHBsYW5lLCBmYXJaKTsKICAgICAgICBtYXhaID0gMDsKICAgICAgICByZXR1cm4gZnJvbVBsYW5lRXh0ZW50cygKICAgICAgICAgIHBsYW5lT3JpZ2luLAogICAgICAgICAgcGxhbmVYQXhpcywKICAgICAgICAgIHBsYW5lWUF4aXMsCiAgICAgICAgICBwbGFuZU5vcm1hbCwKICAgICAgICAgIG1pblgsCiAgICAgICAgICBtYXhYLAogICAgICAgICAgbWluWSwKICAgICAgICAgIG1heFksCiAgICAgICAgICBtaW5aLAogICAgICAgICAgbWF4WiwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guZnJvbVRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24odHJhbnNmb3JtYXRpb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNmb3JtYXRpb24iLCB0cmFuc2Zvcm1hdGlvbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE9yaWVudGVkQm91bmRpbmdCb3goKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IE1hdHJpeDRfZGVmYXVsdC5nZXRUcmFuc2xhdGlvbih0cmFuc2Zvcm1hdGlvbiwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LmhhbGZBeGVzID0gTWF0cml4NF9kZWZhdWx0LmdldE1hdHJpeDModHJhbnNmb3JtYXRpb24sIHJlc3VsdC5oYWxmQXhlcyk7CiAgICAgICAgcmVzdWx0LmhhbGZBeGVzID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICByZXN1bHQuaGFsZkF4ZXMsCiAgICAgICAgICAwLjUsCiAgICAgICAgICByZXN1bHQuaGFsZkF4ZXMKICAgICAgICApOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guY2xvbmUgPSBmdW5jdGlvbihib3gsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJveCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgT3JpZW50ZWRCb3VuZGluZ0JveChib3guY2VudGVyLCBib3guaGFsZkF4ZXMpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYm94LmNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgTWF0cml4M19kZWZhdWx0LmNsb25lKGJveC5oYWxmQXhlcywgcmVzdWx0LmhhbGZBeGVzKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24oYm94LCBwbGFuZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJveCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3ggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBsYW5lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjZW50ZXIgPSBib3guY2VudGVyOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgaGFsZkF4ZXMgPSBib3guaGFsZkF4ZXM7CiAgICAgICAgY29uc3Qgbm9ybWFsWCA9IG5vcm1hbDIueCwgbm9ybWFsWSA9IG5vcm1hbDIueSwgbm9ybWFsWiA9IG5vcm1hbDIuejsKICAgICAgICBjb25zdCByYWRFZmZlY3RpdmUgPSBNYXRoLmFicygKICAgICAgICAgIG5vcm1hbFggKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzBdICsgbm9ybWFsWSAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMV0gKyBub3JtYWxaICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjBST1cyXQogICAgICAgICkgKyBNYXRoLmFicygKICAgICAgICAgIG5vcm1hbFggKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMVJPVzBdICsgbm9ybWFsWSAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMV0gKyBub3JtYWxaICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cyXQogICAgICAgICkgKyBNYXRoLmFicygKICAgICAgICAgIG5vcm1hbFggKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzBdICsgbm9ybWFsWSAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMV0gKyBub3JtYWxaICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cyXQogICAgICAgICk7CiAgICAgICAgY29uc3QgZGlzdGFuY2VUb1BsYW5lID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBjZW50ZXIpICsgcGxhbmUuZGlzdGFuY2U7CiAgICAgICAgaWYgKGRpc3RhbmNlVG9QbGFuZSA8PSAtcmFkRWZmZWN0aXZlKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERTsKICAgICAgICB9IGVsc2UgaWYgKGRpc3RhbmNlVG9QbGFuZSA+PSByYWRFZmZlY3RpdmUpIHsKICAgICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5JTlNJREU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkc7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5VID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuViA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhblcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWYWxpZEF4aXMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmFsaWRBeGlzMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBQcmltZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5kaXN0YW5jZVNxdWFyZWRUbyA9IGZ1bmN0aW9uKGJveCwgY2FydGVzaWFuMTEpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm94IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYXJ0ZXNpYW4gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9mZnNldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjYXJ0ZXNpYW4xMSwgYm94LmNlbnRlciwgc2NyYXRjaE9mZnNldCk7CiAgICAgICAgY29uc3QgaGFsZkF4ZXMgPSBib3guaGFsZkF4ZXM7CiAgICAgICAgbGV0IHUzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaENhcnRlc2lhblUpOwogICAgICAgIGxldCB2MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHNjcmF0Y2hDYXJ0ZXNpYW5WKTsKICAgICAgICBsZXQgdyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHNjcmF0Y2hDYXJ0ZXNpYW5XKTsKICAgICAgICBjb25zdCB1SGFsZiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUodTMpOwogICAgICAgIGNvbnN0IHZIYWxmID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh2Myk7CiAgICAgICAgY29uc3Qgd0hhbGYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHcpOwogICAgICAgIGxldCB1VmFsaWQgPSB0cnVlOwogICAgICAgIGxldCB2VmFsaWQgPSB0cnVlOwogICAgICAgIGxldCB3VmFsaWQgPSB0cnVlOwogICAgICAgIGlmICh1SGFsZiA+IDApIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcih1MywgdUhhbGYsIHUzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdVZhbGlkID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICh2SGFsZiA+IDApIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcih2MywgdkhhbGYsIHYzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdlZhbGlkID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICh3SGFsZiA+IDApIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcih3LCB3SGFsZiwgdyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdWYWxpZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBudW1iZXJPZkRlZ2VuZXJhdGVBeGVzID0gIXVWYWxpZCArICF2VmFsaWQgKyAhd1ZhbGlkOwogICAgICAgIGxldCB2YWxpZEF4aXMxOwogICAgICAgIGxldCB2YWxpZEF4aXMyOwogICAgICAgIGxldCB2YWxpZEF4aXMzOwogICAgICAgIGlmIChudW1iZXJPZkRlZ2VuZXJhdGVBeGVzID09PSAxKSB7CiAgICAgICAgICBsZXQgZGVnZW5lcmF0ZUF4aXMgPSB1MzsKICAgICAgICAgIHZhbGlkQXhpczEgPSB2MzsKICAgICAgICAgIHZhbGlkQXhpczIgPSB3OwogICAgICAgICAgaWYgKCF2VmFsaWQpIHsKICAgICAgICAgICAgZGVnZW5lcmF0ZUF4aXMgPSB2MzsKICAgICAgICAgICAgdmFsaWRBeGlzMSA9IHUzOwogICAgICAgICAgfSBlbHNlIGlmICghd1ZhbGlkKSB7CiAgICAgICAgICAgIGRlZ2VuZXJhdGVBeGlzID0gdzsKICAgICAgICAgICAgdmFsaWRBeGlzMiA9IHUzOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRBeGlzMyA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh2YWxpZEF4aXMxLCB2YWxpZEF4aXMyLCBzY3JhdGNoVmFsaWRBeGlzMyk7CiAgICAgICAgICBpZiAoZGVnZW5lcmF0ZUF4aXMgPT09IHUzKSB7CiAgICAgICAgICAgIHUzID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0gZWxzZSBpZiAoZGVnZW5lcmF0ZUF4aXMgPT09IHYzKSB7CiAgICAgICAgICAgIHYzID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0gZWxzZSBpZiAoZGVnZW5lcmF0ZUF4aXMgPT09IHcpIHsKICAgICAgICAgICAgdyA9IHZhbGlkQXhpczM7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChudW1iZXJPZkRlZ2VuZXJhdGVBeGVzID09PSAyKSB7CiAgICAgICAgICB2YWxpZEF4aXMxID0gdTM7CiAgICAgICAgICBpZiAodlZhbGlkKSB7CiAgICAgICAgICAgIHZhbGlkQXhpczEgPSB2MzsKICAgICAgICAgIH0gZWxzZSBpZiAod1ZhbGlkKSB7CiAgICAgICAgICAgIHZhbGlkQXhpczEgPSB3OwogICAgICAgICAgfQogICAgICAgICAgbGV0IGNyb3NzVmVjdG9yID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWTsKICAgICAgICAgIGlmIChjcm9zc1ZlY3Rvci5lcXVhbHNFcHNpbG9uKHZhbGlkQXhpczEsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMykpIHsKICAgICAgICAgICAgY3Jvc3NWZWN0b3IgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRBeGlzMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh2YWxpZEF4aXMxLCBjcm9zc1ZlY3Rvciwgc2NyYXRjaFZhbGlkQXhpczIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh2YWxpZEF4aXMyLCB2YWxpZEF4aXMyKTsKICAgICAgICAgIHZhbGlkQXhpczMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModmFsaWRBeGlzMSwgdmFsaWRBeGlzMiwgc2NyYXRjaFZhbGlkQXhpczMpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh2YWxpZEF4aXMzLCB2YWxpZEF4aXMzKTsKICAgICAgICAgIGlmICh2YWxpZEF4aXMxID09PSB1MykgewogICAgICAgICAgICB2MyA9IHZhbGlkQXhpczI7CiAgICAgICAgICAgIHcgPSB2YWxpZEF4aXMzOwogICAgICAgICAgfSBlbHNlIGlmICh2YWxpZEF4aXMxID09PSB2MykgewogICAgICAgICAgICB3ID0gdmFsaWRBeGlzMjsKICAgICAgICAgICAgdTMgPSB2YWxpZEF4aXMzOwogICAgICAgICAgfSBlbHNlIGlmICh2YWxpZEF4aXMxID09PSB3KSB7CiAgICAgICAgICAgIHUzID0gdmFsaWRBeGlzMjsKICAgICAgICAgICAgdjMgPSB2YWxpZEF4aXMzOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9PT0gMykgewogICAgICAgICAgdTMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YOwogICAgICAgICAgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZOwogICAgICAgICAgdyA9IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1o7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBQcmltZSA9IHNjcmF0Y2hQUHJpbWU7CiAgICAgICAgcFByaW1lLnggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG9mZnNldCwgdTMpOwogICAgICAgIHBQcmltZS55ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChvZmZzZXQsIHYzKTsKICAgICAgICBwUHJpbWUueiA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qob2Zmc2V0LCB3KTsKICAgICAgICBsZXQgZGlzdGFuY2VTcXVhcmVkID0gMDsKICAgICAgICBsZXQgZDsKICAgICAgICBpZiAocFByaW1lLnggPCAtdUhhbGYpIHsKICAgICAgICAgIGQgPSBwUHJpbWUueCArIHVIYWxmOwogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogICAgICAgIH0gZWxzZSBpZiAocFByaW1lLnggPiB1SGFsZikgewogICAgICAgICAgZCA9IHBQcmltZS54IC0gdUhhbGY7CiAgICAgICAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgICAgICAgfQogICAgICAgIGlmIChwUHJpbWUueSA8IC12SGFsZikgewogICAgICAgICAgZCA9IHBQcmltZS55ICsgdkhhbGY7CiAgICAgICAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgICAgICAgfSBlbHNlIGlmIChwUHJpbWUueSA+IHZIYWxmKSB7CiAgICAgICAgICBkID0gcFByaW1lLnkgLSB2SGFsZjsKICAgICAgICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICAgICAgICB9CiAgICAgICAgaWYgKHBQcmltZS56IDwgLXdIYWxmKSB7CiAgICAgICAgICBkID0gcFByaW1lLnogKyB3SGFsZjsKICAgICAgICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICAgICAgICB9IGVsc2UgaWYgKHBQcmltZS56ID4gd0hhbGYpIHsKICAgICAgICAgIGQgPSBwUHJpbWUueiAtIHdIYWxmOwogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGlzdGFuY2VTcXVhcmVkOwogICAgICB9OwogICAgICBzY3JhdGNoQ29ybmVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVG9DZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZVBsYW5lRGlzdGFuY2VzID0gZnVuY3Rpb24oYm94LCBwb3NpdGlvbiwgZGlyZWN0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm94KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImJveCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9zaXRpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRpcmVjdGlvbjIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGlyZWN0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSW50ZXJ2YWxfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBsZXQgbWluRGlzdCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBsZXQgbWF4RGlzdCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBib3guY2VudGVyOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gYm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IHUzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaENhcnRlc2lhblUpOwogICAgICAgIGNvbnN0IHYzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMSwgc2NyYXRjaENhcnRlc2lhblYpOwogICAgICAgIGNvbnN0IHcgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBzY3JhdGNoQ2FydGVzaWFuVyk7CiAgICAgICAgY29uc3QgY29ybmVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCh1MywgdjMsIHNjcmF0Y2hDb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBjZW50ZXIsIGNvcm5lcik7CiAgICAgICAgY29uc3QgdG9DZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgc2NyYXRjaFRvQ2VudGVyKTsKICAgICAgICBsZXQgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB2MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHcsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHRvQ2VudGVyKTsKICAgICAgICBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICBtaW5EaXN0ID0gTWF0aC5taW4obWFnLCBtaW5EaXN0KTsKICAgICAgICBtYXhEaXN0ID0gTWF0aC5tYXgobWFnLCBtYXhEaXN0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdjMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjb3JuZXIsIHcsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHRvQ2VudGVyKTsKICAgICAgICBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICBtaW5EaXN0ID0gTWF0aC5taW4obWFnLCBtaW5EaXN0KTsKICAgICAgICBtYXhEaXN0ID0gTWF0aC5tYXgobWFnLCBtYXhEaXN0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdjMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNlbnRlciwgdTMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgdjMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIHJlc3VsdC5zdGFydCA9IG1pbkRpc3Q7CiAgICAgICAgcmVzdWx0LnN0b3AgPSBtYXhEaXN0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hYQXhpcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFlBeGlzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWkF4aXMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZUNvcm5lcnMgPSBmdW5jdGlvbihib3gsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYm94IiwgYm94KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBbCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpCiAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBjb25zdCBjZW50ZXIgPSBib3guY2VudGVyOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gYm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IHhBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaFhBeGlzKTsKICAgICAgICBjb25zdCB5QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHNjcmF0Y2hZQXhpcyk7CiAgICAgICAgY29uc3QgekF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBzY3JhdGNoWkF4aXMpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFswXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFswXSwgeEF4aXMsIHJlc3VsdFswXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFswXSwgeUF4aXMsIHJlc3VsdFswXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFswXSwgekF4aXMsIHJlc3VsdFswXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzFdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzFdLCB4QXhpcywgcmVzdWx0WzFdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzFdLCB5QXhpcywgcmVzdWx0WzFdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFsxXSwgekF4aXMsIHJlc3VsdFsxXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzJdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzJdLCB4QXhpcywgcmVzdWx0WzJdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFsyXSwgeUF4aXMsIHJlc3VsdFsyXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFsyXSwgekF4aXMsIHJlc3VsdFsyXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzNdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzNdLCB4QXhpcywgcmVzdWx0WzNdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFszXSwgeUF4aXMsIHJlc3VsdFszXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbM10sIHpBeGlzLCByZXN1bHRbM10pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFs0XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbNF0sIHhBeGlzLCByZXN1bHRbNF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbNF0sIHlBeGlzLCByZXN1bHRbNF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbNF0sIHpBeGlzLCByZXN1bHRbNF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFs1XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbNV0sIHhBeGlzLCByZXN1bHRbNV0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbNV0sIHlBeGlzLCByZXN1bHRbNV0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzVdLCB6QXhpcywgcmVzdWx0WzVdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHRbNl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzZdLCB4QXhpcywgcmVzdWx0WzZdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs2XSwgeUF4aXMsIHJlc3VsdFs2XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFs2XSwgekF4aXMsIHJlc3VsdFs2XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzddKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs3XSwgeEF4aXMsIHJlc3VsdFs3XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbN10sIHlBeGlzLCByZXN1bHRbN10pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzddLCB6QXhpcywgcmVzdWx0WzddKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoUm90YXRpb25TY2FsZSA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5jb21wdXRlVHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbihib3gsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYm94IiwgYm94KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRyYW5zbGF0aW9uMiA9IGJveC5jZW50ZXI7CiAgICAgICAgY29uc3Qgcm90YXRpb25TY2FsZSA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VW5pZm9ybVNjYWxlKAogICAgICAgICAgYm94LmhhbGZBeGVzLAogICAgICAgICAgMiwKICAgICAgICAgIHNjcmF0Y2hSb3RhdGlvblNjYWxlCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gTWF0cml4NF9kZWZhdWx0LmZyb21Sb3RhdGlvblRyYW5zbGF0aW9uKHJvdGF0aW9uU2NhbGUsIHRyYW5zbGF0aW9uMiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaEJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5pc09jY2x1ZGVkID0gZnVuY3Rpb24oYm94LCBvY2NsdWRlcikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJveCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3ggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9jY2x1ZGVyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9jY2x1ZGVyIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21PcmllbnRlZEJvdW5kaW5nQm94KAogICAgICAgICAgYm94LAogICAgICAgICAgc2NyYXRjaEJvdW5kaW5nU3BoZXJlCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gIW9jY2x1ZGVyLmlzQm91bmRpbmdTcGhlcmVWaXNpYmxlKHNwaGVyZSk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24ocGxhbmUpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5pbnRlcnNlY3RQbGFuZSh0aGlzLCBwbGFuZSk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmRpc3RhbmNlU3F1YXJlZFRvID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5kaXN0YW5jZVNxdWFyZWRUbyh0aGlzLCBjYXJ0ZXNpYW4xMSk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmNvbXB1dGVQbGFuZURpc3RhbmNlcyA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5jb21wdXRlUGxhbmVEaXN0YW5jZXMoCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBkaXJlY3Rpb24yLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuY29tcHV0ZUNvcm5lcnMgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5jb21wdXRlQ29ybmVycyh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5jb21wdXRlVHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5jb21wdXRlVHJhbnNmb3JtYXRpb24odGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuaXNPY2NsdWRlZCA9IGZ1bmN0aW9uKG9jY2x1ZGVyKSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guaXNPY2NsdWRlZCh0aGlzLCBvY2NsdWRlcik7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhsZWZ0LmNlbnRlciwgcmlnaHQuY2VudGVyKSAmJiBNYXRyaXgzX2RlZmF1bHQuZXF1YWxzKGxlZnQuaGFsZkF4ZXMsIHJpZ2h0LmhhbGZBeGVzKTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBPcmllbnRlZEJvdW5kaW5nQm94LmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdCA9IE9yaWVudGVkQm91bmRpbmdCb3g7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBwcm9qZWN0VG8yRChwb3NpdGlvbiwgY2VudGVyLCBheGlzMSwgYXhpczIsIHJlc3VsdCkgewogICAgY29uc3QgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9zaXRpb24sIGNlbnRlciwgc2NyYXRjaEludGVyc2VjdGlvblBvaW50KTsKICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGF4aXMxLCB2Myk7CiAgICBjb25zdCB5ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChheGlzMiwgdjMpOwogICAgcmV0dXJuIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoeCwgeSwgcmVzdWx0KTsKICB9CiAgdmFyIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeSwgc2NyYXRjaEludGVyc2VjdGlvblBvaW50LCBzY3JhdGNoWEF4aXMyLCBzY3JhdGNoWUF4aXMyLCBzY3JhdGNoWkF4aXMyLCBvYmJTY3JhdGNoLCBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9PcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBzY3JhdGNoSW50ZXJzZWN0aW9uUG9pbnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hYQXhpczIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hZQXhpczIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2haQXhpczIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG9iYlNjcmF0Y2ggPSBuZXcgT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0KCk7CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeS52YWxpZE91dGxpbmUgPSBmdW5jdGlvbihwb3NpdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgY29uc3Qgb3JpZW50ZWRCb3VuZGluZ0JveCA9IE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdC5mcm9tUG9pbnRzKAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgb2JiU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgaGFsZkF4ZXMgPSBvcmllbnRlZEJvdW5kaW5nQm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IHhBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaFhBeGlzMik7CiAgICAgICAgY29uc3QgeUF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBzY3JhdGNoWUF4aXMyKTsKICAgICAgICBjb25zdCB6QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHNjcmF0Y2haQXhpczIpOwogICAgICAgIGNvbnN0IHhNYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHhBeGlzKTsKICAgICAgICBjb25zdCB5TWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh5QXhpcyk7CiAgICAgICAgY29uc3Qgek1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoekF4aXMpOwogICAgICAgIHJldHVybiAhKHhNYWcgPT09IDAgJiYgKHlNYWcgPT09IDAgfHwgek1hZyA9PT0gMCkgfHwgeU1hZyA9PT0gMCAmJiB6TWFnID09PSAwKTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVQcm9qZWN0VG8yREFyZ3VtZW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgY2VudGVyUmVzdWx0LCBwbGFuZUF4aXMxUmVzdWx0LCBwbGFuZUF4aXMyUmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2VudGVyUmVzdWx0IiwgY2VudGVyUmVzdWx0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBsYW5lQXhpczFSZXN1bHQiLCBwbGFuZUF4aXMxUmVzdWx0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBsYW5lQXhpczJSZXN1bHQiLCBwbGFuZUF4aXMyUmVzdWx0KTsKICAgICAgICBjb25zdCBvcmllbnRlZEJvdW5kaW5nQm94ID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21Qb2ludHMoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBvYmJTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoYWxmQXhlcyA9IG9yaWVudGVkQm91bmRpbmdCb3guaGFsZkF4ZXM7CiAgICAgICAgY29uc3QgeEF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAwLCBzY3JhdGNoWEF4aXMyKTsKICAgICAgICBjb25zdCB5QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHNjcmF0Y2hZQXhpczIpOwogICAgICAgIGNvbnN0IHpBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMiwgc2NyYXRjaFpBeGlzMik7CiAgICAgICAgY29uc3QgeE1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoeEF4aXMpOwogICAgICAgIGNvbnN0IHlNYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHlBeGlzKTsKICAgICAgICBjb25zdCB6TWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh6QXhpcyk7CiAgICAgICAgY29uc3QgbWluMyA9IE1hdGgubWluKHhNYWcsIHlNYWcsIHpNYWcpOwogICAgICAgIGlmICh4TWFnID09PSAwICYmICh5TWFnID09PSAwIHx8IHpNYWcgPT09IDApIHx8IHlNYWcgPT09IDAgJiYgek1hZyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBsZXQgcGxhbmVBeGlzMTsKICAgICAgICBsZXQgcGxhbmVBeGlzMjsKICAgICAgICBpZiAobWluMyA9PT0geU1hZyB8fCBtaW4zID09PSB6TWFnKSB7CiAgICAgICAgICBwbGFuZUF4aXMxID0geEF4aXM7CiAgICAgICAgfQogICAgICAgIGlmIChtaW4zID09PSB4TWFnKSB7CiAgICAgICAgICBwbGFuZUF4aXMxID0geUF4aXM7CiAgICAgICAgfSBlbHNlIGlmIChtaW4zID09PSB6TWFnKSB7CiAgICAgICAgICBwbGFuZUF4aXMyID0geUF4aXM7CiAgICAgICAgfQogICAgICAgIGlmIChtaW4zID09PSB4TWFnIHx8IG1pbjMgPT09IHlNYWcpIHsKICAgICAgICAgIHBsYW5lQXhpczIgPSB6QXhpczsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShwbGFuZUF4aXMxLCBwbGFuZUF4aXMxUmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHBsYW5lQXhpczIsIHBsYW5lQXhpczJSZXN1bHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShvcmllbnRlZEJvdW5kaW5nQm94LmNlbnRlciwgY2VudGVyUmVzdWx0KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNyZWF0ZVByb2plY3RQb2ludHNUbzJERnVuY3Rpb24gPSBmdW5jdGlvbihjZW50ZXIsIGF4aXMxLCBheGlzMikgewogICAgICAgIHJldHVybiBmdW5jdGlvbihwb3NpdGlvbnMpIHsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9uUmVzdWx0cyA9IG5ldyBBcnJheShwb3NpdGlvbnMubGVuZ3RoKTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHBvc2l0aW9uUmVzdWx0c1tpXSA9IHByb2plY3RUbzJEKHBvc2l0aW9uc1tpXSwgY2VudGVyLCBheGlzMSwgYXhpczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBvc2l0aW9uUmVzdWx0czsKICAgICAgICB9OwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkuY3JlYXRlUHJvamVjdFBvaW50VG8yREZ1bmN0aW9uID0gZnVuY3Rpb24oY2VudGVyLCBheGlzMSwgYXhpczIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9zaXRpb24sIHJlc3VsdCkgewogICAgICAgICAgcmV0dXJuIHByb2plY3RUbzJEKHBvc2l0aW9uLCBjZW50ZXIsIGF4aXMxLCBheGlzMiwgcmVzdWx0KTsKICAgICAgICB9OwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0FyY1R5cGUuanMKICB2YXIgQXJjVHlwZSwgQXJjVHlwZV9kZWZhdWx0OwogIHZhciBpbml0X0FyY1R5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0FyY1R5cGUuanMiKCkgewogICAgICBBcmNUeXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIFN0cmFpZ2h0IGxpbmUgdGhhdCBkb2VzIG5vdCBjb25mb3JtIHRvIHRoZSBzdXJmYWNlIG9mIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE5PTkU6IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogRm9sbG93IGdlb2Rlc2ljIHBhdGguCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEdFT0RFU0lDOiAxLAogICAgICAgIC8qKgogICAgICAgICAqIEZvbGxvdyByaHVtYiBvciBsb3hvZHJvbWUgcGF0aC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkhVTUI6IDIKICAgICAgfTsKICAgICAgQXJjVHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShBcmNUeXBlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZFJodW1iTGluZS5qcwogIGZ1bmN0aW9uIGNhbGN1bGF0ZU0oZWxsaXB0aWNpdHksIG1ham9yLCBsYXRpdHVkZSkgewogICAgaWYgKGVsbGlwdGljaXR5ID09PSAwKSB7CiAgICAgIHJldHVybiBtYWpvciAqIGxhdGl0dWRlOwogICAgfQogICAgY29uc3QgZTIgPSBlbGxpcHRpY2l0eSAqIGVsbGlwdGljaXR5OwogICAgY29uc3QgZTQgPSBlMiAqIGUyOwogICAgY29uc3QgZTYgPSBlNCAqIGUyOwogICAgY29uc3QgZTggPSBlNiAqIGUyOwogICAgY29uc3QgZTEwID0gZTggKiBlMjsKICAgIGNvbnN0IGUxMiA9IGUxMCAqIGUyOwogICAgY29uc3QgcGhpID0gbGF0aXR1ZGU7CiAgICBjb25zdCBzaW4yUGhpID0gTWF0aC5zaW4oMiAqIHBoaSk7CiAgICBjb25zdCBzaW40UGhpID0gTWF0aC5zaW4oNCAqIHBoaSk7CiAgICBjb25zdCBzaW42UGhpID0gTWF0aC5zaW4oNiAqIHBoaSk7CiAgICBjb25zdCBzaW44UGhpID0gTWF0aC5zaW4oOCAqIHBoaSk7CiAgICBjb25zdCBzaW4xMFBoaSA9IE1hdGguc2luKDEwICogcGhpKTsKICAgIGNvbnN0IHNpbjEyUGhpID0gTWF0aC5zaW4oMTIgKiBwaGkpOwogICAgcmV0dXJuIG1ham9yICogKCgxIC0gZTIgLyA0IC0gMyAqIGU0IC8gNjQgLSA1ICogZTYgLyAyNTYgLSAxNzUgKiBlOCAvIDE2Mzg0IC0gNDQxICogZTEwIC8gNjU1MzYgLSA0ODUxICogZTEyIC8gMTA0ODU3NikgKiBwaGkgLSAoMyAqIGUyIC8gOCArIDMgKiBlNCAvIDMyICsgNDUgKiBlNiAvIDEwMjQgKyAxMDUgKiBlOCAvIDQwOTYgKyAyMjA1ICogZTEwIC8gMTMxMDcyICsgNjIzNyAqIGUxMiAvIDUyNDI4OCkgKiBzaW4yUGhpICsgKDE1ICogZTQgLyAyNTYgKyA0NSAqIGU2IC8gMTAyNCArIDUyNSAqIGU4IC8gMTYzODQgKyAxNTc1ICogZTEwIC8gNjU1MzYgKyAxNTU5MjUgKiBlMTIgLyA4Mzg4NjA4KSAqIHNpbjRQaGkgLSAoMzUgKiBlNiAvIDMwNzIgKyAxNzUgKiBlOCAvIDEyMjg4ICsgMzY3NSAqIGUxMCAvIDI2MjE0NCArIDEzNDc1ICogZTEyIC8gMTA0ODU3NikgKiBzaW42UGhpICsgKDMxNSAqIGU4IC8gMTMxMDcyICsgMjIwNSAqIGUxMCAvIDUyNDI4OCArIDQzNjU5ICogZTEyIC8gODM4ODYwOCkgKiBzaW44UGhpIC0gKDY5MyAqIGUxMCAvIDEzMTA3MjAgKyA2MjM3ICogZTEyIC8gNTI0Mjg4MCkgKiBzaW4xMFBoaSArIDEwMDEgKiBlMTIgLyA4Mzg4NjA4ICogc2luMTJQaGkpOwogIH0KICBmdW5jdGlvbiBjYWxjdWxhdGVJbnZlcnNlTShNLCBlbGxpcHRpY2l0eSwgbWFqb3IpIHsKICAgIGNvbnN0IGQgPSBNIC8gbWFqb3I7CiAgICBpZiAoZWxsaXB0aWNpdHkgPT09IDApIHsKICAgICAgcmV0dXJuIGQ7CiAgICB9CiAgICBjb25zdCBkMiA9IGQgKiBkOwogICAgY29uc3QgZDMgPSBkMiAqIGQ7CiAgICBjb25zdCBkNCA9IGQzICogZDsKICAgIGNvbnN0IGUgPSBlbGxpcHRpY2l0eTsKICAgIGNvbnN0IGUyID0gZSAqIGU7CiAgICBjb25zdCBlNCA9IGUyICogZTI7CiAgICBjb25zdCBlNiA9IGU0ICogZTI7CiAgICBjb25zdCBlOCA9IGU2ICogZTI7CiAgICBjb25zdCBlMTAgPSBlOCAqIGUyOwogICAgY29uc3QgZTEyID0gZTEwICogZTI7CiAgICBjb25zdCBzaW4yRCA9IE1hdGguc2luKDIgKiBkKTsKICAgIGNvbnN0IGNvczJEID0gTWF0aC5jb3MoMiAqIGQpOwogICAgY29uc3Qgc2luNEQgPSBNYXRoLnNpbig0ICogZCk7CiAgICBjb25zdCBjb3M0RCA9IE1hdGguY29zKDQgKiBkKTsKICAgIGNvbnN0IHNpbjZEID0gTWF0aC5zaW4oNiAqIGQpOwogICAgY29uc3QgY29zNkQgPSBNYXRoLmNvcyg2ICogZCk7CiAgICBjb25zdCBzaW44RCA9IE1hdGguc2luKDggKiBkKTsKICAgIGNvbnN0IGNvczhEID0gTWF0aC5jb3MoOCAqIGQpOwogICAgY29uc3Qgc2luMTBEID0gTWF0aC5zaW4oMTAgKiBkKTsKICAgIGNvbnN0IGNvczEwRCA9IE1hdGguY29zKDEwICogZCk7CiAgICBjb25zdCBzaW4xMkQgPSBNYXRoLnNpbigxMiAqIGQpOwogICAgcmV0dXJuIGQgKyBkICogZTIgLyA0ICsgNyAqIGQgKiBlNCAvIDY0ICsgMTUgKiBkICogZTYgLyAyNTYgKyA1NzkgKiBkICogZTggLyAxNjM4NCArIDE1MTUgKiBkICogZTEwIC8gNjU1MzYgKyAxNjgzNyAqIGQgKiBlMTIgLyAxMDQ4NTc2ICsgKDMgKiBkICogZTQgLyAxNiArIDQ1ICogZCAqIGU2IC8gMjU2IC0gZCAqICgzMiAqIGQyIC0gNTYxKSAqIGU4IC8gNDA5NiAtIGQgKiAoMjMyICogZDIgLSAxNjc3KSAqIGUxMCAvIDE2Mzg0ICsgZCAqICgzOTk5ODUgLSA5MDU2MCAqIGQyICsgNTEyICogZDQpICogZTEyIC8gNTI0Mjg4MCkgKiBjb3MyRCArICgyMSAqIGQgKiBlNiAvIDI1NiArIDQ4MyAqIGQgKiBlOCAvIDQwOTYgLSBkICogKDIyNCAqIGQyIC0gMTk2OSkgKiBlMTAgLyAxNjM4NCAtIGQgKiAoMzMxNTIgKiBkMiAtIDExMjU5OSkgKiBlMTIgLyAxMDQ4NTc2KSAqIGNvczREICsgKDE1MSAqIGQgKiBlOCAvIDQwOTYgKyA0NjgxICogZCAqIGUxMCAvIDY1NTM2ICsgMTQ3OSAqIGQgKiBlMTIgLyAxNjM4NCAtIDQ1MyAqIGQzICogZTEyIC8gMzI3NjgpICogY29zNkQgKyAoMTA5NyAqIGQgKiBlMTAgLyA2NTUzNiArIDQyNzgzICogZCAqIGUxMiAvIDEwNDg1NzYpICogY29zOEQgKyA4MDExICogZCAqIGUxMiAvIDEwNDg1NzYgKiBjb3MxMEQgKyAoMyAqIGUyIC8gOCArIDMgKiBlNCAvIDE2ICsgMjEzICogZTYgLyAyMDQ4IC0gMyAqIGQyICogZTYgLyA2NCArIDI1NSAqIGU4IC8gNDA5NiAtIDMzICogZDIgKiBlOCAvIDUxMiArIDIwODYxICogZTEwIC8gNTI0Mjg4IC0gMzMgKiBkMiAqIGUxMCAvIDUxMiArIGQ0ICogZTEwIC8gMTAyNCArIDI4MjczICogZTEyIC8gMTA0ODU3NiAtIDQ3MSAqIGQyICogZTEyIC8gODE5MiArIDkgKiBkNCAqIGUxMiAvIDQwOTYpICogc2luMkQgKyAoMjEgKiBlNCAvIDI1NiArIDIxICogZTYgLyAyNTYgKyA1MzMgKiBlOCAvIDgxOTIgLSAyMSAqIGQyICogZTggLyA1MTIgKyAxOTcgKiBlMTAgLyA0MDk2IC0gMzE1ICogZDIgKiBlMTAgLyA0MDk2ICsgNTg0MDM5ICogZTEyIC8gMTY3NzcyMTYgLSAxMjUxNyAqIGQyICogZTEyIC8gMTMxMDcyICsgNyAqIGQ0ICogZTEyIC8gMjA0OCkgKiBzaW40RCArICgxNTEgKiBlNiAvIDYxNDQgKyAxNTEgKiBlOCAvIDQwOTYgKyA1MDE5ICogZTEwIC8gMTMxMDcyIC0gNDUzICogZDIgKiBlMTAgLyAxNjM4NCArIDI2OTY1ICogZTEyIC8gNzg2NDMyIC0gODYwNyAqIGQyICogZTEyIC8gMTMxMDcyKSAqIHNpbjZEICsgKDEwOTcgKiBlOCAvIDEzMTA3MiArIDEwOTcgKiBlMTAgLyA2NTUzNiArIDIyNTc5NyAqIGUxMiAvIDEwNDg1NzYwIC0gMTA5NyAqIGQyICogZTEyIC8gNjU1MzYpICogc2luOEQgKyAoODAxMSAqIGUxMCAvIDI2MjE0NDAgKyA4MDExICogZTEyIC8gMTA0ODU3NikgKiBzaW4xMEQgKyAyOTMzOTMgKiBlMTIgLyAyNTE2NTgyNDAgKiBzaW4xMkQ7CiAgfQogIGZ1bmN0aW9uIGNhbGN1bGF0ZVNpZ21hKGVsbGlwdGljaXR5LCBsYXRpdHVkZSkgewogICAgaWYgKGVsbGlwdGljaXR5ID09PSAwKSB7CiAgICAgIHJldHVybiBNYXRoLmxvZyhNYXRoLnRhbigwLjUgKiAoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgbGF0aXR1ZGUpKSk7CiAgICB9CiAgICBjb25zdCBlU2luTCA9IGVsbGlwdGljaXR5ICogTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgcmV0dXJuIE1hdGgubG9nKE1hdGgudGFuKDAuNSAqIChNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gKyBsYXRpdHVkZSkpKSAtIGVsbGlwdGljaXR5IC8gMiAqIE1hdGgubG9nKCgxICsgZVNpbkwpIC8gKDEgLSBlU2luTCkpOwogIH0KICBmdW5jdGlvbiBjYWxjdWxhdGVIZWFkaW5nKGVsbGlwc29pZFJodW1iTGluZSwgZmlyc3RMb25naXR1ZGUsIGZpcnN0TGF0aXR1ZGUsIHNlY29uZExvbmdpdHVkZSwgc2Vjb25kTGF0aXR1ZGUpIHsKICAgIGNvbnN0IHNpZ21hMSA9IGNhbGN1bGF0ZVNpZ21hKGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHksIGZpcnN0TGF0aXR1ZGUpOwogICAgY29uc3Qgc2lnbWEyID0gY2FsY3VsYXRlU2lnbWEoCiAgICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHksCiAgICAgIHNlY29uZExhdGl0dWRlCiAgICApOwogICAgcmV0dXJuIE1hdGguYXRhbjIoCiAgICAgIE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShzZWNvbmRMb25naXR1ZGUgLSBmaXJzdExvbmdpdHVkZSksCiAgICAgIHNpZ21hMiAtIHNpZ21hMQogICAgKTsKICB9CiAgZnVuY3Rpb24gY2FsY3VsYXRlQXJjTGVuZ3RoKGVsbGlwc29pZFJodW1iTGluZSwgbWFqb3IsIG1pbm9yLCBmaXJzdExvbmdpdHVkZSwgZmlyc3RMYXRpdHVkZSwgc2Vjb25kTG9uZ2l0dWRlLCBzZWNvbmRMYXRpdHVkZSkgewogICAgY29uc3QgaGVhZGluZyA9IGVsbGlwc29pZFJodW1iTGluZS5faGVhZGluZzsKICAgIGNvbnN0IGRlbHRhTG9uZ2l0dWRlID0gc2Vjb25kTG9uZ2l0dWRlIC0gZmlyc3RMb25naXR1ZGU7CiAgICBsZXQgZGlzdGFuY2UgPSAwOwogICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICBNYXRoLmFicyhoZWFkaW5nKSwKICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPLAogICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjgKICAgICkpIHsKICAgICAgaWYgKG1ham9yID09PSBtaW5vcikgewogICAgICAgIGRpc3RhbmNlID0gbWFqb3IgKiBNYXRoLmNvcyhmaXJzdExhdGl0dWRlKSAqIE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShkZWx0YUxvbmdpdHVkZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc2luUGhpID0gTWF0aC5zaW4oZmlyc3RMYXRpdHVkZSk7CiAgICAgICAgZGlzdGFuY2UgPSBtYWpvciAqIE1hdGguY29zKGZpcnN0TGF0aXR1ZGUpICogTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKGRlbHRhTG9uZ2l0dWRlKSAvIE1hdGguc3FydCgxIC0gZWxsaXBzb2lkUmh1bWJMaW5lLl9lbGxpcHRpY2l0eVNxdWFyZWQgKiBzaW5QaGkgKiBzaW5QaGkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBNMSA9IGNhbGN1bGF0ZU0oCiAgICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbGxpcHRpY2l0eSwKICAgICAgICBtYWpvciwKICAgICAgICBmaXJzdExhdGl0dWRlCiAgICAgICk7CiAgICAgIGNvbnN0IE0yID0gY2FsY3VsYXRlTSgKICAgICAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5LAogICAgICAgIG1ham9yLAogICAgICAgIHNlY29uZExhdGl0dWRlCiAgICAgICk7CiAgICAgIGRpc3RhbmNlID0gKE0yIC0gTTEpIC8gTWF0aC5jb3MoaGVhZGluZyk7CiAgICB9CiAgICByZXR1cm4gTWF0aC5hYnMoZGlzdGFuY2UpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUHJvcGVydGllcyhlbGxpcHNvaWRSaHVtYkxpbmUsIHN0YXJ0LCBlbmQsIGVsbGlwc29pZCkgewogICAgY29uc3QgZmlyc3RDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3RhcnQsIHNjcmF0Y2hDYXJ0MiksCiAgICAgIHNjcmF0Y2hDYXJ0MQogICAgKTsKICAgIGNvbnN0IGxhc3RDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oZW5kLCBzY3JhdGNoQ2FydDIpLAogICAgICBzY3JhdGNoQ2FydDIKICAgICk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgInZhbHVlIiwKICAgICAgTWF0aC5hYnMoCiAgICAgICAgTWF0aC5hYnMoQ2FydGVzaWFuM19kZWZhdWx0LmFuZ2xlQmV0d2VlbihmaXJzdENhcnRlc2lhbiwgbGFzdENhcnRlc2lhbikpIC0gTWF0aC5QSQogICAgICApLAogICAgICAwLjAxMjUKICAgICk7CiAgICBjb25zdCBtYWpvciA9IGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgY29uc3QgbWlub3IgPSBlbGxpcHNvaWQubWluaW11bVJhZGl1czsKICAgIGNvbnN0IG1ham9yU3F1YXJlZCA9IG1ham9yICogbWFqb3I7CiAgICBjb25zdCBtaW5vclNxdWFyZWQgPSBtaW5vciAqIG1pbm9yOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbGxpcHRpY2l0eVNxdWFyZWQgPSAobWFqb3JTcXVhcmVkIC0gbWlub3JTcXVhcmVkKSAvIG1ham9yU3F1YXJlZDsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHkgPSBNYXRoLnNxcnQoCiAgICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHlTcXVhcmVkCiAgICApOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9zdGFydCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKAogICAgICBzdGFydCwKICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9zdGFydAogICAgKTsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fc3RhcnQuaGVpZ2h0ID0gMDsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fZW5kID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoZW5kLCBlbGxpcHNvaWRSaHVtYkxpbmUuX2VuZCk7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VuZC5oZWlnaHQgPSAwOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9oZWFkaW5nID0gY2FsY3VsYXRlSGVhZGluZygKICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLAogICAgICBzdGFydC5sb25naXR1ZGUsCiAgICAgIHN0YXJ0LmxhdGl0dWRlLAogICAgICBlbmQubG9uZ2l0dWRlLAogICAgICBlbmQubGF0aXR1ZGUKICAgICk7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2Rpc3RhbmNlID0gY2FsY3VsYXRlQXJjTGVuZ3RoKAogICAgICBlbGxpcHNvaWRSaHVtYkxpbmUsCiAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzLAogICAgICBlbGxpcHNvaWQubWluaW11bVJhZGl1cywKICAgICAgc3RhcnQubG9uZ2l0dWRlLAogICAgICBzdGFydC5sYXRpdHVkZSwKICAgICAgZW5kLmxvbmdpdHVkZSwKICAgICAgZW5kLmxhdGl0dWRlCiAgICApOwogIH0KICBmdW5jdGlvbiBpbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKHN0YXJ0LCBoZWFkaW5nLCBkaXN0YW5jZSwgbWFqb3IsIGVsbGlwdGljaXR5LCByZXN1bHQpIHsKICAgIGlmIChkaXN0YW5jZSA9PT0gMCkgewogICAgICByZXR1cm4gQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc3RhcnQsIHJlc3VsdCk7CiAgICB9CiAgICBjb25zdCBlbGxpcHRpY2l0eVNxdWFyZWQgPSBlbGxpcHRpY2l0eSAqIGVsbGlwdGljaXR5OwogICAgbGV0IGxvbmdpdHVkZTsKICAgIGxldCBsYXRpdHVkZTsKICAgIGxldCBkZWx0YUxvbmdpdHVkZTsKICAgIGlmIChNYXRoLmFicyhNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBNYXRoLmFicyhoZWFkaW5nKSkgPiBNYXRoX2RlZmF1bHQuRVBTSUxPTjgpIHsKICAgICAgY29uc3QgTTEgPSBjYWxjdWxhdGVNKGVsbGlwdGljaXR5LCBtYWpvciwgc3RhcnQubGF0aXR1ZGUpOwogICAgICBjb25zdCBkZWx0YU0gPSBkaXN0YW5jZSAqIE1hdGguY29zKGhlYWRpbmcpOwogICAgICBjb25zdCBNMiA9IE0xICsgZGVsdGFNOwogICAgICBsYXRpdHVkZSA9IGNhbGN1bGF0ZUludmVyc2VNKE0yLCBlbGxpcHRpY2l0eSwgbWFqb3IpOwogICAgICBpZiAoTWF0aC5hYnMoaGVhZGluZykgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSB7CiAgICAgICAgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHN0YXJ0LmxvbmdpdHVkZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc2lnbWExID0gY2FsY3VsYXRlU2lnbWEoZWxsaXB0aWNpdHksIHN0YXJ0LmxhdGl0dWRlKTsKICAgICAgICBjb25zdCBzaWdtYTIgPSBjYWxjdWxhdGVTaWdtYShlbGxpcHRpY2l0eSwgbGF0aXR1ZGUpOwogICAgICAgIGRlbHRhTG9uZ2l0dWRlID0gTWF0aC50YW4oaGVhZGluZykgKiAoc2lnbWEyIC0gc2lnbWExKTsKICAgICAgICBsb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoc3RhcnQubG9uZ2l0dWRlICsgZGVsdGFMb25naXR1ZGUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBsYXRpdHVkZSA9IHN0YXJ0LmxhdGl0dWRlOwogICAgICBsZXQgbG9jYWxSYWQ7CiAgICAgIGlmIChlbGxpcHRpY2l0eSA9PT0gMCkgewogICAgICAgIGxvY2FsUmFkID0gbWFqb3IgKiBNYXRoLmNvcyhzdGFydC5sYXRpdHVkZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc2luUGhpID0gTWF0aC5zaW4oc3RhcnQubGF0aXR1ZGUpOwogICAgICAgIGxvY2FsUmFkID0gbWFqb3IgKiBNYXRoLmNvcyhzdGFydC5sYXRpdHVkZSkgLyBNYXRoLnNxcnQoMSAtIGVsbGlwdGljaXR5U3F1YXJlZCAqIHNpblBoaSAqIHNpblBoaSk7CiAgICAgIH0KICAgICAgZGVsdGFMb25naXR1ZGUgPSBkaXN0YW5jZSAvIGxvY2FsUmFkOwogICAgICBpZiAoaGVhZGluZyA+IDApIHsKICAgICAgICBsb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoc3RhcnQubG9uZ2l0dWRlICsgZGVsdGFMb25naXR1ZGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShzdGFydC5sb25naXR1ZGUgLSBkZWx0YUxvbmdpdHVkZSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICByZXN1bHQubGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICByZXR1cm4gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KGxvbmdpdHVkZSwgbGF0aXR1ZGUsIDApOwogIH0KICBmdW5jdGlvbiBFbGxpcHNvaWRSaHVtYkxpbmUoc3RhcnQsIGVuZCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGU7CiAgICB0aGlzLl9zdGFydCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgdGhpcy5fZW5kID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICB0aGlzLl9oZWFkaW5nID0gdm9pZCAwOwogICAgdGhpcy5fZGlzdGFuY2UgPSB2b2lkIDA7CiAgICB0aGlzLl9lbGxpcHRpY2l0eSA9IHZvaWQgMDsKICAgIHRoaXMuX2VsbGlwdGljaXR5U3F1YXJlZCA9IHZvaWQgMDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3RhcnQpICYmIGRlZmluZWRfZGVmYXVsdChlbmQpKSB7CiAgICAgIGNvbXB1dGVQcm9wZXJ0aWVzKHRoaXMsIHN0YXJ0LCBlbmQsIGUpOwogICAgfQogIH0KICB2YXIgc2NyYXRjaENhcnQxLCBzY3JhdGNoQ2FydDIsIEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZFJodW1iTGluZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkUmh1bWJMaW5lLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHNjcmF0Y2hDYXJ0MSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBzdXJmYWNlIGRpc3RhbmNlIGJldHdlZW4gdGhlIHN0YXJ0IGFuZCBlbmQgcG9pbnQKICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgc3VyZmFjZURpc3RhbmNlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRpc3RhbmNlIiwgdGhpcy5fZGlzdGFuY2UpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fZGlzdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBpbml0aWFsIHBsYW5ldG9kZXRpYyBwb2ludCBvbiB0aGUgcGF0aC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0b2dyYXBoaWN9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGFydDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGZpbmFsIHBsYW5ldG9kZXRpYyBwb2ludCBvbiB0aGUgcGF0aC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0b2dyYXBoaWN9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZW5kOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZW5kOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaGVhZGluZyBmcm9tIHRoZSBzdGFydCBwb2ludCB0byB0aGUgZW5kIHBvaW50LgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBoZWFkaW5nOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRpc3RhbmNlIiwgdGhpcy5fZGlzdGFuY2UpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5faGVhZGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBFbGxpcHNvaWRSaHVtYkxpbmUuZnJvbVN0YXJ0SGVhZGluZ0Rpc3RhbmNlID0gZnVuY3Rpb24oc3RhcnQsIGhlYWRpbmcsIGRpc3RhbmNlLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJoZWFkaW5nIiwgaGVhZGluZyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkaXN0YW5jZSIsIGRpc3RhbmNlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW4oImRpc3RhbmNlIiwgZGlzdGFuY2UsIDApOwogICAgICAgIGNvbnN0IGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgICAgIGNvbnN0IG1ham9yID0gZS5tYXhpbXVtUmFkaXVzOwogICAgICAgIGNvbnN0IG1pbm9yID0gZS5taW5pbXVtUmFkaXVzOwogICAgICAgIGNvbnN0IG1ham9yU3F1YXJlZCA9IG1ham9yICogbWFqb3I7CiAgICAgICAgY29uc3QgbWlub3JTcXVhcmVkID0gbWlub3IgKiBtaW5vcjsKICAgICAgICBjb25zdCBlbGxpcHRpY2l0eSA9IE1hdGguc3FydCgobWFqb3JTcXVhcmVkIC0gbWlub3JTcXVhcmVkKSAvIG1ham9yU3F1YXJlZCk7CiAgICAgICAgaGVhZGluZyA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShoZWFkaW5nKTsKICAgICAgICBjb25zdCBlbmQgPSBpbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgICAgc3RhcnQsCiAgICAgICAgICBoZWFkaW5nLAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICBlLm1heGltdW1SYWRpdXMsCiAgICAgICAgICBlbGxpcHRpY2l0eQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSB8fCBkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSAmJiAhZWxsaXBzb2lkLmVxdWFscyhyZXN1bHQuZWxsaXBzb2lkKSkgewogICAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNvaWRSaHVtYkxpbmUoc3RhcnQsIGVuZCwgZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5zZXRFbmRQb2ludHMoc3RhcnQsIGVuZCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5zZXRFbmRQb2ludHMgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImVuZCIsIGVuZCk7CiAgICAgICAgY29tcHV0ZVByb3BlcnRpZXModGhpcywgc3RhcnQsIGVuZCwgdGhpcy5fZWxsaXBzb2lkKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5pbnRlcnBvbGF0ZVVzaW5nRnJhY3Rpb24gPSBmdW5jdGlvbihmcmFjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICAgIGZyYWN0aW9uICogdGhpcy5fZGlzdGFuY2UsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UgPSBmdW5jdGlvbihkaXN0YW5jZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJkaXN0YW5jZSIsIGRpc3RhbmNlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9kaXN0YW5jZSkgfHwgdGhpcy5fZGlzdGFuY2UgPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiRWxsaXBzb2lkUmh1bWJMaW5lIG11c3QgaGF2ZSBkaXN0aW5jdCBzdGFydCBhbmQgZW5kIHNldC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICAgIHRoaXMuX3N0YXJ0LAogICAgICAgICAgdGhpcy5faGVhZGluZywKICAgICAgICAgIGRpc3RhbmNlLAogICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLm1heGltdW1SYWRpdXMsCiAgICAgICAgICB0aGlzLl9lbGxpcHRpY2l0eSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUuZmluZEludGVyc2VjdGlvbldpdGhMb25naXR1ZGUgPSBmdW5jdGlvbihpbnRlcnNlY3Rpb25Mb25naXR1ZGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiaW50ZXJzZWN0aW9uTG9uZ2l0dWRlIiwgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9kaXN0YW5jZSkgfHwgdGhpcy5fZGlzdGFuY2UgPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiRWxsaXBzb2lkUmh1bWJMaW5lIG11c3QgaGF2ZSBkaXN0aW5jdCBzdGFydCBhbmQgZW5kIHNldC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHRpY2l0eSA9IHRoaXMuX2VsbGlwdGljaXR5OwogICAgICAgIGNvbnN0IGhlYWRpbmcgPSB0aGlzLl9oZWFkaW5nOwogICAgICAgIGNvbnN0IGFic0hlYWRpbmcgPSBNYXRoLmFicyhoZWFkaW5nKTsKICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMuX3N0YXJ0OwogICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShpbnRlcnNlY3Rpb25Mb25naXR1ZGUpOwogICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIE1hdGguYWJzKGludGVyc2VjdGlvbkxvbmdpdHVkZSksCiAgICAgICAgICBNYXRoLlBJLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xNAogICAgICAgICkpIHsKICAgICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5zaWduKHN0YXJ0LmxvbmdpdHVkZSkgKiBNYXRoLlBJOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKE1hdGguYWJzKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIGFic0hlYWRpbmcpIDw9IE1hdGhfZGVmYXVsdC5FUFNJTE9OOCkgewogICAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGludGVyc2VjdGlvbkxvbmdpdHVkZTsKICAgICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHN0YXJ0LmxhdGl0dWRlOwogICAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBNYXRoLmFicyhNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBhYnNIZWFkaW5nKSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OOAogICAgICAgICkpIHsKICAgICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlLAogICAgICAgICAgICBzdGFydC5sb25naXR1ZGUsCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIKICAgICAgICAgICkpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBpbnRlcnNlY3Rpb25Mb25naXR1ZGU7CiAgICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gKiBNYXRoX2RlZmF1bHQuc2lnbihNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBoZWFkaW5nKTsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGhpMSA9IHN0YXJ0LmxhdGl0dWRlOwogICAgICAgIGNvbnN0IGVTaW5QaGkxID0gZWxsaXB0aWNpdHkgKiBNYXRoLnNpbihwaGkxKTsKICAgICAgICBjb25zdCBsZWZ0Q29tcG9uZW50ID0gTWF0aC50YW4oMC41ICogKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIHBoaTEpKSAqIE1hdGguZXhwKChpbnRlcnNlY3Rpb25Mb25naXR1ZGUgLSBzdGFydC5sb25naXR1ZGUpIC8gTWF0aC50YW4oaGVhZGluZykpOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9yID0gKDEgKyBlU2luUGhpMSkgLyAoMSAtIGVTaW5QaGkxKTsKICAgICAgICBsZXQgbmV3UGhpID0gc3RhcnQubGF0aXR1ZGU7CiAgICAgICAgbGV0IHBoaTsKICAgICAgICBkbyB7CiAgICAgICAgICBwaGkgPSBuZXdQaGk7CiAgICAgICAgICBjb25zdCBlU2luUGhpID0gZWxsaXB0aWNpdHkgKiBNYXRoLnNpbihwaGkpOwogICAgICAgICAgY29uc3QgbnVtZXJhdG9yID0gKDEgKyBlU2luUGhpKSAvICgxIC0gZVNpblBoaSk7CiAgICAgICAgICBuZXdQaGkgPSAyICogTWF0aC5hdGFuKAogICAgICAgICAgICBsZWZ0Q29tcG9uZW50ICogTWF0aC5wb3cobnVtZXJhdG9yIC8gZGVub21pbmF0b3IsIGVsbGlwdGljaXR5IC8gMikKICAgICAgICAgICkgLSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgfSB3aGlsZSAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKG5ld1BoaSwgcGhpLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyKSk7CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGludGVyc2VjdGlvbkxvbmdpdHVkZTsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBuZXdQaGk7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5maW5kSW50ZXJzZWN0aW9uV2l0aExhdGl0dWRlID0gZnVuY3Rpb24oaW50ZXJzZWN0aW9uTGF0aXR1ZGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiaW50ZXJzZWN0aW9uTGF0aXR1ZGUiLCBpbnRlcnNlY3Rpb25MYXRpdHVkZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fZGlzdGFuY2UpIHx8IHRoaXMuX2Rpc3RhbmNlID09PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIkVsbGlwc29pZFJodW1iTGluZSBtdXN0IGhhdmUgZGlzdGluY3Qgc3RhcnQgYW5kIGVuZCBzZXQuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXB0aWNpdHkgPSB0aGlzLl9lbGxpcHRpY2l0eTsKICAgICAgICBjb25zdCBoZWFkaW5nID0gdGhpcy5faGVhZGluZzsKICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMuX3N0YXJ0OwogICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIE1hdGguYWJzKGhlYWRpbmcpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT044CiAgICAgICAgKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBzaWdtYTEgPSBjYWxjdWxhdGVTaWdtYShlbGxpcHRpY2l0eSwgc3RhcnQubGF0aXR1ZGUpOwogICAgICAgIGNvbnN0IHNpZ21hMiA9IGNhbGN1bGF0ZVNpZ21hKGVsbGlwdGljaXR5LCBpbnRlcnNlY3Rpb25MYXRpdHVkZSk7CiAgICAgICAgY29uc3QgZGVsdGFMb25naXR1ZGUgPSBNYXRoLnRhbihoZWFkaW5nKSAqIChzaWdtYTIgLSBzaWdtYTEpOwogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShzdGFydC5sb25naXR1ZGUgKyBkZWx0YUxvbmdpdHVkZSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gaW50ZXJzZWN0aW9uTGF0aXR1ZGU7CiAgICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uZ2l0dWRlLCBpbnRlcnNlY3Rpb25MYXRpdHVkZSwgMCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0ID0gRWxsaXBzb2lkUmh1bWJMaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkhpZXJhcmNoeS5qcwogIGZ1bmN0aW9uIFBvbHlnb25IaWVyYXJjaHkocG9zaXRpb25zLCBob2xlcykgewogICAgdGhpcy5wb3NpdGlvbnMgPSBkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSA/IHBvc2l0aW9ucyA6IFtdOwogICAgdGhpcy5ob2xlcyA9IGRlZmluZWRfZGVmYXVsdChob2xlcykgPyBob2xlcyA6IFtdOwogIH0KICB2YXIgUG9seWdvbkhpZXJhcmNoeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlnb25IaWVyYXJjaHkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25IaWVyYXJjaHkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgUG9seWdvbkhpZXJhcmNoeV9kZWZhdWx0ID0gUG9seWdvbkhpZXJhcmNoeTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL2VhcmN1dC9zcmMvZWFyY3V0LmpzCiAgZnVuY3Rpb24gZWFyY3V0KGRhdGEsIGhvbGVJbmRpY2VzLCBkaW0gPSAyKSB7CiAgICBjb25zdCBoYXNIb2xlcyA9IGhvbGVJbmRpY2VzICYmIGhvbGVJbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IG91dGVyTGVuID0gaGFzSG9sZXMgPyBob2xlSW5kaWNlc1swXSAqIGRpbSA6IGRhdGEubGVuZ3RoOwogICAgbGV0IG91dGVyTm9kZSA9IGxpbmtlZExpc3QoZGF0YSwgMCwgb3V0ZXJMZW4sIGRpbSwgdHJ1ZSk7CiAgICBjb25zdCB0cmlhbmdsZXMgPSBbXTsKICAgIGlmICghb3V0ZXJOb2RlIHx8IG91dGVyTm9kZS5uZXh0ID09PSBvdXRlck5vZGUucHJldikgcmV0dXJuIHRyaWFuZ2xlczsKICAgIGxldCBtaW5YLCBtaW5ZLCBpbnZTaXplOwogICAgaWYgKGhhc0hvbGVzKSBvdXRlck5vZGUgPSBlbGltaW5hdGVIb2xlcyhkYXRhLCBob2xlSW5kaWNlcywgb3V0ZXJOb2RlLCBkaW0pOwogICAgaWYgKGRhdGEubGVuZ3RoID4gODAgKiBkaW0pIHsKICAgICAgbWluWCA9IEluZmluaXR5OwogICAgICBtaW5ZID0gSW5maW5pdHk7CiAgICAgIGxldCBtYXhYID0gLUluZmluaXR5OwogICAgICBsZXQgbWF4WSA9IC1JbmZpbml0eTsKICAgICAgZm9yIChsZXQgaSA9IGRpbTsgaSA8IG91dGVyTGVuOyBpICs9IGRpbSkgewogICAgICAgIGNvbnN0IHggPSBkYXRhW2ldOwogICAgICAgIGNvbnN0IHkgPSBkYXRhW2kgKyAxXTsKICAgICAgICBpZiAoeCA8IG1pblgpIG1pblggPSB4OwogICAgICAgIGlmICh5IDwgbWluWSkgbWluWSA9IHk7CiAgICAgICAgaWYgKHggPiBtYXhYKSBtYXhYID0geDsKICAgICAgICBpZiAoeSA+IG1heFkpIG1heFkgPSB5OwogICAgICB9CiAgICAgIGludlNpemUgPSBNYXRoLm1heChtYXhYIC0gbWluWCwgbWF4WSAtIG1pblkpOwogICAgICBpbnZTaXplID0gaW52U2l6ZSAhPT0gMCA/IDMyNzY3IC8gaW52U2l6ZSA6IDA7CiAgICB9CiAgICBlYXJjdXRMaW5rZWQob3V0ZXJOb2RlLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgMCk7CiAgICByZXR1cm4gdHJpYW5nbGVzOwogIH0KICBmdW5jdGlvbiBsaW5rZWRMaXN0KGRhdGEsIHN0YXJ0LCBlbmQsIGRpbSwgY2xvY2t3aXNlKSB7CiAgICBsZXQgbGFzdDsKICAgIGlmIChjbG9ja3dpc2UgPT09IHNpZ25lZEFyZWEoZGF0YSwgc3RhcnQsIGVuZCwgZGltKSA+IDApIHsKICAgICAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpICs9IGRpbSkgbGFzdCA9IGluc2VydE5vZGUoaSAvIGRpbSB8IDAsIGRhdGFbaV0sIGRhdGFbaSArIDFdLCBsYXN0KTsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAobGV0IGkgPSBlbmQgLSBkaW07IGkgPj0gc3RhcnQ7IGkgLT0gZGltKSBsYXN0ID0gaW5zZXJ0Tm9kZShpIC8gZGltIHwgMCwgZGF0YVtpXSwgZGF0YVtpICsgMV0sIGxhc3QpOwogICAgfQogICAgaWYgKGxhc3QgJiYgZXF1YWxzKGxhc3QsIGxhc3QubmV4dCkpIHsKICAgICAgcmVtb3ZlTm9kZShsYXN0KTsKICAgICAgbGFzdCA9IGxhc3QubmV4dDsKICAgIH0KICAgIHJldHVybiBsYXN0OwogIH0KICBmdW5jdGlvbiBmaWx0ZXJQb2ludHMoc3RhcnQsIGVuZCkgewogICAgaWYgKCFzdGFydCkgcmV0dXJuIHN0YXJ0OwogICAgaWYgKCFlbmQpIGVuZCA9IHN0YXJ0OwogICAgbGV0IHAgPSBzdGFydCwgYWdhaW47CiAgICBkbyB7CiAgICAgIGFnYWluID0gZmFsc2U7CiAgICAgIGlmICghcC5zdGVpbmVyICYmIChlcXVhbHMocCwgcC5uZXh0KSB8fCBhcmVhKHAucHJldiwgcCwgcC5uZXh0KSA9PT0gMCkpIHsKICAgICAgICByZW1vdmVOb2RlKHApOwogICAgICAgIHAgPSBlbmQgPSBwLnByZXY7CiAgICAgICAgaWYgKHAgPT09IHAubmV4dCkgYnJlYWs7CiAgICAgICAgYWdhaW4gPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHAgPSBwLm5leHQ7CiAgICAgIH0KICAgIH0gd2hpbGUgKGFnYWluIHx8IHAgIT09IGVuZCk7CiAgICByZXR1cm4gZW5kOwogIH0KICBmdW5jdGlvbiBlYXJjdXRMaW5rZWQoZWFyLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgcGFzcykgewogICAgaWYgKCFlYXIpIHJldHVybjsKICAgIGlmICghcGFzcyAmJiBpbnZTaXplKSBpbmRleEN1cnZlKGVhciwgbWluWCwgbWluWSwgaW52U2l6ZSk7CiAgICBsZXQgc3RvcCA9IGVhcjsKICAgIHdoaWxlIChlYXIucHJldiAhPT0gZWFyLm5leHQpIHsKICAgICAgY29uc3QgcHJldiA9IGVhci5wcmV2OwogICAgICBjb25zdCBuZXh0ID0gZWFyLm5leHQ7CiAgICAgIGlmIChpbnZTaXplID8gaXNFYXJIYXNoZWQoZWFyLCBtaW5YLCBtaW5ZLCBpbnZTaXplKSA6IGlzRWFyKGVhcikpIHsKICAgICAgICB0cmlhbmdsZXMucHVzaChwcmV2LmksIGVhci5pLCBuZXh0LmkpOwogICAgICAgIHJlbW92ZU5vZGUoZWFyKTsKICAgICAgICBlYXIgPSBuZXh0Lm5leHQ7CiAgICAgICAgc3RvcCA9IG5leHQubmV4dDsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBlYXIgPSBuZXh0OwogICAgICBpZiAoZWFyID09PSBzdG9wKSB7CiAgICAgICAgaWYgKCFwYXNzKSB7CiAgICAgICAgICBlYXJjdXRMaW5rZWQoZmlsdGVyUG9pbnRzKGVhciksIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCAxKTsKICAgICAgICB9IGVsc2UgaWYgKHBhc3MgPT09IDEpIHsKICAgICAgICAgIGVhciA9IGN1cmVMb2NhbEludGVyc2VjdGlvbnMoZmlsdGVyUG9pbnRzKGVhciksIHRyaWFuZ2xlcyk7CiAgICAgICAgICBlYXJjdXRMaW5rZWQoZWFyLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgMik7CiAgICAgICAgfSBlbHNlIGlmIChwYXNzID09PSAyKSB7CiAgICAgICAgICBzcGxpdEVhcmN1dChlYXIsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gaXNFYXIoZWFyKSB7CiAgICBjb25zdCBhMyA9IGVhci5wcmV2LCBiID0gZWFyLCBjID0gZWFyLm5leHQ7CiAgICBpZiAoYXJlYShhMywgYiwgYykgPj0gMCkgcmV0dXJuIGZhbHNlOwogICAgY29uc3QgYXggPSBhMy54LCBieCA9IGIueCwgY3ggPSBjLngsIGF5ID0gYTMueSwgYnkgPSBiLnksIGN5ID0gYy55OwogICAgY29uc3QgeDAgPSBNYXRoLm1pbihheCwgYngsIGN4KSwgeTAgPSBNYXRoLm1pbihheSwgYnksIGN5KSwgeDEgPSBNYXRoLm1heChheCwgYngsIGN4KSwgeTEgPSBNYXRoLm1heChheSwgYnksIGN5KTsKICAgIGxldCBwID0gYy5uZXh0OwogICAgd2hpbGUgKHAgIT09IGEzKSB7CiAgICAgIGlmIChwLnggPj0geDAgJiYgcC54IDw9IHgxICYmIHAueSA+PSB5MCAmJiBwLnkgPD0geTEgJiYgcG9pbnRJblRyaWFuZ2xlRXhjZXB0Rmlyc3QoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcC54LCBwLnkpICYmIGFyZWEocC5wcmV2LCBwLCBwLm5leHQpID49IDApIHJldHVybiBmYWxzZTsKICAgICAgcCA9IHAubmV4dDsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiBpc0Vhckhhc2hlZChlYXIsIG1pblgsIG1pblksIGludlNpemUpIHsKICAgIGNvbnN0IGEzID0gZWFyLnByZXYsIGIgPSBlYXIsIGMgPSBlYXIubmV4dDsKICAgIGlmIChhcmVhKGEzLCBiLCBjKSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBheCA9IGEzLngsIGJ4ID0gYi54LCBjeCA9IGMueCwgYXkgPSBhMy55LCBieSA9IGIueSwgY3kgPSBjLnk7CiAgICBjb25zdCB4MCA9IE1hdGgubWluKGF4LCBieCwgY3gpLCB5MCA9IE1hdGgubWluKGF5LCBieSwgY3kpLCB4MSA9IE1hdGgubWF4KGF4LCBieCwgY3gpLCB5MSA9IE1hdGgubWF4KGF5LCBieSwgY3kpOwogICAgY29uc3QgbWluWiA9IHpPcmRlcih4MCwgeTAsIG1pblgsIG1pblksIGludlNpemUpLCBtYXhaID0gek9yZGVyKHgxLCB5MSwgbWluWCwgbWluWSwgaW52U2l6ZSk7CiAgICBsZXQgcCA9IGVhci5wcmV2WiwgbiA9IGVhci5uZXh0WjsKICAgIHdoaWxlIChwICYmIHAueiA+PSBtaW5aICYmIG4gJiYgbi56IDw9IG1heFopIHsKICAgICAgaWYgKHAueCA+PSB4MCAmJiBwLnggPD0geDEgJiYgcC55ID49IHkwICYmIHAueSA8PSB5MSAmJiBwICE9PSBhMyAmJiBwICE9PSBjICYmIHBvaW50SW5UcmlhbmdsZUV4Y2VwdEZpcnN0KGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHAueCwgcC55KSAmJiBhcmVhKHAucHJldiwgcCwgcC5uZXh0KSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgICAgIHAgPSBwLnByZXZaOwogICAgICBpZiAobi54ID49IHgwICYmIG4ueCA8PSB4MSAmJiBuLnkgPj0geTAgJiYgbi55IDw9IHkxICYmIG4gIT09IGEzICYmIG4gIT09IGMgJiYgcG9pbnRJblRyaWFuZ2xlRXhjZXB0Rmlyc3QoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgbi54LCBuLnkpICYmIGFyZWEobi5wcmV2LCBuLCBuLm5leHQpID49IDApIHJldHVybiBmYWxzZTsKICAgICAgbiA9IG4ubmV4dFo7CiAgICB9CiAgICB3aGlsZSAocCAmJiBwLnogPj0gbWluWikgewogICAgICBpZiAocC54ID49IHgwICYmIHAueCA8PSB4MSAmJiBwLnkgPj0geTAgJiYgcC55IDw9IHkxICYmIHAgIT09IGEzICYmIHAgIT09IGMgJiYgcG9pbnRJblRyaWFuZ2xlRXhjZXB0Rmlyc3QoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcC54LCBwLnkpICYmIGFyZWEocC5wcmV2LCBwLCBwLm5leHQpID49IDApIHJldHVybiBmYWxzZTsKICAgICAgcCA9IHAucHJldlo7CiAgICB9CiAgICB3aGlsZSAobiAmJiBuLnogPD0gbWF4WikgewogICAgICBpZiAobi54ID49IHgwICYmIG4ueCA8PSB4MSAmJiBuLnkgPj0geTAgJiYgbi55IDw9IHkxICYmIG4gIT09IGEzICYmIG4gIT09IGMgJiYgcG9pbnRJblRyaWFuZ2xlRXhjZXB0Rmlyc3QoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgbi54LCBuLnkpICYmIGFyZWEobi5wcmV2LCBuLCBuLm5leHQpID49IDApIHJldHVybiBmYWxzZTsKICAgICAgbiA9IG4ubmV4dFo7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gY3VyZUxvY2FsSW50ZXJzZWN0aW9ucyhzdGFydCwgdHJpYW5nbGVzKSB7CiAgICBsZXQgcCA9IHN0YXJ0OwogICAgZG8gewogICAgICBjb25zdCBhMyA9IHAucHJldiwgYiA9IHAubmV4dC5uZXh0OwogICAgICBpZiAoIWVxdWFscyhhMywgYikgJiYgaW50ZXJzZWN0cyhhMywgcCwgcC5uZXh0LCBiKSAmJiBsb2NhbGx5SW5zaWRlKGEzLCBiKSAmJiBsb2NhbGx5SW5zaWRlKGIsIGEzKSkgewogICAgICAgIHRyaWFuZ2xlcy5wdXNoKGEzLmksIHAuaSwgYi5pKTsKICAgICAgICByZW1vdmVOb2RlKHApOwogICAgICAgIHJlbW92ZU5vZGUocC5uZXh0KTsKICAgICAgICBwID0gc3RhcnQgPSBiOwogICAgICB9CiAgICAgIHAgPSBwLm5leHQ7CiAgICB9IHdoaWxlIChwICE9PSBzdGFydCk7CiAgICByZXR1cm4gZmlsdGVyUG9pbnRzKHApOwogIH0KICBmdW5jdGlvbiBzcGxpdEVhcmN1dChzdGFydCwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUpIHsKICAgIGxldCBhMyA9IHN0YXJ0OwogICAgZG8gewogICAgICBsZXQgYiA9IGEzLm5leHQubmV4dDsKICAgICAgd2hpbGUgKGIgIT09IGEzLnByZXYpIHsKICAgICAgICBpZiAoYTMuaSAhPT0gYi5pICYmIGlzVmFsaWREaWFnb25hbChhMywgYikpIHsKICAgICAgICAgIGxldCBjID0gc3BsaXRQb2x5Z29uKGEzLCBiKTsKICAgICAgICAgIGEzID0gZmlsdGVyUG9pbnRzKGEzLCBhMy5uZXh0KTsKICAgICAgICAgIGMgPSBmaWx0ZXJQb2ludHMoYywgYy5uZXh0KTsKICAgICAgICAgIGVhcmN1dExpbmtlZChhMywgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDApOwogICAgICAgICAgZWFyY3V0TGlua2VkKGMsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCAwKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgYiA9IGIubmV4dDsKICAgICAgfQogICAgICBhMyA9IGEzLm5leHQ7CiAgICB9IHdoaWxlIChhMyAhPT0gc3RhcnQpOwogIH0KICBmdW5jdGlvbiBlbGltaW5hdGVIb2xlcyhkYXRhLCBob2xlSW5kaWNlcywgb3V0ZXJOb2RlLCBkaW0pIHsKICAgIGNvbnN0IHF1ZXVlID0gW107CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gaG9sZUluZGljZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgY29uc3Qgc3RhcnQgPSBob2xlSW5kaWNlc1tpXSAqIGRpbTsKICAgICAgY29uc3QgZW5kID0gaSA8IGxlbiAtIDEgPyBob2xlSW5kaWNlc1tpICsgMV0gKiBkaW0gOiBkYXRhLmxlbmd0aDsKICAgICAgY29uc3QgbGlzdCA9IGxpbmtlZExpc3QoZGF0YSwgc3RhcnQsIGVuZCwgZGltLCBmYWxzZSk7CiAgICAgIGlmIChsaXN0ID09PSBsaXN0Lm5leHQpIGxpc3Quc3RlaW5lciA9IHRydWU7CiAgICAgIHF1ZXVlLnB1c2goZ2V0TGVmdG1vc3QobGlzdCkpOwogICAgfQogICAgcXVldWUuc29ydChjb21wYXJlWFlTbG9wZSk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIG91dGVyTm9kZSA9IGVsaW1pbmF0ZUhvbGUocXVldWVbaV0sIG91dGVyTm9kZSk7CiAgICB9CiAgICByZXR1cm4gb3V0ZXJOb2RlOwogIH0KICBmdW5jdGlvbiBjb21wYXJlWFlTbG9wZShhMywgYikgewogICAgbGV0IHJlc3VsdCA9IGEzLnggLSBiLng7CiAgICBpZiAocmVzdWx0ID09PSAwKSB7CiAgICAgIHJlc3VsdCA9IGEzLnkgLSBiLnk7CiAgICAgIGlmIChyZXN1bHQgPT09IDApIHsKICAgICAgICBjb25zdCBhU2xvcGUgPSAoYTMubmV4dC55IC0gYTMueSkgLyAoYTMubmV4dC54IC0gYTMueCk7CiAgICAgICAgY29uc3QgYlNsb3BlID0gKGIubmV4dC55IC0gYi55KSAvIChiLm5leHQueCAtIGIueCk7CiAgICAgICAgcmVzdWx0ID0gYVNsb3BlIC0gYlNsb3BlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBlbGltaW5hdGVIb2xlKGhvbGUsIG91dGVyTm9kZSkgewogICAgY29uc3QgYnJpZGdlID0gZmluZEhvbGVCcmlkZ2UoaG9sZSwgb3V0ZXJOb2RlKTsKICAgIGlmICghYnJpZGdlKSB7CiAgICAgIHJldHVybiBvdXRlck5vZGU7CiAgICB9CiAgICBjb25zdCBicmlkZ2VSZXZlcnNlID0gc3BsaXRQb2x5Z29uKGJyaWRnZSwgaG9sZSk7CiAgICBmaWx0ZXJQb2ludHMoYnJpZGdlUmV2ZXJzZSwgYnJpZGdlUmV2ZXJzZS5uZXh0KTsKICAgIHJldHVybiBmaWx0ZXJQb2ludHMoYnJpZGdlLCBicmlkZ2UubmV4dCk7CiAgfQogIGZ1bmN0aW9uIGZpbmRIb2xlQnJpZGdlKGhvbGUsIG91dGVyTm9kZSkgewogICAgbGV0IHAgPSBvdXRlck5vZGU7CiAgICBjb25zdCBoeCA9IGhvbGUueDsKICAgIGNvbnN0IGh5ID0gaG9sZS55OwogICAgbGV0IHF4ID0gLUluZmluaXR5OwogICAgbGV0IG07CiAgICBpZiAoZXF1YWxzKGhvbGUsIHApKSByZXR1cm4gcDsKICAgIGRvIHsKICAgICAgaWYgKGVxdWFscyhob2xlLCBwLm5leHQpKSByZXR1cm4gcC5uZXh0OwogICAgICBlbHNlIGlmIChoeSA8PSBwLnkgJiYgaHkgPj0gcC5uZXh0LnkgJiYgcC5uZXh0LnkgIT09IHAueSkgewogICAgICAgIGNvbnN0IHggPSBwLnggKyAoaHkgLSBwLnkpICogKHAubmV4dC54IC0gcC54KSAvIChwLm5leHQueSAtIHAueSk7CiAgICAgICAgaWYgKHggPD0gaHggJiYgeCA+IHF4KSB7CiAgICAgICAgICBxeCA9IHg7CiAgICAgICAgICBtID0gcC54IDwgcC5uZXh0LnggPyBwIDogcC5uZXh0OwogICAgICAgICAgaWYgKHggPT09IGh4KSByZXR1cm4gbTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcCA9IHAubmV4dDsKICAgIH0gd2hpbGUgKHAgIT09IG91dGVyTm9kZSk7CiAgICBpZiAoIW0pIHJldHVybiBudWxsOwogICAgY29uc3Qgc3RvcCA9IG07CiAgICBjb25zdCBteCA9IG0ueDsKICAgIGNvbnN0IG15ID0gbS55OwogICAgbGV0IHRhbk1pbiA9IEluZmluaXR5OwogICAgcCA9IG07CiAgICBkbyB7CiAgICAgIGlmIChoeCA+PSBwLnggJiYgcC54ID49IG14ICYmIGh4ICE9PSBwLnggJiYgcG9pbnRJblRyaWFuZ2xlKGh5IDwgbXkgPyBoeCA6IHF4LCBoeSwgbXgsIG15LCBoeSA8IG15ID8gcXggOiBoeCwgaHksIHAueCwgcC55KSkgewogICAgICAgIGNvbnN0IHRhbiA9IE1hdGguYWJzKGh5IC0gcC55KSAvIChoeCAtIHAueCk7CiAgICAgICAgaWYgKGxvY2FsbHlJbnNpZGUocCwgaG9sZSkgJiYgKHRhbiA8IHRhbk1pbiB8fCB0YW4gPT09IHRhbk1pbiAmJiAocC54ID4gbS54IHx8IHAueCA9PT0gbS54ICYmIHNlY3RvckNvbnRhaW5zU2VjdG9yKG0sIHApKSkpIHsKICAgICAgICAgIG0gPSBwOwogICAgICAgICAgdGFuTWluID0gdGFuOwogICAgICAgIH0KICAgICAgfQogICAgICBwID0gcC5uZXh0OwogICAgfSB3aGlsZSAocCAhPT0gc3RvcCk7CiAgICByZXR1cm4gbTsKICB9CiAgZnVuY3Rpb24gc2VjdG9yQ29udGFpbnNTZWN0b3IobSwgcCkgewogICAgcmV0dXJuIGFyZWEobS5wcmV2LCBtLCBwLnByZXYpIDwgMCAmJiBhcmVhKHAubmV4dCwgbSwgbS5uZXh0KSA8IDA7CiAgfQogIGZ1bmN0aW9uIGluZGV4Q3VydmUoc3RhcnQsIG1pblgsIG1pblksIGludlNpemUpIHsKICAgIGxldCBwID0gc3RhcnQ7CiAgICBkbyB7CiAgICAgIGlmIChwLnogPT09IDApIHAueiA9IHpPcmRlcihwLngsIHAueSwgbWluWCwgbWluWSwgaW52U2l6ZSk7CiAgICAgIHAucHJldlogPSBwLnByZXY7CiAgICAgIHAubmV4dFogPSBwLm5leHQ7CiAgICAgIHAgPSBwLm5leHQ7CiAgICB9IHdoaWxlIChwICE9PSBzdGFydCk7CiAgICBwLnByZXZaLm5leHRaID0gbnVsbDsKICAgIHAucHJldlogPSBudWxsOwogICAgc29ydExpbmtlZChwKTsKICB9CiAgZnVuY3Rpb24gc29ydExpbmtlZChsaXN0KSB7CiAgICBsZXQgbnVtTWVyZ2VzOwogICAgbGV0IGluU2l6ZSA9IDE7CiAgICBkbyB7CiAgICAgIGxldCBwID0gbGlzdDsKICAgICAgbGV0IGU7CiAgICAgIGxpc3QgPSBudWxsOwogICAgICBsZXQgdGFpbCA9IG51bGw7CiAgICAgIG51bU1lcmdlcyA9IDA7CiAgICAgIHdoaWxlIChwKSB7CiAgICAgICAgbnVtTWVyZ2VzKys7CiAgICAgICAgbGV0IHEgPSBwOwogICAgICAgIGxldCBwU2l6ZSA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpblNpemU7IGkrKykgewogICAgICAgICAgcFNpemUrKzsKICAgICAgICAgIHEgPSBxLm5leHRaOwogICAgICAgICAgaWYgKCFxKSBicmVhazsKICAgICAgICB9CiAgICAgICAgbGV0IHFTaXplID0gaW5TaXplOwogICAgICAgIHdoaWxlIChwU2l6ZSA+IDAgfHwgcVNpemUgPiAwICYmIHEpIHsKICAgICAgICAgIGlmIChwU2l6ZSAhPT0gMCAmJiAocVNpemUgPT09IDAgfHwgIXEgfHwgcC56IDw9IHEueikpIHsKICAgICAgICAgICAgZSA9IHA7CiAgICAgICAgICAgIHAgPSBwLm5leHRaOwogICAgICAgICAgICBwU2l6ZS0tOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZSA9IHE7CiAgICAgICAgICAgIHEgPSBxLm5leHRaOwogICAgICAgICAgICBxU2l6ZS0tOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRhaWwpIHRhaWwubmV4dFogPSBlOwogICAgICAgICAgZWxzZSBsaXN0ID0gZTsKICAgICAgICAgIGUucHJldlogPSB0YWlsOwogICAgICAgICAgdGFpbCA9IGU7CiAgICAgICAgfQogICAgICAgIHAgPSBxOwogICAgICB9CiAgICAgIHRhaWwubmV4dFogPSBudWxsOwogICAgICBpblNpemUgKj0gMjsKICAgIH0gd2hpbGUgKG51bU1lcmdlcyA+IDEpOwogICAgcmV0dXJuIGxpc3Q7CiAgfQogIGZ1bmN0aW9uIHpPcmRlcih4LCB5LCBtaW5YLCBtaW5ZLCBpbnZTaXplKSB7CiAgICB4ID0gKHggLSBtaW5YKSAqIGludlNpemUgfCAwOwogICAgeSA9ICh5IC0gbWluWSkgKiBpbnZTaXplIHwgMDsKICAgIHggPSAoeCB8IHggPDwgOCkgJiAxNjcxMTkzNTsKICAgIHggPSAoeCB8IHggPDwgNCkgJiAyNTI2NDUxMzU7CiAgICB4ID0gKHggfCB4IDw8IDIpICYgODU4OTkzNDU5OwogICAgeCA9ICh4IHwgeCA8PCAxKSAmIDE0MzE2NTU3NjU7CiAgICB5ID0gKHkgfCB5IDw8IDgpICYgMTY3MTE5MzU7CiAgICB5ID0gKHkgfCB5IDw8IDQpICYgMjUyNjQ1MTM1OwogICAgeSA9ICh5IHwgeSA8PCAyKSAmIDg1ODk5MzQ1OTsKICAgIHkgPSAoeSB8IHkgPDwgMSkgJiAxNDMxNjU1NzY1OwogICAgcmV0dXJuIHggfCB5IDw8IDE7CiAgfQogIGZ1bmN0aW9uIGdldExlZnRtb3N0KHN0YXJ0KSB7CiAgICBsZXQgcCA9IHN0YXJ0LCBsZWZ0bW9zdCA9IHN0YXJ0OwogICAgZG8gewogICAgICBpZiAocC54IDwgbGVmdG1vc3QueCB8fCBwLnggPT09IGxlZnRtb3N0LnggJiYgcC55IDwgbGVmdG1vc3QueSkgbGVmdG1vc3QgPSBwOwogICAgICBwID0gcC5uZXh0OwogICAgfSB3aGlsZSAocCAhPT0gc3RhcnQpOwogICAgcmV0dXJuIGxlZnRtb3N0OwogIH0KICBmdW5jdGlvbiBwb2ludEluVHJpYW5nbGUoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcHgsIHB5KSB7CiAgICByZXR1cm4gKGN4IC0gcHgpICogKGF5IC0gcHkpID49IChheCAtIHB4KSAqIChjeSAtIHB5KSAmJiAoYXggLSBweCkgKiAoYnkgLSBweSkgPj0gKGJ4IC0gcHgpICogKGF5IC0gcHkpICYmIChieCAtIHB4KSAqIChjeSAtIHB5KSA+PSAoY3ggLSBweCkgKiAoYnkgLSBweSk7CiAgfQogIGZ1bmN0aW9uIHBvaW50SW5UcmlhbmdsZUV4Y2VwdEZpcnN0KGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHB4LCBweSkgewogICAgcmV0dXJuICEoYXggPT09IHB4ICYmIGF5ID09PSBweSkgJiYgcG9pbnRJblRyaWFuZ2xlKGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHB4LCBweSk7CiAgfQogIGZ1bmN0aW9uIGlzVmFsaWREaWFnb25hbChhMywgYikgewogICAgcmV0dXJuIGEzLm5leHQuaSAhPT0gYi5pICYmIGEzLnByZXYuaSAhPT0gYi5pICYmICFpbnRlcnNlY3RzUG9seWdvbihhMywgYikgJiYgLy8gZG9uZXMndCBpbnRlcnNlY3Qgb3RoZXIgZWRnZXMKICAgIChsb2NhbGx5SW5zaWRlKGEzLCBiKSAmJiBsb2NhbGx5SW5zaWRlKGIsIGEzKSAmJiBtaWRkbGVJbnNpZGUoYTMsIGIpICYmIC8vIGxvY2FsbHkgdmlzaWJsZQogICAgKGFyZWEoYTMucHJldiwgYTMsIGIucHJldikgfHwgYXJlYShhMywgYi5wcmV2LCBiKSkgfHwgLy8gZG9lcyBub3QgY3JlYXRlIG9wcG9zaXRlLWZhY2luZyBzZWN0b3JzCiAgICBlcXVhbHMoYTMsIGIpICYmIGFyZWEoYTMucHJldiwgYTMsIGEzLm5leHQpID4gMCAmJiBhcmVhKGIucHJldiwgYiwgYi5uZXh0KSA+IDApOwogIH0KICBmdW5jdGlvbiBhcmVhKHAsIHEsIHIpIHsKICAgIHJldHVybiAocS55IC0gcC55KSAqIChyLnggLSBxLngpIC0gKHEueCAtIHAueCkgKiAoci55IC0gcS55KTsKICB9CiAgZnVuY3Rpb24gZXF1YWxzKHAxLCBwMikgewogICAgcmV0dXJuIHAxLnggPT09IHAyLnggJiYgcDEueSA9PT0gcDIueTsKICB9CiAgZnVuY3Rpb24gaW50ZXJzZWN0cyhwMSwgcTEyLCBwMiwgcTIyKSB7CiAgICBjb25zdCBvMSA9IHNpZ24yKGFyZWEocDEsIHExMiwgcDIpKTsKICAgIGNvbnN0IG8yID0gc2lnbjIoYXJlYShwMSwgcTEyLCBxMjIpKTsKICAgIGNvbnN0IG8zID0gc2lnbjIoYXJlYShwMiwgcTIyLCBwMSkpOwogICAgY29uc3QgbzQgPSBzaWduMihhcmVhKHAyLCBxMjIsIHExMikpOwogICAgaWYgKG8xICE9PSBvMiAmJiBvMyAhPT0gbzQpIHJldHVybiB0cnVlOwogICAgaWYgKG8xID09PSAwICYmIG9uU2VnbWVudChwMSwgcDIsIHExMikpIHJldHVybiB0cnVlOwogICAgaWYgKG8yID09PSAwICYmIG9uU2VnbWVudChwMSwgcTIyLCBxMTIpKSByZXR1cm4gdHJ1ZTsKICAgIGlmIChvMyA9PT0gMCAmJiBvblNlZ21lbnQocDIsIHAxLCBxMjIpKSByZXR1cm4gdHJ1ZTsKICAgIGlmIChvNCA9PT0gMCAmJiBvblNlZ21lbnQocDIsIHExMiwgcTIyKSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIG9uU2VnbWVudChwLCBxLCByKSB7CiAgICByZXR1cm4gcS54IDw9IE1hdGgubWF4KHAueCwgci54KSAmJiBxLnggPj0gTWF0aC5taW4ocC54LCByLngpICYmIHEueSA8PSBNYXRoLm1heChwLnksIHIueSkgJiYgcS55ID49IE1hdGgubWluKHAueSwgci55KTsKICB9CiAgZnVuY3Rpb24gc2lnbjIobnVtKSB7CiAgICByZXR1cm4gbnVtID4gMCA/IDEgOiBudW0gPCAwID8gLTEgOiAwOwogIH0KICBmdW5jdGlvbiBpbnRlcnNlY3RzUG9seWdvbihhMywgYikgewogICAgbGV0IHAgPSBhMzsKICAgIGRvIHsKICAgICAgaWYgKHAuaSAhPT0gYTMuaSAmJiBwLm5leHQuaSAhPT0gYTMuaSAmJiBwLmkgIT09IGIuaSAmJiBwLm5leHQuaSAhPT0gYi5pICYmIGludGVyc2VjdHMocCwgcC5uZXh0LCBhMywgYikpIHJldHVybiB0cnVlOwogICAgICBwID0gcC5uZXh0OwogICAgfSB3aGlsZSAocCAhPT0gYTMpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KICBmdW5jdGlvbiBsb2NhbGx5SW5zaWRlKGEzLCBiKSB7CiAgICByZXR1cm4gYXJlYShhMy5wcmV2LCBhMywgYTMubmV4dCkgPCAwID8gYXJlYShhMywgYiwgYTMubmV4dCkgPj0gMCAmJiBhcmVhKGEzLCBhMy5wcmV2LCBiKSA+PSAwIDogYXJlYShhMywgYiwgYTMucHJldikgPCAwIHx8IGFyZWEoYTMsIGEzLm5leHQsIGIpIDwgMDsKICB9CiAgZnVuY3Rpb24gbWlkZGxlSW5zaWRlKGEzLCBiKSB7CiAgICBsZXQgcCA9IGEzOwogICAgbGV0IGluc2lkZSA9IGZhbHNlOwogICAgY29uc3QgcHggPSAoYTMueCArIGIueCkgLyAyOwogICAgY29uc3QgcHkgPSAoYTMueSArIGIueSkgLyAyOwogICAgZG8gewogICAgICBpZiAocC55ID4gcHkgIT09IHAubmV4dC55ID4gcHkgJiYgcC5uZXh0LnkgIT09IHAueSAmJiBweCA8IChwLm5leHQueCAtIHAueCkgKiAocHkgLSBwLnkpIC8gKHAubmV4dC55IC0gcC55KSArIHAueCkKICAgICAgICBpbnNpZGUgPSAhaW5zaWRlOwogICAgICBwID0gcC5uZXh0OwogICAgfSB3aGlsZSAocCAhPT0gYTMpOwogICAgcmV0dXJuIGluc2lkZTsKICB9CiAgZnVuY3Rpb24gc3BsaXRQb2x5Z29uKGEzLCBiKSB7CiAgICBjb25zdCBhMjIgPSBjcmVhdGVOb2RlKGEzLmksIGEzLngsIGEzLnkpLCBiMiA9IGNyZWF0ZU5vZGUoYi5pLCBiLngsIGIueSksIGFuID0gYTMubmV4dCwgYnAgPSBiLnByZXY7CiAgICBhMy5uZXh0ID0gYjsKICAgIGIucHJldiA9IGEzOwogICAgYTIyLm5leHQgPSBhbjsKICAgIGFuLnByZXYgPSBhMjI7CiAgICBiMi5uZXh0ID0gYTIyOwogICAgYTIyLnByZXYgPSBiMjsKICAgIGJwLm5leHQgPSBiMjsKICAgIGIyLnByZXYgPSBicDsKICAgIHJldHVybiBiMjsKICB9CiAgZnVuY3Rpb24gaW5zZXJ0Tm9kZShpLCB4LCB5LCBsYXN0KSB7CiAgICBjb25zdCBwID0gY3JlYXRlTm9kZShpLCB4LCB5KTsKICAgIGlmICghbGFzdCkgewogICAgICBwLnByZXYgPSBwOwogICAgICBwLm5leHQgPSBwOwogICAgfSBlbHNlIHsKICAgICAgcC5uZXh0ID0gbGFzdC5uZXh0OwogICAgICBwLnByZXYgPSBsYXN0OwogICAgICBsYXN0Lm5leHQucHJldiA9IHA7CiAgICAgIGxhc3QubmV4dCA9IHA7CiAgICB9CiAgICByZXR1cm4gcDsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlTm9kZShwKSB7CiAgICBwLm5leHQucHJldiA9IHAucHJldjsKICAgIHAucHJldi5uZXh0ID0gcC5uZXh0OwogICAgaWYgKHAucHJldlopIHAucHJldloubmV4dFogPSBwLm5leHRaOwogICAgaWYgKHAubmV4dFopIHAubmV4dFoucHJldlogPSBwLnByZXZaOwogIH0KICBmdW5jdGlvbiBjcmVhdGVOb2RlKGksIHgsIHkpIHsKICAgIHJldHVybiB7CiAgICAgIGksCiAgICAgIC8vIHZlcnRleCBpbmRleCBpbiBjb29yZGluYXRlcyBhcnJheQogICAgICB4LAogICAgICB5LAogICAgICAvLyB2ZXJ0ZXggY29vcmRpbmF0ZXMKICAgICAgcHJldjogbnVsbCwKICAgICAgLy8gcHJldmlvdXMgYW5kIG5leHQgdmVydGV4IG5vZGVzIGluIGEgcG9seWdvbiByaW5nCiAgICAgIG5leHQ6IG51bGwsCiAgICAgIHo6IDAsCiAgICAgIC8vIHotb3JkZXIgY3VydmUgdmFsdWUKICAgICAgcHJldlo6IG51bGwsCiAgICAgIC8vIHByZXZpb3VzIGFuZCBuZXh0IG5vZGVzIGluIHotb3JkZXIKICAgICAgbmV4dFo6IG51bGwsCiAgICAgIHN0ZWluZXI6IGZhbHNlCiAgICAgIC8vIGluZGljYXRlcyB3aGV0aGVyIHRoaXMgaXMgYSBzdGVpbmVyIHBvaW50CiAgICB9OwogIH0KICBmdW5jdGlvbiBzaWduZWRBcmVhKGRhdGEsIHN0YXJ0LCBlbmQsIGRpbSkgewogICAgbGV0IHN1bSA9IDA7CiAgICBmb3IgKGxldCBpID0gc3RhcnQsIGogPSBlbmQgLSBkaW07IGkgPCBlbmQ7IGkgKz0gZGltKSB7CiAgICAgIHN1bSArPSAoZGF0YVtqXSAtIGRhdGFbaV0pICogKGRhdGFbaSArIDFdICsgZGF0YVtqICsgMV0pOwogICAgICBqID0gaTsKICAgIH0KICAgIHJldHVybiBzdW07CiAgfQogIHZhciBpbml0X2VhcmN1dCA9IF9fZXNtKHsKICAgICJub2RlX21vZHVsZXMvZWFyY3V0L3NyYy9lYXJjdXQuanMiKCkgewogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2luZGluZ09yZGVyLmpzCiAgdmFyIFdpbmRpbmdPcmRlciwgV2luZGluZ09yZGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfV2luZGluZ09yZGVyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XaW5kaW5nT3JkZXIuanMiKCkgewogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIFdpbmRpbmdPcmRlciA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBWZXJ0aWNlcyBhcmUgaW4gY2xvY2t3aXNlIG9yZGVyLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBDTE9DS1dJU0U6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ1csCiAgICAgICAgLyoqCiAgICAgICAgICogVmVydGljZXMgYXJlIGluIGNvdW50ZXItY2xvY2t3aXNlIG9yZGVyLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBDT1VOVEVSX0NMT0NLV0lTRTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DQ1cKICAgICAgfTsKICAgICAgV2luZGluZ09yZGVyLnZhbGlkYXRlID0gZnVuY3Rpb24od2luZGluZ09yZGVyKSB7CiAgICAgICAgcmV0dXJuIHdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyLkNMT0NLV0lTRSB8fCB3aW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlci5DT1VOVEVSX0NMT0NLV0lTRTsKICAgICAgfTsKICAgICAgV2luZGluZ09yZGVyX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFdpbmRpbmdPcmRlcik7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uUGlwZWxpbmUuanMKICB2YXIgc2NhbGVUb0dlb2RldGljSGVpZ2h0Tiwgc2NhbGVUb0dlb2RldGljSGVpZ2h0UCwgUG9seWdvblBpcGVsaW5lLCBzdWJkaXZpc2lvblYwU2NyYXRjaCwgc3ViZGl2aXNpb25WMVNjcmF0Y2gsIHN1YmRpdmlzaW9uVjJTY3JhdGNoLCBzdWJkaXZpc2lvblMwU2NyYXRjaCwgc3ViZGl2aXNpb25TMVNjcmF0Y2gsIHN1YmRpdmlzaW9uUzJTY3JhdGNoLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gsIHN1YmRpdmlzaW9uVDBTY3JhdGNoLCBzdWJkaXZpc2lvblQxU2NyYXRjaCwgc3ViZGl2aXNpb25UMlNjcmF0Y2gsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoLCBzdWJkaXZpc2lvbkMwU2NyYXRjaCwgc3ViZGl2aXNpb25DMVNjcmF0Y2gsIHN1YmRpdmlzaW9uQzJTY3JhdGNoLCBzdWJkaXZpc2lvbkNhcnRvZ3JhcGhpY1NjcmF0Y2gsIFBvbHlnb25QaXBlbGluZV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlnb25QaXBlbGluZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvblBpcGVsaW5lLmpzIigpIHsKICAgICAgaW5pdF9lYXJjdXQoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkUmh1bWJMaW5lKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfV2luZGluZ09yZGVyKCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodE4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodFAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25QaXBlbGluZSA9IHt9OwogICAgICBQb2x5Z29uUGlwZWxpbmUuY29tcHV0ZUFyZWEyRCA9IGZ1bmN0aW9uKHBvc2l0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgICAgICJwb3NpdGlvbnMubGVuZ3RoIiwKICAgICAgICAgIHBvc2l0aW9ucy5sZW5ndGgsCiAgICAgICAgICAzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBhcmVhMiA9IDA7CiAgICAgICAgZm9yIChsZXQgaTAgPSBsZW5ndGggLSAxLCBpMSA9IDA7IGkxIDwgbGVuZ3RoOyBpMCA9IGkxKyspIHsKICAgICAgICAgIGNvbnN0IHYwMiA9IHBvc2l0aW9uc1tpMF07CiAgICAgICAgICBjb25zdCB2MTIgPSBwb3NpdGlvbnNbaTFdOwogICAgICAgICAgYXJlYTIgKz0gdjAyLnggKiB2MTIueSAtIHYxMi54ICogdjAyLnk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcmVhMiAqIDAuNTsKICAgICAgfTsKICAgICAgUG9seWdvblBpcGVsaW5lLmNvbXB1dGVXaW5kaW5nT3JkZXIyRCA9IGZ1bmN0aW9uKHBvc2l0aW9ucykgewogICAgICAgIGNvbnN0IGFyZWEyID0gUG9seWdvblBpcGVsaW5lLmNvbXB1dGVBcmVhMkQocG9zaXRpb25zKTsKICAgICAgICByZXR1cm4gYXJlYTIgPiAwID8gV2luZGluZ09yZGVyX2RlZmF1bHQuQ09VTlRFUl9DTE9DS1dJU0UgOiBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DTE9DS1dJU0U7CiAgICAgIH07CiAgICAgIFBvbHlnb25QaXBlbGluZS50cmlhbmd1bGF0ZSA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgaG9sZXMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgZmxhdHRlbmVkUG9zaXRpb25zID0gQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2tBcnJheShwb3NpdGlvbnMpOwogICAgICAgIHJldHVybiBlYXJjdXQoZmxhdHRlbmVkUG9zaXRpb25zLCBob2xlcywgMik7CiAgICAgIH07CiAgICAgIHN1YmRpdmlzaW9uVjBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblYxU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25WMlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uUzBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblMxU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25TMlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25UMFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uVDFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblQyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25QaXBlbGluZS5jb21wdXRlU3ViZGl2aXNpb24gPSBmdW5jdGlvbihlbGxpcHNvaWQsIHBvc2l0aW9ucywgaW5kaWNlcywgdGV4Y29vcmRzLCBncmFudWxhcml0eSkgewogICAgICAgIGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZ3JhbnVsYXJpdHksIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUpOwogICAgICAgIGNvbnN0IGhhc1RleGNvb3JkcyA9IGRlZmluZWRfZGVmYXVsdCh0ZXhjb29yZHMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZWxsaXBzb2lkIiwgZWxsaXBzb2lkKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJpbmRpY2VzIiwgaW5kaWNlcyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGljZXMubGVuZ3RoIiwgaW5kaWNlcy5sZW5ndGgsIDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5lcXVhbHMoImluZGljZXMubGVuZ3RoICUgMyIsICIwIiwgaW5kaWNlcy5sZW5ndGggJSAzLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW4oImdyYW51bGFyaXR5IiwgZ3JhbnVsYXJpdHksIDApOwogICAgICAgIGNvbnN0IHRyaWFuZ2xlcyA9IGluZGljZXMuc2xpY2UoMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBzdWJkaXZpZGVkUG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCAqIDMpOwogICAgICAgIGNvbnN0IHN1YmRpdmlkZWRUZXhjb29yZHMgPSBuZXcgQXJyYXkobGVuZ3RoICogMik7CiAgICAgICAgbGV0IHEgPSAwOwogICAgICAgIGxldCBwID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGl0ZW0gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtLng7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtLnk7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtLno7CiAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgIGNvbnN0IHRleGNvb3JkSXRlbSA9IHRleGNvb3Jkc1tpXTsKICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkc1twKytdID0gdGV4Y29vcmRJdGVtLng7CiAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHNbcCsrXSA9IHRleGNvb3JkSXRlbS55OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBzdWJkaXZpZGVkSW5kaWNlcyA9IFtdOwogICAgICAgIGNvbnN0IGVkZ2VzID0ge307CiAgICAgICAgY29uc3QgcmFkaXVzID0gZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICAgICAgY29uc3QgbWluRGlzdGFuY2UgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoZ3JhbnVsYXJpdHksIHJhZGl1cyk7CiAgICAgICAgY29uc3QgbWluRGlzdGFuY2VTcXJkID0gbWluRGlzdGFuY2UgKiBtaW5EaXN0YW5jZTsKICAgICAgICB3aGlsZSAodHJpYW5nbGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IGkyID0gdHJpYW5nbGVzLnBvcCgpOwogICAgICAgICAgY29uc3QgaTEgPSB0cmlhbmdsZXMucG9wKCk7CiAgICAgICAgICBjb25zdCBpMCA9IHRyaWFuZ2xlcy5wb3AoKTsKICAgICAgICAgIGNvbnN0IHYwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgIGkwICogMywKICAgICAgICAgICAgc3ViZGl2aXNpb25WMFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB2MTIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICBpMSAqIDMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uVjFTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdjIyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgaTIgKiAzLAogICAgICAgICAgICBzdWJkaXZpc2lvblYyU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGxldCB0MCwgdDEsIHQyOwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICB0MCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3JkcywKICAgICAgICAgICAgICBpMCAqIDIsCiAgICAgICAgICAgICAgc3ViZGl2aXNpb25UMFNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdDEgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMsCiAgICAgICAgICAgICAgaTEgKiAyLAogICAgICAgICAgICAgIHN1YmRpdmlzaW9uVDFTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHQyID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLAogICAgICAgICAgICAgIGkyICogMiwKICAgICAgICAgICAgICBzdWJkaXZpc2lvblQyU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgczAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh2MDIsIHN1YmRpdmlzaW9uUzBTY3JhdGNoKSwKICAgICAgICAgICAgcmFkaXVzLAogICAgICAgICAgICBzdWJkaXZpc2lvblMwU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHMxID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodjEyLCBzdWJkaXZpc2lvblMxU2NyYXRjaCksCiAgICAgICAgICAgIHJhZGl1cywKICAgICAgICAgICAgc3ViZGl2aXNpb25TMVNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHYyMiwgc3ViZGl2aXNpb25TMlNjcmF0Y2gpLAogICAgICAgICAgICByYWRpdXMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uUzJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgZzAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHMwLCBzMSwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGcxID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzMSwgczIsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBnMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoczIsIHMwLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgbWF4MyA9IE1hdGgubWF4KGcwLCBnMSwgZzIpOwogICAgICAgICAgbGV0IGVkZ2U7CiAgICAgICAgICBsZXQgbWlkOwogICAgICAgICAgbGV0IG1pZFRleGNvb3JkOwogICAgICAgICAgaWYgKG1heDMgPiBtaW5EaXN0YW5jZVNxcmQpIHsKICAgICAgICAgICAgaWYgKGcwID09PSBtYXgzKSB7CiAgICAgICAgICAgICAgZWRnZSA9IGAke01hdGgubWluKGkwLCBpMSl9ICR7TWF0aC5tYXgoaTAsIGkxKX1gOwogICAgICAgICAgICAgIGkgPSBlZGdlc1tlZGdlXTsKICAgICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpKSkgewogICAgICAgICAgICAgICAgbWlkID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCh2MDIsIHYxMiwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZCwgMC41LCBtaWQpOwogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucy5wdXNoKG1pZC54LCBtaWQueSwgbWlkLnopOwogICAgICAgICAgICAgICAgaSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgICAgICAgICAgICBlZGdlc1tlZGdlXSA9IGk7CiAgICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICAgIG1pZFRleGNvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCh0MCwgdDEsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkVGV4Y29vcmQsIDAuNSwgbWlkVGV4Y29vcmQpOwogICAgICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLnB1c2gobWlkVGV4Y29vcmQueCwgbWlkVGV4Y29vcmQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGkwLCBpLCBpMik7CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaSwgaTEsIGkyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChnMSA9PT0gbWF4MykgewogICAgICAgICAgICAgIGVkZ2UgPSBgJHtNYXRoLm1pbihpMSwgaTIpfSAke01hdGgubWF4KGkxLCBpMil9YDsKICAgICAgICAgICAgICBpID0gZWRnZXNbZWRnZV07CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaSkpIHsKICAgICAgICAgICAgICAgIG1pZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodjEyLCB2MjIsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWQsIDAuNSwgbWlkKTsKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMucHVzaChtaWQueCwgbWlkLnksIG1pZC56KTsKICAgICAgICAgICAgICAgIGkgPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgICAgICAgICAgICAgZWRnZXNbZWRnZV0gPSBpOwogICAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgICBtaWRUZXhjb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQodDEsIHQyLCBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZFRleGNvb3JkLCAwLjUsIG1pZFRleGNvb3JkKTsKICAgICAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkcy5wdXNoKG1pZFRleGNvb3JkLngsIG1pZFRleGNvb3JkLnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpMSwgaSwgaTApOwogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGksIGkyLCBpMCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZzIgPT09IG1heDMpIHsKICAgICAgICAgICAgICBlZGdlID0gYCR7TWF0aC5taW4oaTIsIGkwKX0gJHtNYXRoLm1heChpMiwgaTApfWA7CiAgICAgICAgICAgICAgaSA9IGVkZ2VzW2VkZ2VdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBtaWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHYyMiwgdjAyLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkLCAwLjUsIG1pZCk7CiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2gobWlkLngsIG1pZC55LCBtaWQueik7CiAgICAgICAgICAgICAgICBpID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgICAgICAgICAgICAgIGVkZ2VzW2VkZ2VdID0gaTsKICAgICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgICAgbWlkVGV4Y29vcmQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYWRkKHQyLCB0MCwgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWRUZXhjb29yZCwgMC41LCBtaWRUZXhjb29yZCk7CiAgICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaChtaWRUZXhjb29yZC54LCBtaWRUZXhjb29yZC55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaTIsIGksIGkxKTsKICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpLCBpMCwgaTEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdWJkaXZpZGVkSW5kaWNlcy5wdXNoKGkwKTsKICAgICAgICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMSk7CiAgICAgICAgICAgIHN1YmRpdmlkZWRJbmRpY2VzLnB1c2goaTIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeU9wdGlvbnMgPSB7CiAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBzdWJkaXZpZGVkUG9zaXRpb25zCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9LAogICAgICAgICAgaW5kaWNlczogc3ViZGl2aWRlZEluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICAgICAgfTsKICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICBnZW9tZXRyeU9wdGlvbnMuYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFRleGNvb3JkcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdChnZW9tZXRyeU9wdGlvbnMpOwogICAgICB9OwogICAgICBzdWJkaXZpc2lvbkMwU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvbkMxU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvbkMyU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvbkNhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUG9seWdvblBpcGVsaW5lLmNvbXB1dGVSaHVtYkxpbmVTdWJkaXZpc2lvbiA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcG9zaXRpb25zLCBpbmRpY2VzLCB0ZXhjb29yZHMsIGdyYW51bGFyaXR5KSB7CiAgICAgICAgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChncmFudWxhcml0eSwgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRSk7CiAgICAgICAgY29uc3QgaGFzVGV4Y29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KHRleGNvb3Jkcyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbGxpcHNvaWQiLCBlbGxpcHNvaWQpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImluZGljZXMiLCBpbmRpY2VzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kaWNlcy5sZW5ndGgiLCBpbmRpY2VzLmxlbmd0aCwgMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmVxdWFscygiaW5kaWNlcy5sZW5ndGggJSAzIiwgIjAiLCBpbmRpY2VzLmxlbmd0aCAlIDMsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZ3JhbnVsYXJpdHkiLCBncmFudWxhcml0eSwgMCk7CiAgICAgICAgY29uc3QgdHJpYW5nbGVzID0gaW5kaWNlcy5zbGljZSgwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoICogMyk7CiAgICAgICAgY29uc3Qgc3ViZGl2aWRlZFRleGNvb3JkcyA9IG5ldyBBcnJheShsZW5ndGggKiAyKTsKICAgICAgICBsZXQgcSA9IDA7CiAgICAgICAgbGV0IHAgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgaXRlbSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbcSsrXSA9IGl0ZW0ueDsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbcSsrXSA9IGl0ZW0ueTsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbcSsrXSA9IGl0ZW0uejsKICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgY29uc3QgdGV4Y29vcmRJdGVtID0gdGV4Y29vcmRzW2ldOwogICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzW3ArK10gPSB0ZXhjb29yZEl0ZW0ueDsKICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkc1twKytdID0gdGV4Y29vcmRJdGVtLnk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN1YmRpdmlkZWRJbmRpY2VzID0gW107CiAgICAgICAgY29uc3QgZWRnZXMgPSB7fTsKICAgICAgICBjb25zdCByYWRpdXMgPSBlbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgICAgICBjb25zdCBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aChncmFudWxhcml0eSwgcmFkaXVzKTsKICAgICAgICBjb25zdCByaHVtYjAgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQodm9pZCAwLCB2b2lkIDAsIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3Qgcmh1bWIxID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KHZvaWQgMCwgdm9pZCAwLCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IHJodW1iMiA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdCh2b2lkIDAsIHZvaWQgMCwgZWxsaXBzb2lkKTsKICAgICAgICB3aGlsZSAodHJpYW5nbGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IGkyID0gdHJpYW5nbGVzLnBvcCgpOwogICAgICAgICAgY29uc3QgaTEgPSB0cmlhbmdsZXMucG9wKCk7CiAgICAgICAgICBjb25zdCBpMCA9IHRyaWFuZ2xlcy5wb3AoKTsKICAgICAgICAgIGNvbnN0IHYwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgIGkwICogMywKICAgICAgICAgICAgc3ViZGl2aXNpb25WMFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB2MTIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICBpMSAqIDMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uVjFTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdjIyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgaTIgKiAzLAogICAgICAgICAgICBzdWJkaXZpc2lvblYyU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGxldCB0MCwgdDEsIHQyOwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICB0MCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3JkcywKICAgICAgICAgICAgICBpMCAqIDIsCiAgICAgICAgICAgICAgc3ViZGl2aXNpb25UMFNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdDEgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMsCiAgICAgICAgICAgICAgaTEgKiAyLAogICAgICAgICAgICAgIHN1YmRpdmlzaW9uVDFTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHQyID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLAogICAgICAgICAgICAgIGkyICogMiwKICAgICAgICAgICAgICBzdWJkaXZpc2lvblQyU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWModjAyLCBzdWJkaXZpc2lvbkMwU2NyYXRjaCk7CiAgICAgICAgICBjb25zdCBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyh2MTIsIHN1YmRpdmlzaW9uQzFTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHYyMiwgc3ViZGl2aXNpb25DMlNjcmF0Y2gpOwogICAgICAgICAgcmh1bWIwLnNldEVuZFBvaW50cyhjMCwgYzEpOwogICAgICAgICAgY29uc3QgZzAgPSByaHVtYjAuc3VyZmFjZURpc3RhbmNlOwogICAgICAgICAgcmh1bWIxLnNldEVuZFBvaW50cyhjMSwgYzIpOwogICAgICAgICAgY29uc3QgZzEgPSByaHVtYjEuc3VyZmFjZURpc3RhbmNlOwogICAgICAgICAgcmh1bWIyLnNldEVuZFBvaW50cyhjMiwgYzApOwogICAgICAgICAgY29uc3QgZzIgPSByaHVtYjIuc3VyZmFjZURpc3RhbmNlOwogICAgICAgICAgY29uc3QgbWF4MyA9IE1hdGgubWF4KGcwLCBnMSwgZzIpOwogICAgICAgICAgbGV0IGVkZ2U7CiAgICAgICAgICBsZXQgbWlkOwogICAgICAgICAgbGV0IG1pZEhlaWdodDsKICAgICAgICAgIGxldCBtaWRDYXJ0ZXNpYW4zOwogICAgICAgICAgbGV0IG1pZFRleGNvb3JkOwogICAgICAgICAgaWYgKG1heDMgPiBtaW5EaXN0YW5jZSkgewogICAgICAgICAgICBpZiAoZzAgPT09IG1heDMpIHsKICAgICAgICAgICAgICBlZGdlID0gYCR7TWF0aC5taW4oaTAsIGkxKX0gJHtNYXRoLm1heChpMCwgaTEpfWA7CiAgICAgICAgICAgICAgaSA9IGVkZ2VzW2VkZ2VdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBtaWQgPSByaHVtYjAuaW50ZXJwb2xhdGVVc2luZ0ZyYWN0aW9uKAogICAgICAgICAgICAgICAgICAwLjUsCiAgICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uQ2FydG9ncmFwaGljU2NyYXRjaAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIG1pZEhlaWdodCA9IChjMC5oZWlnaHQgKyBjMS5oZWlnaHQpICogMC41OwogICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgICAgICAgbWlkLmxvbmdpdHVkZSwKICAgICAgICAgICAgICAgICAgbWlkLmxhdGl0dWRlLAogICAgICAgICAgICAgICAgICBtaWRIZWlnaHQsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgc3ViZGl2aXNpb25NaWRTY3JhdGNoCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucy5wdXNoKAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLngsCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMueSwKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy56CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgICAgICAgICAgICBlZGdlc1tlZGdlXSA9IGk7CiAgICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICAgIG1pZFRleGNvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCh0MCwgdDEsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkVGV4Y29vcmQsIDAuNSwgbWlkVGV4Y29vcmQpOwogICAgICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLnB1c2gobWlkVGV4Y29vcmQueCwgbWlkVGV4Y29vcmQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGkwLCBpLCBpMik7CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaSwgaTEsIGkyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChnMSA9PT0gbWF4MykgewogICAgICAgICAgICAgIGVkZ2UgPSBgJHtNYXRoLm1pbihpMSwgaTIpfSAke01hdGgubWF4KGkxLCBpMil9YDsKICAgICAgICAgICAgICBpID0gZWRnZXNbZWRnZV07CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaSkpIHsKICAgICAgICAgICAgICAgIG1pZCA9IHJodW1iMS5pbnRlcnBvbGF0ZVVzaW5nRnJhY3Rpb24oCiAgICAgICAgICAgICAgICAgIDAuNSwKICAgICAgICAgICAgICAgICAgc3ViZGl2aXNpb25DYXJ0b2dyYXBoaWNTY3JhdGNoCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgbWlkSGVpZ2h0ID0gKGMxLmhlaWdodCArIGMyLmhlaWdodCkgKiAwLjU7CiAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICAgICAgICBtaWQubG9uZ2l0dWRlLAogICAgICAgICAgICAgICAgICBtaWQubGF0aXR1ZGUsCiAgICAgICAgICAgICAgICAgIG1pZEhlaWdodCwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2goCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMueCwKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy55LAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLnoKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgICAgICAgICAgICAgIGVkZ2VzW2VkZ2VdID0gaTsKICAgICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgICAgbWlkVGV4Y29vcmQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYWRkKHQxLCB0Miwgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWRUZXhjb29yZCwgMC41LCBtaWRUZXhjb29yZCk7CiAgICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaChtaWRUZXhjb29yZC54LCBtaWRUZXhjb29yZC55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaTEsIGksIGkwKTsKICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpLCBpMiwgaTApOwogICAgICAgICAgICB9IGVsc2UgaWYgKGcyID09PSBtYXgzKSB7CiAgICAgICAgICAgICAgZWRnZSA9IGAke01hdGgubWluKGkyLCBpMCl9ICR7TWF0aC5tYXgoaTIsIGkwKX1gOwogICAgICAgICAgICAgIGkgPSBlZGdlc1tlZGdlXTsKICAgICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpKSkgewogICAgICAgICAgICAgICAgbWlkID0gcmh1bWIyLmludGVycG9sYXRlVXNpbmdGcmFjdGlvbigKICAgICAgICAgICAgICAgICAgMC41LAogICAgICAgICAgICAgICAgICBzdWJkaXZpc2lvbkNhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBtaWRIZWlnaHQgPSAoYzIuaGVpZ2h0ICsgYzAuaGVpZ2h0KSAqIDAuNTsKICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgICAgICAgIG1pZC5sb25naXR1ZGUsCiAgICAgICAgICAgICAgICAgIG1pZC5sYXRpdHVkZSwKICAgICAgICAgICAgICAgICAgbWlkSGVpZ2h0LAogICAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uTWlkU2NyYXRjaAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMucHVzaCgKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy54LAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLnksCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMuegogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGkgPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgICAgICAgICAgICAgZWRnZXNbZWRnZV0gPSBpOwogICAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgICBtaWRUZXhjb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQodDIsIHQwLCBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZFRleGNvb3JkLCAwLjUsIG1pZFRleGNvb3JkKTsKICAgICAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkcy5wdXNoKG1pZFRleGNvb3JkLngsIG1pZFRleGNvb3JkLnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpMiwgaSwgaTEpOwogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGksIGkwLCBpMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YmRpdmlkZWRJbmRpY2VzLnB1c2goaTApOwogICAgICAgICAgICBzdWJkaXZpZGVkSW5kaWNlcy5wdXNoKGkxKTsKICAgICAgICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJ5T3B0aW9ucyA9IHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHN1YmRpdmlkZWRQb3NpdGlvbnMKICAgICAgICAgICAgfSkKICAgICAgICAgIH0sCiAgICAgICAgICBpbmRpY2VzOiBzdWJkaXZpZGVkSW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgICAgICB9OwogICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgIGdlb21ldHJ5T3B0aW9ucy5hdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBzdWJkaXZpZGVkVGV4Y29vcmRzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KGdlb21ldHJ5T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFBvbHlnb25QaXBlbGluZS5zY2FsZVRvR2VvZGV0aWNIZWlnaHQgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGhlaWdodCwgZWxsaXBzb2lkLCBzY2FsZVRvU3VyZmFjZTQpIHsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgICAgIGxldCBuID0gc2NhbGVUb0dlb2RldGljSGVpZ2h0TjsKICAgICAgICBsZXQgcCA9IHNjYWxlVG9HZW9kZXRpY0hlaWdodFA7CiAgICAgICAgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVpZ2h0LCAwKTsKICAgICAgICBzY2FsZVRvU3VyZmFjZTQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzY2FsZVRvU3VyZmFjZTQsIHRydWUpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHApOwogICAgICAgICAgICBpZiAoc2NhbGVUb1N1cmZhY2U0KSB7CiAgICAgICAgICAgICAgcCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHAsIHApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoZWlnaHQgIT09IDApIHsKICAgICAgICAgICAgICBuID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBuKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBoZWlnaHQsIG4pOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocCwgbiwgcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9zaXRpb25zW2ldID0gcC54OwogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDFdID0gcC55OwogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDJdID0gcC56OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdCA9IFBvbHlnb25QaXBlbGluZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1ZXVlLmpzCiAgZnVuY3Rpb24gUXVldWUoKSB7CiAgICB0aGlzLl9hcnJheSA9IFtdOwogICAgdGhpcy5fb2Zmc2V0ID0gMDsKICAgIHRoaXMuX2xlbmd0aCA9IDA7CiAgfQogIHZhciBRdWV1ZV9kZWZhdWx0OwogIHZhciBpbml0X1F1ZXVlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9RdWV1ZS5qcyIoKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFF1ZXVlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBsZW5ndGggb2YgdGhlIHF1ZXVlLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFF1ZXVlLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBsZW5ndGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUXVldWUucHJvdG90eXBlLmVucXVldWUgPSBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgdGhpcy5fYXJyYXkucHVzaChpdGVtKTsKICAgICAgICB0aGlzLl9sZW5ndGgrKzsKICAgICAgfTsKICAgICAgUXVldWUucHJvdG90eXBlLmRlcXVldWUgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5fbGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBhcnJheSA9IHRoaXMuX2FycmF5OwogICAgICAgIGxldCBvZmZzZXQgPSB0aGlzLl9vZmZzZXQ7CiAgICAgICAgY29uc3QgaXRlbSA9IGFycmF5W29mZnNldF07CiAgICAgICAgYXJyYXlbb2Zmc2V0XSA9IHZvaWQgMDsKICAgICAgICBvZmZzZXQrKzsKICAgICAgICBpZiAob2Zmc2V0ID4gMTAgJiYgb2Zmc2V0ICogMiA+IGFycmF5Lmxlbmd0aCkgewogICAgICAgICAgdGhpcy5fYXJyYXkgPSBhcnJheS5zbGljZShvZmZzZXQpOwogICAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5fb2Zmc2V0ID0gb2Zmc2V0OwogICAgICAgIHRoaXMuX2xlbmd0aC0tOwogICAgICAgIHJldHVybiBpdGVtOwogICAgICB9OwogICAgICBRdWV1ZS5wcm90b3R5cGUucGVlayA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9hcnJheVt0aGlzLl9vZmZzZXRdOwogICAgICB9OwogICAgICBRdWV1ZS5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FycmF5LmluZGV4T2YoaXRlbSkgIT09IC0xOwogICAgICB9OwogICAgICBRdWV1ZS5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9hcnJheS5sZW5ndGggPSB0aGlzLl9vZmZzZXQgPSB0aGlzLl9sZW5ndGggPSAwOwogICAgICB9OwogICAgICBRdWV1ZS5wcm90b3R5cGUuc29ydCA9IGZ1bmN0aW9uKGNvbXBhcmVGdW5jdGlvbikgewogICAgICAgIGlmICh0aGlzLl9vZmZzZXQgPiAwKSB7CiAgICAgICAgICB0aGlzLl9hcnJheSA9IHRoaXMuX2FycmF5LnNsaWNlKHRoaXMuX29mZnNldCk7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgPSAwOwogICAgICAgIH0KICAgICAgICB0aGlzLl9hcnJheS5zb3J0KGNvbXBhcmVGdW5jdGlvbik7CiAgICAgIH07CiAgICAgIFF1ZXVlX2RlZmF1bHQgPSBRdWV1ZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25HZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBnZXRQb2ludEF0RGlzdGFuY2UyRChwMCwgcDEsIGRpc3RhbmNlLCBsZW5ndGgpIHsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcDAsIGRpc3RhbmNlMkRTY3JhdGNoKTsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBkaXN0YW5jZTJEU2NyYXRjaCwKICAgICAgZGlzdGFuY2UgLyBsZW5ndGgsCiAgICAgIGRpc3RhbmNlMkRTY3JhdGNoCiAgICApOwogICAgQ2FydGVzaWFuMl9kZWZhdWx0LmFkZChwMCwgZGlzdGFuY2UyRFNjcmF0Y2gsIGRpc3RhbmNlMkRTY3JhdGNoKTsKICAgIHJldHVybiBbZGlzdGFuY2UyRFNjcmF0Y2gueCwgZGlzdGFuY2UyRFNjcmF0Y2gueV07CiAgfQogIGZ1bmN0aW9uIGdldFBvaW50QXREaXN0YW5jZShwMCwgcDEsIGRpc3RhbmNlLCBsZW5ndGgpIHsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcDAsIGRpc3RhbmNlU2NyYXRjaDQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGRpc3RhbmNlU2NyYXRjaDQsCiAgICAgIGRpc3RhbmNlIC8gbGVuZ3RoLAogICAgICBkaXN0YW5jZVNjcmF0Y2g0CiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMCwgZGlzdGFuY2VTY3JhdGNoNCwgZGlzdGFuY2VTY3JhdGNoNCk7CiAgICByZXR1cm4gW2Rpc3RhbmNlU2NyYXRjaDQueCwgZGlzdGFuY2VTY3JhdGNoNC55LCBkaXN0YW5jZVNjcmF0Y2g0LnpdOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRXF1YXRvckludGVyc2VjdGlvblJodW1iKHN0YXJ0LCBlbmQsIGVsbGlwc29pZCkgewogICAgY29uc3QgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoc3RhcnQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwKTsKICAgIGNvbnN0IGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGVuZCwgc2NyYXRjaENhcnRvZ3JhcGhpYzEpOwogICAgaWYgKE1hdGguc2lnbihjMC5sYXRpdHVkZSkgPT09IE1hdGguc2lnbihjMS5sYXRpdHVkZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc2NyYXRjaFJodW1iTGluZS5zZXRFbmRQb2ludHMoYzAsIGMxKTsKICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHNjcmF0Y2hSaHVtYkxpbmUuZmluZEludGVyc2VjdGlvbldpdGhMYXRpdHVkZSgKICAgICAgMCwKICAgICAgc2NyYXRjaFJodW1iSW50ZXJzZWN0aW9uCiAgICApOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgbWluTG9uZ2l0dWRlID0gTWF0aC5taW4oYzAubG9uZ2l0dWRlLCBjMS5sb25naXR1ZGUpOwogICAgbGV0IG1heExvbmdpdHVkZSA9IE1hdGgubWF4KGMwLmxvbmdpdHVkZSwgYzEubG9uZ2l0dWRlKTsKICAgIGlmIChNYXRoLmFicyhtYXhMb25naXR1ZGUgLSBtaW5Mb25naXR1ZGUpID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgIGNvbnN0IHN3YXAyID0gbWluTG9uZ2l0dWRlOwogICAgICBtaW5Mb25naXR1ZGUgPSBtYXhMb25naXR1ZGU7CiAgICAgIG1heExvbmdpdHVkZSA9IHN3YXAyOwogICAgfQogICAgaWYgKGludGVyc2VjdGlvbi5sb25naXR1ZGUgPCBtaW5Mb25naXR1ZGUgfHwgaW50ZXJzZWN0aW9uLmxvbmdpdHVkZSA+IG1heExvbmdpdHVkZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGludGVyc2VjdGlvbik7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVFcXVhdG9ySW50ZXJzZWN0aW9uKHN0YXJ0LCBlbmQsIGVsbGlwc29pZCwgYXJjVHlwZSkgewogICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICByZXR1cm4gY29tcHV0ZUVxdWF0b3JJbnRlcnNlY3Rpb25SaHVtYihzdGFydCwgZW5kLCBlbGxpcHNvaWQpOwogICAgfQogICAgY29uc3QgaW50ZXJzZWN0aW9uID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5saW5lU2VnbWVudFBsYW5lKAogICAgICBzdGFydCwKICAgICAgZW5kLAogICAgICBQbGFuZV9kZWZhdWx0Lk9SSUdJTl9YWV9QTEFORQogICAgKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0dXJuIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKGludGVyc2VjdGlvbiwgaW50ZXJzZWN0aW9uKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUVkZ2VzT25QbGFuZShwb3NpdGlvbnMsIGVsbGlwc29pZCwgYXJjVHlwZSkgewogICAgY29uc3QgZWRnZXNPblBsYW5lID0gW107CiAgICBsZXQgc3RhcnRQb2ludCwgZW5kUG9pbnQsIHR5cGUsIG5leHQsIGludGVyc2VjdGlvbiwgaSA9IDA7CiAgICB3aGlsZSAoaSA8IHBvc2l0aW9ucy5sZW5ndGgpIHsKICAgICAgc3RhcnRQb2ludCA9IHBvc2l0aW9uc1tpXTsKICAgICAgZW5kUG9pbnQgPSBwb3NpdGlvbnNbKGkgKyAxKSAlIHBvc2l0aW9ucy5sZW5ndGhdOwogICAgICB0eXBlID0gTWF0aF9kZWZhdWx0LnNpZ24oc3RhcnRQb2ludC56KTsKICAgICAgbmV4dCA9IE1hdGhfZGVmYXVsdC5zaWduKGVuZFBvaW50LnopOwogICAgICBjb25zdCBnZXRMb25naXR1ZGUgPSAocG9zaXRpb24pID0+IHsKICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMwogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlOwogICAgICB9OwogICAgICBpZiAodHlwZSA9PT0gMCkgewogICAgICAgIGVkZ2VzT25QbGFuZS5wdXNoKHsKICAgICAgICAgIHBvc2l0aW9uOiBpLAogICAgICAgICAgdHlwZSwKICAgICAgICAgIHZpc2l0ZWQ6IGZhbHNlLAogICAgICAgICAgbmV4dCwKICAgICAgICAgIHRoZXRhOiBnZXRMb25naXR1ZGUoc3RhcnRQb2ludCkKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChuZXh0ICE9PSAwKSB7CiAgICAgICAgaW50ZXJzZWN0aW9uID0gY29tcHV0ZUVxdWF0b3JJbnRlcnNlY3Rpb24oCiAgICAgICAgICBzdGFydFBvaW50LAogICAgICAgICAgZW5kUG9pbnQsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBhcmNUeXBlCiAgICAgICAgKTsKICAgICAgICArK2k7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHBvc2l0aW9ucy5zcGxpY2UoaSwgMCwgaW50ZXJzZWN0aW9uKTsKICAgICAgICBlZGdlc09uUGxhbmUucHVzaCh7CiAgICAgICAgICBwb3NpdGlvbjogaSwKICAgICAgICAgIHR5cGUsCiAgICAgICAgICB2aXNpdGVkOiBmYWxzZSwKICAgICAgICAgIG5leHQsCiAgICAgICAgICB0aGV0YTogZ2V0TG9uZ2l0dWRlKGludGVyc2VjdGlvbikKICAgICAgICB9KTsKICAgICAgfQogICAgICArK2k7CiAgICB9CiAgICByZXR1cm4gZWRnZXNPblBsYW5lOwogIH0KICBmdW5jdGlvbiB3aXJlUG9seWdvbihwb2x5Z29ucywgcG9seWdvbkluZGV4LCBwb3NpdGlvbnMsIGVkZ2VzT25QbGFuZSwgdG9EZWxldGUsIHN0YXJ0SW5kZXgsIGFib3ZlUGxhbmUpIHsKICAgIGNvbnN0IHBvbHlnb24yID0gW107CiAgICBsZXQgaSA9IHN0YXJ0SW5kZXg7CiAgICBjb25zdCBnZXRNYXRjaGluZ0VkZ2UgPSAoaTIpID0+IChlZGdlKSA9PiBlZGdlLnBvc2l0aW9uID09PSBpMjsKICAgIGNvbnN0IHBvbHlnb25zVG9XaXJlID0gW107CiAgICBkbyB7CiAgICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25zW2ldOwogICAgICBwb2x5Z29uMi5wdXNoKHBvc2l0aW9uKTsKICAgICAgY29uc3QgZWRnZUluZGV4ID0gZWRnZXNPblBsYW5lLmZpbmRJbmRleChnZXRNYXRjaGluZ0VkZ2UoaSkpOwogICAgICBjb25zdCBlZGdlID0gZWRnZXNPblBsYW5lW2VkZ2VJbmRleF07CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVkZ2UpKSB7CiAgICAgICAgKytpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IHsgdmlzaXRlZDogaGFzQmVlblZpc2l0ZWQsIHR5cGUsIG5leHQgfSA9IGVkZ2U7CiAgICAgIGVkZ2UudmlzaXRlZCA9IHRydWU7CiAgICAgIGlmICh0eXBlID09PSAwKSB7CiAgICAgICAgaWYgKG5leHQgPT09IDApIHsKICAgICAgICAgIGNvbnN0IHByZXZpb3VzRWRnZSA9IGVkZ2VzT25QbGFuZVtlZGdlSW5kZXggLSAoYWJvdmVQbGFuZSA/IDEgOiAtMSldOwogICAgICAgICAgaWYgKHByZXZpb3VzRWRnZT8ucG9zaXRpb24gPT09IGkgKyAxKSB7CiAgICAgICAgICAgIHByZXZpb3VzRWRnZS52aXNpdGVkID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICsraTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghaGFzQmVlblZpc2l0ZWQgJiYgYWJvdmVQbGFuZSAmJiBuZXh0ID4gMCB8fCBzdGFydEluZGV4ID09PSBpICYmICFhYm92ZVBsYW5lICYmIG5leHQgPCAwKSB7CiAgICAgICAgICArK2k7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgZm9sbG93RWRnZSA9IGFib3ZlUGxhbmUgPyB0eXBlID49IDAgOiB0eXBlIDw9IDA7CiAgICAgIGlmICghZm9sbG93RWRnZSkgewogICAgICAgICsraTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoIWhhc0JlZW5WaXNpdGVkKSB7CiAgICAgICAgcG9seWdvbnNUb1dpcmUucHVzaChpKTsKICAgICAgfQogICAgICBjb25zdCBuZXh0RWRnZUluZGV4ID0gZWRnZUluZGV4ICsgKGFib3ZlUGxhbmUgPyAxIDogLTEpOwogICAgICBjb25zdCBuZXh0RWRnZSA9IGVkZ2VzT25QbGFuZVtuZXh0RWRnZUluZGV4XTsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobmV4dEVkZ2UpKSB7CiAgICAgICAgKytpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGkgPSBuZXh0RWRnZS5wb3NpdGlvbjsKICAgIH0gd2hpbGUgKGkgPCBwb3NpdGlvbnMubGVuZ3RoICYmIGkgPj0gMCAmJiBpICE9PSBzdGFydEluZGV4ICYmIHBvbHlnb24yLmxlbmd0aCA8IHBvc2l0aW9ucy5sZW5ndGgpOwogICAgcG9seWdvbnMuc3BsaWNlKHBvbHlnb25JbmRleCwgdG9EZWxldGUsIHBvbHlnb24yKTsKICAgIGZvciAoY29uc3QgaW5kZXggb2YgcG9seWdvbnNUb1dpcmUpIHsKICAgICAgcG9seWdvbkluZGV4ID0gd2lyZVBvbHlnb24oCiAgICAgICAgcG9seWdvbnMsCiAgICAgICAgKytwb2x5Z29uSW5kZXgsCiAgICAgICAgcG9zaXRpb25zLAogICAgICAgIGVkZ2VzT25QbGFuZSwKICAgICAgICAwLAogICAgICAgIGluZGV4LAogICAgICAgICFhYm92ZVBsYW5lCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gcG9seWdvbkluZGV4OwogIH0KICB2YXIgUG9seWdvbkdlb21ldHJ5TGlicmFyeSwgZGlzdGFuY2UyRFNjcmF0Y2gsIGRpc3RhbmNlU2NyYXRjaDQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwLCBzY3JhdGNoQ2FydG9ncmFwaGljMSwgc2NyYXRjaENhcnRvZ3JhcGhpYzIyLCBzY3JhdGNoQ2FydGVzaWFuMCwgc2NyYXRjaFJodW1iTGluZSwgc2NhbGVUb0dlb2RldGljSGVpZ2h0TjEsIHNjYWxlVG9HZW9kZXRpY0hlaWdodE4yLCBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQMSwgc2NhbGVUb0dlb2RldGljSGVpZ2h0UDIsIHNjcmF0Y2hSaHVtYkludGVyc2VjdGlvbiwgc2NyYXRjaENhcnRvZ3JhcGhpYzMsIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjIsIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjMsIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZVF1YXRlcm5pb24sIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZU1hdHJpeDMsIGNvbXB1dGVXYWxsVGV4Y29vcmRzU3ViZGl2aWRlZCwgY29tcHV0ZVdhbGxJbmRpY2VzU3ViZGl2aWRlZCwgcDFTY3JhdGNoMiwgcDJTY3JhdGNoMiwgUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlnb25HZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25HZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZFJodW1iTGluZSgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X0ludGVyc2VjdGlvblRlc3RzKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9QbGFuZSgpOwogICAgICBpbml0X1BvbHlnb25IaWVyYXJjaHkoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1F1ZXVlKCk7CiAgICAgIGluaXRfV2luZGluZ09yZGVyKCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoID0gZnVuY3Rpb24ocG9seWdvbkhpZXJhcmNoeSwgQ2FydGVzaWFuWCkgewogICAgICAgIGxldCBudW1Db21wb25lbnRzID0gMDsKICAgICAgICBjb25zdCBzdGFjayA9IFtwb2x5Z29uSGllcmFyY2h5XTsKICAgICAgICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gc3RhY2sucG9wKCk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChoaWVyYXJjaHkpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbnVtQ29tcG9uZW50cyArPSAyOwogICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gaGllcmFyY2h5LnBvc2l0aW9uczsKICAgICAgICAgIGNvbnN0IGhvbGVzID0gaGllcmFyY2h5LmhvbGVzOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpICYmIHBvc2l0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIG51bUNvbXBvbmVudHMgKz0gcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhblgucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChob2xlcykpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gaG9sZXMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgc3RhY2sucHVzaChob2xlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bUNvbXBvbmVudHM7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkucGFja1BvbHlnb25IaWVyYXJjaHkgPSBmdW5jdGlvbihwb2x5Z29uSGllcmFyY2h5LCBhcnJheSwgc3RhcnRpbmdJbmRleCwgQ2FydGVzaWFuWCkgewogICAgICAgIGNvbnN0IHN0YWNrID0gW3BvbHlnb25IaWVyYXJjaHldOwogICAgICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgICAgICBjb25zdCBoaWVyYXJjaHkgPSBzdGFjay5wb3AoKTsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhpZXJhcmNoeSkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBoaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgICAgY29uc3QgaG9sZXMgPSBoaWVyYXJjaHkuaG9sZXM7CiAgICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgPyBwb3NpdGlvbnMubGVuZ3RoIDogMDsKICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBkZWZpbmVkX2RlZmF1bHQoaG9sZXMpID8gaG9sZXMubGVuZ3RoIDogMDsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhblgucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuWC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhvbGVzKSkgewogICAgICAgICAgICBjb25zdCBob2xlc0xlbmd0aCA9IGhvbGVzLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBob2xlc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICAgICAgc3RhY2sucHVzaChob2xlc1tqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0YXJ0aW5nSW5kZXg7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkudW5wYWNrUG9seWdvbkhpZXJhcmNoeSA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCBDYXJ0ZXNpYW5YKSB7CiAgICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBob2xlc0xlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9uc0xlbmd0aCk7CiAgICAgICAgY29uc3QgaG9sZXMgPSBob2xlc0xlbmd0aCA+IDAgPyBuZXcgQXJyYXkoaG9sZXNMZW5ndGgpIDogdm9pZCAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuWC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhblgudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBob2xlc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICBob2xlc1tqXSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkudW5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIENhcnRlc2lhblgKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ID0gaG9sZXNbal0uc3RhcnRpbmdJbmRleDsKICAgICAgICAgIGRlbGV0ZSBob2xlc1tqXS5zdGFydGluZ0luZGV4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaG9sZXMsCiAgICAgICAgICBzdGFydGluZ0luZGV4CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgZGlzdGFuY2UyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGRpc3RhbmNlU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlTGluZUNvdW50ID0gZnVuY3Rpb24ocDAsIHAxLCBtaW5EaXN0YW5jZSkgewogICAgICAgIGNvbnN0IGRpc3RhbmNlID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHAwLCBwMSk7CiAgICAgICAgY29uc3QgbiA9IGRpc3RhbmNlIC8gbWluRGlzdGFuY2U7CiAgICAgICAgY29uc3QgY291bnREaXZpZGUgPSBNYXRoLm1heCgwLCBNYXRoLmNlaWwoTWF0aF9kZWZhdWx0LmxvZzIobikpKTsKICAgICAgICByZXR1cm4gTWF0aC5wb3coMiwgY291bnREaXZpZGUpOwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMSA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMjIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSaHVtYkxpbmUgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQoKTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVSaHVtYkxpbmVDb3VudCA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcDAsIHAxLCBtaW5EaXN0YW5jZSkgewogICAgICAgIGNvbnN0IGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAwLCBzY3JhdGNoQ2FydG9ncmFwaGljMCk7CiAgICAgICAgY29uc3QgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDEsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxKTsKICAgICAgICBjb25zdCByaHVtYiA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdChjMCwgYzEsIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgbiA9IHJodW1iLnN1cmZhY2VEaXN0YW5jZSAvIG1pbkRpc3RhbmNlOwogICAgICAgIGNvbnN0IGNvdW50RGl2aWRlID0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKE1hdGhfZGVmYXVsdC5sb2cyKG4pKSk7CiAgICAgICAgcmV0dXJuIE1hdGgucG93KDIsIGNvdW50RGl2aWRlKTsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVUZXhjb29yZExpbmUgPSBmdW5jdGlvbih0MCwgdDEsIHAwLCBwMSwgbWluRGlzdGFuY2UsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHN1YmRpdmlzaW9ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlTGluZUNvdW50KAogICAgICAgICAgcDAsCiAgICAgICAgICBwMSwKICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsZW5ndGgyRCA9IENhcnRlc2lhbjJfZGVmYXVsdC5kaXN0YW5jZSh0MCwgdDEpOwogICAgICAgIGNvbnN0IGRpc3RhbmNlQmV0d2VlbkNvb3JkcyA9IGxlbmd0aDJEIC8gc3ViZGl2aXNpb25zOwogICAgICAgIGNvbnN0IHRleGNvb3JkcyA9IHJlc3VsdDsKICAgICAgICB0ZXhjb29yZHMubGVuZ3RoID0gc3ViZGl2aXNpb25zICogMjsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3ViZGl2aXNpb25zOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHQgPSBnZXRQb2ludEF0RGlzdGFuY2UyRCh0MCwgdDEsIGkgKiBkaXN0YW5jZUJldHdlZW5Db29yZHMsIGxlbmd0aDJEKTsKICAgICAgICAgIHRleGNvb3Jkc1tpbmRleCsrXSA9IHRbMF07CiAgICAgICAgICB0ZXhjb29yZHNbaW5kZXgrK10gPSB0WzFdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGV4Y29vcmRzOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZUxpbmUgPSBmdW5jdGlvbihwMCwgcDEsIG1pbkRpc3RhbmNlLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlTGluZUNvdW50KAogICAgICAgICAgcDAsCiAgICAgICAgICBwMSwKICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UocDAsIHAxKTsKICAgICAgICBjb25zdCBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlcyA9IGxlbmd0aCAvIG51bVZlcnRpY2VzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSByZXN1bHQ7CiAgICAgICAgcG9zaXRpb25zLmxlbmd0aCA9IG51bVZlcnRpY2VzICogMzsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgY29uc3QgcCA9IGdldFBvaW50QXREaXN0YW5jZShwMCwgcDEsIGkgKiBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlcywgbGVuZ3RoKTsKICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHBbMF07CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwWzFdOwogICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcFsyXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBvc2l0aW9uczsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVUZXhjb29yZFJodW1iTGluZSA9IGZ1bmN0aW9uKHQwLCB0MSwgZWxsaXBzb2lkLCBwMCwgcDEsIG1pbkRpc3RhbmNlLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMCwgc2NyYXRjaENhcnRvZ3JhcGhpYzApOwogICAgICAgIGNvbnN0IGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBzY3JhdGNoQ2FydG9ncmFwaGljMSk7CiAgICAgICAgc2NyYXRjaFJodW1iTGluZS5zZXRFbmRQb2ludHMoYzAsIGMxKTsKICAgICAgICBjb25zdCBuID0gc2NyYXRjaFJodW1iTGluZS5zdXJmYWNlRGlzdGFuY2UgLyBtaW5EaXN0YW5jZTsKICAgICAgICBjb25zdCBjb3VudERpdmlkZSA9IE1hdGgubWF4KDAsIE1hdGguY2VpbChNYXRoX2RlZmF1bHQubG9nMihuKSkpOwogICAgICAgIGNvbnN0IHN1YmRpdmlzaW9ucyA9IE1hdGgucG93KDIsIGNvdW50RGl2aWRlKTsKICAgICAgICBjb25zdCBsZW5ndGgyRCA9IENhcnRlc2lhbjJfZGVmYXVsdC5kaXN0YW5jZSh0MCwgdDEpOwogICAgICAgIGNvbnN0IGRpc3RhbmNlQmV0d2VlbkNvb3JkcyA9IGxlbmd0aDJEIC8gc3ViZGl2aXNpb25zOwogICAgICAgIGNvbnN0IHRleGNvb3JkcyA9IHJlc3VsdDsKICAgICAgICB0ZXhjb29yZHMubGVuZ3RoID0gc3ViZGl2aXNpb25zICogMjsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3ViZGl2aXNpb25zOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHQgPSBnZXRQb2ludEF0RGlzdGFuY2UyRCh0MCwgdDEsIGkgKiBkaXN0YW5jZUJldHdlZW5Db29yZHMsIGxlbmd0aDJEKTsKICAgICAgICAgIHRleGNvb3Jkc1tpbmRleCsrXSA9IHRbMF07CiAgICAgICAgICB0ZXhjb29yZHNbaW5kZXgrK10gPSB0WzFdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGV4Y29vcmRzOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZVJodW1iTGluZSA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcDAsIHAxLCBtaW5EaXN0YW5jZSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDAsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwKTsKICAgICAgICBjb25zdCBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMSwgc2NyYXRjaENhcnRvZ3JhcGhpYzEpOwogICAgICAgIGNvbnN0IHJodW1iID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KGMwLCBjMSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBuID0gcmh1bWIuc3VyZmFjZURpc3RhbmNlIC8gbWluRGlzdGFuY2U7CiAgICAgICAgY29uc3QgY291bnREaXZpZGUgPSBNYXRoLm1heCgwLCBNYXRoLmNlaWwoTWF0aF9kZWZhdWx0LmxvZzIobikpKTsKICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IE1hdGgucG93KDIsIGNvdW50RGl2aWRlKTsKICAgICAgICBjb25zdCBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlcyA9IHJodW1iLnN1cmZhY2VEaXN0YW5jZSAvIG51bVZlcnRpY2VzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSByZXN1bHQ7CiAgICAgICAgcG9zaXRpb25zLmxlbmd0aCA9IG51bVZlcnRpY2VzICogMzsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgY29uc3QgYyA9IHJodW1iLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UoCiAgICAgICAgICAgIGkgKiBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlcywKICAgICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzIyCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjLCBzY3JhdGNoQ2FydGVzaWFuMCk7CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwLng7CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwLnk7CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwLno7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodE4xID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZVRvR2VvZGV0aWNIZWlnaHROMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVUb0dlb2RldGljSGVpZ2h0UDEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodFAyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnNjYWxlVG9HZW9kZXRpY0hlaWdodEV4dHJ1ZGVkID0gZnVuY3Rpb24oZ2VvbWV0cnksIG1heEhlaWdodCwgbWluSGVpZ2h0LCBlbGxpcHNvaWQsIHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KTsKICAgICAgICBjb25zdCBuMSA9IHNjYWxlVG9HZW9kZXRpY0hlaWdodE4xOwogICAgICAgIGxldCBuMiA9IHNjYWxlVG9HZW9kZXRpY0hlaWdodE4yOwogICAgICAgIGNvbnN0IHAgPSBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQMTsKICAgICAgICBsZXQgcDIgPSBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQMjsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlcykgJiYgZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24pKSB7CiAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAyOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgcCk7CiAgICAgICAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCwgbjEpOwogICAgICAgICAgICBwMiA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHAsIHAyKTsKICAgICAgICAgICAgbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuMSwgbWluSGVpZ2h0LCBuMik7CiAgICAgICAgICAgIG4yID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMiwgbjIsIG4yKTsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyBsZW5ndGhdID0gbjIueDsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxICsgbGVuZ3RoXSA9IG4yLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMiArIGxlbmd0aF0gPSBuMi56OwogICAgICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgICAgICBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwLCBwMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuMSwgbWF4SGVpZ2h0LCBuMik7CiAgICAgICAgICAgIG4yID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMiwgbjIsIG4yKTsKICAgICAgICAgICAgcG9zaXRpb25zW2ldID0gbjIueDsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxXSA9IG4yLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMl0gPSBuMi56OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkucG9seWdvbk91dGxpbmVzRnJvbUhpZXJhcmNoeSA9IGZ1bmN0aW9uKHBvbHlnb25IaWVyYXJjaHksIHNjYWxlVG9FbGxpcHNvaWRTdXJmYWNlLCBlbGxpcHNvaWQpIHsKICAgICAgICBjb25zdCBwb2x5Z29ucyA9IFtdOwogICAgICAgIGNvbnN0IHF1ZXVlID0gbmV3IFF1ZXVlX2RlZmF1bHQoKTsKICAgICAgICBxdWV1ZS5lbnF1ZXVlKHBvbHlnb25IaWVyYXJjaHkpOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBqOwogICAgICAgIGxldCBsZW5ndGg7CiAgICAgICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgY29uc3Qgb3V0ZXJOb2RlID0gcXVldWUuZGVxdWV1ZSgpOwogICAgICAgICAgbGV0IG91dGVyUmluZyA9IG91dGVyTm9kZS5wb3NpdGlvbnM7CiAgICAgICAgICBpZiAoc2NhbGVUb0VsbGlwc29pZFN1cmZhY2UpIHsKICAgICAgICAgICAgbGVuZ3RoID0gb3V0ZXJSaW5nLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2Uob3V0ZXJSaW5nW2ldLCBvdXRlclJpbmdbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBvdXRlclJpbmcgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgICAgb3V0ZXJSaW5nLAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChvdXRlclJpbmcubGVuZ3RoIDwgMykgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IG51bUNoaWxkcmVuID0gb3V0ZXJOb2RlLmhvbGVzID8gb3V0ZXJOb2RlLmhvbGVzLmxlbmd0aCA6IDA7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtQ2hpbGRyZW47IGkrKykgewogICAgICAgICAgICBjb25zdCBob2xlID0gb3V0ZXJOb2RlLmhvbGVzW2ldOwogICAgICAgICAgICBsZXQgaG9sZVBvc2l0aW9ucyA9IGhvbGUucG9zaXRpb25zOwogICAgICAgICAgICBpZiAoc2NhbGVUb0VsbGlwc29pZFN1cmZhY2UpIHsKICAgICAgICAgICAgICBsZW5ndGggPSBob2xlUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKGhvbGVQb3NpdGlvbnNbal0sIGhvbGVQb3NpdGlvbnNbal0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBob2xlUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICAgICAgaG9sZVBvc2l0aW9ucywKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChob2xlUG9zaXRpb25zLmxlbmd0aCA8IDMpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb2x5Z29ucy5wdXNoKGhvbGVQb3NpdGlvbnMpOwogICAgICAgICAgICBsZXQgbnVtR3JhbmRjaGlsZHJlbiA9IDA7CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaG9sZS5ob2xlcykpIHsKICAgICAgICAgICAgICBudW1HcmFuZGNoaWxkcmVuID0gaG9sZS5ob2xlcy5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IG51bUdyYW5kY2hpbGRyZW47IGorKykgewogICAgICAgICAgICAgIHF1ZXVlLmVucXVldWUoaG9sZS5ob2xlc1tqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvbHlnb25zLnB1c2gob3V0ZXJSaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBvbHlnb25zOwogICAgICB9OwogICAgICBzY3JhdGNoUmh1bWJJbnRlcnNlY3Rpb24gPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zcGxpdFBvbHlnb25zT25FcXVhdG9yID0gZnVuY3Rpb24ob3V0ZXJSaW5ncywgZWxsaXBzb2lkLCBhcmNUeXBlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnNwbGljZSgwLCAwLCAuLi5vdXRlclJpbmdzKTsKICAgICAgICByZXN1bHQubGVuZ3RoID0gb3V0ZXJSaW5ncy5sZW5ndGg7CiAgICAgICAgbGV0IGN1cnJlbnRQb2x5Z29uID0gMDsKICAgICAgICB3aGlsZSAoY3VycmVudFBvbHlnb24gPCByZXN1bHQubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCBvdXRlclJpbmcgPSByZXN1bHRbY3VycmVudFBvbHlnb25dOwogICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gb3V0ZXJSaW5nLnNsaWNlKCk7CiAgICAgICAgICBpZiAob3V0ZXJSaW5nLmxlbmd0aCA8IDMpIHsKICAgICAgICAgICAgcmVzdWx0W2N1cnJlbnRQb2x5Z29uXSA9IHBvc2l0aW9uczsKICAgICAgICAgICAgKytjdXJyZW50UG9seWdvbjsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBlZGdlc09uUGxhbmUgPSBjb21wdXRlRWRnZXNPblBsYW5lKHBvc2l0aW9ucywgZWxsaXBzb2lkLCBhcmNUeXBlKTsKICAgICAgICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoID09PSBvdXRlclJpbmcubGVuZ3RoIHx8IGVkZ2VzT25QbGFuZS5sZW5ndGggPD0gMSkgewogICAgICAgICAgICByZXN1bHRbY3VycmVudFBvbHlnb25dID0gcG9zaXRpb25zOwogICAgICAgICAgICArK2N1cnJlbnRQb2x5Z29uOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVkZ2VzT25QbGFuZS5zb3J0KChhMywgYikgPT4gewogICAgICAgICAgICByZXR1cm4gYTMudGhldGEgLSBiLnRoZXRhOwogICAgICAgICAgfSk7CiAgICAgICAgICBjb25zdCBub3J0aCA9IHBvc2l0aW9uc1swXS56ID49IDA7CiAgICAgICAgICBjdXJyZW50UG9seWdvbiA9IHdpcmVQb2x5Z29uKAogICAgICAgICAgICByZXN1bHQsCiAgICAgICAgICAgIGN1cnJlbnRQb2x5Z29uLAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIGVkZ2VzT25QbGFuZSwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgbm9ydGgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkucG9seWdvbnNGcm9tSGllcmFyY2h5ID0gZnVuY3Rpb24ocG9seWdvbkhpZXJhcmNoeSwga2VlcER1cGxpY2F0ZXMsIHByb2plY3RQb2ludHNUbzJELCBzY2FsZVRvRWxsaXBzb2lkU3VyZmFjZSwgZWxsaXBzb2lkLCBzcGxpdFBvbHlnb25zKSB7CiAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gW107CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSBbXTsKICAgICAgICBjb25zdCBxdWV1ZSA9IG5ldyBRdWV1ZV9kZWZhdWx0KCk7CiAgICAgICAgcXVldWUuZW5xdWV1ZShwb2x5Z29uSGllcmFyY2h5KTsKICAgICAgICBsZXQgc3BsaXQgPSBkZWZpbmVkX2RlZmF1bHQoc3BsaXRQb2x5Z29ucyk7CiAgICAgICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgY29uc3Qgb3V0ZXJOb2RlID0gcXVldWUuZGVxdWV1ZSgpOwogICAgICAgICAgbGV0IG91dGVyUmluZyA9IG91dGVyTm9kZS5wb3NpdGlvbnM7CiAgICAgICAgICBjb25zdCBob2xlcyA9IG91dGVyTm9kZS5ob2xlczsKICAgICAgICAgIGxldCBpOwogICAgICAgICAgbGV0IGxlbmd0aDsKICAgICAgICAgIGlmIChzY2FsZVRvRWxsaXBzb2lkU3VyZmFjZSkgewogICAgICAgICAgICBsZW5ndGggPSBvdXRlclJpbmcubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShvdXRlclJpbmdbaV0sIG91dGVyUmluZ1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgha2VlcER1cGxpY2F0ZXMpIHsKICAgICAgICAgICAgb3V0ZXJSaW5nID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICAgICAgb3V0ZXJSaW5nLAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uLAogICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvdXRlclJpbmcubGVuZ3RoIDwgMykgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBwb3NpdGlvbnMyRCA9IHByb2plY3RQb2ludHNUbzJEKG91dGVyUmluZyk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMyRCkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBob2xlSW5kaWNlcyA9IFtdOwogICAgICAgICAgbGV0IG9yaWdpbmFsV2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKHBvc2l0aW9uczJEKTsKICAgICAgICAgIGlmIChvcmlnaW5hbFdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgICAgICAgIHBvc2l0aW9uczJELnJldmVyc2UoKTsKICAgICAgICAgICAgb3V0ZXJSaW5nID0gb3V0ZXJSaW5nLnNsaWNlKCkucmV2ZXJzZSgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNwbGl0KSB7CiAgICAgICAgICAgIHNwbGl0ID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBwb2x5Z29uczIgPSBbb3V0ZXJSaW5nXTsKICAgICAgICAgICAgcG9seWdvbnMyID0gc3BsaXRQb2x5Z29ucyhwb2x5Z29uczIsIHBvbHlnb25zMik7CiAgICAgICAgICAgIGlmIChwb2x5Z29uczIubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgIGZvciAoY29uc3QgcG9zaXRpb25zMiBvZiBwb2x5Z29uczIpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLmVucXVldWUobmV3IFBvbHlnb25IaWVyYXJjaHlfZGVmYXVsdChwb3NpdGlvbnMyLCBob2xlcykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbGV0IHBvc2l0aW9ucyA9IG91dGVyUmluZy5zbGljZSgpOwogICAgICAgICAgY29uc3QgbnVtQ2hpbGRyZW4gPSBkZWZpbmVkX2RlZmF1bHQoaG9sZXMpID8gaG9sZXMubGVuZ3RoIDogMDsKICAgICAgICAgIGNvbnN0IHBvbHlnb25Ib2xlcyA9IFtdOwogICAgICAgICAgbGV0IGo7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtQ2hpbGRyZW47IGkrKykgewogICAgICAgICAgICBjb25zdCBob2xlID0gaG9sZXNbaV07CiAgICAgICAgICAgIGxldCBob2xlUG9zaXRpb25zID0gaG9sZS5wb3NpdGlvbnM7CiAgICAgICAgICAgIGlmIChzY2FsZVRvRWxsaXBzb2lkU3VyZmFjZSkgewogICAgICAgICAgICAgIGxlbmd0aCA9IGhvbGVQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBsZW5ndGg7ICsraikgewogICAgICAgICAgICAgICAgZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoaG9sZVBvc2l0aW9uc1tqXSwgaG9sZVBvc2l0aW9uc1tqXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgha2VlcER1cGxpY2F0ZXMpIHsKICAgICAgICAgICAgICBob2xlUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICAgICAgICBob2xlUG9zaXRpb25zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24sCiAgICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9sZVBvc2l0aW9ucy5sZW5ndGggPCAzKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgaG9sZVBvc2l0aW9uczJEID0gcHJvamVjdFBvaW50c1RvMkQoaG9sZVBvc2l0aW9ucyk7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhvbGVQb3NpdGlvbnMyRCkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcmlnaW5hbFdpbmRpbmdPcmRlciA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRChob2xlUG9zaXRpb25zMkQpOwogICAgICAgICAgICBpZiAob3JpZ2luYWxXaW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICAgICAgICAgIGhvbGVQb3NpdGlvbnMyRC5yZXZlcnNlKCk7CiAgICAgICAgICAgICAgaG9sZVBvc2l0aW9ucyA9IGhvbGVQb3NpdGlvbnMuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9seWdvbkhvbGVzLnB1c2goaG9sZVBvc2l0aW9ucyk7CiAgICAgICAgICAgIGhvbGVJbmRpY2VzLnB1c2gocG9zaXRpb25zLmxlbmd0aCk7CiAgICAgICAgICAgIHBvc2l0aW9ucyA9IHBvc2l0aW9ucy5jb25jYXQoaG9sZVBvc2l0aW9ucyk7CiAgICAgICAgICAgIHBvc2l0aW9uczJEID0gcG9zaXRpb25zMkQuY29uY2F0KGhvbGVQb3NpdGlvbnMyRCk7CiAgICAgICAgICAgIGxldCBudW1HcmFuZGNoaWxkcmVuID0gMDsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChob2xlLmhvbGVzKSkgewogICAgICAgICAgICAgIG51bUdyYW5kY2hpbGRyZW4gPSBob2xlLmhvbGVzLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbnVtR3JhbmRjaGlsZHJlbjsgaisrKSB7CiAgICAgICAgICAgICAgcXVldWUuZW5xdWV1ZShob2xlLmhvbGVzW2pdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaGllcmFyY2h5LnB1c2goewogICAgICAgICAgICBvdXRlclJpbmcsCiAgICAgICAgICAgIGhvbGVzOiBwb2x5Z29uSG9sZXMKICAgICAgICAgIH0pOwogICAgICAgICAgcG9seWdvbnMucHVzaCh7CiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgcG9zaXRpb25zMkQsCiAgICAgICAgICAgIGhvbGVzOiBob2xlSW5kaWNlcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBoaWVyYXJjaHksCiAgICAgICAgICBwb2x5Z29ucwogICAgICAgIH07CiAgICAgIH07CiAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjIgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZVF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZU1hdHJpeDMgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlID0gZnVuY3Rpb24ocGxhbmVOb3JtYWwsIHByb2plY3RQb2ludFRvMkQsIHBvc2l0aW9ucywgYW5nbGUsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBwbGFuZU5vcm1hbCwKICAgICAgICAgIGFuZ2xlLAogICAgICAgICAgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgY29uc3QgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlTWF0cml4MwogICAgICAgICk7CiAgICAgICAgbGV0IG1pblggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IG1heFggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IG1pblkgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IG1heFkgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBwID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjMKICAgICAgICAgICk7CiAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0ZXh0dXJlTWF0cml4LCBwLCBwKTsKICAgICAgICAgIGNvbnN0IHN0ID0gcHJvamVjdFBvaW50VG8yRChwLCBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVDYXJ0ZXNpYW4yKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3QpKSB7CiAgICAgICAgICAgIG1pblggPSBNYXRoLm1pbihtaW5YLCBzdC54KTsKICAgICAgICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIHN0LngpOwogICAgICAgICAgICBtaW5ZID0gTWF0aC5taW4obWluWSwgc3QueSk7CiAgICAgICAgICAgIG1heFkgPSBNYXRoLm1heChtYXhZLCBzdC55KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBtaW5YOwogICAgICAgIHJlc3VsdC55ID0gbWluWTsKICAgICAgICByZXN1bHQud2lkdGggPSBtYXhYIC0gbWluWDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gbWF4WSAtIG1pblk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHBvbHlnb24yLCB0ZXh0dXJlQ29vcmRpbmF0ZXMsIGdyYW51bGFyaXR5LCBwZXJQb3NpdGlvbkhlaWdodCwgdmVydGV4Rm9ybWF0LCBhcmNUeXBlKSB7CiAgICAgICAgbGV0IGluZGljZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC50cmlhbmd1bGF0ZShwb2x5Z29uMi5wb3NpdGlvbnMyRCwgcG9seWdvbjIuaG9sZXMpOwogICAgICAgIGlmIChpbmRpY2VzLmxlbmd0aCA8IDMpIHsKICAgICAgICAgIGluZGljZXMgPSBbMCwgMSwgMl07CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlnb24yLnBvc2l0aW9uczsKICAgICAgICBjb25zdCBoYXNUZXhjb29yZHMgPSBkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKTsKICAgICAgICBjb25zdCB0ZXhjb29yZHMgPSBoYXNUZXhjb29yZHMgPyB0ZXh0dXJlQ29vcmRpbmF0ZXMucG9zaXRpb25zIDogdm9pZCAwOwogICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IGZsYXR0ZW5lZFBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGggKiAzKTsKICAgICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgIGZsYXR0ZW5lZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAueDsKICAgICAgICAgICAgZmxhdHRlbmVkUG9zaXRpb25zW2luZGV4KytdID0gcC55OwogICAgICAgICAgICBmbGF0dGVuZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwLno7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBnZW9tZXRyeU9wdGlvbnMgPSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICAgIHZhbHVlczogZmxhdHRlbmVkUG9zaXRpb25zCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgICAgICAgfTsKICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgZ2VvbWV0cnlPcHRpb25zLmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgICB2YWx1ZXM6IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrQXJyYXkodGV4Y29vcmRzKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IEdlb21ldHJ5X2RlZmF1bHQoZ2VvbWV0cnlPcHRpb25zKTsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIHJldHVybiBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZU5vcm1hbChnZW9tZXRyeSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgICAgfQogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgIHJldHVybiBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlU3ViZGl2aXNpb24oCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICB0ZXhjb29yZHMsCiAgICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICByZXR1cm4gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVJodW1iTGluZVN1YmRpdmlzaW9uKAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgdGV4Y29vcmRzLAogICAgICAgICAgICBncmFudWxhcml0eQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbXB1dGVXYWxsVGV4Y29vcmRzU3ViZGl2aWRlZCA9IFtdOwogICAgICBjb21wdXRlV2FsbEluZGljZXNTdWJkaXZpZGVkID0gW107CiAgICAgIHAxU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHAyU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVdhbGxHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgdGV4dHVyZUNvb3JkaW5hdGVzLCBlbGxpcHNvaWQsIGdyYW51bGFyaXR5LCBwZXJQb3NpdGlvbkhlaWdodCwgYXJjVHlwZSkgewogICAgICAgIGxldCBlZGdlUG9zaXRpb25zOwogICAgICAgIGxldCB0b3BFZGdlTGVuZ3RoOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBwMTsKICAgICAgICBsZXQgcDI7CiAgICAgICAgbGV0IHQxOwogICAgICAgIGxldCB0MjsKICAgICAgICBsZXQgZWRnZVRleGNvb3JkczsKICAgICAgICBsZXQgdG9wRWRnZVRleGNvb3JkTGVuZ3RoOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgbGV0IHRleHR1cmVJbmRleCA9IDA7CiAgICAgICAgY29uc3QgaGFzVGV4Y29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcyk7CiAgICAgICAgY29uc3QgdGV4Y29vcmRzID0gaGFzVGV4Y29vcmRzID8gdGV4dHVyZUNvb3JkaW5hdGVzLnBvc2l0aW9ucyA6IHZvaWQgMDsKICAgICAgICBpZiAoIXBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgICBjb25zdCBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aCgKICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzCiAgICAgICAgICApOwogICAgICAgICAgbGV0IG51bVZlcnRpY2VzID0gMDsKICAgICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVMaW5lQ291bnQoCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIG51bVZlcnRpY2VzICs9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlUmh1bWJMaW5lQ291bnQoCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRvcEVkZ2VMZW5ndGggPSAobnVtVmVydGljZXMgKyBsZW5ndGgpICogMzsKICAgICAgICAgIGVkZ2VQb3NpdGlvbnMgPSBuZXcgQXJyYXkodG9wRWRnZUxlbmd0aCAqIDIpOwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICB0b3BFZGdlVGV4Y29vcmRMZW5ndGggPSAobnVtVmVydGljZXMgKyBsZW5ndGgpICogMjsKICAgICAgICAgICAgZWRnZVRleGNvb3JkcyA9IG5ldyBBcnJheSh0b3BFZGdlVGV4Y29vcmRMZW5ndGggKiAyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBwMSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgcDIgPSBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF07CiAgICAgICAgICAgIGxldCB0ZW1wUG9zaXRpb25zOwogICAgICAgICAgICBsZXQgdGVtcFRleGNvb3JkczsKICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgIHQxID0gdGV4Y29vcmRzW2ldOwogICAgICAgICAgICAgIHQyID0gdGV4Y29vcmRzWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgICB0ZW1wUG9zaXRpb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVMaW5lKAogICAgICAgICAgICAgICAgcDEsCiAgICAgICAgICAgICAgICBwMiwKICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgICAgY29tcHV0ZVdhbGxJbmRpY2VzU3ViZGl2aWRlZAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgdGVtcFRleGNvb3JkcyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlVGV4Y29vcmRMaW5lKAogICAgICAgICAgICAgICAgICB0MSwKICAgICAgICAgICAgICAgICAgdDIsCiAgICAgICAgICAgICAgICAgIHAxLAogICAgICAgICAgICAgICAgICBwMiwKICAgICAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgICAgIGNvbXB1dGVXYWxsVGV4Y29vcmRzU3ViZGl2aWRlZAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICAgICAgdGVtcFBvc2l0aW9ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlUmh1bWJMaW5lKAogICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgcDEsCiAgICAgICAgICAgICAgICBwMiwKICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgICAgY29tcHV0ZVdhbGxJbmRpY2VzU3ViZGl2aWRlZAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgdGVtcFRleGNvb3JkcyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlVGV4Y29vcmRSaHVtYkxpbmUoCiAgICAgICAgICAgICAgICAgIHQxLAogICAgICAgICAgICAgICAgICB0MiwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBwMSwKICAgICAgICAgICAgICAgICAgcDIsCiAgICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgICAgICBjb21wdXRlV2FsbFRleGNvb3Jkc1N1YmRpdmlkZWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHRlbXBQb3NpdGlvbnNMZW5ndGggPSB0ZW1wUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0ZW1wUG9zaXRpb25zTGVuZ3RoOyArK2osICsraW5kZXgpIHsKICAgICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IHRlbXBQb3NpdGlvbnNbal07CiAgICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gdGVtcFBvc2l0aW9uc1tqXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IHAyLng7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAyLng7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gcDIueTsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDIueTsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBwMi56OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMi56OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgY29uc3QgdGVtcFRleGNvb3Jkc0xlbmd0aCA9IHRlbXBUZXhjb29yZHMubGVuZ3RoOwogICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgdGVtcFRleGNvb3Jkc0xlbmd0aDsgKytrLCArK3RleHR1cmVJbmRleCkgewogICAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXhdID0gdGVtcFRleGNvb3Jkc1trXTsKICAgICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHRlbXBUZXhjb29yZHNba107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IHQyLng7CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXggKyB0b3BFZGdlVGV4Y29vcmRMZW5ndGhdID0gdDIueDsKICAgICAgICAgICAgICArK3RleHR1cmVJbmRleDsKICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleF0gPSB0Mi55OwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHQyLnk7CiAgICAgICAgICAgICAgKyt0ZXh0dXJlSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdG9wRWRnZUxlbmd0aCA9IGxlbmd0aCAqIDMgKiAyOwogICAgICAgICAgZWRnZVBvc2l0aW9ucyA9IG5ldyBBcnJheSh0b3BFZGdlTGVuZ3RoICogMik7CiAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgIHRvcEVkZ2VUZXhjb29yZExlbmd0aCA9IGxlbmd0aCAqIDIgKiAyOwogICAgICAgICAgICBlZGdlVGV4Y29vcmRzID0gbmV3IEFycmF5KHRvcEVkZ2VUZXhjb29yZExlbmd0aCAqIDIpOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHAxID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICBwMiA9IHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXTsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMS54OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAxLnk7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDEuejsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMi54OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAyLnk7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDIuejsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgIHQxID0gdGV4Y29vcmRzW2ldOwogICAgICAgICAgICAgIHQyID0gdGV4Y29vcmRzWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHQxLng7CiAgICAgICAgICAgICAgKyt0ZXh0dXJlSW5kZXg7CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXhdID0gZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXggKyB0b3BFZGdlVGV4Y29vcmRMZW5ndGhdID0gdDEueTsKICAgICAgICAgICAgICArK3RleHR1cmVJbmRleDsKICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleF0gPSBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleCArIHRvcEVkZ2VUZXhjb29yZExlbmd0aF0gPSB0Mi54OwogICAgICAgICAgICAgICsrdGV4dHVyZUluZGV4OwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHQyLnk7CiAgICAgICAgICAgICAgKyt0ZXh0dXJlSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gZWRnZVBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgbGVuZ3RoIC8gMywKICAgICAgICAgIGxlbmd0aCAtIHBvc2l0aW9ucy5sZW5ndGggKiA2CiAgICAgICAgKTsKICAgICAgICBsZXQgZWRnZUluZGV4ID0gMDsKICAgICAgICBsZW5ndGggLz0gNjsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IFVMID0gaTsKICAgICAgICAgIGNvbnN0IFVSID0gVUwgKyAxOwogICAgICAgICAgY29uc3QgTEwgPSBVTCArIGxlbmd0aDsKICAgICAgICAgIGNvbnN0IExSID0gTEwgKyAxOwogICAgICAgICAgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGVkZ2VQb3NpdGlvbnMsIFVMICogMywgcDFTY3JhdGNoMik7CiAgICAgICAgICBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZWRnZVBvc2l0aW9ucywgVVIgKiAzLCBwMlNjcmF0Y2gyKTsKICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgICAgcDEsCiAgICAgICAgICAgIHAyLAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwLAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgICApKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVUjsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExSOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeU9wdGlvbnMgPSB7CiAgICAgICAgICBhdHRyaWJ1dGVzOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogZWRnZVBvc2l0aW9ucwogICAgICAgICAgICB9KQogICAgICAgICAgfSksCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgICAgIH07CiAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgZ2VvbWV0cnlPcHRpb25zLmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IGVkZ2VUZXhjb29yZHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KGdlb21ldHJ5T3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjcmVhdGVHZW9tZXRyeUZyb21Qb2x5Z29uKHBvbHlnb24yLCB2ZXJ0ZXhGb3JtYXQsIGJvdW5kaW5nUmVjdGFuZ2xlLCBzdFJvdGF0aW9uLCBoYXJkY29kZWRUZXh0dXJlQ29vcmRpbmF0ZXMsIHByb2plY3RQb2ludFRvMkQsIG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCkgewogICAgY29uc3QgcG9zaXRpb25zID0gcG9seWdvbjIucG9zaXRpb25zOwogICAgbGV0IGluZGljZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC50cmlhbmd1bGF0ZShwb2x5Z29uMi5wb3NpdGlvbnMyRCwgcG9seWdvbjIuaG9sZXMpOwogICAgaWYgKGluZGljZXMubGVuZ3RoIDwgMykgewogICAgICBpbmRpY2VzID0gWzAsIDEsIDJdOwogICAgfQogICAgY29uc3QgbmV3SW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBwb3NpdGlvbnMubGVuZ3RoLAogICAgICBpbmRpY2VzLmxlbmd0aAogICAgKTsKICAgIG5ld0luZGljZXMuc2V0KGluZGljZXMpOwogICAgbGV0IHRleHR1cmVNYXRyaXggPSB0ZXh0dXJlTWF0cml4U2NyYXRjaDI7CiAgICBpZiAoc3RSb3RhdGlvbiAhPT0gMCkgewogICAgICBsZXQgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICBub3JtYWwyLAogICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgcXVhdGVybmlvblNjcmF0Y2gyCiAgICAgICk7CiAgICAgIHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocm90YXRpb24sIHRleHR1cmVNYXRyaXgpOwogICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgIHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgLXN0Um90YXRpb24sCiAgICAgICAgICBxdWF0ZXJuaW9uU2NyYXRjaDIKICAgICAgICApOwogICAgICAgIGNvbnN0IHRhbmdlbnRSb3RhdGlvbiA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgdGFuZ2VudFJvdGF0aW9uU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0YW5nZW50Um90YXRpb24sIHRhbmdlbnQsIHRhbmdlbnQpLAogICAgICAgICAgdGFuZ2VudAogICAgICAgICk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmNsb25lKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdGV4dHVyZU1hdHJpeCk7CiAgICB9CiAgICBjb25zdCBzdE9yaWdpbiA9IHRleHR1cmVDb29yZGluYXRlc09yaWdpbjsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgc3RPcmlnaW4ueCA9IGJvdW5kaW5nUmVjdGFuZ2xlLng7CiAgICAgIHN0T3JpZ2luLnkgPSBib3VuZGluZ1JlY3RhbmdsZS55OwogICAgfQogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IHNpemUgPSBsZW5ndGggKiAzOwogICAgY29uc3QgZmxhdFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSk7CiAgICBjb25zdCBub3JtYWxzID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoICogMikgOiB2b2lkIDA7CiAgICBsZXQgcG9zaXRpb25JbmRleCA9IDA7CiAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgbGV0IGJpdGFuZ2VudEluZGV4ID0gMDsKICAgIGxldCB0YW5nZW50SW5kZXggPSAwOwogICAgbGV0IHN0SW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsKICAgICAgZmxhdFBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgZmxhdFBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgZmxhdFBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGFyZGNvZGVkVGV4dHVyZUNvb3JkaW5hdGVzKSAmJiBoYXJkY29kZWRUZXh0dXJlQ29vcmRpbmF0ZXMucG9zaXRpb25zLmxlbmd0aCA9PT0gbGVuZ3RoKSB7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IGhhcmRjb2RlZFRleHR1cmVDb29yZGluYXRlcy5wb3NpdGlvbnNbaV0ueDsKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gaGFyZGNvZGVkVGV4dHVyZUNvb3JkaW5hdGVzLnBvc2l0aW9uc1tpXS55OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBwID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICAgIHRleHR1cmVNYXRyaXgsCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBzY3JhdGNoUG9zaXRpb24KICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzdCA9IHByb2plY3RQb2ludFRvMkQocCwgc3RTY3JhdGNoKTsKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdChzdCwgc3RPcmlnaW4sIHN0KTsKICAgICAgICAgIGNvbnN0IHN0eCA9IE1hdGhfZGVmYXVsdC5jbGFtcChzdC54IC8gYm91bmRpbmdSZWN0YW5nbGUud2lkdGgsIDAsIDEpOwogICAgICAgICAgY29uc3Qgc3R5ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHN0LnkgLyBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQsIDAsIDEpOwogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdHg7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHN0eTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi54OwogICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLnk7CiAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIuejsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lng7CiAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC55OwogICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueDsKICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lnk7CiAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC56OwogICAgICB9CiAgICB9CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBmbGF0UG9zaXRpb25zCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiB0ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiBuZXdJbmRpY2VzLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5OwogICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gb3B0aW9ucy50ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSIsIHBvbHlnb25IaWVyYXJjaHkpOwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0KTsKICAgIHRoaXMuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgdGhpcy5fc3RSb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3RSb3RhdGlvbiwgMCk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpCiAgICApOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeSI7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoKAogICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICkgKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAoZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcykgPyBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCgKICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQKICAgICkgOiAxKSArIDI7CiAgfQogIHZhciBzY3JhdGNoUG9zaXRpb24sIHNjcmF0Y2hCUiwgc3RTY3JhdGNoLCB0ZXh0dXJlQ29vcmRpbmF0ZXNPcmlnaW4sIHNjcmF0Y2hOb3JtYWw0LCBzY3JhdGNoVGFuZ2VudDIsIHNjcmF0Y2hCaXRhbmdlbnQyLCBjZW50ZXJTY3JhdGNoLCBheGlzMVNjcmF0Y2gsIGF4aXMyU2NyYXRjaCwgcXVhdGVybmlvblNjcmF0Y2gyLCB0ZXh0dXJlTWF0cml4U2NyYXRjaDIsIHRhbmdlbnRSb3RhdGlvblNjcmF0Y2gsIHN1cmZhY2VOb3JtYWxTY3JhdGNoLCBzY3JhdGNoRWxsaXBzb2lkMywgc2NyYXRjaFZlcnRleEZvcm1hdDMsIHNjcmF0Y2hPcHRpb25zNywgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3BsYW5hclBvbHlnb25HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUG9seWdvbkdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIHNjcmF0Y2hQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJSID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNPcmlnaW4gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWw0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVGFuZ2VudDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCaXRhbmdlbnQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjZW50ZXJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBheGlzMVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGF4aXMyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcXVhdGVybmlvblNjcmF0Y2gyID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICB0ZXh0dXJlTWF0cml4U2NyYXRjaDIgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHRhbmdlbnRSb3RhdGlvblNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHN1cmZhY2VOb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeS5mcm9tUG9zaXRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBvcHRpb25zLnBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IHsKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHsKICAgICAgICAgICAgcG9zaXRpb25zOiBvcHRpb25zLnBvc2l0aW9ucwogICAgICAgICAgfSwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBzdFJvdGF0aW9uOiBvcHRpb25zLnN0Um90YXRpb24sCiAgICAgICAgICBlbGxpcHNvaWQ6IG9wdGlvbnMuZWxsaXBzb2lkLAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzOiBvcHRpb25zLnRleHR1cmVDb29yZGluYXRlcwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBDb3BsYW5hclBvbHlnb25HZW9tZXRyeShuZXdPcHRpb25zKTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIHZhbHVlLl9wb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0Um90YXRpb247CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh2YWx1ZS5fdGV4dHVyZUNvb3JkaW5hdGVzKSkgewogICAgICAgICAgc3RhcnRpbmdJbmRleCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgICAgdmFsdWUuX3RleHR1cmVDb29yZGluYXRlcywKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IC0xOwogICAgICAgIH0KICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUucGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDMgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQzID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zNyA9IHsKICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7fQogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGRlbGV0ZSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMyk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDMKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdID09PSAtMSA/IHZvaWQgMCA6IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggPSB0ZXh0dXJlQ29vcmRpbmF0ZXMuc3RhcnRpbmdJbmRleDsKICAgICAgICAgIGRlbGV0ZSB0ZXh0dXJlQ29vcmRpbmF0ZXMuc3RhcnRpbmdJbmRleDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhcnRpbmdJbmRleCsrOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYWNrZWRMZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDb3BsYW5hclBvbHlnb25HZW9tZXRyeShzY3JhdGNoT3B0aW9uczcpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX3N0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fdGV4dHVyZUNvb3JkaW5hdGVzID0gdGV4dHVyZUNvb3JkaW5hdGVzOwogICAgICAgIHJlc3VsdC5wYWNrZWRMZW5ndGggPSBwYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwb2x5Z29uR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBwb2x5Z29uR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkdlb21ldHJ5Ll9wb2x5Z29uSGllcmFyY2h5OwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBwb2x5Z29uR2VvbWV0cnkuX3N0Um90YXRpb247CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gcG9seWdvbkdlb21ldHJ5Ll90ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICAgICAgY29uc3QgaGFzVGV4dHVyZUNvb3JkaW5hdGVzID0gZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcyk7CiAgICAgICAgbGV0IG91dGVyUG9zaXRpb25zID0gcG9seWdvbkhpZXJhcmNoeS5wb3NpdGlvbnM7CiAgICAgICAgb3V0ZXJQb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24sCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgICBpZiAob3V0ZXJQb3NpdGlvbnMubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBsZXQgbm9ybWFsMiA9IHNjcmF0Y2hOb3JtYWw0OwogICAgICAgIGxldCB0YW5nZW50ID0gc2NyYXRjaFRhbmdlbnQyOwogICAgICAgIGxldCBiaXRhbmdlbnQgPSBzY3JhdGNoQml0YW5nZW50MjsKICAgICAgICBsZXQgYXhpczEgPSBheGlzMVNjcmF0Y2g7CiAgICAgICAgY29uc3QgYXhpczIgPSBheGlzMlNjcmF0Y2g7CiAgICAgICAgY29uc3QgdmFsaWRHZW9tZXRyeSA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQcm9qZWN0VG8yREFyZ3VtZW50cygKICAgICAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICAgICAgY2VudGVyU2NyYXRjaCwKICAgICAgICAgIGF4aXMxLAogICAgICAgICAgYXhpczIKICAgICAgICApOwogICAgICAgIGlmICghdmFsaWRHZW9tZXRyeSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhheGlzMSwgYXhpczIsIG5vcm1hbDIpOwogICAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIGlmICghQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBjZW50ZXJTY3JhdGNoLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjYKICAgICAgICApKSB7CiAgICAgICAgICBjb25zdCBzdXJmYWNlTm9ybWFsID0gcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgICAgICBjZW50ZXJTY3JhdGNoLAogICAgICAgICAgICBzdXJmYWNlTm9ybWFsU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIHN1cmZhY2VOb3JtYWwpIDwgMCkgewogICAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICAgICAgYXhpczEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGF4aXMxLCBheGlzMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHByb2plY3RQb2ludHMgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jcmVhdGVQcm9qZWN0UG9pbnRzVG8yREZ1bmN0aW9uKAogICAgICAgICAgY2VudGVyU2NyYXRjaCwKICAgICAgICAgIGF4aXMxLAogICAgICAgICAgYXhpczIKICAgICAgICApOwogICAgICAgIGNvbnN0IHByb2plY3RQb2ludCA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNyZWF0ZVByb2plY3RQb2ludFRvMkRGdW5jdGlvbigKICAgICAgICAgIGNlbnRlclNjcmF0Y2gsCiAgICAgICAgICBheGlzMSwKICAgICAgICAgIGF4aXMyCiAgICAgICAgKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYXhpczEsIHRhbmdlbnQpOwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGF4aXMyLCBiaXRhbmdlbnQpOwogICAgICAgIH0KICAgICAgICBjb25zdCByZXN1bHRzID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBvbHlnb25zRnJvbUhpZXJhcmNoeSgKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgICBwcm9qZWN0UG9pbnRzLAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGNvbnN0IGhpZXJhcmNoeSA9IHJlc3VsdHMuaGllcmFyY2h5OwogICAgICAgIGNvbnN0IHBvbHlnb25zID0gcmVzdWx0cy5wb2x5Z29uczsKICAgICAgICBjb25zdCBkdW1teUZ1bmN0aW9uID0gZnVuY3Rpb24oaWRlbnRpdHkpIHsKICAgICAgICAgIHJldHVybiBpZGVudGl0eTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnMgPSBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPyBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucG9seWdvbnNGcm9tSGllcmFyY2h5KAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgdHJ1ZSwKICAgICAgICAgIGR1bW15RnVuY3Rpb24sCiAgICAgICAgICBmYWxzZQogICAgICAgICkucG9seWdvbnMgOiB2b2lkIDA7CiAgICAgICAgaWYgKGhpZXJhcmNoeS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgb3V0ZXJQb3NpdGlvbnMgPSBoaWVyYXJjaHlbMF0ub3V0ZXJSaW5nOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKG91dGVyUG9zaXRpb25zKTsKICAgICAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlQm91bmRpbmdSZWN0YW5nbGUoCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcHJvamVjdFBvaW50LAogICAgICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgc2NyYXRjaEJSCiAgICAgICAgKTsKICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgZ2VvbWV0cnlJbnN0YW5jZSA9IG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgICAgICBnZW9tZXRyeTogY3JlYXRlR2VvbWV0cnlGcm9tUG9seWdvbigKICAgICAgICAgICAgICBwb2x5Z29uc1tpXSwKICAgICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICAgICAgc3RSb3RhdGlvbiwKICAgICAgICAgICAgICBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPyB0ZXh0dXJlQ29vcmRpbmF0ZVBvbHlnb25zW2ldIDogdm9pZCAwLAogICAgICAgICAgICAgIHByb2plY3RQb2ludCwKICAgICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICAgIHRhbmdlbnQsCiAgICAgICAgICAgICAgYml0YW5nZW50CiAgICAgICAgICAgICkKICAgICAgICAgIH0pOwogICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKGdlb21ldHJ5SW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeSA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21iaW5lSW5zdGFuY2VzKGdlb21ldHJpZXMpWzBdOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gbmV3IEZsb2F0NjRBcnJheSgKICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzCiAgICAgICAgKTsKICAgICAgICBnZW9tZXRyeS5pbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzLAogICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcwogICAgICAgICk7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIGRlbGV0ZSBhdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdCA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeShwb2x5Z29uR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBvbHlnb25HZW9tZXRyeSA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHBvbHlnb25HZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9ucyhwb3NpdGlvbnMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBmbGF0UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiAzKTsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShsZW5ndGgsIGxlbmd0aCAqIDIpOwogICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07CiAgICAgIGZsYXRQb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgIGZsYXRQb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgIGZsYXRQb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aDsKICAgIH0KICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZmxhdFBvc2l0aW9ucwogICAgICB9KQogICAgfSk7CiAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMKICAgIH0pOwogIH0KICBmdW5jdGlvbiBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5OwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLnBvbHlnb25IaWVyYXJjaHkiLCBwb2x5Z29uSGllcmFyY2h5KTsKICAgIHRoaXMuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkiOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCgKICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICApICsgMTsKICB9CiAgdmFyIHNjcmF0Y2hPcHRpb25zOCwgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X1BvbHlnb25HZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5mcm9tUG9zaXRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBvcHRpb25zLnBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IHsKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHsKICAgICAgICAgICAgcG9zaXRpb25zOiBvcHRpb25zLnBvc2l0aW9ucwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkobmV3T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgdmFsdWUuX3BvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUucGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaE9wdGlvbnM4ID0gewogICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHt9CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGRlbGV0ZSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgY29uc3QgcGFja2VkTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgICAgIHJlc3VsdC5wYWNrZWRMZW5ndGggPSBwYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocG9seWdvbkdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25HZW9tZXRyeS5fcG9seWdvbkhpZXJhcmNoeTsKICAgICAgICBsZXQgb3V0ZXJQb3NpdGlvbnMgPSBwb2x5Z29uSGllcmFyY2h5LnBvc2l0aW9uczsKICAgICAgICBvdXRlclBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGlmIChvdXRlclBvc2l0aW9ucy5sZW5ndGggPCAzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlzVmFsaWQgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC52YWxpZE91dGxpbmUob3V0ZXJQb3NpdGlvbnMpOwogICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucG9seWdvbk91dGxpbmVzRnJvbUhpZXJhcmNoeSgKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBmYWxzZQogICAgICAgICk7CiAgICAgICAgaWYgKHBvbHlnb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cmllcyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9seWdvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGdlb21ldHJ5SW5zdGFuY2UgPSBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICAgICAgZ2VvbWV0cnk6IGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9ucyhwb2x5Z29uc1tpXSkKICAgICAgICAgIH0pOwogICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKGdlb21ldHJ5SW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeSA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21iaW5lSW5zdGFuY2VzKGdlb21ldHJpZXMpWzBdOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zKTsKICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlczogZ2VvbWV0cnkuYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5Z29uR2VvbWV0cnkgPSBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgcG9seWdvbkdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Db3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ybmVyVHlwZS5qcwogIHZhciBDb3JuZXJUeXBlLCBDb3JuZXJUeXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29ybmVyVHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ybmVyVHlwZS5qcyIoKSB7CiAgICAgIENvcm5lclR5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogPGltZyBzcmM9IkltYWdlcy9Db3JuZXJUeXBlUm91bmRlZC5wbmciIHN0eWxlPSJ2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOyIgd2lkdGg9IjE4NiIgaGVpZ2h0PSIxODkiIC8+CiAgICAgICAgICoKICAgICAgICAgKiBDb3JuZXIgaGFzIGEgc21vb3RoIGVkZ2UuCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBST1VOREVEOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIDxpbWcgc3JjPSJJbWFnZXMvQ29ybmVyVHlwZU1pdGVyZWQucG5nIiBzdHlsZT0idmVydGljYWwtYWxpZ246IG1pZGRsZTsiIHdpZHRoPSIxODYiIGhlaWdodD0iMTg5IiAvPgogICAgICAgICAqCiAgICAgICAgICogQ29ybmVyIHBvaW50IGlzIHRoZSBpbnRlcnNlY3Rpb24gb2YgYWRqYWNlbnQgZWRnZXMuCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNSVRFUkVEOiAxLAogICAgICAgIC8qKgogICAgICAgICAqIDxpbWcgc3JjPSJJbWFnZXMvQ29ybmVyVHlwZUJldmVsZWQucG5nIiBzdHlsZT0idmVydGljYWwtYWxpZ246IG1pZGRsZTsiIHdpZHRoPSIxODYiIGhlaWdodD0iMTg5IiAvPgogICAgICAgICAqCiAgICAgICAgICogQ29ybmVyIGlzIGNsaXBwZWQuCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBCRVZFTEVEOiAyCiAgICAgIH07CiAgICAgIENvcm5lclR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoQ29ybmVyVHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRHZW9kZXNpYy5qcwogIGZ1bmN0aW9uIHNldENvbnN0YW50cyhlbGxpcHNvaWRHZW9kZXNpYzIpIHsKICAgIGNvbnN0IHVTcXVhcmVkID0gZWxsaXBzb2lkR2VvZGVzaWMyLl91U3F1YXJlZDsKICAgIGNvbnN0IGEzID0gZWxsaXBzb2lkR2VvZGVzaWMyLl9lbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgIGNvbnN0IGIgPSBlbGxpcHNvaWRHZW9kZXNpYzIuX2VsbGlwc29pZC5taW5pbXVtUmFkaXVzOwogICAgY29uc3QgZiA9IChhMyAtIGIpIC8gYTM7CiAgICBjb25zdCBjb3NpbmVIZWFkaW5nID0gTWF0aC5jb3MoZWxsaXBzb2lkR2VvZGVzaWMyLl9zdGFydEhlYWRpbmcpOwogICAgY29uc3Qgc2luZUhlYWRpbmcgPSBNYXRoLnNpbihlbGxpcHNvaWRHZW9kZXNpYzIuX3N0YXJ0SGVhZGluZyk7CiAgICBjb25zdCB0YW5VID0gKDEgLSBmKSAqIE1hdGgudGFuKGVsbGlwc29pZEdlb2Rlc2ljMi5fc3RhcnQubGF0aXR1ZGUpOwogICAgY29uc3QgY29zaW5lVSA9IDEgLyBNYXRoLnNxcnQoMSArIHRhblUgKiB0YW5VKTsKICAgIGNvbnN0IHNpbmVVID0gY29zaW5lVSAqIHRhblU7CiAgICBjb25zdCBzaWdtYSA9IE1hdGguYXRhbjIodGFuVSwgY29zaW5lSGVhZGluZyk7CiAgICBjb25zdCBzaW5lQWxwaGEgPSBjb3NpbmVVICogc2luZUhlYWRpbmc7CiAgICBjb25zdCBzaW5lU3F1YXJlZEFscGhhID0gc2luZUFscGhhICogc2luZUFscGhhOwogICAgY29uc3QgY29zaW5lU3F1YXJlZEFscGhhID0gMSAtIHNpbmVTcXVhcmVkQWxwaGE7CiAgICBjb25zdCBjb3NpbmVBbHBoYSA9IE1hdGguc3FydChjb3NpbmVTcXVhcmVkQWxwaGEpOwogICAgY29uc3QgdTJPdmVyNCA9IHVTcXVhcmVkIC8gNDsKICAgIGNvbnN0IHU0T3ZlcjE2ID0gdTJPdmVyNCAqIHUyT3ZlcjQ7CiAgICBjb25zdCB1Nk92ZXI2NCA9IHU0T3ZlcjE2ICogdTJPdmVyNDsKICAgIGNvbnN0IHU4T3ZlcjI1NiA9IHU0T3ZlcjE2ICogdTRPdmVyMTY7CiAgICBjb25zdCBhMCA9IDEgKyB1Mk92ZXI0IC0gMyAqIHU0T3ZlcjE2IC8gNCArIDUgKiB1Nk92ZXI2NCAvIDQgLSAxNzUgKiB1OE92ZXIyNTYgLyA2NDsKICAgIGNvbnN0IGExID0gMSAtIHUyT3ZlcjQgKyAxNSAqIHU0T3ZlcjE2IC8gOCAtIDM1ICogdTZPdmVyNjQgLyA4OwogICAgY29uc3QgYTIyID0gMSAtIDMgKiB1Mk92ZXI0ICsgMzUgKiB1NE92ZXIxNiAvIDQ7CiAgICBjb25zdCBhMzIgPSAxIC0gNSAqIHUyT3ZlcjQ7CiAgICBjb25zdCBkaXN0YW5jZVJhdGlvID0gYTAgKiBzaWdtYSAtIGExICogTWF0aC5zaW4oMiAqIHNpZ21hKSAqIHUyT3ZlcjQgLyAyIC0gYTIyICogTWF0aC5zaW4oNCAqIHNpZ21hKSAqIHU0T3ZlcjE2IC8gMTYgLSBhMzIgKiBNYXRoLnNpbig2ICogc2lnbWEpICogdTZPdmVyNjQgLyA0OCAtIE1hdGguc2luKDggKiBzaWdtYSkgKiA1ICogdThPdmVyMjU2IC8gNTEyOwogICAgY29uc3QgY29uc3RhbnRzID0gZWxsaXBzb2lkR2VvZGVzaWMyLl9jb25zdGFudHM7CiAgICBjb25zdGFudHMuYSA9IGEzOwogICAgY29uc3RhbnRzLmIgPSBiOwogICAgY29uc3RhbnRzLmYgPSBmOwogICAgY29uc3RhbnRzLmNvc2luZUhlYWRpbmcgPSBjb3NpbmVIZWFkaW5nOwogICAgY29uc3RhbnRzLnNpbmVIZWFkaW5nID0gc2luZUhlYWRpbmc7CiAgICBjb25zdGFudHMudGFuVSA9IHRhblU7CiAgICBjb25zdGFudHMuY29zaW5lVSA9IGNvc2luZVU7CiAgICBjb25zdGFudHMuc2luZVUgPSBzaW5lVTsKICAgIGNvbnN0YW50cy5zaWdtYSA9IHNpZ21hOwogICAgY29uc3RhbnRzLnNpbmVBbHBoYSA9IHNpbmVBbHBoYTsKICAgIGNvbnN0YW50cy5zaW5lU3F1YXJlZEFscGhhID0gc2luZVNxdWFyZWRBbHBoYTsKICAgIGNvbnN0YW50cy5jb3NpbmVTcXVhcmVkQWxwaGEgPSBjb3NpbmVTcXVhcmVkQWxwaGE7CiAgICBjb25zdGFudHMuY29zaW5lQWxwaGEgPSBjb3NpbmVBbHBoYTsKICAgIGNvbnN0YW50cy51Mk92ZXI0ID0gdTJPdmVyNDsKICAgIGNvbnN0YW50cy51NE92ZXIxNiA9IHU0T3ZlcjE2OwogICAgY29uc3RhbnRzLnU2T3ZlcjY0ID0gdTZPdmVyNjQ7CiAgICBjb25zdGFudHMudThPdmVyMjU2ID0gdThPdmVyMjU2OwogICAgY29uc3RhbnRzLmEwID0gYTA7CiAgICBjb25zdGFudHMuYTEgPSBhMTsKICAgIGNvbnN0YW50cy5hMiA9IGEyMjsKICAgIGNvbnN0YW50cy5hMyA9IGEzMjsKICAgIGNvbnN0YW50cy5kaXN0YW5jZVJhdGlvID0gZGlzdGFuY2VSYXRpbzsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUMoZiwgY29zaW5lU3F1YXJlZEFscGhhKSB7CiAgICByZXR1cm4gZiAqIGNvc2luZVNxdWFyZWRBbHBoYSAqICg0ICsgZiAqICg0IC0gMyAqIGNvc2luZVNxdWFyZWRBbHBoYSkpIC8gMTY7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVEZWx0YUxhbWJkYShmLCBzaW5lQWxwaGEsIGNvc2luZVNxdWFyZWRBbHBoYSwgc2lnbWEsIHNpbmVTaWdtYSwgY29zaW5lU2lnbWEsIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCkgewogICAgY29uc3QgQyA9IGNvbXB1dGVDKGYsIGNvc2luZVNxdWFyZWRBbHBoYSk7CiAgICByZXR1cm4gKDEgLSBDKSAqIGYgKiBzaW5lQWxwaGEgKiAoc2lnbWEgKyBDICogc2luZVNpZ21hICogKGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCArIEMgKiBjb3NpbmVTaWdtYSAqICgyICogY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50ICogY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50IC0gMSkpKTsKICB9CiAgZnVuY3Rpb24gdmluY2VudHlJbnZlcnNlRm9ybXVsYShlbGxpcHNvaWRHZW9kZXNpYzIsIG1ham9yLCBtaW5vciwgZmlyc3RMb25naXR1ZGUsIGZpcnN0TGF0aXR1ZGUsIHNlY29uZExvbmdpdHVkZSwgc2Vjb25kTGF0aXR1ZGUpIHsKICAgIGNvbnN0IGVmZiA9IChtYWpvciAtIG1pbm9yKSAvIG1ham9yOwogICAgY29uc3QgbCA9IHNlY29uZExvbmdpdHVkZSAtIGZpcnN0TG9uZ2l0dWRlOwogICAgY29uc3QgdTEyID0gTWF0aC5hdGFuKCgxIC0gZWZmKSAqIE1hdGgudGFuKGZpcnN0TGF0aXR1ZGUpKTsKICAgIGNvbnN0IHUyMiA9IE1hdGguYXRhbigoMSAtIGVmZikgKiBNYXRoLnRhbihzZWNvbmRMYXRpdHVkZSkpOwogICAgY29uc3QgY29zaW5lVTEgPSBNYXRoLmNvcyh1MTIpOwogICAgY29uc3Qgc2luZVUxID0gTWF0aC5zaW4odTEyKTsKICAgIGNvbnN0IGNvc2luZVUyID0gTWF0aC5jb3ModTIyKTsKICAgIGNvbnN0IHNpbmVVMiA9IE1hdGguc2luKHUyMik7CiAgICBjb25zdCBjYyA9IGNvc2luZVUxICogY29zaW5lVTI7CiAgICBjb25zdCBjcyA9IGNvc2luZVUxICogc2luZVUyOwogICAgY29uc3Qgc3MgPSBzaW5lVTEgKiBzaW5lVTI7CiAgICBjb25zdCBzYyA9IHNpbmVVMSAqIGNvc2luZVUyOwogICAgbGV0IGxhbWJkYSA9IGw7CiAgICBsZXQgbGFtYmRhRG90ID0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgIGxldCBjb3NpbmVMYW1iZGEgPSBNYXRoLmNvcyhsYW1iZGEpOwogICAgbGV0IHNpbmVMYW1iZGEgPSBNYXRoLnNpbihsYW1iZGEpOwogICAgbGV0IHNpZ21hOwogICAgbGV0IGNvc2luZVNpZ21hOwogICAgbGV0IHNpbmVTaWdtYTsKICAgIGxldCBjb3NpbmVTcXVhcmVkQWxwaGE7CiAgICBsZXQgY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50OwogICAgZG8gewogICAgICBjb3NpbmVMYW1iZGEgPSBNYXRoLmNvcyhsYW1iZGEpOwogICAgICBzaW5lTGFtYmRhID0gTWF0aC5zaW4obGFtYmRhKTsKICAgICAgY29uc3QgdGVtcCA9IGNzIC0gc2MgKiBjb3NpbmVMYW1iZGE7CiAgICAgIHNpbmVTaWdtYSA9IE1hdGguc3FydCgKICAgICAgICBjb3NpbmVVMiAqIGNvc2luZVUyICogc2luZUxhbWJkYSAqIHNpbmVMYW1iZGEgKyB0ZW1wICogdGVtcAogICAgICApOwogICAgICBjb3NpbmVTaWdtYSA9IHNzICsgY2MgKiBjb3NpbmVMYW1iZGE7CiAgICAgIHNpZ21hID0gTWF0aC5hdGFuMihzaW5lU2lnbWEsIGNvc2luZVNpZ21hKTsKICAgICAgbGV0IHNpbmVBbHBoYTsKICAgICAgaWYgKHNpbmVTaWdtYSA9PT0gMCkgewogICAgICAgIHNpbmVBbHBoYSA9IDA7CiAgICAgICAgY29zaW5lU3F1YXJlZEFscGhhID0gMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzaW5lQWxwaGEgPSBjYyAqIHNpbmVMYW1iZGEgLyBzaW5lU2lnbWE7CiAgICAgICAgY29zaW5lU3F1YXJlZEFscGhhID0gMSAtIHNpbmVBbHBoYSAqIHNpbmVBbHBoYTsKICAgICAgfQogICAgICBsYW1iZGFEb3QgPSBsYW1iZGE7CiAgICAgIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCA9IGNvc2luZVNpZ21hIC0gMiAqIHNzIC8gY29zaW5lU3F1YXJlZEFscGhhOwogICAgICBpZiAoIWlzRmluaXRlKGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCkpIHsKICAgICAgICBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgPSAwOwogICAgICB9CiAgICAgIGxhbWJkYSA9IGwgKyBjb21wdXRlRGVsdGFMYW1iZGEoCiAgICAgICAgZWZmLAogICAgICAgIHNpbmVBbHBoYSwKICAgICAgICBjb3NpbmVTcXVhcmVkQWxwaGEsCiAgICAgICAgc2lnbWEsCiAgICAgICAgc2luZVNpZ21hLAogICAgICAgIGNvc2luZVNpZ21hLAogICAgICAgIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludAogICAgICApOwogICAgfSB3aGlsZSAoTWF0aC5hYnMobGFtYmRhIC0gbGFtYmRhRG90KSA+IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIpOwogICAgY29uc3QgdVNxdWFyZWQgPSBjb3NpbmVTcXVhcmVkQWxwaGEgKiAobWFqb3IgKiBtYWpvciAtIG1pbm9yICogbWlub3IpIC8gKG1pbm9yICogbWlub3IpOwogICAgY29uc3QgQSA9IDEgKyB1U3F1YXJlZCAqICg0MDk2ICsgdVNxdWFyZWQgKiAodVNxdWFyZWQgKiAoMzIwIC0gMTc1ICogdVNxdWFyZWQpIC0gNzY4KSkgLyAxNjM4NDsKICAgIGNvbnN0IEIgPSB1U3F1YXJlZCAqICgyNTYgKyB1U3F1YXJlZCAqICh1U3F1YXJlZCAqICg3NCAtIDQ3ICogdVNxdWFyZWQpIC0gMTI4KSkgLyAxMDI0OwogICAgY29uc3QgY29zaW5lU3F1YXJlZFR3aWNlU2lnbWFNaWRwb2ludCA9IGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCAqIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludDsKICAgIGNvbnN0IGRlbHRhU2lnbWEgPSBCICogc2luZVNpZ21hICogKGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCArIEIgKiAoY29zaW5lU2lnbWEgKiAoMiAqIGNvc2luZVNxdWFyZWRUd2ljZVNpZ21hTWlkcG9pbnQgLSAxKSAtIEIgKiBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgKiAoNCAqIHNpbmVTaWdtYSAqIHNpbmVTaWdtYSAtIDMpICogKDQgKiBjb3NpbmVTcXVhcmVkVHdpY2VTaWdtYU1pZHBvaW50IC0gMykgLyA2KSAvIDQpOwogICAgY29uc3QgZGlzdGFuY2UgPSBtaW5vciAqIEEgKiAoc2lnbWEgLSBkZWx0YVNpZ21hKTsKICAgIGNvbnN0IHN0YXJ0SGVhZGluZyA9IE1hdGguYXRhbjIoCiAgICAgIGNvc2luZVUyICogc2luZUxhbWJkYSwKICAgICAgY3MgLSBzYyAqIGNvc2luZUxhbWJkYQogICAgKTsKICAgIGNvbnN0IGVuZEhlYWRpbmcgPSBNYXRoLmF0YW4yKGNvc2luZVUxICogc2luZUxhbWJkYSwgY3MgKiBjb3NpbmVMYW1iZGEgLSBzYyk7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX2Rpc3RhbmNlID0gZGlzdGFuY2U7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX3N0YXJ0SGVhZGluZyA9IHN0YXJ0SGVhZGluZzsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fZW5kSGVhZGluZyA9IGVuZEhlYWRpbmc7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX3VTcXVhcmVkID0gdVNxdWFyZWQ7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVQcm9wZXJ0aWVzMihlbGxpcHNvaWRHZW9kZXNpYzIsIHN0YXJ0LCBlbmQsIGVsbGlwc29pZCkgewogICAgY29uc3QgZmlyc3RDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3RhcnQsIHNjcmF0Y2hDYXJ0MjIpLAogICAgICBzY3JhdGNoQ2FydDEyCiAgICApOwogICAgY29uc3QgbGFzdENhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihlbmQsIHNjcmF0Y2hDYXJ0MjIpLAogICAgICBzY3JhdGNoQ2FydDIyCiAgICApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICJ2YWx1ZSIsCiAgICAgIE1hdGguYWJzKAogICAgICAgIE1hdGguYWJzKENhcnRlc2lhbjNfZGVmYXVsdC5hbmdsZUJldHdlZW4oZmlyc3RDYXJ0ZXNpYW4sIGxhc3RDYXJ0ZXNpYW4pKSAtIE1hdGguUEkKICAgICAgKSwKICAgICAgMC4wMTI1CiAgICApOwogICAgdmluY2VudHlJbnZlcnNlRm9ybXVsYSgKICAgICAgZWxsaXBzb2lkR2VvZGVzaWMyLAogICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cywKICAgICAgZWxsaXBzb2lkLm1pbmltdW1SYWRpdXMsCiAgICAgIHN0YXJ0LmxvbmdpdHVkZSwKICAgICAgc3RhcnQubGF0aXR1ZGUsCiAgICAgIGVuZC5sb25naXR1ZGUsCiAgICAgIGVuZC5sYXRpdHVkZQogICAgKTsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fc3RhcnQgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZSgKICAgICAgc3RhcnQsCiAgICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fc3RhcnQKICAgICk7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX2VuZCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKGVuZCwgZWxsaXBzb2lkR2VvZGVzaWMyLl9lbmQpOwogICAgZWxsaXBzb2lkR2VvZGVzaWMyLl9zdGFydC5oZWlnaHQgPSAwOwogICAgZWxsaXBzb2lkR2VvZGVzaWMyLl9lbmQuaGVpZ2h0ID0gMDsKICAgIHNldENvbnN0YW50cyhlbGxpcHNvaWRHZW9kZXNpYzIpOwogIH0KICBmdW5jdGlvbiBFbGxpcHNvaWRHZW9kZXNpYyhzdGFydCwgZW5kLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gZTsKICAgIHRoaXMuX3N0YXJ0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICB0aGlzLl9lbmQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgIHRoaXMuX2NvbnN0YW50cyA9IHt9OwogICAgdGhpcy5fc3RhcnRIZWFkaW5nID0gdm9pZCAwOwogICAgdGhpcy5fZW5kSGVhZGluZyA9IHZvaWQgMDsKICAgIHRoaXMuX2Rpc3RhbmNlID0gdm9pZCAwOwogICAgdGhpcy5fdVNxdWFyZWQgPSB2b2lkIDA7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0YXJ0KSAmJiBkZWZpbmVkX2RlZmF1bHQoZW5kKSkgewogICAgICBjb21wdXRlUHJvcGVydGllczIodGhpcywgc3RhcnQsIGVuZCwgZSk7CiAgICB9CiAgfQogIHZhciBzY3JhdGNoQ2FydDEyLCBzY3JhdGNoQ2FydDIyLCBFbGxpcHNvaWRHZW9kZXNpY19kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZEdlb2Rlc2ljID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRHZW9kZXNpYy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgc2NyYXRjaENhcnQxMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnQyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHN1cmZhY2UgZGlzdGFuY2UgYmV0d2VlbiB0aGUgc3RhcnQgYW5kIGVuZCBwb2ludAogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHN1cmZhY2VEaXN0YW5jZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkaXN0YW5jZSIsIHRoaXMuX2Rpc3RhbmNlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2Rpc3RhbmNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaW5pdGlhbCBwbGFuZXRvZGV0aWMgcG9pbnQgb24gdGhlIHBhdGguCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0b2dyYXBoaWN9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGFydDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGZpbmFsIHBsYW5ldG9kZXRpYyBwb2ludCBvbiB0aGUgcGF0aC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRvZ3JhcGhpY30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbmQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbmQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBoZWFkaW5nIGF0IHRoZSBpbml0aWFsIHBvaW50LgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHN0YXJ0SGVhZGluZzogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkaXN0YW5jZSIsIHRoaXMuX2Rpc3RhbmNlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXJ0SGVhZGluZzsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGhlYWRpbmcgYXQgdGhlIGZpbmFsIHBvaW50LgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVuZEhlYWRpbmc6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCB0aGlzLl9kaXN0YW5jZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbmRIZWFkaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZS5zZXRFbmRQb2ludHMgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImVuZCIsIGVuZCk7CiAgICAgICAgY29tcHV0ZVByb3BlcnRpZXMyKHRoaXMsIHN0YXJ0LCBlbmQsIHRoaXMuX2VsbGlwc29pZCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZS5pbnRlcnBvbGF0ZVVzaW5nRnJhY3Rpb24gPSBmdW5jdGlvbihmcmFjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICAgIHRoaXMuX2Rpc3RhbmNlICogZnJhY3Rpb24sCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSA9IGZ1bmN0aW9uKGRpc3RhbmNlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRpc3RhbmNlIiwgdGhpcy5fZGlzdGFuY2UpOwogICAgICAgIGNvbnN0IGNvbnN0YW50cyA9IHRoaXMuX2NvbnN0YW50czsKICAgICAgICBjb25zdCBzID0gY29uc3RhbnRzLmRpc3RhbmNlUmF0aW8gKyBkaXN0YW5jZSAvIGNvbnN0YW50cy5iOwogICAgICAgIGNvbnN0IGNvc2luZTJTID0gTWF0aC5jb3MoMiAqIHMpOwogICAgICAgIGNvbnN0IGNvc2luZTRTID0gTWF0aC5jb3MoNCAqIHMpOwogICAgICAgIGNvbnN0IGNvc2luZTZTID0gTWF0aC5jb3MoNiAqIHMpOwogICAgICAgIGNvbnN0IHNpbmUyUyA9IE1hdGguc2luKDIgKiBzKTsKICAgICAgICBjb25zdCBzaW5lNFMgPSBNYXRoLnNpbig0ICogcyk7CiAgICAgICAgY29uc3Qgc2luZTZTID0gTWF0aC5zaW4oNiAqIHMpOwogICAgICAgIGNvbnN0IHNpbmU4UyA9IE1hdGguc2luKDggKiBzKTsKICAgICAgICBjb25zdCBzMiA9IHMgKiBzOwogICAgICAgIGNvbnN0IHMzID0gcyAqIHMyOwogICAgICAgIGNvbnN0IHU4T3ZlcjI1NiA9IGNvbnN0YW50cy51OE92ZXIyNTY7CiAgICAgICAgY29uc3QgdTJPdmVyNCA9IGNvbnN0YW50cy51Mk92ZXI0OwogICAgICAgIGNvbnN0IHU2T3ZlcjY0ID0gY29uc3RhbnRzLnU2T3ZlcjY0OwogICAgICAgIGNvbnN0IHU0T3ZlcjE2ID0gY29uc3RhbnRzLnU0T3ZlcjE2OwogICAgICAgIGxldCBzaWdtYSA9IDIgKiBzMyAqIHU4T3ZlcjI1NiAqIGNvc2luZTJTIC8gMyArIHMgKiAoMSAtIHUyT3ZlcjQgKyA3ICogdTRPdmVyMTYgLyA0IC0gMTUgKiB1Nk92ZXI2NCAvIDQgKyA1NzkgKiB1OE92ZXIyNTYgLyA2NCAtICh1NE92ZXIxNiAtIDE1ICogdTZPdmVyNjQgLyA0ICsgMTg3ICogdThPdmVyMjU2IC8gMTYpICogY29zaW5lMlMgLSAoNSAqIHU2T3ZlcjY0IC8gNCAtIDExNSAqIHU4T3ZlcjI1NiAvIDE2KSAqIGNvc2luZTRTIC0gMjkgKiB1OE92ZXIyNTYgKiBjb3NpbmU2UyAvIDE2KSArICh1Mk92ZXI0IC8gMiAtIHU0T3ZlcjE2ICsgNzEgKiB1Nk92ZXI2NCAvIDMyIC0gODUgKiB1OE92ZXIyNTYgLyAxNikgKiBzaW5lMlMgKyAoNSAqIHU0T3ZlcjE2IC8gMTYgLSA1ICogdTZPdmVyNjQgLyA0ICsgMzgzICogdThPdmVyMjU2IC8gOTYpICogc2luZTRTIC0gczIgKiAoKHU2T3ZlcjY0IC0gMTEgKiB1OE92ZXIyNTYgLyAyKSAqIHNpbmUyUyArIDUgKiB1OE92ZXIyNTYgKiBzaW5lNFMgLyAyKSArICgyOSAqIHU2T3ZlcjY0IC8gOTYgLSAyOSAqIHU4T3ZlcjI1NiAvIDE2KSAqIHNpbmU2UyArIDUzOSAqIHU4T3ZlcjI1NiAqIHNpbmU4UyAvIDE1MzY7CiAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLmFzaW4oTWF0aC5zaW4oc2lnbWEpICogY29uc3RhbnRzLmNvc2luZUFscGhhKTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IE1hdGguYXRhbihjb25zdGFudHMuYSAvIGNvbnN0YW50cy5iICogTWF0aC50YW4odGhldGEpKTsKICAgICAgICBzaWdtYSA9IHNpZ21hIC0gY29uc3RhbnRzLnNpZ21hOwogICAgICAgIGNvbnN0IGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCA9IE1hdGguY29zKDIgKiBjb25zdGFudHMuc2lnbWEgKyBzaWdtYSk7CiAgICAgICAgY29uc3Qgc2luZVNpZ21hID0gTWF0aC5zaW4oc2lnbWEpOwogICAgICAgIGNvbnN0IGNvc2luZVNpZ21hID0gTWF0aC5jb3Moc2lnbWEpOwogICAgICAgIGNvbnN0IGNjID0gY29uc3RhbnRzLmNvc2luZVUgKiBjb3NpbmVTaWdtYTsKICAgICAgICBjb25zdCBzcyA9IGNvbnN0YW50cy5zaW5lVSAqIHNpbmVTaWdtYTsKICAgICAgICBjb25zdCBsYW1iZGEgPSBNYXRoLmF0YW4yKAogICAgICAgICAgc2luZVNpZ21hICogY29uc3RhbnRzLnNpbmVIZWFkaW5nLAogICAgICAgICAgY2MgLSBzcyAqIGNvbnN0YW50cy5jb3NpbmVIZWFkaW5nCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsID0gbGFtYmRhIC0gY29tcHV0ZURlbHRhTGFtYmRhKAogICAgICAgICAgY29uc3RhbnRzLmYsCiAgICAgICAgICBjb25zdGFudHMuc2luZUFscGhhLAogICAgICAgICAgY29uc3RhbnRzLmNvc2luZVNxdWFyZWRBbHBoYSwKICAgICAgICAgIHNpZ21hLAogICAgICAgICAgc2luZVNpZ21hLAogICAgICAgICAgY29zaW5lU2lnbWEsCiAgICAgICAgICBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQKICAgICAgICApOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHRoaXMuX3N0YXJ0LmxvbmdpdHVkZSArIGw7CiAgICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCh0aGlzLl9zdGFydC5sb25naXR1ZGUgKyBsLCBsYXRpdHVkZSwgMCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZEdlb2Rlc2ljX2RlZmF1bHQgPSBFbGxpcHNvaWRHZW9kZXNpYzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lUGlwZWxpbmUuanMKICBmdW5jdGlvbiBzdWJkaXZpZGVIZWlnaHRzKG51bVBvaW50cywgaDAsIGgxKSB7CiAgICBjb25zdCBoZWlnaHRzID0gc3ViZGl2aWRlSGVpZ2h0c1NjcmF0Y2hBcnJheTsKICAgIGhlaWdodHMubGVuZ3RoID0gbnVtUG9pbnRzOwogICAgbGV0IGk7CiAgICBpZiAoaDAgPT09IGgxKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICAgIGhlaWdodHNbaV0gPSBoMDsKICAgICAgfQogICAgICByZXR1cm4gaGVpZ2h0czsKICAgIH0KICAgIGNvbnN0IGRIZWlnaHQgPSBoMSAtIGgwOwogICAgY29uc3QgaGVpZ2h0UGVyVmVydGV4ID0gZEhlaWdodCAvIG51bVBvaW50czsKICAgIGZvciAoaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICBjb25zdCBoID0gaDAgKyBpICogaGVpZ2h0UGVyVmVydGV4OwogICAgICBoZWlnaHRzW2ldID0gaDsKICAgIH0KICAgIHJldHVybiBoZWlnaHRzOwogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZUNhcnRlc2lhbkFyYyhwMCwgcDEsIG1pbkRpc3RhbmNlLCBlbGxpcHNvaWQsIGgwLCBoMSwgYXJyYXksIG9mZnNldCkgewogICAgY29uc3QgZmlyc3QgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwMCwgc2NhbGVGaXJzdCk7CiAgICBjb25zdCBsYXN0ID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocDEsIHNjYWxlTGFzdCk7CiAgICBjb25zdCBudW1Qb2ludHMgPSBQb2x5bGluZVBpcGVsaW5lLm51bWJlck9mUG9pbnRzKHAwLCBwMSwgbWluRGlzdGFuY2UpOwogICAgY29uc3Qgc3RhcnQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoZmlyc3QsIGNhcnRvMSk7CiAgICBjb25zdCBlbmQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMobGFzdCwgY2FydG8yKTsKICAgIGNvbnN0IGhlaWdodHMgPSBzdWJkaXZpZGVIZWlnaHRzKG51bVBvaW50cywgaDAsIGgxKTsKICAgIGVsbGlwc29pZEdlb2Rlc2ljLnNldEVuZFBvaW50cyhzdGFydCwgZW5kKTsKICAgIGNvbnN0IHN1cmZhY2VEaXN0YW5jZUJldHdlZW5Qb2ludHMgPSBlbGxpcHNvaWRHZW9kZXNpYy5zdXJmYWNlRGlzdGFuY2UgLyBudW1Qb2ludHM7CiAgICBsZXQgaW5kZXggPSBvZmZzZXQ7CiAgICBzdGFydC5oZWlnaHQgPSBoMDsKICAgIGxldCBjYXJ0ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHN0YXJ0LCBjYXJ0ZXNpYW4pOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FydCwgYXJyYXksIGluZGV4KTsKICAgIGluZGV4ICs9IDM7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGNvbnN0IGNhcnRvID0gZWxsaXBzb2lkR2VvZGVzaWMuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICBpICogc3VyZmFjZURpc3RhbmNlQmV0d2VlblBvaW50cywKICAgICAgICBjYXJ0bzIKICAgICAgKTsKICAgICAgY2FydG8uaGVpZ2h0ID0gaGVpZ2h0c1tpXTsKICAgICAgY2FydCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0bywgY2FydGVzaWFuKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FydCwgYXJyYXksIGluZGV4KTsKICAgICAgaW5kZXggKz0gMzsKICAgIH0KICAgIHJldHVybiBpbmRleDsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVDYXJ0ZXNpYW5SaHVtYkFyYyhwMCwgcDEsIGdyYW51bGFyaXR5LCBlbGxpcHNvaWQsIGgwLCBoMSwgYXJyYXksIG9mZnNldCkgewogICAgY29uc3Qgc3RhcnQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDAsIGNhcnRvMSk7CiAgICBjb25zdCBlbmQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDEsIGNhcnRvMik7CiAgICBjb25zdCBudW1Qb2ludHMgPSBQb2x5bGluZVBpcGVsaW5lLm51bWJlck9mUG9pbnRzUmh1bWJMaW5lKAogICAgICBzdGFydCwKICAgICAgZW5kLAogICAgICBncmFudWxhcml0eQogICAgKTsKICAgIHN0YXJ0LmhlaWdodCA9IDA7CiAgICBlbmQuaGVpZ2h0ID0gMDsKICAgIGNvbnN0IGhlaWdodHMgPSBzdWJkaXZpZGVIZWlnaHRzKG51bVBvaW50cywgaDAsIGgxKTsKICAgIGlmICghZWxsaXBzb2lkUmh1bWIuZWxsaXBzb2lkLmVxdWFscyhlbGxpcHNvaWQpKSB7CiAgICAgIGVsbGlwc29pZFJodW1iID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KHZvaWQgMCwgdm9pZCAwLCBlbGxpcHNvaWQpOwogICAgfQogICAgZWxsaXBzb2lkUmh1bWIuc2V0RW5kUG9pbnRzKHN0YXJ0LCBlbmQpOwogICAgY29uc3Qgc3VyZmFjZURpc3RhbmNlQmV0d2VlblBvaW50cyA9IGVsbGlwc29pZFJodW1iLnN1cmZhY2VEaXN0YW5jZSAvIG51bVBvaW50czsKICAgIGxldCBpbmRleCA9IG9mZnNldDsKICAgIHN0YXJ0LmhlaWdodCA9IGgwOwogICAgbGV0IGNhcnQgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3RhcnQsIGNhcnRlc2lhbik7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0LCBhcnJheSwgaW5kZXgpOwogICAgaW5kZXggKz0gMzsKICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgY29uc3QgY2FydG8gPSBlbGxpcHNvaWRSaHVtYi5pbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgIGkgKiBzdXJmYWNlRGlzdGFuY2VCZXR3ZWVuUG9pbnRzLAogICAgICAgIGNhcnRvMgogICAgICApOwogICAgICBjYXJ0by5oZWlnaHQgPSBoZWlnaHRzW2ldOwogICAgICBjYXJ0ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvLCBjYXJ0ZXNpYW4pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0LCBhcnJheSwgaW5kZXgpOwogICAgICBpbmRleCArPSAzOwogICAgfQogICAgcmV0dXJuIGluZGV4OwogIH0KICB2YXIgUG9seWxpbmVQaXBlbGluZSwgY2FydG9TY3JhdGNoLCB3cmFwTG9uZ2l0dWRlSW52ZXJzTWF0cml4LCB3cmFwTG9uZ2l0dWRlT3JpZ2luLCB3cmFwTG9uZ2l0dWRlWFpOb3JtYWwsIHdyYXBMb25naXR1ZGVYWlBsYW5lLCB3cmFwTG9uZ2l0dWRlWVpOb3JtYWwsIHdyYXBMb25naXR1ZGVZWlBsYW5lLCB3cmFwTG9uZ2l0dWRlSW50ZXJzZWN0aW9uLCB3cmFwTG9uZ2l0dWRlT2Zmc2V0LCBzdWJkaXZpZGVIZWlnaHRzU2NyYXRjaEFycmF5LCBjYXJ0bzEsIGNhcnRvMiwgY2FydGVzaWFuLCBzY2FsZUZpcnN0LCBzY2FsZUxhc3QsIGVsbGlwc29pZEdlb2Rlc2ljLCBlbGxpcHNvaWRSaHVtYiwgc2NyYXRjaENhcnRvZ3JhcGhpYzAyLCBzY3JhdGNoQ2FydG9ncmFwaGljMTIsIFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5bGluZVBpcGVsaW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVBpcGVsaW5lLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkR2VvZGVzaWMoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRSaHVtYkxpbmUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgUG9seWxpbmVQaXBlbGluZSA9IHt9OwogICAgICBQb2x5bGluZVBpcGVsaW5lLm51bWJlck9mUG9pbnRzID0gZnVuY3Rpb24ocDAsIHAxLCBtaW5EaXN0YW5jZSkgewogICAgICAgIGNvbnN0IGRpc3RhbmNlID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHAwLCBwMSk7CiAgICAgICAgcmV0dXJuIE1hdGguY2VpbChkaXN0YW5jZSAvIG1pbkRpc3RhbmNlKTsKICAgICAgfTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5udW1iZXJPZlBvaW50c1JodW1iTGluZSA9IGZ1bmN0aW9uKHAwLCBwMSwgZ3JhbnVsYXJpdHkpIHsKICAgICAgICBjb25zdCByYWRpYW5zRGlzdGFuY2VTcXVhcmVkID0gTWF0aC5wb3cocDAubG9uZ2l0dWRlIC0gcDEubG9uZ2l0dWRlLCAyKSArIE1hdGgucG93KHAwLmxhdGl0dWRlIC0gcDEubGF0aXR1ZGUsIDIpOwogICAgICAgIHJldHVybiBNYXRoLm1heCgKICAgICAgICAgIDEsCiAgICAgICAgICBNYXRoLmNlaWwoTWF0aC5zcXJ0KHJhZGlhbnNEaXN0YW5jZVNxdWFyZWQgLyAoZ3JhbnVsYXJpdHkgKiBncmFudWxhcml0eSkpKQogICAgICAgICk7CiAgICAgIH07CiAgICAgIGNhcnRvU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVBpcGVsaW5lLmV4dHJhY3RIZWlnaHRzID0gZnVuY3Rpb24ocG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgaGVpZ2h0c1tpXSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwLCBjYXJ0b1NjcmF0Y2gpLmhlaWdodDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGhlaWdodHM7CiAgICAgIH07CiAgICAgIHdyYXBMb25naXR1ZGVJbnZlcnNNYXRyaXggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHdyYXBMb25naXR1ZGVPcmlnaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHdyYXBMb25naXR1ZGVYWk5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgd3JhcExvbmdpdHVkZVhaUGxhbmUgPSBuZXcgUGxhbmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCAwKTsKICAgICAgd3JhcExvbmdpdHVkZVlaTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB3cmFwTG9uZ2l0dWRlWVpQbGFuZSA9IG5ldyBQbGFuZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIDApOwogICAgICB3cmFwTG9uZ2l0dWRlSW50ZXJzZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB3cmFwTG9uZ2l0dWRlT2Zmc2V0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpZGVIZWlnaHRzU2NyYXRjaEFycmF5ID0gW107CiAgICAgIGNhcnRvMSA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjYXJ0bzIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZUZpcnN0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZUxhc3QgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVsbGlwc29pZEdlb2Rlc2ljID0gbmV3IEVsbGlwc29pZEdlb2Rlc2ljX2RlZmF1bHQoKTsKICAgICAgZWxsaXBzb2lkUmh1bWIgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVQaXBlbGluZS53cmFwTG9uZ2l0dWRlID0gZnVuY3Rpb24ocG9zaXRpb25zLCBtb2RlbE1hdHJpeCkgewogICAgICAgIGNvbnN0IGNhcnRlc2lhbnMgPSBbXTsKICAgICAgICBjb25zdCBzZWdtZW50cyA9IFtdOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSAmJiBwb3NpdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgbW9kZWxNYXRyaXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtb2RlbE1hdHJpeCwgTWF0cml4NF9kZWZhdWx0LklERU5USVRZKTsKICAgICAgICAgIGNvbnN0IGludmVyc2VNb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oCiAgICAgICAgICAgIG1vZGVsTWF0cml4LAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlSW52ZXJzTWF0cml4CiAgICAgICAgICApOwogICAgICAgICAgY29uc3Qgb3JpZ2luID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCgKICAgICAgICAgICAgaW52ZXJzZU1vZGVsTWF0cml4LAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgICAgd3JhcExvbmdpdHVkZU9yaWdpbgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHh6Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludEFzVmVjdG9yKAogICAgICAgICAgICAgIGludmVyc2VNb2RlbE1hdHJpeCwKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLAogICAgICAgICAgICAgIHdyYXBMb25naXR1ZGVYWk5vcm1hbAogICAgICAgICAgICApLAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlWFpOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB4elBsYW5lMiA9IFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50Tm9ybWFsKAogICAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICAgIHh6Tm9ybWFsLAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlWFpQbGFuZQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHl6Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludEFzVmVjdG9yKAogICAgICAgICAgICAgIGludmVyc2VNb2RlbE1hdHJpeCwKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLAogICAgICAgICAgICAgIHdyYXBMb25naXR1ZGVZWk5vcm1hbAogICAgICAgICAgICApLAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlWVpOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB5elBsYW5lID0gUGxhbmVfZGVmYXVsdC5mcm9tUG9pbnROb3JtYWwoCiAgICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgICAgeXpOb3JtYWwsCiAgICAgICAgICAgIHdyYXBMb25naXR1ZGVZWlBsYW5lCiAgICAgICAgICApOwogICAgICAgICAgbGV0IGNvdW50ID0gMTsKICAgICAgICAgIGNhcnRlc2lhbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb25zWzBdKSk7CiAgICAgICAgICBsZXQgcHJldiA9IGNhcnRlc2lhbnNbMF07CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBjb25zdCBjdXIgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgIGlmIChQbGFuZV9kZWZhdWx0LmdldFBvaW50RGlzdGFuY2UoeXpQbGFuZSwgcHJldikgPCAwIHx8IFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZSh5elBsYW5lLCBjdXIpIDwgMCkgewogICAgICAgICAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQubGluZVNlZ21lbnRQbGFuZSgKICAgICAgICAgICAgICAgIHByZXYsCiAgICAgICAgICAgICAgICBjdXIsCiAgICAgICAgICAgICAgICB4elBsYW5lMiwKICAgICAgICAgICAgICAgIHdyYXBMb25naXR1ZGVJbnRlcnNlY3Rpb24KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIHh6Tm9ybWFsLAogICAgICAgICAgICAgICAgICA1ZS05LAogICAgICAgICAgICAgICAgICB3cmFwTG9uZ2l0dWRlT2Zmc2V0CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaWYgKFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZSh4elBsYW5lMiwgcHJldikgPCAwKSB7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUob2Zmc2V0LCBvZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FydGVzaWFucy5wdXNoKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGludGVyc2VjdGlvbiwgb2Zmc2V0LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChjb3VudCArIDEpOwogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShvZmZzZXQsIG9mZnNldCk7CiAgICAgICAgICAgICAgICBjYXJ0ZXNpYW5zLnB1c2goCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoaW50ZXJzZWN0aW9uLCBvZmZzZXQsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBjb3VudCA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhcnRlc2lhbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb25zW2ldKSk7CiAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgIHByZXYgPSBjdXI7CiAgICAgICAgICB9CiAgICAgICAgICBzZWdtZW50cy5wdXNoKGNvdW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHBvc2l0aW9uczogY2FydGVzaWFucywKICAgICAgICAgIGxlbmd0aHM6IHNlZ21lbnRzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZUFyYyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zKSkgewogICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5wb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgICAgIGxldCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICAgICAgY29uc3QgaGFzSGVpZ2h0QXJyYXkgPSBBcnJheS5pc0FycmF5KGhlaWdodCk7CiAgICAgICAgaWYgKGxlbmd0aCA8IDEpIHsKICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgICAgY29uc3QgcCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uc1swXSwgc2NhbGVGaXJzdCk7CiAgICAgICAgICBoZWlnaHQgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFswXSA6IGhlaWdodDsKICAgICAgICAgIGlmIChoZWlnaHQgIT09IDApIHsKICAgICAgICAgICAgY29uc3QgbiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCwgY2FydGVzaWFuKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobiwgaGVpZ2h0LCBuKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwLCBuLCBwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbcC54LCBwLnksIHAuel07CiAgICAgICAgfQogICAgICAgIGxldCBtaW5EaXN0YW5jZSA9IG9wdGlvbnMubWluRGlzdGFuY2U7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWluRGlzdGFuY2UpKSB7CiAgICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICAgICAgICApOwogICAgICAgICAgbWluRGlzdGFuY2UgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoZ3JhbnVsYXJpdHksIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzKTsKICAgICAgICB9CiAgICAgICAgbGV0IG51bVBvaW50cyA9IDA7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgbnVtUG9pbnRzICs9IFBvbHlsaW5lUGlwZWxpbmUubnVtYmVyT2ZQb2ludHMoCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGFycmF5TGVuZ3RoID0gKG51bVBvaW50cyArIDEpICogMzsKICAgICAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgQXJyYXkoYXJyYXlMZW5ndGgpOwogICAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgY29uc3QgcDEgPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgY29uc3QgaDAgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFtpXSA6IGhlaWdodDsKICAgICAgICAgIGNvbnN0IGgxID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbaSArIDFdIDogaGVpZ2h0OwogICAgICAgICAgb2Zmc2V0ID0gZ2VuZXJhdGVDYXJ0ZXNpYW5BcmMoCiAgICAgICAgICAgIHAwLAogICAgICAgICAgICBwMSwKICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgaDAsCiAgICAgICAgICAgIGgxLAogICAgICAgICAgICBuZXdQb3NpdGlvbnMsCiAgICAgICAgICAgIG9mZnNldAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgc3ViZGl2aWRlSGVpZ2h0c1NjcmF0Y2hBcnJheS5sZW5ndGggPSAwOwogICAgICAgIGNvbnN0IGxhc3RQb2ludCA9IHBvc2l0aW9uc1tsZW5ndGggLSAxXTsKICAgICAgICBjb25zdCBjYXJ0byA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhsYXN0UG9pbnQsIGNhcnRvMSk7CiAgICAgICAgY2FydG8uaGVpZ2h0ID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbbGVuZ3RoIC0gMV0gOiBoZWlnaHQ7CiAgICAgICAgY29uc3QgY2FydCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0bywgY2FydGVzaWFuKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0LCBuZXdQb3NpdGlvbnMsIGFycmF5TGVuZ3RoIC0gMyk7CiAgICAgICAgcmV0dXJuIG5ld1Bvc2l0aW9uczsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzAyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVBpcGVsaW5lLmdlbmVyYXRlUmh1bWJBcmMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucykpIHsKICAgICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KTsKICAgICAgICBsZXQgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgICAgIGNvbnN0IGhhc0hlaWdodEFycmF5ID0gQXJyYXkuaXNBcnJheShoZWlnaHQpOwogICAgICAgIGlmIChsZW5ndGggPCAxKSB7CiAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfSBlbHNlIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgICAgIGNvbnN0IHAgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbnNbMF0sIHNjYWxlRmlyc3QpOwogICAgICAgICAgaGVpZ2h0ID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbMF0gOiBoZWlnaHQ7CiAgICAgICAgICBpZiAoaGVpZ2h0ICE9PSAwKSB7CiAgICAgICAgICAgIGNvbnN0IG4gPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHAsIGNhcnRlc2lhbik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG4sIGhlaWdodCwgbik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocCwgbiwgcCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gW3AueCwgcC55LCBwLnpdOwogICAgICAgIH0KICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICAgICApOwogICAgICAgIGxldCBudW1Qb2ludHMgPSAwOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgIHBvc2l0aW9uc1swXSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwMgogICAgICAgICk7CiAgICAgICAgbGV0IGMxOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDFdLAogICAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMTIKICAgICAgICAgICk7CiAgICAgICAgICBudW1Qb2ludHMgKz0gUG9seWxpbmVQaXBlbGluZS5udW1iZXJPZlBvaW50c1JodW1iTGluZShjMCwgYzEsIGdyYW51bGFyaXR5KTsKICAgICAgICAgIGMwID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoYzEsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwMik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGFycmF5TGVuZ3RoID0gKG51bVBvaW50cyArIDEpICogMzsKICAgICAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgQXJyYXkoYXJyYXlMZW5ndGgpOwogICAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgY29uc3QgcDEgPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgY29uc3QgaDAgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFtpXSA6IGhlaWdodDsKICAgICAgICAgIGNvbnN0IGgxID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbaSArIDFdIDogaGVpZ2h0OwogICAgICAgICAgb2Zmc2V0ID0gZ2VuZXJhdGVDYXJ0ZXNpYW5SaHVtYkFyYygKICAgICAgICAgICAgcDAsCiAgICAgICAgICAgIHAxLAogICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBoMCwKICAgICAgICAgICAgaDEsCiAgICAgICAgICAgIG5ld1Bvc2l0aW9ucywKICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBzdWJkaXZpZGVIZWlnaHRzU2NyYXRjaEFycmF5Lmxlbmd0aCA9IDA7CiAgICAgICAgY29uc3QgbGFzdFBvaW50ID0gcG9zaXRpb25zW2xlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IGNhcnRvID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGxhc3RQb2ludCwgY2FydG8xKTsKICAgICAgICBjYXJ0by5oZWlnaHQgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFtsZW5ndGggLSAxXSA6IGhlaWdodDsKICAgICAgICBjb25zdCBjYXJ0ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvLCBjYXJ0ZXNpYW4pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhcnQsIG5ld1Bvc2l0aW9ucywgYXJyYXlMZW5ndGggLSAzKTsKICAgICAgICByZXR1cm4gbmV3UG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5bGluZVBpcGVsaW5lLmdlbmVyYXRlQ2FydGVzaWFuQXJjID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IG51bWJlckFycmF5ID0gUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZUFyYyhvcHRpb25zKTsKICAgICAgICBjb25zdCBzaXplID0gbnVtYmVyQXJyYXkubGVuZ3RoIC8gMzsKICAgICAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgQXJyYXkoc2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sobnVtYmVyQXJyYXksIGkgKiAzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1Bvc2l0aW9uczsKICAgICAgfTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZUNhcnRlc2lhblJodW1iQXJjID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IG51bWJlckFycmF5ID0gUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZVJodW1iQXJjKG9wdGlvbnMpOwogICAgICAgIGNvbnN0IHNpemUgPSBudW1iZXJBcnJheS5sZW5ndGggLyAzOwogICAgICAgIGNvbnN0IG5ld1Bvc2l0aW9ucyA9IG5ldyBBcnJheShzaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykgewogICAgICAgICAgbmV3UG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhudW1iZXJBcnJheSwgaSAqIDMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3UG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQgPSBQb2x5bGluZVBpcGVsaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvb25lVGltZVdhcm5pbmcuanMKICBmdW5jdGlvbiBvbmVUaW1lV2FybmluZyhpZGVudGlmaWVyLCBtZXNzYWdlKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpZGVudGlmaWVyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaWRlbnRpZmllciBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHdhcm5pbmdzW2lkZW50aWZpZXJdKSkgewogICAgICB3YXJuaW5nc1tpZGVudGlmaWVyXSA9IHRydWU7CiAgICAgIGNvbnNvbGUud2FybihkZWZhdWx0VmFsdWVfZGVmYXVsdChtZXNzYWdlLCBpZGVudGlmaWVyKSk7CiAgICB9CiAgfQogIHZhciB3YXJuaW5ncywgb25lVGltZVdhcm5pbmdfZGVmYXVsdDsKICB2YXIgaW5pdF9vbmVUaW1lV2FybmluZyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvb25lVGltZVdhcm5pbmcuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICB3YXJuaW5ncyA9IHt9OwogICAgICBvbmVUaW1lV2FybmluZy5nZW9tZXRyeU91dGxpbmVzID0gIkVudGl0eSBnZW9tZXRyeSBvdXRsaW5lcyBhcmUgdW5zdXBwb3J0ZWQgb24gdGVycmFpbi4gT3V0bGluZXMgd2lsbCBiZSBkaXNhYmxlZC4gVG8gZW5hYmxlIG91dGxpbmVzLCBkaXNhYmxlIGdlb21ldHJ5IHRlcnJhaW4gY2xhbXBpbmcgYnkgZXhwbGljaXRseSBzZXR0aW5nIGhlaWdodCB0byAwLiI7CiAgICAgIG9uZVRpbWVXYXJuaW5nLmdlb21ldHJ5WkluZGV4ID0gIkVudGl0eSBnZW9tZXRyeSB3aXRoIHpJbmRleCBhcmUgdW5zdXBwb3J0ZWQgd2hlbiBoZWlnaHQgb3IgZXh0cnVkZWRIZWlnaHQgYXJlIGRlZmluZWQuICB6SW5kZXggd2lsbCBiZSBpZ25vcmVkIjsKICAgICAgb25lVGltZVdhcm5pbmcuZ2VvbWV0cnlIZWlnaHRSZWZlcmVuY2UgPSAiRW50aXR5IGNvcnJpZG9yLCBlbGxpcHNlLCBwb2x5Z29uIG9yIHJlY3RhbmdsZSB3aXRoIGhlaWdodFJlZmVyZW5jZSBtdXN0IGFsc28gaGF2ZSBhIGRlZmluZWQgaGVpZ2h0LiAgaGVpZ2h0UmVmZXJlbmNlIHdpbGwgYmUgaWdub3JlZCI7CiAgICAgIG9uZVRpbWVXYXJuaW5nLmdlb21ldHJ5RXh0cnVkZWRIZWlnaHRSZWZlcmVuY2UgPSAiRW50aXR5IGNvcnJpZG9yLCBlbGxpcHNlLCBwb2x5Z29uIG9yIHJlY3RhbmdsZSB3aXRoIGV4dHJ1ZGVkSGVpZ2h0UmVmZXJlbmNlIG11c3QgYWxzbyBoYXZlIGEgZGVmaW5lZCBleHRydWRlZEhlaWdodC4gIGV4dHJ1ZGVkSGVpZ2h0UmVmZXJlbmNlIHdpbGwgYmUgaWdub3JlZCI7CiAgICAgIG9uZVRpbWVXYXJuaW5nX2RlZmF1bHQgPSBvbmVUaW1lV2FybmluZzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gc2NhbGVUb1N1cmZhY2UocG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGhlaWdodHMgPSBuZXcgQXJyYXkocG9zaXRpb25zLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwb3MgPSBwb3NpdGlvbnNbaV07CiAgICAgIGNhcnRvZ3JhcGhpYyA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwb3MsIGNhcnRvZ3JhcGhpYyk7CiAgICAgIGhlaWdodHNbaV0gPSBjYXJ0b2dyYXBoaWMuaGVpZ2h0OwogICAgICBwb3NpdGlvbnNbaV0gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3MsIHBvcyk7CiAgICB9CiAgICByZXR1cm4gaGVpZ2h0czsKICB9CiAgZnVuY3Rpb24gc3ViZGl2aWRlSGVpZ2h0czIocG9pbnRzLCBoMCwgaDEsIGdyYW51bGFyaXR5KSB7CiAgICBjb25zdCBwMCA9IHBvaW50c1swXTsKICAgIGNvbnN0IHAxID0gcG9pbnRzWzFdOwogICAgY29uc3QgYW5nbGVCZXR3ZWVuID0gQ2FydGVzaWFuM19kZWZhdWx0LmFuZ2xlQmV0d2VlbihwMCwgcDEpOwogICAgY29uc3QgbnVtUG9pbnRzID0gTWF0aC5jZWlsKGFuZ2xlQmV0d2VlbiAvIGdyYW51bGFyaXR5KTsKICAgIGNvbnN0IGhlaWdodHMgPSBuZXcgQXJyYXkobnVtUG9pbnRzKTsKICAgIGxldCBpOwogICAgaWYgKGgwID09PSBoMSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICBoZWlnaHRzW2ldID0gaDA7CiAgICAgIH0KICAgICAgaGVpZ2h0cy5wdXNoKGgxKTsKICAgICAgcmV0dXJuIGhlaWdodHM7CiAgICB9CiAgICBjb25zdCBkSGVpZ2h0ID0gaDEgLSBoMDsKICAgIGNvbnN0IGhlaWdodFBlclZlcnRleCA9IGRIZWlnaHQgLyBudW1Qb2ludHM7CiAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgY29uc3QgaCA9IGgwICsgaSAqIGhlaWdodFBlclZlcnRleDsKICAgICAgaGVpZ2h0c1tpXSA9IGg7CiAgICB9CiAgICBoZWlnaHRzWzBdID0gaDA7CiAgICBoZWlnaHRzLnB1c2goaDEpOwogICAgcmV0dXJuIGhlaWdodHM7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSb3RhdGlvbkFuZ2xlKHN0YXJ0LCBlbmQsIHBvc2l0aW9uLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IG5ldyBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdChwb3NpdGlvbiwgZWxsaXBzb2lkKTsKICAgIGNvbnN0IG5leHQgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50T250b1BsYW5lKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBzdGFydCwgbmV4dFNjcmF0Y2gpLAogICAgICBuZXh0U2NyYXRjaAogICAgKTsKICAgIGNvbnN0IHByZXYgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50T250b1BsYW5lKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBlbmQsIHByZXZTY3JhdGNoKSwKICAgICAgcHJldlNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBhbmdsZSA9IENhcnRlc2lhbjJfZGVmYXVsdC5hbmdsZUJldHdlZW4obmV4dCwgcHJldik7CiAgICByZXR1cm4gcHJldi54ICogbmV4dC55IC0gcHJldi55ICogbmV4dC54ID49IDAgPyAtYW5nbGUgOiBhbmdsZTsKICB9CiAgZnVuY3Rpb24gYWRkUG9zaXRpb24oY2VudGVyLCBsZWZ0LCBzaGFwZSwgZmluYWxQb3NpdGlvbnMsIGVsbGlwc29pZCwgaGVpZ2h0LCB4U2NhbGFyLCByZXBlYXQpIHsKICAgIGxldCB3ZXN0ID0gd2VzdFNjcmF0Y2g7CiAgICBsZXQgZmluYWxQb3NpdGlvbiA9IGZpbmFsUG9zU2NyYXRjaDsKICAgIHRyYW5zZm9ybSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZShjZW50ZXIsIGVsbGlwc29pZCwgdHJhbnNmb3JtKTsKICAgIHdlc3QgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50QXNWZWN0b3IodHJhbnNmb3JtLCBuZWdhdGl2ZVgsIHdlc3QpOwogICAgd2VzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUod2VzdCwgd2VzdCk7CiAgICBjb25zdCBhbmdsZSA9IGNvbXB1dGVSb3RhdGlvbkFuZ2xlKHdlc3QsIGxlZnQsIGNlbnRlciwgZWxsaXBzb2lkKTsKICAgIHJvdGF0aW9uWiA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUm90YXRpb25aKGFuZ2xlLCByb3RhdGlvblopOwogICAgaGVpZ2h0Q2FydGVzaWFuLnogPSBoZWlnaHQ7CiAgICB0cmFuc2Zvcm0gPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlUcmFuc2Zvcm1hdGlvbigKICAgICAgdHJhbnNmb3JtLAogICAgICBNYXRyaXg0X2RlZmF1bHQuZnJvbVJvdGF0aW9uVHJhbnNsYXRpb24ocm90YXRpb25aLCBoZWlnaHRDYXJ0ZXNpYW4sIHRyYW5zbGF0aW9uKSwKICAgICAgdHJhbnNmb3JtCiAgICApOwogICAgY29uc3Qgc2NhbGUgPSBzY2FsZU1hdHJpeDsKICAgIHNjYWxlWzBdID0geFNjYWxhcjsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVwZWF0OyBqKyspIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaGFwZS5sZW5ndGg7IGkgKz0gMykgewogICAgICAgIGZpbmFsUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHNoYXBlLCBpLCBmaW5hbFBvc2l0aW9uKTsKICAgICAgICBmaW5hbFBvc2l0aW9uID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICBzY2FsZSwKICAgICAgICAgIGZpbmFsUG9zaXRpb24sCiAgICAgICAgICBmaW5hbFBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBmaW5hbFBvc2l0aW9uID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCgKICAgICAgICAgIHRyYW5zZm9ybSwKICAgICAgICAgIGZpbmFsUG9zaXRpb24sCiAgICAgICAgICBmaW5hbFBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBmaW5hbFBvc2l0aW9ucy5wdXNoKGZpbmFsUG9zaXRpb24ueCwgZmluYWxQb3NpdGlvbi55LCBmaW5hbFBvc2l0aW9uLnopOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmluYWxQb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGFkZFBvc2l0aW9ucyhjZW50ZXJzLCBsZWZ0LCBzaGFwZSwgZmluYWxQb3NpdGlvbnMsIGVsbGlwc29pZCwgaGVpZ2h0cywgeFNjYWxhcikgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjZW50ZXJzLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoY2VudGVycywgaSwgY2VudGVyU2NyYXRjaDIpOwogICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9uKAogICAgICAgIGNlbnRlciwKICAgICAgICBsZWZ0LAogICAgICAgIHNoYXBlLAogICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBoZWlnaHRzW2kgLyAzXSwKICAgICAgICB4U2NhbGFyLAogICAgICAgIDEKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBmaW5hbFBvc2l0aW9uczsKICB9CiAgZnVuY3Rpb24gY29udmVydFNoYXBlVG8zRER1cGxpY2F0ZShzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSkgewogICAgY29uc3QgbGVuZ3RoID0gc2hhcGUyRC5sZW5ndGg7CiAgICBjb25zdCBzaGFwZSA9IG5ldyBBcnJheShsZW5ndGggKiA2KTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBjb25zdCB4T2Zmc2V0ID0gYm91bmRpbmdSZWN0YW5nbGUueCArIGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoIC8gMjsKICAgIGNvbnN0IHlPZmZzZXQgPSBib3VuZGluZ1JlY3RhbmdsZS55ICsgYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0IC8gMjsKICAgIGxldCBwb2ludCA9IHNoYXBlMkRbMF07CiAgICBzaGFwZVtpbmRleCsrXSA9IHBvaW50LnggLSB4T2Zmc2V0OwogICAgc2hhcGVbaW5kZXgrK10gPSAwOwogICAgc2hhcGVbaW5kZXgrK10gPSBwb2ludC55IC0geU9mZnNldDsKICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcG9pbnQgPSBzaGFwZTJEW2ldOwogICAgICBjb25zdCB4ID0gcG9pbnQueCAtIHhPZmZzZXQ7CiAgICAgIGNvbnN0IHogPSBwb2ludC55IC0geU9mZnNldDsKICAgICAgc2hhcGVbaW5kZXgrK10gPSB4OwogICAgICBzaGFwZVtpbmRleCsrXSA9IDA7CiAgICAgIHNoYXBlW2luZGV4KytdID0gejsKICAgICAgc2hhcGVbaW5kZXgrK10gPSB4OwogICAgICBzaGFwZVtpbmRleCsrXSA9IDA7CiAgICAgIHNoYXBlW2luZGV4KytdID0gejsKICAgIH0KICAgIHBvaW50ID0gc2hhcGUyRFswXTsKICAgIHNoYXBlW2luZGV4KytdID0gcG9pbnQueCAtIHhPZmZzZXQ7CiAgICBzaGFwZVtpbmRleCsrXSA9IDA7CiAgICBzaGFwZVtpbmRleCsrXSA9IHBvaW50LnkgLSB5T2Zmc2V0OwogICAgcmV0dXJuIHNoYXBlOwogIH0KICBmdW5jdGlvbiBjb252ZXJ0U2hhcGVUbzNEKHNoYXBlMkQsIGJvdW5kaW5nUmVjdGFuZ2xlKSB7CiAgICBjb25zdCBsZW5ndGggPSBzaGFwZTJELmxlbmd0aDsKICAgIGNvbnN0IHNoYXBlID0gbmV3IEFycmF5KGxlbmd0aCAqIDMpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGNvbnN0IHhPZmZzZXQgPSBib3VuZGluZ1JlY3RhbmdsZS54ICsgYm91bmRpbmdSZWN0YW5nbGUud2lkdGggLyAyOwogICAgY29uc3QgeU9mZnNldCA9IGJvdW5kaW5nUmVjdGFuZ2xlLnkgKyBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQgLyAyOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBzaGFwZVtpbmRleCsrXSA9IHNoYXBlMkRbaV0ueCAtIHhPZmZzZXQ7CiAgICAgIHNoYXBlW2luZGV4KytdID0gMDsKICAgICAgc2hhcGVbaW5kZXgrK10gPSBzaGFwZTJEW2ldLnkgLSB5T2Zmc2V0OwogICAgfQogICAgcmV0dXJuIHNoYXBlOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUm91bmRDb3JuZXIocGl2b3QsIHN0YXJ0UG9pbnQsIGVuZFBvaW50LCBjb3JuZXJUeXBlLCBsZWZ0SXNPdXRzaWRlLCBlbGxpcHNvaWQsIGZpbmFsUG9zaXRpb25zLCBzaGFwZSwgaGVpZ2h0LCBkdXBsaWNhdGVQb2ludHMpIHsKICAgIGNvbnN0IGFuZ2xlID0gQ2FydGVzaWFuM19kZWZhdWx0LmFuZ2xlQmV0d2VlbigKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHN0YXJ0UG9pbnQsIHBpdm90LCBzY3JhdGNoMSksCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChlbmRQb2ludCwgcGl2b3QsIHNjcmF0Y2gyKQogICAgKTsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQgPyAwIDogTWF0aC5jZWlsKGFuZ2xlIC8gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyg1KSk7CiAgICBsZXQgbTsKICAgIGlmIChsZWZ0SXNPdXRzaWRlKSB7CiAgICAgIG0gPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHBpdm90LCBzY3JhdGNoMSksCiAgICAgICAgICBhbmdsZSAvIChncmFudWxhcml0eSArIDEpLAogICAgICAgICAgcXVhdGVyaW9uCiAgICAgICAgKSwKICAgICAgICByb3RNYXRyaXgKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIG0gPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUocGl2b3QsIGFuZ2xlIC8gKGdyYW51bGFyaXR5ICsgMSksIHF1YXRlcmlvbiksCiAgICAgICAgcm90TWF0cml4CiAgICAgICk7CiAgICB9CiAgICBsZXQgbGVmdDsKICAgIGxldCBzdXJmYWNlUG9pbnQ7CiAgICBzdGFydFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHN0YXJ0UG9pbnQsIHN0YXJ0UG9pbnRTY3JhdGNoKTsKICAgIGlmIChncmFudWxhcml0eSA+IDApIHsKICAgICAgY29uc3QgcmVwZWF0ID0gZHVwbGljYXRlUG9pbnRzID8gMiA6IDE7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JhbnVsYXJpdHk7IGkrKykgewogICAgICAgIHN0YXJ0UG9pbnQgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihtLCBzdGFydFBvaW50LCBzdGFydFBvaW50KTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHN0YXJ0UG9pbnQsIHBpdm90LCBzY3JhdGNoMSk7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobGVmdCwgbGVmdCk7CiAgICAgICAgaWYgKCFsZWZ0SXNPdXRzaWRlKSB7CiAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShsZWZ0LCBsZWZ0KTsKICAgICAgICB9CiAgICAgICAgc3VyZmFjZVBvaW50ID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2Uoc3RhcnRQb2ludCwgc2NyYXRjaDIpOwogICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgICBzdXJmYWNlUG9pbnQsCiAgICAgICAgICBsZWZ0LAogICAgICAgICAgc2hhcGUsCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIDEsCiAgICAgICAgICByZXBlYXQKICAgICAgICApOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHN0YXJ0UG9pbnQsIHBpdm90LCBzY3JhdGNoMSk7CiAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGxlZnQsIGxlZnQpOwogICAgICBpZiAoIWxlZnRJc091dHNpZGUpIHsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShsZWZ0LCBsZWZ0KTsKICAgICAgfQogICAgICBzdXJmYWNlUG9pbnQgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShzdGFydFBvaW50LCBzY3JhdGNoMik7CiAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgc3VyZmFjZVBvaW50LAogICAgICAgIGxlZnQsCiAgICAgICAgc2hhcGUsCiAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGhlaWdodCwKICAgICAgICAxLAogICAgICAgIDEKICAgICAgKTsKICAgICAgZW5kUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5kUG9pbnQsIHN0YXJ0UG9pbnRTY3JhdGNoKTsKICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChlbmRQb2ludCwgcGl2b3QsIHNjcmF0Y2gxKTsKICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobGVmdCwgbGVmdCk7CiAgICAgIGlmICghbGVmdElzT3V0c2lkZSkgewogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGxlZnQsIGxlZnQpOwogICAgICB9CiAgICAgIHN1cmZhY2VQb2ludCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKGVuZFBvaW50LCBzY3JhdGNoMik7CiAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgc3VyZmFjZVBvaW50LAogICAgICAgIGxlZnQsCiAgICAgICAgc2hhcGUsCiAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGhlaWdodCwKICAgICAgICAxLAogICAgICAgIDEKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBmaW5hbFBvc2l0aW9uczsKICB9CiAgdmFyIHNjcmF0Y2gyQXJyYXksIHNjcmF0Y2hDYXJ0ZXNpYW4xNiwgc2NyYXRjaENhcnRlc2lhbjI2LCBzY3JhdGNoQ2FydGVzaWFuMzcsIHNjcmF0Y2hDYXJ0ZXNpYW40Mywgc2NyYXRjaENhcnRlc2lhbjUyLCBzY3JhdGNoQ2FydGVzaWFuNjIsIHNjcmF0Y2hDYXJ0ZXNpYW43LCBzY3JhdGNoQ2FydGVzaWFuOCwgc2NyYXRjaENhcnRlc2lhbjksIHNjcmF0Y2gxLCBzY3JhdGNoMiwgUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnksIGNhcnRvZ3JhcGhpYywgbmV4dFNjcmF0Y2gsIHByZXZTY3JhdGNoLCBuZWdhdGl2ZVgsIHRyYW5zZm9ybSwgdHJhbnNsYXRpb24sIHJvdGF0aW9uWiwgc2NhbGVNYXRyaXgsIHdlc3RTY3JhdGNoLCBmaW5hbFBvc1NjcmF0Y2gsIGhlaWdodENhcnRlc2lhbiwgY2VudGVyU2NyYXRjaDIsIHF1YXRlcmlvbiwgc3RhcnRQb2ludFNjcmF0Y2gsIHJvdE1hdHJpeCwgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uLCBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uLCBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ29ybmVyVHlwZSgpOwogICAgICBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1BvbHlsaW5lUGlwZWxpbmUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBpbml0X29uZVRpbWVXYXJuaW5nKCk7CiAgICAgIHNjcmF0Y2gyQXJyYXkgPSBbbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCldOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM3ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW41MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjYyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW45ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5ID0ge307CiAgICAgIGNhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBuZXh0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcHJldlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG5lZ2F0aXZlWCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoLTEsIDAsIDApOwogICAgICB0cmFuc2Zvcm0gPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHRyYW5zbGF0aW9uID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICByb3RhdGlvblogPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHNjYWxlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LklERU5USVRZLmNsb25lKCk7CiAgICAgIHdlc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmaW5hbFBvc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIGhlaWdodENhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2VudGVyU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHF1YXRlcmlvbiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgc3RhcnRQb2ludFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJvdE1hdHJpeCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkucmVtb3ZlRHVwbGljYXRlc0Zyb21TaGFwZSA9IGZ1bmN0aW9uKHNoYXBlUG9zaXRpb25zKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gc2hhcGVQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGNsZWFuZWRQb3NpdGlvbnMgPSBbXTsKICAgICAgICBmb3IgKGxldCBpMCA9IGxlbmd0aCAtIDEsIGkxID0gMDsgaTEgPCBsZW5ndGg7IGkwID0gaTErKykgewogICAgICAgICAgY29uc3QgdjAyID0gc2hhcGVQb3NpdGlvbnNbaTBdOwogICAgICAgICAgY29uc3QgdjEyID0gc2hhcGVQb3NpdGlvbnNbaTFdOwogICAgICAgICAgaWYgKCFDYXJ0ZXNpYW4yX2RlZmF1bHQuZXF1YWxzKHYwMiwgdjEyKSkgewogICAgICAgICAgICBjbGVhbmVkUG9zaXRpb25zLnB1c2godjEyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNsZWFuZWRQb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5LmFuZ2xlSXNHcmVhdGVyVGhhblBpID0gZnVuY3Rpb24oZm9yd2FyZCwgYmFja3dhcmQsIHBvc2l0aW9uLCBlbGxpcHNvaWQpIHsKICAgICAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBuZXcgRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQocG9zaXRpb24sIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgbmV4dCA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRPbnRvUGxhbmUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBmb3J3YXJkLCBuZXh0U2NyYXRjaCksCiAgICAgICAgICBuZXh0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgcHJldiA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRPbnRvUGxhbmUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBiYWNrd2FyZCwgcHJldlNjcmF0Y2gpLAogICAgICAgICAgcHJldlNjcmF0Y2gKICAgICAgICApOwogICAgICAgIHJldHVybiBwcmV2LnggKiBuZXh0LnkgLSBwcmV2LnkgKiBuZXh0LnggPj0gMDsKICAgICAgfTsKICAgICAgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeS5jb21wdXRlUG9zaXRpb25zID0gZnVuY3Rpb24ocG9zaXRpb25zLCBzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSwgZ2VvbWV0cnksIGR1cGxpY2F0ZVBvaW50cykgewogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgaGVpZ2h0cyA9IHNjYWxlVG9TdXJmYWNlKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBjb3JuZXJUeXBlID0gZ2VvbWV0cnkuX2Nvcm5lclR5cGU7CiAgICAgICAgY29uc3Qgc2hhcGVGb3JTaWRlcyA9IGR1cGxpY2F0ZVBvaW50cyA/IGNvbnZlcnRTaGFwZVRvM0REdXBsaWNhdGUoc2hhcGUyRCwgYm91bmRpbmdSZWN0YW5nbGUpIDogY29udmVydFNoYXBlVG8zRChzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSk7CiAgICAgICAgY29uc3Qgc2hhcGVGb3JFbmRzID0gZHVwbGljYXRlUG9pbnRzID8gY29udmVydFNoYXBlVG8zRChzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSkgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgaGVpZ2h0T2Zmc2V0ID0gYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0IC8gMjsKICAgICAgICBjb25zdCB3aWR0aCA9IGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoIC8gMjsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgZmluYWxQb3NpdGlvbnMgPSBbXTsKICAgICAgICBsZXQgZW5kcyA9IGR1cGxpY2F0ZVBvaW50cyA/IFtdIDogdm9pZCAwOwogICAgICAgIGxldCBmb3J3YXJkID0gc2NyYXRjaENhcnRlc2lhbjE2OwogICAgICAgIGxldCBiYWNrd2FyZCA9IHNjcmF0Y2hDYXJ0ZXNpYW4yNjsKICAgICAgICBsZXQgY29ybmVyRGlyZWN0aW9uID0gc2NyYXRjaENhcnRlc2lhbjM3OwogICAgICAgIGxldCBzdXJmYWNlTm9ybWFsID0gc2NyYXRjaENhcnRlc2lhbjQzOwogICAgICAgIGxldCBwaXZvdCA9IHNjcmF0Y2hDYXJ0ZXNpYW41MjsKICAgICAgICBsZXQgc3RhcnQgPSBzY3JhdGNoQ2FydGVzaWFuNjI7CiAgICAgICAgbGV0IGVuZCA9IHNjcmF0Y2hDYXJ0ZXNpYW43OwogICAgICAgIGxldCBsZWZ0ID0gc2NyYXRjaENhcnRlc2lhbjg7CiAgICAgICAgbGV0IHByZXZpb3VzUG9zaXRpb24gPSBzY3JhdGNoQ2FydGVzaWFuOTsKICAgICAgICBsZXQgcG9zaXRpb24gPSBwb3NpdGlvbnNbMF07CiAgICAgICAgbGV0IG5leHRQb3NpdGlvbiA9IHBvc2l0aW9uc1sxXTsKICAgICAgICBzdXJmYWNlTm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgc3VyZmFjZU5vcm1hbCk7CiAgICAgICAgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChuZXh0UG9zaXRpb24sIHBvc2l0aW9uLCBmb3J3YXJkKTsKICAgICAgICBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShmb3J3YXJkLCBmb3J3YXJkKTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHN1cmZhY2VOb3JtYWwsIGZvcndhcmQsIGxlZnQpOwogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGxlZnQsIGxlZnQpOwogICAgICAgIGxldCBoMCA9IGhlaWdodHNbMF07CiAgICAgICAgbGV0IGgxID0gaGVpZ2h0c1sxXTsKICAgICAgICBpZiAoZHVwbGljYXRlUG9pbnRzKSB7CiAgICAgICAgICBlbmRzID0gYWRkUG9zaXRpb24oCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICBzaGFwZUZvckVuZHMsCiAgICAgICAgICAgIGVuZHMsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgaDAgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHByZXZpb3VzUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHByZXZpb3VzUG9zaXRpb24pOwogICAgICAgIHBvc2l0aW9uID0gbmV4dFBvc2l0aW9uOwogICAgICAgIGJhY2t3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShmb3J3YXJkLCBiYWNrd2FyZCk7CiAgICAgICAgbGV0IHN1YmRpdmlkZWRIZWlnaHRzOwogICAgICAgIGxldCBzdWJkaXZpZGVkUG9zaXRpb25zOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICBjb25zdCByZXBlYXQgPSBkdXBsaWNhdGVQb2ludHMgPyAyIDogMTsKICAgICAgICAgIG5leHRQb3NpdGlvbiA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBpZiAocG9zaXRpb24uZXF1YWxzKG5leHRQb3NpdGlvbikpIHsKICAgICAgICAgICAgb25lVGltZVdhcm5pbmdfZGVmYXVsdCgKICAgICAgICAgICAgICAiUG9zaXRpb25zIGFyZSB0b28gY2xvc2UgYW5kIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgd2l0aCByb3VuZGluZyBlcnJvci4iCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChuZXh0UG9zaXRpb24sIHBvc2l0aW9uLCBmb3J3YXJkKTsKICAgICAgICAgIGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGZvcndhcmQsIGZvcndhcmQpOwogICAgICAgICAgc3VyZmFjZU5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIHN1cmZhY2VOb3JtYWwpOwogICAgICAgICAgY29uc3QgZm9yd2FyZFByb2plY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgc3VyZmFjZU5vcm1hbCwKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRvdChmb3J3YXJkLCBzdXJmYWNlTm9ybWFsKSwKICAgICAgICAgICAgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uCiAgICAgICAgICApOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGZvcndhcmQsIGZvcndhcmRQcm9qZWN0aW9uLCBmb3J3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGZvcndhcmRQcm9qZWN0aW9uLCBmb3J3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBjb25zdCBiYWNrd2FyZFByb2plY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgc3VyZmFjZU5vcm1hbCwKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRvdChiYWNrd2FyZCwgc3VyZmFjZU5vcm1hbCksCiAgICAgICAgICAgIHNjcmF0Y2hCYWNrd2FyZFByb2plY3Rpb24KICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoYmFja3dhcmQsIGJhY2t3YXJkUHJvamVjdGlvbiwgYmFja3dhcmRQcm9qZWN0aW9uKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoYmFja3dhcmRQcm9qZWN0aW9uLCBiYWNrd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgY29uc3QgZG9Db3JuZXIgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICAgIE1hdGguYWJzKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZm9yd2FyZFByb2plY3Rpb24sIGJhY2t3YXJkUHJvamVjdGlvbikpLAogICAgICAgICAgICAxLAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjcKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZG9Db3JuZXIpIHsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChmb3J3YXJkLCBiYWNrd2FyZCwgY29ybmVyRGlyZWN0aW9uKTsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShjb3JuZXJEaXJlY3Rpb24sIGNvcm5lckRpcmVjdGlvbik7CiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgc3VyZmFjZU5vcm1hbCwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgICAgICAgIHN1cmZhY2VOb3JtYWwsCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNvcm5lckRpcmVjdGlvbiwgY29ybmVyRGlyZWN0aW9uKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGFyID0gMSAvIE1hdGgubWF4KAogICAgICAgICAgICAgIDAuMjUsCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhjb3JuZXJEaXJlY3Rpb24sIGJhY2t3YXJkLCBzY3JhdGNoMSkKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IGxlZnRJc091dHNpZGUgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeS5hbmdsZUlzR3JlYXRlclRoYW5QaSgKICAgICAgICAgICAgICBmb3J3YXJkLAogICAgICAgICAgICAgIGJhY2t3YXJkLAogICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAobGVmdElzT3V0c2lkZSkgewogICAgICAgICAgICAgIHBpdm90ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICAgICAgc2NhbGFyICogd2lkdGgsCiAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHBpdm90CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzdGFydCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBwaXZvdCwKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoLCBzdGFydCksCiAgICAgICAgICAgICAgICBzdGFydAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc2NyYXRjaDJBcnJheVswXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwcmV2aW91c1Bvc2l0aW9uLCBzY3JhdGNoMkFycmF5WzBdKTsKICAgICAgICAgICAgICBzY3JhdGNoMkFycmF5WzFdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHN0YXJ0LCBzY3JhdGNoMkFycmF5WzFdKTsKICAgICAgICAgICAgICBzdWJkaXZpZGVkSGVpZ2h0cyA9IHN1YmRpdmlkZUhlaWdodHMyKAogICAgICAgICAgICAgICAgc2NyYXRjaDJBcnJheSwKICAgICAgICAgICAgICAgIGgwICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICBncmFudWxhcml0eQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyh7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnM6IHNjcmF0Y2gyQXJyYXksCiAgICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb25zKAogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGxlZnQsCiAgICAgICAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkSGVpZ2h0cywKICAgICAgICAgICAgICAgIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Moc3VyZmFjZU5vcm1hbCwgZm9yd2FyZCwgbGVmdCk7CiAgICAgICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobGVmdCwgbGVmdCk7CiAgICAgICAgICAgICAgZW5kID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHBpdm90LAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGgsIGVuZCksCiAgICAgICAgICAgICAgICBlbmQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCB8fCBjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgICAgICAgY29tcHV0ZVJvdW5kQ29ybmVyKAogICAgICAgICAgICAgICAgICBwaXZvdCwKICAgICAgICAgICAgICAgICAgc3RhcnQsCiAgICAgICAgICAgICAgICAgIGVuZCwKICAgICAgICAgICAgICAgICAgY29ybmVyVHlwZSwKICAgICAgICAgICAgICAgICAgbGVmdElzT3V0c2lkZSwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICAgIGR1cGxpY2F0ZVBvaW50cwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjb3JuZXJEaXJlY3Rpb24sIGNvcm5lckRpcmVjdGlvbik7CiAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9uKAogICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgICAgc2NhbGFyLAogICAgICAgICAgICAgICAgICByZXBlYXQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5kLCBwcmV2aW91c1Bvc2l0aW9uKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwaXZvdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgICAgIHNjYWxhciAqIHdpZHRoLAogICAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBwaXZvdAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc3RhcnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcGl2b3QsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCAtd2lkdGgsIHN0YXJ0KSwKICAgICAgICAgICAgICAgIHN0YXJ0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzY3JhdGNoMkFycmF5WzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zaXRpb24sIHNjcmF0Y2gyQXJyYXlbMF0pOwogICAgICAgICAgICAgIHNjcmF0Y2gyQXJyYXlbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoc3RhcnQsIHNjcmF0Y2gyQXJyYXlbMV0pOwogICAgICAgICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzID0gc3ViZGl2aWRlSGVpZ2h0czIoCiAgICAgICAgICAgICAgICBzY3JhdGNoMkFycmF5LAogICAgICAgICAgICAgICAgaDAgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uczogc2NyYXRjaDJBcnJheSwKICAgICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzLAogICAgICAgICAgICAgICAgMQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhzdXJmYWNlTm9ybWFsLCBmb3J3YXJkLCBsZWZ0KTsKICAgICAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShsZWZ0LCBsZWZ0KTsKICAgICAgICAgICAgICBlbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcGl2b3QsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCAtd2lkdGgsIGVuZCksCiAgICAgICAgICAgICAgICBlbmQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCB8fCBjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgICAgICAgY29tcHV0ZVJvdW5kQ29ybmVyKAogICAgICAgICAgICAgICAgICBwaXZvdCwKICAgICAgICAgICAgICAgICAgc3RhcnQsCiAgICAgICAgICAgICAgICAgIGVuZCwKICAgICAgICAgICAgICAgICAgY29ybmVyVHlwZSwKICAgICAgICAgICAgICAgICAgbGVmdElzT3V0c2lkZSwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICAgIGR1cGxpY2F0ZVBvaW50cwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbigKICAgICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICAgIHNjYWxhciwKICAgICAgICAgICAgICAgICAgcmVwZWF0CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVuZCwgcHJldmlvdXNQb3NpdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYmFja3dhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGZvcndhcmQsIGJhY2t3YXJkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgICAgICAgcHJldmlvdXNQb3NpdGlvbiwKICAgICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIGgwICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgMQogICAgICAgICAgICApOwogICAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uID0gcG9zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBoMCA9IGgxOwogICAgICAgICAgaDEgPSBoZWlnaHRzW2kgKyAxXTsKICAgICAgICAgIHBvc2l0aW9uID0gbmV4dFBvc2l0aW9uOwogICAgICAgIH0KICAgICAgICBzY3JhdGNoMkFycmF5WzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zaXRpb24sIHNjcmF0Y2gyQXJyYXlbMF0pOwogICAgICAgIHNjcmF0Y2gyQXJyYXlbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHNjcmF0Y2gyQXJyYXlbMV0pOwogICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzID0gc3ViZGl2aWRlSGVpZ2h0czIoCiAgICAgICAgICBzY3JhdGNoMkFycmF5LAogICAgICAgICAgaDAgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgKTsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKHsKICAgICAgICAgIHBvc2l0aW9uczogc2NyYXRjaDJBcnJheSwKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgfSk7CiAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbnMoCiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgbGVmdCwKICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzLAogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgaWYgKGR1cGxpY2F0ZVBvaW50cykgewogICAgICAgICAgZW5kcyA9IGFkZFBvc2l0aW9uKAogICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgc2hhcGVGb3JFbmRzLAogICAgICAgICAgICBlbmRzLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGgxICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAxLAogICAgICAgICAgICAxCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBmaW5hbFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgcG9zTGVuZ3RoID0gZHVwbGljYXRlUG9pbnRzID8gbGVuZ3RoICsgZW5kcy5sZW5ndGggOiBsZW5ndGg7CiAgICAgICAgY29uc3QgY29tYmluZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHBvc0xlbmd0aCk7CiAgICAgICAgY29tYmluZWRQb3NpdGlvbnMuc2V0KGZpbmFsUG9zaXRpb25zKTsKICAgICAgICBpZiAoZHVwbGljYXRlUG9pbnRzKSB7CiAgICAgICAgICBjb21iaW5lZFBvc2l0aW9ucy5zZXQoZW5kcywgbGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbWJpbmVkUG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvckdlb21ldHJ5TGlicmFyeS5qcwogIGZ1bmN0aW9uIGNvbXB1dGVSb3VuZENvcm5lcjIoY29ybmVyUG9pbnQsIHN0YXJ0UG9pbnQsIGVuZFBvaW50LCBjb3JuZXJUeXBlLCBsZWZ0SXNPdXRzaWRlKSB7CiAgICBjb25zdCBhbmdsZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5hbmdsZUJldHdlZW4oCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzdGFydFBvaW50LCBjb3JuZXJQb2ludCwgc2NyYXRjaDEyKSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGVuZFBvaW50LCBjb3JuZXJQb2ludCwgc2NyYXRjaDIyKQogICAgKTsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQgPyAxIDogTWF0aC5jZWlsKGFuZ2xlIC8gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyg1KSkgKyAxOwogICAgY29uc3Qgc2l6ZSA9IGdyYW51bGFyaXR5ICogMzsKICAgIGNvbnN0IGFycmF5ID0gbmV3IEFycmF5KHNpemUpOwogICAgYXJyYXlbc2l6ZSAtIDNdID0gZW5kUG9pbnQueDsKICAgIGFycmF5W3NpemUgLSAyXSA9IGVuZFBvaW50Lnk7CiAgICBhcnJheVtzaXplIC0gMV0gPSBlbmRQb2ludC56OwogICAgbGV0IG07CiAgICBpZiAobGVmdElzT3V0c2lkZSkgewogICAgICBtID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjb3JuZXJQb2ludCwgc2NyYXRjaDEyKSwKICAgICAgICAgIGFuZ2xlIC8gZ3JhbnVsYXJpdHksCiAgICAgICAgICBxdWF0ZXJpb24yCiAgICAgICAgKSwKICAgICAgICByb3RNYXRyaXgyCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICBtID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKGNvcm5lclBvaW50LCBhbmdsZSAvIGdyYW51bGFyaXR5LCBxdWF0ZXJpb24yKSwKICAgICAgICByb3RNYXRyaXgyCiAgICAgICk7CiAgICB9CiAgICBsZXQgaW5kZXggPSAwOwogICAgc3RhcnRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzdGFydFBvaW50LCBzY3JhdGNoMTIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncmFudWxhcml0eTsgaSsrKSB7CiAgICAgIHN0YXJ0UG9pbnQgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihtLCBzdGFydFBvaW50LCBzdGFydFBvaW50KTsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBzdGFydFBvaW50Lng7CiAgICAgIGFycmF5W2luZGV4KytdID0gc3RhcnRQb2ludC55OwogICAgICBhcnJheVtpbmRleCsrXSA9IHN0YXJ0UG9pbnQuejsKICAgIH0KICAgIHJldHVybiBhcnJheTsKICB9CiAgZnVuY3Rpb24gYWRkRW5kQ2FwcyhjYWxjdWxhdGVkUG9zaXRpb25zKSB7CiAgICBsZXQgY29ybmVyUG9pbnQgPSBjYXJ0ZXNpYW4xOwogICAgbGV0IHN0YXJ0UG9pbnQgPSBjYXJ0ZXNpYW4yOwogICAgbGV0IGVuZFBvaW50ID0gY2FydGVzaWFuMzsKICAgIGxldCBsZWZ0RWRnZSA9IGNhbGN1bGF0ZWRQb3NpdGlvbnNbMV07CiAgICBzdGFydFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgY2FsY3VsYXRlZFBvc2l0aW9uc1sxXSwKICAgICAgbGVmdEVkZ2UubGVuZ3RoIC0gMywKICAgICAgc3RhcnRQb2ludAogICAgKTsKICAgIGVuZFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjYWxjdWxhdGVkUG9zaXRpb25zWzBdLCAwLCBlbmRQb2ludCk7CiAgICBjb3JuZXJQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludChzdGFydFBvaW50LCBlbmRQb2ludCwgY29ybmVyUG9pbnQpOwogICAgY29uc3QgZmlyc3RFbmRDYXAgPSBjb21wdXRlUm91bmRDb3JuZXIyKAogICAgICBjb3JuZXJQb2ludCwKICAgICAgc3RhcnRQb2ludCwKICAgICAgZW5kUG9pbnQsCiAgICAgIENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVELAogICAgICBmYWxzZQogICAgKTsKICAgIGNvbnN0IGxlbmd0aCA9IGNhbGN1bGF0ZWRQb3NpdGlvbnMubGVuZ3RoIC0gMTsKICAgIGNvbnN0IHJpZ2h0RWRnZSA9IGNhbGN1bGF0ZWRQb3NpdGlvbnNbbGVuZ3RoIC0gMV07CiAgICBsZWZ0RWRnZSA9IGNhbGN1bGF0ZWRQb3NpdGlvbnNbbGVuZ3RoXTsKICAgIHN0YXJ0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICByaWdodEVkZ2UsCiAgICAgIHJpZ2h0RWRnZS5sZW5ndGggLSAzLAogICAgICBzdGFydFBvaW50CiAgICApOwogICAgZW5kUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxlZnRFZGdlLCAwLCBlbmRQb2ludCk7CiAgICBjb3JuZXJQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludChzdGFydFBvaW50LCBlbmRQb2ludCwgY29ybmVyUG9pbnQpOwogICAgY29uc3QgbGFzdEVuZENhcCA9IGNvbXB1dGVSb3VuZENvcm5lcjIoCiAgICAgIGNvcm5lclBvaW50LAogICAgICBzdGFydFBvaW50LAogICAgICBlbmRQb2ludCwKICAgICAgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQsCiAgICAgIGZhbHNlCiAgICApOwogICAgcmV0dXJuIFtmaXJzdEVuZENhcCwgbGFzdEVuZENhcF07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVNaXRlcmVkQ29ybmVyKHBvc2l0aW9uLCBsZWZ0Q29ybmVyRGlyZWN0aW9uLCBsYXN0UG9pbnQsIGxlZnRJc091dHNpZGUpIHsKICAgIGxldCBjb3JuZXJQb2ludCA9IHNjcmF0Y2gxMjsKICAgIGlmIChsZWZ0SXNPdXRzaWRlKSB7CiAgICAgIGNvcm5lclBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgbGVmdENvcm5lckRpcmVjdGlvbiwgY29ybmVyUG9pbnQpOwogICAgfSBlbHNlIHsKICAgICAgbGVmdENvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgbGVmdENvcm5lckRpcmVjdGlvbiwKICAgICAgICBsZWZ0Q29ybmVyRGlyZWN0aW9uCiAgICAgICk7CiAgICAgIGNvcm5lclBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgbGVmdENvcm5lckRpcmVjdGlvbiwgY29ybmVyUG9pbnQpOwogICAgfQogICAgcmV0dXJuIFsKICAgICAgY29ybmVyUG9pbnQueCwKICAgICAgY29ybmVyUG9pbnQueSwKICAgICAgY29ybmVyUG9pbnQueiwKICAgICAgbGFzdFBvaW50LngsCiAgICAgIGxhc3RQb2ludC55LAogICAgICBsYXN0UG9pbnQuegogICAgXTsKICB9CiAgZnVuY3Rpb24gYWRkU2hpZnRlZFBvc2l0aW9ucyhwb3NpdGlvbnMsIGxlZnQsIHNjYWxhciwgY2FsY3VsYXRlZFBvc2l0aW9ucykgewogICAgY29uc3QgcmlnaHRQb3NpdGlvbnMgPSBuZXcgQXJyYXkocG9zaXRpb25zLmxlbmd0aCk7CiAgICBjb25zdCBsZWZ0UG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9ucy5sZW5ndGgpOwogICAgY29uc3Qgc2NhbGVkTGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHNjYWxhciwgc2NyYXRjaDEyKTsKICAgIGNvbnN0IHNjYWxlZFJpZ2h0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShzY2FsZWRMZWZ0LCBzY3JhdGNoMjIpOwogICAgbGV0IHJpZ2h0SW5kZXggPSAwOwogICAgbGV0IGxlZnRJbmRleCA9IHBvc2l0aW9ucy5sZW5ndGggLSAxOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgcG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHNjcmF0Y2gzKTsKICAgICAgY29uc3QgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvcywgc2NhbGVkUmlnaHQsIHNjcmF0Y2g0KTsKICAgICAgcmlnaHRQb3NpdGlvbnNbcmlnaHRJbmRleCsrXSA9IHJpZ2h0UG9zLng7CiAgICAgIHJpZ2h0UG9zaXRpb25zW3JpZ2h0SW5kZXgrK10gPSByaWdodFBvcy55OwogICAgICByaWdodFBvc2l0aW9uc1tyaWdodEluZGV4KytdID0gcmlnaHRQb3MuejsKICAgICAgY29uc3QgbGVmdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zLCBzY2FsZWRMZWZ0LCBzY3JhdGNoNCk7CiAgICAgIGxlZnRQb3NpdGlvbnNbbGVmdEluZGV4LS1dID0gbGVmdFBvcy56OwogICAgICBsZWZ0UG9zaXRpb25zW2xlZnRJbmRleC0tXSA9IGxlZnRQb3MueTsKICAgICAgbGVmdFBvc2l0aW9uc1tsZWZ0SW5kZXgtLV0gPSBsZWZ0UG9zLng7CiAgICB9CiAgICBjYWxjdWxhdGVkUG9zaXRpb25zLnB1c2gocmlnaHRQb3NpdGlvbnMsIGxlZnRQb3NpdGlvbnMpOwogICAgcmV0dXJuIGNhbGN1bGF0ZWRQb3NpdGlvbnM7CiAgfQogIHZhciBDb3JyaWRvckdlb21ldHJ5TGlicmFyeSwgc2NyYXRjaDEyLCBzY3JhdGNoMjIsIHNjcmF0Y2gzLCBzY3JhdGNoNCwgc2NhbGVBcnJheTIsIGNhcnRlc2lhbjEsIGNhcnRlc2lhbjIsIGNhcnRlc2lhbjMsIGNhcnRlc2lhbjQsIGNhcnRlc2lhbjUsIGNhcnRlc2lhbjYsIGNhcnRlc2lhbjcsIGNhcnRlc2lhbjgsIGNhcnRlc2lhbjksIGNhcnRlc2lhbjEwLCBxdWF0ZXJpb24yLCByb3RNYXRyaXgyLCBzY3JhdGNoRm9yd2FyZFByb2plY3Rpb24yLCBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uMiwgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3JyaWRvckdlb21ldHJ5TGlicmFyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db3JuZXJUeXBlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUG9seWxpbmVQaXBlbGluZSgpOwogICAgICBpbml0X1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBzY3JhdGNoMTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2gyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2g0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZUFycmF5MiA9IFtuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKV07CiAgICAgIGNhcnRlc2lhbjEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjEwID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBxdWF0ZXJpb24yID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICByb3RNYXRyaXgyID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeS5hZGRBdHRyaWJ1dGUgPSBmdW5jdGlvbihhdHRyaWJ1dGUsIHZhbHVlLCBmcm9udCwgYmFjaykgewogICAgICAgIGNvbnN0IHggPSB2YWx1ZS54OwogICAgICAgIGNvbnN0IHkgPSB2YWx1ZS55OwogICAgICAgIGNvbnN0IHogPSB2YWx1ZS56OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZnJvbnQpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVbZnJvbnRdID0geDsKICAgICAgICAgIGF0dHJpYnV0ZVtmcm9udCArIDFdID0geTsKICAgICAgICAgIGF0dHJpYnV0ZVtmcm9udCArIDJdID0gejsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChiYWNrKSkgewogICAgICAgICAgYXR0cmlidXRlW2JhY2tdID0gejsKICAgICAgICAgIGF0dHJpYnV0ZVtiYWNrIC0gMV0gPSB5OwogICAgICAgICAgYXR0cmlidXRlW2JhY2sgLSAyXSA9IHg7CiAgICAgICAgfQogICAgICB9OwogICAgICBzY3JhdGNoRm9yd2FyZFByb2plY3Rpb24yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVBvc2l0aW9ucyA9IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcGFyYW1zLmdyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBhcmFtcy5wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcGFyYW1zLmVsbGlwc29pZDsKICAgICAgICBjb25zdCB3aWR0aCA9IHBhcmFtcy53aWR0aCAvIDI7CiAgICAgICAgY29uc3QgY29ybmVyVHlwZSA9IHBhcmFtcy5jb3JuZXJUeXBlOwogICAgICAgIGNvbnN0IHNhdmVBdHRyaWJ1dGVzID0gcGFyYW1zLnNhdmVBdHRyaWJ1dGVzOwogICAgICAgIGxldCBub3JtYWwyID0gY2FydGVzaWFuMTsKICAgICAgICBsZXQgZm9yd2FyZCA9IGNhcnRlc2lhbjI7CiAgICAgICAgbGV0IGJhY2t3YXJkID0gY2FydGVzaWFuMzsKICAgICAgICBsZXQgbGVmdCA9IGNhcnRlc2lhbjQ7CiAgICAgICAgbGV0IGNvcm5lckRpcmVjdGlvbiA9IGNhcnRlc2lhbjU7CiAgICAgICAgbGV0IHN0YXJ0UG9pbnQgPSBjYXJ0ZXNpYW42OwogICAgICAgIGxldCBwcmV2aW91c1BvcyA9IGNhcnRlc2lhbjc7CiAgICAgICAgbGV0IHJpZ2h0UG9zID0gY2FydGVzaWFuODsKICAgICAgICBsZXQgbGVmdFBvcyA9IGNhcnRlc2lhbjk7CiAgICAgICAgbGV0IGNlbnRlciA9IGNhcnRlc2lhbjEwOwogICAgICAgIGxldCBjYWxjdWxhdGVkUG9zaXRpb25zID0gW107CiAgICAgICAgY29uc3QgY2FsY3VsYXRlZExlZnRzID0gc2F2ZUF0dHJpYnV0ZXMgPyBbXSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBjYWxjdWxhdGVkTm9ybWFscyA9IHNhdmVBdHRyaWJ1dGVzID8gW10gOiB2b2lkIDA7CiAgICAgICAgbGV0IHBvc2l0aW9uID0gcG9zaXRpb25zWzBdOwogICAgICAgIGxldCBuZXh0UG9zaXRpb24gPSBwb3NpdGlvbnNbMV07CiAgICAgICAgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobmV4dFBvc2l0aW9uLCBwb3NpdGlvbiwgZm9yd2FyZCksCiAgICAgICAgICBmb3J3YXJkCiAgICAgICAgKTsKICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIGZvcndhcmQsIGxlZnQpLCBsZWZ0KTsKICAgICAgICBpZiAoc2F2ZUF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGNhbGN1bGF0ZWRMZWZ0cy5wdXNoKGxlZnQueCwgbGVmdC55LCBsZWZ0LnopOwogICAgICAgICAgY2FsY3VsYXRlZE5vcm1hbHMucHVzaChub3JtYWwyLngsIG5vcm1hbDIueSwgbm9ybWFsMi56KTsKICAgICAgICB9CiAgICAgICAgcHJldmlvdXNQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHByZXZpb3VzUG9zKTsKICAgICAgICBwb3NpdGlvbiA9IG5leHRQb3NpdGlvbjsKICAgICAgICBiYWNrd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZm9yd2FyZCwgYmFja3dhcmQpOwogICAgICAgIGxldCBzdWJkaXZpZGVkUG9zaXRpb25zOwogICAgICAgIGNvbnN0IGNvcm5lcnMgPSBbXTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICAgIG5leHRQb3NpdGlvbiA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHRQb3NpdGlvbiwgcG9zaXRpb24sIGZvcndhcmQpLAogICAgICAgICAgICBmb3J3YXJkCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgZm9yd2FyZFByb2plY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRvdChmb3J3YXJkLCBub3JtYWwyKSwKICAgICAgICAgICAgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uMgogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChmb3J3YXJkLCBmb3J3YXJkUHJvamVjdGlvbiwgZm9yd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShmb3J3YXJkUHJvamVjdGlvbiwgZm9yd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgY29uc3QgYmFja3dhcmRQcm9qZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoYmFja3dhcmQsIG5vcm1hbDIpLAogICAgICAgICAgICBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uMgogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChiYWNrd2FyZCwgYmFja3dhcmRQcm9qZWN0aW9uLCBiYWNrd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShiYWNrd2FyZFByb2plY3Rpb24sIGJhY2t3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBjb25zdCBkb0Nvcm5lciA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgICAgTWF0aC5hYnMoQ2FydGVzaWFuM19kZWZhdWx0LmRvdChmb3J3YXJkUHJvamVjdGlvbiwgYmFja3dhcmRQcm9qZWN0aW9uKSksCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONwogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkb0Nvcm5lcikgewogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZm9yd2FyZCwgYmFja3dhcmQsIGNvcm5lckRpcmVjdGlvbiksCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNvcm5lckRpcmVjdGlvbiwgY29ybmVyRGlyZWN0aW9uKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGFyID0gd2lkdGggLyBNYXRoLm1heCgKICAgICAgICAgICAgICAwLjI1LAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoY29ybmVyRGlyZWN0aW9uLCBiYWNrd2FyZCwgc2NyYXRjaDEyKQogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgbGVmdElzT3V0c2lkZSA9IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYW5nbGVJc0dyZWF0ZXJUaGFuUGkoCiAgICAgICAgICAgICAgZm9yd2FyZCwKICAgICAgICAgICAgICBiYWNrd2FyZCwKICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgIHNjYWxhciwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGxlZnRJc091dHNpZGUpIHsKICAgICAgICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGNvcm5lckRpcmVjdGlvbiwgcmlnaHRQb3MpOwogICAgICAgICAgICAgIGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICByaWdodFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoLCBjZW50ZXIpLAogICAgICAgICAgICAgICAgY2VudGVyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHJpZ2h0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGggKiAyLCBsZWZ0UG9zKSwKICAgICAgICAgICAgICAgIGxlZnRQb3MKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHNjYWxlQXJyYXkyWzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zLCBzY2FsZUFycmF5MlswXSk7CiAgICAgICAgICAgICAgc2NhbGVBcnJheTJbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCBzY2FsZUFycmF5MlsxXSk7CiAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyh7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnM6IHNjYWxlQXJyYXkyLAogICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBjYWxjdWxhdGVkUG9zaXRpb25zID0gYWRkU2hpZnRlZFBvc2l0aW9ucygKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgICAgICBjYWxjdWxhdGVkUG9zaXRpb25zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoc2F2ZUF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWRMZWZ0cy5wdXNoKGxlZnQueCwgbGVmdC55LCBsZWZ0LnopOwogICAgICAgICAgICAgICAgY2FsY3VsYXRlZE5vcm1hbHMucHVzaChub3JtYWwyLngsIG5vcm1hbDIueSwgbm9ybWFsMi56KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhcnRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShsZWZ0UG9zLCBzdGFydFBvaW50KTsKICAgICAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCBmb3J3YXJkLCBsZWZ0KSwKICAgICAgICAgICAgICAgIGxlZnQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCAqIDIsIGxlZnRQb3MpLAogICAgICAgICAgICAgICAgbGVmdFBvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcHJldmlvdXNQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCwgcHJldmlvdXNQb3MpLAogICAgICAgICAgICAgICAgcHJldmlvdXNQb3MKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCB8fCBjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgICAgICAgY29ybmVycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgbGVmdFBvc2l0aW9uczogY29tcHV0ZVJvdW5kQ29ybmVyMigKICAgICAgICAgICAgICAgICAgICByaWdodFBvcywKICAgICAgICAgICAgICAgICAgICBzdGFydFBvaW50LAogICAgICAgICAgICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICAgICAgICAgICAgY29ybmVyVHlwZSwKICAgICAgICAgICAgICAgICAgICBsZWZ0SXNPdXRzaWRlCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb3JuZXJzLnB1c2goewogICAgICAgICAgICAgICAgICBsZWZ0UG9zaXRpb25zOiBjb21wdXRlTWl0ZXJlZENvcm5lcigKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGNvcm5lckRpcmVjdGlvbiwgY29ybmVyRGlyZWN0aW9uKSwKICAgICAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgICAgIGxlZnRJc091dHNpZGUKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBjb3JuZXJEaXJlY3Rpb24sIGxlZnRQb3MpOwogICAgICAgICAgICAgIGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGgsIGNlbnRlciksCiAgICAgICAgICAgICAgICAgIGNlbnRlcgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIGNlbnRlcgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgbGVmdFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoICogMiwgcmlnaHRQb3MpLAogICAgICAgICAgICAgICAgICByaWdodFBvcwogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHJpZ2h0UG9zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzY2FsZUFycmF5MlswXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwcmV2aW91c1Bvcywgc2NhbGVBcnJheTJbMF0pOwogICAgICAgICAgICAgIHNjYWxlQXJyYXkyWzFdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgc2NhbGVBcnJheTJbMV0pOwogICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoewogICAgICAgICAgICAgICAgcG9zaXRpb25zOiBzY2FsZUFycmF5MiwKICAgICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgY2FsY3VsYXRlZFBvc2l0aW9ucyA9IGFkZFNoaWZ0ZWRQb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgICAgIHdpZHRoLAogICAgICAgICAgICAgICAgY2FsY3VsYXRlZFBvc2l0aW9ucwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHNhdmVBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICBjYWxjdWxhdGVkTGVmdHMucHVzaChsZWZ0LngsIGxlZnQueSwgbGVmdC56KTsKICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWROb3JtYWxzLnB1c2gobm9ybWFsMi54LCBub3JtYWwyLnksIG5vcm1hbDIueik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN0YXJ0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmlnaHRQb3MsIHN0YXJ0UG9pbnQpOwogICAgICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIGZvcndhcmQsIGxlZnQpLAogICAgICAgICAgICAgICAgbGVmdAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgbGVmdFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoICogMiwgcmlnaHRQb3MpLAogICAgICAgICAgICAgICAgICByaWdodFBvcwogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHJpZ2h0UG9zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBwcmV2aW91c1BvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGgsIHByZXZpb3VzUG9zKSwKICAgICAgICAgICAgICAgICAgcHJldmlvdXNQb3MKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBwcmV2aW91c1BvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEIHx8IGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEKSB7CiAgICAgICAgICAgICAgICBjb3JuZXJzLnB1c2goewogICAgICAgICAgICAgICAgICByaWdodFBvc2l0aW9uczogY29tcHV0ZVJvdW5kQ29ybmVyMigKICAgICAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0UG9pbnQsCiAgICAgICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICAgICAgY29ybmVyVHlwZSwKICAgICAgICAgICAgICAgICAgICBsZWZ0SXNPdXRzaWRlCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb3JuZXJzLnB1c2goewogICAgICAgICAgICAgICAgICByaWdodFBvc2l0aW9uczogY29tcHV0ZU1pdGVyZWRDb3JuZXIoCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0UG9zLAogICAgICAgICAgICAgICAgICAgIGxlZnRJc091dHNpZGUKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJhY2t3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShmb3J3YXJkLCBiYWNrd2FyZCk7CiAgICAgICAgICB9CiAgICAgICAgICBwb3NpdGlvbiA9IG5leHRQb3NpdGlvbjsKICAgICAgICB9CiAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIHNjYWxlQXJyYXkyWzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zLCBzY2FsZUFycmF5MlswXSk7CiAgICAgICAgc2NhbGVBcnJheTJbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHNjYWxlQXJyYXkyWzFdKTsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKHsKICAgICAgICAgIHBvc2l0aW9uczogc2NhbGVBcnJheTIsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGVsbGlwc29pZAogICAgICAgIH0pOwogICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnMgPSBhZGRTaGlmdGVkUG9zaXRpb25zKAogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgIGxlZnQsCiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIGlmIChzYXZlQXR0cmlidXRlcykgewogICAgICAgICAgY2FsY3VsYXRlZExlZnRzLnB1c2gobGVmdC54LCBsZWZ0LnksIGxlZnQueik7CiAgICAgICAgICBjYWxjdWxhdGVkTm9ybWFscy5wdXNoKG5vcm1hbDIueCwgbm9ybWFsMi55LCBub3JtYWwyLnopOwogICAgICAgIH0KICAgICAgICBsZXQgZW5kUG9zaXRpb25zOwogICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCkgewogICAgICAgICAgZW5kUG9zaXRpb25zID0gYWRkRW5kQ2FwcyhjYWxjdWxhdGVkUG9zaXRpb25zKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHBvc2l0aW9uczogY2FsY3VsYXRlZFBvc2l0aW9ucywKICAgICAgICAgIGNvcm5lcnMsCiAgICAgICAgICBsZWZ0czogY2FsY3VsYXRlZExlZnRzLAogICAgICAgICAgbm9ybWFsczogY2FsY3VsYXRlZE5vcm1hbHMsCiAgICAgICAgICBlbmRQb3NpdGlvbnMKICAgICAgICB9OwogICAgICB9OwogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvckdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gc2NhbGVUb1N1cmZhY2UyKHBvc2l0aW9ucywgZWxsaXBzb2lkKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICBwb3NpdGlvbnNbaV0gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbnNbaV0sIHBvc2l0aW9uc1tpXSk7CiAgICB9CiAgICByZXR1cm4gcG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpIHsKICAgIGNvbnN0IG5vcm1hbHMgPSBhdHRyLm5vcm1hbHM7CiAgICBjb25zdCB0YW5nZW50cyA9IGF0dHIudGFuZ2VudHM7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gYXR0ci5iaXRhbmdlbnRzOwogICAgY29uc3QgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhsZWZ0LCBub3JtYWwyLCBzY3JhdGNoMTMpLAogICAgICBzY3JhdGNoMTMKICAgICk7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShub3JtYWxzLCBub3JtYWwyLCBmcm9udCwgYmFjayk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUodGFuZ2VudHMsIGZvcndhcmQsIGZyb250LCBiYWNrKTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKGJpdGFuZ2VudHMsIGxlZnQsIGZyb250LCBiYWNrKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gY29tYmluZTIoY29tcHV0ZWRQb3NpdGlvbnMsIHZlcnRleEZvcm1hdCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBjb21wdXRlZFBvc2l0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCBjb3JuZXJzID0gY29tcHV0ZWRQb3NpdGlvbnMuY29ybmVyczsKICAgIGNvbnN0IGVuZFBvc2l0aW9ucyA9IGNvbXB1dGVkUG9zaXRpb25zLmVuZFBvc2l0aW9uczsKICAgIGNvbnN0IGNvbXB1dGVkTGVmdHMgPSBjb21wdXRlZFBvc2l0aW9ucy5sZWZ0czsKICAgIGNvbnN0IGNvbXB1dGVkTm9ybWFscyA9IGNvbXB1dGVkUG9zaXRpb25zLm5vcm1hbHM7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBsZXQgY29ybmVyOwogICAgbGV0IGxlZnRDb3VudCA9IDA7CiAgICBsZXQgcmlnaHRDb3VudCA9IDA7CiAgICBsZXQgaTsKICAgIGxldCBpbmRpY2VzTGVuZ3RoID0gMDsKICAgIGxldCBsZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgIGxlbmd0aCA9IHBvc2l0aW9uc1tpXS5sZW5ndGggLSAzOwogICAgICBsZWZ0Q291bnQgKz0gbGVuZ3RoOwogICAgICBpbmRpY2VzTGVuZ3RoICs9IGxlbmd0aCAqIDI7CiAgICAgIHJpZ2h0Q291bnQgKz0gcG9zaXRpb25zW2kgKyAxXS5sZW5ndGggLSAzOwogICAgfQogICAgbGVmdENvdW50ICs9IDM7CiAgICByaWdodENvdW50ICs9IDM7CiAgICBmb3IgKGkgPSAwOyBpIDwgY29ybmVycy5sZW5ndGg7IGkrKykgewogICAgICBjb3JuZXIgPSBjb3JuZXJzW2ldOwogICAgICBjb25zdCBsZWZ0U2lkZSA9IGNvcm5lcnNbaV0ubGVmdFBvc2l0aW9uczsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChsZWZ0U2lkZSkpIHsKICAgICAgICBsZW5ndGggPSBsZWZ0U2lkZS5sZW5ndGg7CiAgICAgICAgbGVmdENvdW50ICs9IGxlbmd0aDsKICAgICAgICBpbmRpY2VzTGVuZ3RoICs9IGxlbmd0aDsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZW5ndGggPSBjb3JuZXJzW2ldLnJpZ2h0UG9zaXRpb25zLmxlbmd0aDsKICAgICAgICByaWdodENvdW50ICs9IGxlbmd0aDsKICAgICAgICBpbmRpY2VzTGVuZ3RoICs9IGxlbmd0aDsKICAgICAgfQogICAgfQogICAgY29uc3QgYWRkRW5kUG9zaXRpb25zID0gZGVmaW5lZF9kZWZhdWx0KGVuZFBvc2l0aW9ucyk7CiAgICBsZXQgZW5kUG9zaXRpb25MZW5ndGg7CiAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgIGVuZFBvc2l0aW9uTGVuZ3RoID0gZW5kUG9zaXRpb25zWzBdLmxlbmd0aCAtIDM7CiAgICAgIGxlZnRDb3VudCArPSBlbmRQb3NpdGlvbkxlbmd0aDsKICAgICAgcmlnaHRDb3VudCArPSBlbmRQb3NpdGlvbkxlbmd0aDsKICAgICAgZW5kUG9zaXRpb25MZW5ndGggLz0gMzsKICAgICAgaW5kaWNlc0xlbmd0aCArPSBlbmRQb3NpdGlvbkxlbmd0aCAqIDY7CiAgICB9CiAgICBjb25zdCBzaXplID0gbGVmdENvdW50ICsgcmlnaHRDb3VudDsKICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplKTsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUpIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUpIDogdm9pZCAwOwogICAgY29uc3QgYXR0ciA9IHsKICAgICAgbm9ybWFscywKICAgICAgdGFuZ2VudHMsCiAgICAgIGJpdGFuZ2VudHMKICAgIH07CiAgICBsZXQgZnJvbnQgPSAwOwogICAgbGV0IGJhY2sgPSBzaXplIC0gMTsKICAgIGxldCBVTCwgTEwsIFVSLCBMUjsKICAgIGxldCBub3JtYWwyID0gY2FydGVzaWFuMTI7CiAgICBsZXQgbGVmdCA9IGNhcnRlc2lhbjIyOwogICAgbGV0IHJpZ2h0UG9zLCBsZWZ0UG9zOwogICAgY29uc3QgaGFsZkxlbmd0aCA9IGVuZFBvc2l0aW9uTGVuZ3RoIC8gMjsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShzaXplIC8gMywgaW5kaWNlc0xlbmd0aCk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgaWYgKGFkZEVuZFBvc2l0aW9ucykgewogICAgICBsZWZ0UG9zID0gY2FydGVzaWFuMzI7CiAgICAgIHJpZ2h0UG9zID0gY2FydGVzaWFuNDI7CiAgICAgIGNvbnN0IGZpcnN0RW5kUG9zaXRpb25zID0gZW5kUG9zaXRpb25zWzBdOwogICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZE5vcm1hbHMsIDAsIG5vcm1hbDIpOwogICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZExlZnRzLCAwLCBsZWZ0KTsKICAgICAgZm9yIChpID0gMDsgaSA8IGhhbGZMZW5ndGg7IGkrKykgewogICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmlyc3RFbmRQb3NpdGlvbnMsCiAgICAgICAgICAoaGFsZkxlbmd0aCAtIDEgLSBpKSAqIDMsCiAgICAgICAgICBsZWZ0UG9zCiAgICAgICAgKTsKICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmaXJzdEVuZFBvc2l0aW9ucywKICAgICAgICAgIChoYWxmTGVuZ3RoICsgaSkgKiAzLAogICAgICAgICAgcmlnaHRQb3MKICAgICAgICApOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKGZpbmFsUG9zaXRpb25zLCByaWdodFBvcywgZnJvbnQpOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgYmFjawogICAgICAgICk7CiAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICBMTCA9IGZyb250IC8gMzsKICAgICAgICBMUiA9IExMICsgMTsKICAgICAgICBVTCA9IChiYWNrIC0gMikgLyAzOwogICAgICAgIFVSID0gVUwgLSAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICB9CiAgICBsZXQgcG9zSW5kZXggPSAwOwogICAgbGV0IGNvbXBJbmRleCA9IDA7CiAgICBsZXQgcmlnaHRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgbGV0IGxlZnRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgZmluYWxQb3NpdGlvbnMuc2V0KHJpZ2h0RWRnZSwgZnJvbnQpOwogICAgZmluYWxQb3NpdGlvbnMuc2V0KGxlZnRFZGdlLCBiYWNrIC0gbGVmdEVkZ2UubGVuZ3RoICsgMSk7CiAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZExlZnRzLCBjb21wSW5kZXgsIGxlZnQpOwogICAgbGV0IHJpZ2h0Tm9ybWFsOwogICAgbGV0IGxlZnROb3JtYWw7CiAgICBsZW5ndGggPSBsZWZ0RWRnZS5sZW5ndGggLSAzOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgIHJpZ2h0Tm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHJpZ2h0RWRnZSwgaSwgc2NyYXRjaDEzKSwKICAgICAgICBzY3JhdGNoMTMKICAgICAgKTsKICAgICAgbGVmdE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsZWZ0RWRnZSwgbGVuZ3RoIC0gaSwgc2NyYXRjaDIzKSwKICAgICAgICBzY3JhdGNoMjMKICAgICAgKTsKICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyaWdodE5vcm1hbCwgbGVmdE5vcm1hbCwgbm9ybWFsMiksCiAgICAgICAgbm9ybWFsMgogICAgICApOwogICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICBMTCA9IGZyb250IC8gMzsKICAgICAgTFIgPSBMTCArIDE7CiAgICAgIFVMID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgIFVSID0gVUwgLSAxOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICBmcm9udCArPSAzOwogICAgICBiYWNrIC09IDM7CiAgICB9CiAgICByaWdodE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocmlnaHRFZGdlLCBsZW5ndGgsIHNjcmF0Y2gxMyksCiAgICAgIHNjcmF0Y2gxMwogICAgKTsKICAgIGxlZnROb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxlZnRFZGdlLCBsZW5ndGgsIHNjcmF0Y2gyMyksCiAgICAgIHNjcmF0Y2gyMwogICAgKTsKICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJpZ2h0Tm9ybWFsLCBsZWZ0Tm9ybWFsLCBub3JtYWwyKSwKICAgICAgbm9ybWFsMgogICAgKTsKICAgIGNvbXBJbmRleCArPSAzOwogICAgZm9yIChpID0gMDsgaSA8IGNvcm5lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IGo7CiAgICAgIGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgIGNvbnN0IGwgPSBjb3JuZXIubGVmdFBvc2l0aW9uczsKICAgICAgY29uc3QgciA9IGNvcm5lci5yaWdodFBvc2l0aW9uczsKICAgICAgbGV0IHBpdm90OwogICAgICBsZXQgc3RhcnQ7CiAgICAgIGxldCBvdXRzaWRlUG9pbnQgPSBjYXJ0ZXNpYW42MjsKICAgICAgbGV0IHByZXZpb3VzUG9pbnQgPSBjYXJ0ZXNpYW4zMjsKICAgICAgbGV0IG5leHRQb2ludCA9IGNhcnRlc2lhbjQyOwogICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZE5vcm1hbHMsIGNvbXBJbmRleCwgbm9ybWFsMik7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobCkpIHsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIHZvaWQgMCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICBiYWNrIC09IDM7CiAgICAgICAgcGl2b3QgPSBMUjsKICAgICAgICBzdGFydCA9IFVSOwogICAgICAgIGZvciAoaiA9IDA7IGogPCBsLmxlbmd0aCAvIDM7IGorKykgewogICAgICAgICAgb3V0c2lkZVBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsLCBqICogMywgb3V0c2lkZVBvaW50KTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBwaXZvdDsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCAtIGogLSAxOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0IC0gajsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIGJhY2sKICAgICAgICAgICk7CiAgICAgICAgICBwcmV2aW91c1BvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgIChzdGFydCAtIGogLSAxKSAqIDMsCiAgICAgICAgICAgIHByZXZpb3VzUG9pbnQKICAgICAgICAgICk7CiAgICAgICAgICBuZXh0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGZpbmFsUG9zaXRpb25zLCBwaXZvdCAqIDMsIG5leHRQb2ludCk7CiAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByZXZpb3VzUG9pbnQsIG5leHRQb2ludCwgbGVmdCksCiAgICAgICAgICAgIGxlZnQKICAgICAgICAgICk7CiAgICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIHZvaWQgMCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICAgIGJhY2sgLT0gMzsKICAgICAgICB9CiAgICAgICAgb3V0c2lkZVBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgcGl2b3QgKiAzLAogICAgICAgICAgb3V0c2lkZVBvaW50CiAgICAgICAgKTsKICAgICAgICBwcmV2aW91c1BvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShmaW5hbFBvc2l0aW9ucywgc3RhcnQgKiAzLCBwcmV2aW91c1BvaW50KSwKICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgIHByZXZpb3VzUG9pbnQKICAgICAgICApOwogICAgICAgIG5leHRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZmluYWxQb3NpdGlvbnMsIChzdGFydCAtIGopICogMywgbmV4dFBvaW50KSwKICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgIG5leHRQb2ludAogICAgICAgICk7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHByZXZpb3VzUG9pbnQsIG5leHRQb2ludCwgbGVmdCksCiAgICAgICAgICBsZWZ0CiAgICAgICAgKTsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCB2b2lkIDAsIHZlcnRleEZvcm1hdCk7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgfSBlbHNlIHsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCB2b2lkIDAsIHZlcnRleEZvcm1hdCk7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBwaXZvdCA9IFVSOwogICAgICAgIHN0YXJ0ID0gTFI7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHIubGVuZ3RoIC8gMzsgaisrKSB7CiAgICAgICAgICBvdXRzaWRlUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHIsIGogKiAzLCBvdXRzaWRlUG9pbnQpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHBpdm90OwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0ICsgajsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCArIGogKyAxOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICAgIGZyb250CiAgICAgICAgICApOwogICAgICAgICAgcHJldmlvdXNQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICBwaXZvdCAqIDMsCiAgICAgICAgICAgIHByZXZpb3VzUG9pbnQKICAgICAgICAgICk7CiAgICAgICAgICBuZXh0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgKHN0YXJ0ICsgaikgKiAzLAogICAgICAgICAgICBuZXh0UG9pbnQKICAgICAgICAgICk7CiAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByZXZpb3VzUG9pbnQsIG5leHRQb2ludCwgbGVmdCksCiAgICAgICAgICAgIGxlZnQKICAgICAgICAgICk7CiAgICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCB2b2lkIDAsIHZlcnRleEZvcm1hdCk7CiAgICAgICAgICBmcm9udCArPSAzOwogICAgICAgIH0KICAgICAgICBvdXRzaWRlUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBwaXZvdCAqIDMsCiAgICAgICAgICBvdXRzaWRlUG9pbnQKICAgICAgICApOwogICAgICAgIHByZXZpb3VzUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGZpbmFsUG9zaXRpb25zLCAoc3RhcnQgKyBqKSAqIDMsIHByZXZpb3VzUG9pbnQpLAogICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgcHJldmlvdXNQb2ludAogICAgICAgICk7CiAgICAgICAgbmV4dFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShmaW5hbFBvc2l0aW9ucywgc3RhcnQgKiAzLCBuZXh0UG9pbnQpLAogICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgbmV4dFBvaW50CiAgICAgICAgKTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZXh0UG9pbnQsIHByZXZpb3VzUG9pbnQsIGxlZnQpLCBsZWZ0KSwKICAgICAgICAgIGxlZnQKICAgICAgICApOwogICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgdm9pZCAwLCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIGJhY2sgLT0gMzsKICAgICAgfQogICAgICByaWdodEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICAgIGxlZnRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgICByaWdodEVkZ2Uuc3BsaWNlKDAsIDMpOwogICAgICBsZWZ0RWRnZS5zcGxpY2UobGVmdEVkZ2UubGVuZ3RoIC0gMywgMyk7CiAgICAgIGZpbmFsUG9zaXRpb25zLnNldChyaWdodEVkZ2UsIGZyb250KTsKICAgICAgZmluYWxQb3NpdGlvbnMuc2V0KGxlZnRFZGdlLCBiYWNrIC0gbGVmdEVkZ2UubGVuZ3RoICsgMSk7CiAgICAgIGxlbmd0aCA9IGxlZnRFZGdlLmxlbmd0aCAtIDM7CiAgICAgIGNvbXBJbmRleCArPSAzOwogICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZExlZnRzLCBjb21wSW5kZXgsIGxlZnQpOwogICAgICBmb3IgKGogPSAwOyBqIDwgbGVmdEVkZ2UubGVuZ3RoOyBqICs9IDMpIHsKICAgICAgICByaWdodE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHJpZ2h0RWRnZSwgaiwgc2NyYXRjaDEzKSwKICAgICAgICAgIHNjcmF0Y2gxMwogICAgICAgICk7CiAgICAgICAgbGVmdE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxlZnRFZGdlLCBsZW5ndGggLSBqLCBzY3JhdGNoMjMpLAogICAgICAgICAgc2NyYXRjaDIzCiAgICAgICAgKTsKICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmlnaHROb3JtYWwsIGxlZnROb3JtYWwsIG5vcm1hbDIpLAogICAgICAgICAgbm9ybWFsMgogICAgICAgICk7CiAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICBMUiA9IGZyb250IC8gMzsKICAgICAgICBMTCA9IExSIC0gMTsKICAgICAgICBVUiA9IChiYWNrIC0gMikgLyAzOwogICAgICAgIFVMID0gVVIgKyAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICAgIGZyb250IC09IDM7CiAgICAgIGJhY2sgKz0gMzsKICAgIH0KICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICBjb21wdXRlZE5vcm1hbHMsCiAgICAgIGNvbXB1dGVkTm9ybWFscy5sZW5ndGggLSAzLAogICAgICBub3JtYWwyCiAgICApOwogICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgIGlmIChhZGRFbmRQb3NpdGlvbnMpIHsKICAgICAgZnJvbnQgKz0gMzsKICAgICAgYmFjayAtPSAzOwogICAgICBsZWZ0UG9zID0gY2FydGVzaWFuMzI7CiAgICAgIHJpZ2h0UG9zID0gY2FydGVzaWFuNDI7CiAgICAgIGNvbnN0IGxhc3RFbmRQb3NpdGlvbnMgPSBlbmRQb3NpdGlvbnNbMV07CiAgICAgIGZvciAoaSA9IDA7IGkgPCBoYWxmTGVuZ3RoOyBpKyspIHsKICAgICAgICBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGxhc3RFbmRQb3NpdGlvbnMsCiAgICAgICAgICAoZW5kUG9zaXRpb25MZW5ndGggLSBpIC0gMSkgKiAzLAogICAgICAgICAgbGVmdFBvcwogICAgICAgICk7CiAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxhc3RFbmRQb3NpdGlvbnMsIGkgKiAzLCByaWdodFBvcyk7CiAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICBiYWNrCiAgICAgICAgKTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShmaW5hbFBvc2l0aW9ucywgcmlnaHRQb3MsIGZyb250KTsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIExSID0gZnJvbnQgLyAzOwogICAgICAgIExMID0gTFIgLSAxOwogICAgICAgIFVSID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgICAgVUwgPSBVUiArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgIH0KICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgdmFsdWVzOiBmaW5hbFBvc2l0aW9ucwogICAgfSk7CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGNvbnN0IHN0ID0gbmV3IEZsb2F0MzJBcnJheShzaXplIC8gMyAqIDIpOwogICAgICBsZXQgcmlnaHRTdDsKICAgICAgbGV0IGxlZnRTdDsKICAgICAgbGV0IHN0SW5kZXggPSAwOwogICAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgICAgbGVmdENvdW50IC89IDM7CiAgICAgICAgcmlnaHRDb3VudCAvPSAzOwogICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aC5QSSAvIChlbmRQb3NpdGlvbkxlbmd0aCArIDEpOwogICAgICAgIGxlZnRTdCA9IDEgLyAobGVmdENvdW50IC0gZW5kUG9zaXRpb25MZW5ndGggKyAxKTsKICAgICAgICByaWdodFN0ID0gMSAvIChyaWdodENvdW50IC0gZW5kUG9zaXRpb25MZW5ndGggKyAxKTsKICAgICAgICBsZXQgYTM7CiAgICAgICAgY29uc3QgaGFsZkVuZFBvcyA9IGVuZFBvc2l0aW9uTGVuZ3RoIC8gMjsKICAgICAgICBmb3IgKGkgPSBoYWxmRW5kUG9zICsgMTsgaSA8IGVuZFBvc2l0aW9uTGVuZ3RoICsgMTsgaSsrKSB7CiAgICAgICAgICBhMyA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIHRoZXRhICogaTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSByaWdodFN0ICogKDEgKyBNYXRoLmNvcyhhMykpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDAuNSAqICgxICsgTWF0aC5zaW4oYTMpKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMTsgaSA8IHJpZ2h0Q291bnQgLSBlbmRQb3NpdGlvbkxlbmd0aCArIDE7IGkrKykgewogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IGkgKiByaWdodFN0OwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDA7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IGVuZFBvc2l0aW9uTGVuZ3RoOyBpID4gaGFsZkVuZFBvczsgaS0tKSB7CiAgICAgICAgICBhMyA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIGkgKiB0aGV0YTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAxIC0gcmlnaHRTdCAqICgxICsgTWF0aC5jb3MoYTMpKTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAwLjUgKiAoMSArIE1hdGguc2luKGEzKSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IGhhbGZFbmRQb3M7IGkgPiAwOyBpLS0pIHsKICAgICAgICAgIGEzID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gdGhldGEgKiBpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDEgLSBsZWZ0U3QgKiAoMSArIE1hdGguY29zKGEzKSk7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMC41ICogKDEgKyBNYXRoLnNpbihhMykpOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSBsZWZ0Q291bnQgLSBlbmRQb3NpdGlvbkxlbmd0aDsgaSA+IDA7IGktLSkgewogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IGkgKiBsZWZ0U3Q7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMTsgaSA8IGhhbGZFbmRQb3MgKyAxOyBpKyspIHsKICAgICAgICAgIGEzID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgdGhldGEgKiBpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IGxlZnRTdCAqICgxICsgTWF0aC5jb3MoYTMpKTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAwLjUgKiAoMSArIE1hdGguc2luKGEzKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGxlZnRDb3VudCAvPSAzOwogICAgICAgIHJpZ2h0Q291bnQgLz0gMzsKICAgICAgICBsZWZ0U3QgPSAxIC8gKGxlZnRDb3VudCAtIDEpOwogICAgICAgIHJpZ2h0U3QgPSAxIC8gKHJpZ2h0Q291bnQgLSAxKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmlnaHRDb3VudDsgaSsrKSB7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gaSAqIHJpZ2h0U3Q7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gbGVmdENvdW50OyBpID4gMDsgaS0tKSB7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gKGkgLSAxKSAqIGxlZnRTdDsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAxOwogICAgICAgIH0KICAgICAgfQogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiBzdAogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBhdHRyLm5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBhdHRyLnRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGF0dHIuYml0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGV4dHJ1ZGVkQXR0cmlidXRlcyhhdHRyaWJ1dGVzLCB2ZXJ0ZXhGb3JtYXQpIHsKICAgIGlmICghdmVydGV4Rm9ybWF0Lm5vcm1hbCAmJiAhdmVydGV4Rm9ybWF0LnRhbmdlbnQgJiYgIXZlcnRleEZvcm1hdC5iaXRhbmdlbnQgJiYgIXZlcnRleEZvcm1hdC5zdCkgewogICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIGNvbnN0IHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgbGV0IHRvcE5vcm1hbHM7CiAgICBsZXQgdG9wQml0YW5nZW50czsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgdG9wTm9ybWFscyA9IGF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgdG9wQml0YW5nZW50cyA9IGF0dHJpYnV0ZXMuYml0YW5nZW50LnZhbHVlczsKICAgIH0KICAgIGNvbnN0IHNpemUgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAxODsKICAgIGNvbnN0IHRocmVlU2l6ZSA9IHNpemUgKiAzOwogICAgY29uc3QgdHdvU2l6ZSA9IHNpemUgKiAyOwogICAgY29uc3Qgc2l4U2l6ZSA9IHRocmVlU2l6ZSAqIDI7CiAgICBsZXQgaTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHRocmVlU2l6ZSAqIDYpIDogdm9pZCAwOwogICAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheSh0aHJlZVNpemUgKiA2KSA6IHZvaWQgMDsKICAgICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHRocmVlU2l6ZSAqIDYpIDogdm9pZCAwOwogICAgICBsZXQgdG9wUG9zaXRpb24gPSBjYXJ0ZXNpYW4xMjsKICAgICAgbGV0IGJvdHRvbVBvc2l0aW9uID0gY2FydGVzaWFuMjI7CiAgICAgIGxldCBwcmV2aW91c1Bvc2l0aW9uID0gY2FydGVzaWFuMzI7CiAgICAgIGxldCBub3JtYWwyID0gY2FydGVzaWFuNDI7CiAgICAgIGxldCB0YW5nZW50ID0gY2FydGVzaWFuNTI7CiAgICAgIGxldCBiaXRhbmdlbnQgPSBjYXJ0ZXNpYW42MjsKICAgICAgbGV0IGF0dHJJbmRleCA9IHNpeFNpemU7CiAgICAgIGZvciAoaSA9IDA7IGkgPCB0aHJlZVNpemU7IGkgKz0gMykgewogICAgICAgIGNvbnN0IGF0dHJJbmRleE9mZnNldCA9IGF0dHJJbmRleCArIHNpeFNpemU7CiAgICAgICAgdG9wUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgdG9wUG9zaXRpb24pOwogICAgICAgIGJvdHRvbVBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIGkgKyB0aHJlZVNpemUsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgcHJldmlvdXNQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAoaSArIDMpICUgdGhyZWVTaXplLAogICAgICAgICAgcHJldmlvdXNQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgYm90dG9tUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBib3R0b21Qb3NpdGlvbiwKICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgYm90dG9tUG9zaXRpb24KICAgICAgICApOwogICAgICAgIHByZXZpb3VzUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uLAogICAgICAgICAgdG9wUG9zaXRpb24sCiAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhib3R0b21Qb3NpdGlvbiwgcHJldmlvdXNQb3NpdGlvbiwgbm9ybWFsMiksCiAgICAgICAgICBub3JtYWwyCiAgICAgICAgKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUobm9ybWFscywgbm9ybWFsMiwgYXR0ckluZGV4T2Zmc2V0KTsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICBub3JtYWxzLAogICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICBhdHRySW5kZXhPZmZzZXQgKyAzCiAgICAgICAgICApOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUobm9ybWFscywgbm9ybWFsMiwgYXR0ckluZGV4KTsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKG5vcm1hbHMsIG5vcm1hbDIsIGF0dHJJbmRleCArIDMpOwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0b3BOb3JtYWxzLCBpLCBiaXRhbmdlbnQpOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgICBiaXRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4T2Zmc2V0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgICAgYml0YW5nZW50LAogICAgICAgICAgICAgIGF0dHJJbmRleE9mZnNldCArIDMKICAgICAgICAgICAgKTsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgICBiaXRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgICAgYml0YW5nZW50LAogICAgICAgICAgICAgIGF0dHJJbmRleCArIDMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYml0YW5nZW50LCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgICAgIHRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4T2Zmc2V0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgICAgIHRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4T2Zmc2V0ICsgMwogICAgICAgICAgICApOwogICAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSh0YW5nZW50cywgdGFuZ2VudCwgYXR0ckluZGV4KTsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgICAgICAgdGFuZ2VudCwKICAgICAgICAgICAgICBhdHRySW5kZXggKyAzCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGF0dHJJbmRleCArPSA2OwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgbm9ybWFscy5zZXQodG9wTm9ybWFscyk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRocmVlU2l6ZTsgaSArPSAzKSB7CiAgICAgICAgICBub3JtYWxzW2kgKyB0aHJlZVNpemVdID0gLXRvcE5vcm1hbHNbaV07CiAgICAgICAgICBub3JtYWxzW2kgKyB0aHJlZVNpemUgKyAxXSA9IC10b3BOb3JtYWxzW2kgKyAxXTsKICAgICAgICAgIG5vcm1hbHNbaSArIHRocmVlU2l6ZSArIDJdID0gLXRvcE5vcm1hbHNbaSArIDJdOwogICAgICAgIH0KICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMgPSBub3JtYWxzOwogICAgICB9IGVsc2UgewogICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gdm9pZCAwOwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgYml0YW5nZW50cy5zZXQodG9wQml0YW5nZW50cyk7CiAgICAgICAgYml0YW5nZW50cy5zZXQodG9wQml0YW5nZW50cywgdGhyZWVTaXplKTsKICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudC52YWx1ZXMgPSBiaXRhbmdlbnRzOwogICAgICB9IGVsc2UgewogICAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gdm9pZCAwOwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgIGNvbnN0IHRvcFRhbmdlbnRzID0gYXR0cmlidXRlcy50YW5nZW50LnZhbHVlczsKICAgICAgICB0YW5nZW50cy5zZXQodG9wVGFuZ2VudHMpOwogICAgICAgIHRhbmdlbnRzLnNldCh0b3BUYW5nZW50cywgdGhyZWVTaXplKTsKICAgICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQudmFsdWVzID0gdGFuZ2VudHM7CiAgICAgIH0KICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgY29uc3QgdG9wU3QgPSBhdHRyaWJ1dGVzLnN0LnZhbHVlczsKICAgICAgY29uc3Qgc3QgPSBuZXcgRmxvYXQzMkFycmF5KHR3b1NpemUgKiA2KTsKICAgICAgc3Quc2V0KHRvcFN0KTsKICAgICAgc3Quc2V0KHRvcFN0LCB0d29TaXplKTsKICAgICAgbGV0IGluZGV4ID0gdHdvU2l6ZSAqIDI7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMjsgaisrKSB7CiAgICAgICAgc3RbaW5kZXgrK10gPSB0b3BTdFswXTsKICAgICAgICBzdFtpbmRleCsrXSA9IHRvcFN0WzFdOwogICAgICAgIGZvciAoaSA9IDI7IGkgPCB0d29TaXplOyBpICs9IDIpIHsKICAgICAgICAgIGNvbnN0IHMgPSB0b3BTdFtpXTsKICAgICAgICAgIGNvbnN0IHQgPSB0b3BTdFtpICsgMV07CiAgICAgICAgICBzdFtpbmRleCsrXSA9IHM7CiAgICAgICAgICBzdFtpbmRleCsrXSA9IHQ7CiAgICAgICAgICBzdFtpbmRleCsrXSA9IHM7CiAgICAgICAgICBzdFtpbmRleCsrXSA9IHQ7CiAgICAgICAgfQogICAgICAgIHN0W2luZGV4KytdID0gdG9wU3RbMF07CiAgICAgICAgc3RbaW5kZXgrK10gPSB0b3BTdFsxXTsKICAgICAgfQogICAgICBhdHRyaWJ1dGVzLnN0LnZhbHVlcyA9IHN0OwogICAgfQogICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgfQogIGZ1bmN0aW9uIGFkZFdhbGxQb3NpdGlvbnMocG9zaXRpb25zLCBpbmRleCwgd2FsbFBvc2l0aW9ucykgewogICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHBvc2l0aW9uc1swXTsKICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSBwb3NpdGlvbnNbMV07CiAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gcG9zaXRpb25zWzJdOwogICAgZm9yIChsZXQgaSA9IDM7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgeCA9IHBvc2l0aW9uc1tpXTsKICAgICAgY29uc3QgeSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgIGNvbnN0IHogPSBwb3NpdGlvbnNbaSArIDJdOwogICAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0geDsKICAgICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHk7CiAgICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSB6OwogICAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0geDsKICAgICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHk7CiAgICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSB6OwogICAgfQogICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHBvc2l0aW9uc1swXTsKICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSBwb3NpdGlvbnNbMV07CiAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gcG9zaXRpb25zWzJdOwogICAgcmV0dXJuIHdhbGxQb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVQb3NpdGlvbnNFeHRydWRlZChwYXJhbXMsIHZlcnRleEZvcm1hdCkgewogICAgY29uc3QgdG9wVmVydGV4Rm9ybWF0ID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KHsKICAgICAgcG9zaXRpb246IHZlcnRleEZvcm1hdC5wb3NpdGlvbiwKICAgICAgbm9ybWFsOiB2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgcGFyYW1zLnNoYWRvd1ZvbHVtZSwKICAgICAgdGFuZ2VudDogdmVydGV4Rm9ybWF0LnRhbmdlbnQsCiAgICAgIGJpdGFuZ2VudDogdmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50LAogICAgICBzdDogdmVydGV4Rm9ybWF0LnN0CiAgICB9KTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHBhcmFtcy5lbGxpcHNvaWQ7CiAgICBjb25zdCBjb21wdXRlZFBvc2l0aW9ucyA9IENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9ucyhwYXJhbXMpOwogICAgY29uc3QgYXR0ciA9IGNvbWJpbmUyKGNvbXB1dGVkUG9zaXRpb25zLCB0b3BWZXJ0ZXhGb3JtYXQsIGVsbGlwc29pZCk7CiAgICBjb25zdCBoZWlnaHQgPSBwYXJhbXMuaGVpZ2h0OwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBwYXJhbXMuZXh0cnVkZWRIZWlnaHQ7CiAgICBsZXQgYXR0cmlidXRlcyA9IGF0dHIuYXR0cmlidXRlczsKICAgIGNvbnN0IGluZGljZXMgPSBhdHRyLmluZGljZXM7CiAgICBsZXQgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IG5ld1Bvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoICogNik7CiAgICBsZXQgZXh0cnVkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCk7CiAgICBleHRydWRlZFBvc2l0aW9ucy5zZXQocG9zaXRpb25zKTsKICAgIGxldCB3YWxsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiA0KTsKICAgIHBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgcG9zaXRpb25zLAogICAgICBoZWlnaHQsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIHdhbGxQb3NpdGlvbnMgPSBhZGRXYWxsUG9zaXRpb25zKHBvc2l0aW9ucywgMCwgd2FsbFBvc2l0aW9ucyk7CiAgICBleHRydWRlZFBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgZXh0cnVkZWRQb3NpdGlvbnMsCiAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9ucygKICAgICAgZXh0cnVkZWRQb3NpdGlvbnMsCiAgICAgIGxlbmd0aCAqIDIsCiAgICAgIHdhbGxQb3NpdGlvbnMKICAgICk7CiAgICBuZXdQb3NpdGlvbnMuc2V0KHBvc2l0aW9ucyk7CiAgICBuZXdQb3NpdGlvbnMuc2V0KGV4dHJ1ZGVkUG9zaXRpb25zLCBsZW5ndGgpOwogICAgbmV3UG9zaXRpb25zLnNldCh3YWxsUG9zaXRpb25zLCBsZW5ndGggKiAyKTsKICAgIGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gbmV3UG9zaXRpb25zOwogICAgYXR0cmlidXRlcyA9IGV4dHJ1ZGVkQXR0cmlidXRlcyhhdHRyaWJ1dGVzLCB2ZXJ0ZXhGb3JtYXQpOwogICAgbGV0IGk7CiAgICBjb25zdCBzaXplID0gbGVuZ3RoIC8gMzsKICAgIGlmIChwYXJhbXMuc2hhZG93Vm9sdW1lKSB7CiAgICAgIGNvbnN0IHRvcE5vcm1hbHMgPSBhdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXM7CiAgICAgIGxlbmd0aCA9IHRvcE5vcm1hbHMubGVuZ3RoOwogICAgICBsZXQgZXh0cnVkZU5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCAqIDYpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB0b3BOb3JtYWxzW2ldID0gLXRvcE5vcm1hbHNbaV07CiAgICAgIH0KICAgICAgZXh0cnVkZU5vcm1hbHMuc2V0KHRvcE5vcm1hbHMsIGxlbmd0aCk7CiAgICAgIGV4dHJ1ZGVOb3JtYWxzID0gYWRkV2FsbFBvc2l0aW9ucyh0b3BOb3JtYWxzLCBsZW5ndGggKiA0LCBleHRydWRlTm9ybWFscyk7CiAgICAgIGF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICAgIGlmICghdmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gdm9pZCAwOwogICAgICB9CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgIGxldCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KHNpemUgKiA2KTsKICAgICAgaWYgKHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgYXBwbHlPZmZzZXQgPSBhcHBseU9mZnNldC5maWxsKDEsIDAsIHNpemUpLmZpbGwoMSwgc2l6ZSAqIDIsIHNpemUgKiA0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhcHBseU9mZnNldFZhbHVlID0gcGFyYW1zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgYXBwbHlPZmZzZXQgPSBhcHBseU9mZnNldC5maWxsKGFwcGx5T2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBpTGVuZ3RoID0gaW5kaWNlcy5sZW5ndGg7CiAgICBjb25zdCB0d29TaXplID0gc2l6ZSArIHNpemU7CiAgICBjb25zdCBuZXdJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG5ld1Bvc2l0aW9ucy5sZW5ndGggLyAzLAogICAgICBpTGVuZ3RoICogMiArIHR3b1NpemUgKiAzCiAgICApOwogICAgbmV3SW5kaWNlcy5zZXQoaW5kaWNlcyk7CiAgICBsZXQgaW5kZXggPSBpTGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGlMZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCB2MDIgPSBpbmRpY2VzW2ldOwogICAgICBjb25zdCB2MTIgPSBpbmRpY2VzW2kgKyAxXTsKICAgICAgY29uc3QgdjIyID0gaW5kaWNlc1tpICsgMl07CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSB2MjIgKyBzaXplOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gdjEyICsgc2l6ZTsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IHYwMiArIHNpemU7CiAgICB9CiAgICBsZXQgVUwsIExMLCBVUiwgTFI7CiAgICBmb3IgKGkgPSAwOyBpIDwgdHdvU2l6ZTsgaSArPSAyKSB7CiAgICAgIFVMID0gaSArIHR3b1NpemU7CiAgICAgIExMID0gVUwgKyB0d29TaXplOwogICAgICBVUiA9IFVMICsgMTsKICAgICAgTFIgPSBMTCArIDE7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICB9CiAgICByZXR1cm4gewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiBuZXdJbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBjb21wdXRlT2Zmc2V0UG9pbnRzKHBvc2l0aW9uMSwgcG9zaXRpb24yLCBlbGxpcHNvaWQsIGhhbGZXaWR0aCwgbWluMywgbWF4MykgewogICAgY29uc3QgZGlyZWN0aW9uMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgcG9zaXRpb24yLAogICAgICBwb3NpdGlvbjEsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNwogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZGlyZWN0aW9uMik7CiAgICBjb25zdCBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbjEsIHNjcmF0Y2hDYXJ0ZXNpYW4yNyk7CiAgICBjb25zdCBvZmZzZXREaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgIGRpcmVjdGlvbjIsCiAgICAgIG5vcm1hbDIsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNwogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG9mZnNldERpcmVjdGlvbiwgaGFsZldpZHRoLCBvZmZzZXREaXJlY3Rpb24pOwogICAgbGV0IG1pbkxhdCA9IG1pbjMubGF0aXR1ZGU7CiAgICBsZXQgbWluTG9uID0gbWluMy5sb25naXR1ZGU7CiAgICBsZXQgbWF4TGF0ID0gbWF4My5sYXRpdHVkZTsKICAgIGxldCBtYXhMb24gPSBtYXgzLmxvbmdpdHVkZTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24xLCBvZmZzZXREaXJlY3Rpb24sIHNjcmF0Y2hDYXJ0ZXNpYW4yNyk7CiAgICBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoc2NyYXRjaENhcnRlc2lhbjI3LCBzY3JhdGNoQ2FydG9ncmFwaGljNCk7CiAgICBsZXQgbGF0ID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubGF0aXR1ZGU7CiAgICBsZXQgbG9uID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubG9uZ2l0dWRlOwogICAgbWluTGF0ID0gTWF0aC5taW4obWluTGF0LCBsYXQpOwogICAgbWluTG9uID0gTWF0aC5taW4obWluTG9uLCBsb24pOwogICAgbWF4TGF0ID0gTWF0aC5tYXgobWF4TGF0LCBsYXQpOwogICAgbWF4TG9uID0gTWF0aC5tYXgobWF4TG9uLCBsb24pOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvc2l0aW9uMSwgb2Zmc2V0RGlyZWN0aW9uLCBzY3JhdGNoQ2FydGVzaWFuMjcpOwogICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHNjcmF0Y2hDYXJ0ZXNpYW4yNywgc2NyYXRjaENhcnRvZ3JhcGhpYzQpOwogICAgbGF0ID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubGF0aXR1ZGU7CiAgICBsb24gPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sb25naXR1ZGU7CiAgICBtaW5MYXQgPSBNYXRoLm1pbihtaW5MYXQsIGxhdCk7CiAgICBtaW5Mb24gPSBNYXRoLm1pbihtaW5Mb24sIGxvbik7CiAgICBtYXhMYXQgPSBNYXRoLm1heChtYXhMYXQsIGxhdCk7CiAgICBtYXhMb24gPSBNYXRoLm1heChtYXhMb24sIGxvbik7CiAgICBtaW4zLmxhdGl0dWRlID0gbWluTGF0OwogICAgbWluMy5sb25naXR1ZGUgPSBtaW5Mb247CiAgICBtYXgzLmxhdGl0dWRlID0gbWF4TGF0OwogICAgbWF4My5sb25naXR1ZGUgPSBtYXhMb247CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSZWN0YW5nbGUyKHBvc2l0aW9ucywgZWxsaXBzb2lkLCB3aWR0aCwgY29ybmVyVHlwZSwgcmVzdWx0KSB7CiAgICBwb3NpdGlvbnMgPSBzY2FsZVRvU3VyZmFjZTIocG9zaXRpb25zLCBlbGxpcHNvaWQpOwogICAgY29uc3QgY2xlYW5Qb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgcG9zaXRpb25zLAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbgogICAgKTsKICAgIGNvbnN0IGxlbmd0aCA9IGNsZWFuUG9zaXRpb25zLmxlbmd0aDsKICAgIGlmIChsZW5ndGggPCAyIHx8IHdpZHRoIDw9IDApIHsKICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgfQogICAgY29uc3QgaGFsZldpZHRoID0gd2lkdGggKiAwLjU7CiAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxhdGl0dWRlID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sb25naXR1ZGUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxhdGl0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sb25naXR1ZGUgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbGF0LCBsb247CiAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpIHsKICAgICAgY29uc3QgZmlyc3QgPSBjbGVhblBvc2l0aW9uc1swXTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGZpcnN0LCBjbGVhblBvc2l0aW9uc1sxXSwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoc2NyYXRjaENhcnRlc2lhbk9mZnNldCwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsCiAgICAgICAgaGFsZldpZHRoLAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChmaXJzdCwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCwgc2NyYXRjaENhcnRlc2lhbkVuZHMpOwogICAgICBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgc2NyYXRjaENhcnRlc2lhbkVuZHMsCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzQKICAgICAgKTsKICAgICAgbGF0ID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubGF0aXR1ZGU7CiAgICAgIGxvbiA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LmxvbmdpdHVkZTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sYXRpdHVkZSA9IE1hdGgubWluKAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubGF0aXR1ZGUsCiAgICAgICAgbGF0CiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubG9uZ2l0dWRlID0gTWF0aC5taW4oCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sb25naXR1ZGUsCiAgICAgICAgbG9uCiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubGF0aXR1ZGUgPSBNYXRoLm1heCgKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxhdGl0dWRlLAogICAgICAgIGxhdAogICAgICApOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxvbmdpdHVkZSA9IE1hdGgubWF4KAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubG9uZ2l0dWRlLAogICAgICAgIGxvbgogICAgICApOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGggLSAxOyArK2kpIHsKICAgICAgY29tcHV0ZU9mZnNldFBvaW50cygKICAgICAgICBjbGVhblBvc2l0aW9uc1tpXSwKICAgICAgICBjbGVhblBvc2l0aW9uc1tpICsgMV0sCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGhhbGZXaWR0aCwKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGxhc3QgPSBjbGVhblBvc2l0aW9uc1tsZW5ndGggLSAxXTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChsYXN0LCBjbGVhblBvc2l0aW9uc1tsZW5ndGggLSAyXSwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsCiAgICAgIGhhbGZXaWR0aCwKICAgICAgc2NyYXRjaENhcnRlc2lhbk9mZnNldAogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobGFzdCwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCwgc2NyYXRjaENhcnRlc2lhbkVuZHMpOwogICAgY29tcHV0ZU9mZnNldFBvaW50cygKICAgICAgbGFzdCwKICAgICAgc2NyYXRjaENhcnRlc2lhbkVuZHMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgaGFsZldpZHRoLAogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLAogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4CiAgICApOwogICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKSB7CiAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuRW5kcywKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNAogICAgICApOwogICAgICBsYXQgPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sYXRpdHVkZTsKICAgICAgbG9uID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubG9uZ2l0dWRlOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxhdGl0dWRlID0gTWF0aC5taW4oCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sYXRpdHVkZSwKICAgICAgICBsYXQKICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sb25naXR1ZGUgPSBNYXRoLm1pbigKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxvbmdpdHVkZSwKICAgICAgICBsb24KICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sYXRpdHVkZSA9IE1hdGgubWF4KAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubGF0aXR1ZGUsCiAgICAgICAgbGF0CiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubG9uZ2l0dWRlID0gTWF0aC5tYXgoCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sb25naXR1ZGUsCiAgICAgICAgbG9uCiAgICAgICk7CiAgICB9CiAgICBjb25zdCByZWN0YW5nbGUgPSBkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSA/IHJlc3VsdCA6IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgcmVjdGFuZ2xlLm5vcnRoID0gc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sYXRpdHVkZTsKICAgIHJlY3RhbmdsZS5zb3V0aCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubGF0aXR1ZGU7CiAgICByZWN0YW5nbGUuZWFzdCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubG9uZ2l0dWRlOwogICAgcmVjdGFuZ2xlLndlc3QgPSBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxvbmdpdHVkZTsKICAgIHJldHVybiByZWN0YW5nbGU7CiAgfQogIGZ1bmN0aW9uIENvcnJpZG9yR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLndpZHRoIiwgd2lkdGgpOwogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KQogICAgKTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCkKICAgICk7CiAgICB0aGlzLl93aWR0aCA9IHdpZHRoOwogICAgdGhpcy5faGVpZ2h0ID0gTWF0aC5tYXgoaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fY29ybmVyVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY29ybmVyVHlwZSwgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX3NoYWRvd1ZvbHVtZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2hhZG93Vm9sdW1lLCBmYWxzZSk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUNvcnJpZG9yR2VvbWV0cnkiOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSB2b2lkIDA7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IDEgKyBwb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDc7CiAgfQogIHZhciBjYXJ0ZXNpYW4xMiwgY2FydGVzaWFuMjIsIGNhcnRlc2lhbjMyLCBjYXJ0ZXNpYW40MiwgY2FydGVzaWFuNTIsIGNhcnRlc2lhbjYyLCBzY3JhdGNoMTMsIHNjcmF0Y2gyMywgc2NyYXRjaENhcnRlc2lhbjE3LCBzY3JhdGNoQ2FydGVzaWFuMjcsIHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LCBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0LCBzY3JhdGNoQ2FydGVzaWFuRW5kcywgc2NyYXRjaENhcnRvZ3JhcGhpY01pbiwgc2NyYXRjaENhcnRvZ3JhcGhpY01heCwgc2NyYXRjaEVsbGlwc29pZDQsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ0LCBzY3JhdGNoT3B0aW9uczksIENvcnJpZG9yR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3JyaWRvckdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvckdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ29ybmVyVHlwZSgpOwogICAgICBpbml0X0NvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBjYXJ0ZXNpYW4xMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW40MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuNTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjYyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoMTMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2gyMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjE3ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMjcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5FbmRzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3dpZHRoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5faGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9jb3JuZXJUeXBlOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zaGFkb3dWb2x1bWUgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ0ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NCA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczkgPSB7CiAgICAgICAgcG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkNCwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ0LAogICAgICAgIHdpZHRoOiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBjb3JuZXJUeXBlOiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBzaGFkb3dWb2x1bWU6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBDb3JyaWRvckdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDQpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB3aWR0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgY29ybmVyVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LnBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS53aWR0aCA9IHdpZHRoOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LmNvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczkuc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5Lm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IENvcnJpZG9yR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnM5KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fd2lkdGggPSB3aWR0aDsKICAgICAgICByZXN1bHQuX2hlaWdodCA9IGhlaWdodDsKICAgICAgICByZXN1bHQuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmVzdWx0Ll9zaGFkb3dWb2x1bWUgPSBzaGFkb3dWb2x1bWU7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvcnJpZG9yR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZSA9IGZ1bmN0aW9uKG9wdGlvbnMsIHJlc3VsdCkgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMud2lkdGgiLCB3aWR0aCk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvcm5lclR5cGUsIENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKTsKICAgICAgICByZXR1cm4gY29tcHV0ZVJlY3RhbmdsZTIocG9zaXRpb25zLCBlbGxpcHNvaWQsIHdpZHRoLCBjb3JuZXJUeXBlLCByZXN1bHQpOwogICAgICB9OwogICAgICBDb3JyaWRvckdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oY29ycmlkb3JHZW9tZXRyeSkgewogICAgICAgIGxldCBwb3NpdGlvbnMgPSBjb3JyaWRvckdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3Qgd2lkdGggPSBjb3JyaWRvckdlb21ldHJ5Ll93aWR0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBjb3JyaWRvckdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgcG9zaXRpb25zID0gc2NhbGVUb1N1cmZhY2UyKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBjbGVhblBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24KICAgICAgICApOwogICAgICAgIGlmIChjbGVhblBvc2l0aW9ucy5sZW5ndGggPCAyIHx8IHdpZHRoIDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gY29ycmlkb3JHZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gY29ycmlkb3JHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gY29ycmlkb3JHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHBvc2l0aW9uczogY2xlYW5Qb3NpdGlvbnMsCiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGNvcm5lclR5cGU6IGNvcnJpZG9yR2VvbWV0cnkuX2Nvcm5lclR5cGUsCiAgICAgICAgICBncmFudWxhcml0eTogY29ycmlkb3JHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICBzYXZlQXR0cmlidXRlczogdHJ1ZQogICAgICAgIH07CiAgICAgICAgbGV0IGF0dHI7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIHBhcmFtcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICBwYXJhbXMuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIHBhcmFtcy5zaGFkb3dWb2x1bWUgPSBjb3JyaWRvckdlb21ldHJ5Ll9zaGFkb3dWb2x1bWU7CiAgICAgICAgICBwYXJhbXMub2Zmc2V0QXR0cmlidXRlID0gY29ycmlkb3JHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgYXR0ciA9IGNvbXB1dGVQb3NpdGlvbnNFeHRydWRlZChwYXJhbXMsIHZlcnRleEZvcm1hdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKHBhcmFtcyk7CiAgICAgICAgICBhdHRyID0gY29tYmluZTIoY29tcHV0ZWRQb3NpdGlvbnMsIHZlcnRleEZvcm1hdCwgZWxsaXBzb2lkKTsKICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb3JyaWRvckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0VmFsdWUgPSBjb3JyaWRvckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBhdHRyLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKGFwcGx5T2Zmc2V0VmFsdWUpOwogICAgICAgICAgICBhdHRyLmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBhdHRyLmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgMwogICAgICAgICk7CiAgICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogYXR0ci5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBjb3JyaWRvckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeS5jcmVhdGVTaGFkb3dWb2x1bWUgPSBmdW5jdGlvbihjb3JyaWRvckdlb21ldHJ5LCBtaW5IZWlnaHRGdW5jLCBtYXhIZWlnaHRGdW5jKSB7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBjb3JyaWRvckdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBjb3JyaWRvckdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0ID0gbWluSGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSBtYXhIZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIHJldHVybiBuZXcgQ29ycmlkb3JHZW9tZXRyeSh7CiAgICAgICAgICBwb3NpdGlvbnM6IGNvcnJpZG9yR2VvbWV0cnkuX3Bvc2l0aW9ucywKICAgICAgICAgIHdpZHRoOiBjb3JyaWRvckdlb21ldHJ5Ll93aWR0aCwKICAgICAgICAgIGNvcm5lclR5cGU6IGNvcnJpZG9yR2VvbWV0cnkuX2Nvcm5lclR5cGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IG1heEhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWSwKICAgICAgICAgIHNoYWRvd1ZvbHVtZTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhDb3JyaWRvckdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9yZWN0YW5nbGUpKSB7CiAgICAgICAgICAgICAgdGhpcy5fcmVjdGFuZ2xlID0gY29tcHV0ZVJlY3RhbmdsZTIoCiAgICAgICAgICAgICAgICB0aGlzLl9wb3NpdGlvbnMsCiAgICAgICAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICAgICAgICB0aGlzLl93aWR0aCwKICAgICAgICAgICAgICAgIHRoaXMuX2Nvcm5lclR5cGUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZWN0YW5nbGU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBGb3IgcmVtYXBwaW5nIHRleHR1cmUgY29vcmRpbmF0ZXMgd2hlbiByZW5kZXJpbmcgQ29ycmlkb3JHZW9tZXRyaWVzIGFzIEdyb3VuZFByaW1pdGl2ZXMuCiAgICAgICAgICoKICAgICAgICAgKiBDb3JyaWRvcnMgZG9uJ3Qgc3VwcG9ydCBzdFJvdGF0aW9uLAogICAgICAgICAqIHNvIGp1c3QgcmV0dXJuIHRoZSBjb3JuZXJzIG9mIHRoZSBvcmlnaW5hbCBzeXN0ZW0uCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gWzAsIDAsIDAsIDEsIDEsIDBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIENvcnJpZG9yR2VvbWV0cnlfZGVmYXVsdCA9IENvcnJpZG9yR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3JyaWRvckdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ29ycmlkb3JHZW9tZXRyeShjb3JyaWRvckdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjb3JyaWRvckdlb21ldHJ5ID0gQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhjb3JyaWRvckdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgY29ycmlkb3JHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoY29ycmlkb3JHZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBDb3JyaWRvckdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY29ycmlkb3JHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDb3JyaWRvckdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlQ29ycmlkb3JHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29ycmlkb3JHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ29ycmlkb3JHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ29ycmlkb3JHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcnJpZG9yT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gc2NhbGVUb1N1cmZhY2UzKHBvc2l0aW9ucywgZWxsaXBzb2lkKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICBwb3NpdGlvbnNbaV0gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbnNbaV0sIHBvc2l0aW9uc1tpXSk7CiAgICB9CiAgICByZXR1cm4gcG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBjb21iaW5lMyhjb21wdXRlZFBvc2l0aW9ucywgY29ybmVyVHlwZSkgewogICAgY29uc3Qgd2FsbEluZGljZXMgPSBbXTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGNvbXB1dGVkUG9zaXRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IGNvcm5lcnMgPSBjb21wdXRlZFBvc2l0aW9ucy5jb3JuZXJzOwogICAgY29uc3QgZW5kUG9zaXRpb25zID0gY29tcHV0ZWRQb3NpdGlvbnMuZW5kUG9zaXRpb25zOwogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgbGV0IGNvcm5lcjsKICAgIGxldCBsZWZ0Q291bnQgPSAwOwogICAgbGV0IHJpZ2h0Q291bnQgPSAwOwogICAgbGV0IGk7CiAgICBsZXQgaW5kaWNlc0xlbmd0aCA9IDA7CiAgICBsZXQgbGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkgKz0gMikgewogICAgICBsZW5ndGggPSBwb3NpdGlvbnNbaV0ubGVuZ3RoIC0gMzsKICAgICAgbGVmdENvdW50ICs9IGxlbmd0aDsKICAgICAgaW5kaWNlc0xlbmd0aCArPSBsZW5ndGggLyAzICogNDsKICAgICAgcmlnaHRDb3VudCArPSBwb3NpdGlvbnNbaSArIDFdLmxlbmd0aCAtIDM7CiAgICB9CiAgICBsZWZ0Q291bnQgKz0gMzsKICAgIHJpZ2h0Q291bnQgKz0gMzsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3JuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgIGNvbnN0IGxlZnRTaWRlID0gY29ybmVyc1tpXS5sZWZ0UG9zaXRpb25zOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxlZnRTaWRlKSkgewogICAgICAgIGxlbmd0aCA9IGxlZnRTaWRlLmxlbmd0aDsKICAgICAgICBsZWZ0Q291bnQgKz0gbGVuZ3RoOwogICAgICAgIGluZGljZXNMZW5ndGggKz0gbGVuZ3RoIC8gMyAqIDI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGVuZ3RoID0gY29ybmVyc1tpXS5yaWdodFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgcmlnaHRDb3VudCArPSBsZW5ndGg7CiAgICAgICAgaW5kaWNlc0xlbmd0aCArPSBsZW5ndGggLyAzICogMjsKICAgICAgfQogICAgfQogICAgY29uc3QgYWRkRW5kUG9zaXRpb25zID0gZGVmaW5lZF9kZWZhdWx0KGVuZFBvc2l0aW9ucyk7CiAgICBsZXQgZW5kUG9zaXRpb25MZW5ndGg7CiAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgIGVuZFBvc2l0aW9uTGVuZ3RoID0gZW5kUG9zaXRpb25zWzBdLmxlbmd0aCAtIDM7CiAgICAgIGxlZnRDb3VudCArPSBlbmRQb3NpdGlvbkxlbmd0aDsKICAgICAgcmlnaHRDb3VudCArPSBlbmRQb3NpdGlvbkxlbmd0aDsKICAgICAgZW5kUG9zaXRpb25MZW5ndGggLz0gMzsKICAgICAgaW5kaWNlc0xlbmd0aCArPSBlbmRQb3NpdGlvbkxlbmd0aCAqIDQ7CiAgICB9CiAgICBjb25zdCBzaXplID0gbGVmdENvdW50ICsgcmlnaHRDb3VudDsKICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplKTsKICAgIGxldCBmcm9udCA9IDA7CiAgICBsZXQgYmFjayA9IHNpemUgLSAxOwogICAgbGV0IFVMLCBMTCwgVVIsIExSOwogICAgbGV0IHJpZ2h0UG9zLCBsZWZ0UG9zOwogICAgY29uc3QgaGFsZkxlbmd0aCA9IGVuZFBvc2l0aW9uTGVuZ3RoIC8gMjsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShzaXplIC8gMywgaW5kaWNlc0xlbmd0aCArIDQpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGluZGljZXNbaW5kZXgrK10gPSBmcm9udCAvIDM7CiAgICBpbmRpY2VzW2luZGV4KytdID0gKGJhY2sgLSAyKSAvIDM7CiAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgIHdhbGxJbmRpY2VzLnB1c2goZnJvbnQgLyAzKTsKICAgICAgbGVmdFBvcyA9IGNhcnRlc2lhbjEzOwogICAgICByaWdodFBvcyA9IGNhcnRlc2lhbjIzOwogICAgICBjb25zdCBmaXJzdEVuZFBvc2l0aW9ucyA9IGVuZFBvc2l0aW9uc1swXTsKICAgICAgZm9yIChpID0gMDsgaSA8IGhhbGZMZW5ndGg7IGkrKykgewogICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmlyc3RFbmRQb3NpdGlvbnMsCiAgICAgICAgICAoaGFsZkxlbmd0aCAtIDEgLSBpKSAqIDMsCiAgICAgICAgICBsZWZ0UG9zCiAgICAgICAgKTsKICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmaXJzdEVuZFBvc2l0aW9ucywKICAgICAgICAgIChoYWxmTGVuZ3RoICsgaSkgKiAzLAogICAgICAgICAgcmlnaHRQb3MKICAgICAgICApOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKGZpbmFsUG9zaXRpb25zLCByaWdodFBvcywgZnJvbnQpOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgYmFjawogICAgICAgICk7CiAgICAgICAgTEwgPSBmcm9udCAvIDM7CiAgICAgICAgTFIgPSBMTCArIDE7CiAgICAgICAgVUwgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgICBVUiA9IFVMIC0gMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgIH0KICAgIGxldCBwb3NJbmRleCA9IDA7CiAgICBsZXQgcmlnaHRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgbGV0IGxlZnRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgZmluYWxQb3NpdGlvbnMuc2V0KHJpZ2h0RWRnZSwgZnJvbnQpOwogICAgZmluYWxQb3NpdGlvbnMuc2V0KGxlZnRFZGdlLCBiYWNrIC0gbGVmdEVkZ2UubGVuZ3RoICsgMSk7CiAgICBsZW5ndGggPSBsZWZ0RWRnZS5sZW5ndGggLSAzOwogICAgd2FsbEluZGljZXMucHVzaChmcm9udCAvIDMsIChiYWNrIC0gMikgLyAzKTsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICBMTCA9IGZyb250IC8gMzsKICAgICAgTFIgPSBMTCArIDE7CiAgICAgIFVMID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgIFVSID0gVUwgLSAxOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgIGZyb250ICs9IDM7CiAgICAgIGJhY2sgLT0gMzsKICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCBjb3JuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGxldCBqOwogICAgICBjb3JuZXIgPSBjb3JuZXJzW2ldOwogICAgICBjb25zdCBsID0gY29ybmVyLmxlZnRQb3NpdGlvbnM7CiAgICAgIGNvbnN0IHIgPSBjb3JuZXIucmlnaHRQb3NpdGlvbnM7CiAgICAgIGxldCBzdGFydDsKICAgICAgbGV0IG91dHNpZGVQb2ludCA9IGNhcnRlc2lhbjMzOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGwpKSB7CiAgICAgICAgYmFjayAtPSAzOwogICAgICAgIHN0YXJ0ID0gVVI7CiAgICAgICAgd2FsbEluZGljZXMucHVzaChMUik7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IGwubGVuZ3RoIC8gMzsgaisrKSB7CiAgICAgICAgICBvdXRzaWRlUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGwsIGogKiAzLCBvdXRzaWRlUG9pbnQpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0IC0gaiAtIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgLSBqOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgYmFjawogICAgICAgICAgKTsKICAgICAgICAgIGJhY2sgLT0gMzsKICAgICAgICB9CiAgICAgICAgd2FsbEluZGljZXMucHVzaChzdGFydCAtIE1hdGguZmxvb3IobC5sZW5ndGggLyA2KSk7CiAgICAgICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEKSB7CiAgICAgICAgICB3YWxsSW5kaWNlcy5wdXNoKChiYWNrIC0gMikgLyAzICsgMSk7CiAgICAgICAgfQogICAgICAgIGZyb250ICs9IDM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBzdGFydCA9IExSOwogICAgICAgIHdhbGxJbmRpY2VzLnB1c2goVVIpOwogICAgICAgIGZvciAoaiA9IDA7IGogPCByLmxlbmd0aCAvIDM7IGorKykgewogICAgICAgICAgb3V0c2lkZVBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShyLCBqICogMywgb3V0c2lkZVBvaW50KTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCArIGo7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgKyBqICsgMTsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgICBmcm9udAogICAgICAgICAgKTsKICAgICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgfQogICAgICAgIHdhbGxJbmRpY2VzLnB1c2goc3RhcnQgKyBNYXRoLmZsb29yKHIubGVuZ3RoIC8gNikpOwogICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgd2FsbEluZGljZXMucHVzaChmcm9udCAvIDMgLSAxKTsKICAgICAgICB9CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICAgIHJpZ2h0RWRnZSA9IHBvc2l0aW9uc1twb3NJbmRleCsrXTsKICAgICAgbGVmdEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICAgIHJpZ2h0RWRnZS5zcGxpY2UoMCwgMyk7CiAgICAgIGxlZnRFZGdlLnNwbGljZShsZWZ0RWRnZS5sZW5ndGggLSAzLCAzKTsKICAgICAgZmluYWxQb3NpdGlvbnMuc2V0KHJpZ2h0RWRnZSwgZnJvbnQpOwogICAgICBmaW5hbFBvc2l0aW9ucy5zZXQobGVmdEVkZ2UsIGJhY2sgLSBsZWZ0RWRnZS5sZW5ndGggKyAxKTsKICAgICAgbGVuZ3RoID0gbGVmdEVkZ2UubGVuZ3RoIC0gMzsKICAgICAgZm9yIChqID0gMDsgaiA8IGxlZnRFZGdlLmxlbmd0aDsgaiArPSAzKSB7CiAgICAgICAgTFIgPSBmcm9udCAvIDM7CiAgICAgICAgTEwgPSBMUiAtIDE7CiAgICAgICAgVVIgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgICBVTCA9IFVSICsgMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgICAgZnJvbnQgLT0gMzsKICAgICAgYmFjayArPSAzOwogICAgICB3YWxsSW5kaWNlcy5wdXNoKGZyb250IC8gMywgKGJhY2sgLSAyKSAvIDMpOwogICAgfQogICAgaWYgKGFkZEVuZFBvc2l0aW9ucykgewogICAgICBmcm9udCArPSAzOwogICAgICBiYWNrIC09IDM7CiAgICAgIGxlZnRQb3MgPSBjYXJ0ZXNpYW4xMzsKICAgICAgcmlnaHRQb3MgPSBjYXJ0ZXNpYW4yMzsKICAgICAgY29uc3QgbGFzdEVuZFBvc2l0aW9ucyA9IGVuZFBvc2l0aW9uc1sxXTsKICAgICAgZm9yIChpID0gMDsgaSA8IGhhbGZMZW5ndGg7IGkrKykgewogICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgbGFzdEVuZFBvc2l0aW9ucywKICAgICAgICAgIChlbmRQb3NpdGlvbkxlbmd0aCAtIGkgLSAxKSAqIDMsCiAgICAgICAgICBsZWZ0UG9zCiAgICAgICAgKTsKICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobGFzdEVuZFBvc2l0aW9ucywgaSAqIDMsIHJpZ2h0UG9zKTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgbGVmdFBvcywKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIGJhY2sKICAgICAgICApOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKGZpbmFsUG9zaXRpb25zLCByaWdodFBvcywgZnJvbnQpOwogICAgICAgIExSID0gZnJvbnQgLyAzOwogICAgICAgIExMID0gTFIgLSAxOwogICAgICAgIFVSID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgICAgVUwgPSBVUiArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICAgIHdhbGxJbmRpY2VzLnB1c2goZnJvbnQgLyAzKTsKICAgIH0gZWxzZSB7CiAgICAgIHdhbGxJbmRpY2VzLnB1c2goZnJvbnQgLyAzLCAoYmFjayAtIDIpIC8gMyk7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gZnJvbnQgLyAzOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IChiYWNrIC0gMikgLyAzOwogICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICB2YWx1ZXM6IGZpbmFsUG9zaXRpb25zCiAgICB9KTsKICAgIHJldHVybiB7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMsCiAgICAgIHdhbGxJbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBjb21wdXRlUG9zaXRpb25zRXh0cnVkZWQyKHBhcmFtcykgewogICAgY29uc3QgZWxsaXBzb2lkID0gcGFyYW1zLmVsbGlwc29pZDsKICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKHBhcmFtcyk7CiAgICBjb25zdCBhdHRyID0gY29tYmluZTMoY29tcHV0ZWRQb3NpdGlvbnMsIHBhcmFtcy5jb3JuZXJUeXBlKTsKICAgIGNvbnN0IHdhbGxJbmRpY2VzID0gYXR0ci53YWxsSW5kaWNlczsKICAgIGNvbnN0IGhlaWdodCA9IHBhcmFtcy5oZWlnaHQ7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IHBhcmFtcy5leHRydWRlZEhlaWdodDsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBhdHRyLmF0dHJpYnV0ZXM7CiAgICBjb25zdCBpbmRpY2VzID0gYXR0ci5pbmRpY2VzOwogICAgbGV0IHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBsZXQgZXh0cnVkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCk7CiAgICBleHRydWRlZFBvc2l0aW9ucy5zZXQocG9zaXRpb25zKTsKICAgIGNvbnN0IG5ld1Bvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoICogMik7CiAgICBwb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBleHRydWRlZFBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgZXh0cnVkZWRQb3NpdGlvbnMsCiAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBuZXdQb3NpdGlvbnMuc2V0KHBvc2l0aW9ucyk7CiAgICBuZXdQb3NpdGlvbnMuc2V0KGV4dHJ1ZGVkUG9zaXRpb25zLCBsZW5ndGgpOwogICAgYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBuZXdQb3NpdGlvbnM7CiAgICBsZW5ndGggLz0gMzsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocGFyYW1zLm9mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgbGV0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoICogMik7CiAgICAgIGlmIChwYXJhbXMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIGFwcGx5T2Zmc2V0ID0gYXBwbHlPZmZzZXQuZmlsbCgxLCAwLCBsZW5ndGgpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0VmFsdWUgPSBwYXJhbXMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBhcHBseU9mZnNldCA9IGFwcGx5T2Zmc2V0LmZpbGwoYXBwbHlPZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICB9KTsKICAgIH0KICAgIGxldCBpOwogICAgY29uc3QgaUxlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgY29uc3QgbmV3SW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBuZXdQb3NpdGlvbnMubGVuZ3RoIC8gMywKICAgICAgKGlMZW5ndGggKyB3YWxsSW5kaWNlcy5sZW5ndGgpICogMgogICAgKTsKICAgIG5ld0luZGljZXMuc2V0KGluZGljZXMpOwogICAgbGV0IGluZGV4ID0gaUxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBpTGVuZ3RoOyBpICs9IDIpIHsKICAgICAgY29uc3QgdjAyID0gaW5kaWNlc1tpXTsKICAgICAgY29uc3QgdjEyID0gaW5kaWNlc1tpICsgMV07CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSB2MDIgKyBsZW5ndGg7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSB2MTIgKyBsZW5ndGg7CiAgICB9CiAgICBsZXQgVUwsIExMOwogICAgZm9yIChpID0gMDsgaSA8IHdhbGxJbmRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIFVMID0gd2FsbEluZGljZXNbaV07CiAgICAgIExMID0gVUwgKyBsZW5ndGg7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlczogbmV3SW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5wb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLndpZHRoIiwgd2lkdGgpOwogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KQogICAgKTsKICAgIHRoaXMuX3dpZHRoID0gd2lkdGg7CiAgICB0aGlzLl9oZWlnaHQgPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9jb3JuZXJUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb3JuZXJUeXBlLCBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5IjsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gMSArIHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNjsKICB9CiAgdmFyIGNhcnRlc2lhbjEzLCBjYXJ0ZXNpYW4yMywgY2FydGVzaWFuMzMsIHNjcmF0Y2hFbGxpcHNvaWQ1LCBzY3JhdGNoT3B0aW9uczEwLCBDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0NvcnJpZG9yT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvck91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0Nvcm5lclR5cGUoKTsKICAgICAgaW5pdF9Db3JyaWRvckdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgY2FydGVzaWFuMTMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjIzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl93aWR0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2hlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY29ybmVyVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDUgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTAgPSB7CiAgICAgICAgcG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkNSwKICAgICAgICB3aWR0aDogdm9pZCAwLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgY29ybmVyVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkNSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3Qgd2lkdGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEwLnBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAud2lkdGggPSB3aWR0aDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMC5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMC5jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxMCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll93aWR0aCA9IHdpZHRoOwogICAgICAgIHJlc3VsdC5faGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX2Nvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjb3JyaWRvck91dGxpbmVHZW9tZXRyeSkgewogICAgICAgIGxldCBwb3NpdGlvbnMgPSBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IHdpZHRoID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX3dpZHRoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgcG9zaXRpb25zID0gc2NhbGVUb1N1cmZhY2UzKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBjbGVhblBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24KICAgICAgICApOwogICAgICAgIGlmIChjbGVhblBvc2l0aW9ucy5sZW5ndGggPCAyIHx8IHdpZHRoIDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04yCiAgICAgICAgKTsKICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBwb3NpdGlvbnM6IGNsZWFuUG9zaXRpb25zLAogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBjb3JuZXJUeXBlOiBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fY29ybmVyVHlwZSwKICAgICAgICAgIGdyYW51bGFyaXR5OiBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICBzYXZlQXR0cmlidXRlczogZmFsc2UKICAgICAgICB9OwogICAgICAgIGxldCBhdHRyOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICBwYXJhbXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgcGFyYW1zLmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBwYXJhbXMub2Zmc2V0QXR0cmlidXRlID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIGF0dHIgPSBjb21wdXRlUG9zaXRpb25zRXh0cnVkZWQyKHBhcmFtcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKHBhcmFtcyk7CiAgICAgICAgICBhdHRyID0gY29tYmluZTMoY29tcHV0ZWRQb3NpdGlvbnMsIHBhcmFtcy5jb3JuZXJUeXBlKTsKICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBhdHRyLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgYXR0ci5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gYXR0ci5hdHRyaWJ1dGVzOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIDMKICAgICAgICApOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogYXR0ci5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IENvcnJpZG9yT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeShjb3JyaWRvck91dGxpbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkgPSBDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICBjb3JyaWRvck91dGxpbmVHZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX2VsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Db3JyaWRvck91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkuanMKICB2YXIgQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnksIEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N5bGluZGVyR2VvbWV0cnlMaWJyYXJ5LmpzIigpIHsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5ID0ge307CiAgICAgIEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVQb3NpdGlvbnMgPSBmdW5jdGlvbihsZW5ndGgsIHRvcFJhZGl1cywgYm90dG9tUmFkaXVzLCBzbGljZXMsIGZpbGwpIHsKICAgICAgICBjb25zdCB0b3BaID0gbGVuZ3RoICogMC41OwogICAgICAgIGNvbnN0IGJvdHRvbVogPSAtdG9wWjsKICAgICAgICBjb25zdCB0d29TbGljZSA9IHNsaWNlcyArIHNsaWNlczsKICAgICAgICBjb25zdCBzaXplID0gZmlsbCA/IDIgKiB0d29TbGljZSA6IHR3b1NsaWNlOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSAqIDMpOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgbGV0IHRiSW5kZXggPSAwOwogICAgICAgIGNvbnN0IGJvdHRvbU9mZnNldCA9IGZpbGwgPyB0d29TbGljZSAqIDMgOiAwOwogICAgICAgIGNvbnN0IHRvcE9mZnNldCA9IGZpbGwgPyAodHdvU2xpY2UgKyBzbGljZXMpICogMyA6IHNsaWNlcyAqIDM7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlczsgaSsrKSB7CiAgICAgICAgICBjb25zdCBhbmdsZSA9IGkgLyBzbGljZXMgKiBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICAgIGNvbnN0IHkgPSBNYXRoLnNpbihhbmdsZSk7CiAgICAgICAgICBjb25zdCBib3R0b21YID0geCAqIGJvdHRvbVJhZGl1czsKICAgICAgICAgIGNvbnN0IGJvdHRvbVkgPSB5ICogYm90dG9tUmFkaXVzOwogICAgICAgICAgY29uc3QgdG9wWCA9IHggKiB0b3BSYWRpdXM7CiAgICAgICAgICBjb25zdCB0b3BZID0geSAqIHRvcFJhZGl1czsKICAgICAgICAgIHBvc2l0aW9uc1t0YkluZGV4ICsgYm90dG9tT2Zmc2V0XSA9IGJvdHRvbVg7CiAgICAgICAgICBwb3NpdGlvbnNbdGJJbmRleCArIGJvdHRvbU9mZnNldCArIDFdID0gYm90dG9tWTsKICAgICAgICAgIHBvc2l0aW9uc1t0YkluZGV4ICsgYm90dG9tT2Zmc2V0ICsgMl0gPSBib3R0b21aOwogICAgICAgICAgcG9zaXRpb25zW3RiSW5kZXggKyB0b3BPZmZzZXRdID0gdG9wWDsKICAgICAgICAgIHBvc2l0aW9uc1t0YkluZGV4ICsgdG9wT2Zmc2V0ICsgMV0gPSB0b3BZOwogICAgICAgICAgcG9zaXRpb25zW3RiSW5kZXggKyB0b3BPZmZzZXQgKyAyXSA9IHRvcFo7CiAgICAgICAgICB0YkluZGV4ICs9IDM7CiAgICAgICAgICBpZiAoZmlsbCkgewogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBib3R0b21YOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBib3R0b21ZOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBib3R0b21aOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSB0b3BYOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSB0b3BZOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSB0b3BaOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcG9zaXRpb25zOwogICAgICB9OwogICAgICBDeWxpbmRlckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DeWxpbmRlckdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gQ3lsaW5kZXJHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IGxlbmd0aCA9IG9wdGlvbnMubGVuZ3RoOwogICAgY29uc3QgdG9wUmFkaXVzID0gb3B0aW9ucy50b3BSYWRpdXM7CiAgICBjb25zdCBib3R0b21SYWRpdXMgPSBvcHRpb25zLmJvdHRvbVJhZGl1czsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIGNvbnN0IHNsaWNlcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2xpY2VzLCAxMjgpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVuZ3RoKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5sZW5ndGggbXVzdCBiZSBkZWZpbmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodG9wUmFkaXVzKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy50b3BSYWRpdXMgbXVzdCBiZSBkZWZpbmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm90dG9tUmFkaXVzKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5ib3R0b21SYWRpdXMgbXVzdCBiZSBkZWZpbmVkLiIpOwogICAgfQogICAgaWYgKHNsaWNlcyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMuc2xpY2VzIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIDMuIgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkgJiYgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5UT1AgaXMgbm90IGEgc3VwcG9ydGVkIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlIGZvciB0aGlzIGdlb21ldHJ5LiIKICAgICAgKTsKICAgIH0KICAgIHRoaXMuX2xlbmd0aCA9IGxlbmd0aDsKICAgIHRoaXMuX3RvcFJhZGl1cyA9IHRvcFJhZGl1czsKICAgIHRoaXMuX2JvdHRvbVJhZGl1cyA9IGJvdHRvbVJhZGl1czsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9zbGljZXMgPSBzbGljZXM7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeSI7CiAgfQogIHZhciByYWRpdXNTY3JhdGNoLCBub3JtYWxTY3JhdGNoMywgYml0YW5nZW50U2NyYXRjaCwgdGFuZ2VudFNjcmF0Y2gsIHBvc2l0aW9uU2NyYXRjaCwgc2NyYXRjaFZlcnRleEZvcm1hdDUsIHNjcmF0Y2hPcHRpb25zMTEsIHVuaXRDeWxpbmRlckdlb21ldHJ5LCBDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ3lsaW5kZXJHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3lsaW5kZXJHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgcmFkaXVzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgbm9ybWFsU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJpdGFuZ2VudFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRhbmdlbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwb3NpdGlvblNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEN5bGluZGVyR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fdG9wUmFkaXVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYm90dG9tUmFkaXVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2xpY2VzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDUgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxMSA9IHsKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ1LAogICAgICAgIGxlbmd0aDogdm9pZCAwLAogICAgICAgIHRvcFJhZGl1czogdm9pZCAwLAogICAgICAgIGJvdHRvbVJhZGl1czogdm9pZCAwLAogICAgICAgIHNsaWNlczogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEN5bGluZGVyR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NQogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCB0b3BSYWRpdXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGJvdHRvbVJhZGl1cyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2xpY2VzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczExLmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTEudG9wUmFkaXVzID0gdG9wUmFkaXVzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMS5ib3R0b21SYWRpdXMgPSBib3R0b21SYWRpdXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczExLnNsaWNlcyA9IHNsaWNlczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTEub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgQ3lsaW5kZXJHZW9tZXRyeShzY3JhdGNoT3B0aW9uczExKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX2xlbmd0aCA9IGxlbmd0aDsKICAgICAgICByZXN1bHQuX3RvcFJhZGl1cyA9IHRvcFJhZGl1czsKICAgICAgICByZXN1bHQuX2JvdHRvbVJhZGl1cyA9IGJvdHRvbVJhZGl1czsKICAgICAgICByZXN1bHQuX3NsaWNlcyA9IHNsaWNlczsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGN5bGluZGVyR2VvbWV0cnkpIHsKICAgICAgICBsZXQgbGVuZ3RoID0gY3lsaW5kZXJHZW9tZXRyeS5fbGVuZ3RoOwogICAgICAgIGNvbnN0IHRvcFJhZGl1cyA9IGN5bGluZGVyR2VvbWV0cnkuX3RvcFJhZGl1czsKICAgICAgICBjb25zdCBib3R0b21SYWRpdXMgPSBjeWxpbmRlckdlb21ldHJ5Ll9ib3R0b21SYWRpdXM7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gY3lsaW5kZXJHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IHNsaWNlcyA9IGN5bGluZGVyR2VvbWV0cnkuX3NsaWNlczsKICAgICAgICBpZiAobGVuZ3RoIDw9IDAgfHwgdG9wUmFkaXVzIDwgMCB8fCBib3R0b21SYWRpdXMgPCAwIHx8IHRvcFJhZGl1cyA9PT0gMCAmJiBib3R0b21SYWRpdXMgPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdHdvU2xpY2VzID0gc2xpY2VzICsgc2xpY2VzOwogICAgICAgIGNvbnN0IHRocmVlU2xpY2VzID0gc2xpY2VzICsgdHdvU2xpY2VzOwogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gdHdvU2xpY2VzICsgdHdvU2xpY2VzOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9ucygKICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgIHRvcFJhZGl1cywKICAgICAgICAgIGJvdHRvbVJhZGl1cywKICAgICAgICAgIHNsaWNlcywKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0ID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDIpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDMpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMykgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMykgOiB2b2lkIDA7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgY29tcHV0ZU5vcm1hbCA9IHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudDsKICAgICAgICBpZiAoY29tcHV0ZU5vcm1hbCkgewogICAgICAgICAgY29uc3QgY29tcHV0ZVRhbmdlbnQgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50OwogICAgICAgICAgbGV0IG5vcm1hbEluZGV4ID0gMDsKICAgICAgICAgIGxldCB0YW5nZW50SW5kZXggPSAwOwogICAgICAgICAgbGV0IGJpdGFuZ2VudEluZGV4ID0gMDsKICAgICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aC5hdGFuMihib3R0b21SYWRpdXMgLSB0b3BSYWRpdXMsIGxlbmd0aCk7CiAgICAgICAgICBjb25zdCBub3JtYWwyID0gbm9ybWFsU2NyYXRjaDM7CiAgICAgICAgICBub3JtYWwyLnogPSBNYXRoLnNpbih0aGV0YSk7CiAgICAgICAgICBjb25zdCBub3JtYWxTY2FsZTIgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICAgICAgICBsZXQgdGFuZ2VudCA9IHRhbmdlbnRTY3JhdGNoOwogICAgICAgICAgbGV0IGJpdGFuZ2VudCA9IGJpdGFuZ2VudFNjcmF0Y2g7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBpIC8gc2xpY2VzICogTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgICAgY29uc3QgeCA9IG5vcm1hbFNjYWxlMiAqIE1hdGguY29zKGFuZ2xlKTsKICAgICAgICAgICAgY29uc3QgeSA9IG5vcm1hbFNjYWxlMiAqIE1hdGguc2luKGFuZ2xlKTsKICAgICAgICAgICAgaWYgKGNvbXB1dGVOb3JtYWwpIHsKICAgICAgICAgICAgICBub3JtYWwyLnggPSB4OwogICAgICAgICAgICAgIG5vcm1hbDIueSA9IHk7CiAgICAgICAgICAgICAgaWYgKGNvbXB1dGVUYW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIG5vcm1hbDIsIHRhbmdlbnQpLAogICAgICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLnk7CiAgICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi56OwogICAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLnk7CiAgICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi56OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lno7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lno7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzOyBpKyspIHsKICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gMDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gMDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gMTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gLTE7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXM7IGkrKykgewogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IDE7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IDE7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IDEyICogc2xpY2VzIC0gMTI7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KG51bVZlcnRpY2VzLCBudW1JbmRpY2VzKTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGxldCBqID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzIC0gMTsgaSsrKSB7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gajsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgMjsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgMzsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyAzOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyAxOwogICAgICAgICAgaiArPSAyOwogICAgICAgIH0KICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzIC0gMjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gMDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzIC0gMjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzIC0gMTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgc2xpY2VzIC0gMTsgaSsrKSB7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzICsgaSArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzICsgaTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0d29TbGljZXM7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDE7IGkgPCBzbGljZXMgLSAxOyBpKyspIHsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0aHJlZVNsaWNlczsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0aHJlZVNsaWNlcyArIGk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdGhyZWVTbGljZXMgKyBpICsgMTsKICAgICAgICB9CiAgICAgICAgbGV0IHRleHR1cmVDb29yZEluZGV4ID0gMDsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICBjb25zdCByYWQgPSBNYXRoLm1heCh0b3BSYWRpdXMsIGJvdHRvbVJhZGl1cyk7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpICogMywgcG9zaXRpb25TY3JhdGNoKTsKICAgICAgICAgICAgc3RbdGV4dHVyZUNvb3JkSW5kZXgrK10gPSAocG9zaXRpb24ueCArIHJhZCkgLyAoMiAqIHJhZCk7CiAgICAgICAgICAgIHN0W3RleHR1cmVDb29yZEluZGV4KytdID0gKHBvc2l0aW9uLnkgKyByYWQpIC8gKDIgKiByYWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IHN0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmFkaXVzU2NyYXRjaC54ID0gbGVuZ3RoICogMC41OwogICAgICAgIHJhZGl1c1NjcmF0Y2gueSA9IE1hdGgubWF4KGJvdHRvbVJhZGl1cywgdG9wUmFkaXVzKTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubWFnbml0dWRlKHJhZGl1c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogY3lsaW5kZXJHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEN5bGluZGVyR2VvbWV0cnkuZ2V0VW5pdEN5bGluZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodW5pdEN5bGluZGVyR2VvbWV0cnkpKSB7CiAgICAgICAgICB1bml0Q3lsaW5kZXJHZW9tZXRyeSA9IEN5bGluZGVyR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkoCiAgICAgICAgICAgIG5ldyBDeWxpbmRlckdlb21ldHJ5KHsKICAgICAgICAgICAgICB0b3BSYWRpdXM6IDEsCiAgICAgICAgICAgICAgYm90dG9tUmFkaXVzOiAxLAogICAgICAgICAgICAgIGxlbmd0aDogMSwKICAgICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFkKICAgICAgICAgICAgfSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bml0Q3lsaW5kZXJHZW9tZXRyeTsKICAgICAgfTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0ID0gQ3lsaW5kZXJHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDeWxpbmRlckdlb21ldHJ5KGN5bGluZGVyR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGN5bGluZGVyR2VvbWV0cnkgPSBDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGN5bGluZGVyR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGN5bGluZGVyR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0N5bGluZGVyR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNyZWF0ZUN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUN5bGluZGVyR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DeWxpbmRlck91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgbGVuZ3RoID0gb3B0aW9ucy5sZW5ndGg7CiAgICBjb25zdCB0b3BSYWRpdXMgPSBvcHRpb25zLnRvcFJhZGl1czsKICAgIGNvbnN0IGJvdHRvbVJhZGl1cyA9IG9wdGlvbnMuYm90dG9tUmFkaXVzOwogICAgY29uc3Qgc2xpY2VzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zbGljZXMsIDEyOCk7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2FsTGluZXMgPSBNYXRoLm1heCgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5udW1iZXJPZlZlcnRpY2FsTGluZXMsIDE2KSwKICAgICAgMAogICAgKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigib3B0aW9ucy5wb3NpdGlvbnMiLCBsZW5ndGgpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLnRvcFJhZGl1cyIsIHRvcFJhZGl1cyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMuYm90dG9tUmFkaXVzIiwgYm90dG9tUmFkaXVzKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJvcHRpb25zLnNsaWNlcyIsIHNsaWNlcywgMyk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSAmJiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLlRPUCBpcyBub3QgYSBzdXBwb3J0ZWQgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgZm9yIHRoaXMgZ2VvbWV0cnkuIgogICAgICApOwogICAgfQogICAgdGhpcy5fbGVuZ3RoID0gbGVuZ3RoOwogICAgdGhpcy5fdG9wUmFkaXVzID0gdG9wUmFkaXVzOwogICAgdGhpcy5fYm90dG9tUmFkaXVzID0gYm90dG9tUmFkaXVzOwogICAgdGhpcy5fc2xpY2VzID0gc2xpY2VzOwogICAgdGhpcy5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIHJhZGl1c1NjcmF0Y2gyLCBzY3JhdGNoT3B0aW9uczEyLCBDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0N5bGluZGVyT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DeWxpbmRlck91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9DeWxpbmRlckdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIHJhZGl1c1NjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBDeWxpbmRlck91dGxpbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSA2OwogICAgICBDeWxpbmRlck91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2xlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3RvcFJhZGl1czsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2JvdHRvbVJhZGl1czsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NsaWNlczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX251bWJlck9mVmVydGljYWxMaW5lczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hPcHRpb25zMTIgPSB7CiAgICAgICAgbGVuZ3RoOiB2b2lkIDAsCiAgICAgICAgdG9wUmFkaXVzOiB2b2lkIDAsCiAgICAgICAgYm90dG9tUmFkaXVzOiB2b2lkIDAsCiAgICAgICAgc2xpY2VzOiB2b2lkIDAsCiAgICAgICAgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgdG9wUmFkaXVzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBib3R0b21SYWRpdXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNsaWNlcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEyLmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTIudG9wUmFkaXVzID0gdG9wUmFkaXVzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMi5ib3R0b21SYWRpdXMgPSBib3R0b21SYWRpdXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEyLnNsaWNlcyA9IHNsaWNlczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTIubnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMi5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBDeWxpbmRlck91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczEyKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgcmVzdWx0Ll90b3BSYWRpdXMgPSB0b3BSYWRpdXM7CiAgICAgICAgcmVzdWx0Ll9ib3R0b21SYWRpdXMgPSBib3R0b21SYWRpdXM7CiAgICAgICAgcmVzdWx0Ll9zbGljZXMgPSBzbGljZXM7CiAgICAgICAgcmVzdWx0Ll9udW1iZXJPZlZlcnRpY2FsTGluZXMgPSBudW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oY3lsaW5kZXJHZW9tZXRyeSkgewogICAgICAgIGxldCBsZW5ndGggPSBjeWxpbmRlckdlb21ldHJ5Ll9sZW5ndGg7CiAgICAgICAgY29uc3QgdG9wUmFkaXVzID0gY3lsaW5kZXJHZW9tZXRyeS5fdG9wUmFkaXVzOwogICAgICAgIGNvbnN0IGJvdHRvbVJhZGl1cyA9IGN5bGluZGVyR2VvbWV0cnkuX2JvdHRvbVJhZGl1czsKICAgICAgICBjb25zdCBzbGljZXMgPSBjeWxpbmRlckdlb21ldHJ5Ll9zbGljZXM7CiAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gY3lsaW5kZXJHZW9tZXRyeS5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIGlmIChsZW5ndGggPD0gMCB8fCB0b3BSYWRpdXMgPCAwIHx8IGJvdHRvbVJhZGl1cyA8IDAgfHwgdG9wUmFkaXVzID09PSAwICYmIGJvdHRvbVJhZGl1cyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IHNsaWNlcyAqIDI7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKAogICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgdG9wUmFkaXVzLAogICAgICAgICAgYm90dG9tUmFkaXVzLAogICAgICAgICAgc2xpY2VzLAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGxldCBudW1JbmRpY2VzID0gc2xpY2VzICogMjsKICAgICAgICBsZXQgbnVtU2lkZTsKICAgICAgICBpZiAobnVtYmVyT2ZWZXJ0aWNhbExpbmVzID4gMCkgewogICAgICAgICAgY29uc3QgbnVtU2lkZUxpbmVzID0gTWF0aC5taW4obnVtYmVyT2ZWZXJ0aWNhbExpbmVzLCBzbGljZXMpOwogICAgICAgICAgbnVtU2lkZSA9IE1hdGgucm91bmQoc2xpY2VzIC8gbnVtU2lkZUxpbmVzKTsKICAgICAgICAgIG51bUluZGljZXMgKz0gbnVtU2lkZUxpbmVzOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIG51bUluZGljZXMgKiAyKTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXMgLSAxOyBpKyspIHsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBzbGljZXM7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDEgKyBzbGljZXM7CiAgICAgICAgfQogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzbGljZXMgLSAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSAwOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzbGljZXMgKyBzbGljZXMgLSAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzbGljZXM7CiAgICAgICAgaWYgKG51bWJlck9mVmVydGljYWxMaW5lcyA+IDApIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXM7IGkgKz0gbnVtU2lkZSkgewogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBzbGljZXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgcmFkaXVzU2NyYXRjaDIueCA9IGxlbmd0aCAqIDAuNTsKICAgICAgICByYWRpdXNTY3JhdGNoMi55ID0gTWF0aC5tYXgoYm90dG9tUmFkaXVzLCB0b3BSYWRpdXMpOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tYWduaXR1ZGUocmFkaXVzU2NyYXRjaDIpCiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBjeWxpbmRlckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IEN5bGluZGVyT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeShjeWxpbmRlckdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjeWxpbmRlckdlb21ldHJ5ID0gQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soY3lsaW5kZXJHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGN5bGluZGVyR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0N5bGluZGVyT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNlR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRWxsaXBzZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVFbGxpcHNlR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVFbGxpcHNlR2VvbWV0cnkoZWxsaXBzZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBlbGxpcHNlR2VvbWV0cnkgPSBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soZWxsaXBzZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIpOwogICAgZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoZWxsaXBzZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUVsbGlwc2VHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc2VHZW9tZXRyeSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBjcmVhdGVFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUVsbGlwc2VHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5KGVsbGlwc2VHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgZWxsaXBzZUdlb21ldHJ5ID0gRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhlbGxpcHNlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNlR2VvbWV0cnkuX2NlbnRlcik7CiAgICBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoZWxsaXBzZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc2VPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZEdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gRWxsaXBzb2lkR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCByYWRpaSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucmFkaWksIGRlZmF1bHRSYWRpaSk7CiAgICBjb25zdCBpbm5lclJhZGlpID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5pbm5lclJhZGlpLCByYWRpaSk7CiAgICBjb25zdCBtaW5pbXVtQ2xvY2sgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1DbG9jaywgMCk7CiAgICBjb25zdCBtYXhpbXVtQ2xvY2sgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1heGltdW1DbG9jaywgTWF0aF9kZWZhdWx0LlRXT19QSSk7CiAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUNvbmUsIDApOwogICAgY29uc3QgbWF4aW11bUNvbmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1heGltdW1Db25lLCBNYXRoX2RlZmF1bHQuUEkpOwogICAgY29uc3Qgc3RhY2tQYXJ0aXRpb25zID0gTWF0aC5yb3VuZChkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0YWNrUGFydGl0aW9ucywgNjQpKTsKICAgIGNvbnN0IHNsaWNlUGFydGl0aW9ucyA9IE1hdGgucm91bmQoZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zbGljZVBhcnRpdGlvbnMsIDY0KSk7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICBpZiAoc2xpY2VQYXJ0aXRpb25zIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5zbGljZVBhcnRpdGlvbnMgY2Fubm90IGJlIGxlc3MgdGhhbiB0aHJlZS4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoc3RhY2tQYXJ0aXRpb25zIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5zdGFja1BhcnRpdGlvbnMgY2Fubm90IGJlIGxlc3MgdGhhbiB0aHJlZS4iCiAgICAgICk7CiAgICB9CiAgICB0aGlzLl9yYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyYWRpaSk7CiAgICB0aGlzLl9pbm5lclJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGlubmVyUmFkaWkpOwogICAgdGhpcy5fbWluaW11bUNsb2NrID0gbWluaW11bUNsb2NrOwogICAgdGhpcy5fbWF4aW11bUNsb2NrID0gbWF4aW11bUNsb2NrOwogICAgdGhpcy5fbWluaW11bUNvbmUgPSBtaW5pbXVtQ29uZTsKICAgIHRoaXMuX21heGltdW1Db25lID0gbWF4aW11bUNvbmU7CiAgICB0aGlzLl9zdGFja1BhcnRpdGlvbnMgPSBzdGFja1BhcnRpdGlvbnM7CiAgICB0aGlzLl9zbGljZVBhcnRpdGlvbnMgPSBzbGljZVBhcnRpdGlvbnM7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQpOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hQb3NpdGlvbjIsIHNjcmF0Y2hOb3JtYWw1LCBzY3JhdGNoVGFuZ2VudDMsIHNjcmF0Y2hCaXRhbmdlbnQzLCBzY3JhdGNoTm9ybWFsU1QsIGRlZmF1bHRSYWRpaSwgY29zLCBzaW4sIHNjcmF0Y2hSYWRpaSwgc2NyYXRjaElubmVyUmFkaWksIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ2LCBzY3JhdGNoT3B0aW9uczEzLCB1bml0RWxsaXBzb2lkR2VvbWV0cnksIEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzb2lkR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgc2NyYXRjaFBvc2l0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbDUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUYW5nZW50MyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJpdGFuZ2VudDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWxTVCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZGVmYXVsdFJhZGlpID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKTsKICAgICAgY29zID0gTWF0aC5jb3M7CiAgICAgIHNpbiA9IE1hdGguc2luOwogICAgICBFbGxpcHNvaWRHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSAyICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDc7CiAgICAgIEVsbGlwc29pZEdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX3JhZGlpLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9pbm5lclJhZGlpLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWluaW11bUNsb2NrOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWF4aW11bUNsb2NrOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWluaW11bUNvbmU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9tYXhpbXVtQ29uZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0YWNrUGFydGl0aW9uczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NsaWNlUGFydGl0aW9uczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaElubmVyUmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ2ID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTMgPSB7CiAgICAgICAgcmFkaWk6IHNjcmF0Y2hSYWRpaSwKICAgICAgICBpbm5lclJhZGlpOiBzY3JhdGNoSW5uZXJSYWRpaSwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ2LAogICAgICAgIG1pbmltdW1DbG9jazogdm9pZCAwLAogICAgICAgIG1heGltdW1DbG9jazogdm9pZCAwLAogICAgICAgIG1pbmltdW1Db25lOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUNvbmU6IHZvaWQgMCwKICAgICAgICBzdGFja1BhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzbGljZVBhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBFbGxpcHNvaWRHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaFJhZGlpKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgaW5uZXJSYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hJbm5lclJhZGlpKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDYKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbWF4aW11bUNsb2NrID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbWF4aW11bUNvbmUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN0YWNrUGFydGl0aW9ucyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2xpY2VQYXJ0aXRpb25zID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEzLm1pbmltdW1DbG9jayA9IG1pbmltdW1DbG9jazsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTMubWF4aW11bUNsb2NrID0gbWF4aW11bUNsb2NrOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5taW5pbXVtQ29uZSA9IG1pbmltdW1Db25lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5tYXhpbXVtQ29uZSA9IG1heGltdW1Db25lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5zdGFja1BhcnRpdGlvbnMgPSBzdGFja1BhcnRpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEzLnNsaWNlUGFydGl0aW9ucyA9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTMub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgRWxsaXBzb2lkR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxMyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmFkaWksIHJlc3VsdC5fcmFkaWkpOwogICAgICAgIHJlc3VsdC5faW5uZXJSYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbm5lclJhZGlpLCByZXN1bHQuX2lubmVyUmFkaWkpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtQ2xvY2sgPSBtaW5pbXVtQ2xvY2s7CiAgICAgICAgcmVzdWx0Ll9tYXhpbXVtQ2xvY2sgPSBtYXhpbXVtQ2xvY2s7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtQ29uZSA9IG1pbmltdW1Db25lOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUNvbmUgPSBtYXhpbXVtQ29uZTsKICAgICAgICByZXN1bHQuX3N0YWNrUGFydGl0aW9ucyA9IHN0YWNrUGFydGl0aW9uczsKICAgICAgICByZXN1bHQuX3NsaWNlUGFydGl0aW9ucyA9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihlbGxpcHNvaWRHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHJhZGlpID0gZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpOwogICAgICAgIGlmIChyYWRpaS54IDw9IDAgfHwgcmFkaWkueSA8PSAwIHx8IHJhZGlpLnogPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbm5lclJhZGlpID0gZWxsaXBzb2lkR2VvbWV0cnkuX2lubmVyUmFkaWk7CiAgICAgICAgaWYgKGlubmVyUmFkaWkueCA8PSAwIHx8IGlubmVyUmFkaWkueSA8PSAwIHx8IGlubmVyUmFkaWkueiA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGVsbGlwc29pZEdlb21ldHJ5Ll9taW5pbXVtQ2xvY2s7CiAgICAgICAgY29uc3QgbWF4aW11bUNsb2NrID0gZWxsaXBzb2lkR2VvbWV0cnkuX21heGltdW1DbG9jazsKICAgICAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9taW5pbXVtQ29uZTsKICAgICAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9tYXhpbXVtQ29uZTsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBlbGxpcHNvaWRHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGxldCBzbGljZVBhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc2xpY2VQYXJ0aXRpb25zICsgMTsKICAgICAgICBsZXQgc3RhY2tQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3N0YWNrUGFydGl0aW9ucyArIDE7CiAgICAgICAgc2xpY2VQYXJ0aXRpb25zID0gTWF0aC5yb3VuZCgKICAgICAgICAgIHNsaWNlUGFydGl0aW9ucyAqIE1hdGguYWJzKG1heGltdW1DbG9jayAtIG1pbmltdW1DbG9jaykgLyBNYXRoX2RlZmF1bHQuVFdPX1BJCiAgICAgICAgKTsKICAgICAgICBzdGFja1BhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKAogICAgICAgICAgc3RhY2tQYXJ0aXRpb25zICogTWF0aC5hYnMobWF4aW11bUNvbmUgLSBtaW5pbXVtQ29uZSkgLyBNYXRoX2RlZmF1bHQuUEkKICAgICAgICApOwogICAgICAgIGlmIChzbGljZVBhcnRpdGlvbnMgPCAyKSB7CiAgICAgICAgICBzbGljZVBhcnRpdGlvbnMgPSAyOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhY2tQYXJ0aXRpb25zIDwgMikgewogICAgICAgICAgc3RhY2tQYXJ0aXRpb25zID0gMjsKICAgICAgICB9CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBjb25zdCBwaGlzID0gW21pbmltdW1Db25lXTsKICAgICAgICBjb25zdCB0aGV0YXMgPSBbbWluaW11bUNsb2NrXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3RhY2tQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgIHBoaXMucHVzaCgKICAgICAgICAgICAgbWluaW11bUNvbmUgKyBpICogKG1heGltdW1Db25lIC0gbWluaW11bUNvbmUpIC8gKHN0YWNrUGFydGl0aW9ucyAtIDEpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBwaGlzLnB1c2gobWF4aW11bUNvbmUpOwogICAgICAgIGZvciAoaiA9IDA7IGogPCBzbGljZVBhcnRpdGlvbnM7IGorKykgewogICAgICAgICAgdGhldGFzLnB1c2goCiAgICAgICAgICAgIG1pbmltdW1DbG9jayArIGogKiAobWF4aW11bUNsb2NrIC0gbWluaW11bUNsb2NrKSAvIChzbGljZVBhcnRpdGlvbnMgLSAxKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgdGhldGFzLnB1c2gobWF4aW11bUNsb2NrKTsKICAgICAgICBjb25zdCBudW1QaGlzID0gcGhpcy5sZW5ndGg7CiAgICAgICAgY29uc3QgbnVtVGhldGFzID0gdGhldGFzLmxlbmd0aDsKICAgICAgICBsZXQgZXh0cmFJbmRpY2VzID0gMDsKICAgICAgICBsZXQgdmVydGV4TXVsdGlwbGllciA9IDE7CiAgICAgICAgY29uc3QgaGFzSW5uZXJTdXJmYWNlID0gaW5uZXJSYWRpaS54ICE9PSByYWRpaS54IHx8IGlubmVyUmFkaWkueSAhPT0gcmFkaWkueSB8fCBpbm5lclJhZGlpLnogIT09IHJhZGlpLno7CiAgICAgICAgbGV0IGlzVG9wT3BlbiA9IGZhbHNlOwogICAgICAgIGxldCBpc0JvdE9wZW4gPSBmYWxzZTsKICAgICAgICBsZXQgaXNDbG9ja09wZW4gPSBmYWxzZTsKICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICB2ZXJ0ZXhNdWx0aXBsaWVyID0gMjsKICAgICAgICAgIGlmIChtaW5pbXVtQ29uZSA+IDApIHsKICAgICAgICAgICAgaXNUb3BPcGVuID0gdHJ1ZTsKICAgICAgICAgICAgZXh0cmFJbmRpY2VzICs9IHNsaWNlUGFydGl0aW9ucyAtIDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF4aW11bUNvbmUgPCBNYXRoLlBJKSB7CiAgICAgICAgICAgIGlzQm90T3BlbiA9IHRydWU7CiAgICAgICAgICAgIGV4dHJhSW5kaWNlcyArPSBzbGljZVBhcnRpdGlvbnMgLSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChtYXhpbXVtQ2xvY2sgLSBtaW5pbXVtQ2xvY2spICUgTWF0aF9kZWZhdWx0LlRXT19QSSkgewogICAgICAgICAgICBpc0Nsb2NrT3BlbiA9IHRydWU7CiAgICAgICAgICAgIGV4dHJhSW5kaWNlcyArPSAoc3RhY2tQYXJ0aXRpb25zIC0gMSkgKiAyICsgMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4dHJhSW5kaWNlcyArPSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IG51bVRoZXRhcyAqIG51bVBoaXMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkodmVydGV4Q291bnQgKiAzKTsKICAgICAgICBjb25zdCBpc0lubmVyID0gbmV3IEFycmF5KHZlcnRleENvdW50KS5maWxsKGZhbHNlKTsKICAgICAgICBjb25zdCBuZWdhdGVOb3JtYWwgPSBuZXcgQXJyYXkodmVydGV4Q291bnQpLmZpbGwoZmFsc2UpOwogICAgICAgIGNvbnN0IGluZGV4Q291bnQgPSBzbGljZVBhcnRpdGlvbnMgKiBzdGFja1BhcnRpdGlvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOwogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSA2ICogKGluZGV4Q291bnQgKyBleHRyYUluZGljZXMgKyAxIC0gKHNsaWNlUGFydGl0aW9ucyArIHN0YWNrUGFydGl0aW9ucykgKiB2ZXJ0ZXhNdWx0aXBsaWVyKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoaW5kZXhDb3VudCwgbnVtSW5kaWNlcyk7CiAgICAgICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogMykgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAzKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAzKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBzdCA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAyKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBzaW5QaGkgPSBuZXcgQXJyYXkobnVtUGhpcyk7CiAgICAgICAgY29uc3QgY29zUGhpID0gbmV3IEFycmF5KG51bVBoaXMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1QaGlzOyBpKyspIHsKICAgICAgICAgIHNpblBoaVtpXSA9IHNpbihwaGlzW2ldKTsKICAgICAgICAgIGNvc1BoaVtpXSA9IGNvcyhwaGlzW2ldKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2luVGhldGEgPSBuZXcgQXJyYXkobnVtVGhldGFzKTsKICAgICAgICBjb25zdCBjb3NUaGV0YSA9IG5ldyBBcnJheShudW1UaGV0YXMpOwogICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1UaGV0YXM7IGorKykgewogICAgICAgICAgY29zVGhldGFbal0gPSBjb3ModGhldGFzW2pdKTsKICAgICAgICAgIHNpblRoZXRhW2pdID0gc2luKHRoZXRhc1tqXSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1QaGlzOyBpKyspIHsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1UaGV0YXM7IGorKykgewogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS54ICogc2luUGhpW2ldICogY29zVGhldGFbal07CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnkgKiBzaW5QaGlbaV0gKiBzaW5UaGV0YVtqXTsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueiAqIGNvc1BoaVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IHZlcnRleEluZGV4ID0gdmVydGV4Q291bnQgLyAyOwogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1QaGlzOyBpKyspIHsKICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IG51bVRoZXRhczsgaisrKSB7CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS54ICogc2luUGhpW2ldICogY29zVGhldGFbal07CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS55ICogc2luUGhpW2ldICogc2luVGhldGFbal07CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS56ICogY29zUGhpW2ldOwogICAgICAgICAgICAgIGlzSW5uZXJbdmVydGV4SW5kZXhdID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAoaSA+IDAgJiYgaSAhPT0gbnVtUGhpcyAtIDEgJiYgaiAhPT0gMCAmJiBqICE9PSBudW1UaGV0YXMgLSAxKSB7CiAgICAgICAgICAgICAgICBuZWdhdGVOb3JtYWxbdmVydGV4SW5kZXhdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmVydGV4SW5kZXgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgbGV0IHRvcE9mZnNldDsKICAgICAgICBsZXQgYm90dG9tT2Zmc2V0OwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBudW1QaGlzIC0gMjsgaSsrKSB7CiAgICAgICAgICB0b3BPZmZzZXQgPSBpICogbnVtVGhldGFzOwogICAgICAgICAgYm90dG9tT2Zmc2V0ID0gKGkgKyAxKSAqIG51bVRoZXRhczsKICAgICAgICAgIGZvciAoaiA9IDE7IGogPCBudW1UaGV0YXMgLSAyOyBqKyspIHsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbU9mZnNldCArIGo7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21PZmZzZXQgKyBqICsgMTsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGogKyAxOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tT2Zmc2V0ICsgajsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGogKyAxOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgajsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbnVtUGhpcyAqIG51bVRoZXRhczsKICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBudW1QaGlzIC0gMjsgaSsrKSB7CiAgICAgICAgICAgIHRvcE9mZnNldCA9IG9mZnNldCArIGkgKiBudW1UaGV0YXM7CiAgICAgICAgICAgIGJvdHRvbU9mZnNldCA9IG9mZnNldCArIChpICsgMSkgKiBudW1UaGV0YXM7CiAgICAgICAgICAgIGZvciAoaiA9IDE7IGogPCBudW1UaGV0YXMgLSAyOyBqKyspIHsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tT2Zmc2V0ICsgajsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgajsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgaiArIDE7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbU9mZnNldCArIGo7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGogKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21PZmZzZXQgKyBqICsgMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgb3V0ZXJPZmZzZXQ7CiAgICAgICAgbGV0IGlubmVyT2Zmc2V0OwogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGlmIChpc1RvcE9wZW4pIHsKICAgICAgICAgICAgaW5uZXJPZmZzZXQgPSBudW1QaGlzICogbnVtVGhldGFzOwogICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtVGhldGFzIC0gMjsgaSsrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGkgKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGkgKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0JvdE9wZW4pIHsKICAgICAgICAgICAgb3V0ZXJPZmZzZXQgPSBudW1QaGlzICogbnVtVGhldGFzIC0gbnVtVGhldGFzOwogICAgICAgICAgICBpbm5lck9mZnNldCA9IG51bVBoaXMgKiBudW1UaGV0YXMgKiB2ZXJ0ZXhNdWx0aXBsaWVyIC0gbnVtVGhldGFzOwogICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtVGhldGFzIC0gMjsgaSsrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgaSArIDE7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIGkgKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaSArIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzQ2xvY2tPcGVuKSB7CiAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUGhpcyAtIDI7IGkrKykgewogICAgICAgICAgICBpbm5lck9mZnNldCA9IG51bVRoZXRhcyAqIG51bVBoaXMgKyBudW1UaGV0YXMgKiBpOwogICAgICAgICAgICBvdXRlck9mZnNldCA9IG51bVRoZXRhcyAqIGk7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldDsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQ7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldDsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBudW1UaGV0YXM7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUGhpcyAtIDI7IGkrKykgewogICAgICAgICAgICBpbm5lck9mZnNldCA9IG51bVRoZXRhcyAqIG51bVBoaXMgKyBudW1UaGV0YXMgKiAoaSArIDEpIC0gMTsKICAgICAgICAgICAgb3V0ZXJPZmZzZXQgPSBudW1UaGV0YXMgKiAoaSArIDEpIC0gMTsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQ7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldDsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBudW1UaGV0YXM7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBsZXQgc3RJbmRleCA9IDA7CiAgICAgICAgbGV0IG5vcm1hbEluZGV4ID0gMDsKICAgICAgICBsZXQgdGFuZ2VudEluZGV4ID0gMDsKICAgICAgICBsZXQgYml0YW5nZW50SW5kZXggPSAwOwogICAgICAgIGNvbnN0IHZlcnRleENvdW50SGFsZiA9IHZlcnRleENvdW50IC8gMjsKICAgICAgICBsZXQgZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGVsbGlwc29pZE91dGVyID0gRWxsaXBzb2lkX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjMocmFkaWkpOwogICAgICAgIGNvbnN0IGVsbGlwc29pZElubmVyID0gRWxsaXBzb2lkX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjMoaW5uZXJSYWRpaSk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCB8fCB2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB2ZXJ0ZXhDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGVsbGlwc29pZCA9IGlzSW5uZXJbaV0gPyBlbGxpcHNvaWRJbm5lciA6IGVsbGlwc29pZE91dGVyOwogICAgICAgICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpICogMywgc2NyYXRjaFBvc2l0aW9uMik7CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBzY3JhdGNoTm9ybWFsNSk7CiAgICAgICAgICAgIGlmIChuZWdhdGVOb3JtYWxbaV0pIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgICAgICBjb25zdCBub3JtYWxTVCA9IENhcnRlc2lhbjJfZGVmYXVsdC5uZWdhdGUobm9ybWFsMiwgc2NyYXRjaE5vcm1hbFNUKTsKICAgICAgICAgICAgICBzdFtzdEluZGV4KytdID0gTWF0aC5hdGFuMihub3JtYWxTVC55LCBub3JtYWxTVC54KSAvIE1hdGhfZGVmYXVsdC5UV09fUEkgKyAwLjU7CiAgICAgICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IE1hdGguYXNpbihub3JtYWwyLnopIC8gTWF0aC5QSSArIDAuNTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLng7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueTsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgY29uc3QgdGFuZ2VudCA9IHNjcmF0Y2hUYW5nZW50MzsKICAgICAgICAgICAgICBsZXQgdGFuZ2V0T2Zmc2V0ID0gMDsKICAgICAgICAgICAgICBsZXQgdW5pdDsKICAgICAgICAgICAgICBpZiAoaXNJbm5lcltpXSkgewogICAgICAgICAgICAgICAgdGFuZ2V0T2Zmc2V0ID0gdmVydGV4Q291bnRIYWxmOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWlzVG9wT3BlbiAmJiBpID49IHRhbmdldE9mZnNldCAmJiBpIDwgdGFuZ2V0T2Zmc2V0ICsgbnVtVGhldGFzICogMikgewogICAgICAgICAgICAgICAgdW5pdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1g7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVuaXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModW5pdCwgbm9ybWFsMiwgdGFuZ2VudCk7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh0YW5nZW50LCB0YW5nZW50KTsKICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBzY3JhdGNoQml0YW5nZW50Myk7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGJpdGFuZ2VudCwgYml0YW5nZW50KTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICAgIHZhbHVlczogc3QKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbUVsbGlwc29pZChlbGxpcHNvaWRPdXRlciksCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGVsbGlwc29pZEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvbWV0cnkuZ2V0VW5pdEVsbGlwc29pZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHVuaXRFbGxpcHNvaWRHZW9tZXRyeSkpIHsKICAgICAgICAgIHVuaXRFbGxpcHNvaWRHZW9tZXRyeSA9IEVsbGlwc29pZEdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5KAogICAgICAgICAgICBuZXcgRWxsaXBzb2lkR2VvbWV0cnkoewogICAgICAgICAgICAgIHJhZGlpOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDEsIDEsIDEpLAogICAgICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWQogICAgICAgICAgICB9KQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuaXRFbGxpcHNvaWRHZW9tZXRyeTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdCA9IEVsbGlwc29pZEdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeShlbGxpcHNvaWRHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgZWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhlbGxpcHNvaWRHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGVsbGlwc29pZEdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc29pZEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmFkaWkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJhZGlpLCBkZWZhdWx0UmFkaWkyKTsKICAgIGNvbnN0IGlubmVyUmFkaWkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmlubmVyUmFkaWksIHJhZGlpKTsKICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUNsb2NrLCAwKTsKICAgIGNvbnN0IG1heGltdW1DbG9jayA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUNsb2NrLCBNYXRoX2RlZmF1bHQuVFdPX1BJKTsKICAgIGNvbnN0IG1pbmltdW1Db25lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtQ29uZSwgMCk7CiAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUNvbmUsIE1hdGhfZGVmYXVsdC5QSSk7CiAgICBjb25zdCBzdGFja1BhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3RhY2tQYXJ0aXRpb25zLCAxMCkpOwogICAgY29uc3Qgc2xpY2VQYXJ0aXRpb25zID0gTWF0aC5yb3VuZChkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNsaWNlUGFydGl0aW9ucywgOCkpOwogICAgY29uc3Qgc3ViZGl2aXNpb25zID0gTWF0aC5yb3VuZChkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN1YmRpdmlzaW9ucywgMTI4KSk7CiAgICBpZiAoc3RhY2tQYXJ0aXRpb25zIDwgMSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5zdGFja1BhcnRpdGlvbnMgY2Fubm90IGJlIGxlc3MgdGhhbiAxIik7CiAgICB9CiAgICBpZiAoc2xpY2VQYXJ0aXRpb25zIDwgMCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5zbGljZVBhcnRpdGlvbnMgY2Fubm90IGJlIGxlc3MgdGhhbiAwIik7CiAgICB9CiAgICBpZiAoc3ViZGl2aXNpb25zIDwgMCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5zdWJkaXZpc2lvbnMgbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gemVyby4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSAmJiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLlRPUCBpcyBub3QgYSBzdXBwb3J0ZWQgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgZm9yIHRoaXMgZ2VvbWV0cnkuIgogICAgICApOwogICAgfQogICAgdGhpcy5fcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmFkaWkpOwogICAgdGhpcy5faW5uZXJSYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbm5lclJhZGlpKTsKICAgIHRoaXMuX21pbmltdW1DbG9jayA9IG1pbmltdW1DbG9jazsKICAgIHRoaXMuX21heGltdW1DbG9jayA9IG1heGltdW1DbG9jazsKICAgIHRoaXMuX21pbmltdW1Db25lID0gbWluaW11bUNvbmU7CiAgICB0aGlzLl9tYXhpbXVtQ29uZSA9IG1heGltdW1Db25lOwogICAgdGhpcy5fc3RhY2tQYXJ0aXRpb25zID0gc3RhY2tQYXJ0aXRpb25zOwogICAgdGhpcy5fc2xpY2VQYXJ0aXRpb25zID0gc2xpY2VQYXJ0aXRpb25zOwogICAgdGhpcy5fc3ViZGl2aXNpb25zID0gc3ViZGl2aXNpb25zOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBkZWZhdWx0UmFkaWkyLCBjb3MyLCBzaW4yLCBzY3JhdGNoUmFkaWkyLCBzY3JhdGNoSW5uZXJSYWRpaTIsIHNjcmF0Y2hPcHRpb25zMTQsIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZE91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBkZWZhdWx0UmFkaWkyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKTsKICAgICAgY29zMiA9IE1hdGguY29zOwogICAgICBzaW4yID0gTWF0aC5zaW47CiAgICAgIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSAyICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIDg7CiAgICAgIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9yYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5faW5uZXJSYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21pbmltdW1DbG9jazsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21heGltdW1DbG9jazsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21pbmltdW1Db25lOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWF4aW11bUNvbmU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdGFja1BhcnRpdGlvbnM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zbGljZVBhcnRpdGlvbnM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdWJkaXZpc2lvbnM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoUmFkaWkyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoSW5uZXJSYWRpaTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTQgPSB7CiAgICAgICAgcmFkaWk6IHNjcmF0Y2hSYWRpaTIsCiAgICAgICAgaW5uZXJSYWRpaTogc2NyYXRjaElubmVyUmFkaWkyLAogICAgICAgIG1pbmltdW1DbG9jazogdm9pZCAwLAogICAgICAgIG1heGltdW1DbG9jazogdm9pZCAwLAogICAgICAgIG1pbmltdW1Db25lOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUNvbmU6IHZvaWQgMCwKICAgICAgICBzdGFja1BhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzbGljZVBhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzdWJkaXZpc2lvbnM6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hSYWRpaTIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBpbm5lclJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaElubmVyUmFkaWkyKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgbWluaW11bUNsb2NrID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBtYXhpbXVtQ2xvY2sgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG1pbmltdW1Db25lID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3RhY2tQYXJ0aXRpb25zID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzbGljZVBhcnRpdGlvbnMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN1YmRpdmlzaW9ucyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5taW5pbXVtQ2xvY2sgPSBtaW5pbXVtQ2xvY2s7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0Lm1heGltdW1DbG9jayA9IG1heGltdW1DbG9jazsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQubWluaW11bUNvbmUgPSBtaW5pbXVtQ29uZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQubWF4aW11bUNvbmUgPSBtYXhpbXVtQ29uZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQuc3RhY2tQYXJ0aXRpb25zID0gc3RhY2tQYXJ0aXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5zbGljZVBhcnRpdGlvbnMgPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0LnN1YmRpdmlzaW9ucyA9IHN1YmRpdmlzaW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3JhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJhZGlpLCByZXN1bHQuX3JhZGlpKTsKICAgICAgICByZXN1bHQuX2lubmVyUmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW5uZXJSYWRpaSwgcmVzdWx0Ll9pbm5lclJhZGlpKTsKICAgICAgICByZXN1bHQuX21pbmltdW1DbG9jayA9IG1pbmltdW1DbG9jazsKICAgICAgICByZXN1bHQuX21heGltdW1DbG9jayA9IG1heGltdW1DbG9jazsKICAgICAgICByZXN1bHQuX21pbmltdW1Db25lID0gbWluaW11bUNvbmU7CiAgICAgICAgcmVzdWx0Ll9tYXhpbXVtQ29uZSA9IG1heGltdW1Db25lOwogICAgICAgIHJlc3VsdC5fc3RhY2tQYXJ0aXRpb25zID0gc3RhY2tQYXJ0aXRpb25zOwogICAgICAgIHJlc3VsdC5fc2xpY2VQYXJ0aXRpb25zID0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIHJlc3VsdC5fc3ViZGl2aXNpb25zID0gc3ViZGl2aXNpb25zOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihlbGxpcHNvaWRHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHJhZGlpID0gZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpOwogICAgICAgIGlmIChyYWRpaS54IDw9IDAgfHwgcmFkaWkueSA8PSAwIHx8IHJhZGlpLnogPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbm5lclJhZGlpID0gZWxsaXBzb2lkR2VvbWV0cnkuX2lubmVyUmFkaWk7CiAgICAgICAgaWYgKGlubmVyUmFkaWkueCA8PSAwIHx8IGlubmVyUmFkaWkueSA8PSAwIHx8IGlubmVyUmFkaWkueiA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGVsbGlwc29pZEdlb21ldHJ5Ll9taW5pbXVtQ2xvY2s7CiAgICAgICAgY29uc3QgbWF4aW11bUNsb2NrID0gZWxsaXBzb2lkR2VvbWV0cnkuX21heGltdW1DbG9jazsKICAgICAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9taW5pbXVtQ29uZTsKICAgICAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9tYXhpbXVtQ29uZTsKICAgICAgICBjb25zdCBzdWJkaXZpc2lvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc3ViZGl2aXNpb25zOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmZyb21DYXJ0ZXNpYW4zKHJhZGlpKTsKICAgICAgICBsZXQgc2xpY2VQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3NsaWNlUGFydGl0aW9ucyArIDE7CiAgICAgICAgbGV0IHN0YWNrUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zdGFja1BhcnRpdGlvbnMgKyAxOwogICAgICAgIHNsaWNlUGFydGl0aW9ucyA9IE1hdGgucm91bmQoCiAgICAgICAgICBzbGljZVBhcnRpdGlvbnMgKiBNYXRoLmFicyhtYXhpbXVtQ2xvY2sgLSBtaW5pbXVtQ2xvY2spIC8gTWF0aF9kZWZhdWx0LlRXT19QSQogICAgICAgICk7CiAgICAgICAgc3RhY2tQYXJ0aXRpb25zID0gTWF0aC5yb3VuZCgKICAgICAgICAgIHN0YWNrUGFydGl0aW9ucyAqIE1hdGguYWJzKG1heGltdW1Db25lIC0gbWluaW11bUNvbmUpIC8gTWF0aF9kZWZhdWx0LlBJCiAgICAgICAgKTsKICAgICAgICBpZiAoc2xpY2VQYXJ0aXRpb25zIDwgMikgewogICAgICAgICAgc2xpY2VQYXJ0aXRpb25zID0gMjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YWNrUGFydGl0aW9ucyA8IDIpIHsKICAgICAgICAgIHN0YWNrUGFydGl0aW9ucyA9IDI7CiAgICAgICAgfQogICAgICAgIGxldCBleHRyYUluZGljZXMgPSAwOwogICAgICAgIGxldCB2ZXJ0ZXhNdWx0aXBsaWVyID0gMTsKICAgICAgICBjb25zdCBoYXNJbm5lclN1cmZhY2UgPSBpbm5lclJhZGlpLnggIT09IHJhZGlpLnggfHwgaW5uZXJSYWRpaS55ICE9PSByYWRpaS55IHx8IGlubmVyUmFkaWkueiAhPT0gcmFkaWkuejsKICAgICAgICBsZXQgaXNUb3BPcGVuID0gZmFsc2U7CiAgICAgICAgbGV0IGlzQm90T3BlbiA9IGZhbHNlOwogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIHZlcnRleE11bHRpcGxpZXIgPSAyOwogICAgICAgICAgaWYgKG1pbmltdW1Db25lID4gMCkgewogICAgICAgICAgICBpc1RvcE9wZW4gPSB0cnVlOwogICAgICAgICAgICBleHRyYUluZGljZXMgKz0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1heGltdW1Db25lIDwgTWF0aC5QSSkgewogICAgICAgICAgICBpc0JvdE9wZW4gPSB0cnVlOwogICAgICAgICAgICBleHRyYUluZGljZXMgKz0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IHN1YmRpdmlzaW9ucyAqIHZlcnRleE11bHRpcGxpZXIgKiAoc3RhY2tQYXJ0aXRpb25zICsgc2xpY2VQYXJ0aXRpb25zKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHZlcnRleENvdW50ICogMyk7CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IDIgKiAodmVydGV4Q291bnQgKyBleHRyYUluZGljZXMgLSAoc2xpY2VQYXJ0aXRpb25zICsgc3RhY2tQYXJ0aXRpb25zKSAqIHZlcnRleE11bHRpcGxpZXIpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSh2ZXJ0ZXhDb3VudCwgbnVtSW5kaWNlcyk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IHRoZXRhOwogICAgICAgIGxldCBwaGk7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBjb25zdCBzaW5QaGkgPSBuZXcgQXJyYXkoc3RhY2tQYXJ0aXRpb25zKTsKICAgICAgICBjb25zdCBjb3NQaGkgPSBuZXcgQXJyYXkoc3RhY2tQYXJ0aXRpb25zKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3RhY2tQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgIHBoaSA9IG1pbmltdW1Db25lICsgaSAqIChtYXhpbXVtQ29uZSAtIG1pbmltdW1Db25lKSAvIChzdGFja1BhcnRpdGlvbnMgLSAxKTsKICAgICAgICAgIHNpblBoaVtpXSA9IHNpbjIocGhpKTsKICAgICAgICAgIGNvc1BoaVtpXSA9IGNvczIocGhpKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2luVGhldGEgPSBuZXcgQXJyYXkoc3ViZGl2aXNpb25zKTsKICAgICAgICBjb25zdCBjb3NUaGV0YSA9IG5ldyBBcnJheShzdWJkaXZpc2lvbnMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdWJkaXZpc2lvbnM7IGkrKykgewogICAgICAgICAgdGhldGEgPSBtaW5pbXVtQ2xvY2sgKyBpICogKG1heGltdW1DbG9jayAtIG1pbmltdW1DbG9jaykgLyAoc3ViZGl2aXNpb25zIC0gMSk7CiAgICAgICAgICBzaW5UaGV0YVtpXSA9IHNpbjIodGhldGEpOwogICAgICAgICAgY29zVGhldGFbaV0gPSBjb3MyKHRoZXRhKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN0YWNrUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc3ViZGl2aXNpb25zOyBqKyspIHsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueCAqIHNpblBoaVtpXSAqIGNvc1RoZXRhW2pdOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS55ICogc2luUGhpW2ldICogc2luVGhldGFbal07CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdGFja1BhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc3ViZGl2aXNpb25zOyBqKyspIHsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnggKiBzaW5QaGlbaV0gKiBjb3NUaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnkgKiBzaW5QaGlbaV0gKiBzaW5UaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2luUGhpLmxlbmd0aCA9IHN1YmRpdmlzaW9uczsKICAgICAgICBjb3NQaGkubGVuZ3RoID0gc3ViZGl2aXNpb25zOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdWJkaXZpc2lvbnM7IGkrKykgewogICAgICAgICAgcGhpID0gbWluaW11bUNvbmUgKyBpICogKG1heGltdW1Db25lIC0gbWluaW11bUNvbmUpIC8gKHN1YmRpdmlzaW9ucyAtIDEpOwogICAgICAgICAgc2luUGhpW2ldID0gc2luMihwaGkpOwogICAgICAgICAgY29zUGhpW2ldID0gY29zMihwaGkpOwogICAgICAgIH0KICAgICAgICBzaW5UaGV0YS5sZW5ndGggPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgY29zVGhldGEubGVuZ3RoID0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZVBhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgdGhldGEgPSBtaW5pbXVtQ2xvY2sgKyBpICogKG1heGltdW1DbG9jayAtIG1pbmltdW1DbG9jaykgLyAoc2xpY2VQYXJ0aXRpb25zIC0gMSk7CiAgICAgICAgICBzaW5UaGV0YVtpXSA9IHNpbjIodGhldGEpOwogICAgICAgICAgY29zVGhldGFbaV0gPSBjb3MyKHRoZXRhKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN1YmRpdmlzaW9uczsgaSsrKSB7CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc2xpY2VQYXJ0aXRpb25zOyBqKyspIHsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueCAqIHNpblBoaVtpXSAqIGNvc1RoZXRhW2pdOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS55ICogc2luUGhpW2ldICogc2luVGhldGFbal07CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdWJkaXZpc2lvbnM7IGkrKykgewogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc2xpY2VQYXJ0aXRpb25zOyBqKyspIHsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnggKiBzaW5QaGlbaV0gKiBjb3NUaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnkgKiBzaW5QaGlbaV0gKiBzaW5UaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdGFja1BhcnRpdGlvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHRvcE9mZnNldCA9IGkgKiBzdWJkaXZpc2lvbnM7CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc3ViZGl2aXNpb25zIC0gMTsgaisrKSB7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BPZmZzZXQgKyBqOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgaiArIDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBvZmZzZXQgPSBzdGFja1BhcnRpdGlvbnMgKiBzdWJkaXZpc2lvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZVBhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHN1YmRpdmlzaW9ucyAtIDE7IGorKykgewogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb2Zmc2V0ICsgaSArIGogKiBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvZmZzZXQgKyBpICsgKGogKyAxKSAqIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgb2Zmc2V0ID0gc3RhY2tQYXJ0aXRpb25zICogc3ViZGl2aXNpb25zICogdmVydGV4TXVsdGlwbGllciArIHNsaWNlUGFydGl0aW9ucyAqIHN1YmRpdmlzaW9uczsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZVBhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc3ViZGl2aXNpb25zIC0gMTsgaisrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG9mZnNldCArIGkgKyBqICogc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvZmZzZXQgKyBpICsgKGogKyAxKSAqIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICBsZXQgb3V0ZXJPZmZzZXQgPSBzdGFja1BhcnRpdGlvbnMgKiBzdWJkaXZpc2lvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOwogICAgICAgICAgbGV0IGlubmVyT2Zmc2V0ID0gb3V0ZXJPZmZzZXQgKyBzdWJkaXZpc2lvbnMgKiBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICBpZiAoaXNUb3BPcGVuKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZVBhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQm90T3BlbikgewogICAgICAgICAgICBvdXRlck9mZnNldCArPSBzdWJkaXZpc2lvbnMgKiBzbGljZVBhcnRpdGlvbnMgLSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICAgIGlubmVyT2Zmc2V0ICs9IHN1YmRpdmlzaW9ucyAqIHNsaWNlUGFydGl0aW9ucyAtIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBlbGxpcHNvaWRHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbUVsbGlwc29pZChlbGxpcHNvaWQpLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBlbGxpcHNvaWRHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KGVsbGlwc29pZEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkR2VvbWV0cnkuYnVmZmVyLCBvZmZzZXQpKSB7CiAgICAgIGVsbGlwc29pZEdlb21ldHJ5ID0gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIGVsbGlwc29pZEdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgcmV0dXJuIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGVsbGlwc29pZEdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3VsbGluZ1ZvbHVtZS5qcwogIGZ1bmN0aW9uIEN1bGxpbmdWb2x1bWUocGxhbmVzKSB7CiAgICB0aGlzLnBsYW5lcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHBsYW5lcywgW10pOwogIH0KICB2YXIgZmFjZXMsIHNjcmF0Y2hQbGFuZUNlbnRlciwgc2NyYXRjaFBsYW5lTm9ybWFsMiwgc2NyYXRjaFBsYW5lMiwgQ3VsbGluZ1ZvbHVtZV9kZWZhdWx0OwogIHZhciBpbml0X0N1bGxpbmdWb2x1bWUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N1bGxpbmdWb2x1bWUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgZmFjZXMgPSBbbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKV07CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCBmYWNlc1swXSk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLCBmYWNlc1sxXSk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCBmYWNlc1syXSk7CiAgICAgIHNjcmF0Y2hQbGFuZUNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBsYW5lTm9ybWFsMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBsYW5lMiA9IG5ldyBQbGFuZV9kZWZhdWx0KG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMSwgMCwgMCksIDApOwogICAgICBDdWxsaW5nVm9sdW1lLmZyb21Cb3VuZGluZ1NwaGVyZSA9IGZ1bmN0aW9uKGJvdW5kaW5nU3BoZXJlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3VuZGluZ1NwaGVyZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3VuZGluZ1NwaGVyZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEN1bGxpbmdWb2x1bWUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gZmFjZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IHBsYW5lcyA9IHJlc3VsdC5wbGFuZXM7CiAgICAgICAgcGxhbmVzLmxlbmd0aCA9IDIgKiBsZW5ndGg7CiAgICAgICAgY29uc3QgY2VudGVyID0gYm91bmRpbmdTcGhlcmUuY2VudGVyOwogICAgICAgIGNvbnN0IHJhZGl1cyA9IGJvdW5kaW5nU3BoZXJlLnJhZGl1czsKICAgICAgICBsZXQgcGxhbmVJbmRleCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgZmFjZU5vcm1hbCA9IGZhY2VzW2ldOwogICAgICAgICAgbGV0IHBsYW5lMCA9IHBsYW5lc1twbGFuZUluZGV4XTsKICAgICAgICAgIGxldCBwbGFuZTEgPSBwbGFuZXNbcGxhbmVJbmRleCArIDFdOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUwKSkgewogICAgICAgICAgICBwbGFuZTAgPSBwbGFuZXNbcGxhbmVJbmRleF0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZTEpKSB7CiAgICAgICAgICAgIHBsYW5lMSA9IHBsYW5lc1twbGFuZUluZGV4ICsgMV0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihmYWNlTm9ybWFsLCAtcmFkaXVzLCBzY3JhdGNoUGxhbmVDZW50ZXIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHNjcmF0Y2hQbGFuZUNlbnRlciwgc2NyYXRjaFBsYW5lQ2VudGVyKTsKICAgICAgICAgIHBsYW5lMC54ID0gZmFjZU5vcm1hbC54OwogICAgICAgICAgcGxhbmUwLnkgPSBmYWNlTm9ybWFsLnk7CiAgICAgICAgICBwbGFuZTAueiA9IGZhY2VOb3JtYWwuejsKICAgICAgICAgIHBsYW5lMC53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZmFjZU5vcm1hbCwgc2NyYXRjaFBsYW5lQ2VudGVyKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGZhY2VOb3JtYWwsIHJhZGl1cywgc2NyYXRjaFBsYW5lQ2VudGVyKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCBzY3JhdGNoUGxhbmVDZW50ZXIsIHNjcmF0Y2hQbGFuZUNlbnRlcik7CiAgICAgICAgICBwbGFuZTEueCA9IC1mYWNlTm9ybWFsLng7CiAgICAgICAgICBwbGFuZTEueSA9IC1mYWNlTm9ybWFsLnk7CiAgICAgICAgICBwbGFuZTEueiA9IC1mYWNlTm9ybWFsLno7CiAgICAgICAgICBwbGFuZTEudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGZhY2VOb3JtYWwsIHNjcmF0Y2hQbGFuZU5vcm1hbDIpLAogICAgICAgICAgICBzY3JhdGNoUGxhbmVDZW50ZXIKICAgICAgICAgICk7CiAgICAgICAgICBwbGFuZUluZGV4ICs9IDI7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEN1bGxpbmdWb2x1bWUucHJvdG90eXBlLmNvbXB1dGVWaXNpYmlsaXR5ID0gZnVuY3Rpb24oYm91bmRpbmdWb2x1bWUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3VuZGluZ1ZvbHVtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3VuZGluZ1ZvbHVtZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGxhbmVzID0gdGhpcy5wbGFuZXM7CiAgICAgICAgbGV0IGludGVyc2VjdGluZyA9IGZhbHNlOwogICAgICAgIGZvciAobGV0IGsgPSAwLCBsZW4gPSBwbGFuZXMubGVuZ3RoOyBrIDwgbGVuOyArK2spIHsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGJvdW5kaW5nVm9sdW1lLmludGVyc2VjdFBsYW5lKAogICAgICAgICAgICBQbGFuZV9kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KHBsYW5lc1trXSwgc2NyYXRjaFBsYW5lMikKICAgICAgICAgICk7CiAgICAgICAgICBpZiAocmVzdWx0ID09PSBJbnRlcnNlY3RfZGVmYXVsdC5PVVRTSURFKSB7CiAgICAgICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5PVVRTSURFOwogICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQgPT09IEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORykgewogICAgICAgICAgICBpbnRlcnNlY3RpbmcgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaW50ZXJzZWN0aW5nID8gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HIDogSW50ZXJzZWN0X2RlZmF1bHQuSU5TSURFOwogICAgICB9OwogICAgICBDdWxsaW5nVm9sdW1lLnByb3RvdHlwZS5jb21wdXRlVmlzaWJpbGl0eVdpdGhQbGFuZU1hc2sgPSBmdW5jdGlvbihib3VuZGluZ1ZvbHVtZSwgcGFyZW50UGxhbmVNYXNrKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm91bmRpbmdWb2x1bWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm91bmRpbmdWb2x1bWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBhcmVudFBsYW5lTWFzaykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwYXJlbnRQbGFuZU1hc2sgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChwYXJlbnRQbGFuZU1hc2sgPT09IEN1bGxpbmdWb2x1bWUuTUFTS19PVVRTSURFIHx8IHBhcmVudFBsYW5lTWFzayA9PT0gQ3VsbGluZ1ZvbHVtZS5NQVNLX0lOU0lERSkgewogICAgICAgICAgcmV0dXJuIHBhcmVudFBsYW5lTWFzazsKICAgICAgICB9CiAgICAgICAgbGV0IG1hc2sgPSBDdWxsaW5nVm9sdW1lLk1BU0tfSU5TSURFOwogICAgICAgIGNvbnN0IHBsYW5lcyA9IHRoaXMucGxhbmVzOwogICAgICAgIGZvciAobGV0IGsgPSAwLCBsZW4gPSBwbGFuZXMubGVuZ3RoOyBrIDwgbGVuOyArK2spIHsKICAgICAgICAgIGNvbnN0IGZsYWcgPSBrIDwgMzEgPyAxIDw8IGsgOiAwOwogICAgICAgICAgaWYgKGsgPCAzMSAmJiAocGFyZW50UGxhbmVNYXNrICYgZmxhZykgPT09IDApIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBib3VuZGluZ1ZvbHVtZS5pbnRlcnNlY3RQbGFuZSgKICAgICAgICAgICAgUGxhbmVfZGVmYXVsdC5mcm9tQ2FydGVzaWFuNChwbGFuZXNba10sIHNjcmF0Y2hQbGFuZTIpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERSkgewogICAgICAgICAgICByZXR1cm4gQ3VsbGluZ1ZvbHVtZS5NQVNLX09VVFNJREU7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdCA9PT0gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HKSB7CiAgICAgICAgICAgIG1hc2sgfD0gZmxhZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hc2s7CiAgICAgIH07CiAgICAgIEN1bGxpbmdWb2x1bWUuTUFTS19PVVRTSURFID0gNDI5NDk2NzI5NTsKICAgICAgQ3VsbGluZ1ZvbHVtZS5NQVNLX0lOU0lERSA9IDA7CiAgICAgIEN1bGxpbmdWb2x1bWUuTUFTS19JTkRFVEVSTUlOQVRFID0gMjE0NzQ4MzY0NzsKICAgICAgQ3VsbGluZ1ZvbHVtZV9kZWZhdWx0ID0gQ3VsbGluZ1ZvbHVtZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0uanMKICBmdW5jdGlvbiBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5sZWZ0ID0gb3B0aW9ucy5sZWZ0OwogICAgdGhpcy5fbGVmdCA9IHZvaWQgMDsKICAgIHRoaXMucmlnaHQgPSBvcHRpb25zLnJpZ2h0OwogICAgdGhpcy5fcmlnaHQgPSB2b2lkIDA7CiAgICB0aGlzLnRvcCA9IG9wdGlvbnMudG9wOwogICAgdGhpcy5fdG9wID0gdm9pZCAwOwogICAgdGhpcy5ib3R0b20gPSBvcHRpb25zLmJvdHRvbTsKICAgIHRoaXMuX2JvdHRvbSA9IHZvaWQgMDsKICAgIHRoaXMubmVhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubmVhciwgMSk7CiAgICB0aGlzLl9uZWFyID0gdGhpcy5uZWFyOwogICAgdGhpcy5mYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmZhciwgNWU4KTsKICAgIHRoaXMuX2ZhciA9IHRoaXMuZmFyOwogICAgdGhpcy5fY3VsbGluZ1ZvbHVtZSA9IG5ldyBDdWxsaW5nVm9sdW1lX2RlZmF1bHQoKTsKICAgIHRoaXMuX29ydGhvZ3JhcGhpY01hdHJpeCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICB9CiAgZnVuY3Rpb24gdXBkYXRlKGZydXN0dW0pIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ucmlnaHQpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5sZWZ0KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0udG9wKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uYm90dG9tKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ubmVhcikgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmZhcikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgInJpZ2h0LCBsZWZ0LCB0b3AsIGJvdHRvbSwgbmVhciwgb3IgZmFyIHBhcmFtZXRlcnMgYXJlIG5vdCBzZXQuIgogICAgICApOwogICAgfQogICAgaWYgKGZydXN0dW0udG9wICE9PSBmcnVzdHVtLl90b3AgfHwgZnJ1c3R1bS5ib3R0b20gIT09IGZydXN0dW0uX2JvdHRvbSB8fCBmcnVzdHVtLmxlZnQgIT09IGZydXN0dW0uX2xlZnQgfHwgZnJ1c3R1bS5yaWdodCAhPT0gZnJ1c3R1bS5fcmlnaHQgfHwgZnJ1c3R1bS5uZWFyICE9PSBmcnVzdHVtLl9uZWFyIHx8IGZydXN0dW0uZmFyICE9PSBmcnVzdHVtLl9mYXIpIHsKICAgICAgaWYgKGZydXN0dW0ubGVmdCA+IGZydXN0dW0ucmlnaHQpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgbXVzdCBiZSBncmVhdGVyIHRoYW4gbGVmdC4iKTsKICAgICAgfQogICAgICBpZiAoZnJ1c3R1bS5ib3R0b20gPiBmcnVzdHVtLnRvcCkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ0b3AgbXVzdCBiZSBncmVhdGVyIHRoYW4gYm90dG9tLiIpOwogICAgICB9CiAgICAgIGlmIChmcnVzdHVtLm5lYXIgPD0gMCB8fCBmcnVzdHVtLm5lYXIgPiBmcnVzdHVtLmZhcikgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIm5lYXIgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVybyBhbmQgbGVzcyB0aGFuIGZhci4iCiAgICAgICAgKTsKICAgICAgfQogICAgICBmcnVzdHVtLl9sZWZ0ID0gZnJ1c3R1bS5sZWZ0OwogICAgICBmcnVzdHVtLl9yaWdodCA9IGZydXN0dW0ucmlnaHQ7CiAgICAgIGZydXN0dW0uX3RvcCA9IGZydXN0dW0udG9wOwogICAgICBmcnVzdHVtLl9ib3R0b20gPSBmcnVzdHVtLmJvdHRvbTsKICAgICAgZnJ1c3R1bS5fbmVhciA9IGZydXN0dW0ubmVhcjsKICAgICAgZnJ1c3R1bS5fZmFyID0gZnJ1c3R1bS5mYXI7CiAgICAgIGZydXN0dW0uX29ydGhvZ3JhcGhpY01hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jb21wdXRlT3J0aG9ncmFwaGljT2ZmQ2VudGVyKAogICAgICAgIGZydXN0dW0ubGVmdCwKICAgICAgICBmcnVzdHVtLnJpZ2h0LAogICAgICAgIGZydXN0dW0uYm90dG9tLAogICAgICAgIGZydXN0dW0udG9wLAogICAgICAgIGZydXN0dW0ubmVhciwKICAgICAgICBmcnVzdHVtLmZhciwKICAgICAgICBmcnVzdHVtLl9vcnRob2dyYXBoaWNNYXRyaXgKICAgICAgKTsKICAgIH0KICB9CiAgdmFyIGdldFBsYW5lc1JpZ2h0LCBnZXRQbGFuZXNOZWFyQ2VudGVyLCBnZXRQbGFuZXNQb2ludCwgbmVnYXRlU2NyYXRjaCwgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bV9kZWZhdWx0OwogIHZhciBpbml0X09ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ3VsbGluZ1ZvbHVtZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgb3J0aG9ncmFwaGljIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bS4KICAgICAgICAgKiBAbWVtYmVyb2YgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBwcm9qZWN0aW9uTWF0cml4OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGUodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vcnRob2dyYXBoaWNNYXRyaXg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgZ2V0UGxhbmVzUmlnaHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGdldFBsYW5lc05lYXJDZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGdldFBsYW5lc1BvaW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBuZWdhdGVTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5jb21wdXRlQ3VsbGluZ1ZvbHVtZSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvc2l0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkaXJlY3Rpb24yKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRpcmVjdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBsYW5lcyA9IHRoaXMuX2N1bGxpbmdWb2x1bWUucGxhbmVzOwogICAgICAgIGNvbnN0IHQgPSB0aGlzLnRvcDsKICAgICAgICBjb25zdCBiID0gdGhpcy5ib3R0b207CiAgICAgICAgY29uc3QgciA9IHRoaXMucmlnaHQ7CiAgICAgICAgY29uc3QgbCA9IHRoaXMubGVmdDsKICAgICAgICBjb25zdCBuID0gdGhpcy5uZWFyOwogICAgICAgIGNvbnN0IGYgPSB0aGlzLmZhcjsKICAgICAgICBjb25zdCByaWdodCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhkaXJlY3Rpb24yLCB1cCwgZ2V0UGxhbmVzUmlnaHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmlnaHQsIHJpZ2h0KTsKICAgICAgICBjb25zdCBuZWFyQ2VudGVyID0gZ2V0UGxhbmVzTmVhckNlbnRlcjsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaXJlY3Rpb24yLCBuLCBuZWFyQ2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBuZWFyQ2VudGVyLCBuZWFyQ2VudGVyKTsKICAgICAgICBjb25zdCBwb2ludCA9IGdldFBsYW5lc1BvaW50OwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJpZ2h0LCBsLCBwb2ludCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBwb2ludCwgcG9pbnQpOwogICAgICAgIGxldCBwbGFuZSA9IHBsYW5lc1swXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzBdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gcmlnaHQueDsKICAgICAgICBwbGFuZS55ID0gcmlnaHQueTsKICAgICAgICBwbGFuZS56ID0gcmlnaHQuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QocmlnaHQsIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyaWdodCwgciwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgcG9pbnQsIHBvaW50KTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1sxXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzFdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gLXJpZ2h0Lng7CiAgICAgICAgcGxhbmUueSA9IC1yaWdodC55OwogICAgICAgIHBsYW5lLnogPSAtcmlnaHQuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShyaWdodCwgbmVnYXRlU2NyYXRjaCksIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih1cCwgYiwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgcG9pbnQsIHBvaW50KTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1syXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzJdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gdXAueDsKICAgICAgICBwbGFuZS55ID0gdXAueTsKICAgICAgICBwbGFuZS56ID0gdXAuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QodXAsIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih1cCwgdCwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgcG9pbnQsIHBvaW50KTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1szXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzNdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gLXVwLng7CiAgICAgICAgcGxhbmUueSA9IC11cC55OwogICAgICAgIHBsYW5lLnogPSAtdXAuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSh1cCwgbmVnYXRlU2NyYXRjaCksIHBvaW50KTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1s0XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzRdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gZGlyZWN0aW9uMi54OwogICAgICAgIHBsYW5lLnkgPSBkaXJlY3Rpb24yLnk7CiAgICAgICAgcGxhbmUueiA9IGRpcmVjdGlvbjIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgbmVhckNlbnRlcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGlyZWN0aW9uMiwgZiwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIHBvaW50LCBwb2ludCk7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbNV07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1s1XSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IC1kaXJlY3Rpb24yLng7CiAgICAgICAgcGxhbmUueSA9IC1kaXJlY3Rpb24yLnk7CiAgICAgICAgcGxhbmUueiA9IC1kaXJlY3Rpb24yLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZGlyZWN0aW9uMiwgbmVnYXRlU2NyYXRjaCksIHBvaW50KTsKICAgICAgICByZXR1cm4gdGhpcy5fY3VsbGluZ1ZvbHVtZTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuZ2V0UGl4ZWxEaW1lbnNpb25zID0gZnVuY3Rpb24oZHJhd2luZ0J1ZmZlcldpZHRoLCBkcmF3aW5nQnVmZmVySGVpZ2h0LCBkaXN0YW5jZSwgcGl4ZWxSYXRpbywgcmVzdWx0KSB7CiAgICAgICAgdXBkYXRlKHRoaXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRyYXdpbmdCdWZmZXJXaWR0aCkgfHwgIWRlZmluZWRfZGVmYXVsdChkcmF3aW5nQnVmZmVySGVpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJCb3RoIGRyYXdpbmdCdWZmZXJXaWR0aCBhbmQgZHJhd2luZ0J1ZmZlckhlaWdodCBhcmUgcmVxdWlyZWQuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRyYXdpbmdCdWZmZXJXaWR0aCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZHJhd2luZ0J1ZmZlcldpZHRoIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmIChkcmF3aW5nQnVmZmVySGVpZ2h0IDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkcmF3aW5nQnVmZmVySGVpZ2h0IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRpc3RhbmNlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRpc3RhbmNlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwaXhlbFJhdGlvKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBpeGVsUmF0aW8gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChwaXhlbFJhdGlvIDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXhlbFJhdGlvIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBIHJlc3VsdCBvYmplY3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZydXN0dW1XaWR0aCA9IHRoaXMucmlnaHQgLSB0aGlzLmxlZnQ7CiAgICAgICAgY29uc3QgZnJ1c3R1bUhlaWdodCA9IHRoaXMudG9wIC0gdGhpcy5ib3R0b207CiAgICAgICAgY29uc3QgcGl4ZWxXaWR0aCA9IHBpeGVsUmF0aW8gKiBmcnVzdHVtV2lkdGggLyBkcmF3aW5nQnVmZmVyV2lkdGg7CiAgICAgICAgY29uc3QgcGl4ZWxIZWlnaHQgPSBwaXhlbFJhdGlvICogZnJ1c3R1bUhlaWdodCAvIGRyYXdpbmdCdWZmZXJIZWlnaHQ7CiAgICAgICAgcmVzdWx0LnggPSBwaXhlbFdpZHRoOwogICAgICAgIHJlc3VsdC55ID0gcGl4ZWxIZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubGVmdCA9IHRoaXMubGVmdDsKICAgICAgICByZXN1bHQucmlnaHQgPSB0aGlzLnJpZ2h0OwogICAgICAgIHJlc3VsdC50b3AgPSB0aGlzLnRvcDsKICAgICAgICByZXN1bHQuYm90dG9tID0gdGhpcy5ib3R0b207CiAgICAgICAgcmVzdWx0Lm5lYXIgPSB0aGlzLm5lYXI7CiAgICAgICAgcmVzdWx0LmZhciA9IHRoaXMuZmFyOwogICAgICAgIHJlc3VsdC5fbGVmdCA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX3JpZ2h0ID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fdG9wID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fYm90dG9tID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fbmVhciA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2ZhciA9IHZvaWQgMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQob3RoZXIpICYmIG90aGVyIGluc3RhbmNlb2YgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bSAmJiB0aGlzLnJpZ2h0ID09PSBvdGhlci5yaWdodCAmJiB0aGlzLmxlZnQgPT09IG90aGVyLmxlZnQgJiYgdGhpcy50b3AgPT09IG90aGVyLnRvcCAmJiB0aGlzLmJvdHRvbSA9PT0gb3RoZXIuYm90dG9tICYmIHRoaXMubmVhciA9PT0gb3RoZXIubmVhciAmJiB0aGlzLmZhciA9PT0gb3RoZXIuZmFyOwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIG90aGVyID09PSB0aGlzIHx8IGRlZmluZWRfZGVmYXVsdChvdGhlcikgJiYgb3RoZXIgaW5zdGFuY2VvZiBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5yaWdodCwKICAgICAgICAgIG90aGVyLnJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMubGVmdCwKICAgICAgICAgIG90aGVyLmxlZnQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy50b3AsCiAgICAgICAgICBvdGhlci50b3AsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5ib3R0b20sCiAgICAgICAgICBvdGhlci5ib3R0b20sCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5uZWFyLAogICAgICAgICAgb3RoZXIubmVhciwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmZhciwKICAgICAgICAgIG90aGVyLmZhciwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW1fZGVmYXVsdCA9IE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW07CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PcnRob2dyYXBoaWNGcnVzdHVtLmpzCiAgZnVuY3Rpb24gT3J0aG9ncmFwaGljRnJ1c3R1bShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMuX29mZkNlbnRlckZydXN0dW0gPSBuZXcgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bV9kZWZhdWx0KCk7CiAgICB0aGlzLndpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgIHRoaXMuX3dpZHRoID0gdm9pZCAwOwogICAgdGhpcy5hc3BlY3RSYXRpbyA9IG9wdGlvbnMuYXNwZWN0UmF0aW87CiAgICB0aGlzLl9hc3BlY3RSYXRpbyA9IHZvaWQgMDsKICAgIHRoaXMubmVhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubmVhciwgMSk7CiAgICB0aGlzLl9uZWFyID0gdGhpcy5uZWFyOwogICAgdGhpcy5mYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmZhciwgNWU4KTsKICAgIHRoaXMuX2ZhciA9IHRoaXMuZmFyOwogIH0KICBmdW5jdGlvbiB1cGRhdGUyKGZydXN0dW0pIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ud2lkdGgpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5hc3BlY3RSYXRpbykgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLm5lYXIpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5mYXIpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJ3aWR0aCwgYXNwZWN0UmF0aW8sIG5lYXIsIG9yIGZhciBwYXJhbWV0ZXJzIGFyZSBub3Qgc2V0LiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGYgPSBmcnVzdHVtLl9vZmZDZW50ZXJGcnVzdHVtOwogICAgaWYgKGZydXN0dW0ud2lkdGggIT09IGZydXN0dW0uX3dpZHRoIHx8IGZydXN0dW0uYXNwZWN0UmF0aW8gIT09IGZydXN0dW0uX2FzcGVjdFJhdGlvIHx8IGZydXN0dW0ubmVhciAhPT0gZnJ1c3R1bS5fbmVhciB8fCBmcnVzdHVtLmZhciAhPT0gZnJ1c3R1bS5fZmFyKSB7CiAgICAgIGlmIChmcnVzdHVtLmFzcGVjdFJhdGlvIDwgMCkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhc3BlY3RSYXRpbyBtdXN0IGJlIHBvc2l0aXZlLiIpOwogICAgICB9CiAgICAgIGlmIChmcnVzdHVtLm5lYXIgPCAwIHx8IGZydXN0dW0ubmVhciA+IGZydXN0dW0uZmFyKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAibmVhciBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvIGFuZCBsZXNzIHRoYW4gZmFyLiIKICAgICAgICApOwogICAgICB9CiAgICAgIGZydXN0dW0uX2FzcGVjdFJhdGlvID0gZnJ1c3R1bS5hc3BlY3RSYXRpbzsKICAgICAgZnJ1c3R1bS5fd2lkdGggPSBmcnVzdHVtLndpZHRoOwogICAgICBmcnVzdHVtLl9uZWFyID0gZnJ1c3R1bS5uZWFyOwogICAgICBmcnVzdHVtLl9mYXIgPSBmcnVzdHVtLmZhcjsKICAgICAgY29uc3QgcmF0aW8gPSAxIC8gZnJ1c3R1bS5hc3BlY3RSYXRpbzsKICAgICAgZi5yaWdodCA9IGZydXN0dW0ud2lkdGggKiAwLjU7CiAgICAgIGYubGVmdCA9IC1mLnJpZ2h0OwogICAgICBmLnRvcCA9IHJhdGlvICogZi5yaWdodDsKICAgICAgZi5ib3R0b20gPSAtZi50b3A7CiAgICAgIGYubmVhciA9IGZydXN0dW0ubmVhcjsKICAgICAgZi5mYXIgPSBmcnVzdHVtLmZhcjsKICAgIH0KICB9CiAgdmFyIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdDsKICB2YXIgaW5pdF9PcnRob2dyYXBoaWNGcnVzdHVtID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PcnRob2dyYXBoaWNGcnVzdHVtLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9PcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtKCk7CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucGFja2VkTGVuZ3RoID0gNDsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUud2lkdGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmFzcGVjdFJhdGlvOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5uZWFyOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUuZmFyOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE9ydGhvZ3JhcGhpY0ZydXN0dW0oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LndpZHRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuYXNwZWN0UmF0aW8gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5uZWFyID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuZmFyID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcnRob2dyYXBoaWMgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtLgogICAgICAgICAqIEBtZW1iZXJvZiBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHByb2plY3Rpb25NYXRyaXg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTIodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLnByb2plY3Rpb25NYXRyaXg7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcnRob2dyYXBoaWMgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtLgogICAgICAgICAqIEBtZW1iZXJvZiBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgb2ZmQ2VudGVyRnJ1c3R1bTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlMih0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUuY29tcHV0ZUN1bGxpbmdWb2x1bWUgPSBmdW5jdGlvbihwb3NpdGlvbiwgZGlyZWN0aW9uMiwgdXApIHsKICAgICAgICB1cGRhdGUyKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmNvbXB1dGVDdWxsaW5nVm9sdW1lKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCk7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlLmdldFBpeGVsRGltZW5zaW9ucyA9IGZ1bmN0aW9uKGRyYXdpbmdCdWZmZXJXaWR0aCwgZHJhd2luZ0J1ZmZlckhlaWdodCwgZGlzdGFuY2UsIHBpeGVsUmF0aW8sIHJlc3VsdCkgewogICAgICAgIHVwZGF0ZTIodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW0uZ2V0UGl4ZWxEaW1lbnNpb25zKAogICAgICAgICAgZHJhd2luZ0J1ZmZlcldpZHRoLAogICAgICAgICAgZHJhd2luZ0J1ZmZlckhlaWdodCwKICAgICAgICAgIGRpc3RhbmNlLAogICAgICAgICAgcGl4ZWxSYXRpbywKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE9ydGhvZ3JhcGhpY0ZydXN0dW0oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmFzcGVjdFJhdGlvID0gdGhpcy5hc3BlY3RSYXRpbzsKICAgICAgICByZXN1bHQud2lkdGggPSB0aGlzLndpZHRoOwogICAgICAgIHJlc3VsdC5uZWFyID0gdGhpcy5uZWFyOwogICAgICAgIHJlc3VsdC5mYXIgPSB0aGlzLmZhcjsKICAgICAgICByZXN1bHQuX2FzcGVjdFJhdGlvID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fd2lkdGggPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9uZWFyID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZmFyID0gdm9pZCAwOwogICAgICAgIHRoaXMuX29mZkNlbnRlckZydXN0dW0uY2xvbmUocmVzdWx0Ll9vZmZDZW50ZXJGcnVzdHVtKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG90aGVyKSB8fCAhKG90aGVyIGluc3RhbmNlb2YgT3J0aG9ncmFwaGljRnJ1c3R1bSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlMih0aGlzKTsKICAgICAgICB1cGRhdGUyKG90aGVyKTsKICAgICAgICByZXR1cm4gdGhpcy53aWR0aCA9PT0gb3RoZXIud2lkdGggJiYgdGhpcy5hc3BlY3RSYXRpbyA9PT0gb3RoZXIuYXNwZWN0UmF0aW8gJiYgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5lcXVhbHMob3RoZXIuX29mZkNlbnRlckZydXN0dW0pOwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3RoZXIpIHx8ICEob3RoZXIgaW5zdGFuY2VvZiBPcnRob2dyYXBoaWNGcnVzdHVtKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB1cGRhdGUyKHRoaXMpOwogICAgICAgIHVwZGF0ZTIob3RoZXIpOwogICAgICAgIHJldHVybiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMud2lkdGgsCiAgICAgICAgICBvdGhlci53aWR0aCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmFzcGVjdFJhdGlvLAogICAgICAgICAgb3RoZXIuYXNwZWN0UmF0aW8sCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIHRoaXMuX29mZkNlbnRlckZydXN0dW0uZXF1YWxzRXBzaWxvbigKICAgICAgICAgIG90aGVyLl9vZmZDZW50ZXJGcnVzdHVtLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0ID0gT3J0aG9ncmFwaGljRnJ1c3R1bTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5qcwogIGZ1bmN0aW9uIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMubGVmdCA9IG9wdGlvbnMubGVmdDsKICAgIHRoaXMuX2xlZnQgPSB2b2lkIDA7CiAgICB0aGlzLnJpZ2h0ID0gb3B0aW9ucy5yaWdodDsKICAgIHRoaXMuX3JpZ2h0ID0gdm9pZCAwOwogICAgdGhpcy50b3AgPSBvcHRpb25zLnRvcDsKICAgIHRoaXMuX3RvcCA9IHZvaWQgMDsKICAgIHRoaXMuYm90dG9tID0gb3B0aW9ucy5ib3R0b207CiAgICB0aGlzLl9ib3R0b20gPSB2b2lkIDA7CiAgICB0aGlzLm5lYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm5lYXIsIDEpOwogICAgdGhpcy5fbmVhciA9IHRoaXMubmVhcjsKICAgIHRoaXMuZmFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5mYXIsIDVlOCk7CiAgICB0aGlzLl9mYXIgPSB0aGlzLmZhcjsKICAgIHRoaXMuX2N1bGxpbmdWb2x1bWUgPSBuZXcgQ3VsbGluZ1ZvbHVtZV9kZWZhdWx0KCk7CiAgICB0aGlzLl9wZXJzcGVjdGl2ZU1hdHJpeCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgIHRoaXMuX2luZmluaXRlUGVyc3BlY3RpdmUgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZTMoZnJ1c3R1bSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5yaWdodCkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmxlZnQpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS50b3ApIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5ib3R0b20pIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5uZWFyKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uZmFyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAicmlnaHQsIGxlZnQsIHRvcCwgYm90dG9tLCBuZWFyLCBvciBmYXIgcGFyYW1ldGVycyBhcmUgbm90IHNldC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCB7IHRvcCwgYm90dG9tLCByaWdodCwgbGVmdCwgbmVhciwgZmFyIH0gPSBmcnVzdHVtOwogICAgY29uc3QgY2hhbmdlZCA9IHRvcCAhPT0gZnJ1c3R1bS5fdG9wIHx8IGJvdHRvbSAhPT0gZnJ1c3R1bS5fYm90dG9tIHx8IGxlZnQgIT09IGZydXN0dW0uX2xlZnQgfHwgcmlnaHQgIT09IGZydXN0dW0uX3JpZ2h0IHx8IG5lYXIgIT09IGZydXN0dW0uX25lYXIgfHwgZmFyICE9PSBmcnVzdHVtLl9mYXI7CiAgICBpZiAoIWNoYW5nZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGZydXN0dW0ubmVhciA8PSAwIHx8IGZydXN0dW0ubmVhciA+IGZydXN0dW0uZmFyKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJuZWFyIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8gYW5kIGxlc3MgdGhhbiBmYXIuIgogICAgICApOwogICAgfQogICAgZnJ1c3R1bS5fbGVmdCA9IGxlZnQ7CiAgICBmcnVzdHVtLl9yaWdodCA9IHJpZ2h0OwogICAgZnJ1c3R1bS5fdG9wID0gdG9wOwogICAgZnJ1c3R1bS5fYm90dG9tID0gYm90dG9tOwogICAgZnJ1c3R1bS5fbmVhciA9IG5lYXI7CiAgICBmcnVzdHVtLl9mYXIgPSBmYXI7CiAgICBmcnVzdHVtLl9wZXJzcGVjdGl2ZU1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jb21wdXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIoCiAgICAgIGxlZnQsCiAgICAgIHJpZ2h0LAogICAgICBib3R0b20sCiAgICAgIHRvcCwKICAgICAgbmVhciwKICAgICAgZmFyLAogICAgICBmcnVzdHVtLl9wZXJzcGVjdGl2ZU1hdHJpeAogICAgKTsKICAgIGZydXN0dW0uX2luZmluaXRlUGVyc3BlY3RpdmUgPSBNYXRyaXg0X2RlZmF1bHQuY29tcHV0ZUluZmluaXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIoCiAgICAgIGxlZnQsCiAgICAgIHJpZ2h0LAogICAgICBib3R0b20sCiAgICAgIHRvcCwKICAgICAgbmVhciwKICAgICAgZnJ1c3R1bS5faW5maW5pdGVQZXJzcGVjdGl2ZQogICAgKTsKICB9CiAgdmFyIGdldFBsYW5lc1JpZ2h0MiwgZ2V0UGxhbmVzTmVhckNlbnRlcjIsIGdldFBsYW5lc0ZhckNlbnRlciwgZ2V0UGxhbmVzTm9ybWFsLCBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW1fZGVmYXVsdDsKICB2YXIgaW5pdF9QZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DdWxsaW5nVm9sdW1lKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHBlcnNwZWN0aXZlIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bS4KICAgICAgICAgKiBUaGUgcHJvamVjdGlvbiBtYXRyaXggd2lsbCBiZSByZWNvbXB1dGVkIGlmIGFueSBmcnVzdHVtIHBhcmFtZXRlcnMgaGF2ZSBjaGFuZ2VkLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBzZWUgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtI2luZmluaXRlUHJvamVjdGlvbk1hdHJpeAogICAgICAgICAqLwogICAgICAgIHByb2plY3Rpb25NYXRyaXg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTModGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wZXJzcGVjdGl2ZU1hdHJpeDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHBlcnNwZWN0aXZlIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bSB3aXRoIGFuIGluZmluaXRlIGZhciBwbGFuZS4KICAgICAgICAgKiBAbWVtYmVyb2YgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqCiAgICAgICAgICogQHNlZSBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0jcHJvamVjdGlvbk1hdHJpeAogICAgICAgICAqLwogICAgICAgIGluZmluaXRlUHJvamVjdGlvbk1hdHJpeDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlMyh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2luZmluaXRlUGVyc3BlY3RpdmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgZ2V0UGxhbmVzUmlnaHQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBnZXRQbGFuZXNOZWFyQ2VudGVyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZ2V0UGxhbmVzRmFyQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBnZXRQbGFuZXNOb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuY29tcHV0ZUN1bGxpbmdWb2x1bWUgPSBmdW5jdGlvbihwb3NpdGlvbiwgZGlyZWN0aW9uMiwgdXApIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwb3NpdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGlyZWN0aW9uMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXJlY3Rpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHVwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInVwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwbGFuZXMgPSB0aGlzLl9jdWxsaW5nVm9sdW1lLnBsYW5lczsKICAgICAgICBjb25zdCB0ID0gdGhpcy50b3A7CiAgICAgICAgY29uc3QgYiA9IHRoaXMuYm90dG9tOwogICAgICAgIGNvbnN0IHIgPSB0aGlzLnJpZ2h0OwogICAgICAgIGNvbnN0IGwgPSB0aGlzLmxlZnQ7CiAgICAgICAgY29uc3QgbiA9IHRoaXMubmVhcjsKICAgICAgICBjb25zdCBmID0gdGhpcy5mYXI7CiAgICAgICAgY29uc3QgcmlnaHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZGlyZWN0aW9uMiwgdXAsIGdldFBsYW5lc1JpZ2h0Mik7CiAgICAgICAgY29uc3QgbmVhckNlbnRlciA9IGdldFBsYW5lc05lYXJDZW50ZXIyOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGRpcmVjdGlvbjIsIG4sIG5lYXJDZW50ZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIG5lYXJDZW50ZXIsIG5lYXJDZW50ZXIpOwogICAgICAgIGNvbnN0IGZhckNlbnRlciA9IGdldFBsYW5lc0ZhckNlbnRlcjsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaXJlY3Rpb24yLCBmLCBmYXJDZW50ZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGZhckNlbnRlciwgZmFyQ2VudGVyKTsKICAgICAgICBjb25zdCBub3JtYWwyID0gZ2V0UGxhbmVzTm9ybWFsOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJpZ2h0LCBsLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChub3JtYWwyLCBwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgdXAsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgbGV0IHBsYW5lID0gcGxhbmVzWzBdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbMF0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSBub3JtYWwyLng7CiAgICAgICAgcGxhbmUueSA9IG5vcm1hbDIueTsKICAgICAgICBwbGFuZS56ID0gbm9ybWFsMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBwb3NpdGlvbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIocmlnaHQsIHIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgbm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5vcm1hbDIsIHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModXAsIG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbMV07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1sxXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IG5vcm1hbDIueDsKICAgICAgICBwbGFuZS55ID0gbm9ybWFsMi55OwogICAgICAgIHBsYW5lLnogPSBub3JtYWwyLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIHBvc2l0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih1cCwgYiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qobm9ybWFsMiwgcG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhyaWdodCwgbm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1syXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzJdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gbm9ybWFsMi54OwogICAgICAgIHBsYW5lLnkgPSBub3JtYWwyLnk7CiAgICAgICAgcGxhbmUueiA9IG5vcm1hbDIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgcG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHVwLCB0LCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChub3JtYWwyLCBwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHJpZ2h0LCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzNdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbM10gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSBub3JtYWwyLng7CiAgICAgICAgcGxhbmUueSA9IG5vcm1hbDIueTsKICAgICAgICBwbGFuZS56ID0gbm9ybWFsMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBwb3NpdGlvbik7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbNF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1s0XSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IGRpcmVjdGlvbjIueDsKICAgICAgICBwbGFuZS55ID0gZGlyZWN0aW9uMi55OwogICAgICAgIHBsYW5lLnogPSBkaXJlY3Rpb24yLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIG5lYXJDZW50ZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZGlyZWN0aW9uMiwgbm9ybWFsMik7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbNV07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1s1XSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IG5vcm1hbDIueDsKICAgICAgICBwbGFuZS55ID0gbm9ybWFsMi55OwogICAgICAgIHBsYW5lLnogPSBub3JtYWwyLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIGZhckNlbnRlcik7CiAgICAgICAgcmV0dXJuIHRoaXMuX2N1bGxpbmdWb2x1bWU7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuZ2V0UGl4ZWxEaW1lbnNpb25zID0gZnVuY3Rpb24oZHJhd2luZ0J1ZmZlcldpZHRoLCBkcmF3aW5nQnVmZmVySGVpZ2h0LCBkaXN0YW5jZSwgcGl4ZWxSYXRpbywgcmVzdWx0KSB7CiAgICAgICAgdXBkYXRlMyh0aGlzKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkcmF3aW5nQnVmZmVyV2lkdGgpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZHJhd2luZ0J1ZmZlckhlaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiQm90aCBkcmF3aW5nQnVmZmVyV2lkdGggYW5kIGRyYXdpbmdCdWZmZXJIZWlnaHQgYXJlIHJlcXVpcmVkLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChkcmF3aW5nQnVmZmVyV2lkdGggPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRyYXdpbmdCdWZmZXJXaWR0aCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoZHJhd2luZ0J1ZmZlckhlaWdodCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZHJhd2luZ0J1ZmZlckhlaWdodCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkaXN0YW5jZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXN0YW5jZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGl4ZWxSYXRpbykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXhlbFJhdGlvIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmIChwaXhlbFJhdGlvIDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXhlbFJhdGlvIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBIHJlc3VsdCBvYmplY3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGludmVyc2VOZWFyID0gMSAvIHRoaXMubmVhcjsKICAgICAgICBsZXQgdGFuVGhldGEgPSB0aGlzLnRvcCAqIGludmVyc2VOZWFyOwogICAgICAgIGNvbnN0IHBpeGVsSGVpZ2h0ID0gMiAqIHBpeGVsUmF0aW8gKiBkaXN0YW5jZSAqIHRhblRoZXRhIC8gZHJhd2luZ0J1ZmZlckhlaWdodDsKICAgICAgICB0YW5UaGV0YSA9IHRoaXMucmlnaHQgKiBpbnZlcnNlTmVhcjsKICAgICAgICBjb25zdCBwaXhlbFdpZHRoID0gMiAqIHBpeGVsUmF0aW8gKiBkaXN0YW5jZSAqIHRhblRoZXRhIC8gZHJhd2luZ0J1ZmZlcldpZHRoOwogICAgICAgIHJlc3VsdC54ID0gcGl4ZWxXaWR0aDsKICAgICAgICByZXN1bHQueSA9IHBpeGVsSGVpZ2h0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yaWdodCA9IHRoaXMucmlnaHQ7CiAgICAgICAgcmVzdWx0LmxlZnQgPSB0aGlzLmxlZnQ7CiAgICAgICAgcmVzdWx0LnRvcCA9IHRoaXMudG9wOwogICAgICAgIHJlc3VsdC5ib3R0b20gPSB0aGlzLmJvdHRvbTsKICAgICAgICByZXN1bHQubmVhciA9IHRoaXMubmVhcjsKICAgICAgICByZXN1bHQuZmFyID0gdGhpcy5mYXI7CiAgICAgICAgcmVzdWx0Ll9sZWZ0ID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fcmlnaHQgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll90b3AgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9ib3R0b20gPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9uZWFyID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZmFyID0gdm9pZCAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gZGVmaW5lZF9kZWZhdWx0KG90aGVyKSAmJiBvdGhlciBpbnN0YW5jZW9mIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSAmJiB0aGlzLnJpZ2h0ID09PSBvdGhlci5yaWdodCAmJiB0aGlzLmxlZnQgPT09IG90aGVyLmxlZnQgJiYgdGhpcy50b3AgPT09IG90aGVyLnRvcCAmJiB0aGlzLmJvdHRvbSA9PT0gb3RoZXIuYm90dG9tICYmIHRoaXMubmVhciA9PT0gb3RoZXIubmVhciAmJiB0aGlzLmZhciA9PT0gb3RoZXIuZmFyOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihvdGhlciwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gb3RoZXIgPT09IHRoaXMgfHwgZGVmaW5lZF9kZWZhdWx0KG90aGVyKSAmJiBvdGhlciBpbnN0YW5jZW9mIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMucmlnaHQsCiAgICAgICAgICBvdGhlci5yaWdodCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmxlZnQsCiAgICAgICAgICBvdGhlci5sZWZ0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMudG9wLAogICAgICAgICAgb3RoZXIudG9wLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMuYm90dG9tLAogICAgICAgICAgb3RoZXIuYm90dG9tLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMubmVhciwKICAgICAgICAgIG90aGVyLm5lYXIsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5mYXIsCiAgICAgICAgICBvdGhlci5mYXIsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW1fZGVmYXVsdCA9IFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BlcnNwZWN0aXZlRnJ1c3R1bS5qcwogIGZ1bmN0aW9uIFBlcnNwZWN0aXZlRnJ1c3R1bShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMuX29mZkNlbnRlckZydXN0dW0gPSBuZXcgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtX2RlZmF1bHQoKTsKICAgIHRoaXMuZm92ID0gb3B0aW9ucy5mb3Y7CiAgICB0aGlzLl9mb3YgPSB2b2lkIDA7CiAgICB0aGlzLl9mb3Z5ID0gdm9pZCAwOwogICAgdGhpcy5fc3NlRGVub21pbmF0b3IgPSB2b2lkIDA7CiAgICB0aGlzLmFzcGVjdFJhdGlvID0gb3B0aW9ucy5hc3BlY3RSYXRpbzsKICAgIHRoaXMuX2FzcGVjdFJhdGlvID0gdm9pZCAwOwogICAgdGhpcy5uZWFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5uZWFyLCAxKTsKICAgIHRoaXMuX25lYXIgPSB0aGlzLm5lYXI7CiAgICB0aGlzLmZhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZmFyLCA1ZTgpOwogICAgdGhpcy5fZmFyID0gdGhpcy5mYXI7CiAgICB0aGlzLnhPZmZzZXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnhPZmZzZXQsIDApOwogICAgdGhpcy5feE9mZnNldCA9IHRoaXMueE9mZnNldDsKICAgIHRoaXMueU9mZnNldCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMueU9mZnNldCwgMCk7CiAgICB0aGlzLl95T2Zmc2V0ID0gdGhpcy55T2Zmc2V0OwogIH0KICBmdW5jdGlvbiB1cGRhdGU0KGZydXN0dW0pIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uZm92KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uYXNwZWN0UmF0aW8pIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5uZWFyKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uZmFyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiZm92LCBhc3BlY3RSYXRpbywgbmVhciwgb3IgZmFyIHBhcmFtZXRlcnMgYXJlIG5vdCBzZXQuIgogICAgICApOwogICAgfQogICAgY29uc3QgY2hhbmdlZCA9IGZydXN0dW0uZm92ICE9PSBmcnVzdHVtLl9mb3YgfHwgZnJ1c3R1bS5hc3BlY3RSYXRpbyAhPT0gZnJ1c3R1bS5fYXNwZWN0UmF0aW8gfHwgZnJ1c3R1bS5uZWFyICE9PSBmcnVzdHVtLl9uZWFyIHx8IGZydXN0dW0uZmFyICE9PSBmcnVzdHVtLl9mYXIgfHwgZnJ1c3R1bS54T2Zmc2V0ICE9PSBmcnVzdHVtLl94T2Zmc2V0IHx8IGZydXN0dW0ueU9mZnNldCAhPT0gZnJ1c3R1bS5feU9mZnNldDsKICAgIGlmICghY2hhbmdlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZm92IiwgZnJ1c3R1bS5mb3YsIDApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuKCJmb3YiLCBmcnVzdHVtLmZvdiwgTWF0aC5QSSk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgImFzcGVjdFJhdGlvIiwKICAgICAgZnJ1c3R1bS5hc3BlY3RSYXRpbywKICAgICAgMAogICAgKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJuZWFyIiwgZnJ1c3R1bS5uZWFyLCAwKTsKICAgIGlmIChmcnVzdHVtLm5lYXIgPiBmcnVzdHVtLmZhcikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibmVhciBtdXN0IGJlIGxlc3MgdGhhbiBmYXIuIik7CiAgICB9CiAgICBmcnVzdHVtLl9hc3BlY3RSYXRpbyA9IGZydXN0dW0uYXNwZWN0UmF0aW87CiAgICBmcnVzdHVtLl9mb3YgPSBmcnVzdHVtLmZvdjsKICAgIGZydXN0dW0uX2ZvdnkgPSBmcnVzdHVtLmFzcGVjdFJhdGlvIDw9IDEgPyBmcnVzdHVtLmZvdiA6IE1hdGguYXRhbihNYXRoLnRhbihmcnVzdHVtLmZvdiAqIDAuNSkgLyBmcnVzdHVtLmFzcGVjdFJhdGlvKSAqIDI7CiAgICBmcnVzdHVtLl9uZWFyID0gZnJ1c3R1bS5uZWFyOwogICAgZnJ1c3R1bS5fZmFyID0gZnJ1c3R1bS5mYXI7CiAgICBmcnVzdHVtLl9zc2VEZW5vbWluYXRvciA9IDIgKiBNYXRoLnRhbigwLjUgKiBmcnVzdHVtLl9mb3Z5KTsKICAgIGZydXN0dW0uX3hPZmZzZXQgPSBmcnVzdHVtLnhPZmZzZXQ7CiAgICBmcnVzdHVtLl95T2Zmc2V0ID0gZnJ1c3R1bS55T2Zmc2V0OwogICAgY29uc3QgZiA9IGZydXN0dW0uX29mZkNlbnRlckZydXN0dW07CiAgICBmLnRvcCA9IGZydXN0dW0ubmVhciAqIE1hdGgudGFuKDAuNSAqIGZydXN0dW0uX2ZvdnkpOwogICAgZi5ib3R0b20gPSAtZi50b3A7CiAgICBmLnJpZ2h0ID0gZnJ1c3R1bS5hc3BlY3RSYXRpbyAqIGYudG9wOwogICAgZi5sZWZ0ID0gLWYucmlnaHQ7CiAgICBmLm5lYXIgPSBmcnVzdHVtLm5lYXI7CiAgICBmLmZhciA9IGZydXN0dW0uZmFyOwogICAgZi5yaWdodCArPSBmcnVzdHVtLnhPZmZzZXQ7CiAgICBmLmxlZnQgKz0gZnJ1c3R1bS54T2Zmc2V0OwogICAgZi50b3AgKz0gZnJ1c3R1bS55T2Zmc2V0OwogICAgZi5ib3R0b20gKz0gZnJ1c3R1bS55T2Zmc2V0OwogIH0KICB2YXIgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQ7CiAgdmFyIGluaXRfUGVyc3BlY3RpdmVGcnVzdHVtID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QZXJzcGVjdGl2ZUZydXN0dW0uanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSgpOwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucGFja2VkTGVuZ3RoID0gNjsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5mb3Y7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmFzcGVjdFJhdGlvOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5uZWFyOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5mYXI7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnhPZmZzZXQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS55T2Zmc2V0OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUGVyc3BlY3RpdmVGcnVzdHVtKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5mb3YgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5hc3BlY3RSYXRpbyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0Lm5lYXIgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5mYXIgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC54T2Zmc2V0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueU9mZnNldCA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBwZXJzcGVjdGl2ZSBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0uCiAgICAgICAgICogSWYgbmVjZXNzYXJ5LCB0aGUgcHJvamVjdGlvbiBtYXRyaXggd2lsbCBiZSByZWNvbXB1dGVkLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBzZWUgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtI3Byb2plY3Rpb25NYXRyaXguCiAgICAgICAgICogQHNlZSBQZXJzcGVjdGl2ZUZydXN0dW0jaW5maW5pdGVQcm9qZWN0aW9uTWF0cml4CiAgICAgICAgICovCiAgICAgICAgcHJvamVjdGlvbk1hdHJpeDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW0ucHJvamVjdGlvbk1hdHJpeDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBwZXJzcGVjdGl2ZSBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0gd2l0aCBhbiBpbmZpbml0ZSBmYXIgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBzZWUgUGVyc3BlY3RpdmVGcnVzdHVtI3Byb2plY3Rpb25NYXRyaXgKICAgICAgICAgKi8KICAgICAgICBpbmZpbml0ZVByb2plY3Rpb25NYXRyaXg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmluZmluaXRlUHJvamVjdGlvbk1hdHJpeDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGFuZ2xlIG9mIHRoZSB2ZXJ0aWNhbCBmaWVsZCBvZiB2aWV3LCBpbiByYWRpYW5zLgogICAgICAgICAqIEBtZW1iZXJvZiBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcnx1bmRlZmluZWR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICogQGRlZmF1bHQgdW5kZWZpbmVkCiAgICAgICAgICovCiAgICAgICAgZm92eTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2Zvdnk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHNzZURlbm9taW5hdG9yOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fc3NlRGVub21pbmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcnRob2dyYXBoaWMgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtLgogICAgICAgICAqIEBtZW1iZXJvZiBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge1BlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bX0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIG9mZkNlbnRlckZydXN0dW06IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUuY29tcHV0ZUN1bGxpbmdWb2x1bWUgPSBmdW5jdGlvbihwb3NpdGlvbiwgZGlyZWN0aW9uMiwgdXApIHsKICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmNvbXB1dGVDdWxsaW5nVm9sdW1lKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCk7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUuZ2V0UGl4ZWxEaW1lbnNpb25zID0gZnVuY3Rpb24oZHJhd2luZ0J1ZmZlcldpZHRoLCBkcmF3aW5nQnVmZmVySGVpZ2h0LCBkaXN0YW5jZSwgcGl4ZWxSYXRpbywgcmVzdWx0KSB7CiAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5nZXRQaXhlbERpbWVuc2lvbnMoCiAgICAgICAgICBkcmF3aW5nQnVmZmVyV2lkdGgsCiAgICAgICAgICBkcmF3aW5nQnVmZmVySGVpZ2h0LAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICBwaXhlbFJhdGlvLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBQZXJzcGVjdGl2ZUZydXN0dW0oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmFzcGVjdFJhdGlvID0gdGhpcy5hc3BlY3RSYXRpbzsKICAgICAgICByZXN1bHQuZm92ID0gdGhpcy5mb3Y7CiAgICAgICAgcmVzdWx0Lm5lYXIgPSB0aGlzLm5lYXI7CiAgICAgICAgcmVzdWx0LmZhciA9IHRoaXMuZmFyOwogICAgICAgIHJlc3VsdC5fYXNwZWN0UmF0aW8gPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9mb3YgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9uZWFyID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZmFyID0gdm9pZCAwOwogICAgICAgIHRoaXMuX29mZkNlbnRlckZydXN0dW0uY2xvbmUocmVzdWx0Ll9vZmZDZW50ZXJGcnVzdHVtKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3RoZXIpIHx8ICEob3RoZXIgaW5zdGFuY2VvZiBQZXJzcGVjdGl2ZUZydXN0dW0pKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgdXBkYXRlNChvdGhlcik7CiAgICAgICAgcmV0dXJuIHRoaXMuZm92ID09PSBvdGhlci5mb3YgJiYgdGhpcy5hc3BlY3RSYXRpbyA9PT0gb3RoZXIuYXNwZWN0UmF0aW8gJiYgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5lcXVhbHMob3RoZXIuX29mZkNlbnRlckZydXN0dW0pOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihvdGhlciwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvdGhlcikgfHwgIShvdGhlciBpbnN0YW5jZW9mIFBlcnNwZWN0aXZlRnJ1c3R1bSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICB1cGRhdGU0KG90aGVyKTsKICAgICAgICByZXR1cm4gTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmZvdiwKICAgICAgICAgIG90aGVyLmZvdiwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmFzcGVjdFJhdGlvLAogICAgICAgICAgb3RoZXIuYXNwZWN0UmF0aW8sCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIHRoaXMuX29mZkNlbnRlckZydXN0dW0uZXF1YWxzRXBzaWxvbigKICAgICAgICAgIG90aGVyLl9vZmZDZW50ZXJGcnVzdHVtLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQgPSBQZXJzcGVjdGl2ZUZydXN0dW07CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GcnVzdHVtR2VvbWV0cnkuanMKICBmdW5jdGlvbiBGcnVzdHVtR2VvbWV0cnkob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMuZnJ1c3R1bSIsIG9wdGlvbnMuZnJ1c3R1bSk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMub3JpZ2luIiwgb3B0aW9ucy5vcmlnaW4pOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLm9yaWVudGF0aW9uIiwgb3B0aW9ucy5vcmllbnRhdGlvbik7CiAgICBjb25zdCBmcnVzdHVtID0gb3B0aW9ucy5mcnVzdHVtOwogICAgY29uc3Qgb3JpZW50YXRpb24gPSBvcHRpb25zLm9yaWVudGF0aW9uOwogICAgY29uc3Qgb3JpZ2luID0gb3B0aW9ucy5vcmlnaW47CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5fZHJhd05lYXJQbGFuZSwgdHJ1ZSk7CiAgICBsZXQgZnJ1c3R1bVR5cGU7CiAgICBsZXQgZnJ1c3R1bVBhY2tlZExlbmd0aDsKICAgIGlmIChmcnVzdHVtIGluc3RhbmNlb2YgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQpIHsKICAgICAgZnJ1c3R1bVR5cGUgPSBQRVJTUEVDVElWRTsKICAgICAgZnJ1c3R1bVBhY2tlZExlbmd0aCA9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0gZWxzZSBpZiAoZnJ1c3R1bSBpbnN0YW5jZW9mIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdCkgewogICAgICBmcnVzdHVtVHlwZSA9IE9SVEhPR1JBUEhJQzsKICAgICAgZnJ1c3R1bVBhY2tlZExlbmd0aCA9IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9CiAgICB0aGlzLl9mcnVzdHVtVHlwZSA9IGZydXN0dW1UeXBlOwogICAgdGhpcy5fZnJ1c3R1bSA9IGZydXN0dW0uY2xvbmUoKTsKICAgIHRoaXMuX29yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShvcmlnaW4pOwogICAgdGhpcy5fb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuY2xvbmUob3JpZW50YXRpb24pOwogICAgdGhpcy5fZHJhd05lYXJQbGFuZSA9IGRyYXdOZWFyUGxhbmU7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSB2ZXJ0ZXhGb3JtYXQ7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUZydXN0dW1HZW9tZXRyeSI7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IDIgKyBmcnVzdHVtUGFja2VkTGVuZ3RoICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgfQogIGZ1bmN0aW9uIGdldEF0dHJpYnV0ZXMob2Zmc2V0LCBub3JtYWxzLCB0YW5nZW50cywgYml0YW5nZW50cywgc3QsIG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCkgewogICAgY29uc3Qgc3RPZmZzZXQgPSBvZmZzZXQgLyAzICogMjsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgKytpKSB7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgICBub3JtYWxzW29mZnNldF0gPSBub3JtYWwyLng7CiAgICAgICAgbm9ybWFsc1tvZmZzZXQgKyAxXSA9IG5vcm1hbDIueTsKICAgICAgICBub3JtYWxzW29mZnNldCArIDJdID0gbm9ybWFsMi56OwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGFuZ2VudHMpKSB7CiAgICAgICAgdGFuZ2VudHNbb2Zmc2V0XSA9IHRhbmdlbnQueDsKICAgICAgICB0YW5nZW50c1tvZmZzZXQgKyAxXSA9IHRhbmdlbnQueTsKICAgICAgICB0YW5nZW50c1tvZmZzZXQgKyAyXSA9IHRhbmdlbnQuejsKICAgICAgfQogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudHMpKSB7CiAgICAgICAgYml0YW5nZW50c1tvZmZzZXRdID0gYml0YW5nZW50Lng7CiAgICAgICAgYml0YW5nZW50c1tvZmZzZXQgKyAxXSA9IGJpdGFuZ2VudC55OwogICAgICAgIGJpdGFuZ2VudHNbb2Zmc2V0ICsgMl0gPSBiaXRhbmdlbnQuejsKICAgICAgfQogICAgICBvZmZzZXQgKz0gMzsKICAgIH0KICAgIHN0W3N0T2Zmc2V0XSA9IDA7CiAgICBzdFtzdE9mZnNldCArIDFdID0gMDsKICAgIHN0W3N0T2Zmc2V0ICsgMl0gPSAxOwogICAgc3Rbc3RPZmZzZXQgKyAzXSA9IDA7CiAgICBzdFtzdE9mZnNldCArIDRdID0gMTsKICAgIHN0W3N0T2Zmc2V0ICsgNV0gPSAxOwogICAgc3Rbc3RPZmZzZXQgKyA2XSA9IDA7CiAgICBzdFtzdE9mZnNldCArIDddID0gMTsKICB9CiAgdmFyIFBFUlNQRUNUSVZFLCBPUlRIT0dSQVBISUMsIHNjcmF0Y2hQYWNrUGVyc3BlY3RpdmUsIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljLCBzY3JhdGNoUGFja1F1YXRlcm5pb24sIHNjcmF0Y2hQYWNrb3JpZ2luLCBzY3JhdGNoVmVydGV4Rm9ybWF0Nywgc2NyYXRjaFJvdGF0aW9uTWF0cml4Miwgc2NyYXRjaFZpZXdNYXRyaXgsIHNjcmF0Y2hJbnZlcnNlTWF0cml4LCBzY3JhdGNoWERpcmVjdGlvbiwgc2NyYXRjaFlEaXJlY3Rpb24sIHNjcmF0Y2haRGlyZWN0aW9uLCBzY3JhdGNoTmVnYXRpdmVYLCBzY3JhdGNoTmVnYXRpdmVZLCBzY3JhdGNoTmVnYXRpdmVaLCBmcnVzdHVtU3BsaXRzLCBmcnVzdHVtQ29ybmVyc05EQywgc2NyYXRjaEZydXN0dW1Db3JuZXJzLCBGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9GcnVzdHVtR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ZydXN0dW1HZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfT3J0aG9ncmFwaGljRnJ1c3R1bSgpOwogICAgICBpbml0X1BlcnNwZWN0aXZlRnJ1c3R1bSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIFBFUlNQRUNUSVZFID0gMDsKICAgICAgT1JUSE9HUkFQSElDID0gMTsKICAgICAgRnJ1c3R1bUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gdmFsdWUuX2ZydXN0dW1UeXBlOwogICAgICAgIGNvbnN0IGZydXN0dW0gPSB2YWx1ZS5fZnJ1c3R1bTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZnJ1c3R1bVR5cGU7CiAgICAgICAgaWYgKGZydXN0dW1UeXBlID09PSBQRVJTUEVDVElWRSkgewogICAgICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFjayhmcnVzdHVtLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ICs9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2soZnJ1c3R1bSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fb3JpZ2luLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrKHZhbHVlLl9vcmllbnRhdGlvbiwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUXVhdGVybmlvbl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9kcmF3TmVhclBsYW5lID8gMSA6IDA7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoUGFja1BlcnNwZWN0aXZlID0gbmV3IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljID0gbmV3IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGFja1F1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQYWNrb3JpZ2luID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NyA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBGcnVzdHVtR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBsZXQgZnJ1c3R1bTsKICAgICAgICBpZiAoZnJ1c3R1bVR5cGUgPT09IFBFUlNQRUNUSVZFKSB7CiAgICAgICAgICBmcnVzdHVtID0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgc2NyYXRjaFBhY2tQZXJzcGVjdGl2ZQogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcnVzdHVtID0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0KICAgICAgICBjb25zdCBvcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUGFja29yaWdpbik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hQYWNrUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBRdWF0ZXJuaW9uX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ3CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gYXJyYXlbc3RhcnRpbmdJbmRleF0gPT09IDE7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBGcnVzdHVtR2VvbWV0cnkoewogICAgICAgICAgICBmcnVzdHVtLAogICAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICAgIG9yaWVudGF0aW9uLAogICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICAgIF9kcmF3TmVhclBsYW5lOiBkcmF3TmVhclBsYW5lCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnJ1c3R1bVJlc3VsdCA9IGZydXN0dW1UeXBlID09PSByZXN1bHQuX2ZydXN0dW1UeXBlID8gcmVzdWx0Ll9mcnVzdHVtIDogdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZnJ1c3R1bSA9IGZydXN0dW0uY2xvbmUoZnJ1c3R1bVJlc3VsdCk7CiAgICAgICAgcmVzdWx0Ll9mcnVzdHVtVHlwZSA9IGZydXN0dW1UeXBlOwogICAgICAgIHJlc3VsdC5fb3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG9yaWdpbiwgcmVzdWx0Ll9vcmlnaW4pOwogICAgICAgIHJlc3VsdC5fb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuY2xvbmUob3JpZW50YXRpb24sIHJlc3VsdC5fb3JpZW50YXRpb24pOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9kcmF3TmVhclBsYW5lID0gZHJhd05lYXJQbGFuZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoUm90YXRpb25NYXRyaXgyID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmlld01hdHJpeCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEludmVyc2VNYXRyaXggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hYRGlyZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWURpcmVjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFpEaXJlY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOZWdhdGl2ZVggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOZWdhdGl2ZVkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOZWdhdGl2ZVogPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZydXN0dW1TcGxpdHMgPSBuZXcgQXJyYXkoMyk7CiAgICAgIGZydXN0dW1Db3JuZXJzTkRDID0gbmV3IEFycmF5KDQpOwogICAgICBmcnVzdHVtQ29ybmVyc05EQ1swXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoLTEsIC0xLCAxLCAxKTsKICAgICAgZnJ1c3R1bUNvcm5lcnNORENbMV0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KDEsIC0xLCAxLCAxKTsKICAgICAgZnJ1c3R1bUNvcm5lcnNORENbMl0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KDEsIDEsIDEsIDEpOwogICAgICBmcnVzdHVtQ29ybmVyc05EQ1szXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoLTEsIDEsIDEsIDEpOwogICAgICBzY3JhdGNoRnJ1c3R1bUNvcm5lcnMgPSBuZXcgQXJyYXkoNCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgKytpKSB7CiAgICAgICAgc2NyYXRjaEZydXN0dW1Db3JuZXJzW2ldID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICB9CiAgICAgIEZydXN0dW1HZW9tZXRyeS5fY29tcHV0ZU5lYXJGYXJQbGFuZXMgPSBmdW5jdGlvbihvcmlnaW4sIG9yaWVudGF0aW9uLCBmcnVzdHVtVHlwZSwgZnJ1c3R1bSwgcG9zaXRpb25zLCB4RGlyZWN0aW9uLCB5RGlyZWN0aW9uLCB6RGlyZWN0aW9uKSB7CiAgICAgICAgY29uc3Qgcm90YXRpb25NYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgICBvcmllbnRhdGlvbiwKICAgICAgICAgIHNjcmF0Y2hSb3RhdGlvbk1hdHJpeDIKICAgICAgICApOwogICAgICAgIGxldCB4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeERpcmVjdGlvbiwgc2NyYXRjaFhEaXJlY3Rpb24pOwogICAgICAgIGxldCB5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeURpcmVjdGlvbiwgc2NyYXRjaFlEaXJlY3Rpb24pOwogICAgICAgIGxldCB6ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoekRpcmVjdGlvbiwgc2NyYXRjaFpEaXJlY3Rpb24pOwogICAgICAgIHggPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKHJvdGF0aW9uTWF0cml4LCAwLCB4KTsKICAgICAgICB5ID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihyb3RhdGlvbk1hdHJpeCwgMSwgeSk7CiAgICAgICAgeiA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb25NYXRyaXgsIDIsIHopOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoeCwgeCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh5LCB5KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHosIHopOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoeCwgeCk7CiAgICAgICAgY29uc3QgdmlldyA9IE1hdHJpeDRfZGVmYXVsdC5jb21wdXRlVmlldyhvcmlnaW4sIHosIHksIHgsIHNjcmF0Y2hWaWV3TWF0cml4KTsKICAgICAgICBsZXQgaW52ZXJzZVZpZXc7CiAgICAgICAgbGV0IGludmVyc2VWaWV3UHJvamVjdGlvbjsKICAgICAgICBjb25zdCBwcm9qZWN0aW9uID0gZnJ1c3R1bS5wcm9qZWN0aW9uTWF0cml4OwogICAgICAgIGlmIChmcnVzdHVtVHlwZSA9PT0gUEVSU1BFQ1RJVkUpIHsKICAgICAgICAgIGNvbnN0IHZpZXdQcm9qZWN0aW9uID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KAogICAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgICB2aWV3LAogICAgICAgICAgICBzY3JhdGNoSW52ZXJzZU1hdHJpeAogICAgICAgICAgKTsKICAgICAgICAgIGludmVyc2VWaWV3UHJvamVjdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlKAogICAgICAgICAgICB2aWV3UHJvamVjdGlvbiwKICAgICAgICAgICAgc2NyYXRjaEludmVyc2VNYXRyaXgKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGludmVyc2VWaWV3ID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2VUcmFuc2Zvcm1hdGlvbih2aWV3LCBzY3JhdGNoSW52ZXJzZU1hdHJpeCk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW52ZXJzZVZpZXdQcm9qZWN0aW9uKSkgewogICAgICAgICAgZnJ1c3R1bVNwbGl0c1swXSA9IGZydXN0dW0ubmVhcjsKICAgICAgICAgIGZydXN0dW1TcGxpdHNbMV0gPSBmcnVzdHVtLmZhcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJ1c3R1bVNwbGl0c1swXSA9IDA7CiAgICAgICAgICBmcnVzdHVtU3BsaXRzWzFdID0gZnJ1c3R1bS5uZWFyOwogICAgICAgICAgZnJ1c3R1bVNwbGl0c1syXSA9IGZydXN0dW0uZmFyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI7ICsraSkgewogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA0OyArK2opIHsKICAgICAgICAgICAgbGV0IGNvcm5lciA9IENhcnRlc2lhbjRfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgICAgICBmcnVzdHVtQ29ybmVyc05EQ1tqXSwKICAgICAgICAgICAgICBzY3JhdGNoRnJ1c3R1bUNvcm5lcnNbal0KICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW52ZXJzZVZpZXdQcm9qZWN0aW9uKSkgewogICAgICAgICAgICAgIGNvbnN0IG9mZkNlbnRlckZydXN0dW0gPSBmcnVzdHVtLm9mZkNlbnRlckZydXN0dW07CiAgICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZDZW50ZXJGcnVzdHVtKSkgewogICAgICAgICAgICAgICAgZnJ1c3R1bSA9IG9mZkNlbnRlckZydXN0dW07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IG5lYXIgPSBmcnVzdHVtU3BsaXRzW2ldOwogICAgICAgICAgICAgIGNvbnN0IGZhciA9IGZydXN0dW1TcGxpdHNbaSArIDFdOwogICAgICAgICAgICAgIGNvcm5lci54ID0gKGNvcm5lci54ICogKGZydXN0dW0ucmlnaHQgLSBmcnVzdHVtLmxlZnQpICsgZnJ1c3R1bS5sZWZ0ICsgZnJ1c3R1bS5yaWdodCkgKiAwLjU7CiAgICAgICAgICAgICAgY29ybmVyLnkgPSAoY29ybmVyLnkgKiAoZnJ1c3R1bS50b3AgLSBmcnVzdHVtLmJvdHRvbSkgKyBmcnVzdHVtLmJvdHRvbSArIGZydXN0dW0udG9wKSAqIDAuNTsKICAgICAgICAgICAgICBjb3JuZXIueiA9IChjb3JuZXIueiAqIChuZWFyIC0gZmFyKSAtIG5lYXIgLSBmYXIpICogMC41OwogICAgICAgICAgICAgIGNvcm5lci53ID0gMTsKICAgICAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihpbnZlcnNlVmlldywgY29ybmVyLCBjb3JuZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvcm5lciA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgICAgICAgaW52ZXJzZVZpZXdQcm9qZWN0aW9uLAogICAgICAgICAgICAgICAgY29ybmVyLAogICAgICAgICAgICAgICAgY29ybmVyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBjb25zdCB3ID0gMSAvIGNvcm5lci53OwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBvcmlnaW4sIGNvcm5lcik7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShjb3JuZXIsIGNvcm5lcik7CiAgICAgICAgICAgICAgY29uc3QgZmFjID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh6LCBjb3JuZXIpOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGNvcm5lciwgZnJ1c3R1bVNwbGl0c1tpXSAvIGZhYywgY29ybmVyKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgb3JpZ2luLCBjb3JuZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMiAqIGkgKyBqICogM10gPSBjb3JuZXIueDsKICAgICAgICAgICAgcG9zaXRpb25zWzEyICogaSArIGogKiAzICsgMV0gPSBjb3JuZXIueTsKICAgICAgICAgICAgcG9zaXRpb25zWzEyICogaSArIGogKiAzICsgMl0gPSBjb3JuZXIuejsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIEZydXN0dW1HZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGZydXN0dW1HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gZnJ1c3R1bUdlb21ldHJ5Ll9mcnVzdHVtVHlwZTsKICAgICAgICBjb25zdCBmcnVzdHVtID0gZnJ1c3R1bUdlb21ldHJ5Ll9mcnVzdHVtOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IGZydXN0dW1HZW9tZXRyeS5fb3JpZ2luOwogICAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gZnJ1c3R1bUdlb21ldHJ5Ll9vcmllbnRhdGlvbjsKICAgICAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gZnJ1c3R1bUdlb21ldHJ5Ll9kcmF3TmVhclBsYW5lOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGZydXN0dW1HZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IG51bWJlck9mUGxhbmVzID0gZHJhd05lYXJQbGFuZSA/IDYgOiA1OwogICAgICAgIGxldCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDMgKiA0ICogNik7CiAgICAgICAgRnJ1c3R1bUdlb21ldHJ5Ll9jb21wdXRlTmVhckZhclBsYW5lcygKICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgIG9yaWVudGF0aW9uLAogICAgICAgICAgZnJ1c3R1bVR5cGUsCiAgICAgICAgICBmcnVzdHVtLAogICAgICAgICAgcG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBsZXQgb2Zmc2V0ID0gMyAqIDQgKiAyOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXRdID0gcG9zaXRpb25zWzMgKiA0XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMV0gPSBwb3NpdGlvbnNbMyAqIDQgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMl0gPSBwb3NpdGlvbnNbMyAqIDQgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgM10gPSBwb3NpdGlvbnNbMF07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDRdID0gcG9zaXRpb25zWzFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA1XSA9IHBvc2l0aW9uc1syXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNl0gPSBwb3NpdGlvbnNbMyAqIDNdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA3XSA9IHBvc2l0aW9uc1szICogMyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA4XSA9IHBvc2l0aW9uc1szICogMyArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA5XSA9IHBvc2l0aW9uc1szICogN107CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDEwXSA9IHBvc2l0aW9uc1szICogNyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMV0gPSBwb3NpdGlvbnNbMyAqIDcgKyAyXTsKICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgcG9zaXRpb25zW29mZnNldF0gPSBwb3NpdGlvbnNbMyAqIDVdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxXSA9IHBvc2l0aW9uc1szICogNSArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAyXSA9IHBvc2l0aW9uc1szICogNSArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAzXSA9IHBvc2l0aW9uc1szXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNF0gPSBwb3NpdGlvbnNbMyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA1XSA9IHBvc2l0aW9uc1szICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDZdID0gcG9zaXRpb25zWzBdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA3XSA9IHBvc2l0aW9uc1sxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOF0gPSBwb3NpdGlvbnNbMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDldID0gcG9zaXRpb25zWzMgKiA0XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTBdID0gcG9zaXRpb25zWzMgKiA0ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDExXSA9IHBvc2l0aW9uc1szICogNCArIDJdOwogICAgICAgIG9mZnNldCArPSAzICogNDsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0XSA9IHBvc2l0aW9uc1szXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMV0gPSBwb3NpdGlvbnNbMyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAyXSA9IHBvc2l0aW9uc1szICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDNdID0gcG9zaXRpb25zWzMgKiA1XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNF0gPSBwb3NpdGlvbnNbMyAqIDUgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNV0gPSBwb3NpdGlvbnNbMyAqIDUgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNl0gPSBwb3NpdGlvbnNbMyAqIDZdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA3XSA9IHBvc2l0aW9uc1szICogNiArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA4XSA9IHBvc2l0aW9uc1szICogNiArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA5XSA9IHBvc2l0aW9uc1szICogMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDEwXSA9IHBvc2l0aW9uc1szICogMiArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMV0gPSBwb3NpdGlvbnNbMyAqIDIgKyAyXTsKICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgcG9zaXRpb25zW29mZnNldF0gPSBwb3NpdGlvbnNbMyAqIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxXSA9IHBvc2l0aW9uc1szICogMiArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAyXSA9IHBvc2l0aW9uc1szICogMiArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAzXSA9IHBvc2l0aW9uc1szICogNl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDRdID0gcG9zaXRpb25zWzMgKiA2ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDVdID0gcG9zaXRpb25zWzMgKiA2ICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDZdID0gcG9zaXRpb25zWzMgKiA3XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgN10gPSBwb3NpdGlvbnNbMyAqIDcgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOF0gPSBwb3NpdGlvbnNbMyAqIDcgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOV0gPSBwb3NpdGlvbnNbMyAqIDNdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMF0gPSBwb3NpdGlvbnNbMyAqIDMgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTFdID0gcG9zaXRpb25zWzMgKiAzICsgMl07CiAgICAgICAgaWYgKCFkcmF3TmVhclBsYW5lKSB7CiAgICAgICAgICBwb3NpdGlvbnMgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMyAqIDQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KHsKICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB8fCBkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHx8IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB8fCBkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0LnN0KSkgewogICAgICAgICAgY29uc3Qgbm9ybWFscyA9IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSA/IG5ldyBGbG9hdDMyQXJyYXkoMyAqIDQgKiBudW1iZXJPZlBsYW5lcykgOiB2b2lkIDA7CiAgICAgICAgICBjb25zdCB0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgPyBuZXcgRmxvYXQzMkFycmF5KDMgKiA0ICogbnVtYmVyT2ZQbGFuZXMpIDogdm9pZCAwOwogICAgICAgICAgY29uc3QgYml0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSA/IG5ldyBGbG9hdDMyQXJyYXkoMyAqIDQgKiBudW1iZXJPZlBsYW5lcykgOiB2b2lkIDA7CiAgICAgICAgICBjb25zdCBzdCA9IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQuc3QpID8gbmV3IEZsb2F0MzJBcnJheSgyICogNCAqIG51bWJlck9mUGxhbmVzKSA6IHZvaWQgMDsKICAgICAgICAgIGNvbnN0IHggPSBzY3JhdGNoWERpcmVjdGlvbjsKICAgICAgICAgIGNvbnN0IHkgPSBzY3JhdGNoWURpcmVjdGlvbjsKICAgICAgICAgIGNvbnN0IHogPSBzY3JhdGNoWkRpcmVjdGlvbjsKICAgICAgICAgIGNvbnN0IG5lZ2F0aXZlWDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHgsIHNjcmF0Y2hOZWdhdGl2ZVgpOwogICAgICAgICAgY29uc3QgbmVnYXRpdmVZID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSh5LCBzY3JhdGNoTmVnYXRpdmVZKTsKICAgICAgICAgIGNvbnN0IG5lZ2F0aXZlWiA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoeiwgc2NyYXRjaE5lZ2F0aXZlWik7CiAgICAgICAgICBvZmZzZXQgPSAwOwogICAgICAgICAgaWYgKGRyYXdOZWFyUGxhbmUpIHsKICAgICAgICAgICAgZ2V0QXR0cmlidXRlcyhvZmZzZXQsIG5vcm1hbHMsIHRhbmdlbnRzLCBiaXRhbmdlbnRzLCBzdCwgbmVnYXRpdmVaLCB4LCB5KTsKICAgICAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgICAgfQogICAgICAgICAgZ2V0QXR0cmlidXRlcyhvZmZzZXQsIG5vcm1hbHMsIHRhbmdlbnRzLCBiaXRhbmdlbnRzLCBzdCwgeiwgbmVnYXRpdmVYMiwgeSk7CiAgICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgICBnZXRBdHRyaWJ1dGVzKAogICAgICAgICAgICBvZmZzZXQsCiAgICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgICBiaXRhbmdlbnRzLAogICAgICAgICAgICBzdCwKICAgICAgICAgICAgbmVnYXRpdmVYMiwKICAgICAgICAgICAgbmVnYXRpdmVaLAogICAgICAgICAgICB5CiAgICAgICAgICApOwogICAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgICAgZ2V0QXR0cmlidXRlcygKICAgICAgICAgICAgb2Zmc2V0LAogICAgICAgICAgICBub3JtYWxzLAogICAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgc3QsCiAgICAgICAgICAgIG5lZ2F0aXZlWSwKICAgICAgICAgICAgbmVnYXRpdmVaLAogICAgICAgICAgICBuZWdhdGl2ZVgyCiAgICAgICAgICApOwogICAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgICAgZ2V0QXR0cmlidXRlcyhvZmZzZXQsIG5vcm1hbHMsIHRhbmdlbnRzLCBiaXRhbmdlbnRzLCBzdCwgeCwgeiwgeSk7CiAgICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgICBnZXRBdHRyaWJ1dGVzKG9mZnNldCwgbm9ybWFscywgdGFuZ2VudHMsIGJpdGFuZ2VudHMsIHN0LCB5LCB6LCBuZWdhdGl2ZVgyKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRhbmdlbnRzKSkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChiaXRhbmdlbnRzKSkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3QpKSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgICB2YWx1ZXM6IHN0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDYgKiBudW1iZXJPZlBsYW5lcyk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1iZXJPZlBsYW5lczsgKytpKSB7CiAgICAgICAgICBjb25zdCBpbmRleE9mZnNldCA9IGkgKiA2OwogICAgICAgICAgY29uc3QgaW5kZXggPSBpICogNDsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXRdID0gaW5kZXg7CiAgICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgMV0gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgMl0gPSBpbmRleCArIDI7CiAgICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgM10gPSBpbmRleDsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXQgKyA0XSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXQgKyA1XSA9IGluZGV4ICsgMzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEZydXN0dW1HZW9tZXRyeV9kZWZhdWx0ID0gRnJ1c3R1bUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRnJ1c3R1bUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUZydXN0dW1HZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRnJ1c3R1bUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUZydXN0dW1HZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlRnJ1c3R1bUdlb21ldHJ5KGZydXN0dW1HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgZnJ1c3R1bUdlb21ldHJ5ID0gRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGZydXN0dW1HZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShmcnVzdHVtR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlRnJ1c3R1bUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVGcnVzdHVtR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9GcnVzdHVtR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVGcnVzdHVtR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GcnVzdHVtT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gRnJ1c3R1bU91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMiLCBvcHRpb25zKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5mcnVzdHVtIiwgb3B0aW9ucy5mcnVzdHVtKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5vcmlnaW4iLCBvcHRpb25zLm9yaWdpbik7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMub3JpZW50YXRpb24iLCBvcHRpb25zLm9yaWVudGF0aW9uKTsKICAgIGNvbnN0IGZydXN0dW0gPSBvcHRpb25zLmZydXN0dW07CiAgICBjb25zdCBvcmllbnRhdGlvbiA9IG9wdGlvbnMub3JpZW50YXRpb247CiAgICBjb25zdCBvcmlnaW4gPSBvcHRpb25zLm9yaWdpbjsKICAgIGNvbnN0IGRyYXdOZWFyUGxhbmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLl9kcmF3TmVhclBsYW5lLCB0cnVlKTsKICAgIGxldCBmcnVzdHVtVHlwZTsKICAgIGxldCBmcnVzdHVtUGFja2VkTGVuZ3RoOwogICAgaWYgKGZydXN0dW0gaW5zdGFuY2VvZiBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdCkgewogICAgICBmcnVzdHVtVHlwZSA9IFBFUlNQRUNUSVZFMjsKICAgICAgZnJ1c3R1bVBhY2tlZExlbmd0aCA9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0gZWxzZSBpZiAoZnJ1c3R1bSBpbnN0YW5jZW9mIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdCkgewogICAgICBmcnVzdHVtVHlwZSA9IE9SVEhPR1JBUEhJQzI7CiAgICAgIGZydXN0dW1QYWNrZWRMZW5ndGggPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfQogICAgdGhpcy5fZnJ1c3R1bVR5cGUgPSBmcnVzdHVtVHlwZTsKICAgIHRoaXMuX2ZydXN0dW0gPSBmcnVzdHVtLmNsb25lKCk7CiAgICB0aGlzLl9vcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUob3JpZ2luKTsKICAgIHRoaXMuX29yaWVudGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmNsb25lKG9yaWVudGF0aW9uKTsKICAgIHRoaXMuX2RyYXdOZWFyUGxhbmUgPSBkcmF3TmVhclBsYW5lOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5IjsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gMiArIGZydXN0dW1QYWNrZWRMZW5ndGggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgUXVhdGVybmlvbl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICB9CiAgdmFyIFBFUlNQRUNUSVZFMiwgT1JUSE9HUkFQSElDMiwgc2NyYXRjaFBhY2tQZXJzcGVjdGl2ZTIsIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljMiwgc2NyYXRjaFBhY2tRdWF0ZXJuaW9uMiwgc2NyYXRjaFBhY2tvcmlnaW4yLCBGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9GcnVzdHVtR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfT3J0aG9ncmFwaGljRnJ1c3R1bSgpOwogICAgICBpbml0X1BlcnNwZWN0aXZlRnJ1c3R1bSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIFBFUlNQRUNUSVZFMiA9IDA7CiAgICAgIE9SVEhPR1JBUEhJQzIgPSAxOwogICAgICBGcnVzdHVtT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gdmFsdWUuX2ZydXN0dW1UeXBlOwogICAgICAgIGNvbnN0IGZydXN0dW0gPSB2YWx1ZS5fZnJ1c3R1bTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZnJ1c3R1bVR5cGU7CiAgICAgICAgaWYgKGZydXN0dW1UeXBlID09PSBQRVJTUEVDVElWRTIpIHsKICAgICAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2soZnJ1c3R1bSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrKGZydXN0dW0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX29yaWdpbiwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQucGFjayh2YWx1ZS5fb3JpZW50YXRpb24sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZHJhd05lYXJQbGFuZSA/IDEgOiAwOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFBhY2tQZXJzcGVjdGl2ZTIgPSBuZXcgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBhY2tPcnRob2dyYXBoaWMyID0gbmV3IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGFja1F1YXRlcm5pb24yID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGFja29yaWdpbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEZydXN0dW1PdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBsZXQgZnJ1c3R1bTsKICAgICAgICBpZiAoZnJ1c3R1bVR5cGUgPT09IFBFUlNQRUNUSVZFMikgewogICAgICAgICAgZnJ1c3R1bSA9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hQYWNrUGVyc3BlY3RpdmUyCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZydXN0dW0gPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgc2NyYXRjaFBhY2tPcnRob2dyYXBoaWMyCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0KICAgICAgICBjb25zdCBvcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUGFja29yaWdpbjIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBvcmllbnRhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoUGFja1F1YXRlcm5pb24yCiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgZHJhd05lYXJQbGFuZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdID09PSAxOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSh7CiAgICAgICAgICAgIGZydXN0dW0sCiAgICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgICAgb3JpZW50YXRpb24sCiAgICAgICAgICAgIF9kcmF3TmVhclBsYW5lOiBkcmF3TmVhclBsYW5lCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnJ1c3R1bVJlc3VsdCA9IGZydXN0dW1UeXBlID09PSByZXN1bHQuX2ZydXN0dW1UeXBlID8gcmVzdWx0Ll9mcnVzdHVtIDogdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZnJ1c3R1bSA9IGZydXN0dW0uY2xvbmUoZnJ1c3R1bVJlc3VsdCk7CiAgICAgICAgcmVzdWx0Ll9mcnVzdHVtVHlwZSA9IGZydXN0dW1UeXBlOwogICAgICAgIHJlc3VsdC5fb3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG9yaWdpbiwgcmVzdWx0Ll9vcmlnaW4pOwogICAgICAgIHJlc3VsdC5fb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuY2xvbmUob3JpZW50YXRpb24sIHJlc3VsdC5fb3JpZW50YXRpb24pOwogICAgICAgIHJlc3VsdC5fZHJhd05lYXJQbGFuZSA9IGRyYXdOZWFyUGxhbmU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGZydXN0dW1HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gZnJ1c3R1bUdlb21ldHJ5Ll9mcnVzdHVtVHlwZTsKICAgICAgICBjb25zdCBmcnVzdHVtID0gZnJ1c3R1bUdlb21ldHJ5Ll9mcnVzdHVtOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IGZydXN0dW1HZW9tZXRyeS5fb3JpZ2luOwogICAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gZnJ1c3R1bUdlb21ldHJ5Ll9vcmllbnRhdGlvbjsKICAgICAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gZnJ1c3R1bUdlb21ldHJ5Ll9kcmF3TmVhclBsYW5lOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoMyAqIDQgKiAyKTsKICAgICAgICBGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdC5fY29tcHV0ZU5lYXJGYXJQbGFuZXMoCiAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICBvcmllbnRhdGlvbiwKICAgICAgICAgIGZydXN0dW1UeXBlLAogICAgICAgICAgZnJ1c3R1bSwKICAgICAgICAgIHBvc2l0aW9ucwogICAgICAgICk7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KQogICAgICAgIH0pOwogICAgICAgIGxldCBvZmZzZXQ7CiAgICAgICAgbGV0IGluZGV4OwogICAgICAgIGNvbnN0IG51bWJlck9mUGxhbmVzID0gZHJhd05lYXJQbGFuZSA/IDIgOiAxOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoOCAqIChudW1iZXJPZlBsYW5lcyArIDEpKTsKICAgICAgICBsZXQgaSA9IGRyYXdOZWFyUGxhbmUgPyAwIDogMTsKICAgICAgICBmb3IgKDsgaSA8IDI7ICsraSkgewogICAgICAgICAgb2Zmc2V0ID0gZHJhd05lYXJQbGFuZSA/IGkgKiA4IDogMDsKICAgICAgICAgIGluZGV4ID0gaSAqIDQ7CiAgICAgICAgICBpbmRpY2VzW29mZnNldF0gPSBpbmRleDsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgMV0gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDJdID0gaW5kZXggKyAxOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyAzXSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgNF0gPSBpbmRleCArIDI7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDVdID0gaW5kZXggKyAzOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA2XSA9IGluZGV4ICsgMzsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgN10gPSBpbmRleDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDI7ICsraSkgewogICAgICAgICAgb2Zmc2V0ID0gKG51bWJlck9mUGxhbmVzICsgaSkgKiA4OwogICAgICAgICAgaW5kZXggPSBpICogNDsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0XSA9IGluZGV4OwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyAxXSA9IGluZGV4ICsgNDsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgMl0gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDNdID0gaW5kZXggKyA1OwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA0XSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgNV0gPSBpbmRleCArIDY7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDZdID0gaW5kZXggKyAzOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA3XSA9IGluZGV4ICsgNzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKHBvc2l0aW9ucykKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gRnJ1c3R1bU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5KGZydXN0dW1HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgZnJ1c3R1bUdlb21ldHJ5ID0gRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhmcnVzdHVtR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGZydXN0dW1HZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0ZydXN0dW1PdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb2dyYXBoaWNUaWxpbmdTY2hlbWUuanMKICBmdW5jdGlvbiBHZW9ncmFwaGljVGlsaW5nU2NoZW1lKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgdGhpcy5fcmVjdGFuZ2xlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yZWN0YW5nbGUsIFJlY3RhbmdsZV9kZWZhdWx0Lk1BWF9WQUxVRSk7CiAgICB0aGlzLl9wcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQodGhpcy5fZWxsaXBzb2lkKTsKICAgIHRoaXMuX251bWJlck9mTGV2ZWxaZXJvVGlsZXNYID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMubnVtYmVyT2ZMZXZlbFplcm9UaWxlc1gsCiAgICAgIDIKICAgICk7CiAgICB0aGlzLl9udW1iZXJPZkxldmVsWmVyb1RpbGVzWSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLm51bWJlck9mTGV2ZWxaZXJvVGlsZXNZLAogICAgICAxCiAgICApOwogIH0KICB2YXIgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZV9kZWZhdWx0OwogIHZhciBpbml0X0dlb2dyYXBoaWNUaWxpbmdTY2hlbWUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb2dyYXBoaWNUaWxpbmdTY2hlbWUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBlbGxpcHNvaWQgdGhhdCBpcyB0aWxlZCBieSB0aGlzIHRpbGluZyBzY2hlbWUuCiAgICAgICAgICogQG1lbWJlcm9mIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSByZWN0YW5nbGUsIGluIHJhZGlhbnMsIGNvdmVyZWQgYnkgdGhpcyB0aWxpbmcgc2NoZW1lLgogICAgICAgICAqIEBtZW1iZXJvZiBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtSZWN0YW5nbGV9CiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVjdGFuZ2xlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbWFwIHByb2plY3Rpb24gdXNlZCBieSB0aGlzIHRpbGluZyBzY2hlbWUuCiAgICAgICAgICogQG1lbWJlcm9mIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge01hcFByb2plY3Rpb259CiAgICAgICAgICovCiAgICAgICAgcHJvamVjdGlvbjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2plY3Rpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUuZ2V0TnVtYmVyT2ZYVGlsZXNBdExldmVsID0gZnVuY3Rpb24obGV2ZWwpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbnVtYmVyT2ZMZXZlbFplcm9UaWxlc1ggPDwgbGV2ZWw7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLmdldE51bWJlck9mWVRpbGVzQXRMZXZlbCA9IGZ1bmN0aW9uKGxldmVsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX251bWJlck9mTGV2ZWxaZXJvVGlsZXNZIDw8IGxldmVsOwogICAgICB9OwogICAgICBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZS5yZWN0YW5nbGVUb05hdGl2ZVJlY3RhbmdsZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZS53ZXN0KTsKICAgICAgICBjb25zdCBzb3V0aCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGUuZWFzdCk7CiAgICAgICAgY29uc3Qgbm9ydGggPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGVfZGVmYXVsdCh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBlYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLnRpbGVYWVRvTmF0aXZlUmVjdGFuZ2xlID0gZnVuY3Rpb24oeCwgeSwgbGV2ZWwsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHJlY3RhbmdsZVJhZGlhbnMgPSB0aGlzLnRpbGVYWVRvUmVjdGFuZ2xlKHgsIHksIGxldmVsLCByZXN1bHQpOwogICAgICAgIHJlY3RhbmdsZVJhZGlhbnMud2VzdCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlUmFkaWFucy53ZXN0KTsKICAgICAgICByZWN0YW5nbGVSYWRpYW5zLnNvdXRoID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGVSYWRpYW5zLnNvdXRoKTsKICAgICAgICByZWN0YW5nbGVSYWRpYW5zLmVhc3QgPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZVJhZGlhbnMuZWFzdCk7CiAgICAgICAgcmVjdGFuZ2xlUmFkaWFucy5ub3J0aCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlUmFkaWFucy5ub3J0aCk7CiAgICAgICAgcmV0dXJuIHJlY3RhbmdsZVJhZGlhbnM7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLnRpbGVYWVRvUmVjdGFuZ2xlID0gZnVuY3Rpb24oeCwgeSwgbGV2ZWwsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICBjb25zdCB4VGlsZXMgPSB0aGlzLmdldE51bWJlck9mWFRpbGVzQXRMZXZlbChsZXZlbCk7CiAgICAgICAgY29uc3QgeVRpbGVzID0gdGhpcy5nZXROdW1iZXJPZllUaWxlc0F0TGV2ZWwobGV2ZWwpOwogICAgICAgIGNvbnN0IHhUaWxlV2lkdGggPSByZWN0YW5nbGUud2lkdGggLyB4VGlsZXM7CiAgICAgICAgY29uc3Qgd2VzdCA9IHggKiB4VGlsZVdpZHRoICsgcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgY29uc3QgZWFzdCA9ICh4ICsgMSkgKiB4VGlsZVdpZHRoICsgcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgY29uc3QgeVRpbGVIZWlnaHQgPSByZWN0YW5nbGUuaGVpZ2h0IC8geVRpbGVzOwogICAgICAgIGNvbnN0IG5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoIC0geSAqIHlUaWxlSGVpZ2h0OwogICAgICAgIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLm5vcnRoIC0gKHkgKyAxKSAqIHlUaWxlSGVpZ2h0OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBlYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLnBvc2l0aW9uVG9UaWxlWFkgPSBmdW5jdGlvbihwb3NpdGlvbiwgbGV2ZWwsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICBpZiAoIVJlY3RhbmdsZV9kZWZhdWx0LmNvbnRhaW5zKHJlY3RhbmdsZSwgcG9zaXRpb24pKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCB4VGlsZXMgPSB0aGlzLmdldE51bWJlck9mWFRpbGVzQXRMZXZlbChsZXZlbCk7CiAgICAgICAgY29uc3QgeVRpbGVzID0gdGhpcy5nZXROdW1iZXJPZllUaWxlc0F0TGV2ZWwobGV2ZWwpOwogICAgICAgIGNvbnN0IHhUaWxlV2lkdGggPSByZWN0YW5nbGUud2lkdGggLyB4VGlsZXM7CiAgICAgICAgY29uc3QgeVRpbGVIZWlnaHQgPSByZWN0YW5nbGUuaGVpZ2h0IC8geVRpbGVzOwogICAgICAgIGxldCBsb25naXR1ZGUgPSBwb3NpdGlvbi5sb25naXR1ZGU7CiAgICAgICAgaWYgKHJlY3RhbmdsZS5lYXN0IDwgcmVjdGFuZ2xlLndlc3QpIHsKICAgICAgICAgIGxvbmdpdHVkZSArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICBsZXQgeFRpbGVDb29yZGluYXRlID0gKGxvbmdpdHVkZSAtIHJlY3RhbmdsZS53ZXN0KSAvIHhUaWxlV2lkdGggfCAwOwogICAgICAgIGlmICh4VGlsZUNvb3JkaW5hdGUgPj0geFRpbGVzKSB7CiAgICAgICAgICB4VGlsZUNvb3JkaW5hdGUgPSB4VGlsZXMgLSAxOwogICAgICAgIH0KICAgICAgICBsZXQgeVRpbGVDb29yZGluYXRlID0gKHJlY3RhbmdsZS5ub3J0aCAtIHBvc2l0aW9uLmxhdGl0dWRlKSAvIHlUaWxlSGVpZ2h0IHwgMDsKICAgICAgICBpZiAoeVRpbGVDb29yZGluYXRlID49IHlUaWxlcykgewogICAgICAgICAgeVRpbGVDb29yZGluYXRlID0geVRpbGVzIC0gMTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoeFRpbGVDb29yZGluYXRlLCB5VGlsZUNvb3JkaW5hdGUpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHhUaWxlQ29vcmRpbmF0ZTsKICAgICAgICByZXN1bHQueSA9IHlUaWxlQ29vcmRpbmF0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBHZW9ncmFwaGljVGlsaW5nU2NoZW1lX2RlZmF1bHQgPSBHZW9ncmFwaGljVGlsaW5nU2NoZW1lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5qcwogIGZ1bmN0aW9uIGdldFRpbGVYWUxldmVsKHJlY3RhbmdsZSkgewogICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgIHJlY3RhbmdsZS5lYXN0LAogICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgIDAsCiAgICAgIHNjcmF0Y2hDb3JuZXJzWzBdCiAgICApOwogICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgIHJlY3RhbmdsZS53ZXN0LAogICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgIDAsCiAgICAgIHNjcmF0Y2hDb3JuZXJzWzFdCiAgICApOwogICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgIHJlY3RhbmdsZS5lYXN0LAogICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgIDAsCiAgICAgIHNjcmF0Y2hDb3JuZXJzWzJdCiAgICApOwogICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgIHJlY3RhbmdsZS53ZXN0LAogICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgIDAsCiAgICAgIHNjcmF0Y2hDb3JuZXJzWzNdCiAgICApOwogICAgbGV0IGxhc3RMZXZlbFggPSAwLCBsYXN0TGV2ZWxZID0gMDsKICAgIGxldCBjdXJyZW50WCA9IDAsIGN1cnJlbnRZID0gMDsKICAgIGNvbnN0IG1heExldmVsID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHNNYXhMZXZlbDsKICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8PSBtYXhMZXZlbDsgKytpKSB7CiAgICAgIGxldCBmYWlsZWQgPSBmYWxzZTsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA0OyArK2opIHsKICAgICAgICBjb25zdCBjb3JuZXIgPSBzY3JhdGNoQ29ybmVyc1tqXTsKICAgICAgICB0aWxpbmdTY2hlbWUucG9zaXRpb25Ub1RpbGVYWShjb3JuZXIsIGksIHNjcmF0Y2hUaWxlWFkpOwogICAgICAgIGlmIChqID09PSAwKSB7CiAgICAgICAgICBjdXJyZW50WCA9IHNjcmF0Y2hUaWxlWFkueDsKICAgICAgICAgIGN1cnJlbnRZID0gc2NyYXRjaFRpbGVYWS55OwogICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFggIT09IHNjcmF0Y2hUaWxlWFkueCB8fCBjdXJyZW50WSAhPT0gc2NyYXRjaFRpbGVYWS55KSB7CiAgICAgICAgICBmYWlsZWQgPSB0cnVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmYWlsZWQpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBsYXN0TGV2ZWxYID0gY3VycmVudFg7CiAgICAgIGxhc3RMZXZlbFkgPSBjdXJyZW50WTsKICAgIH0KICAgIGlmIChpID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXR1cm4gewogICAgICB4OiBsYXN0TGV2ZWxYLAogICAgICB5OiBsYXN0TGV2ZWxZLAogICAgICBsZXZlbDogaSA+IG1heExldmVsID8gbWF4TGV2ZWwgOiBpIC0gMQogICAgfTsKICB9CiAgdmFyIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhbk5FLCBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5TVywgc2NyYXRjaERpYWdvbmFsQ2FydG9ncmFwaGljLCBzY3JhdGNoQ2VudGVyQ2FydGVzaWFuLCBzY3JhdGNoU3VyZmFjZUNhcnRlc2lhbiwgc2NyYXRjaEJvdW5kaW5nU3BoZXJlMiwgdGlsaW5nU2NoZW1lLCBzY3JhdGNoQ29ybmVycywgc2NyYXRjaFRpbGVYWSwgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cywgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0c19kZWZhdWx0OwogIHZhciBpbml0X0FwcHJveGltYXRlVGVycmFpbkhlaWdodHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0FwcHJveGltYXRlVGVycmFpbkhlaWdodHMuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfYnVpbGRNb2R1bGVVcmwoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZSgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1Jlc291cmNlKCk7CiAgICAgIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhbk5FID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5TVyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydG9ncmFwaGljID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXJDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTdXJmYWNlQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQm91bmRpbmdTcGhlcmUyID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgdGlsaW5nU2NoZW1lID0gbmV3IEdlb2dyYXBoaWNUaWxpbmdTY2hlbWVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ29ybmVycyA9IFsKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKQogICAgICBdOwogICAgICBzY3JhdGNoVGlsZVhZID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzID0ge307CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGxldCBpbml0UHJvbWlzZSA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2luaXRQcm9taXNlOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5pdFByb21pc2UpKSB7CiAgICAgICAgICByZXR1cm4gaW5pdFByb21pc2U7CiAgICAgICAgfQogICAgICAgIGluaXRQcm9taXNlID0gUmVzb3VyY2VfZGVmYXVsdC5mZXRjaEpzb24oCiAgICAgICAgICBidWlsZE1vZHVsZVVybF9kZWZhdWx0KCJBc3NldHMvYXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5qc29uIikKICAgICAgICApLnRoZW4oZnVuY3Rpb24oanNvbikgewogICAgICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHMgPSBqc29uOwogICAgICAgIH0pOwogICAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2luaXRQcm9taXNlID0gaW5pdFByb21pc2U7CiAgICAgICAgcmV0dXJuIGluaXRQcm9taXNlOwogICAgICB9OwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmdldE1pbmltdW1NYXhpbXVtSGVpZ2h0cyA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJZb3UgbXVzdCBjYWxsIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuaW5pdGlhbGl6ZSBhbmQgd2FpdCBmb3IgdGhlIHByb21pc2UgdG8gcmVzb2x2ZSBiZWZvcmUgdXNpbmcgdGhpcyBmdW5jdGlvbiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCk7CiAgICAgICAgY29uc3QgeHlMZXZlbCA9IGdldFRpbGVYWUxldmVsKHJlY3RhbmdsZSk7CiAgICAgICAgbGV0IG1pblRlcnJhaW5IZWlnaHQgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9kZWZhdWx0TWluVGVycmFpbkhlaWdodDsKICAgICAgICBsZXQgbWF4VGVycmFpbkhlaWdodCA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNYXhUZXJyYWluSGVpZ2h0OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoeHlMZXZlbCkpIHsKICAgICAgICAgIGNvbnN0IGtleSA9IGAke3h5TGV2ZWwubGV2ZWx9LSR7eHlMZXZlbC54fS0ke3h5TGV2ZWwueX1gOwogICAgICAgICAgY29uc3QgaGVpZ2h0cyA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzW2tleV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhlaWdodHMpKSB7CiAgICAgICAgICAgIG1pblRlcnJhaW5IZWlnaHQgPSBoZWlnaHRzWzBdOwogICAgICAgICAgICBtYXhUZXJyYWluSGVpZ2h0ID0gaGVpZ2h0c1sxXTsKICAgICAgICAgIH0KICAgICAgICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQubm9ydGhlYXN0KHJlY3RhbmdsZSwgc2NyYXRjaERpYWdvbmFsQ2FydG9ncmFwaGljKSwKICAgICAgICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuTkUKICAgICAgICAgICk7CiAgICAgICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0LnNvdXRod2VzdChyZWN0YW5nbGUsIHNjcmF0Y2hEaWFnb25hbENhcnRvZ3JhcGhpYyksCiAgICAgICAgICAgIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhblNXCiAgICAgICAgICApOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KAogICAgICAgICAgICBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5TVywKICAgICAgICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuTkUsCiAgICAgICAgICAgIHNjcmF0Y2hDZW50ZXJDYXJ0ZXNpYW4KICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzdXJmYWNlUG9zaXRpb24gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgICAgICAgc2NyYXRjaENlbnRlckNhcnRlc2lhbiwKICAgICAgICAgICAgc2NyYXRjaFN1cmZhY2VDYXJ0ZXNpYW4KICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN1cmZhY2VQb3NpdGlvbikpIHsKICAgICAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UoCiAgICAgICAgICAgICAgc2NyYXRjaENlbnRlckNhcnRlc2lhbiwKICAgICAgICAgICAgICBzdXJmYWNlUG9zaXRpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgbWluVGVycmFpbkhlaWdodCA9IE1hdGgubWluKG1pblRlcnJhaW5IZWlnaHQsIC1kaXN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtaW5UZXJyYWluSGVpZ2h0ID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fZGVmYXVsdE1pblRlcnJhaW5IZWlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG1pblRlcnJhaW5IZWlnaHQgPSBNYXRoLm1heCgKICAgICAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNaW5UZXJyYWluSGVpZ2h0LAogICAgICAgICAgbWluVGVycmFpbkhlaWdodAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG1pbmltdW1UZXJyYWluSGVpZ2h0OiBtaW5UZXJyYWluSGVpZ2h0LAogICAgICAgICAgbWF4aW11bVRlcnJhaW5IZWlnaHQ6IG1heFRlcnJhaW5IZWlnaHQKICAgICAgICB9OwogICAgICB9OwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmdldEJvdW5kaW5nU3BoZXJlID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBlbGxpcHNvaWQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIllvdSBtdXN0IGNhbGwgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5pbml0aWFsaXplIGFuZCB3YWl0IGZvciB0aGUgcHJvbWlzZSB0byByZXNvbHZlIGJlZm9yZSB1c2luZyB0aGlzIGZ1bmN0aW9uIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KTsKICAgICAgICBjb25zdCB4eUxldmVsID0gZ2V0VGlsZVhZTGV2ZWwocmVjdGFuZ2xlKTsKICAgICAgICBsZXQgbWF4VGVycmFpbkhlaWdodCA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNYXhUZXJyYWluSGVpZ2h0OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoeHlMZXZlbCkpIHsKICAgICAgICAgIGNvbnN0IGtleSA9IGAke3h5TGV2ZWwubGV2ZWx9LSR7eHlMZXZlbC54fS0ke3h5TGV2ZWwueX1gOwogICAgICAgICAgY29uc3QgaGVpZ2h0cyA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzW2tleV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhlaWdodHMpKSB7CiAgICAgICAgICAgIG1heFRlcnJhaW5IZWlnaHQgPSBoZWlnaHRzWzFdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCByZXN1bHQgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRChyZWN0YW5nbGUsIGVsbGlwc29pZCwgMCk7CiAgICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBtYXhUZXJyYWluSGVpZ2h0LAogICAgICAgICAgc2NyYXRjaEJvdW5kaW5nU3BoZXJlMgogICAgICAgICk7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24ocmVzdWx0LCBzY3JhdGNoQm91bmRpbmdTcGhlcmUyLCByZXN1bHQpOwogICAgICB9OwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0c01heExldmVsID0gNjsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fZGVmYXVsdE1heFRlcnJhaW5IZWlnaHQgPSA5ZTM7CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNaW5UZXJyYWluSGVpZ2h0ID0gLTFlNTsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHMgPSB2b2lkIDA7CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2luaXRQcm9taXNlID0gdm9pZCAwOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogRGV0ZXJtaW5lcyBpZiB0aGUgdGVycmFpbiBoZWlnaHRzIGFyZSBpbml0aWFsaXplZCBhbmQgcmVhZHkgdG8gdXNlLiBUbyBpbml0aWFsaXplIHRoZSB0ZXJyYWluIGhlaWdodHMsCiAgICAgICAgICogY2FsbCB7QGxpbmsgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cyNpbml0aWFsaXplfSBhbmQgd2FpdCBmb3IgdGhlIHJldHVybmVkIHByb21pc2UgdG8gcmVzb2x2ZS4KICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAbWVtYmVyb2YgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cwogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemVkOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGVmaW5lZF9kZWZhdWx0KEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzX2RlZmF1bHQgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA8IDIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkF0IGxlYXN0IHR3byBwb3NpdGlvbnMgYXJlIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUpICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJWYWxpZCBvcHRpb25zIGZvciBhcmNUeXBlIGFyZSBBcmNUeXBlLkdFT0RFU0lDIGFuZCBBcmNUeXBlLlJIVU1CLiIKICAgICAgKTsKICAgIH0KICAgIHRoaXMud2lkdGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLndpZHRoLCAxKTsKICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgIHRoaXMuZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmdyYW51bGFyaXR5LCA5OTk5KTsKICAgIHRoaXMubG9vcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubG9vcCwgZmFsc2UpOwogICAgdGhpcy5hcmNUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hcmNUeXBlLCBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdDsKICAgIHRoaXMuX3Byb2plY3Rpb25JbmRleCA9IDA7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkiOwogICAgdGhpcy5fc2NlbmUzRE9ubHkgPSBmYWxzZTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVJpZ2h0Tm9ybWFsKHN0YXJ0LCBlbmQsIG1heEhlaWdodCwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgIGNvbnN0IHN0YXJ0Qm90dG9tID0gZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBzdGFydCwgMCwgY2FydDNTY3JhdGNoMSk7CiAgICBjb25zdCBzdGFydFRvcCA9IGdldFBvc2l0aW9uKGVsbGlwc29pZCwgc3RhcnQsIG1heEhlaWdodCwgY2FydDNTY3JhdGNoMik7CiAgICBjb25zdCBlbmRCb3R0b20gPSBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIGVuZCwgMCwgY2FydDNTY3JhdGNoMyk7CiAgICBjb25zdCB1cCA9IGRpcmVjdGlvbihzdGFydFRvcCwgc3RhcnRCb3R0b20sIGNhcnQzU2NyYXRjaDIpOwogICAgY29uc3QgZm9yd2FyZCA9IGRpcmVjdGlvbihlbmRCb3R0b20sIHN0YXJ0Qm90dG9tLCBjYXJ0M1NjcmF0Y2gzKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhmb3J3YXJkLCB1cCwgcmVzdWx0KTsKICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICB9CiAgZnVuY3Rpb24gaW50ZXJwb2xhdGVTZWdtZW50KHN0YXJ0LCBlbmQsIG1pbkhlaWdodCwgbWF4SGVpZ2h0LCBncmFudWxhcml0eSwgYXJjVHlwZSwgZWxsaXBzb2lkLCBub3JtYWxzQXJyYXksIGJvdHRvbVBvc2l0aW9uc0FycmF5LCB0b3BQb3NpdGlvbnNBcnJheSwgY2FydG9ncmFwaGljc0FycmF5KSB7CiAgICBpZiAoZ3JhbnVsYXJpdHkgPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGV0IGVsbGlwc29pZExpbmU7CiAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgIGVsbGlwc29pZExpbmUgPSBuZXcgRWxsaXBzb2lkR2VvZGVzaWNfZGVmYXVsdChzdGFydCwgZW5kLCBlbGxpcHNvaWQpOwogICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgZWxsaXBzb2lkTGluZSA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdChzdGFydCwgZW5kLCBlbGxpcHNvaWQpOwogICAgfQogICAgY29uc3Qgc3VyZmFjZURpc3RhbmNlID0gZWxsaXBzb2lkTGluZS5zdXJmYWNlRGlzdGFuY2U7CiAgICBpZiAoc3VyZmFjZURpc3RhbmNlIDwgZ3JhbnVsYXJpdHkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgaW50ZXJwb2xhdGVkTm9ybWFsID0gY29tcHV0ZVJpZ2h0Tm9ybWFsKAogICAgICBzdGFydCwKICAgICAgZW5kLAogICAgICBtYXhIZWlnaHQsCiAgICAgIGVsbGlwc29pZCwKICAgICAgaW50ZXJwb2xhdGVkTm9ybWFsU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IHNlZ21lbnRzID0gTWF0aC5jZWlsKHN1cmZhY2VEaXN0YW5jZSAvIGdyYW51bGFyaXR5KTsKICAgIGNvbnN0IGludGVycG9pbnREaXN0YW5jZSA9IHN1cmZhY2VEaXN0YW5jZSAvIHNlZ21lbnRzOwogICAgbGV0IGRpc3RhbmNlRnJvbVN0YXJ0ID0gaW50ZXJwb2ludERpc3RhbmNlOwogICAgY29uc3QgcG9pbnRzVG9BZGQgPSBzZWdtZW50cyAtIDE7CiAgICBsZXQgcGFja0luZGV4ID0gbm9ybWFsc0FycmF5Lmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9pbnRzVG9BZGQ7IGkrKykgewogICAgICBjb25zdCBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWMgPSBlbGxpcHNvaWRMaW5lLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UoCiAgICAgICAgZGlzdGFuY2VGcm9tU3RhcnQsCiAgICAgICAgaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBpbnRlcnBvbGF0ZWRCb3R0b20gPSBnZXRQb3NpdGlvbigKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljLAogICAgICAgIG1pbkhlaWdodCwKICAgICAgICBpbnRlcnBvbGF0ZWRCb3R0b21TY3JhdGNoCiAgICAgICk7CiAgICAgIGNvbnN0IGludGVycG9sYXRlZFRvcCA9IGdldFBvc2l0aW9uKAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWMsCiAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgIGludGVycG9sYXRlZFRvcFNjcmF0Y2gKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soaW50ZXJwb2xhdGVkTm9ybWFsLCBub3JtYWxzQXJyYXksIHBhY2tJbmRleCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGludGVycG9sYXRlZEJvdHRvbSwgYm90dG9tUG9zaXRpb25zQXJyYXksIHBhY2tJbmRleCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGludGVycG9sYXRlZFRvcCwgdG9wUG9zaXRpb25zQXJyYXksIHBhY2tJbmRleCk7CiAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKGludGVycG9sYXRlZENhcnRvZ3JhcGhpYy5sYXRpdHVkZSk7CiAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKGludGVycG9sYXRlZENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpOwogICAgICBwYWNrSW5kZXggKz0gMzsKICAgICAgZGlzdGFuY2VGcm9tU3RhcnQgKz0gaW50ZXJwb2ludERpc3RhbmNlOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIGNhcnRvZ3JhcGhpYzIsIGhlaWdodCwgcmVzdWx0KSB7CiAgICBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShjYXJ0b2dyYXBoaWMyLCBoZWlnaHRsZXNzQ2FydG9ncmFwaGljU2NyYXRjaCk7CiAgICBoZWlnaHRsZXNzQ2FydG9ncmFwaGljU2NyYXRjaC5oZWlnaHQgPSBoZWlnaHQ7CiAgICByZXR1cm4gQ2FydG9ncmFwaGljX2RlZmF1bHQudG9DYXJ0ZXNpYW4oCiAgICAgIGhlaWdodGxlc3NDYXJ0b2dyYXBoaWNTY3JhdGNoLAogICAgICBlbGxpcHNvaWQsCiAgICAgIHJlc3VsdAogICAgKTsKICB9CiAgZnVuY3Rpb24gZGlyZWN0aW9uKHRhcmdldCwgb3JpZ2luLCByZXN1bHQpIHsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh0YXJnZXQsIG9yaWdpbiwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gdGFuZ2VudERpcmVjdGlvbih0YXJnZXQsIG9yaWdpbiwgdXAsIHJlc3VsdCkgewogICAgcmVzdWx0ID0gZGlyZWN0aW9uKHRhcmdldCwgb3JpZ2luLCByZXN1bHQpOwogICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHJlc3VsdCwgdXAsIHJlc3VsdCk7CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1cCwgcmVzdWx0LCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVZlcnRleE1pdGVyTm9ybWFsKHByZXZpb3VzQm90dG9tLCB2ZXJ0ZXhCb3R0b20sIHZlcnRleFRvcCwgbmV4dEJvdHRvbSwgcmVzdWx0KSB7CiAgICBjb25zdCB1cCA9IGRpcmVjdGlvbih2ZXJ0ZXhUb3AsIHZlcnRleEJvdHRvbSwgdmVydGV4VXBTY3JhdGNoKTsKICAgIGNvbnN0IHRvUHJldmlvdXMgPSB0YW5nZW50RGlyZWN0aW9uKAogICAgICBwcmV2aW91c0JvdHRvbSwKICAgICAgdmVydGV4Qm90dG9tLAogICAgICB1cCwKICAgICAgdG9QcmV2aW91c1NjcmF0Y2gKICAgICk7CiAgICBjb25zdCB0b05leHQgPSB0YW5nZW50RGlyZWN0aW9uKG5leHRCb3R0b20sIHZlcnRleEJvdHRvbSwgdXAsIHRvTmV4dFNjcmF0Y2gpOwogICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRvUHJldmlvdXMsIHRvTmV4dCksCiAgICAgIGNvc2luZTE4MCwKICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT041CiAgICApKSB7CiAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1cCwgdG9QcmV2aW91cywgcmVzdWx0KTsKICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHRvTmV4dCwgdG9QcmV2aW91cywgcmVzdWx0KTsKICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgY29uc3QgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1cCwgcmVzdWx0LCBmb3J3YXJkU2NyYXRjaCk7CiAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0b05leHQsIGZvcndhcmQpIDwgY29zaW5lOTApIHsKICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShyZXN1bHQsIHJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBicmVha01pdGVyKGVuZEdlb21ldHJ5Tm9ybWFsLCBzdGFydEJvdHRvbSwgZW5kQm90dG9tLCBlbmRUb3ApIHsKICAgIGNvbnN0IGxpbmVEaXJlY3Rpb24gPSBkaXJlY3Rpb24oZW5kQm90dG9tLCBzdGFydEJvdHRvbSwgbGluZURpcmVjdGlvblNjcmF0Y2gpOwogICAgY29uc3QgZG90ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChsaW5lRGlyZWN0aW9uLCBlbmRHZW9tZXRyeU5vcm1hbCk7CiAgICBpZiAoZG90ID4gTUlURVJfQlJFQUtfU01BTEwgfHwgZG90IDwgTUlURVJfQlJFQUtfTEFSR0UpIHsKICAgICAgY29uc3QgdmVydGV4VXAgPSBkaXJlY3Rpb24oZW5kVG9wLCBlbmRCb3R0b20sIHZlcnRleFVwU2NyYXRjaCk7CiAgICAgIGNvbnN0IGFuZ2xlID0gZG90IDwgTUlURVJfQlJFQUtfTEFSR0UgPyBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gOiAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPOwogICAgICBjb25zdCBxdWF0ZXJuaW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgdmVydGV4VXAsCiAgICAgICAgYW5nbGUsCiAgICAgICAgcXVhdGVybmlvblNjcmF0Y2gzCiAgICAgICk7CiAgICAgIGNvbnN0IHJvdGF0aW9uTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHF1YXRlcm5pb24sIG1hdHJpeDNTY3JhdGNoKTsKICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgcm90YXRpb25NYXRyaXgsCiAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwsCiAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwKICAgICAgKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIHByb2plY3ROb3JtYWwocHJvamVjdGlvbiwgY2FydG9ncmFwaGljMiwgbm9ybWFsMiwgcHJvamVjdGVkUG9zaXRpb24sIHJlc3VsdCkgewogICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC50b0NhcnRlc2lhbigKICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgcHJvamVjdGlvbi5fZWxsaXBzb2lkLAogICAgICBub3JtYWxTdGFydHBvaW50U2NyYXRjaAogICAgKTsKICAgIGxldCBub3JtYWxFbmRwb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIG5vcm1hbDIsIG5vcm1hbEVuZHBvaW50U2NyYXRjaCk7CiAgICBsZXQgZmxpcE5vcm1hbCA9IGZhbHNlOwogICAgY29uc3QgZWxsaXBzb2lkID0gcHJvamVjdGlvbi5fZWxsaXBzb2lkOwogICAgbGV0IG5vcm1hbEVuZHBvaW50Q2FydG9ncmFwaGljID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICBub3JtYWxFbmRwb2ludCwKICAgICAgZW5kUG9zQ2FydG9ncmFwaGljU2NyYXRjaAogICAgKTsKICAgIGlmIChNYXRoLmFicyhjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSAtIG5vcm1hbEVuZHBvaW50Q2FydG9ncmFwaGljLmxvbmdpdHVkZSkgPiBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08pIHsKICAgICAgZmxpcE5vcm1hbCA9IHRydWU7CiAgICAgIG5vcm1hbEVuZHBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIHBvc2l0aW9uLAogICAgICAgIG5vcm1hbDIsCiAgICAgICAgbm9ybWFsRW5kcG9pbnRTY3JhdGNoCiAgICAgICk7CiAgICAgIG5vcm1hbEVuZHBvaW50Q2FydG9ncmFwaGljID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgIG5vcm1hbEVuZHBvaW50LAogICAgICAgIGVuZFBvc0NhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgKTsKICAgIH0KICAgIG5vcm1hbEVuZHBvaW50Q2FydG9ncmFwaGljLmhlaWdodCA9IDA7CiAgICBjb25zdCBub3JtYWxFbmRwb2ludFByb2plY3RlZCA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgbm9ybWFsRW5kcG9pbnRDYXJ0b2dyYXBoaWMsCiAgICAgIHJlc3VsdAogICAgKTsKICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgbm9ybWFsRW5kcG9pbnRQcm9qZWN0ZWQsCiAgICAgIHByb2plY3RlZFBvc2l0aW9uLAogICAgICByZXN1bHQKICAgICk7CiAgICByZXN1bHQueiA9IDA7CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIGlmIChmbGlwTm9ybWFsKSB7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUocmVzdWx0LCByZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gYWRqdXN0SGVpZ2h0cyhib3R0b20sIHRvcCwgbWluSGVpZ2h0LCBtYXhIZWlnaHQsIGFkanVzdEhlaWdodEJvdHRvbSwgYWRqdXN0SGVpZ2h0VG9wKSB7CiAgICBjb25zdCBhZGp1c3RIZWlnaHROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgIHRvcCwKICAgICAgYm90dG9tLAogICAgICBhZGp1c3RIZWlnaHROb3JtYWxTY3JhdGNoCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShhZGp1c3RIZWlnaHROb3JtYWwsIGFkanVzdEhlaWdodE5vcm1hbCk7CiAgICBjb25zdCBkaXN0YW5jZUZvckJvdHRvbSA9IG1pbkhlaWdodCAtIFdBTExfSU5JVElBTF9NSU5fSEVJR0hUOwogICAgbGV0IGFkanVzdEhlaWdodE9mZnNldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBhZGp1c3RIZWlnaHROb3JtYWwsCiAgICAgIGRpc3RhbmNlRm9yQm90dG9tLAogICAgICBhZGp1c3RIZWlnaHRPZmZzZXRTY3JhdGNoCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChib3R0b20sIGFkanVzdEhlaWdodE9mZnNldCwgYWRqdXN0SGVpZ2h0Qm90dG9tKTsKICAgIGNvbnN0IGRpc3RhbmNlRm9yVG9wID0gbWF4SGVpZ2h0IC0gV0FMTF9JTklUSUFMX01BWF9IRUlHSFQ7CiAgICBhZGp1c3RIZWlnaHRPZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgYWRqdXN0SGVpZ2h0Tm9ybWFsLAogICAgICBkaXN0YW5jZUZvclRvcCwKICAgICAgYWRqdXN0SGVpZ2h0T2Zmc2V0U2NyYXRjaAogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodG9wLCBhZGp1c3RIZWlnaHRPZmZzZXQsIGFkanVzdEhlaWdodFRvcCk7CiAgfQogIGZ1bmN0aW9uIG51ZGdlWFooc3RhcnQsIGVuZCkgewogICAgY29uc3Qgc3RhcnRUb1haZGlzdGFuY2UgPSBQbGFuZV9kZWZhdWx0LmdldFBvaW50RGlzdGFuY2UoWFpfUExBTkUsIHN0YXJ0KTsKICAgIGNvbnN0IGVuZFRvWFpkaXN0YW5jZSA9IFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZShYWl9QTEFORSwgZW5kKTsKICAgIGxldCBvZmZzZXQgPSBudWRnZURpcmVjdGlvblNjcmF0Y2g7CiAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oc3RhcnRUb1haZGlzdGFuY2UsIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMikpIHsKICAgICAgb2Zmc2V0ID0gZGlyZWN0aW9uKGVuZCwgc3RhcnQsIG9mZnNldCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG9mZnNldCwgTWF0aF9kZWZhdWx0LkVQU0lMT04yLCBvZmZzZXQpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHN0YXJ0LCBvZmZzZXQsIHN0YXJ0KTsKICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oZW5kVG9YWmRpc3RhbmNlLCAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIpKSB7CiAgICAgIG9mZnNldCA9IGRpcmVjdGlvbihzdGFydCwgZW5kLCBvZmZzZXQpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihvZmZzZXQsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMiwgb2Zmc2V0KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChlbmQsIG9mZnNldCwgZW5kKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gbnVkZ2VDYXJ0b2dyYXBoaWMoc3RhcnQsIGVuZCkgewogICAgY29uc3QgYWJzU3RhcnRMb24gPSBNYXRoLmFicyhzdGFydC5sb25naXR1ZGUpOwogICAgY29uc3QgYWJzRW5kTG9uID0gTWF0aC5hYnMoZW5kLmxvbmdpdHVkZSk7CiAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oYWJzU3RhcnRMb24sIE1hdGhfZGVmYXVsdC5QSSwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMSkpIHsKICAgICAgY29uc3QgZW5kU2lnbiA9IE1hdGhfZGVmYXVsdC5zaWduKGVuZC5sb25naXR1ZGUpOwogICAgICBzdGFydC5sb25naXR1ZGUgPSBlbmRTaWduICogKGFic1N0YXJ0TG9uIC0gTWF0aF9kZWZhdWx0LkVQU0lMT04xMSk7CiAgICAgIHJldHVybiAxOwogICAgfSBlbHNlIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihhYnNFbmRMb24sIE1hdGhfZGVmYXVsdC5QSSwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMSkpIHsKICAgICAgY29uc3Qgc3RhcnRTaWduID0gTWF0aF9kZWZhdWx0LnNpZ24oc3RhcnQubG9uZ2l0dWRlKTsKICAgICAgZW5kLmxvbmdpdHVkZSA9IHN0YXJ0U2lnbiAqIChhYnNFbmRMb24gLSBNYXRoX2RlZmF1bHQuRVBTSUxPTjExKTsKICAgICAgcmV0dXJuIDI7CiAgICB9CiAgICByZXR1cm4gMDsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVHZW9tZXRyeUF0dHJpYnV0ZXMobG9vcCwgcHJvamVjdGlvbiwgYm90dG9tUG9zaXRpb25zQXJyYXksIHRvcFBvc2l0aW9uc0FycmF5LCBub3JtYWxzQXJyYXksIGNhcnRvZ3JhcGhpY3NBcnJheSwgY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgbGV0IGk7CiAgICBsZXQgaW5kZXg7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLl9lbGxpcHNvaWQ7CiAgICBjb25zdCBzZWdtZW50Q291bnQgPSBib3R0b21Qb3NpdGlvbnNBcnJheS5sZW5ndGggLyAzIC0gMTsKICAgIGNvbnN0IHZlcnRleENvdW50ID0gc2VnbWVudENvdW50ICogODsKICAgIGNvbnN0IGFycmF5U2l6ZVZlYzQgPSB2ZXJ0ZXhDb3VudCAqIDQ7CiAgICBjb25zdCBpbmRleENvdW50ID0gc2VnbWVudENvdW50ICogMzY7CiAgICBjb25zdCBpbmRpY2VzID0gdmVydGV4Q291bnQgPiA2NTUzNSA/IG5ldyBVaW50MzJBcnJheShpbmRleENvdW50KSA6IG5ldyBVaW50MTZBcnJheShpbmRleENvdW50KTsKICAgIGNvbnN0IHBvc2l0aW9uc0FycmF5ID0gbmV3IEZsb2F0NjRBcnJheSh2ZXJ0ZXhDb3VudCAqIDMpOwogICAgY29uc3Qgc3RhcnRIaUFuZEZvcndhcmRPZmZzZXRYID0gbmV3IEZsb2F0MzJBcnJheShhcnJheVNpemVWZWM0KTsKICAgIGNvbnN0IHN0YXJ0TG9BbmRGb3J3YXJkT2Zmc2V0WSA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlTaXplVmVjNCk7CiAgICBjb25zdCBzdGFydE5vcm1hbEFuZEZvcndhcmRPZmZzZXRaID0gbmV3IEZsb2F0MzJBcnJheShhcnJheVNpemVWZWM0KTsKICAgIGNvbnN0IGVuZE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblggPSBuZXcgRmxvYXQzMkFycmF5KAogICAgICBhcnJheVNpemVWZWM0CiAgICApOwogICAgY29uc3QgcmlnaHROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25ZID0gbmV3IEZsb2F0MzJBcnJheSgKICAgICAgYXJyYXlTaXplVmVjNAogICAgKTsKICAgIGxldCBzdGFydEhpTG8yRDsKICAgIGxldCBvZmZzZXRBbmRSaWdodDJEOwogICAgbGV0IHN0YXJ0RW5kTm9ybWFsczJEOwogICAgbGV0IHRleGNvb3JkTm9ybWFsaXphdGlvbjJEOwogICAgaWYgKGNvbXB1dGUyZEF0dHJpYnV0ZXMpIHsKICAgICAgc3RhcnRIaUxvMkQgPSBuZXcgRmxvYXQzMkFycmF5KGFycmF5U2l6ZVZlYzQpOwogICAgICBvZmZzZXRBbmRSaWdodDJEID0gbmV3IEZsb2F0MzJBcnJheShhcnJheVNpemVWZWM0KTsKICAgICAgc3RhcnRFbmROb3JtYWxzMkQgPSBuZXcgRmxvYXQzMkFycmF5KGFycmF5U2l6ZVZlYzQpOwogICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRCA9IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAyKTsKICAgIH0KICAgIGNvbnN0IGNhcnRvZ3JhcGhpY3NMZW5ndGggPSBjYXJ0b2dyYXBoaWNzQXJyYXkubGVuZ3RoIC8gMjsKICAgIGxldCBsZW5ndGgyRCA9IDA7CiAgICBjb25zdCBzdGFydENhcnRvZ3JhcGhpYyA9IHN0YXJ0Q2FydG9ncmFwaGljU2NyYXRjaDsKICAgIHN0YXJ0Q2FydG9ncmFwaGljLmhlaWdodCA9IDA7CiAgICBjb25zdCBlbmRDYXJ0b2dyYXBoaWMgPSBlbmRDYXJ0b2dyYXBoaWNTY3JhdGNoOwogICAgZW5kQ2FydG9ncmFwaGljLmhlaWdodCA9IDA7CiAgICBsZXQgc2VnbWVudFN0YXJ0Q2FydGVzaWFuID0gc2VnbWVudFN0YXJ0VG9wU2NyYXRjaDsKICAgIGxldCBzZWdtZW50RW5kQ2FydGVzaWFuID0gc2VnbWVudEVuZFRvcFNjcmF0Y2g7CiAgICBpZiAoY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgICBpbmRleCA9IDA7CiAgICAgIGZvciAoaSA9IDE7IGkgPCBjYXJ0b2dyYXBoaWNzTGVuZ3RoOyBpKyspIHsKICAgICAgICBzdGFydENhcnRvZ3JhcGhpYy5sYXRpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtpbmRleF07CiAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2luZGV4ICsgMV07CiAgICAgICAgZW5kQ2FydG9ncmFwaGljLmxhdGl0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2luZGV4ICsgMl07CiAgICAgICAgZW5kQ2FydG9ncmFwaGljLmxvbmdpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtpbmRleCArIDNdOwogICAgICAgIHNlZ21lbnRTdGFydENhcnRlc2lhbiA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgc2VnbWVudFN0YXJ0Q2FydGVzaWFuCiAgICAgICAgKTsKICAgICAgICBzZWdtZW50RW5kQ2FydGVzaWFuID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgc2VnbWVudEVuZENhcnRlc2lhbgogICAgICAgICk7CiAgICAgICAgbGVuZ3RoMkQgKz0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKAogICAgICAgICAgc2VnbWVudFN0YXJ0Q2FydGVzaWFuLAogICAgICAgICAgc2VnbWVudEVuZENhcnRlc2lhbgogICAgICAgICk7CiAgICAgICAgaW5kZXggKz0gMjsKICAgICAgfQogICAgfQogICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gdG9wUG9zaXRpb25zQXJyYXkubGVuZ3RoIC8gMzsKICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICB0b3BQb3NpdGlvbnNBcnJheSwKICAgICAgMCwKICAgICAgc2VnbWVudEVuZENhcnRlc2lhbgogICAgKTsKICAgIGxldCBsZW5ndGgzRCA9IDA7CiAgICBpbmRleCA9IDM7CiAgICBmb3IgKGkgPSAxOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyBpKyspIHsKICAgICAgc2VnbWVudFN0YXJ0Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4sCiAgICAgICAgc2VnbWVudFN0YXJ0Q2FydGVzaWFuCiAgICAgICk7CiAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAgIGluZGV4LAogICAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4KICAgICAgKTsKICAgICAgbGVuZ3RoM0QgKz0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHNlZ21lbnRTdGFydENhcnRlc2lhbiwgc2VnbWVudEVuZENhcnRlc2lhbik7CiAgICAgIGluZGV4ICs9IDM7CiAgICB9CiAgICBsZXQgajsKICAgIGluZGV4ID0gMzsKICAgIGxldCBjYXJ0b2dyYXBoaWNzSW5kZXggPSAwOwogICAgbGV0IHZlYzJzV3JpdGVJbmRleCA9IDA7CiAgICBsZXQgdmVjM3NXcml0ZUluZGV4ID0gMDsKICAgIGxldCB2ZWM0c1dyaXRlSW5kZXggPSAwOwogICAgbGV0IG1pdGVyQnJva2VuID0gZmFsc2U7CiAgICBsZXQgZW5kQm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgIDAsCiAgICAgIHNlZ21lbnRFbmRCb3R0b21TY3JhdGNoCiAgICApOwogICAgbGV0IGVuZFRvcCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sodG9wUG9zaXRpb25zQXJyYXksIDAsIHNlZ21lbnRFbmRUb3BTY3JhdGNoKTsKICAgIGxldCBlbmRHZW9tZXRyeU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgIG5vcm1hbHNBcnJheSwKICAgICAgMCwKICAgICAgc2VnbWVudEVuZE5vcm1hbFNjcmF0Y2gKICAgICk7CiAgICBpZiAobG9vcCkgewogICAgICBjb25zdCBwcmVFbmRCb3R0b20gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5LAogICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5Lmxlbmd0aCAtIDYsCiAgICAgICAgc2VnbWVudFN0YXJ0Qm90dG9tU2NyYXRjaAogICAgICApOwogICAgICBpZiAoYnJlYWtNaXRlcihlbmRHZW9tZXRyeU5vcm1hbCwgcHJlRW5kQm90dG9tLCBlbmRCb3R0b20sIGVuZFRvcCkpIHsKICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCwKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgbGV0IGxlbmd0aFNvRmFyM0QgPSAwOwogICAgbGV0IGxlbmd0aFNvRmFyMkQgPSAwOwogICAgbGV0IHN1bUhlaWdodHMgPSAwOwogICAgZm9yIChpID0gMDsgaSA8IHNlZ21lbnRDb3VudDsgaSsrKSB7CiAgICAgIGNvbnN0IHN0YXJ0Qm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVuZEJvdHRvbSwgc2VnbWVudFN0YXJ0Qm90dG9tU2NyYXRjaCk7CiAgICAgIGNvbnN0IHN0YXJ0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVuZFRvcCwgc2VnbWVudFN0YXJ0VG9wU2NyYXRjaCk7CiAgICAgIGxldCBzdGFydEdlb21ldHJ5Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsLAogICAgICAgIHNlZ21lbnRTdGFydE5vcm1hbFNjcmF0Y2gKICAgICAgKTsKICAgICAgaWYgKG1pdGVyQnJva2VuKSB7CiAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsLAogICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbAogICAgICAgICk7CiAgICAgIH0KICAgICAgZW5kQm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICBpbmRleCwKICAgICAgICBzZWdtZW50RW5kQm90dG9tU2NyYXRjaAogICAgICApOwogICAgICBlbmRUb3AgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHRvcFBvc2l0aW9uc0FycmF5LCBpbmRleCwgc2VnbWVudEVuZFRvcFNjcmF0Y2gpOwogICAgICBlbmRHZW9tZXRyeU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgbm9ybWFsc0FycmF5LAogICAgICAgIGluZGV4LAogICAgICAgIHNlZ21lbnRFbmROb3JtYWxTY3JhdGNoCiAgICAgICk7CiAgICAgIG1pdGVyQnJva2VuID0gYnJlYWtNaXRlcihlbmRHZW9tZXRyeU5vcm1hbCwgc3RhcnRCb3R0b20sIGVuZEJvdHRvbSwgZW5kVG9wKTsKICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbY2FydG9ncmFwaGljc0luZGV4XTsKICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2NhcnRvZ3JhcGhpY3NJbmRleCArIDFdOwogICAgICBlbmRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbY2FydG9ncmFwaGljc0luZGV4ICsgMl07CiAgICAgIGVuZENhcnRvZ3JhcGhpYy5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbY2FydG9ncmFwaGljc0luZGV4ICsgM107CiAgICAgIGxldCBzdGFydDJEOwogICAgICBsZXQgZW5kMkQ7CiAgICAgIGxldCBzdGFydEdlb21ldHJ5Tm9ybWFsMkQ7CiAgICAgIGxldCBlbmRHZW9tZXRyeU5vcm1hbDJEOwogICAgICBpZiAoY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgICAgIGNvbnN0IG51ZGdlUmVzdWx0ID0gbnVkZ2VDYXJ0b2dyYXBoaWMoc3RhcnRDYXJ0b2dyYXBoaWMsIGVuZENhcnRvZ3JhcGhpYyk7CiAgICAgICAgc3RhcnQyRCA9IHByb2plY3Rpb24ucHJvamVjdChzdGFydENhcnRvZ3JhcGhpYywgc2VnbWVudFN0YXJ0MkRTY3JhdGNoKTsKICAgICAgICBlbmQyRCA9IHByb2plY3Rpb24ucHJvamVjdChlbmRDYXJ0b2dyYXBoaWMsIHNlZ21lbnRFbmQyRFNjcmF0Y2gpOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjJEID0gZGlyZWN0aW9uKGVuZDJELCBzdGFydDJELCBmb3J3YXJkT2Zmc2V0MkRTY3JhdGNoKTsKICAgICAgICBkaXJlY3Rpb24yRC55ID0gTWF0aC5hYnMoZGlyZWN0aW9uMkQueSk7CiAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbDJEID0gc2VnbWVudFN0YXJ0Tm9ybWFsMkRTY3JhdGNoOwogICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsMkQgPSBzZWdtZW50RW5kTm9ybWFsMkRTY3JhdGNoOwogICAgICAgIGlmIChudWRnZVJlc3VsdCA9PT0gMCB8fCBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjJELCBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZKSA+IE1JVEVSX0JSRUFLX1NNQUxMKSB7CiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsMkQgPSBwcm9qZWN0Tm9ybWFsKAogICAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbCwKICAgICAgICAgICAgc3RhcnQyRCwKICAgICAgICAgICAgc2VnbWVudFN0YXJ0Tm9ybWFsMkRTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwyRCA9IHByb2plY3ROb3JtYWwoCiAgICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICAgIGVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwsCiAgICAgICAgICAgIGVuZDJELAogICAgICAgICAgICBzZWdtZW50RW5kTm9ybWFsMkRTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAobnVkZ2VSZXN1bHQgPT09IDEpIHsKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsMkQgPSBwcm9qZWN0Tm9ybWFsKAogICAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgICBlbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsLAogICAgICAgICAgICBlbmQyRCwKICAgICAgICAgICAgc2VnbWVudEVuZE5vcm1hbDJEU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwyRC54ID0gMDsKICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwyRC55ID0gTWF0aF9kZWZhdWx0LnNpZ24oCiAgICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLmxvbmdpdHVkZSAtIE1hdGguYWJzKGVuZENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbDJELnogPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsMkQgPSBwcm9qZWN0Tm9ybWFsKAogICAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbCwKICAgICAgICAgICAgc3RhcnQyRCwKICAgICAgICAgICAgc2VnbWVudFN0YXJ0Tm9ybWFsMkRTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwyRC54ID0gMDsKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsMkQueSA9IE1hdGhfZGVmYXVsdC5zaWduKAogICAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYy5sb25naXR1ZGUgLSBlbmRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlCiAgICAgICAgICApOwogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwyRC56ID0gMDsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3Qgc2VnbWVudExlbmd0aDNEID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHN0YXJ0VG9wLCBlbmRUb3ApOwogICAgICBjb25zdCBlbmNvZGVkU3RhcnQgPSBFbmNvZGVkQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4oCiAgICAgICAgc3RhcnRCb3R0b20sCiAgICAgICAgZW5jb2RlU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBmb3J3YXJkT2Zmc2V0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIGVuZEJvdHRvbSwKICAgICAgICBzdGFydEJvdHRvbSwKICAgICAgICBvZmZzZXRTY3JhdGNoMgogICAgICApOwogICAgICBjb25zdCBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShmb3J3YXJkT2Zmc2V0LCByaWdodFNjcmF0Y2gyKTsKICAgICAgbGV0IHN0YXJ0VXAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoc3RhcnRUb3AsIHN0YXJ0Qm90dG9tLCBzdGFydFVwU2NyYXRjaCk7CiAgICAgIHN0YXJ0VXAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHN0YXJ0VXAsIHN0YXJ0VXApOwogICAgICBsZXQgcmlnaHROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZm9yd2FyZCwgc3RhcnRVcCwgcmlnaHRTY3JhdGNoMik7CiAgICAgIHJpZ2h0Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyaWdodE5vcm1hbCwgcmlnaHROb3JtYWwpOwogICAgICBsZXQgc3RhcnRQbGFuZU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICBzdGFydFVwLAogICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwsCiAgICAgICAgc3RhcnRQbGFuZU5vcm1hbFNjcmF0Y2gKICAgICAgKTsKICAgICAgc3RhcnRQbGFuZU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoc3RhcnRQbGFuZU5vcm1hbCwgc3RhcnRQbGFuZU5vcm1hbCk7CiAgICAgIGxldCBlbmRVcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChlbmRUb3AsIGVuZEJvdHRvbSwgZW5kVXBTY3JhdGNoKTsKICAgICAgZW5kVXAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGVuZFVwLCBlbmRVcCk7CiAgICAgIGxldCBlbmRQbGFuZU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCwKICAgICAgICBlbmRVcCwKICAgICAgICBlbmRQbGFuZU5vcm1hbFNjcmF0Y2gKICAgICAgKTsKICAgICAgZW5kUGxhbmVOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGVuZFBsYW5lTm9ybWFsLCBlbmRQbGFuZU5vcm1hbCk7CiAgICAgIGNvbnN0IHRleGNvb3JkTm9ybWFsaXphdGlvbjNEWCA9IHNlZ21lbnRMZW5ndGgzRCAvIGxlbmd0aDNEOwogICAgICBjb25zdCB0ZXhjb29yZE5vcm1hbGl6YXRpb24zRFkgPSBsZW5ndGhTb0ZhcjNEIC8gbGVuZ3RoM0Q7CiAgICAgIGxldCBzZWdtZW50TGVuZ3RoMkQgPSAwOwogICAgICBsZXQgZW5jb2RlZFN0YXJ0MkQ7CiAgICAgIGxldCBmb3J3YXJkT2Zmc2V0MkQ7CiAgICAgIGxldCByaWdodDJEOwogICAgICBsZXQgdGV4Y29vcmROb3JtYWxpemF0aW9uMkRYID0gMDsKICAgICAgbGV0IHRleGNvb3JkTm9ybWFsaXphdGlvbjJEWSA9IDA7CiAgICAgIGlmIChjb21wdXRlMmRBdHRyaWJ1dGVzKSB7CiAgICAgICAgc2VnbWVudExlbmd0aDJEID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHN0YXJ0MkQsIGVuZDJEKTsKICAgICAgICBlbmNvZGVkU3RhcnQyRCA9IEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUNhcnRlc2lhbigKICAgICAgICAgIHN0YXJ0MkQsCiAgICAgICAgICBlbmNvZGVTY3JhdGNoMkQKICAgICAgICApOwogICAgICAgIGZvcndhcmRPZmZzZXQyRCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGVuZDJELAogICAgICAgICAgc3RhcnQyRCwKICAgICAgICAgIGZvcndhcmRPZmZzZXQyRFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIHJpZ2h0MkQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGZvcndhcmRPZmZzZXQyRCwgcmlnaHQyRFNjcmF0Y2gpOwogICAgICAgIGNvbnN0IHN3YXAyID0gcmlnaHQyRC54OwogICAgICAgIHJpZ2h0MkQueCA9IHJpZ2h0MkQueTsKICAgICAgICByaWdodDJELnkgPSAtc3dhcDI7CiAgICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uMkRYID0gc2VnbWVudExlbmd0aDJEIC8gbGVuZ3RoMkQ7CiAgICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uMkRZID0gbGVuZ3RoU29GYXIyRCAvIGxlbmd0aDJEOwogICAgICB9CiAgICAgIGZvciAoaiA9IDA7IGogPCA4OyBqKyspIHsKICAgICAgICBjb25zdCB2ZWM0SW5kZXggPSB2ZWM0c1dyaXRlSW5kZXggKyBqICogNDsKICAgICAgICBjb25zdCB2ZWMySW5kZXggPSB2ZWMyc1dyaXRlSW5kZXggKyBqICogMjsKICAgICAgICBjb25zdCB3SW5kZXggPSB2ZWM0SW5kZXggKyAzOwogICAgICAgIGNvbnN0IHJpZ2h0UGxhbmVTaWRlID0gaiA8IDQgPyAxIDogLTE7CiAgICAgICAgY29uc3QgdG9wQm90dG9tU2lkZSA9IGogPT09IDIgfHwgaiA9PT0gMyB8fCBqID09PSA2IHx8IGogPT09IDcgPyAxIDogLTE7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZW5jb2RlZFN0YXJ0LmhpZ2gsIHN0YXJ0SGlBbmRGb3J3YXJkT2Zmc2V0WCwgdmVjNEluZGV4KTsKICAgICAgICBzdGFydEhpQW5kRm9yd2FyZE9mZnNldFhbd0luZGV4XSA9IGZvcndhcmRPZmZzZXQueDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhlbmNvZGVkU3RhcnQubG93LCBzdGFydExvQW5kRm9yd2FyZE9mZnNldFksIHZlYzRJbmRleCk7CiAgICAgICAgc3RhcnRMb0FuZEZvcndhcmRPZmZzZXRZW3dJbmRleF0gPSBmb3J3YXJkT2Zmc2V0Lnk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soCiAgICAgICAgICBzdGFydFBsYW5lTm9ybWFsLAogICAgICAgICAgc3RhcnROb3JtYWxBbmRGb3J3YXJkT2Zmc2V0WiwKICAgICAgICAgIHZlYzRJbmRleAogICAgICAgICk7CiAgICAgICAgc3RhcnROb3JtYWxBbmRGb3J3YXJkT2Zmc2V0Wlt3SW5kZXhdID0gZm9yd2FyZE9mZnNldC56OwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgICAgZW5kUGxhbmVOb3JtYWwsCiAgICAgICAgICBlbmROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25YLAogICAgICAgICAgdmVjNEluZGV4CiAgICAgICAgKTsKICAgICAgICBlbmROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25YW3dJbmRleF0gPSB0ZXhjb29yZE5vcm1hbGl6YXRpb24zRFggKiByaWdodFBsYW5lU2lkZTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICAgIHJpZ2h0Tm9ybWFsLAogICAgICAgICAgcmlnaHROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25ZLAogICAgICAgICAgdmVjNEluZGV4CiAgICAgICAgKTsKICAgICAgICBsZXQgdGV4Y29vcmROb3JtYWxpemF0aW9uID0gdGV4Y29vcmROb3JtYWxpemF0aW9uM0RZICogdG9wQm90dG9tU2lkZTsKICAgICAgICBpZiAodGV4Y29vcmROb3JtYWxpemF0aW9uID09PSAwICYmIHRvcEJvdHRvbVNpZGUgPCAwKSB7CiAgICAgICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24gPSA5OwogICAgICAgIH0KICAgICAgICByaWdodE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvbllbd0luZGV4XSA9IHRleGNvb3JkTm9ybWFsaXphdGlvbjsKICAgICAgICBpZiAoY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgICAgICAgc3RhcnRIaUxvMkRbdmVjNEluZGV4XSA9IGVuY29kZWRTdGFydDJELmhpZ2gueDsKICAgICAgICAgIHN0YXJ0SGlMbzJEW3ZlYzRJbmRleCArIDFdID0gZW5jb2RlZFN0YXJ0MkQuaGlnaC55OwogICAgICAgICAgc3RhcnRIaUxvMkRbdmVjNEluZGV4ICsgMl0gPSBlbmNvZGVkU3RhcnQyRC5sb3cueDsKICAgICAgICAgIHN0YXJ0SGlMbzJEW3ZlYzRJbmRleCArIDNdID0gZW5jb2RlZFN0YXJ0MkQubG93Lnk7CiAgICAgICAgICBzdGFydEVuZE5vcm1hbHMyRFt2ZWM0SW5kZXhdID0gLXN0YXJ0R2VvbWV0cnlOb3JtYWwyRC55OwogICAgICAgICAgc3RhcnRFbmROb3JtYWxzMkRbdmVjNEluZGV4ICsgMV0gPSBzdGFydEdlb21ldHJ5Tm9ybWFsMkQueDsKICAgICAgICAgIHN0YXJ0RW5kTm9ybWFsczJEW3ZlYzRJbmRleCArIDJdID0gZW5kR2VvbWV0cnlOb3JtYWwyRC55OwogICAgICAgICAgc3RhcnRFbmROb3JtYWxzMkRbdmVjNEluZGV4ICsgM10gPSAtZW5kR2VvbWV0cnlOb3JtYWwyRC54OwogICAgICAgICAgb2Zmc2V0QW5kUmlnaHQyRFt2ZWM0SW5kZXhdID0gZm9yd2FyZE9mZnNldDJELng7CiAgICAgICAgICBvZmZzZXRBbmRSaWdodDJEW3ZlYzRJbmRleCArIDFdID0gZm9yd2FyZE9mZnNldDJELnk7CiAgICAgICAgICBvZmZzZXRBbmRSaWdodDJEW3ZlYzRJbmRleCArIDJdID0gcmlnaHQyRC54OwogICAgICAgICAgb2Zmc2V0QW5kUmlnaHQyRFt2ZWM0SW5kZXggKyAzXSA9IHJpZ2h0MkQueTsKICAgICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbjJEW3ZlYzJJbmRleF0gPSB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFggKiByaWdodFBsYW5lU2lkZTsKICAgICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbiA9IHRleGNvb3JkTm9ybWFsaXphdGlvbjJEWSAqIHRvcEJvdHRvbVNpZGU7CiAgICAgICAgICBpZiAodGV4Y29vcmROb3JtYWxpemF0aW9uID09PSAwICYmIHRvcEJvdHRvbVNpZGUgPCAwKSB7CiAgICAgICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbiA9IDk7CiAgICAgICAgICB9CiAgICAgICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFt2ZWMySW5kZXggKyAxXSA9IHRleGNvb3JkTm9ybWFsaXphdGlvbjsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20gPSBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbVNjcmF0Y2g7CiAgICAgIGNvbnN0IGFkanVzdEhlaWdodEVuZEJvdHRvbSA9IGFkanVzdEhlaWdodEVuZEJvdHRvbVNjcmF0Y2g7CiAgICAgIGNvbnN0IGFkanVzdEhlaWdodFN0YXJ0VG9wID0gYWRqdXN0SGVpZ2h0U3RhcnRUb3BTY3JhdGNoOwogICAgICBjb25zdCBhZGp1c3RIZWlnaHRFbmRUb3AgPSBhZGp1c3RIZWlnaHRFbmRUb3BTY3JhdGNoOwogICAgICBjb25zdCBnZXRIZWlnaHRzUmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuZnJvbUNhcnRvZ3JhcGhpY0FycmF5KAogICAgICAgIGdldEhlaWdodENhcnRvZ3JhcGhpY3MsCiAgICAgICAgZ2V0SGVpZ2h0UmVjdGFuZ2xlU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBtaW5NYXhIZWlnaHRzID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0c19kZWZhdWx0LmdldE1pbmltdW1NYXhpbXVtSGVpZ2h0cygKICAgICAgICBnZXRIZWlnaHRzUmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZAogICAgICApOwogICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5NYXhIZWlnaHRzLm1pbmltdW1UZXJyYWluSGVpZ2h0OwogICAgICBjb25zdCBtYXhIZWlnaHQgPSBtaW5NYXhIZWlnaHRzLm1heGltdW1UZXJyYWluSGVpZ2h0OwogICAgICBzdW1IZWlnaHRzICs9IE1hdGguYWJzKG1pbkhlaWdodCk7CiAgICAgIHN1bUhlaWdodHMgKz0gTWF0aC5hYnMobWF4SGVpZ2h0KTsKICAgICAgYWRqdXN0SGVpZ2h0cygKICAgICAgICBzdGFydEJvdHRvbSwKICAgICAgICBzdGFydFRvcCwKICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0VG9wCiAgICAgICk7CiAgICAgIGFkanVzdEhlaWdodHMoCiAgICAgICAgZW5kQm90dG9tLAogICAgICAgIGVuZFRvcCwKICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgIGFkanVzdEhlaWdodEVuZEJvdHRvbSwKICAgICAgICBhZGp1c3RIZWlnaHRFbmRUb3AKICAgICAgKTsKICAgICAgbGV0IG5vcm1hbE51ZGdlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgcmlnaHROb3JtYWwsCiAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT041LAogICAgICAgIG5vcm1hbE51ZGdlU2NyYXRjaAogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLAogICAgICAgIG5vcm1hbE51ZGdlLAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYWRqdXN0SGVpZ2h0RW5kQm90dG9tLCBub3JtYWxOdWRnZSwgYWRqdXN0SGVpZ2h0RW5kQm90dG9tKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChhZGp1c3RIZWlnaHRTdGFydFRvcCwgbm9ybWFsTnVkZ2UsIGFkanVzdEhlaWdodFN0YXJ0VG9wKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChhZGp1c3RIZWlnaHRFbmRUb3AsIG5vcm1hbE51ZGdlLCBhZGp1c3RIZWlnaHRFbmRUb3ApOwogICAgICBudWRnZVhaKGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLCBhZGp1c3RIZWlnaHRFbmRCb3R0b20pOwogICAgICBudWRnZVhaKGFkanVzdEhlaWdodFN0YXJ0VG9wLCBhZGp1c3RIZWlnaHRFbmRUb3ApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwgcG9zaXRpb25zQXJyYXksIHZlYzNzV3JpdGVJbmRleCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGFkanVzdEhlaWdodEVuZEJvdHRvbSwgcG9zaXRpb25zQXJyYXksIHZlYzNzV3JpdGVJbmRleCArIDMpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhhZGp1c3RIZWlnaHRFbmRUb3AsIHBvc2l0aW9uc0FycmF5LCB2ZWMzc1dyaXRlSW5kZXggKyA2KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soYWRqdXN0SGVpZ2h0U3RhcnRUb3AsIHBvc2l0aW9uc0FycmF5LCB2ZWMzc1dyaXRlSW5kZXggKyA5KTsKICAgICAgbm9ybWFsTnVkZ2UgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICByaWdodE5vcm1hbCwKICAgICAgICAtMiAqIE1hdGhfZGVmYXVsdC5FUFNJTE9ONSwKICAgICAgICBub3JtYWxOdWRnZVNjcmF0Y2gKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwKICAgICAgICBub3JtYWxOdWRnZSwKICAgICAgICBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbQogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGFkanVzdEhlaWdodEVuZEJvdHRvbSwgbm9ybWFsTnVkZ2UsIGFkanVzdEhlaWdodEVuZEJvdHRvbSk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYWRqdXN0SGVpZ2h0U3RhcnRUb3AsIG5vcm1hbE51ZGdlLCBhZGp1c3RIZWlnaHRTdGFydFRvcCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYWRqdXN0SGVpZ2h0RW5kVG9wLCBub3JtYWxOdWRnZSwgYWRqdXN0SGVpZ2h0RW5kVG9wKTsKICAgICAgbnVkZ2VYWihhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwgYWRqdXN0SGVpZ2h0RW5kQm90dG9tKTsKICAgICAgbnVkZ2VYWihhZGp1c3RIZWlnaHRTdGFydFRvcCwgYWRqdXN0SGVpZ2h0RW5kVG9wKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soCiAgICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20sCiAgICAgICAgcG9zaXRpb25zQXJyYXksCiAgICAgICAgdmVjM3NXcml0ZUluZGV4ICsgMTIKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soCiAgICAgICAgYWRqdXN0SGVpZ2h0RW5kQm90dG9tLAogICAgICAgIHBvc2l0aW9uc0FycmF5LAogICAgICAgIHZlYzNzV3JpdGVJbmRleCArIDE1CiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGFkanVzdEhlaWdodEVuZFRvcCwgcG9zaXRpb25zQXJyYXksIHZlYzNzV3JpdGVJbmRleCArIDE4KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soYWRqdXN0SGVpZ2h0U3RhcnRUb3AsIHBvc2l0aW9uc0FycmF5LCB2ZWMzc1dyaXRlSW5kZXggKyAyMSk7CiAgICAgIGNhcnRvZ3JhcGhpY3NJbmRleCArPSAyOwogICAgICBpbmRleCArPSAzOwogICAgICB2ZWMyc1dyaXRlSW5kZXggKz0gMTY7CiAgICAgIHZlYzNzV3JpdGVJbmRleCArPSAyNDsKICAgICAgdmVjNHNXcml0ZUluZGV4ICs9IDMyOwogICAgICBsZW5ndGhTb0ZhcjNEICs9IHNlZ21lbnRMZW5ndGgzRDsKICAgICAgbGVuZ3RoU29GYXIyRCArPSBzZWdtZW50TGVuZ3RoMkQ7CiAgICB9CiAgICBpbmRleCA9IDA7CiAgICBsZXQgaW5kZXhPZmZzZXQgPSAwOwogICAgZm9yIChpID0gMDsgaSA8IHNlZ21lbnRDb3VudDsgaSsrKSB7CiAgICAgIGZvciAoaiA9IDA7IGogPCBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEg7IGorKykgewogICAgICAgIGluZGljZXNbaW5kZXggKyBqXSA9IFJFRkVSRU5DRV9JTkRJQ0VTW2pdICsgaW5kZXhPZmZzZXQ7CiAgICAgIH0KICAgICAgaW5kZXhPZmZzZXQgKz0gODsKICAgICAgaW5kZXggKz0gUkVGRVJFTkNFX0lORElDRVNfTEVOR1RIOwogICAgfQogICAgY29uc3QgYm91bmRpbmdTcGhlcmVzID0gc2NyYXRjaEJvdW5kaW5nU3BoZXJlczsKICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgIDMsCiAgICAgIGJvdW5kaW5nU3BoZXJlc1swXQogICAgKTsKICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICB0b3BQb3NpdGlvbnNBcnJheSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgIDMsCiAgICAgIGJvdW5kaW5nU3BoZXJlc1sxXQogICAgKTsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tQm91bmRpbmdTcGhlcmVzKGJvdW5kaW5nU3BoZXJlcyk7CiAgICBib3VuZGluZ1NwaGVyZS5yYWRpdXMgKz0gc3VtSGVpZ2h0cyAvIChzZWdtZW50Q291bnQgKiAyKTsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSB7CiAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgbm9ybWFsaXplOiBmYWxzZSwKICAgICAgICB2YWx1ZXM6IHBvc2l0aW9uc0FycmF5CiAgICAgIH0pLAogICAgICBzdGFydEhpQW5kRm9yd2FyZE9mZnNldFg6IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSgKICAgICAgICBzdGFydEhpQW5kRm9yd2FyZE9mZnNldFgKICAgICAgKSwKICAgICAgc3RhcnRMb0FuZEZvcndhcmRPZmZzZXRZOiBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUoCiAgICAgICAgc3RhcnRMb0FuZEZvcndhcmRPZmZzZXRZCiAgICAgICksCiAgICAgIHN0YXJ0Tm9ybWFsQW5kRm9yd2FyZE9mZnNldFo6IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSgKICAgICAgICBzdGFydE5vcm1hbEFuZEZvcndhcmRPZmZzZXRaCiAgICAgICksCiAgICAgIGVuZE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblg6IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSgKICAgICAgICBlbmROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25YCiAgICAgICksCiAgICAgIHJpZ2h0Tm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWTogZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKAogICAgICAgIHJpZ2h0Tm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWQogICAgICApCiAgICB9OwogICAgaWYgKGNvbXB1dGUyZEF0dHJpYnV0ZXMpIHsKICAgICAgYXR0cmlidXRlcy5zdGFydEhpTG8yRCA9IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZShzdGFydEhpTG8yRCk7CiAgICAgIGF0dHJpYnV0ZXMub2Zmc2V0QW5kUmlnaHQyRCA9IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZShvZmZzZXRBbmRSaWdodDJEKTsKICAgICAgYXR0cmlidXRlcy5zdGFydEVuZE5vcm1hbHMyRCA9IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZShzdGFydEVuZE5vcm1hbHMyRCk7CiAgICAgIGF0dHJpYnV0ZXMudGV4Y29vcmROb3JtYWxpemF0aW9uMkQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICBub3JtYWxpemU6IGZhbHNlLAogICAgICAgIHZhbHVlczogdGV4Y29vcmROb3JtYWxpemF0aW9uMkQKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzLAogICAgICBib3VuZGluZ1NwaGVyZQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSh0eXBlZEFycmF5KSB7CiAgICByZXR1cm4gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogNCwKICAgICAgbm9ybWFsaXplOiBmYWxzZSwKICAgICAgdmFsdWVzOiB0eXBlZEFycmF5CiAgICB9KTsKICB9CiAgdmFyIFBST0pFQ1RJT05TLCBQUk9KRUNUSU9OX0NPVU5ULCBNSVRFUl9CUkVBS19TTUFMTCwgTUlURVJfQlJFQUtfTEFSR0UsIFdBTExfSU5JVElBTF9NSU5fSEVJR0hULCBXQUxMX0lOSVRJQUxfTUFYX0hFSUdIVCwgY2FydDNTY3JhdGNoMSwgY2FydDNTY3JhdGNoMiwgY2FydDNTY3JhdGNoMywgaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljU2NyYXRjaCwgaW50ZXJwb2xhdGVkQm90dG9tU2NyYXRjaCwgaW50ZXJwb2xhdGVkVG9wU2NyYXRjaCwgaW50ZXJwb2xhdGVkTm9ybWFsU2NyYXRjaCwgaGVpZ2h0bGVzc0NhcnRvZ3JhcGhpY1NjcmF0Y2gsIHRvUHJldmlvdXNTY3JhdGNoLCB0b05leHRTY3JhdGNoLCBmb3J3YXJkU2NyYXRjaCwgdmVydGV4VXBTY3JhdGNoLCBjb3NpbmU5MCwgY29zaW5lMTgwLCBYWl9QTEFORSwgcHJldmlvdXNCb3R0b21TY3JhdGNoLCB2ZXJ0ZXhCb3R0b21TY3JhdGNoLCB2ZXJ0ZXhUb3BTY3JhdGNoLCBuZXh0Qm90dG9tU2NyYXRjaCwgdmVydGV4Tm9ybWFsU2NyYXRjaCwgaW50ZXJzZWN0aW9uU2NyYXRjaCwgY2FydG9ncmFwaGljU2NyYXRjaDAsIGNhcnRvZ3JhcGhpY1NjcmF0Y2gxLCBjYXJ0b2dyYXBoaWNJbnRlcnNlY3Rpb25TY3JhdGNoLCBsaW5lRGlyZWN0aW9uU2NyYXRjaCwgbWF0cml4M1NjcmF0Y2gsIHF1YXRlcm5pb25TY3JhdGNoMywgZW5kUG9zQ2FydG9ncmFwaGljU2NyYXRjaCwgbm9ybWFsU3RhcnRwb2ludFNjcmF0Y2gsIG5vcm1hbEVuZHBvaW50U2NyYXRjaCwgYWRqdXN0SGVpZ2h0Tm9ybWFsU2NyYXRjaCwgYWRqdXN0SGVpZ2h0T2Zmc2V0U2NyYXRjaCwgbnVkZ2VEaXJlY3Rpb25TY3JhdGNoLCBzdGFydENhcnRvZ3JhcGhpY1NjcmF0Y2gsIGVuZENhcnRvZ3JhcGhpY1NjcmF0Y2gsIHNlZ21lbnRTdGFydFRvcFNjcmF0Y2gsIHNlZ21lbnRFbmRUb3BTY3JhdGNoLCBzZWdtZW50U3RhcnRCb3R0b21TY3JhdGNoLCBzZWdtZW50RW5kQm90dG9tU2NyYXRjaCwgc2VnbWVudFN0YXJ0Tm9ybWFsU2NyYXRjaCwgc2VnbWVudEVuZE5vcm1hbFNjcmF0Y2gsIGdldEhlaWdodENhcnRvZ3JhcGhpY3MsIGdldEhlaWdodFJlY3RhbmdsZVNjcmF0Y2gsIGFkanVzdEhlaWdodFN0YXJ0VG9wU2NyYXRjaCwgYWRqdXN0SGVpZ2h0RW5kVG9wU2NyYXRjaCwgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b21TY3JhdGNoLCBhZGp1c3RIZWlnaHRFbmRCb3R0b21TY3JhdGNoLCBzZWdtZW50U3RhcnQyRFNjcmF0Y2gsIHNlZ21lbnRFbmQyRFNjcmF0Y2gsIHNlZ21lbnRTdGFydE5vcm1hbDJEU2NyYXRjaCwgc2VnbWVudEVuZE5vcm1hbDJEU2NyYXRjaCwgb2Zmc2V0U2NyYXRjaDIsIHN0YXJ0VXBTY3JhdGNoLCBlbmRVcFNjcmF0Y2gsIHJpZ2h0U2NyYXRjaDIsIHN0YXJ0UGxhbmVOb3JtYWxTY3JhdGNoLCBlbmRQbGFuZU5vcm1hbFNjcmF0Y2gsIGVuY29kZVNjcmF0Y2gsIGVuY29kZVNjcmF0Y2gyRCwgZm9yd2FyZE9mZnNldDJEU2NyYXRjaCwgcmlnaHQyRFNjcmF0Y2gsIG5vcm1hbE51ZGdlU2NyYXRjaCwgc2NyYXRjaEJvdW5kaW5nU3BoZXJlcywgUkVGRVJFTkNFX0lORElDRVMsIFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSCwgR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0dyb3VuZFBvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dyb3VuZFBvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FwcHJveGltYXRlVGVycmFpbkhlaWdodHMoKTsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZEdlb2Rlc2ljKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkUmh1bWJMaW5lKCk7CiAgICAgIGluaXRfRW5jb2RlZENhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfV2ViTWVyY2F0b3JQcm9qZWN0aW9uKCk7CiAgICAgIFBST0pFQ1RJT05TID0gW0dlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQsIFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0XTsKICAgICAgUFJPSkVDVElPTl9DT1VOVCA9IFBST0pFQ1RJT05TLmxlbmd0aDsKICAgICAgTUlURVJfQlJFQUtfU01BTEwgPSBNYXRoLmNvcyhNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDMwKSk7CiAgICAgIE1JVEVSX0JSRUFLX0xBUkdFID0gTWF0aC5jb3MoTWF0aF9kZWZhdWx0LnRvUmFkaWFucygxNTApKTsKICAgICAgV0FMTF9JTklUSUFMX01JTl9IRUlHSFQgPSAwOwogICAgICBXQUxMX0lOSVRJQUxfTUFYX0hFSUdIVCA9IDFlMzsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIHVzZWQgdG8gcGFjayB0aGUgb2JqZWN0IGludG8gYW4gYXJyYXkuCiAgICAgICAgICogQG1lbWJlcm9mIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHBhY2tlZExlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIDEgKyB0aGlzLl9wb3NpdGlvbnMubGVuZ3RoICogMyArIDEgKyAxICsgMSArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDEgKyAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuc2V0UHJvamVjdGlvbkFuZEVsbGlwc29pZCA9IGZ1bmN0aW9uKGdyb3VuZFBvbHlsaW5lR2VvbWV0cnksIG1hcFByb2plY3Rpb24pIHsKICAgICAgICBsZXQgcHJvamVjdGlvbkluZGV4ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IFBST0pFQ1RJT05fQ09VTlQ7IGkrKykgewogICAgICAgICAgaWYgKG1hcFByb2plY3Rpb24gaW5zdGFuY2VvZiBQUk9KRUNUSU9OU1tpXSkgewogICAgICAgICAgICBwcm9qZWN0aW9uSW5kZXggPSBpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fcHJvamVjdGlvbkluZGV4ID0gcHJvamVjdGlvbkluZGV4OwogICAgICAgIGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCA9IG1hcFByb2plY3Rpb24uZWxsaXBzb2lkOwogICAgICB9OwogICAgICBjYXJ0M1NjcmF0Y2gxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0M1NjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0M1NjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGludGVycG9sYXRlZEJvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGludGVycG9sYXRlZFRvcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGludGVycG9sYXRlZE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGhlaWdodGxlc3NDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBsZXQgaW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSBwb3NpdGlvbnNMZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgY2FydGVzaWFuMTEgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0ZXNpYW4xMSwgYXJyYXksIGluZGV4KTsKICAgICAgICAgIGluZGV4ICs9IDM7CiAgICAgICAgfQogICAgICAgIGFycmF5W2luZGV4KytdID0gdmFsdWUuZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB2YWx1ZS5sb29wID8gMSA6IDA7CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB2YWx1ZS5hcmNUeXBlOwogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIGluZGV4KTsKICAgICAgICBpbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB2YWx1ZS5fcHJvamVjdGlvbkluZGV4OwogICAgICAgIGFycmF5W2luZGV4KytdID0gdmFsdWUuX3NjZW5lM0RPbmx5ID8gMSA6IDA7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBHcm91bmRQb2x5bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGxldCBpbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IGFycmF5W2luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShwb3NpdGlvbnNMZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIGluZGV4KTsKICAgICAgICAgIGluZGV4ICs9IDM7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbaW5kZXgrK107CiAgICAgICAgY29uc3QgbG9vcCA9IGFycmF5W2luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBhcnJheVtpbmRleCsrXTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIGluZGV4KTsKICAgICAgICBpbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgcHJvamVjdGlvbkluZGV4ID0gYXJyYXlbaW5kZXgrK107CiAgICAgICAgY29uc3Qgc2NlbmUzRE9ubHkgPSBhcnJheVtpbmRleCsrXSA9PT0gMTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgR3JvdW5kUG9seWxpbmVHZW9tZXRyeSh7CiAgICAgICAgICAgIHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5sb29wID0gbG9vcDsKICAgICAgICByZXN1bHQuYXJjVHlwZSA9IGFyY1R5cGU7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBlbGxpcHNvaWQ7CiAgICAgICAgcmVzdWx0Ll9wcm9qZWN0aW9uSW5kZXggPSBwcm9qZWN0aW9uSW5kZXg7CiAgICAgICAgcmVzdWx0Ll9zY2VuZTNET25seSA9IHNjZW5lM0RPbmx5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHRvUHJldmlvdXNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b05leHRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmb3J3YXJkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdmVydGV4VXBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjb3NpbmU5MCA9IDA7CiAgICAgIGNvc2luZTE4MCA9IC0xOwogICAgICBYWl9QTEFORSA9IFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50Tm9ybWFsKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZKTsKICAgICAgcHJldmlvdXNCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2ZXJ0ZXhCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2ZXJ0ZXhUb3BTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBuZXh0Qm90dG9tU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdmVydGV4Tm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaW50ZXJzZWN0aW9uU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDAgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDEgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydG9ncmFwaGljSW50ZXJzZWN0aW9uU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBHcm91bmRQb2x5bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oZ3JvdW5kUG9seWxpbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IGNvbXB1dGUyZEF0dHJpYnV0ZXMgPSAhZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fc2NlbmUzRE9ubHk7CiAgICAgICAgbGV0IGxvb3AgPSBncm91bmRQb2x5bGluZUdlb21ldHJ5Lmxvb3A7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBhcmNUeXBlID0gZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5hcmNUeXBlOwogICAgICAgIGNvbnN0IHByb2plY3Rpb24gPSBuZXcgUFJPSkVDVElPTlNbZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fcHJvamVjdGlvbkluZGV4XSgKICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICk7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0ID0gV0FMTF9JTklUSUFMX01JTl9IRUlHSFQ7CiAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gV0FMTF9JTklUSUFMX01BWF9IRUlHSFQ7CiAgICAgICAgbGV0IGluZGV4OwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGlmIChwb3NpdGlvbnNMZW5ndGggPT09IDIpIHsKICAgICAgICAgIGxvb3AgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgbGV0IHAwOwogICAgICAgIGxldCBwMTsKICAgICAgICBsZXQgYzA7CiAgICAgICAgbGV0IGMxOwogICAgICAgIGNvbnN0IHJodW1iTGluZSA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdCh2b2lkIDAsIHZvaWQgMCwgZWxsaXBzb2lkKTsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uOwogICAgICAgIGxldCBpbnRlcnNlY3Rpb25DYXJ0b2dyYXBoaWM7CiAgICAgICAgbGV0IGludGVyc2VjdGlvbkxvbmdpdHVkZTsKICAgICAgICBjb25zdCBzcGxpdFBvc2l0aW9ucyA9IFtwb3NpdGlvbnNbMF1dOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgcDEgPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgaW50ZXJzZWN0aW9uID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5saW5lU2VnbWVudFBsYW5lKAogICAgICAgICAgICBwMCwKICAgICAgICAgICAgcDEsCiAgICAgICAgICAgIFhaX1BMQU5FLAogICAgICAgICAgICBpbnRlcnNlY3Rpb25TY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpKSB7CiAgICAgICAgICAgIGlmIChncm91bmRQb2x5bGluZUdlb21ldHJ5LmFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICAgIHNwbGl0UG9zaXRpb25zLnB1c2goQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGludGVyc2VjdGlvbikpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLAogICAgICAgICAgICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDAKICAgICAgICAgICAgICApLmxvbmdpdHVkZTsKICAgICAgICAgICAgICBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMCwgY2FydG9ncmFwaGljU2NyYXRjaDApOwogICAgICAgICAgICAgIGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBjYXJ0b2dyYXBoaWNTY3JhdGNoMSk7CiAgICAgICAgICAgICAgcmh1bWJMaW5lLnNldEVuZFBvaW50cyhjMCwgYzEpOwogICAgICAgICAgICAgIGludGVyc2VjdGlvbkNhcnRvZ3JhcGhpYyA9IHJodW1iTGluZS5maW5kSW50ZXJzZWN0aW9uV2l0aExvbmdpdHVkZSgKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSwKICAgICAgICAgICAgICAgIGNhcnRvZ3JhcGhpY0ludGVyc2VjdGlvblNjcmF0Y2gKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGludGVyc2VjdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbkNhcnRvZ3JhcGhpYywKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvblNjcmF0Y2gKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMCwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMSwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSkgewogICAgICAgICAgICAgICAgc3BsaXRQb3NpdGlvbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW50ZXJzZWN0aW9uKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzcGxpdFBvc2l0aW9ucy5wdXNoKHAxKTsKICAgICAgICB9CiAgICAgICAgaWYgKGxvb3ApIHsKICAgICAgICAgIHAwID0gcG9zaXRpb25zW3Bvc2l0aW9uc0xlbmd0aCAtIDFdOwogICAgICAgICAgcDEgPSBwb3NpdGlvbnNbMF07CiAgICAgICAgICBpbnRlcnNlY3Rpb24gPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LmxpbmVTZWdtZW50UGxhbmUoCiAgICAgICAgICAgIHAwLAogICAgICAgICAgICBwMSwKICAgICAgICAgICAgWFpfUExBTkUsCiAgICAgICAgICAgIGludGVyc2VjdGlvblNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDEsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykpIHsKICAgICAgICAgICAgaWYgKGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgICAgc3BsaXRQb3NpdGlvbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW50ZXJzZWN0aW9uKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5hcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25Mb25naXR1ZGUgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24sCiAgICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMAogICAgICAgICAgICAgICkubG9uZ2l0dWRlOwogICAgICAgICAgICAgIGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAwLCBjYXJ0b2dyYXBoaWNTY3JhdGNoMCk7CiAgICAgICAgICAgICAgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDEsIGNhcnRvZ3JhcGhpY1NjcmF0Y2gxKTsKICAgICAgICAgICAgICByaHVtYkxpbmUuc2V0RW5kUG9pbnRzKGMwLCBjMSk7CiAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uQ2FydG9ncmFwaGljID0gcmh1bWJMaW5lLmZpbmRJbnRlcnNlY3Rpb25XaXRoTG9uZ2l0dWRlKAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlLAogICAgICAgICAgICAgICAgY2FydG9ncmFwaGljSW50ZXJzZWN0aW9uU2NyYXRjaAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uQ2FydG9ncmFwaGljLAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uU2NyYXRjaAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpKSB7CiAgICAgICAgICAgICAgICBzcGxpdFBvc2l0aW9ucy5wdXNoKENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbnRlcnNlY3Rpb24pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGNhcnRvZ3JhcGhpY3NMZW5ndGggPSBzcGxpdFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IGNhcnRvZ3JhcGhpY3MgPSBuZXcgQXJyYXkoY2FydG9ncmFwaGljc0xlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNhcnRvZ3JhcGhpY3NMZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHNwbGl0UG9zaXRpb25zW2ldLAogICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICk7CiAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmhlaWdodCA9IDA7CiAgICAgICAgICBjYXJ0b2dyYXBoaWNzW2ldID0gY2FydG9ncmFwaGljMjsKICAgICAgICB9CiAgICAgICAgY2FydG9ncmFwaGljcyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgY2FydG9ncmFwaGljcywKICAgICAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LmVxdWFsc0Vwc2lsb24KICAgICAgICApOwogICAgICAgIGNhcnRvZ3JhcGhpY3NMZW5ndGggPSBjYXJ0b2dyYXBoaWNzLmxlbmd0aDsKICAgICAgICBpZiAoY2FydG9ncmFwaGljc0xlbmd0aCA8IDIpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpY3NBcnJheSA9IFtdOwogICAgICAgIGNvbnN0IG5vcm1hbHNBcnJheSA9IFtdOwogICAgICAgIGNvbnN0IGJvdHRvbVBvc2l0aW9uc0FycmF5ID0gW107CiAgICAgICAgY29uc3QgdG9wUG9zaXRpb25zQXJyYXkgPSBbXTsKICAgICAgICBsZXQgcHJldmlvdXNCb3R0b20gPSBwcmV2aW91c0JvdHRvbVNjcmF0Y2g7CiAgICAgICAgbGV0IHZlcnRleEJvdHRvbSA9IHZlcnRleEJvdHRvbVNjcmF0Y2g7CiAgICAgICAgbGV0IHZlcnRleFRvcCA9IHZlcnRleFRvcFNjcmF0Y2g7CiAgICAgICAgbGV0IG5leHRCb3R0b20gPSBuZXh0Qm90dG9tU2NyYXRjaDsKICAgICAgICBsZXQgdmVydGV4Tm9ybWFsID0gdmVydGV4Tm9ybWFsU2NyYXRjaDsKICAgICAgICBjb25zdCBzdGFydENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbMF07CiAgICAgICAgY29uc3QgbmV4dENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbMV07CiAgICAgICAgY29uc3QgcHJlc3RhcnRDYXJ0b2dyYXBoaWMgPSBjYXJ0b2dyYXBoaWNzW2NhcnRvZ3JhcGhpY3NMZW5ndGggLSAxXTsKICAgICAgICBwcmV2aW91c0JvdHRvbSA9IGdldFBvc2l0aW9uKAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgcHJlc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICBwcmV2aW91c0JvdHRvbQogICAgICAgICk7CiAgICAgICAgbmV4dEJvdHRvbSA9IGdldFBvc2l0aW9uKGVsbGlwc29pZCwgbmV4dENhcnRvZ3JhcGhpYywgbWluSGVpZ2h0LCBuZXh0Qm90dG9tKTsKICAgICAgICB2ZXJ0ZXhCb3R0b20gPSBnZXRQb3NpdGlvbigKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgdmVydGV4Qm90dG9tCiAgICAgICAgKTsKICAgICAgICB2ZXJ0ZXhUb3AgPSBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIHN0YXJ0Q2FydG9ncmFwaGljLCBtYXhIZWlnaHQsIHZlcnRleFRvcCk7CiAgICAgICAgaWYgKGxvb3ApIHsKICAgICAgICAgIHZlcnRleE5vcm1hbCA9IGNvbXB1dGVWZXJ0ZXhNaXRlck5vcm1hbCgKICAgICAgICAgICAgcHJldmlvdXNCb3R0b20sCiAgICAgICAgICAgIHZlcnRleEJvdHRvbSwKICAgICAgICAgICAgdmVydGV4VG9wLAogICAgICAgICAgICBuZXh0Qm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZlcnRleE5vcm1hbCA9IGNvbXB1dGVSaWdodE5vcm1hbCgKICAgICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG5leHRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleE5vcm1hbCwgbm9ybWFsc0FycmF5LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhCb3R0b20sIGJvdHRvbVBvc2l0aW9uc0FycmF5LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhUb3AsIHRvcFBvc2l0aW9uc0FycmF5LCAwKTsKICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChzdGFydENhcnRvZ3JhcGhpYy5sYXRpdHVkZSk7CiAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKTsKICAgICAgICBpbnRlcnBvbGF0ZVNlZ21lbnQoCiAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgIG5leHRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBub3JtYWxzQXJyYXksCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5CiAgICAgICAgKTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgY2FydG9ncmFwaGljc0xlbmd0aCAtIDE7ICsraSkgewogICAgICAgICAgcHJldmlvdXNCb3R0b20gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUodmVydGV4Qm90dG9tLCBwcmV2aW91c0JvdHRvbSk7CiAgICAgICAgICB2ZXJ0ZXhCb3R0b20gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobmV4dEJvdHRvbSwgdmVydGV4Qm90dG9tKTsKICAgICAgICAgIGNvbnN0IHZlcnRleENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbaV07CiAgICAgICAgICBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIHZlcnRleENhcnRvZ3JhcGhpYywgbWF4SGVpZ2h0LCB2ZXJ0ZXhUb3ApOwogICAgICAgICAgZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBjYXJ0b2dyYXBoaWNzW2kgKyAxXSwgbWluSGVpZ2h0LCBuZXh0Qm90dG9tKTsKICAgICAgICAgIGNvbXB1dGVWZXJ0ZXhNaXRlck5vcm1hbCgKICAgICAgICAgICAgcHJldmlvdXNCb3R0b20sCiAgICAgICAgICAgIHZlcnRleEJvdHRvbSwKICAgICAgICAgICAgdmVydGV4VG9wLAogICAgICAgICAgICBuZXh0Qm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgICBpbmRleCA9IG5vcm1hbHNBcnJheS5sZW5ndGg7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhOb3JtYWwsIG5vcm1hbHNBcnJheSwgaW5kZXgpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4Qm90dG9tLCBib3R0b21Qb3NpdGlvbnNBcnJheSwgaW5kZXgpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4VG9wLCB0b3BQb3NpdGlvbnNBcnJheSwgaW5kZXgpOwogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2godmVydGV4Q2FydG9ncmFwaGljLmxhdGl0dWRlKTsKICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKHZlcnRleENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpOwogICAgICAgICAgaW50ZXJwb2xhdGVTZWdtZW50KAogICAgICAgICAgICBjYXJ0b2dyYXBoaWNzW2ldLAogICAgICAgICAgICBjYXJ0b2dyYXBoaWNzW2kgKyAxXSwKICAgICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIG5vcm1hbHNBcnJheSwKICAgICAgICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgICAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVuZENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbY2FydG9ncmFwaGljc0xlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IHByZUVuZENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbY2FydG9ncmFwaGljc0xlbmd0aCAtIDJdOwogICAgICAgIHZlcnRleEJvdHRvbSA9IGdldFBvc2l0aW9uKAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgdmVydGV4Qm90dG9tCiAgICAgICAgKTsKICAgICAgICB2ZXJ0ZXhUb3AgPSBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIGVuZENhcnRvZ3JhcGhpYywgbWF4SGVpZ2h0LCB2ZXJ0ZXhUb3ApOwogICAgICAgIGlmIChsb29wKSB7CiAgICAgICAgICBjb25zdCBwb3N0RW5kQ2FydG9ncmFwaGljID0gY2FydG9ncmFwaGljc1swXTsKICAgICAgICAgIHByZXZpb3VzQm90dG9tID0gZ2V0UG9zaXRpb24oCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcHJlRW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICAgIHByZXZpb3VzQm90dG9tCiAgICAgICAgICApOwogICAgICAgICAgbmV4dEJvdHRvbSA9IGdldFBvc2l0aW9uKAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc3RFbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG1pbkhlaWdodCwKICAgICAgICAgICAgbmV4dEJvdHRvbQogICAgICAgICAgKTsKICAgICAgICAgIHZlcnRleE5vcm1hbCA9IGNvbXB1dGVWZXJ0ZXhNaXRlck5vcm1hbCgKICAgICAgICAgICAgcHJldmlvdXNCb3R0b20sCiAgICAgICAgICAgIHZlcnRleEJvdHRvbSwKICAgICAgICAgICAgdmVydGV4VG9wLAogICAgICAgICAgICBuZXh0Qm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZlcnRleE5vcm1hbCA9IGNvbXB1dGVSaWdodE5vcm1hbCgKICAgICAgICAgICAgcHJlRW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgICBlbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gbm9ybWFsc0FycmF5Lmxlbmd0aDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhOb3JtYWwsIG5vcm1hbHNBcnJheSwgaW5kZXgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleEJvdHRvbSwgYm90dG9tUG9zaXRpb25zQXJyYXksIGluZGV4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhUb3AsIHRvcFBvc2l0aW9uc0FycmF5LCBpbmRleCk7CiAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goZW5kQ2FydG9ncmFwaGljLmxhdGl0dWRlKTsKICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChlbmRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKTsKICAgICAgICBpZiAobG9vcCkgewogICAgICAgICAgaW50ZXJwb2xhdGVTZWdtZW50KAogICAgICAgICAgICBlbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgbm9ybWFsc0FycmF5LAogICAgICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICAgICAgdG9wUG9zaXRpb25zQXJyYXksCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheQogICAgICAgICAgKTsKICAgICAgICAgIGluZGV4ID0gbm9ybWFsc0FycmF5Lmxlbmd0aDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCAzOyArK2kpIHsKICAgICAgICAgICAgbm9ybWFsc0FycmF5W2luZGV4ICsgaV0gPSBub3JtYWxzQXJyYXlbaV07CiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5W2luZGV4ICsgaV0gPSBib3R0b21Qb3NpdGlvbnNBcnJheVtpXTsKICAgICAgICAgICAgdG9wUG9zaXRpb25zQXJyYXlbaW5kZXggKyBpXSA9IHRvcFBvc2l0aW9uc0FycmF5W2ldOwogICAgICAgICAgfQogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goc3RhcnRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUpOwogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlbmVyYXRlR2VvbWV0cnlBdHRyaWJ1dGVzKAogICAgICAgICAgbG9vcCwKICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAgICAgbm9ybWFsc0FycmF5LAogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LAogICAgICAgICAgY29tcHV0ZTJkQXR0cmlidXRlcwogICAgICAgICk7CiAgICAgIH07CiAgICAgIGxpbmVEaXJlY3Rpb25TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXRyaXgzU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgcXVhdGVybmlvblNjcmF0Y2gzID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBlbmRQb3NDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIG5vcm1hbFN0YXJ0cG9pbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3JtYWxFbmRwb2ludFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGFkanVzdEhlaWdodE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGFkanVzdEhlaWdodE9mZnNldFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG51ZGdlRGlyZWN0aW9uU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3RhcnRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGVuZENhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudFN0YXJ0VG9wU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudEVuZFRvcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRTdGFydEJvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRFbmRCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50U3RhcnROb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50RW5kTm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZ2V0SGVpZ2h0Q2FydG9ncmFwaGljcyA9IFsKICAgICAgICBzdGFydENhcnRvZ3JhcGhpY1NjcmF0Y2gsCiAgICAgICAgZW5kQ2FydG9ncmFwaGljU2NyYXRjaAogICAgICBdOwogICAgICBnZXRIZWlnaHRSZWN0YW5nbGVTY3JhdGNoID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIGFkanVzdEhlaWdodFN0YXJ0VG9wU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYWRqdXN0SGVpZ2h0RW5kVG9wU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBhZGp1c3RIZWlnaHRFbmRCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50U3RhcnQyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRFbmQyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRTdGFydE5vcm1hbDJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudEVuZE5vcm1hbDJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgb2Zmc2V0U2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN0YXJ0VXBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbmRVcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJpZ2h0U2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN0YXJ0UGxhbmVOb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbmRQbGFuZU5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVuY29kZVNjcmF0Y2ggPSBuZXcgRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbmNvZGVTY3JhdGNoMkQgPSBuZXcgRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmb3J3YXJkT2Zmc2V0MkRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICByaWdodDJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbm9ybWFsTnVkZ2VTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQm91bmRpbmdTcGhlcmVzID0gW25ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCksIG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCldOwogICAgICBSRUZFUkVOQ0VfSU5ESUNFUyA9IFsKICAgICAgICAwLAogICAgICAgIDIsCiAgICAgICAgMSwKICAgICAgICAwLAogICAgICAgIDMsCiAgICAgICAgMiwKICAgICAgICAvLyByaWdodAogICAgICAgIDAsCiAgICAgICAgNywKICAgICAgICAzLAogICAgICAgIDAsCiAgICAgICAgNCwKICAgICAgICA3LAogICAgICAgIC8vIHN0YXJ0CiAgICAgICAgMCwKICAgICAgICA1LAogICAgICAgIDQsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDUsCiAgICAgICAgLy8gYm90dG9tCiAgICAgICAgNSwKICAgICAgICA3LAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICA2LAogICAgICAgIDcsCiAgICAgICAgLy8gbGVmdAogICAgICAgIDUsCiAgICAgICAgMiwKICAgICAgICA2LAogICAgICAgIDUsCiAgICAgICAgMSwKICAgICAgICAyLAogICAgICAgIC8vIGVuZAogICAgICAgIDMsCiAgICAgICAgNiwKICAgICAgICAyLAogICAgICAgIDMsCiAgICAgICAgNywKICAgICAgICA2CiAgICAgICAgLy8gdG9wCiAgICAgIF07CiAgICAgIFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSCA9IFJFRkVSRU5DRV9JTkRJQ0VTLmxlbmd0aDsKICAgICAgR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fcHJvamVjdE5vcm1hbCA9IHByb2plY3ROb3JtYWw7CiAgICAgIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IEdyb3VuZFBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeShncm91bmRQb2x5bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIHJldHVybiBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzX2RlZmF1bHQuaW5pdGlhbGl6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICAgIGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkgPSBHcm91bmRQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgZ3JvdW5kUG9seWxpbmVHZW9tZXRyeSwKICAgICAgICAgIG9mZnNldAogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShncm91bmRQb2x5bGluZUdlb21ldHJ5KTsKICAgIH0pOwogIH0KICB2YXIgY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FwcHJveGltYXRlVGVycmFpbkhlaWdodHMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfR3JvdW5kUG9seWxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGxhbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFBsYW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSB2ZXJ0ZXhGb3JtYXQ7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBsYW5lR2VvbWV0cnkiOwogIH0KICB2YXIgc2NyYXRjaFZlcnRleEZvcm1hdDgsIHNjcmF0Y2hPcHRpb25zMTUsIG1pbiwgbWF4LCBQbGFuZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUGxhbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGxhbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBQbGFuZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgUGxhbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ4ID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTUgPSB7CiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0OAogICAgICB9OwogICAgICBQbGFuZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0OAogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBQbGFuZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTUpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIG1pbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoLTAuNSwgLTAuNSwgMCk7CiAgICAgIG1heCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMC41LCAwLjUsIDApOwogICAgICBQbGFuZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocGxhbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHBsYW5lR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgbGV0IGluZGljZXM7CiAgICAgICAgbGV0IHBvc2l0aW9uczsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgICAgICBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDQgKiAzKTsKICAgICAgICAgIHBvc2l0aW9uc1swXSA9IG1pbi54OwogICAgICAgICAgcG9zaXRpb25zWzFdID0gbWluLnk7CiAgICAgICAgICBwb3NpdGlvbnNbMl0gPSAwOwogICAgICAgICAgcG9zaXRpb25zWzNdID0gbWF4Lng7CiAgICAgICAgICBwb3NpdGlvbnNbNF0gPSBtaW4ueTsKICAgICAgICAgIHBvc2l0aW9uc1s1XSA9IDA7CiAgICAgICAgICBwb3NpdGlvbnNbNl0gPSBtYXgueDsKICAgICAgICAgIHBvc2l0aW9uc1s3XSA9IG1heC55OwogICAgICAgICAgcG9zaXRpb25zWzhdID0gMDsKICAgICAgICAgIHBvc2l0aW9uc1s5XSA9IG1pbi54OwogICAgICAgICAgcG9zaXRpb25zWzEwXSA9IG1heC55OwogICAgICAgICAgcG9zaXRpb25zWzExXSA9IDA7CiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KDQgKiAzKTsKICAgICAgICAgICAgbm9ybWFsc1swXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzJdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1szXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzVdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s2XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbN10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzhdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s5XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTBdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxMV0gPSAxOwogICAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgICAgY29uc3QgdGV4Q29vcmRzID0gbmV3IEZsb2F0MzJBcnJheSg0ICogMik7CiAgICAgICAgICAgIHRleENvb3Jkc1swXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s1XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s3XSA9IDE7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgICB2YWx1ZXM6IHRleENvb3JkcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICBjb25zdCB0YW5nZW50cyA9IG5ldyBGbG9hdDMyQXJyYXkoNCAqIDMpOwogICAgICAgICAgICB0YW5nZW50c1swXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzRdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s2XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbOF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s5XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzEwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzExXSA9IDA7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gbmV3IEZsb2F0MzJBcnJheSg0ICogMyk7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzFdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1syXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbM10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzRdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzddID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s4XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbOV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzEwXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTFdID0gMDsKICAgICAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDIgKiAzKTsKICAgICAgICAgIGluZGljZXNbMF0gPSAwOwogICAgICAgICAgaW5kaWNlc1sxXSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzJdID0gMjsKICAgICAgICAgIGluZGljZXNbM10gPSAwOwogICAgICAgICAgaW5kaWNlc1s0XSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzVdID0gMzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgTWF0aC5zcXJ0KDIpKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBQbGFuZUdlb21ldHJ5X2RlZmF1bHQgPSBQbGFuZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUGxhbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQbGFuZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVQbGFuZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVBsYW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBsYW5lR2VvbWV0cnkocGxhbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcGxhbmVHZW9tZXRyeSA9IFBsYW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socGxhbmVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBQbGFuZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocGxhbmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVQbGFuZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlUGxhbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUGxhbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1BsYW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlUGxhbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUGxhbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BsYW5lT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gUGxhbmVPdXRsaW5lR2VvbWV0cnkoKSB7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIG1pbjIsIG1heDIsIFBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUGxhbmVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BsYW5lT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIFBsYW5lT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IDA7CiAgICAgIFBsYW5lT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXkpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBQbGFuZU91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBsYW5lT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIG1pbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KC0wLjUsIC0wLjUsIDApOwogICAgICBtYXgyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgwLjUsIDAuNSwgMCk7CiAgICAgIFBsYW5lT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoNCAqIDIpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoNCAqIDMpOwogICAgICAgIHBvc2l0aW9uc1swXSA9IG1pbjIueDsKICAgICAgICBwb3NpdGlvbnNbMV0gPSBtaW4yLnk7CiAgICAgICAgcG9zaXRpb25zWzJdID0gbWluMi56OwogICAgICAgIHBvc2l0aW9uc1szXSA9IG1heDIueDsKICAgICAgICBwb3NpdGlvbnNbNF0gPSBtaW4yLnk7CiAgICAgICAgcG9zaXRpb25zWzVdID0gbWluMi56OwogICAgICAgIHBvc2l0aW9uc1s2XSA9IG1heDIueDsKICAgICAgICBwb3NpdGlvbnNbN10gPSBtYXgyLnk7CiAgICAgICAgcG9zaXRpb25zWzhdID0gbWluMi56OwogICAgICAgIHBvc2l0aW9uc1s5XSA9IG1pbjIueDsKICAgICAgICBwb3NpdGlvbnNbMTBdID0gbWF4Mi55OwogICAgICAgIHBvc2l0aW9uc1sxMV0gPSBtaW4yLno7CiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgIH0pOwogICAgICAgIGluZGljZXNbMF0gPSAwOwogICAgICAgIGluZGljZXNbMV0gPSAxOwogICAgICAgIGluZGljZXNbMl0gPSAxOwogICAgICAgIGluZGljZXNbM10gPSAyOwogICAgICAgIGluZGljZXNbNF0gPSAyOwogICAgICAgIGluZGljZXNbNV0gPSAzOwogICAgICAgIGluZGljZXNbNl0gPSAzOwogICAgICAgIGluZGljZXNbN10gPSAwOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgTWF0aC5zcXJ0KDIpKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUGxhbmVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5KHBsYW5lR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBsYW5lR2VvbWV0cnkgPSBQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhwbGFuZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIFBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocGxhbmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1BsYW5lT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1N0ZXJlb2dyYXBoaWMuanMKICBmdW5jdGlvbiBTdGVyZW9ncmFwaGljKHBvc2l0aW9uLCB0YW5nZW50UGxhbmUpIHsKICAgIHRoaXMucG9zaXRpb24gPSBwb3NpdGlvbjsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMucG9zaXRpb24pKSB7CiAgICAgIHRoaXMucG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICB9CiAgICB0aGlzLnRhbmdlbnRQbGFuZSA9IHRhbmdlbnRQbGFuZTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMudGFuZ2VudFBsYW5lKSkgewogICAgICB0aGlzLnRhbmdlbnRQbGFuZSA9IFN0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRV9UQU5HRU5UX1BMQU5FOwogICAgfQogIH0KICB2YXIgc2NyYXRjaENhcnRvZ3JhcGhpYzUsIHNjcmF0Y2hDYXJ0ZXNpYW4xMCwgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheTIsIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXlEaXJlY3Rpb24sIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zMiwgU3RlcmVvZ3JhcGhpY19kZWZhdWx0OwogIHZhciBpbml0X1N0ZXJlb2dyYXBoaWMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1N0ZXJlb2dyYXBoaWMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkVGFuZ2VudFBsYW5lKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0aW9uVGVzdHMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUmF5KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBTdGVyZW9ncmFwaGljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtFbGxpcHNvaWR9CiAgICAgICAgICovCiAgICAgICAgZWxsaXBzb2lkOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy50YW5nZW50UGxhbmUuZWxsaXBzb2lkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgeCBjb29yZGluYXRlCiAgICAgICAgICogQG1lbWJlcm9mIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICB4OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbi54OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgeSBjb29yZGluYXRlCiAgICAgICAgICogQG1lbWJlcm9mIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICB5OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbi55OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcHV0ZXMgdGhlIGNvbmZvcm1hbCBsYXRpdHVkZSwgb3IgdGhlIGVsbGlwc29pZGFsIGxhdGl0dWRlIHByb2plY3RlZCBvbnRvIGFuIGFyYml0cmFyeSBzcGhlcmUuCiAgICAgICAgICogQG1lbWJlcm9mIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICBjb25mb3JtYWxMYXRpdHVkZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjJfZGVmYXVsdC5tYWduaXR1ZGUodGhpcy5wb3NpdGlvbik7CiAgICAgICAgICAgIGNvbnN0IGQgPSAyICogdGhpcy5lbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgICAgICAgICAgY29uc3Qgc2lnbjMgPSB0aGlzLnRhbmdlbnRQbGFuZS5wbGFuZS5ub3JtYWwuejsKICAgICAgICAgICAgcmV0dXJuIHNpZ24zICogKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIDIgKiBNYXRoLmF0YW4yKHIsIGQpKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIENvbXB1dGVzIHRoZSBsb25naXR1ZGUKICAgICAgICAgKiBAbWVtYmVyb2YgU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxvbmdpdHVkZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbGV0IGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIE1hdGguYXRhbjIodGhpcy55LCB0aGlzLngpOwogICAgICAgICAgICBpZiAobG9uZ2l0dWRlID4gTWF0aC5QSSkgewogICAgICAgICAgICAgIGxvbmdpdHVkZSAtPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsb25naXR1ZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzUgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjEwID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBTdGVyZW9ncmFwaGljLnByb3RvdHlwZS5nZXRMYXRpdHVkZSA9IGZ1bmN0aW9uKGVsbGlwc29pZCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkpIHsKICAgICAgICAgIGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQ7CiAgICAgICAgfQogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM1LmxhdGl0dWRlID0gdGhpcy5jb25mb3JtYWxMYXRpdHVkZTsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNS5sb25naXR1ZGUgPSB0aGlzLmxvbmdpdHVkZTsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNS5oZWlnaHQgPSAwOwogICAgICAgIGNvbnN0IGNhcnRlc2lhbjExID0gdGhpcy5lbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMAogICAgICAgICk7CiAgICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGNhcnRlc2lhbjExLCBzY3JhdGNoQ2FydG9ncmFwaGljNSk7CiAgICAgICAgcmV0dXJuIHNjcmF0Y2hDYXJ0b2dyYXBoaWM1LmxhdGl0dWRlOwogICAgICB9OwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5MiA9IG5ldyBSYXlfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5RGlyZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMzIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFN0ZXJlb2dyYXBoaWMuZnJvbUNhcnRlc2lhbiA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBjb25zdCBzaWduMyA9IE1hdGhfZGVmYXVsdC5zaWduTm90WmVybyhjYXJ0ZXNpYW4xMS56KTsKICAgICAgICBsZXQgdGFuZ2VudFBsYW5lID0gU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFX1RBTkdFTlRfUExBTkU7CiAgICAgICAgbGV0IG9yaWdpbiA9IFN0ZXJlb2dyYXBoaWMuU09VVEhfUE9MRTsKICAgICAgICBpZiAoc2lnbjMgPCAwKSB7CiAgICAgICAgICB0YW5nZW50UGxhbmUgPSBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEVfVEFOR0VOVF9QTEFORTsKICAgICAgICAgIG9yaWdpbiA9IFN0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmF5ID0gc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheTI7CiAgICAgICAgcmF5Lm9yaWdpbiA9IHRhbmdlbnRQbGFuZS5lbGxpcHNvaWQuc2NhbGVUb0dlb2NlbnRyaWNTdXJmYWNlKAogICAgICAgICAgY2FydGVzaWFuMTEsCiAgICAgICAgICByYXkub3JpZ2luCiAgICAgICAgKTsKICAgICAgICByYXkuZGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgcmF5Lm9yaWdpbiwKICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXlEaXJlY3Rpb24KICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmF5LmRpcmVjdGlvbiwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgY29uc3QgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgcmF5LAogICAgICAgICAgdGFuZ2VudFBsYW5lLnBsYW5lLAogICAgICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMyCiAgICAgICAgKTsKICAgICAgICBjb25zdCB2MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChpbnRlcnNlY3Rpb25Qb2ludCwgb3JpZ2luLCBpbnRlcnNlY3Rpb25Qb2ludCk7CiAgICAgICAgY29uc3QgeCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodGFuZ2VudFBsYW5lLnhBeGlzLCB2Myk7CiAgICAgICAgY29uc3QgeSA9IHNpZ24zICogQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0YW5nZW50UGxhbmUueUF4aXMsIHYzKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFN0ZXJlb2dyYXBoaWMobmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4LCB5KSwgdGFuZ2VudFBsYW5lKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4LCB5KTsKICAgICAgICByZXN1bHQudGFuZ2VudFBsYW5lID0gdGFuZ2VudFBsYW5lOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFN0ZXJlb2dyYXBoaWMuZnJvbUNhcnRlc2lhbkFycmF5ID0gZnVuY3Rpb24oY2FydGVzaWFucywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY2FydGVzaWFucy5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlc3VsdFtpXSA9IFN0ZXJlb2dyYXBoaWMuZnJvbUNhcnRlc2lhbihjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBTdGVyZW9ncmFwaGljLmNsb25lID0gZnVuY3Rpb24oc3RlcmVvZ3JhcGhpYywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3RlcmVvZ3JhcGhpYykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgU3RlcmVvZ3JhcGhpYygKICAgICAgICAgICAgc3RlcmVvZ3JhcGhpYy5wb3NpdGlvbiwKICAgICAgICAgICAgc3RlcmVvZ3JhcGhpYy50YW5nZW50UGxhbmUKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wb3NpdGlvbiA9IHN0ZXJlb2dyYXBoaWMucG9zaXRpb247CiAgICAgICAgcmVzdWx0LnRhbmdlbnRQbGFuZSA9IHN0ZXJlb2dyYXBoaWMudGFuZ2VudFBsYW5lOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFN0ZXJlb2dyYXBoaWMuSEFMRl9VTklUX1NQSEVSRSA9IE9iamVjdC5mcmVlemUobmV3IEVsbGlwc29pZF9kZWZhdWx0KDAuNSwgMC41LCAwLjUpKTsKICAgICAgU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDAsIDAsIDAuNSkpOwogICAgICBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEUgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMCwgMCwgLTAuNSkpOwogICAgICBTdGVyZW9ncmFwaGljLk5PUlRIX1BPTEVfVEFOR0VOVF9QTEFORSA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFLAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5IQUxGX1VOSVRfU1BIRVJFCiAgICAgICAgKQogICAgICApOwogICAgICBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEVfVEFOR0VOVF9QTEFORSA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5TT1VUSF9QT0xFLAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5IQUxGX1VOSVRfU1BIRVJFCiAgICAgICAgKQogICAgICApOwogICAgICBTdGVyZW9ncmFwaGljX2RlZmF1bHQgPSBTdGVyZW9ncmFwaGljOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gYWRqdXN0UG9zSGVpZ2h0c0Zvck5vcm1hbChwb3NpdGlvbiwgcDEsIHAyLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGNhcnRvMTIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocG9zaXRpb24sIHNjcmF0Y2hDYXJ0bzEpOwogICAgY29uc3QgaGVpZ2h0ID0gY2FydG8xMi5oZWlnaHQ7CiAgICBjb25zdCBwMUNhcnRvID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBzY3JhdGNoQ2FydG8yKTsKICAgIHAxQ2FydG8uaGVpZ2h0ID0gaGVpZ2h0OwogICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHAxQ2FydG8sIHAxKTsKICAgIGNvbnN0IHAyQ2FydG8gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDIsIHNjcmF0Y2hDYXJ0bzIpOwogICAgcDJDYXJ0by5oZWlnaHQgPSBoZWlnaHQgLSAxMDA7CiAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4ocDJDYXJ0bywgcDIpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlQXR0cmlidXRlcyhvcHRpb25zKSB7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBvcHRpb25zLnZlcnRleEZvcm1hdDsKICAgIGNvbnN0IGdlb21ldHJ5ID0gb3B0aW9ucy5nZW9tZXRyeTsKICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IG9wdGlvbnMuc2hhZG93Vm9sdW1lOwogICAgY29uc3QgZmxhdFBvc2l0aW9ucyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgZmxhdFRleGNvb3JkcyA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0KSA/IGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3QudmFsdWVzIDogdm9pZCAwOwogICAgbGV0IGxlbmd0aCA9IGZsYXRQb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgd2FsbCA9IG9wdGlvbnMud2FsbDsKICAgIGNvbnN0IHRvcCA9IG9wdGlvbnMudG9wIHx8IHdhbGw7CiAgICBjb25zdCBib3R0b20gPSBvcHRpb25zLmJvdHRvbSB8fCB3YWxsOwogICAgaWYgKHZlcnRleEZvcm1hdC5zdCB8fCB2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgc2hhZG93Vm9sdW1lKSB7CiAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gb3B0aW9ucy5ib3VuZGluZ1JlY3RhbmdsZTsKICAgICAgY29uc3Qgcm90YXRpb25BeGlzID0gb3B0aW9ucy5yb3RhdGlvbkF4aXM7CiAgICAgIGNvbnN0IHByb2plY3RUbzJkID0gb3B0aW9ucy5wcm9qZWN0VG8yZDsKICAgICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBvcHRpb25zLnN0Um90YXRpb247CiAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodDsKICAgICAgY29uc3Qgb3JpZ2luID0gYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzT3JpZ2luOwogICAgICBvcmlnaW4ueCA9IGJvdW5kaW5nUmVjdGFuZ2xlLng7CiAgICAgIG9yaWdpbi55ID0gYm91bmRpbmdSZWN0YW5nbGUueTsKICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheSgyICogKGxlbmd0aCAvIDMpKSA6IHZvaWQgMDsKICAgICAgbGV0IG5vcm1hbHM7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0ICYmIHRvcCAmJiAhd2FsbCkgewogICAgICAgICAgbm9ybWFscyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgIGNvbnN0IGV4dHJ1ZGVOb3JtYWxzID0gc2hhZG93Vm9sdW1lID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICBsZXQgdGV4dHVyZUNvb3JkSW5kZXggPSAwOwogICAgICBsZXQgYXR0ckluZGV4ID0gMDsKICAgICAgbGV0IG5vcm1hbDIgPSBzY3JhdGNoTm9ybWFsNjsKICAgICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDQ7CiAgICAgIGxldCBiaXRhbmdlbnQgPSBzY3JhdGNoQml0YW5nZW50NDsKICAgICAgbGV0IHJlY29tcHV0ZU5vcm1hbCA9IHRydWU7CiAgICAgIGxldCB0ZXh0dXJlTWF0cml4ID0gYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4MzsKICAgICAgbGV0IHRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IHRhbmdlbnRNYXRyaXhTY3JhdGNoMjsKICAgICAgaWYgKHN0Um90YXRpb24gIT09IDApIHsKICAgICAgICBsZXQgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIHJvdGF0aW9uQXhpcywKICAgICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHJvdGF0aW9uLCB0ZXh0dXJlTWF0cml4KTsKICAgICAgICByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgcm90YXRpb25BeGlzLAogICAgICAgICAgLXN0Um90YXRpb24sCiAgICAgICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICB0YW5nZW50Um90YXRpb25NYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeAogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFksIHRleHR1cmVNYXRyaXgpOwogICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwKICAgICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeAogICAgICAgICk7CiAgICAgIH0KICAgICAgbGV0IGJvdHRvbU9mZnNldCA9IDA7CiAgICAgIGxldCBib3R0b21PZmZzZXQyID0gMDsKICAgICAgaWYgKHRvcCAmJiBib3R0b20pIHsKICAgICAgICBib3R0b21PZmZzZXQgPSBsZW5ndGggLyAyOwogICAgICAgIGJvdHRvbU9mZnNldDIgPSBsZW5ndGggLyAzOwogICAgICAgIGxlbmd0aCAvPSAyOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmbGF0UG9zaXRpb25zLAogICAgICAgICAgaSwKICAgICAgICAgIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjMKICAgICAgICApOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZsYXRUZXhjb29yZHMpKSB7CiAgICAgICAgICAgIGxldCBwID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICAgICAgdGV4dHVyZU1hdHJpeCwKICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICBzY3JhdGNoUG9zaXRpb24zCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHAgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwLCBwKTsKICAgICAgICAgICAgY29uc3Qgc3QgPSBwcm9qZWN0VG8yZChbcF0sIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjIpWzBdOwogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3Qoc3QsIG9yaWdpbiwgc3QpOwogICAgICAgICAgICBjb25zdCBzdHggPSBNYXRoX2RlZmF1bHQuY2xhbXAoc3QueCAvIGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoLCAwLCAxKTsKICAgICAgICAgICAgY29uc3Qgc3R5ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHN0LnkgLyBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQsIDAsIDEpOwogICAgICAgICAgICBpZiAoYm90dG9tKSB7CiAgICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4ICsgYm90dG9tT2Zmc2V0Ml0gPSBzdHg7CiAgICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4ICsgMSArIGJvdHRvbU9mZnNldDJdID0gc3R5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0b3ApIHsKICAgICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXhdID0gc3R4OwogICAgICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIDFdID0gc3R5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRleHR1cmVDb29yZEluZGV4ICs9IDI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICBjb25zdCBhdHRySW5kZXgxID0gYXR0ckluZGV4ICsgMTsKICAgICAgICAgIGNvbnN0IGF0dHJJbmRleDIgPSBhdHRySW5kZXggKyAyOwogICAgICAgICAgaWYgKHdhbGwpIHsKICAgICAgICAgICAgaWYgKGkgKyAzIDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgY29uc3QgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGZsYXRQb3NpdGlvbnMsIGkgKyAzLCBwMVNjcmF0Y2gzKTsKICAgICAgICAgICAgICBpZiAocmVjb21wdXRlTm9ybWFsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgICAgIGZsYXRQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICAgIGkgKyBsZW5ndGgsCiAgICAgICAgICAgICAgICAgIHAyU2NyYXRjaDMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgYWRqdXN0UG9zSGVpZ2h0c0Zvck5vcm1hbChwb3NpdGlvbiwgcDEsIHAyLCBlbGxpcHNvaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAxLCBwb3NpdGlvbiwgcDEpOwogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAyLCBwb3NpdGlvbiwgcDIpOwogICAgICAgICAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhwMiwgcDEsIG5vcm1hbDIpLAogICAgICAgICAgICAgICAgICBub3JtYWwyCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgcmVjb21wdXRlTm9ybWFsID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwMSwgcG9zaXRpb24sIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgIGJpdGFuZ2VudCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIGJpdGFuZ2VudCk7CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGJpdGFuZ2VudCwgbm9ybWFsMiwgdGFuZ2VudCksCiAgICAgICAgICAgICAgICAgIHRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICAgICAgbm9ybWFscywKICAgICAgICAgICAgICAgICAgYXR0ckluZGV4LAogICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zTm9ybWFsCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NOb3JtYWwsCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NUYW5nZW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICAgICAgICAgICAgICB0YW5nZW50Um90YXRpb25NYXRyaXgsCiAgICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQsCiAgICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQKICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zQml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zTm9ybWFsLAogICAgICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQsCiAgICAgICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zQml0YW5nZW50CiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zQml0YW5nZW50CiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgbm9ybWFsMiwgdGFuZ2VudCk7CiAgICAgICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0YW5nZW50Um90YXRpb25NYXRyaXgsIHRhbmdlbnQsIHRhbmdlbnQpLAogICAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICBpZiAob3B0aW9ucy53YWxsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXggKyBib3R0b21PZmZzZXRdID0gbm9ybWFsMi54OwogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4MSArIGJvdHRvbU9mZnNldF0gPSBub3JtYWwyLnk7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgyICsgYm90dG9tT2Zmc2V0XSA9IG5vcm1hbDIuejsKICAgICAgICAgICAgfSBlbHNlIGlmIChib3R0b20pIHsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleCArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi54OwogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4MSArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4MiArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0b3AgJiYgIXBlclBvc2l0aW9uSGVpZ2h0IHx8IHdhbGwpIHsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleF0gPSBub3JtYWwyLng7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgxXSA9IG5vcm1hbDIueTsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDJdID0gbm9ybWFsMi56OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICAgIGlmICh3YWxsKSB7CiAgICAgICAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2F0dHJJbmRleCArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi54OwogICAgICAgICAgICBleHRydWRlTm9ybWFsc1thdHRySW5kZXgxICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLnk7CiAgICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2F0dHJJbmRleDIgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIuejsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICBpZiAob3B0aW9ucy53YWxsKSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4ICsgYm90dG9tT2Zmc2V0XSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgxICsgYm90dG9tT2Zmc2V0XSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgyICsgYm90dG9tT2Zmc2V0XSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgfSBlbHNlIGlmIChib3R0b20pIHsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXggKyBib3R0b21PZmZzZXRdID0gLXRhbmdlbnQueDsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgxICsgYm90dG9tT2Zmc2V0XSA9IC10YW5nZW50Lnk7CiAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MiArIGJvdHRvbU9mZnNldF0gPSAtdGFuZ2VudC56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0b3ApIHsKICAgICAgICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleF0gPSBzY3JhdGNoUGVyUG9zVGFuZ2VudC54OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MV0gPSBzY3JhdGNoUGVyUG9zVGFuZ2VudC55OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4Ml0gPSBzY3JhdGNoUGVyUG9zVGFuZ2VudC56OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXhdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MV0gPSB0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgyXSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGlmIChib3R0b20pIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleCArIGJvdHRvbU9mZnNldF0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDEgKyBib3R0b21PZmZzZXRdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgyICsgYm90dG9tT2Zmc2V0XSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0b3ApIHsKICAgICAgICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4XSA9IHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQueDsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4MV0gPSBzY3JhdGNoUGVyUG9zQml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDJdID0gc2NyYXRjaFBlclBvc0JpdGFuZ2VudC56OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleF0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4MV0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4Ml0gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGF0dHJJbmRleCArPSAzOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0ICYmICFkZWZpbmVkX2RlZmF1bHQoZmxhdFRleGNvb3JkcykpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgdmFsdWVzOiB0ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBleHRydWRlTm9ybWFscwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICBpZiAob3B0aW9ucy5leHRydWRlICYmIGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgY29uc3Qgc2l6ZSA9IGZsYXRQb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgICAgbGV0IG9mZnNldEF0dHJpYnV0ZSA9IG5ldyBVaW50OEFycmF5KHNpemUpOwogICAgICBpZiAob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgaWYgKHRvcCAmJiBib3R0b20gfHwgd2FsbCkgewogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwoMSwgMCwgc2l6ZSAvIDIpOwogICAgICAgIH0gZWxzZSBpZiAodG9wKSB7CiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogb2Zmc2V0QXR0cmlidXRlCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZChlbGxpcHNvaWQsIHBvbHlnb24yLCB0ZXh0dXJlQ29vcmRpbmF0ZXMsIGdyYW51bGFyaXR5LCBoaWVyYXJjaHksIHBlclBvc2l0aW9uSGVpZ2h0LCBjbG9zZVRvcCwgY2xvc2VCb3R0b20sIHZlcnRleEZvcm1hdCwgYXJjVHlwZSkgewogICAgY29uc3QgZ2VvcyA9IHsKICAgICAgd2FsbHM6IFtdCiAgICB9OwogICAgbGV0IGk7CiAgICBpZiAoY2xvc2VUb3AgfHwgY2xvc2VCb3R0b20pIHsKICAgICAgY29uc3QgdG9wR2VvID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9ucygKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgcG9seWdvbjIsCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICBhcmNUeXBlCiAgICAgICk7CiAgICAgIGNvbnN0IGVkZ2VQb2ludHMgPSB0b3BHZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICAgIGNvbnN0IGluZGljZXMgPSB0b3BHZW8uaW5kaWNlczsKICAgICAgbGV0IG51bVBvc2l0aW9uczsKICAgICAgbGV0IG5ld0luZGljZXM7CiAgICAgIGlmIChjbG9zZVRvcCAmJiBjbG9zZUJvdHRvbSkgewogICAgICAgIGNvbnN0IHRvcEJvdHRvbVBvc2l0aW9ucyA9IGVkZ2VQb2ludHMuY29uY2F0KGVkZ2VQb2ludHMpOwogICAgICAgIG51bVBvc2l0aW9ucyA9IHRvcEJvdHRvbVBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgICAgIG5ld0luZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIG51bVBvc2l0aW9ucywKICAgICAgICAgIGluZGljZXMubGVuZ3RoICogMgogICAgICAgICk7CiAgICAgICAgbmV3SW5kaWNlcy5zZXQoaW5kaWNlcyk7CiAgICAgICAgY29uc3QgaWxlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IG51bVBvc2l0aW9ucyAvIDI7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlsZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgY29uc3QgaTAgPSBuZXdJbmRpY2VzW2ldICsgbGVuZ3RoOwogICAgICAgICAgY29uc3QgaTEgPSBuZXdJbmRpY2VzW2kgKyAxXSArIGxlbmd0aDsKICAgICAgICAgIGNvbnN0IGkyID0gbmV3SW5kaWNlc1tpICsgMl0gKyBsZW5ndGg7CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyBpbGVuZ3RoXSA9IGkyOwogICAgICAgICAgbmV3SW5kaWNlc1tpICsgMSArIGlsZW5ndGhdID0gaTE7CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyAyICsgaWxlbmd0aF0gPSBpMDsKICAgICAgICB9CiAgICAgICAgdG9wR2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gdG9wQm90dG9tUG9zaXRpb25zOwogICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCAmJiB2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBjb25zdCBub3JtYWxzID0gdG9wR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgICAgIHRvcEdlby5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KAogICAgICAgICAgICB0b3BCb3R0b21Qb3NpdGlvbnMubGVuZ3RoCiAgICAgICAgICApOwogICAgICAgICAgdG9wR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlcy5zZXQobm9ybWFscyk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QgJiYgZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIGNvbnN0IHRleGNvb3JkcyA9IHRvcEdlby5hdHRyaWJ1dGVzLnN0LnZhbHVlczsKICAgICAgICAgIHRvcEdlby5hdHRyaWJ1dGVzLnN0LnZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkobnVtUG9zaXRpb25zICogMik7CiAgICAgICAgICB0b3BHZW8uYXR0cmlidXRlcy5zdC52YWx1ZXMgPSB0ZXhjb29yZHMuY29uY2F0KHRleGNvb3Jkcyk7CiAgICAgICAgfQogICAgICAgIHRvcEdlby5pbmRpY2VzID0gbmV3SW5kaWNlczsKICAgICAgfSBlbHNlIGlmIChjbG9zZUJvdHRvbSkgewogICAgICAgIG51bVBvc2l0aW9ucyA9IGVkZ2VQb2ludHMubGVuZ3RoIC8gMzsKICAgICAgICBuZXdJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtUG9zaXRpb25zLCBpbmRpY2VzLmxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGluZGljZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIG5ld0luZGljZXNbaV0gPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgICAgIG5ld0luZGljZXNbaSArIDFdID0gaW5kaWNlc1tpICsgMV07CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyAyXSA9IGluZGljZXNbaV07CiAgICAgICAgfQogICAgICAgIHRvcEdlby5pbmRpY2VzID0gbmV3SW5kaWNlczsKICAgICAgfQogICAgICBnZW9zLnRvcEFuZEJvdHRvbSA9IG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB0b3BHZW8KICAgICAgfSk7CiAgICB9CiAgICBsZXQgb3V0ZXJSaW5nID0gaGllcmFyY2h5Lm91dGVyUmluZzsKICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMob3V0ZXJSaW5nLCBlbGxpcHNvaWQpOwogICAgbGV0IHBvc2l0aW9uczJEID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUoCiAgICAgIG91dGVyUmluZywKICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zRXh0cnVkZWRQb3NpdGlvbnMKICAgICk7CiAgICBsZXQgd2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKHBvc2l0aW9uczJEKTsKICAgIGlmICh3aW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICBvdXRlclJpbmcgPSBvdXRlclJpbmcuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICB9CiAgICBsZXQgd2FsbEdlbyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlV2FsbEdlb21ldHJ5KAogICAgICBvdXRlclJpbmcsCiAgICAgIHRleHR1cmVDb29yZGluYXRlcywKICAgICAgZWxsaXBzb2lkLAogICAgICBncmFudWxhcml0eSwKICAgICAgcGVyUG9zaXRpb25IZWlnaHQsCiAgICAgIGFyY1R5cGUKICAgICk7CiAgICBnZW9zLndhbGxzLnB1c2goCiAgICAgIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB3YWxsR2VvCiAgICAgIH0pCiAgICApOwogICAgY29uc3QgaG9sZXMgPSBoaWVyYXJjaHkuaG9sZXM7CiAgICBmb3IgKGkgPSAwOyBpIDwgaG9sZXMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IGhvbGUgPSBob2xlc1tpXTsKICAgICAgcG9zaXRpb25zMkQgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50c09udG9QbGFuZSgKICAgICAgICBob2xlLAogICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkUG9zaXRpb25zCiAgICAgICk7CiAgICAgIHdpbmRpbmdPcmRlciA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRChwb3NpdGlvbnMyRCk7CiAgICAgIGlmICh3aW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNPVU5URVJfQ0xPQ0tXSVNFKSB7CiAgICAgICAgaG9sZSA9IGhvbGUuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICAgIH0KICAgICAgd2FsbEdlbyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlV2FsbEdlb21ldHJ5KAogICAgICAgIGhvbGUsCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBncmFudWxhcml0eSwKICAgICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICBhcmNUeXBlCiAgICAgICk7CiAgICAgIGdlb3Mud2FsbHMucHVzaCgKICAgICAgICBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICAgIGdlb21ldHJ5OiB3YWxsR2VvCiAgICAgICAgfSkKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBnZW9zOwogIH0KICBmdW5jdGlvbiBQb2x5Z29uR2VvbWV0cnkob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSIsIG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQpICYmIG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQgJiYgZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0KSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiQ2Fubm90IHVzZSBib3RoIG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQgYW5kIG9wdGlvbnMuaGVpZ2h0IgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUpICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJJbnZhbGlkIGFyY1R5cGUuIFZhbGlkIG9wdGlvbnMgYXJlIEFyY1R5cGUuR0VPREVTSUMgYW5kIEFyY1R5cGUuUkhVTUIuIgogICAgICApOwogICAgfQogICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeTsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KTsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCBzdFJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdFJvdGF0aW9uLCAwKTsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IG9wdGlvbnMudGV4dHVyZUNvb3JkaW5hdGVzOwogICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnBlclBvc2l0aW9uSGVpZ2h0LCBmYWxzZSk7CiAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPSBwZXJQb3NpdGlvbkhlaWdodCAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCk7CiAgICBsZXQgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgbGV0IGV4dHJ1ZGVkSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlKSB7CiAgICAgIGNvbnN0IGggPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgICAgZXh0cnVkZWRIZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgICAgaGVpZ2h0ID0gaDsKICAgIH0KICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX3N0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgdGhpcy5faGVpZ2h0ID0gaGVpZ2h0OwogICAgdGhpcy5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgIHRoaXMuX2Nsb3NlVG9wID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jbG9zZVRvcCwgdHJ1ZSk7CiAgICB0aGlzLl9jbG9zZUJvdHRvbSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY2xvc2VCb3R0b20sIHRydWUpOwogICAgdGhpcy5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICB0aGlzLl9wZXJQb3NpdGlvbkhlaWdodCA9IHBlclBvc2l0aW9uSGVpZ2h0OwogICAgdGhpcy5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlOwogICAgdGhpcy5fc2hhZG93Vm9sdW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zaGFkb3dWb2x1bWUsIGZhbHNlKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUG9seWdvbkdlb21ldHJ5IjsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fYXJjVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSwgQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKTsKICAgIHRoaXMuX3JlY3RhbmdsZSA9IHZvaWQgMDsKICAgIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMgPSB2b2lkIDA7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoKAogICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICkgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAodGV4dHVyZUNvb3JkaW5hdGVzID8gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVIaWVyYXJjaHlQYWNrZWRMZW5ndGgoCiAgICAgIHRleHR1cmVDb29yZGluYXRlcywKICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICApIDogMSkgKyAxMjsKICB9CiAgZnVuY3Rpb24gZXhwYW5kUmVjdGFuZ2xlKHBvbGFyLCBsYXN0UG9sYXIsIGVsbGlwc29pZCwgYXJjVHlwZSwgcG9seWdvbjIsIHJlc3VsdCkgewogICAgY29uc3QgbG9uZ2l0dWRlID0gcG9sYXIubG9uZ2l0dWRlOwogICAgY29uc3QgbG9uQWRqdXN0ZWQgPSBsb25naXR1ZGUgPj0gMCA/IGxvbmdpdHVkZSA6IGxvbmdpdHVkZSArIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICBwb2x5Z29uMi53ZXN0T3ZlcklkbCA9IE1hdGgubWluKHBvbHlnb24yLndlc3RPdmVySWRsLCBsb25BZGp1c3RlZCk7CiAgICBwb2x5Z29uMi5lYXN0T3ZlcklkbCA9IE1hdGgubWF4KHBvbHlnb24yLmVhc3RPdmVySWRsLCBsb25BZGp1c3RlZCk7CiAgICByZXN1bHQud2VzdCA9IE1hdGgubWluKHJlc3VsdC53ZXN0LCBsb25naXR1ZGUpOwogICAgcmVzdWx0LmVhc3QgPSBNYXRoLm1heChyZXN1bHQuZWFzdCwgbG9uZ2l0dWRlKTsKICAgIGNvbnN0IGxhdGl0dWRlID0gcG9sYXIuZ2V0TGF0aXR1ZGUoZWxsaXBzb2lkKTsKICAgIGxldCBzZWdtZW50TGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgIHJlc3VsdC5zb3V0aCA9IE1hdGgubWluKHJlc3VsdC5zb3V0aCwgbGF0aXR1ZGUpOwogICAgcmVzdWx0Lm5vcnRoID0gTWF0aC5tYXgocmVzdWx0Lm5vcnRoLCBsYXRpdHVkZSk7CiAgICBpZiAoYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIGNvbnN0IHNlZ21lbnQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgbGFzdFBvbGFyLnBvc2l0aW9uLAogICAgICAgIHBvbGFyLnBvc2l0aW9uLAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4wMgogICAgICApOwogICAgICBjb25zdCB0ID0gQ2FydGVzaWFuMl9kZWZhdWx0LmRvdChsYXN0UG9sYXIucG9zaXRpb24sIHNlZ21lbnQpIC8gQ2FydGVzaWFuMl9kZWZhdWx0LmRvdChzZWdtZW50LCBzZWdtZW50KTsKICAgICAgaWYgKHQgPiAwICYmIHQgPCAxKSB7CiAgICAgICAgY29uc3QgcHJvamVjdGVkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCgKICAgICAgICAgIGxhc3RQb2xhci5wb3NpdGlvbiwKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHNlZ21lbnQsIC10LCBzZWdtZW50KSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xOAogICAgICAgICk7CiAgICAgICAgY29uc3QgY2xvc2VzdFBvbGFyID0gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmNsb25lKGxhc3RQb2xhciwgc2NyYXRjaFBvbGFyQ2xvc2VzdCk7CiAgICAgICAgY2xvc2VzdFBvbGFyLnBvc2l0aW9uID0gcHJvamVjdGVkOwogICAgICAgIGNvbnN0IGFkanVzdGVkTGF0aXR1ZGUgPSBjbG9zZXN0UG9sYXIuZ2V0TGF0aXR1ZGUoZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuc291dGggPSBNYXRoLm1pbihyZXN1bHQuc291dGgsIGFkanVzdGVkTGF0aXR1ZGUpOwogICAgICAgIHJlc3VsdC5ub3J0aCA9IE1hdGgubWF4KHJlc3VsdC5ub3J0aCwgYWRqdXN0ZWRMYXRpdHVkZSk7CiAgICAgICAgaWYgKE1hdGguYWJzKGxhdGl0dWRlKSA+IE1hdGguYWJzKGFkanVzdGVkTGF0aXR1ZGUpKSB7CiAgICAgICAgICBzZWdtZW50TGF0aXR1ZGUgPSBhZGp1c3RlZExhdGl0dWRlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgY29uc3QgZGlyZWN0aW9uMiA9IGxhc3RQb2xhci54ICogcG9sYXIueSAtIHBvbGFyLnggKiBsYXN0UG9sYXIueTsKICAgIGxldCBhbmdsZSA9IE1hdGguc2lnbihkaXJlY3Rpb24yKTsKICAgIGlmIChhbmdsZSAhPT0gMCkgewogICAgICBhbmdsZSAqPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYW5nbGVCZXR3ZWVuKGxhc3RQb2xhci5wb3NpdGlvbiwgcG9sYXIucG9zaXRpb24pOwogICAgfQogICAgaWYgKHNlZ21lbnRMYXRpdHVkZSA+PSAwKSB7CiAgICAgIHBvbHlnb24yLm5vcnRoQW5nbGUgKz0gYW5nbGU7CiAgICB9CiAgICBpZiAoc2VnbWVudExhdGl0dWRlIDw9IDApIHsKICAgICAgcG9seWdvbjIuc291dGhBbmdsZSArPSBhbmdsZTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0VGFuZ2VudFBsYW5lKHJlY3RhbmdsZSwgcG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgIGlmIChyZWN0YW5nbGUuaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5QSSB8fCByZWN0YW5nbGUud2lkdGggPj0gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgIGNvbnN0IHBvbGFyID0gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4oCiAgICAgICAgcG9zaXRpb25zWzBdLAogICAgICAgIHNjcmF0Y2hQb2xhckZvclBsYW5lCiAgICAgICk7CiAgICAgIHJldHVybiBwb2xhci50YW5nZW50UGxhbmU7CiAgICB9CiAgICByZXR1cm4gRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVByb2plY3RUbzJkKHJlY3RhbmdsZSwgb3V0ZXJQb3NpdGlvbnMsIGVsbGlwc29pZCkgewogICAgcmV0dXJuIChwb3NpdGlvbnMsIHJlc3VsdHMpID0+IHsKICAgICAgaWYgKHJlY3RhbmdsZS5oZWlnaHQgPj0gTWF0aF9kZWZhdWx0LlBJIHx8IHJlY3RhbmdsZS53aWR0aCA+PSBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICBpZiAocmVjdGFuZ2xlLnNvdXRoIDwgMCAmJiByZWN0YW5nbGUubm9ydGggPiAwKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHRzKSkgewogICAgICAgICAgICByZXN1bHRzID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljQ3lsbGluZHJpY2FsCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJlc3VsdHNbaV0gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KAogICAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlIC8gTWF0aF9kZWZhdWx0LlBJLAogICAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUgLyBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdHMubGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW5BcnJheShwb3NpdGlvbnMsIHJlc3VsdHMpOwogICAgICB9CiAgICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMoCiAgICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkCiAgICAgICk7CiAgICAgIHJldHVybiB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50c09udG9QbGFuZShwb3NpdGlvbnMsIHJlc3VsdHMpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUHJvamVjdFBvc2l0aW9uVG8yZChyZWN0YW5nbGUsIG91dGVyUmluZywgZWxsaXBzb2lkKSB7CiAgICBpZiAocmVjdGFuZ2xlLmhlaWdodCA+PSBNYXRoX2RlZmF1bHQuUEkgfHwgcmVjdGFuZ2xlLndpZHRoID49IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICByZXR1cm4gKHBvc2l0aW9uLCByZXN1bHQpID0+IHsKICAgICAgICBpZiAocmVjdGFuZ2xlLnNvdXRoIDwgMCAmJiByZWN0YW5nbGUubm9ydGggPiAwKSB7CiAgICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY0N5bGxpbmRyaWNhbAogICAgICAgICAgKTsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0LnggPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSAvIE1hdGhfZGVmYXVsdC5QSTsKICAgICAgICAgIHJlc3VsdC55ID0gY2FydG9ncmFwaGljMi5sYXRpdHVkZSAvIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBTdGVyZW9ncmFwaGljX2RlZmF1bHQuZnJvbUNhcnRlc2lhbihwb3NpdGlvbiwgcmVzdWx0KTsKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMob3V0ZXJSaW5nLCBlbGxpcHNvaWQpOwogICAgcmV0dXJuIChwb3NpdGlvbiwgcmVzdWx0KSA9PiB7CiAgICAgIHJldHVybiB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50c09udG9QbGFuZShwb3NpdGlvbiwgcmVzdWx0KTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVNwbGl0UG9seWdvbnMocmVjdGFuZ2xlLCBlbGxpcHNvaWQsIGFyY1R5cGUsIHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICByZXR1cm4gKHBvbHlnb25zLCByZXN1bHRzKSA9PiB7CiAgICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHQgJiYgKHJlY3RhbmdsZS5oZWlnaHQgPj0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIHx8IHJlY3RhbmdsZS53aWR0aCA+PSAyICogTWF0aF9kZWZhdWx0LlBJX09WRVJfVEhSRUUpKSB7CiAgICAgICAgcmV0dXJuIFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zcGxpdFBvbHlnb25zT25FcXVhdG9yKAogICAgICAgICAgcG9seWdvbnMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgcmVzdWx0cwogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIHBvbHlnb25zOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlKG91dGVyUmluZywgcmVjdGFuZ2xlLCBlbGxpcHNvaWQsIHN0Um90YXRpb24pIHsKICAgIGlmIChyZWN0YW5nbGUuaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5QSSB8fCByZWN0YW5nbGUud2lkdGggPj0gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgIHJldHVybiBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIHZvaWQgMCwKICAgICAgICBzY3JhdGNoQm91bmRpbmdSZWN0YW5nbGUKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG91dGVyUG9zaXRpb25zID0gb3V0ZXJSaW5nOwogICAgY29uc3QgdGFuZ2VudFBsYW5lID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50cygKICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlKAogICAgICB0YW5nZW50UGxhbmUucGxhbmUubm9ybWFsLAogICAgICB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50T250b1BsYW5lLmJpbmQodGFuZ2VudFBsYW5lKSwKICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgIHN0Um90YXRpb24sCiAgICAgIHNjcmF0Y2hCb3VuZGluZ1JlY3RhbmdsZQogICAgKTsKICB9CiAgZnVuY3Rpb24gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czIocG9seWdvbkdlb21ldHJ5KSB7CiAgICBjb25zdCBzdFJvdGF0aW9uID0gLXBvbHlnb25HZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgIGlmIChzdFJvdGF0aW9uID09PSAwKSB7CiAgICAgIHJldHVybiBbMCwgMCwgMCwgMSwgMSwgMF07CiAgICB9CiAgICBjb25zdCBlbGxpcHNvaWQgPSBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlnb25HZW9tZXRyeS5fcG9seWdvbkhpZXJhcmNoeS5wb3NpdGlvbnM7CiAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IHBvbHlnb25HZW9tZXRyeS5yZWN0YW5nbGU7CiAgICByZXR1cm4gR2VvbWV0cnlfZGVmYXVsdC5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cygKICAgICAgcG9zaXRpb25zLAogICAgICBzdFJvdGF0aW9uLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlCiAgICApOwogIH0KICB2YXIgc2NyYXRjaENhcnRvMSwgc2NyYXRjaENhcnRvMiwgc2NyYXRjaEJvdW5kaW5nUmVjdGFuZ2xlLCBzY3JhdGNoUG9zaXRpb24zLCBzY3JhdGNoTm9ybWFsNiwgc2NyYXRjaFRhbmdlbnQ0LCBzY3JhdGNoQml0YW5nZW50NCwgcDFTY3JhdGNoMywgcDJTY3JhdGNoMywgc2NyYXRjaFBlclBvc05vcm1hbCwgc2NyYXRjaFBlclBvc1RhbmdlbnQsIHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQsIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc09yaWdpbiwgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzQ2FydGVzaWFuMiwgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzQ2FydGVzaWFuMywgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzUXVhdGVybmlvbiwgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4MywgdGFuZ2VudE1hdHJpeFNjcmF0Y2gyLCBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZFBvc2l0aW9ucywgc2NyYXRjaEVsbGlwc29pZDYsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ5LCBkdW1teU9wdGlvbnMsIHNjcmF0Y2hDYXJ0ZXNpYW4wMiwgc2NyYXRjaENhcnRlc2lhbjE4LCBzY3JhdGNoUG9sYXJDbG9zZXN0LCBzY3JhdGNoUG9sYXIsIHNjcmF0Y2hQb2xhclByZXZpb3VzLCBwb2x5Z29uLCBzY3JhdGNoUG9sYXJGb3JQbGFuZSwgc2NyYXRjaENhcnRvZ3JhcGhpY0N5bGxpbmRyaWNhbCwgUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWdvbkdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1JlY3RhbmdsZSgpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkVGFuZ2VudFBsYW5lKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9Qb2x5Z29uR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1N0ZXJlb2dyYXBoaWMoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgaW5pdF9XaW5kaW5nT3JkZXIoKTsKICAgICAgc2NyYXRjaENhcnRvMSA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG8yID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCb3VuZGluZ1JlY3RhbmdsZSA9IG5ldyBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQb3NpdGlvbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWw2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVGFuZ2VudDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCaXRhbmdlbnQ0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwMVNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwMlNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyUG9zTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyUG9zVGFuZ2VudCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlclBvc0JpdGFuZ2VudCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzT3JpZ2luID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNDYXJ0ZXNpYW4yID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXgzID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICB0YW5nZW50TWF0cml4U2NyYXRjaDIgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkUG9zaXRpb25zID0gW107CiAgICAgIFBvbHlnb25HZW9tZXRyeS5mcm9tUG9zaXRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBvcHRpb25zLnBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IHsKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHsKICAgICAgICAgICAgcG9zaXRpb25zOiBvcHRpb25zLnBvc2l0aW9ucwogICAgICAgICAgfSwKICAgICAgICAgIGhlaWdodDogb3B0aW9ucy5oZWlnaHQsCiAgICAgICAgICBleHRydWRlZEhlaWdodDogb3B0aW9ucy5leHRydWRlZEhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBzdFJvdGF0aW9uOiBvcHRpb25zLnN0Um90YXRpb24sCiAgICAgICAgICBlbGxpcHNvaWQ6IG9wdGlvbnMuZWxsaXBzb2lkLAogICAgICAgICAgZ3JhbnVsYXJpdHk6IG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodDogb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgIGNsb3NlVG9wOiBvcHRpb25zLmNsb3NlVG9wLAogICAgICAgICAgY2xvc2VCb3R0b206IG9wdGlvbnMuY2xvc2VCb3R0b20sCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlLAogICAgICAgICAgYXJjVHlwZTogb3B0aW9ucy5hcmNUeXBlLAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzOiBvcHRpb25zLnRleHR1cmVDb29yZGluYXRlcwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBQb2x5Z29uR2VvbWV0cnkobmV3T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgdmFsdWUuX3BvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5faGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0Um90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9wZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3BlclBvc2l0aW9uSGVpZ2h0ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9jbG9zZVRvcCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY2xvc2VCb3R0b20gPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NoYWRvd1ZvbHVtZSA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9hcmNUeXBlOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodmFsdWUuX3RleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICAgIHZhbHVlLl90ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSAtMTsKICAgICAgICB9CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnBhY2tlZExlbmd0aDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ2ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0OSA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBkdW1teU9wdGlvbnMgPSB7CiAgICAgICAgcG9seWdvbkhpZXJhcmNoeToge30KICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnVucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgZGVsZXRlIHBvbHlnb25IaWVyYXJjaHkuc3RhcnRpbmdJbmRleDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQ2KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0OQogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IGNsb3NlVG9wID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBjbG9zZUJvdHRvbSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgc2hhZG93Vm9sdW1lID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdID09PSAtMSA/IHZvaWQgMCA6IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggPSB0ZXh0dXJlQ29vcmRpbmF0ZXMuc3RhcnRpbmdJbmRleDsKICAgICAgICAgIGRlbGV0ZSB0ZXh0dXJlQ29vcmRpbmF0ZXMuc3RhcnRpbmdJbmRleDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhcnRpbmdJbmRleCsrOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYWNrZWRMZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBQb2x5Z29uR2VvbWV0cnkoZHVtbXlPcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkhpZXJhcmNoeTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQuX3N0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlOwogICAgICAgIHJlc3VsdC5fcGVyUG9zaXRpb25IZWlnaHQgPSBwZXJQb3NpdGlvbkhlaWdodDsKICAgICAgICByZXN1bHQuX2Nsb3NlVG9wID0gY2xvc2VUb3A7CiAgICAgICAgcmVzdWx0Ll9jbG9zZUJvdHRvbSA9IGNsb3NlQm90dG9tOwogICAgICAgIHJlc3VsdC5fc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXN1bHQuX2FyY1R5cGUgPSBhcmNUeXBlOwogICAgICAgIHJlc3VsdC5fdGV4dHVyZUNvb3JkaW5hdGVzID0gdGV4dHVyZUNvb3JkaW5hdGVzOwogICAgICAgIHJlc3VsdC5wYWNrZWRMZW5ndGggPSBwYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjAyID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQb2xhckNsb3Nlc3QgPSBuZXcgU3RlcmVvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQb2xhciA9IG5ldyBTdGVyZW9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBvbGFyUHJldmlvdXMgPSBuZXcgU3RlcmVvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHBvbHlnb24gPSB7CiAgICAgICAgbm9ydGhBbmdsZTogMCwKICAgICAgICBzb3V0aEFuZ2xlOiAwLAogICAgICAgIHdlc3RPdmVySWRsOiAwLAogICAgICAgIGVhc3RPdmVySWRsOiAwCiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeS5jb21wdXRlUmVjdGFuZ2xlRnJvbVBvc2l0aW9ucyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgZWxsaXBzb2lkLCBhcmNUeXBlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIHJlc3VsdC5ub3J0aCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBwb2x5Z29uLm5vcnRoQW5nbGUgPSAwOwogICAgICAgIHBvbHlnb24uc291dGhBbmdsZSA9IDA7CiAgICAgICAgcG9seWdvbi53ZXN0T3ZlcklkbCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBwb2x5Z29uLmVhc3RPdmVySWRsID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IGxhc3RQb2xhclBvc2l0aW9uID0gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4oCiAgICAgICAgICBwb3NpdGlvbnNbMF0sCiAgICAgICAgICBzY3JhdGNoUG9sYXJQcmV2aW91cwogICAgICAgICk7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgcG9sYXJQb3NpdGlvbiA9IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuKAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHNjcmF0Y2hQb2xhcgogICAgICAgICAgKTsKICAgICAgICAgIGV4cGFuZFJlY3RhbmdsZSgKICAgICAgICAgICAgcG9sYXJQb3NpdGlvbiwKICAgICAgICAgICAgbGFzdFBvbGFyUG9zaXRpb24sCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgYXJjVHlwZSwKICAgICAgICAgICAgcG9seWdvbiwKICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICApOwogICAgICAgICAgbGFzdFBvbGFyUG9zaXRpb24gPSBTdGVyZW9ncmFwaGljX2RlZmF1bHQuY2xvbmUocG9sYXJQb3NpdGlvbiwgbGFzdFBvbGFyUG9zaXRpb24pOwogICAgICAgIH0KICAgICAgICBleHBhbmRSZWN0YW5nbGUoCiAgICAgICAgICBTdGVyZW9ncmFwaGljX2RlZmF1bHQuZnJvbUNhcnRlc2lhbihwb3NpdGlvbnNbMF0sIHNjcmF0Y2hQb2xhciksCiAgICAgICAgICBsYXN0UG9sYXJQb3NpdGlvbiwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICBwb2x5Z29uLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICBpZiAocmVzdWx0LmVhc3QgLSByZXN1bHQud2VzdCA+IHBvbHlnb24uZWFzdE92ZXJJZGwgLSBwb2x5Z29uLndlc3RPdmVySWRsKSB7CiAgICAgICAgICByZXN1bHQud2VzdCA9IHBvbHlnb24ud2VzdE92ZXJJZGw7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IHBvbHlnb24uZWFzdE92ZXJJZGw7CiAgICAgICAgICBpZiAocmVzdWx0LmVhc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgcmVzdWx0LmVhc3QgPSByZXN1bHQuZWFzdCAtIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVzdWx0Lndlc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgcmVzdWx0Lndlc3QgPSByZXN1bHQud2VzdCAtIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIE1hdGguYWJzKHBvbHlnb24ubm9ydGhBbmdsZSksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuVFdPX1BJLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMAogICAgICAgICkpIHsKICAgICAgICAgIHJlc3VsdC5ub3J0aCA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIHJlc3VsdC5lYXN0ID0gTWF0aF9kZWZhdWx0LlBJOwogICAgICAgICAgcmVzdWx0Lndlc3QgPSAtTWF0aF9kZWZhdWx0LlBJOwogICAgICAgIH0KICAgICAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBNYXRoLmFicyhwb2x5Z29uLnNvdXRoQW5nbGUpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlRXT19QSSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApKSB7CiAgICAgICAgICByZXN1bHQuc291dGggPSAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPOwogICAgICAgICAgcmVzdWx0LmVhc3QgPSBNYXRoX2RlZmF1bHQuUEk7CiAgICAgICAgICByZXN1bHQud2VzdCA9IC1NYXRoX2RlZmF1bHQuUEk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hQb2xhckZvclBsYW5lID0gbmV3IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljQ3lsbGluZHJpY2FsID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlnb25HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHBvbHlnb25HZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcG9seWdvbkdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBzdFJvdGF0aW9uID0gcG9seWdvbkdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uR2VvbWV0cnkuX3BvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBwb2x5Z29uR2VvbWV0cnkuX3BlclBvc2l0aW9uSGVpZ2h0OwogICAgICAgIGNvbnN0IGNsb3NlVG9wID0gcG9seWdvbkdlb21ldHJ5Ll9jbG9zZVRvcDsKICAgICAgICBjb25zdCBjbG9zZUJvdHRvbSA9IHBvbHlnb25HZW9tZXRyeS5fY2xvc2VCb3R0b207CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IHBvbHlnb25HZW9tZXRyeS5fYXJjVHlwZTsKICAgICAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBwb2x5Z29uR2VvbWV0cnkuX3RleHR1cmVDb29yZGluYXRlczsKICAgICAgICBjb25zdCBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPSBkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKTsKICAgICAgICBjb25zdCBvdXRlclBvc2l0aW9ucyA9IHBvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgIGlmIChvdXRlclBvc2l0aW9ucy5sZW5ndGggPCAzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IHBvbHlnb25HZW9tZXRyeS5yZWN0YW5nbGU7CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgaGFzVGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgY3JlYXRlUHJvamVjdFRvMmQocmVjdGFuZ2xlLCBvdXRlclBvc2l0aW9ucywgZWxsaXBzb2lkKSwKICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGNyZWF0ZVNwbGl0UG9seWdvbnMocmVjdGFuZ2xlLCBlbGxpcHNvaWQsIGFyY1R5cGUsIHBlclBvc2l0aW9uSGVpZ2h0KQogICAgICAgICk7CiAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gcmVzdWx0cy5oaWVyYXJjaHk7CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSByZXN1bHRzLnBvbHlnb25zOwogICAgICAgIGNvbnN0IGR1bW15RnVuY3Rpb24gPSBmdW5jdGlvbihpZGVudGl0eSkgewogICAgICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgICAgIH07CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVQb2x5Z29ucyA9IGhhc1RleHR1cmVDb29yZGluYXRlcyA/IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgICB0cnVlLAogICAgICAgICAgZHVtbXlGdW5jdGlvbiwKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgKS5wb2x5Z29ucyA6IHZvaWQgMDsKICAgICAgICBpZiAoaGllcmFyY2h5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBvdXRlclJpbmcgPSBoaWVyYXJjaHlbMF0ub3V0ZXJSaW5nOwogICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlKAogICAgICAgICAgb3V0ZXJSaW5nLAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3RSb3RhdGlvbgogICAgICAgICk7CiAgICAgICAgY29uc3QgZ2VvbWV0cmllcyA9IFtdOwogICAgICAgIGNvbnN0IGhlaWdodCA9IHBvbHlnb25HZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcG9seWdvbkdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gcG9seWdvbkdlb21ldHJ5Ll9wZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgfHwgIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQsIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMik7CiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgICAgZ2VvbWV0cnk6IHZvaWQgMCwKICAgICAgICAgIHJvdGF0aW9uQXhpczogZ2V0VGFuZ2VudFBsYW5lKHJlY3RhbmdsZSwgb3V0ZXJSaW5nLCBlbGxpcHNvaWQpLnBsYW5lLm5vcm1hbCwKICAgICAgICAgIHByb2plY3RUbzJkOiBjcmVhdGVQcm9qZWN0UG9zaXRpb25UbzJkKHJlY3RhbmdsZSwgb3V0ZXJSaW5nLCBlbGxpcHNvaWQpLAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzOiB2b2lkIDAsCiAgICAgICAgICBib3R0b206IGZhbHNlLAogICAgICAgICAgdG9wOiB0cnVlLAogICAgICAgICAgd2FsbDogZmFsc2UsCiAgICAgICAgICBleHRydWRlOiBmYWxzZSwKICAgICAgICAgIGFyY1R5cGUKICAgICAgICB9OwogICAgICAgIGxldCBpOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICBvcHRpb25zLmV4dHJ1ZGUgPSB0cnVlOwogICAgICAgICAgb3B0aW9ucy50b3AgPSBjbG9zZVRvcDsKICAgICAgICAgIG9wdGlvbnMuYm90dG9tID0gY2xvc2VCb3R0b207CiAgICAgICAgICBvcHRpb25zLnNoYWRvd1ZvbHVtZSA9IHBvbHlnb25HZW9tZXRyeS5fc2hhZG93Vm9sdW1lOwogICAgICAgICAgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPSBwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBzcGxpdEdlb21ldHJ5ID0gY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zRXh0cnVkZWQoCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIHBvbHlnb25zW2ldLAogICAgICAgICAgICAgIGhhc1RleHR1cmVDb29yZGluYXRlcyA/IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnNbaV0gOiB2b2lkIDAsCiAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgaGllcmFyY2h5W2ldLAogICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgICAgIGNsb3NlVG9wLAogICAgICAgICAgICAgIGNsb3NlQm90dG9tLAogICAgICAgICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICAgICAgICBhcmNUeXBlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGxldCB0b3BBbmRCb3R0b207CiAgICAgICAgICAgIGlmIChjbG9zZVRvcCAmJiBjbG9zZUJvdHRvbSkgewogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbSA9IHNwbGl0R2VvbWV0cnkudG9wQW5kQm90dG9tOwogICAgICAgICAgICAgIG9wdGlvbnMuZ2VvbWV0cnkgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0RXh0cnVkZWQoCiAgICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnksCiAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbG9zZVRvcCkgewogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbSA9IHNwbGl0R2VvbWV0cnkudG9wQW5kQm90dG9tOwogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IHRvcEFuZEJvdHRvbS5nZW9tZXRyeTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbG9zZUJvdHRvbSkgewogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbSA9IHNwbGl0R2VvbWV0cnkudG9wQW5kQm90dG9tOwogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IHRvcEFuZEJvdHRvbS5nZW9tZXRyeTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2xvc2VUb3AgfHwgY2xvc2VCb3R0b20pIHsKICAgICAgICAgICAgICBvcHRpb25zLndhbGwgPSBmYWxzZTsKICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnkgPSBjb21wdXRlQXR0cmlidXRlcyhvcHRpb25zKTsKICAgICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2godG9wQW5kQm90dG9tKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCB3YWxscyA9IHNwbGl0R2VvbWV0cnkud2FsbHM7CiAgICAgICAgICAgIG9wdGlvbnMud2FsbCA9IHRydWU7CiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgd2FsbHMubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICBjb25zdCB3YWxsID0gd2FsbHNba107CiAgICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHRFeHRydWRlZCgKICAgICAgICAgICAgICAgIHdhbGwuZ2VvbWV0cnksCiAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB3YWxsLmdlb21ldHJ5ID0gY29tcHV0ZUF0dHJpYnV0ZXMob3B0aW9ucyk7CiAgICAgICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKHdhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBnZW9tZXRyeUluc3RhbmNlID0gbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgICAgICAgZ2VvbWV0cnk6IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBwb2x5Z29uc1tpXSwKICAgICAgICAgICAgICAgIGhhc1RleHR1cmVDb29yZGluYXRlcyA/IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnNbaV0gOiB2b2lkIDAsCiAgICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgICAgICAgICAgYXJjVHlwZQogICAgICAgICAgICAgICkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICApOwogICAgICAgICAgICBvcHRpb25zLmdlb21ldHJ5ID0gZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeTsKICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeSA9IGNvbXB1dGVBdHRyaWJ1dGVzKG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKGdlb21ldHJ5SW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeSA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21iaW5lSW5zdGFuY2VzKGdlb21ldHJpZXMpWzBdOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gbmV3IEZsb2F0NjRBcnJheSgKICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzCiAgICAgICAgKTsKICAgICAgICBnZW9tZXRyeS5pbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzLAogICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcwogICAgICAgICk7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzCiAgICAgICAgKTsKICAgICAgICBpZiAoIXZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgZGVsZXRlIGF0dHJpYnV0ZXMucG9zaXRpb247CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogZ2VvbWV0cnkuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5LmNyZWF0ZVNoYWRvd1ZvbHVtZSA9IGZ1bmN0aW9uKHBvbHlnb25HZW9tZXRyeSwgbWluSGVpZ2h0RnVuYywgbWF4SGVpZ2h0RnVuYykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcG9seWdvbkdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5IZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1heEhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIG5ldyBQb2x5Z29uR2VvbWV0cnkoewogICAgICAgICAgcG9seWdvbkhpZXJhcmNoeTogcG9seWdvbkdlb21ldHJ5Ll9wb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3RSb3RhdGlvbjogcG9seWdvbkdlb21ldHJ5Ll9zdFJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodDogZmFsc2UsCiAgICAgICAgICBleHRydWRlZEhlaWdodDogbWluSGVpZ2h0LAogICAgICAgICAgaGVpZ2h0OiBtYXhIZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFksCiAgICAgICAgICBzaGFkb3dWb2x1bWU6IHRydWUsCiAgICAgICAgICBhcmNUeXBlOiBwb2x5Z29uR2VvbWV0cnkuX2FyY1R5cGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoUG9seWdvbkdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9yZWN0YW5nbGUpKSB7CiAgICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdGhpcy5fcG9seWdvbkhpZXJhcmNoeS5wb3NpdGlvbnM7CiAgICAgICAgICAgICAgdGhpcy5fcmVjdGFuZ2xlID0gUG9seWdvbkdlb21ldHJ5LmNvbXB1dGVSZWN0YW5nbGVGcm9tUG9zaXRpb25zKAogICAgICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgdGhpcy5fYXJjVHlwZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEZvciByZW1hcHBpbmcgdGV4dHVyZSBjb29yZGluYXRlcyB3aGVuIHJlbmRlcmluZyBQb2x5Z29uR2VvbWV0cmllcyBhcyBHcm91bmRQcmltaXRpdmVzLgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cykpIHsKICAgICAgICAgICAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czIodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQgPSBQb2x5Z29uR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5Z29uR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWdvbkdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVQb2x5Z29uR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5Z29uR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5Z29uR2VvbWV0cnkgPSBQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVBvbHlnb25HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWdvbkdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWdvbkdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUG9seWdvbkdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uczIoZWxsaXBzb2lkLCBwb3NpdGlvbnMsIG1pbkRpc3RhbmNlLCBwZXJQb3NpdGlvbkhlaWdodCwgYXJjVHlwZSkgewogICAgY29uc3QgdGFuZ2VudFBsYW5lID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICBjb25zdCBwb3NpdGlvbnMyRCA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRzT250b1BsYW5lKAogICAgICBwb3NpdGlvbnMsCiAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1Bvc2l0aW9ucwogICAgKTsKICAgIGNvbnN0IG9yaWdpbmFsV2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKHBvc2l0aW9uczJEKTsKICAgIGlmIChvcmlnaW5hbFdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgIHBvc2l0aW9uczJELnJldmVyc2UoKTsKICAgICAgcG9zaXRpb25zID0gcG9zaXRpb25zLnNsaWNlKCkucmV2ZXJzZSgpOwogICAgfQogICAgbGV0IHN1YmRpdmlkZWRQb3NpdGlvbnM7CiAgICBsZXQgaTsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgbGV0IG51bVZlcnRpY2VzID0gMDsKICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZUxpbmVDb3VudCgKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG51bVZlcnRpY2VzICs9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zdWJkaXZpZGVSaHVtYkxpbmVDb3VudCgKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGxldCB0ZW1wUG9zaXRpb25zOwogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgIHRlbXBQb3NpdGlvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlTGluZSgKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNTdWJkaXZpZGVkCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICB0ZW1wUG9zaXRpb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZVJodW1iTGluZSgKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1N1YmRpdmlkZWQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRlbXBQb3NpdGlvbnNMZW5ndGggPSB0ZW1wUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRlbXBQb3NpdGlvbnNMZW5ndGg7ICsraikgewogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHRlbXBQb3NpdGlvbnNbal07CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiAyICogMyk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC54OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC55OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC56OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS54OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS55OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS56OwogICAgICB9CiAgICB9CiAgICBsZW5ndGggPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBpbmRpY2VzU2l6ZSA9IGxlbmd0aCAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobGVuZ3RoLCBpbmRpY2VzU2l6ZSk7CiAgICBpbmRleCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gbGVuZ3RoIC0gMTsKICAgIGluZGljZXNbaW5kZXgrK10gPSAwOwogICAgcmV0dXJuIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICBnZW9tZXRyeTogbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KSwKICAgICAgICBpbmRpY2VzLAogICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgICB9KQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkMihlbGxpcHNvaWQsIHBvc2l0aW9ucywgbWluRGlzdGFuY2UsIHBlclBvc2l0aW9uSGVpZ2h0LCBhcmNUeXBlKSB7CiAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgIGNvbnN0IHBvc2l0aW9uczJEID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUoCiAgICAgIHBvc2l0aW9ucywKICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zUG9zaXRpb25zCiAgICApOwogICAgY29uc3Qgb3JpZ2luYWxXaW5kaW5nT3JkZXIgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlV2luZGluZ09yZGVyMkQocG9zaXRpb25zMkQpOwogICAgaWYgKG9yaWdpbmFsV2luZGluZ09yZGVyID09PSBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DTE9DS1dJU0UpIHsKICAgICAgcG9zaXRpb25zMkQucmV2ZXJzZSgpOwogICAgICBwb3NpdGlvbnMgPSBwb3NpdGlvbnMuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICB9CiAgICBsZXQgc3ViZGl2aWRlZFBvc2l0aW9uczsKICAgIGxldCBpOwogICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBjb3JuZXJzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgaWYgKCFwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICBsZXQgbnVtVmVydGljZXMgPSAwOwogICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBudW1WZXJ0aWNlcyArPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlTGluZUNvdW50KAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZVJodW1iTGluZUNvdW50KAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobnVtVmVydGljZXMgKiAzICogMik7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGNvcm5lcnNbaV0gPSBpbmRleCAvIDM7CiAgICAgICAgbGV0IHRlbXBQb3NpdGlvbnM7CiAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgdGVtcFBvc2l0aW9ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zdWJkaXZpZGVMaW5lKAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1N1YmRpdmlkZWQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgIHRlbXBQb3NpdGlvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlUmh1bWJMaW5lKAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zU3ViZGl2aWRlZAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGVtcFBvc2l0aW9uc0xlbmd0aCA9IHRlbXBQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGVtcFBvc2l0aW9uc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW2luZGV4KytdID0gdGVtcFBvc2l0aW9uc1tqXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCAqIDIgKiAzICogMik7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGNvcm5lcnNbaV0gPSBpbmRleCAvIDM7CiAgICAgICAgY29uc3QgcDAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgY29uc3QgcDEgPSBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF07CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAwLng7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAwLnk7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAwLno7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAxLng7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAxLnk7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAxLno7CiAgICAgIH0KICAgIH0KICAgIGxlbmd0aCA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gKDMgKiAyKTsKICAgIGNvbnN0IGNvcm5lcnNMZW5ndGggPSBjb3JuZXJzLmxlbmd0aDsKICAgIGNvbnN0IGluZGljZXNTaXplID0gKGxlbmd0aCAqIDIgKyBjb3JuZXJzTGVuZ3RoKSAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIGxlbmd0aCArIGNvcm5lcnNMZW5ndGgsCiAgICAgIGluZGljZXNTaXplCiAgICApOwogICAgaW5kZXggPSAwOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBsZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSAoaSArIDEpICUgbGVuZ3RoICsgbGVuZ3RoOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGNvcm5lcnNMZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjb3JuZXIgPSBjb3JuZXJzW2ldOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gY29ybmVyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gY29ybmVyICsgbGVuZ3RoOwogICAgfQogICAgcmV0dXJuIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICBnZW9tZXRyeTogbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KSwKICAgICAgICBpbmRpY2VzLAogICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgICB9KQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIFBvbHlnb25PdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSIsIG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSk7CiAgICBpZiAob3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJDYW5ub3QgdXNlIGJvdGggb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCBhbmQgb3B0aW9ucy5oZWlnaHQiCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSkgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkludmFsaWQgYXJjVHlwZS4gVmFsaWQgb3B0aW9ucyBhcmUgQXJjVHlwZS5HRU9ERVNJQyBhbmQgQXJjVHlwZS5SSFVNQi4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5OwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCwgZmFsc2UpOwogICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHQgJiYgZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQpOwogICAgY29uc3QgYXJjVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSwgQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKTsKICAgIGxldCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBsZXQgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgaWYgKCFwZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUpIHsKICAgICAgY29uc3QgaCA9IE1hdGgubWF4KGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgICBleHRydWRlZEhlaWdodCA9IE1hdGgubWluKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgICBoZWlnaHQgPSBoOwogICAgfQogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICB0aGlzLl9oZWlnaHQgPSBoZWlnaHQ7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgdGhpcy5fYXJjVHlwZSA9IGFyY1R5cGU7CiAgICB0aGlzLl9wb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkhpZXJhcmNoeTsKICAgIHRoaXMuX3BlclBvc2l0aW9uSGVpZ2h0ID0gcGVyUG9zaXRpb25IZWlnaHQ7CiAgICB0aGlzLl9wZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPSBwZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGU7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeSI7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoKAogICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICkgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA4OwogIH0KICB2YXIgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zUG9zaXRpb25zLCBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNTdWJkaXZpZGVkLCBzY3JhdGNoRWxsaXBzb2lkNywgZHVtbXlPcHRpb25zMiwgUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlnb25PdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkVGFuZ2VudFBsYW5lKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlnb25HZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfV2luZGluZ09yZGVyKCk7CiAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1Bvc2l0aW9ucyA9IFtdOwogICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNTdWJkaXZpZGVkID0gW107CiAgICAgIFBvbHlnb25PdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIHZhbHVlLl9wb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2hlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9wZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3BlclBvc2l0aW9uSGVpZ2h0ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9hcmNUeXBlOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5wYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkNyA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgZHVtbXlPcHRpb25zMiA9IHsKICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7fQogICAgICB9OwogICAgICBQb2x5Z29uT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnVucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgZGVsZXRlIHBvbHlnb25IaWVyYXJjaHkuc3RhcnRpbmdJbmRleDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQ3KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwYWNrZWRMZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUG9seWdvbk91dGxpbmVHZW9tZXRyeShkdW1teU9wdGlvbnMyKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkhpZXJhcmNoeTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5faGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmVzdWx0Ll9wZXJQb3NpdGlvbkhlaWdodCA9IHBlclBvc2l0aW9uSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlOwogICAgICAgIHJlc3VsdC5fYXJjVHlwZSA9IGFyY1R5cGU7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJlc3VsdC5wYWNrZWRMZW5ndGggPSBwYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUG9seWdvbk91dGxpbmVHZW9tZXRyeS5mcm9tUG9zaXRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBvcHRpb25zLnBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IHsKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHsKICAgICAgICAgICAgcG9zaXRpb25zOiBvcHRpb25zLnBvc2l0aW9ucwogICAgICAgICAgfSwKICAgICAgICAgIGhlaWdodDogb3B0aW9ucy5oZWlnaHQsCiAgICAgICAgICBleHRydWRlZEhlaWdodDogb3B0aW9ucy5leHRydWRlZEhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZDogb3B0aW9ucy5lbGxpcHNvaWQsCiAgICAgICAgICBncmFudWxhcml0eTogb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0OiBvcHRpb25zLnBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgYXJjVHlwZTogb3B0aW9ucy5hcmNUeXBlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBQb2x5Z29uT3V0bGluZUdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocG9seWdvbkdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBwb2x5Z29uR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uR2VvbWV0cnkuX3BvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBwb2x5Z29uR2VvbWV0cnkuX3BlclBvc2l0aW9uSGVpZ2h0OwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBwb2x5Z29uR2VvbWV0cnkuX2FyY1R5cGU7CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucG9seWdvbk91dGxpbmVzRnJvbUhpZXJhcmNoeSgKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICAhcGVyUG9zaXRpb25IZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICApOwogICAgICAgIGlmIChwb2x5Z29ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGxldCBnZW9tZXRyeUluc3RhbmNlOwogICAgICAgIGNvbnN0IGdlb21ldHJpZXMgPSBbXTsKICAgICAgICBjb25zdCBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aCgKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMKICAgICAgICApOwogICAgICAgIGNvbnN0IGhlaWdodCA9IHBvbHlnb25HZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcG9seWdvbkdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gcG9seWdvbkdlb21ldHJ5Ll9wZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgfHwgIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQsIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMik7CiAgICAgICAgbGV0IG9mZnNldFZhbHVlOwogICAgICAgIGxldCBpOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcG9seWdvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZSA9IGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkMigKICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgcG9seWdvbnNbaV0sCiAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQsCiAgICAgICAgICAgICAgYXJjVHlwZQogICAgICAgICAgICApOwogICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodEV4dHJ1ZGVkKAogICAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnksCiAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDM7CiAgICAgICAgICAgICAgbGV0IG9mZnNldEF0dHJpYnV0ZSA9IG5ldyBVaW50OEFycmF5KHNpemUpOwogICAgICAgICAgICAgIGlmIChwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKDEsIDAsIHNpemUgLyAyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgb2Zmc2V0VmFsdWUgPSBwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goZ2VvbWV0cnlJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlID0gY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zMigKICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgcG9seWdvbnNbaV0sCiAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQsCiAgICAgICAgICAgICAgYXJjVHlwZQogICAgICAgICAgICApOwogICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAhcGVyUG9zaXRpb25IZWlnaHQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgICBjb25zdCBsZW5ndGggPSBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgICBvZmZzZXRWYWx1ZSA9IHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhnZW9tZXRyaWVzKVswXTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMKICAgICAgICApOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiBnZW9tZXRyeS5hdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogZ2VvbWV0cnkuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUG9seWdvbk91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWdvbkdlb21ldHJ5ID0gUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhwb2x5Z29uR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29sb3IuanMKICBmdW5jdGlvbiBodWUycmdiKG0xLCBtMiwgaCkgewogICAgaWYgKGggPCAwKSB7CiAgICAgIGggKz0gMTsKICAgIH0KICAgIGlmIChoID4gMSkgewogICAgICBoIC09IDE7CiAgICB9CiAgICBpZiAoaCAqIDYgPCAxKSB7CiAgICAgIHJldHVybiBtMSArIChtMiAtIG0xKSAqIDYgKiBoOwogICAgfQogICAgaWYgKGggKiAyIDwgMSkgewogICAgICByZXR1cm4gbTI7CiAgICB9CiAgICBpZiAoaCAqIDMgPCAyKSB7CiAgICAgIHJldHVybiBtMSArIChtMiAtIG0xKSAqICgyIC8gMyAtIGgpICogNjsKICAgIH0KICAgIHJldHVybiBtMTsKICB9CiAgZnVuY3Rpb24gQ29sb3IocmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpIHsKICAgIHRoaXMucmVkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocmVkLCAxKTsKICAgIHRoaXMuZ3JlZW4gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChncmVlbiwgMSk7CiAgICB0aGlzLmJsdWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChibHVlLCAxKTsKICAgIHRoaXMuYWxwaGEgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChhbHBoYSwgMSk7CiAgfQogIHZhciBzY3JhdGNoQXJyYXlCdWZmZXIsIHNjcmF0Y2hVaW50MzJBcnJheSwgc2NyYXRjaFVpbnQ4QXJyYXksIHJnYmFNYXRjaGVyLCBycmdnYmJhYU1hdGNoZXIsIHJnYlBhcmVudGhlc2VzTWF0Y2hlciwgaHNsUGFyZW50aGVzZXNNYXRjaGVyLCBDb2xvcl9kZWZhdWx0OwogIHZhciBpbml0X0NvbG9yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db2xvci5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRmVhdHVyZURldGVjdGlvbigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ29sb3IuZnJvbUNhcnRlc2lhbjQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56LCBjYXJ0ZXNpYW4xMS53KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJlZCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQuYmx1ZSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmVzdWx0LmFscGhhID0gY2FydGVzaWFuMTEudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5mcm9tQnl0ZXMgPSBmdW5jdGlvbihyZWQsIGdyZWVuLCBibHVlLCBhbHBoYSwgcmVzdWx0KSB7CiAgICAgICAgcmVkID0gQ29sb3IuYnl0ZVRvRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQocmVkLCAyNTUpKTsKICAgICAgICBncmVlbiA9IENvbG9yLmJ5dGVUb0Zsb2F0KGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGdyZWVuLCAyNTUpKTsKICAgICAgICBibHVlID0gQ29sb3IuYnl0ZVRvRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQoYmx1ZSwgMjU1KSk7CiAgICAgICAgYWxwaGEgPSBDb2xvci5ieXRlVG9GbG9hdChkZWZhdWx0VmFsdWVfZGVmYXVsdChhbHBoYSwgMjU1KSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihyZWQsIGdyZWVuLCBibHVlLCBhbHBoYSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yZWQgPSByZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLmZyb21BbHBoYSA9IGZ1bmN0aW9uKGNvbG9yLCBhbHBoYSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFscGhhIiwgYWxwaGEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IoY29sb3IucmVkLCBjb2xvci5ncmVlbiwgY29sb3IuYmx1ZSwgYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gY29sb3IucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGNvbG9yLmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gY29sb3IuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBhbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBpZiAoRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0LnN1cHBvcnRzVHlwZWRBcnJheXMoKSkgewogICAgICAgIHNjcmF0Y2hBcnJheUJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICBzY3JhdGNoVWludDMyQXJyYXkgPSBuZXcgVWludDMyQXJyYXkoc2NyYXRjaEFycmF5QnVmZmVyKTsKICAgICAgICBzY3JhdGNoVWludDhBcnJheSA9IG5ldyBVaW50OEFycmF5KHNjcmF0Y2hBcnJheUJ1ZmZlcik7CiAgICAgIH0KICAgICAgQ29sb3IuZnJvbVJnYmEgPSBmdW5jdGlvbihyZ2JhLCByZXN1bHQpIHsKICAgICAgICBzY3JhdGNoVWludDMyQXJyYXlbMF0gPSByZ2JhOwogICAgICAgIHJldHVybiBDb2xvci5mcm9tQnl0ZXMoCiAgICAgICAgICBzY3JhdGNoVWludDhBcnJheVswXSwKICAgICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzFdLAogICAgICAgICAgc2NyYXRjaFVpbnQ4QXJyYXlbMl0sCiAgICAgICAgICBzY3JhdGNoVWludDhBcnJheVszXSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIENvbG9yLmZyb21Ic2wgPSBmdW5jdGlvbihodWUsIHNhdHVyYXRpb24sIGxpZ2h0bmVzcywgYWxwaGEsIHJlc3VsdCkgewogICAgICAgIGh1ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGh1ZSwgMCkgJSAxOwogICAgICAgIHNhdHVyYXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzYXR1cmF0aW9uLCAwKTsKICAgICAgICBsaWdodG5lc3MgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsaWdodG5lc3MsIDApOwogICAgICAgIGFscGhhID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYWxwaGEsIDEpOwogICAgICAgIGxldCByZWQgPSBsaWdodG5lc3M7CiAgICAgICAgbGV0IGdyZWVuID0gbGlnaHRuZXNzOwogICAgICAgIGxldCBibHVlID0gbGlnaHRuZXNzOwogICAgICAgIGlmIChzYXR1cmF0aW9uICE9PSAwKSB7CiAgICAgICAgICBsZXQgbTI7CiAgICAgICAgICBpZiAobGlnaHRuZXNzIDwgMC41KSB7CiAgICAgICAgICAgIG0yID0gbGlnaHRuZXNzICogKDEgKyBzYXR1cmF0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG0yID0gbGlnaHRuZXNzICsgc2F0dXJhdGlvbiAtIGxpZ2h0bmVzcyAqIHNhdHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBtMSA9IDIgKiBsaWdodG5lc3MgLSBtMjsKICAgICAgICAgIHJlZCA9IGh1ZTJyZ2IobTEsIG0yLCBodWUgKyAxIC8gMyk7CiAgICAgICAgICBncmVlbiA9IGh1ZTJyZ2IobTEsIG0yLCBodWUpOwogICAgICAgICAgYmx1ZSA9IGh1ZTJyZ2IobTEsIG0yLCBodWUgLSAxIC8gMyk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IocmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gcmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBhbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5mcm9tUmFuZG9tID0gZnVuY3Rpb24ob3B0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgbGV0IHJlZCA9IG9wdGlvbnMucmVkOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlZCkpIHsKICAgICAgICAgIGNvbnN0IG1pbmltdW1SZWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1SZWQsIDApOwogICAgICAgICAgY29uc3QgbWF4aW11bVJlZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bVJlZCwgMSk7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygibWluaW11bVJlZCIsIG1pbmltdW1SZWQsIG1heGltdW1SZWQpOwogICAgICAgICAgcmVkID0gbWluaW11bVJlZCArIE1hdGhfZGVmYXVsdC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4aW11bVJlZCAtIG1pbmltdW1SZWQpOwogICAgICAgIH0KICAgICAgICBsZXQgZ3JlZW4gPSBvcHRpb25zLmdyZWVuOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdyZWVuKSkgewogICAgICAgICAgY29uc3QgbWluaW11bUdyZWVuID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtR3JlZW4sIDApOwogICAgICAgICAgY29uc3QgbWF4aW11bUdyZWVuID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtR3JlZW4sIDEpOwogICAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoCiAgICAgICAgICAgICJtaW5pbXVtR3JlZW4iLAogICAgICAgICAgICBtaW5pbXVtR3JlZW4sCiAgICAgICAgICAgIG1heGltdW1HcmVlbgogICAgICAgICAgKTsKICAgICAgICAgIGdyZWVuID0gbWluaW11bUdyZWVuICsgTWF0aF9kZWZhdWx0Lm5leHRSYW5kb21OdW1iZXIoKSAqIChtYXhpbXVtR3JlZW4gLSBtaW5pbXVtR3JlZW4pOwogICAgICAgIH0KICAgICAgICBsZXQgYmx1ZSA9IG9wdGlvbnMuYmx1ZTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChibHVlKSkgewogICAgICAgICAgY29uc3QgbWluaW11bUJsdWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1CbHVlLCAwKTsKICAgICAgICAgIGNvbnN0IG1heGltdW1CbHVlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtQmx1ZSwgMSk7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygKICAgICAgICAgICAgIm1pbmltdW1CbHVlIiwKICAgICAgICAgICAgbWluaW11bUJsdWUsCiAgICAgICAgICAgIG1heGltdW1CbHVlCiAgICAgICAgICApOwogICAgICAgICAgYmx1ZSA9IG1pbmltdW1CbHVlICsgTWF0aF9kZWZhdWx0Lm5leHRSYW5kb21OdW1iZXIoKSAqIChtYXhpbXVtQmx1ZSAtIG1pbmltdW1CbHVlKTsKICAgICAgICB9CiAgICAgICAgbGV0IGFscGhhID0gb3B0aW9ucy5hbHBoYTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbHBoYSkpIHsKICAgICAgICAgIGNvbnN0IG1pbmltdW1BbHBoYSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUFscGhhLCAwKTsKICAgICAgICAgIGNvbnN0IG1heGltdW1BbHBoYSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUFscGhhLCAxKTsKICAgICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKAogICAgICAgICAgICAibWluaW11bUFscGhhIiwKICAgICAgICAgICAgbWluaW11bUFscGhhLAogICAgICAgICAgICBtYXhpbXVtQWxwaGEKICAgICAgICAgICk7CiAgICAgICAgICBhbHBoYSA9IG1pbmltdW1BbHBoYSArIE1hdGhfZGVmYXVsdC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4aW11bUFscGhhIC0gbWluaW11bUFscGhhKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihyZWQsIGdyZWVuLCBibHVlLCBhbHBoYSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yZWQgPSByZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHJnYmFNYXRjaGVyID0gL14jKFswLTlhLWZdKShbMC05YS1mXSkoWzAtOWEtZl0pKFswLTlhLWZdKT8kL2k7CiAgICAgIHJyZ2diYmFhTWF0Y2hlciA9IC9eIyhbMC05YS1mXXsyfSkoWzAtOWEtZl17Mn0pKFswLTlhLWZdezJ9KShbMC05YS1mXXsyfSk/JC9pOwogICAgICByZ2JQYXJlbnRoZXNlc01hdGNoZXIgPSAvXnJnYmE/XHMqXChccyooWzAtOS5dKyU/KVxzKlssXHNdK1xzKihbMC05Ll0rJT8pXHMqWyxcc10rXHMqKFswLTkuXSslPykoPzpccypbLFxzL10rXHMqKFswLTkuXSspKT9ccypcKSQvaTsKICAgICAgaHNsUGFyZW50aGVzZXNNYXRjaGVyID0gL15oc2xhP1xzKlwoXHMqKFswLTkuXSspXHMqWyxcc10rXHMqKFswLTkuXSslKVxzKlssXHNdK1xzKihbMC05Ll0rJSkoPzpccypbLFxzL10rXHMqKFswLTkuXSspKT9ccypcKSQvaTsKICAgICAgQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nID0gZnVuY3Rpb24oY29sb3IsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLnN0cmluZygiY29sb3IiLCBjb2xvcik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENvbG9yKCk7CiAgICAgICAgfQogICAgICAgIGNvbG9yID0gY29sb3IudHJpbSgpOwogICAgICAgIGNvbnN0IG5hbWVkQ29sb3IgPSBDb2xvcltjb2xvci50b1VwcGVyQ2FzZSgpXTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG5hbWVkQ29sb3IpKSB7CiAgICAgICAgICBDb2xvci5jbG9uZShuYW1lZENvbG9yLCByZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbGV0IG1hdGNoZXMgPSByZ2JhTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0LnJlZCA9IHBhcnNlSW50KG1hdGNoZXNbMV0sIDE2KSAvIDE1OwogICAgICAgICAgcmVzdWx0LmdyZWVuID0gcGFyc2VJbnQobWF0Y2hlc1syXSwgMTYpIC8gMTU7CiAgICAgICAgICByZXN1bHQuYmx1ZSA9IHBhcnNlSW50KG1hdGNoZXNbM10sIDE2KSAvIDE1OwogICAgICAgICAgcmVzdWx0LmFscGhhID0gcGFyc2VJbnQoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF0Y2hlc1s0XSwgImYiKSwgMTYpIC8gMTU7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBtYXRjaGVzID0gcnJnZ2JiYWFNYXRjaGVyLmV4ZWMoY29sb3IpOwogICAgICAgIGlmIChtYXRjaGVzICE9PSBudWxsKSB7CiAgICAgICAgICByZXN1bHQucmVkID0gcGFyc2VJbnQobWF0Y2hlc1sxXSwgMTYpIC8gMjU1OwogICAgICAgICAgcmVzdWx0LmdyZWVuID0gcGFyc2VJbnQobWF0Y2hlc1syXSwgMTYpIC8gMjU1OwogICAgICAgICAgcmVzdWx0LmJsdWUgPSBwYXJzZUludChtYXRjaGVzWzNdLCAxNikgLyAyNTU7CiAgICAgICAgICByZXN1bHQuYWxwaGEgPSBwYXJzZUludChkZWZhdWx0VmFsdWVfZGVmYXVsdChtYXRjaGVzWzRdLCAiZmYiKSwgMTYpIC8gMjU1OwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlcyA9IHJnYlBhcmVudGhlc2VzTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0LnJlZCA9IHBhcnNlRmxvYXQobWF0Y2hlc1sxXSkgLyAoIiUiID09PSBtYXRjaGVzWzFdLnN1YnN0cigtMSkgPyAxMDAgOiAyNTUpOwogICAgICAgICAgcmVzdWx0LmdyZWVuID0gcGFyc2VGbG9hdChtYXRjaGVzWzJdKSAvICgiJSIgPT09IG1hdGNoZXNbMl0uc3Vic3RyKC0xKSA/IDEwMCA6IDI1NSk7CiAgICAgICAgICByZXN1bHQuYmx1ZSA9IHBhcnNlRmxvYXQobWF0Y2hlc1szXSkgLyAoIiUiID09PSBtYXRjaGVzWzNdLnN1YnN0cigtMSkgPyAxMDAgOiAyNTUpOwogICAgICAgICAgcmVzdWx0LmFscGhhID0gcGFyc2VGbG9hdChkZWZhdWx0VmFsdWVfZGVmYXVsdChtYXRjaGVzWzRdLCAiMS4wIikpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlcyA9IGhzbFBhcmVudGhlc2VzTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIENvbG9yLmZyb21Ic2woCiAgICAgICAgICAgIHBhcnNlRmxvYXQobWF0Y2hlc1sxXSkgLyAzNjAsCiAgICAgICAgICAgIHBhcnNlRmxvYXQobWF0Y2hlc1syXSkgLyAxMDAsCiAgICAgICAgICAgIHBhcnNlRmxvYXQobWF0Y2hlc1szXSkgLyAxMDAsCiAgICAgICAgICAgIHBhcnNlRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF0Y2hlc1s0XSwgIjEuMCIpKSwKICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IucGFja2VkTGVuZ3RoID0gNDsKICAgICAgQ29sb3IucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnJlZDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuZ3JlZW47CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmJsdWU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5hbHBoYTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIENvbG9yLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ29sb3IoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJlZCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmdyZWVuID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuYmx1ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmFscGhhID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IuYnl0ZVRvRmxvYXQgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gbnVtYmVyIC8gMjU1OwogICAgICB9OwogICAgICBDb2xvci5mbG9hdFRvQnl0ZSA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgIHJldHVybiBudW1iZXIgPT09IDEgPyAyNTUgOiBudW1iZXIgKiAyNTYgfCAwOwogICAgICB9OwogICAgICBDb2xvci5jbG9uZSA9IGZ1bmN0aW9uKGNvbG9yLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb2xvcikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IoY29sb3IucmVkLCBjb2xvci5ncmVlbiwgY29sb3IuYmx1ZSwgY29sb3IuYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gY29sb3IucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGNvbG9yLmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gY29sb3IuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBjb2xvci5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCAvLwogICAgICAgIGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiAvLwogICAgICAgIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgLy8KICAgICAgICBsZWZ0LnJlZCA9PT0gcmlnaHQucmVkICYmIC8vCiAgICAgICAgbGVmdC5ncmVlbiA9PT0gcmlnaHQuZ3JlZW4gJiYgLy8KICAgICAgICBsZWZ0LmJsdWUgPT09IHJpZ2h0LmJsdWUgJiYgLy8KICAgICAgICBsZWZ0LmFscGhhID09PSByaWdodC5hbHBoYTsKICAgICAgfTsKICAgICAgQ29sb3IuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihjb2xvciwgYXJyYXksIG9mZnNldCkgewogICAgICAgIHJldHVybiBjb2xvci5yZWQgPT09IGFycmF5W29mZnNldF0gJiYgY29sb3IuZ3JlZW4gPT09IGFycmF5W29mZnNldCArIDFdICYmIGNvbG9yLmJsdWUgPT09IGFycmF5W29mZnNldCArIDJdICYmIGNvbG9yLmFscGhhID09PSBhcnJheVtvZmZzZXQgKyAzXTsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIENvbG9yLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIHJldHVybiBDb2xvci5lcXVhbHModGhpcywgb3RoZXIpOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKG90aGVyLCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIHRoaXMgPT09IG90aGVyIHx8IC8vCiAgICAgICAgZGVmaW5lZF9kZWZhdWx0KG90aGVyKSAmJiAvLwogICAgICAgIE1hdGguYWJzKHRoaXMucmVkIC0gb3RoZXIucmVkKSA8PSBlcHNpbG9uICYmIC8vCiAgICAgICAgTWF0aC5hYnModGhpcy5ncmVlbiAtIG90aGVyLmdyZWVuKSA8PSBlcHNpbG9uICYmIC8vCiAgICAgICAgTWF0aC5hYnModGhpcy5ibHVlIC0gb3RoZXIuYmx1ZSkgPD0gZXBzaWxvbiAmJiAvLwogICAgICAgIE1hdGguYWJzKHRoaXMuYWxwaGEgLSBvdGhlci5hbHBoYSkgPD0gZXBzaWxvbjsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLnJlZH0sICR7dGhpcy5ncmVlbn0sICR7dGhpcy5ibHVlfSwgJHt0aGlzLmFscGhhfSlgOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUudG9Dc3NDb2xvclN0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IHJlZCA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMucmVkKTsKICAgICAgICBjb25zdCBncmVlbiA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuZ3JlZW4pOwogICAgICAgIGNvbnN0IGJsdWUgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmJsdWUpOwogICAgICAgIGlmICh0aGlzLmFscGhhID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gYHJnYigke3JlZH0sJHtncmVlbn0sJHtibHVlfSlgOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYHJnYmEoJHtyZWR9LCR7Z3JlZW59LCR7Ymx1ZX0sJHt0aGlzLmFscGhhfSlgOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUudG9Dc3NIZXhTdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgciA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMucmVkKS50b1N0cmluZygxNik7CiAgICAgICAgaWYgKHIubGVuZ3RoIDwgMikgewogICAgICAgICAgciA9IGAwJHtyfWA7CiAgICAgICAgfQogICAgICAgIGxldCBnID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ncmVlbikudG9TdHJpbmcoMTYpOwogICAgICAgIGlmIChnLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIGcgPSBgMCR7Z31gOwogICAgICAgIH0KICAgICAgICBsZXQgYiA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYmx1ZSkudG9TdHJpbmcoMTYpOwogICAgICAgIGlmIChiLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIGIgPSBgMCR7Yn1gOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5hbHBoYSA8IDEpIHsKICAgICAgICAgIGxldCBoZXhBbHBoYSA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYWxwaGEpLnRvU3RyaW5nKDE2KTsKICAgICAgICAgIGlmIChoZXhBbHBoYS5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgIGhleEFscGhhID0gYDAke2hleEFscGhhfWA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYCMke3J9JHtnfSR7Yn0ke2hleEFscGhhfWA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBgIyR7cn0ke2d9JHtifWA7CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS50b0J5dGVzID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgY29uc3QgcmVkID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5yZWQpOwogICAgICAgIGNvbnN0IGdyZWVuID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ncmVlbik7CiAgICAgICAgY29uc3QgYmx1ZSA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYmx1ZSk7CiAgICAgICAgY29uc3QgYWxwaGEgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmFscGhhKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gW3JlZCwgZ3JlZW4sIGJsdWUsIGFscGhhXTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gcmVkOwogICAgICAgIHJlc3VsdFsxXSA9IGdyZWVuOwogICAgICAgIHJlc3VsdFsyXSA9IGJsdWU7CiAgICAgICAgcmVzdWx0WzNdID0gYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLnRvUmdiYSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzBdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5yZWQpOwogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzFdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ncmVlbik7CiAgICAgICAgc2NyYXRjaFVpbnQ4QXJyYXlbMl0gPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmJsdWUpOwogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzNdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5hbHBoYSk7CiAgICAgICAgcmV0dXJuIHNjcmF0Y2hVaW50MzJBcnJheVswXTsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLmJyaWdodGVuID0gZnVuY3Rpb24obWFnbml0dWRlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIG1hZ25pdHVkZSA9IDEgLSBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnJlZCA9IDEgLSAoMSAtIHRoaXMucmVkKSAqIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQuZ3JlZW4gPSAxIC0gKDEgLSB0aGlzLmdyZWVuKSAqIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQuYmx1ZSA9IDEgLSAoMSAtIHRoaXMuYmx1ZSkgKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gdGhpcy5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUuZGFya2VuID0gZnVuY3Rpb24obWFnbml0dWRlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIG1hZ25pdHVkZSA9IDEgLSBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnJlZCA9IHRoaXMucmVkICogbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IHRoaXMuZ3JlZW4gKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmJsdWUgPSB0aGlzLmJsdWUgKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gdGhpcy5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUud2l0aEFscGhhID0gZnVuY3Rpb24oYWxwaGEsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBDb2xvci5mcm9tQWxwaGEodGhpcywgYWxwaGEsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENvbG9yLmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gbGVmdC5yZWQgKyByaWdodC5yZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gbGVmdC5ncmVlbiArIHJpZ2h0LmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gbGVmdC5ibHVlICsgcmlnaHQuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBsZWZ0LmFscGhhICsgcmlnaHQuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3Iuc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnJlZCA9IGxlZnQucmVkIC0gcmlnaHQucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGxlZnQuZ3JlZW4gLSByaWdodC5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGxlZnQuYmx1ZSAtIHJpZ2h0LmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gbGVmdC5hbHBoYSAtIHJpZ2h0LmFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLm11bHRpcGx5ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBsZWZ0LnJlZCAqIHJpZ2h0LnJlZDsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBsZWZ0LmdyZWVuICogcmlnaHQuZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBsZWZ0LmJsdWUgKiByaWdodC5ibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGxlZnQuYWxwaGEgKiByaWdodC5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5kaXZpZGUgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnJlZCA9IGxlZnQucmVkIC8gcmlnaHQucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGxlZnQuZ3JlZW4gLyByaWdodC5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGxlZnQuYmx1ZSAvIHJpZ2h0LmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gbGVmdC5hbHBoYSAvIHJpZ2h0LmFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLm1vZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gbGVmdC5yZWQgJSByaWdodC5yZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gbGVmdC5ncmVlbiAlIHJpZ2h0LmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gbGVmdC5ibHVlICUgcmlnaHQuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBsZWZ0LmFscGhhICUgcmlnaHQuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IubGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gTWF0aF9kZWZhdWx0LmxlcnAoc3RhcnQucmVkLCBlbmQucmVkLCB0KTsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBNYXRoX2RlZmF1bHQubGVycChzdGFydC5ncmVlbiwgZW5kLmdyZWVuLCB0KTsKICAgICAgICByZXN1bHQuYmx1ZSA9IE1hdGhfZGVmYXVsdC5sZXJwKHN0YXJ0LmJsdWUsIGVuZC5ibHVlLCB0KTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBNYXRoX2RlZmF1bHQubGVycChzdGFydC5hbHBoYSwgZW5kLmFscGhhLCB0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24oY29sb3IsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBjb2xvci5yZWQgKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gY29sb3IuZ3JlZW4gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmJsdWUgPSBjb2xvci5ibHVlICogc2NhbGFyOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGNvbG9yLmFscGhhICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24oY29sb3IsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBjb2xvci5yZWQgLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gY29sb3IuZ3JlZW4gLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmJsdWUgPSBjb2xvci5ibHVlIC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGNvbG9yLmFscGhhIC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLkFMSUNFQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjBGOEZGIikpOwogICAgICBDb2xvci5BTlRJUVVFV0hJVEUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZBRUJENyIpKTsKICAgICAgQ29sb3IuQVFVQSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBGRkZGIikpOwogICAgICBDb2xvci5BUVVBTUFSSU5FID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3RkZGRDQiKSk7CiAgICAgIENvbG9yLkFaVVJFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGMEZGRkYiKSk7CiAgICAgIENvbG9yLkJFSUdFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNUY1REMiKSk7CiAgICAgIENvbG9yLkJJU1FVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZFNEM0IikpOwogICAgICBDb2xvci5CTEFDSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDAwMDAwIikpOwogICAgICBDb2xvci5CTEFOQ0hFREFMTU9ORCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZFQkNEIikpOwogICAgICBDb2xvci5CTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMDAwRkYiKSk7CiAgICAgIENvbG9yLkJMVUVWSU9MRVQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzhBMkJFMiIpKTsKICAgICAgQ29sb3IuQlJPV04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0E1MkEyQSIpKTsKICAgICAgQ29sb3IuQlVSTFlXT09EID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNERUI4ODciKSk7CiAgICAgIENvbG9yLkNBREVUQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNUY5RUEwIikpOwogICAgICBDb2xvci5DSEFSVFJFVVNFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3RkZGMDAiKSk7CiAgICAgIENvbG9yLkNIT0NPTEFURSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDI2OTFFIikpOwogICAgICBDb2xvci5DT1JBTCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkY3RjUwIikpOwogICAgICBDb2xvci5DT1JORkxPV0VSQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNjQ5NUVEIikpOwogICAgICBDb2xvci5DT1JOU0lMSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGOERDIikpOwogICAgICBDb2xvci5DUklNU09OID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQzE0M0MiKSk7CiAgICAgIENvbG9yLkNZQU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwRkZGRiIpKTsKICAgICAgQ29sb3IuREFSS0JMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwMDA4QiIpKTsKICAgICAgQ29sb3IuREFSS0NZQU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwOEI4QiIpKTsKICAgICAgQ29sb3IuREFSS0dPTERFTlJPRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQjg4NjBCIikpOwogICAgICBDb2xvci5EQVJLR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQTlBOUE5IikpOwogICAgICBDb2xvci5EQVJLR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwNjQwMCIpKTsKICAgICAgQ29sb3IuREFSS0dSRVkgPSBDb2xvci5EQVJLR1JBWTsKICAgICAgQ29sb3IuREFSS0tIQUtJID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCREI3NkIiKSk7CiAgICAgIENvbG9yLkRBUktNQUdFTlRBID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QjAwOEIiKSk7CiAgICAgIENvbG9yLkRBUktPTElWRUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM1NTZCMkYiKSk7CiAgICAgIENvbG9yLkRBUktPUkFOR0UgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGOEMwMCIpKTsKICAgICAgQ29sb3IuREFSS09SQ0hJRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOTkzMkNDIikpOwogICAgICBDb2xvci5EQVJLUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QjAwMDAiKSk7CiAgICAgIENvbG9yLkRBUktTQUxNT04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0U5OTY3QSIpKTsKICAgICAgQ29sb3IuREFSS1NFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4RkJDOEYiKSk7CiAgICAgIENvbG9yLkRBUktTTEFURUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzQ4M0Q4QiIpKTsKICAgICAgQ29sb3IuREFSS1NMQVRFR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMkY0RjRGIikpOwogICAgICBDb2xvci5EQVJLU0xBVEVHUkVZID0gQ29sb3IuREFSS1NMQVRFR1JBWTsKICAgICAgQ29sb3IuREFSS1RVUlFVT0lTRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBDRUQxIikpOwogICAgICBDb2xvci5EQVJLVklPTEVUID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5NDAwRDMiKSk7CiAgICAgIENvbG9yLkRFRVBQSU5LID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRjE0OTMiKSk7CiAgICAgIENvbG9yLkRFRVBTS1lCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMEJGRkYiKSk7CiAgICAgIENvbG9yLkRJTUdSQVkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzY5Njk2OSIpKTsKICAgICAgQ29sb3IuRElNR1JFWSA9IENvbG9yLkRJTUdSQVk7CiAgICAgIENvbG9yLkRPREdFUkJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzFFOTBGRiIpKTsKICAgICAgQ29sb3IuRklSRUJSSUNLID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCMjIyMjIiKSk7CiAgICAgIENvbG9yLkZMT1JBTFdISVRFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZBRjAiKSk7CiAgICAgIENvbG9yLkZPUkVTVEdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMyMjhCMjIiKSk7CiAgICAgIENvbG9yLkZVQ0hTSUEgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGMDBGRiIpKTsKICAgICAgQ29sb3IuR0FJTlNCT1JPID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQ0RDREMiKSk7CiAgICAgIENvbG9yLkdIT1NUV0hJVEUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0Y4RjhGRiIpKTsKICAgICAgQ29sb3IuR09MRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZENzAwIikpOwogICAgICBDb2xvci5HT0xERU5ST0QgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0RBQTUyMCIpKTsKICAgICAgQ29sb3IuR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODA4MDgwIikpOwogICAgICBDb2xvci5HUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDA4MDAwIikpOwogICAgICBDb2xvci5HUkVFTllFTExPVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQURGRjJGIikpOwogICAgICBDb2xvci5HUkVZID0gQ29sb3IuR1JBWTsKICAgICAgQ29sb3IuSE9ORVlERVcgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0YwRkZGMCIpKTsKICAgICAgQ29sb3IuSE9UUElOSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkY2OUI0IikpOwogICAgICBDb2xvci5JTkRJQU5SRUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0NENUM1QyIpKTsKICAgICAgQ29sb3IuSU5ESUdPID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0QjAwODIiKSk7CiAgICAgIENvbG9yLklWT1JZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZGRjAiKSk7CiAgICAgIENvbG9yLktIQUtJID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGMEU2OEMiKSk7CiAgICAgIENvbG9yLkxBVkVOREVSID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNFNkU2RkEiKSk7CiAgICAgIENvbG9yLkxBVkVOREFSX0JMVVNIID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkYwRjUiKSk7CiAgICAgIENvbG9yLkxBV05HUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjN0NGQzAwIikpOwogICAgICBDb2xvci5MRU1PTkNISUZGT04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRkFDRCIpKTsKICAgICAgQ29sb3IuTElHSFRCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNBREQ4RTYiKSk7CiAgICAgIENvbG9yLkxJR0hUQ09SQUwgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0YwODA4MCIpKTsKICAgICAgQ29sb3IuTElHSFRDWUFOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNFMEZGRkYiKSk7CiAgICAgIENvbG9yLkxJR0hUR09MREVOUk9EWUVMTE9XID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGQUZBRDIiKSk7CiAgICAgIENvbG9yLkxJR0hUR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDNEM0QzIikpOwogICAgICBDb2xvci5MSUdIVEdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5MEVFOTAiKSk7CiAgICAgIENvbG9yLkxJR0hUR1JFWSA9IENvbG9yLkxJR0hUR1JBWTsKICAgICAgQ29sb3IuTElHSFRQSU5LID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkI2QzEiKSk7CiAgICAgIENvbG9yLkxJR0hUU0VBR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzIwQjJBQSIpKTsKICAgICAgQ29sb3IuTElHSFRTS1lCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4N0NFRkEiKSk7CiAgICAgIENvbG9yLkxJR0hUU0xBVEVHUkFZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3Nzg4OTkiKSk7CiAgICAgIENvbG9yLkxJR0hUU0xBVEVHUkVZID0gQ29sb3IuTElHSFRTTEFURUdSQVk7CiAgICAgIENvbG9yLkxJR0hUU1RFRUxCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCMEM0REUiKSk7CiAgICAgIENvbG9yLkxJR0hUWUVMTE9XID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZGRTAiKSk7CiAgICAgIENvbG9yLkxJTUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwRkYwMCIpKTsKICAgICAgQ29sb3IuTElNRUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMzMkNEMzIiKSk7CiAgICAgIENvbG9yLkxJTkVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGQUYwRTYiKSk7CiAgICAgIENvbG9yLk1BR0VOVEEgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGMDBGRiIpKTsKICAgICAgQ29sb3IuTUFST09OID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4MDAwMDAiKSk7CiAgICAgIENvbG9yLk1FRElVTUFRVUFNQVJJTkUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzY2Q0RBQSIpKTsKICAgICAgQ29sb3IuTUVESVVNQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDAwMENEIikpOwogICAgICBDb2xvci5NRURJVU1PUkNISUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0JBNTVEMyIpKTsKICAgICAgQ29sb3IuTUVESVVNUFVSUExFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5MzcwREIiKSk7CiAgICAgIENvbG9yLk1FRElVTVNFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMzQ0IzNzEiKSk7CiAgICAgIENvbG9yLk1FRElVTVNMQVRFQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjN0I2OEVFIikpOwogICAgICBDb2xvci5NRURJVU1TUFJJTkdHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBGQTlBIikpOwogICAgICBDb2xvci5NRURJVU1UVVJRVU9JU0UgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzQ4RDFDQyIpKTsKICAgICAgQ29sb3IuTUVESVVNVklPTEVUUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNDNzE1ODUiKSk7CiAgICAgIENvbG9yLk1JRE5JR0hUQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMTkxOTcwIikpOwogICAgICBDb2xvci5NSU5UQ1JFQU0gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0Y1RkZGQSIpKTsKICAgICAgQ29sb3IuTUlTVFlST1NFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkU0RTEiKSk7CiAgICAgIENvbG9yLk1PQ0NBU0lOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkU0QjUiKSk7CiAgICAgIENvbG9yLk5BVkFKT1dISVRFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkRFQUQiKSk7CiAgICAgIENvbG9yLk5BVlkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwMDA4MCIpKTsKICAgICAgQ29sb3IuT0xETEFDRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkRGNUU2IikpOwogICAgICBDb2xvci5PTElWRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODA4MDAwIikpOwogICAgICBDb2xvci5PTElWRURSQUIgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzZCOEUyMyIpKTsKICAgICAgQ29sb3IuT1JBTkdFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkE1MDAiKSk7CiAgICAgIENvbG9yLk9SQU5HRVJFRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkY0NTAwIikpOwogICAgICBDb2xvci5PUkNISUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0RBNzBENiIpKTsKICAgICAgQ29sb3IuUEFMRUdPTERFTlJPRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRUVFOEFBIikpOwogICAgICBDb2xvci5QQUxFR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzk4RkI5OCIpKTsKICAgICAgQ29sb3IuUEFMRVRVUlFVT0lTRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQUZFRUVFIikpOwogICAgICBDb2xvci5QQUxFVklPTEVUUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQjcwOTMiKSk7CiAgICAgIENvbG9yLlBBUEFZQVdISVAgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRUZENSIpKTsKICAgICAgQ29sb3IuUEVBQ0hQVUZGID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkRBQjkiKSk7CiAgICAgIENvbG9yLlBFUlUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0NEODUzRiIpKTsKICAgICAgQ29sb3IuUElOSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZDMENCIikpOwogICAgICBDb2xvci5QTFVNID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEREEwREQiKSk7CiAgICAgIENvbG9yLlBPV0RFUkJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0IwRTBFNiIpKTsKICAgICAgQ29sb3IuUFVSUExFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4MDAwODAiKSk7CiAgICAgIENvbG9yLlJFRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkYwMDAwIikpOwogICAgICBDb2xvci5ST1NZQlJPV04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0JDOEY4RiIpKTsKICAgICAgQ29sb3IuUk9ZQUxCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0MTY5RTEiKSk7CiAgICAgIENvbG9yLlNBRERMRUJST1dOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QjQ1MTMiKSk7CiAgICAgIENvbG9yLlNBTE1PTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkE4MDcyIikpOwogICAgICBDb2xvci5TQU5EWUJST1dOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNEE0NjAiKSk7CiAgICAgIENvbG9yLlNFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMyRThCNTciKSk7CiAgICAgIENvbG9yLlNFQVNIRUxMID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkY1RUUiKSk7CiAgICAgIENvbG9yLlNJRU5OQSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQTA1MjJEIikpOwogICAgICBDb2xvci5TSUxWRVIgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0MwQzBDMCIpKTsKICAgICAgQ29sb3IuU0tZQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODdDRUVCIikpOwogICAgICBDb2xvci5TTEFURUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzZBNUFDRCIpKTsKICAgICAgQ29sb3IuU0xBVEVHUkFZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3MDgwOTAiKSk7CiAgICAgIENvbG9yLlNMQVRFR1JFWSA9IENvbG9yLlNMQVRFR1JBWTsKICAgICAgQ29sb3IuU05PVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGQUZBIikpOwogICAgICBDb2xvci5TUFJJTkdHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBGRjdGIikpOwogICAgICBDb2xvci5TVEVFTEJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzQ2ODJCNCIpKTsKICAgICAgQ29sb3IuVEFOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEMkI0OEMiKSk7CiAgICAgIENvbG9yLlRFQUwgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwODA4MCIpKTsKICAgICAgQ29sb3IuVEhJU1RMRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDhCRkQ4IikpOwogICAgICBDb2xvci5UT01BVE8gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGNjM0NyIpKTsKICAgICAgQ29sb3IuVFVSUVVPSVNFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0MEUwRDAiKSk7CiAgICAgIENvbG9yLlZJT0xFVCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRUU4MkVFIikpOwogICAgICBDb2xvci5XSEVBVCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjVERUIzIikpOwogICAgICBDb2xvci5XSElURSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGRkZGIikpOwogICAgICBDb2xvci5XSElURVNNT0tFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNUY1RjUiKSk7CiAgICAgIENvbG9yLllFTExPVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGRjAwIikpOwogICAgICBDb2xvci5ZRUxMT1dHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOUFDRDMyIikpOwogICAgICBDb2xvci5UUkFOU1BBUkVOVCA9IE9iamVjdC5mcmVlemUobmV3IENvbG9yKDAsIDAsIDAsIDApKTsKICAgICAgQ29sb3JfZGVmYXVsdCA9IENvbG9yOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGludGVycG9sYXRlQ29sb3JzKHAwLCBwMSwgY29sb3IwLCBjb2xvcjEsIG51bVBvaW50cykgewogICAgY29uc3QgY29sb3JzID0gc2NyYXRjaEludGVycG9sYXRlQ29sb3JzQXJyYXk7CiAgICBjb2xvcnMubGVuZ3RoID0gbnVtUG9pbnRzOwogICAgbGV0IGk7CiAgICBjb25zdCByMCA9IGNvbG9yMC5yZWQ7CiAgICBjb25zdCBnMCA9IGNvbG9yMC5ncmVlbjsKICAgIGNvbnN0IGIwID0gY29sb3IwLmJsdWU7CiAgICBjb25zdCBhMCA9IGNvbG9yMC5hbHBoYTsKICAgIGNvbnN0IHIxID0gY29sb3IxLnJlZDsKICAgIGNvbnN0IGcxID0gY29sb3IxLmdyZWVuOwogICAgY29uc3QgYjEgPSBjb2xvcjEuYmx1ZTsKICAgIGNvbnN0IGExID0gY29sb3IxLmFscGhhOwogICAgaWYgKENvbG9yX2RlZmF1bHQuZXF1YWxzKGNvbG9yMCwgY29sb3IxKSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICBjb2xvcnNbaV0gPSBDb2xvcl9kZWZhdWx0LmNsb25lKGNvbG9yMCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbG9yczsKICAgIH0KICAgIGNvbnN0IHJlZFBlclZlcnRleCA9IChyMSAtIHIwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGdyZWVuUGVyVmVydGV4ID0gKGcxIC0gZzApIC8gbnVtUG9pbnRzOwogICAgY29uc3QgYmx1ZVBlclZlcnRleCA9IChiMSAtIGIwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGFscGhhUGVyVmVydGV4ID0gKGExIC0gYTApIC8gbnVtUG9pbnRzOwogICAgZm9yIChpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGNvbG9yc1tpXSA9IG5ldyBDb2xvcl9kZWZhdWx0KAogICAgICAgIHIwICsgaSAqIHJlZFBlclZlcnRleCwKICAgICAgICBnMCArIGkgKiBncmVlblBlclZlcnRleCwKICAgICAgICBiMCArIGkgKiBibHVlUGVyVmVydGV4LAogICAgICAgIGEwICsgaSAqIGFscGhhUGVyVmVydGV4CiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gY29sb3JzOwogIH0KICBmdW5jdGlvbiBQb2x5bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCBjb2xvcnMgPSBvcHRpb25zLmNvbG9yczsKICAgIGNvbnN0IHdpZHRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy53aWR0aCwgMSk7CiAgICBjb25zdCBjb2xvcnNQZXJWZXJ0ZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvbG9yc1BlclZlcnRleCwgZmFsc2UpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoIDwgMikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQXQgbGVhc3QgdHdvIHBvc2l0aW9ucyBhcmUgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAodHlwZW9mIHdpZHRoICE9PSAibnVtYmVyIikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgid2lkdGggbXVzdCBiZSBhIG51bWJlciIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpICYmIChjb2xvcnNQZXJWZXJ0ZXggJiYgY29sb3JzLmxlbmd0aCA8IHBvc2l0aW9ucy5sZW5ndGggfHwgIWNvbG9yc1BlclZlcnRleCAmJiBjb2xvcnMubGVuZ3RoIDwgcG9zaXRpb25zLmxlbmd0aCAtIDEpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb2xvcnMgaGFzIGFuIGludmFsaWQgbGVuZ3RoLiIpOwogICAgfQogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fY29sb3JzID0gY29sb3JzOwogICAgdGhpcy5fd2lkdGggPSB3aWR0aDsKICAgIHRoaXMuX2NvbG9yc1BlclZlcnRleCA9IGNvbG9yc1BlclZlcnRleDsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCkKICAgICk7CiAgICB0aGlzLl9hcmNUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hcmNUeXBlLCBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCkKICAgICk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBvbHlsaW5lR2VvbWV0cnkiOwogICAgbGV0IG51bUNvbXBvbmVudHMgPSAxICsgcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBudW1Db21wb25lbnRzICs9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gMSArIGNvbG9ycy5sZW5ndGggKiBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCA6IDE7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IG51bUNvbXBvbmVudHMgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA0OwogIH0KICB2YXIgc2NyYXRjaEludGVycG9sYXRlQ29sb3JzQXJyYXksIHNjcmF0Y2hFbGxpcHNvaWQ4LCBzY3JhdGNoVmVydGV4Rm9ybWF0MTAsIHNjcmF0Y2hPcHRpb25zMTYsIHNjcmF0Y2hDYXJ0ZXNpYW4zOCwgc2NyYXRjaFBvc2l0aW9uNCwgc2NyYXRjaFByZXZQb3NpdGlvbiwgc2NyYXRjaE5leHRQb3NpdGlvbiwgUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db2xvcigpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5VHlwZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWxpbmVQaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgc2NyYXRjaEludGVycG9sYXRlQ29sb3JzQXJyYXkgPSBbXTsKICAgICAgUG9seWxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbG9ycyA9IHZhbHVlLl9jb2xvcnM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyBjb2xvcnMubGVuZ3RoIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ29sb3JfZGVmYXVsdC5wYWNrKGNvbG9yc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3dpZHRoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY29sb3JzUGVyVmVydGV4ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9hcmNUeXBlOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDggPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMCA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczE2ID0gewogICAgICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIGNvbG9yczogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDgsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0MTAsCiAgICAgICAgd2lkdGg6IHZvaWQgMCwKICAgICAgICBjb2xvcnNQZXJWZXJ0ZXg6IHZvaWQgMCwKICAgICAgICBhcmNUeXBlOiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMAogICAgICB9OwogICAgICBQb2x5bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGNvbG9ycyA9IGxlbmd0aCA+IDAgPyBuZXcgQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIGNvbG9yc1tpXSA9IENvbG9yX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkOCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDEwCiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB3aWR0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgY29sb3JzUGVyVmVydGV4ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBhcmNUeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTYucG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNi5jb2xvcnMgPSBjb2xvcnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE2LndpZHRoID0gd2lkdGg7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE2LmNvbG9yc1BlclZlcnRleCA9IGNvbG9yc1BlclZlcnRleDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTYuYXJjVHlwZSA9IGFyY1R5cGU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE2LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFBvbHlsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxNik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fY29sb3JzID0gY29sb3JzOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX3dpZHRoID0gd2lkdGg7CiAgICAgICAgcmVzdWx0Ll9jb2xvcnNQZXJWZXJ0ZXggPSBjb2xvcnNQZXJWZXJ0ZXg7CiAgICAgICAgcmVzdWx0Ll9hcmNUeXBlID0gYXJjVHlwZTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM4ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUG9zaXRpb240ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJldlBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTmV4dFBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocG9seWxpbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHdpZHRoID0gcG9seWxpbmVHZW9tZXRyeS5fd2lkdGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gcG9seWxpbmVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGxldCBjb2xvcnMgPSBwb2x5bGluZUdlb21ldHJ5Ll9jb2xvcnM7CiAgICAgICAgY29uc3QgY29sb3JzUGVyVmVydGV4ID0gcG9seWxpbmVHZW9tZXRyeS5fY29sb3JzUGVyVmVydGV4OwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBwb2x5bGluZUdlb21ldHJ5Ll9hcmNUeXBlOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcG9seWxpbmVHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBqOwogICAgICAgIGxldCBrOwogICAgICAgIGNvbnN0IHJlbW92ZWRJbmRpY2VzID0gW107CiAgICAgICAgbGV0IHBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgcG9seWxpbmVHZW9tZXRyeS5fcG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24sCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIHJlbW92ZWRJbmRpY2VzCiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgJiYgcmVtb3ZlZEluZGljZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgbGV0IHJlbW92ZWRBcnJheUluZGV4ID0gMDsKICAgICAgICAgIGxldCBuZXh0UmVtb3ZlZEluZGV4ID0gcmVtb3ZlZEluZGljZXNbMF07CiAgICAgICAgICBjb2xvcnMgPSBjb2xvcnMuZmlsdGVyKGZ1bmN0aW9uKGNvbG9yLCBpbmRleDIpIHsKICAgICAgICAgICAgbGV0IHJlbW92ZSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoY29sb3JzUGVyVmVydGV4KSB7CiAgICAgICAgICAgICAgcmVtb3ZlID0gaW5kZXgyID09PSBuZXh0UmVtb3ZlZEluZGV4IHx8IGluZGV4MiA9PT0gMCAmJiBuZXh0UmVtb3ZlZEluZGV4ID09PSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlbW92ZSA9IGluZGV4MiArIDEgPT09IG5leHRSZW1vdmVkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlbW92ZSkgewogICAgICAgICAgICAgIHJlbW92ZWRBcnJheUluZGV4Kys7CiAgICAgICAgICAgICAgbmV4dFJlbW92ZWRJbmRleCA9IHJlbW92ZWRJbmRpY2VzW3JlbW92ZWRBcnJheUluZGV4XTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgbGV0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgaWYgKHBvc2l0aW9uc0xlbmd0aCA8IDIgfHwgd2lkdGggPD0gMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyB8fCBhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgIGxldCBzdWJkaXZpc2lvblNpemU7CiAgICAgICAgICBsZXQgbnVtYmVyT2ZQb2ludHNGdW5jdGlvbjsKICAgICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgc3ViZGl2aXNpb25TaXplID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG51bWJlck9mUG9pbnRzRnVuY3Rpb24gPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQubnVtYmVyT2ZQb2ludHM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdWJkaXZpc2lvblNpemUgPSBncmFudWxhcml0eTsKICAgICAgICAgICAgbnVtYmVyT2ZQb2ludHNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5udW1iZXJPZlBvaW50c1JodW1iTGluZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGhlaWdodHMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZXh0cmFjdEhlaWdodHMocG9zaXRpb25zLCBlbGxpcHNvaWQpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpKSB7CiAgICAgICAgICAgIGxldCBjb2xvckxlbmd0aCA9IDE7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGggLSAxOyArK2kpIHsKICAgICAgICAgICAgICBjb2xvckxlbmd0aCArPSBudW1iZXJPZlBvaW50c0Z1bmN0aW9uKAogICAgICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxXSwKICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uU2l6ZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgbmV3Q29sb3JzID0gbmV3IEFycmF5KGNvbG9yTGVuZ3RoKTsKICAgICAgICAgICAgbGV0IG5ld0NvbG9ySW5kZXggPSAwOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoIC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgY29uc3QgcDAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgICAgY29uc3QgcDEgPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgICAgIGNvbnN0IGMwID0gY29sb3JzW2ldOwogICAgICAgICAgICAgIGNvbnN0IG51bUNvbG9ycyA9IG51bWJlck9mUG9pbnRzRnVuY3Rpb24ocDAsIHAxLCBzdWJkaXZpc2lvblNpemUpOwogICAgICAgICAgICAgIGlmIChjb2xvcnNQZXJWZXJ0ZXggJiYgaSA8IGNvbG9yTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjMSA9IGNvbG9yc1tpICsgMV07CiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnBvbGF0ZWRDb2xvcnMgPSBpbnRlcnBvbGF0ZUNvbG9ycygKICAgICAgICAgICAgICAgICAgcDAsCiAgICAgICAgICAgICAgICAgIHAxLAogICAgICAgICAgICAgICAgICBjMCwKICAgICAgICAgICAgICAgICAgYzEsCiAgICAgICAgICAgICAgICAgIG51bUNvbG9ycwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGNvbnN0IGludGVycG9sYXRlZENvbG9yc0xlbmd0aCA9IGludGVycG9sYXRlZENvbG9ycy5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgaW50ZXJwb2xhdGVkQ29sb3JzTGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICAgICAgbmV3Q29sb3JzW25ld0NvbG9ySW5kZXgrK10gPSBpbnRlcnBvbGF0ZWRDb2xvcnNbal07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1Db2xvcnM7ICsraikgewogICAgICAgICAgICAgICAgICBuZXdDb2xvcnNbbmV3Q29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuY2xvbmUoYzApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDb2xvcnNbbmV3Q29sb3JJbmRleF0gPSBDb2xvcl9kZWZhdWx0LmNsb25lKGNvbG9yc1tjb2xvcnMubGVuZ3RoIC0gMV0pOwogICAgICAgICAgICBjb2xvcnMgPSBuZXdDb2xvcnM7CiAgICAgICAgICAgIHNjcmF0Y2hJbnRlcnBvbGF0ZUNvbG9yc0FycmF5Lmxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgIHBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUNhcnRlc2lhbkFyYyh7CiAgICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICAgIG1pbkRpc3RhbmNlOiBzdWJkaXZpc2lvblNpemUsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUNhcnRlc2lhblJodW1iQXJjKHsKICAgICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgICAgZ3JhbnVsYXJpdHk6IHN1YmRpdmlzaW9uU2l6ZSwKICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IHNpemUgPSBwb3NpdGlvbnNMZW5ndGggKiA0IC0gNDsKICAgICAgICBjb25zdCBmaW5hbFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSAqIDMpOwogICAgICAgIGNvbnN0IHByZXZQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgICAgICBjb25zdCBuZXh0UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICAgICAgY29uc3QgZXhwYW5kQW5kV2lkdGggPSBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKTsKICAgICAgICBjb25zdCBzdCA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IGZpbmFsQ29sb3JzID0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyBuZXcgVWludDhBcnJheShzaXplICogNCkgOiB2b2lkIDA7CiAgICAgICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgICAgIGxldCBleHBhbmRBbmRXaWR0aEluZGV4ID0gMDsKICAgICAgICBsZXQgc3RJbmRleCA9IDA7CiAgICAgICAgbGV0IGNvbG9ySW5kZXggPSAwOwogICAgICAgIGxldCBwb3NpdGlvbjsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgcG9zaXRpb25zTGVuZ3RoOyArK2opIHsKICAgICAgICAgIGlmIChqID09PSAwKSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gc2NyYXRjaENhcnRlc2lhbjM4OwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9zaXRpb25zWzBdLCBwb3NpdGlvbnNbMV0sIHBvc2l0aW9uKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbnNbMF0sIHBvc2l0aW9uLCBwb3NpdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uc1tqIC0gMV07CiAgICAgICAgICB9CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHNjcmF0Y2hQcmV2UG9zaXRpb24pOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uc1tqXSwgc2NyYXRjaFBvc2l0aW9uNCk7CiAgICAgICAgICBpZiAoaiA9PT0gcG9zaXRpb25zTGVuZ3RoIC0gMSkgewogICAgICAgICAgICBwb3NpdGlvbiA9IHNjcmF0Y2hDYXJ0ZXNpYW4zODsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbnNMZW5ndGggLSAxXSwKICAgICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25zTGVuZ3RoIC0gMl0sCiAgICAgICAgICAgICAgcG9zaXRpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbnNbcG9zaXRpb25zTGVuZ3RoIC0gMV0sIHBvc2l0aW9uLCBwb3NpdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uc1tqICsgMV07CiAgICAgICAgICB9CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHNjcmF0Y2hOZXh0UG9zaXRpb24pOwogICAgICAgICAgbGV0IGNvbG9yMCwgY29sb3IxOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChmaW5hbENvbG9ycykpIHsKICAgICAgICAgICAgaWYgKGogIT09IDAgJiYgIWNvbG9yc1BlclZlcnRleCkgewogICAgICAgICAgICAgIGNvbG9yMCA9IGNvbG9yc1tqIC0gMV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29sb3IwID0gY29sb3JzW2pdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChqICE9PSBwb3NpdGlvbnNMZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgY29sb3IxID0gY29sb3JzW2pdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBzdGFydEsgPSBqID09PSAwID8gMiA6IDA7CiAgICAgICAgICBjb25zdCBlbmRLID0gaiA9PT0gcG9zaXRpb25zTGVuZ3RoIC0gMSA/IDIgOiA0OwogICAgICAgICAgZm9yIChrID0gc3RhcnRLOyBrIDwgZW5kSzsgKytrKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHNjcmF0Y2hQb3NpdGlvbjQsIGZpbmFsUG9zaXRpb25zLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc2NyYXRjaFByZXZQb3NpdGlvbiwgcHJldlBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHNjcmF0Y2hOZXh0UG9zaXRpb24sIG5leHRQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgICBwb3NpdGlvbkluZGV4ICs9IDM7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBrIC0gMiA8IDAgPyAtMSA6IDE7CiAgICAgICAgICAgIGV4cGFuZEFuZFdpZHRoW2V4cGFuZEFuZFdpZHRoSW5kZXgrK10gPSAyICogKGsgJSAyKSAtIDE7CiAgICAgICAgICAgIGV4cGFuZEFuZFdpZHRoW2V4cGFuZEFuZFdpZHRoSW5kZXgrK10gPSBkaXJlY3Rpb24yICogd2lkdGg7CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgICAgICBzdFtzdEluZGV4KytdID0gaiAvIChwb3NpdGlvbnNMZW5ndGggLSAxKTsKICAgICAgICAgICAgICBzdFtzdEluZGV4KytdID0gTWF0aC5tYXgoZXhwYW5kQW5kV2lkdGhbZXhwYW5kQW5kV2lkdGhJbmRleCAtIDJdLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGZpbmFsQ29sb3JzKSkgewogICAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gayA8IDIgPyBjb2xvcjAgOiBjb2xvcjE7CiAgICAgICAgICAgICAgZmluYWxDb2xvcnNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IucmVkKTsKICAgICAgICAgICAgICBmaW5hbENvbG9yc1tjb2xvckluZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ncmVlbik7CiAgICAgICAgICAgICAgZmluYWxDb2xvcnNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYmx1ZSk7CiAgICAgICAgICAgICAgZmluYWxDb2xvcnNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYWxwaGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogZmluYWxQb3NpdGlvbnMKICAgICAgICB9KTsKICAgICAgICBhdHRyaWJ1dGVzLnByZXZQb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IHByZXZQb3NpdGlvbnMKICAgICAgICB9KTsKICAgICAgICBhdHRyaWJ1dGVzLm5leHRQb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IG5leHRQb3NpdGlvbnMKICAgICAgICB9KTsKICAgICAgICBhdHRyaWJ1dGVzLmV4cGFuZEFuZFdpZHRoID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgdmFsdWVzOiBleHBhbmRBbmRXaWR0aAogICAgICAgIH0pOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IHN0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChmaW5hbENvbG9ycykpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuY29sb3IgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDQsCiAgICAgICAgICAgIHZhbHVlczogZmluYWxDb2xvcnMsCiAgICAgICAgICAgIG5vcm1hbGl6ZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShzaXplLCBwb3NpdGlvbnNMZW5ndGggKiA2IC0gNik7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBsZXQgaW5kaWNlc0luZGV4ID0gMDsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnNMZW5ndGggLSAxOwogICAgICAgIGZvciAoaiA9IDA7IGogPCBsZW5ndGg7ICsraikgewogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleDsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAyOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMTsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAyOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDM7CiAgICAgICAgICBpbmRleCArPSA0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMpLAogICAgICAgICAgZ2VvbWV0cnlUeXBlOiBHZW9tZXRyeVR5cGVfZGVmYXVsdC5QT0xZTElORVMKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUG9seWxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5bGluZUdlb21ldHJ5KHBvbHlsaW5lR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBvbHlsaW5lR2VvbWV0cnkgPSBQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHBvbHlsaW5lR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBwb2x5bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwb2x5bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShwb2x5bGluZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVQb2x5bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVWb2x1bWVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNvbXB1dGVBdHRyaWJ1dGVzMihjb21iaW5lZFBvc2l0aW9ucywgc2hhcGUsIGJvdW5kaW5nUmVjdGFuZ2xlLCB2ZXJ0ZXhGb3JtYXQpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGNvbWJpbmVkUG9zaXRpb25zCiAgICAgIH0pOwogICAgfQogICAgY29uc3Qgc2hhcGVMZW5ndGggPSBzaGFwZS5sZW5ndGg7CiAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IGNvbWJpbmVkUG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBsZW5ndGggPSAodmVydGV4Q291bnQgLSBzaGFwZUxlbmd0aCAqIDIpIC8gKHNoYXBlTGVuZ3RoICogMik7CiAgICBjb25zdCBmaXJzdEVuZEluZGljZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC50cmlhbmd1bGF0ZShzaGFwZSk7CiAgICBjb25zdCBpbmRpY2VzQ291bnQgPSAobGVuZ3RoIC0gMSkgKiBzaGFwZUxlbmd0aCAqIDYgKyBmaXJzdEVuZEluZGljZXMubGVuZ3RoICogMjsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSh2ZXJ0ZXhDb3VudCwgaW5kaWNlc0NvdW50KTsKICAgIGxldCBpLCBqOwogICAgbGV0IGxsLCB1bCwgdXIsIGxyOwogICAgY29uc3Qgb2Zmc2V0ID0gc2hhcGVMZW5ndGggKiAyOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgZm9yIChqID0gMDsgaiA8IHNoYXBlTGVuZ3RoIC0gMTsgaisrKSB7CiAgICAgICAgbGwgPSBqICogMiArIGkgKiBzaGFwZUxlbmd0aCAqIDI7CiAgICAgICAgbHIgPSBsbCArIG9mZnNldDsKICAgICAgICB1bCA9IGxsICsgMTsKICAgICAgICB1ciA9IHVsICsgb2Zmc2V0OwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB1bDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gbGw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHVyOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB1cjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gbGw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGxyOwogICAgICB9CiAgICAgIGxsID0gc2hhcGVMZW5ndGggKiAyIC0gMiArIGkgKiBzaGFwZUxlbmd0aCAqIDI7CiAgICAgIHVsID0gbGwgKyAxOwogICAgICB1ciA9IHVsICsgb2Zmc2V0OwogICAgICBsciA9IGxsICsgb2Zmc2V0OwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdWw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBsbDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHVyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdXI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBsbDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGxyOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGNvbnN0IHN0ID0gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhDb3VudCAqIDIpOwogICAgICBjb25zdCBsZW5ndGhTdCA9IDEgLyAobGVuZ3RoIC0gMSk7CiAgICAgIGNvbnN0IGhlaWdodFN0ID0gMSAvIGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodDsKICAgICAgY29uc3QgaGVpZ2h0T2Zmc2V0ID0gYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0IC8gMjsKICAgICAgbGV0IHMsIHQ7CiAgICAgIGxldCBzdGluZGV4ID0gMDsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgcyA9IGkgKiBsZW5ndGhTdDsKICAgICAgICB0ID0gaGVpZ2h0U3QgKiAoc2hhcGVbMF0ueSArIGhlaWdodE9mZnNldCk7CiAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHM7CiAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHQ7CiAgICAgICAgZm9yIChqID0gMTsgaiA8IHNoYXBlTGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHQgPSBoZWlnaHRTdCAqIChzaGFwZVtqXS55ICsgaGVpZ2h0T2Zmc2V0KTsKICAgICAgICAgIHN0W3N0aW5kZXgrK10gPSBzOwogICAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHQ7CiAgICAgICAgICBzdFtzdGluZGV4KytdID0gczsKICAgICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICAgIH0KICAgICAgICB0ID0gaGVpZ2h0U3QgKiAoc2hhcGVbMF0ueSArIGhlaWdodE9mZnNldCk7CiAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHM7CiAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHQ7CiAgICAgIH0KICAgICAgZm9yIChqID0gMDsgaiA8IHNoYXBlTGVuZ3RoOyBqKyspIHsKICAgICAgICBzID0gMDsKICAgICAgICB0ID0gaGVpZ2h0U3QgKiAoc2hhcGVbal0ueSArIGhlaWdodE9mZnNldCk7CiAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHM7CiAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHQ7CiAgICAgIH0KICAgICAgZm9yIChqID0gMDsgaiA8IHNoYXBlTGVuZ3RoOyBqKyspIHsKICAgICAgICBzID0gKGxlbmd0aCAtIDEpICogbGVuZ3RoU3Q7CiAgICAgICAgdCA9IGhlaWdodFN0ICogKHNoYXBlW2pdLnkgKyBoZWlnaHRPZmZzZXQpOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSBzOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IG5ldyBGbG9hdDMyQXJyYXkoc3QpCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgZW5kT2Zmc2V0ID0gdmVydGV4Q291bnQgLSBzaGFwZUxlbmd0aCAqIDI7CiAgICBmb3IgKGkgPSAwOyBpIDwgZmlyc3RFbmRJbmRpY2VzLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IHYwMiA9IGZpcnN0RW5kSW5kaWNlc1tpXSArIGVuZE9mZnNldDsKICAgICAgY29uc3QgdjEyID0gZmlyc3RFbmRJbmRpY2VzW2kgKyAxXSArIGVuZE9mZnNldDsKICAgICAgY29uc3QgdjIyID0gZmlyc3RFbmRJbmRpY2VzW2kgKyAyXSArIGVuZE9mZnNldDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHYwMjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHYxMjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHYyMjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHYyMiArIHNoYXBlTGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdjEyICsgc2hhcGVMZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MDIgKyBzaGFwZUxlbmd0aDsKICAgIH0KICAgIGxldCBnZW9tZXRyeSA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcywKICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKGNvbWJpbmVkUG9zaXRpb25zKSwKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgfSk7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBnZW9tZXRyeSA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlTm9ybWFsKGdlb21ldHJ5KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIHRyeSB7CiAgICAgICAgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVRhbmdlbnRBbmRCaXRhbmdlbnQoZ2VvbWV0cnkpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgb25lVGltZVdhcm5pbmdfZGVmYXVsdCgKICAgICAgICAgICJwb2x5bGluZS12b2x1bWUtdGFuZ2VudC1iaXRhbmdlbnQiLAogICAgICAgICAgIlVuYWJsZSB0byBjb21wdXRlIHRhbmdlbnRzIGFuZCBiaXRhbmdlbnRzIGZvciBwb2x5bGluZSB2b2x1bWUgZ2VvbWV0cnkiCiAgICAgICAgKTsKICAgICAgfQogICAgICBpZiAoIXZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50ID0gdm9pZCAwOwogICAgICB9CiAgICAgIGlmICghdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYml0YW5nZW50ID0gdm9pZCAwOwogICAgICB9CiAgICAgIGlmICghdmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5zdCA9IHZvaWQgMDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBQb2x5bGluZVZvbHVtZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb2x5bGluZVBvc2l0aW9uczsKICAgIGNvbnN0IHNoYXBlID0gb3B0aW9ucy5zaGFwZVBvc2l0aW9uczsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9seWxpbmVQb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzaGFwZSkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuc2hhcGVQb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICB0aGlzLl9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICB0aGlzLl9zaGFwZSA9IHNoYXBlOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KQogICAgKTsKICAgIHRoaXMuX2Nvcm5lclR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvcm5lclR5cGUsIENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCkKICAgICk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgbnVtQ29tcG9uZW50cyArPSAxICsgc2hhcGUubGVuZ3RoICogQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gbnVtQ29tcG9uZW50cyArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDI7CiAgfQogIHZhciBzY3JhdGNoRWxsaXBzb2lkOSwgc2NyYXRjaFZlcnRleEZvcm1hdDExLCBzY3JhdGNoT3B0aW9uczE3LCBiclNjcmF0Y2gsIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1JlY3RhbmdsZSgpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0Nvcm5lclR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfb25lVGltZVdhcm5pbmcoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgaW5pdF9XaW5kaW5nT3JkZXIoKTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNoYXBlID0gdmFsdWUuX3NoYXBlOwogICAgICAgIGxlbmd0aCA9IHNoYXBlLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhzaGFwZVtpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2Nvcm5lclR5cGU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkOSA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDExID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTcgPSB7CiAgICAgICAgcG9seWxpbmVQb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzaGFwZVBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDksCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0MTEsCiAgICAgICAgY29ybmVyVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzaGFwZSA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBzaGFwZVtpXSA9IENhcnRlc2lhbjJfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQ5KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTEKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNy5wb2x5bGluZVBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTcuc2hhcGVQb3NpdGlvbnMgPSBzaGFwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTcuY29ybmVyVHlwZSA9IGNvcm5lclR5cGU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE3LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxNyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fc2hhcGUgPSBzaGFwZTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgYnJTY3JhdGNoID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBwb2x5bGluZVZvbHVtZUdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgY2xlYW5Qb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uCiAgICAgICAgKTsKICAgICAgICBsZXQgc2hhcGUyRCA9IHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuX3NoYXBlOwogICAgICAgIHNoYXBlMkQgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnJlbW92ZUR1cGxpY2F0ZXNGcm9tU2hhcGUoc2hhcGUyRCk7CiAgICAgICAgaWYgKGNsZWFuUG9zaXRpb25zLmxlbmd0aCA8IDIgfHwgc2hhcGUyRC5sZW5ndGggPCAzKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKHNoYXBlMkQpID09PSBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DTE9DS1dJU0UpIHsKICAgICAgICAgIHNoYXBlMkQucmV2ZXJzZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQuZnJvbVBvaW50cyhzaGFwZTJELCBiclNjcmF0Y2gpOwogICAgICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKAogICAgICAgICAgY2xlYW5Qb3NpdGlvbnMsCiAgICAgICAgICBzaGFwZTJELAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICBwb2x5bGluZVZvbHVtZUdlb21ldHJ5LAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVBdHRyaWJ1dGVzMigKICAgICAgICAgIGNvbXB1dGVkUG9zaXRpb25zLAogICAgICAgICAgc2hhcGUyRCwKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLAogICAgICAgICAgcG9seWxpbmVWb2x1bWVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9kZWZhdWx0ID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5KHBvbHlsaW5lVm9sdW1lR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIHBvbHlsaW5lVm9sdW1lR2VvbWV0cnksCiAgICAgICAgb2Zmc2V0CiAgICAgICk7CiAgICB9CiAgICBwb2x5bGluZVZvbHVtZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgcG9seWxpbmVWb2x1bWVHZW9tZXRyeS5fZWxsaXBzb2lkCiAgICApOwogICAgcmV0dXJuIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShwb2x5bGluZVZvbHVtZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWxpbmVWb2x1bWVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjb21wdXRlQXR0cmlidXRlczMocG9zaXRpb25zLCBzaGFwZSkgewogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgfSk7CiAgICBjb25zdCBzaGFwZUxlbmd0aCA9IHNoYXBlLmxlbmd0aDsKICAgIGNvbnN0IHZlcnRleENvdW50ID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHBvc2l0aW9uTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBzaGFwZUNvdW50ID0gcG9zaXRpb25MZW5ndGggLyBzaGFwZUxlbmd0aDsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgdmVydGV4Q291bnQsCiAgICAgIDIgKiBzaGFwZUxlbmd0aCAqIChzaGFwZUNvdW50ICsgMSkKICAgICk7CiAgICBsZXQgaSwgajsKICAgIGxldCBpbmRleCA9IDA7CiAgICBpID0gMDsKICAgIGxldCBvZmZzZXQgPSBpICogc2hhcGVMZW5ndGg7CiAgICBmb3IgKGogPSAwOyBqIDwgc2hhcGVMZW5ndGggLSAxOyBqKyspIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBvZmZzZXQ7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgb2Zmc2V0ICsgMTsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBzaGFwZUxlbmd0aCAtIDEgKyBvZmZzZXQ7CiAgICBpbmRpY2VzW2luZGV4KytdID0gb2Zmc2V0OwogICAgaSA9IHNoYXBlQ291bnQgLSAxOwogICAgb2Zmc2V0ID0gaSAqIHNoYXBlTGVuZ3RoOwogICAgZm9yIChqID0gMDsgaiA8IHNoYXBlTGVuZ3RoIC0gMTsgaisrKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgb2Zmc2V0OwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIG9mZnNldCArIDE7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gc2hhcGVMZW5ndGggLSAxICsgb2Zmc2V0OwogICAgaW5kaWNlc1tpbmRleCsrXSA9IG9mZnNldDsKICAgIGZvciAoaSA9IDA7IGkgPCBzaGFwZUNvdW50IC0gMTsgaSsrKSB7CiAgICAgIGNvbnN0IGZpcnN0T2Zmc2V0ID0gc2hhcGVMZW5ndGggKiBpOwogICAgICBjb25zdCBzZWNvbmRPZmZzZXQgPSBmaXJzdE9mZnNldCArIHNoYXBlTGVuZ3RoOwogICAgICBmb3IgKGogPSAwOyBqIDwgc2hhcGVMZW5ndGg7IGorKykgewogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgZmlyc3RPZmZzZXQ7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBzZWNvbmRPZmZzZXQ7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSh2ZXJ0ZXhDb3VudCwgaW5kaWNlcyksCiAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMKICAgIH0pOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9seWxpbmVQb3NpdGlvbnM7CiAgICBjb25zdCBzaGFwZSA9IG9wdGlvbnMuc2hhcGVQb3NpdGlvbnM7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvbHlsaW5lUG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2hhcGUpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnNoYXBlUG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fc2hhcGUgPSBzaGFwZTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCkKICAgICk7CiAgICB0aGlzLl9jb3JuZXJUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb3JuZXJUeXBlLCBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSI7CiAgICBsZXQgbnVtQ29tcG9uZW50cyA9IDEgKyBwb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIG51bUNvbXBvbmVudHMgKz0gMSArIHNoYXBlLmxlbmd0aCAqIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IG51bUNvbXBvbmVudHMgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAyOwogIH0KICB2YXIgc2NyYXRjaEVsbGlwc29pZDEwLCBzY3JhdGNoT3B0aW9uczE4LCBiclNjcmF0Y2gyLCBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Db3JuZXJUeXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfV2luZGluZ09yZGVyKCk7CiAgICAgIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2hhcGUgPSB2YWx1ZS5fc2hhcGU7CiAgICAgICAgbGVuZ3RoID0gc2hhcGUubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKHNoYXBlW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY29ybmVyVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxMCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxOCA9IHsKICAgICAgICBwb2x5bGluZVBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIHNoYXBlUG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgY29ybmVyVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2hhcGUgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgc2hhcGVbaV0gPSBDYXJ0ZXNpYW4yX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMTApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOC5wb2x5bGluZVBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTguc2hhcGVQb3NpdGlvbnMgPSBzaGFwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTguY29ybmVyVHlwZSA9IGNvcm5lclR5cGU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE4LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICByZXN1bHQuX3NoYXBlID0gc2hhcGU7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX2Nvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBiclNjcmF0Y2gyID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgY2xlYW5Qb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uCiAgICAgICAgKTsKICAgICAgICBsZXQgc2hhcGUyRCA9IHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5Ll9zaGFwZTsKICAgICAgICBzaGFwZTJEID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5yZW1vdmVEdXBsaWNhdGVzRnJvbVNoYXBlKHNoYXBlMkQpOwogICAgICAgIGlmIChjbGVhblBvc2l0aW9ucy5sZW5ndGggPCAyIHx8IHNoYXBlMkQubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRChzaGFwZTJEKSA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgICAgICBzaGFwZTJELnJldmVyc2UoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGUgPSBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0LmZyb21Qb2ludHMoc2hhcGUyRCwgYnJTY3JhdGNoMik7CiAgICAgICAgY29uc3QgY29tcHV0ZWRQb3NpdGlvbnMgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBjbGVhblBvc2l0aW9ucywKICAgICAgICAgIHNoYXBlMkQsCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZSwKICAgICAgICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIHJldHVybiBjb21wdXRlQXR0cmlidXRlczMoY29tcHV0ZWRQb3NpdGlvbnMsIHNoYXBlMkQpOwogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSA9IFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgcG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkCiAgICApOwogICAgcmV0dXJuIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoCiAgICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5CiAgICApOwogIH0KICB2YXIgY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9Qb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBnZXRSb3RhdGlvbk9wdGlvbnMobndDb3JuZXIsIHJvdGF0aW9uLCBncmFudWxhcml0eVgsIGdyYW51bGFyaXR5WSwgY2VudGVyLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICBjb25zdCBjb3NSb3RhdGlvbiA9IE1hdGguY29zKHJvdGF0aW9uKTsKICAgIGNvbnN0IGdyYW5ZQ29zID0gZ3JhbnVsYXJpdHlZICogY29zUm90YXRpb247CiAgICBjb25zdCBncmFuWENvcyA9IGdyYW51bGFyaXR5WCAqIGNvc1JvdGF0aW9uOwogICAgY29uc3Qgc2luUm90YXRpb24gPSBNYXRoLnNpbihyb3RhdGlvbik7CiAgICBjb25zdCBncmFuWVNpbiA9IGdyYW51bGFyaXR5WSAqIHNpblJvdGF0aW9uOwogICAgY29uc3QgZ3JhblhTaW4gPSBncmFudWxhcml0eVggKiBzaW5Sb3RhdGlvbjsKICAgIHByb2ouX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQ7CiAgICBud0NhcnRlc2lhbiA9IHByb2oucHJvamVjdChud0Nvcm5lciwgbndDYXJ0ZXNpYW4pOwogICAgbndDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobndDYXJ0ZXNpYW4sIGNlbnRlckNhcnRlc2lhbiwgbndDYXJ0ZXNpYW4pOwogICAgY29uc3Qgcm90YXRpb25NYXRyaXggPSBNYXRyaXgyX2RlZmF1bHQuZnJvbVJvdGF0aW9uKHJvdGF0aW9uLCByb3RhdGlvbk1hdHJpeFNjcmF0Y2gpOwogICAgbndDYXJ0ZXNpYW4gPSBNYXRyaXgyX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgcm90YXRpb25NYXRyaXgsCiAgICAgIG53Q2FydGVzaWFuLAogICAgICBud0NhcnRlc2lhbgogICAgKTsKICAgIG53Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChud0NhcnRlc2lhbiwgY2VudGVyQ2FydGVzaWFuLCBud0NhcnRlc2lhbik7CiAgICBud0Nvcm5lciA9IHByb2oudW5wcm9qZWN0KG53Q2FydGVzaWFuLCBud0Nvcm5lcik7CiAgICB3aWR0aCAtPSAxOwogICAgaGVpZ2h0IC09IDE7CiAgICBjb25zdCBsYXRpdHVkZSA9IG53Q29ybmVyLmxhdGl0dWRlOwogICAgY29uc3QgbGF0aXR1ZGUwID0gbGF0aXR1ZGUgKyB3aWR0aCAqIGdyYW5YU2luOwogICAgY29uc3QgbGF0aXR1ZGUxID0gbGF0aXR1ZGUgLSBncmFuWUNvcyAqIGhlaWdodDsKICAgIGNvbnN0IGxhdGl0dWRlMiA9IGxhdGl0dWRlIC0gZ3JhbllDb3MgKiBoZWlnaHQgKyB3aWR0aCAqIGdyYW5YU2luOwogICAgY29uc3Qgbm9ydGggPSBNYXRoLm1heChsYXRpdHVkZSwgbGF0aXR1ZGUwLCBsYXRpdHVkZTEsIGxhdGl0dWRlMik7CiAgICBjb25zdCBzb3V0aCA9IE1hdGgubWluKGxhdGl0dWRlLCBsYXRpdHVkZTAsIGxhdGl0dWRlMSwgbGF0aXR1ZGUyKTsKICAgIGNvbnN0IGxvbmdpdHVkZSA9IG53Q29ybmVyLmxvbmdpdHVkZTsKICAgIGNvbnN0IGxvbmdpdHVkZTAgPSBsb25naXR1ZGUgKyB3aWR0aCAqIGdyYW5YQ29zOwogICAgY29uc3QgbG9uZ2l0dWRlMSA9IGxvbmdpdHVkZSArIGhlaWdodCAqIGdyYW5ZU2luOwogICAgY29uc3QgbG9uZ2l0dWRlMiA9IGxvbmdpdHVkZSArIGhlaWdodCAqIGdyYW5ZU2luICsgd2lkdGggKiBncmFuWENvczsKICAgIGNvbnN0IGVhc3QgPSBNYXRoLm1heChsb25naXR1ZGUsIGxvbmdpdHVkZTAsIGxvbmdpdHVkZTEsIGxvbmdpdHVkZTIpOwogICAgY29uc3Qgd2VzdCA9IE1hdGgubWluKGxvbmdpdHVkZSwgbG9uZ2l0dWRlMCwgbG9uZ2l0dWRlMSwgbG9uZ2l0dWRlMik7CiAgICByZXR1cm4gewogICAgICBub3J0aCwKICAgICAgc291dGgsCiAgICAgIGVhc3QsCiAgICAgIHdlc3QsCiAgICAgIGdyYW5ZQ29zLAogICAgICBncmFuWVNpbiwKICAgICAgZ3JhblhDb3MsCiAgICAgIGdyYW5YU2luLAogICAgICBud0Nvcm5lcgogICAgfTsKICB9CiAgdmFyIGNvczMsIHNpbjMsIHNxcnQsIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeSwgcm90YXRpb25NYXRyaXhTY3JhdGNoLCBud0NhcnRlc2lhbiwgY2VudGVyU2NyYXRjaDMsIGNlbnRlckNhcnRlc2lhbiwgcHJvaiwgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgyKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGNvczMgPSBNYXRoLmNvczsKICAgICAgc2luMyA9IE1hdGguc2luOwogICAgICBzcXJ0ID0gTWF0aC5zcXJ0OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVQb3NpdGlvbiA9IGZ1bmN0aW9uKGNvbXB1dGVkT3B0aW9ucywgZWxsaXBzb2lkLCBjb21wdXRlU1QsIHJvdywgY29sLCBwb3NpdGlvbiwgc3QpIHsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSBlbGxpcHNvaWQucmFkaWlTcXVhcmVkOwogICAgICAgIGNvbnN0IG53Q29ybmVyID0gY29tcHV0ZWRPcHRpb25zLm53Q29ybmVyOwogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IGNvbXB1dGVkT3B0aW9ucy5ib3VuZGluZ1JlY3RhbmdsZTsKICAgICAgICBsZXQgc3RMYXRpdHVkZSA9IG53Q29ybmVyLmxhdGl0dWRlIC0gY29tcHV0ZWRPcHRpb25zLmdyYW5ZQ29zICogcm93ICsgY29sICogY29tcHV0ZWRPcHRpb25zLmdyYW5YU2luOwogICAgICAgIGNvbnN0IGNvc0xhdGl0dWRlID0gY29zMyhzdExhdGl0dWRlKTsKICAgICAgICBjb25zdCBuWiA9IHNpbjMoc3RMYXRpdHVkZSk7CiAgICAgICAgY29uc3Qga1ogPSByYWRpaVNxdWFyZWQueiAqIG5aOwogICAgICAgIGxldCBzdExvbmdpdHVkZSA9IG53Q29ybmVyLmxvbmdpdHVkZSArIHJvdyAqIGNvbXB1dGVkT3B0aW9ucy5ncmFuWVNpbiArIGNvbCAqIGNvbXB1dGVkT3B0aW9ucy5ncmFuWENvczsKICAgICAgICBjb25zdCBuWCA9IGNvc0xhdGl0dWRlICogY29zMyhzdExvbmdpdHVkZSk7CiAgICAgICAgY29uc3QgblkgPSBjb3NMYXRpdHVkZSAqIHNpbjMoc3RMb25naXR1ZGUpOwogICAgICAgIGNvbnN0IGtYID0gcmFkaWlTcXVhcmVkLnggKiBuWDsKICAgICAgICBjb25zdCBrWSA9IHJhZGlpU3F1YXJlZC55ICogblk7CiAgICAgICAgY29uc3QgZ2FtbWEgPSBzcXJ0KGtYICogblggKyBrWSAqIG5ZICsga1ogKiBuWik7CiAgICAgICAgcG9zaXRpb24ueCA9IGtYIC8gZ2FtbWE7CiAgICAgICAgcG9zaXRpb24ueSA9IGtZIC8gZ2FtbWE7CiAgICAgICAgcG9zaXRpb24ueiA9IGtaIC8gZ2FtbWE7CiAgICAgICAgaWYgKGNvbXB1dGVTVCkgewogICAgICAgICAgY29uc3Qgc3ROd0Nvcm5lciA9IGNvbXB1dGVkT3B0aW9ucy5zdE53Q29ybmVyOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdE53Q29ybmVyKSkgewogICAgICAgICAgICBzdExhdGl0dWRlID0gc3ROd0Nvcm5lci5sYXRpdHVkZSAtIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5ZQ29zICogcm93ICsgY29sICogY29tcHV0ZWRPcHRpb25zLnN0R3JhblhTaW47CiAgICAgICAgICAgIHN0TG9uZ2l0dWRlID0gc3ROd0Nvcm5lci5sb25naXR1ZGUgKyByb3cgKiBjb21wdXRlZE9wdGlvbnMuc3RHcmFuWVNpbiArIGNvbCAqIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5YQ29zOwogICAgICAgICAgICBzdC54ID0gKHN0TG9uZ2l0dWRlIC0gY29tcHV0ZWRPcHRpb25zLnN0V2VzdCkgKiBjb21wdXRlZE9wdGlvbnMubG9uU2NhbGFyOwogICAgICAgICAgICBzdC55ID0gKHN0TGF0aXR1ZGUgLSBjb21wdXRlZE9wdGlvbnMuc3RTb3V0aCkgKiBjb21wdXRlZE9wdGlvbnMubGF0U2NhbGFyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3QueCA9IChzdExvbmdpdHVkZSAtIHJlY3RhbmdsZS53ZXN0KSAqIGNvbXB1dGVkT3B0aW9ucy5sb25TY2FsYXI7CiAgICAgICAgICAgIHN0LnkgPSAoc3RMYXRpdHVkZSAtIHJlY3RhbmdsZS5zb3V0aCkgKiBjb21wdXRlZE9wdGlvbnMubGF0U2NhbGFyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgcm90YXRpb25NYXRyaXhTY3JhdGNoID0gbmV3IE1hdHJpeDJfZGVmYXVsdCgpOwogICAgICBud0NhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2VudGVyU2NyYXRjaDMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2VudGVyQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcm9qID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVPcHRpb25zID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBncmFudWxhcml0eSwgcm90YXRpb24sIHN0Um90YXRpb24sIGJvdW5kaW5nUmVjdGFuZ2xlU2NyYXRjaCwgbndDb3JuZXJSZXN1bHQsIHN0TndDb3JuZXJSZXN1bHQpIHsKICAgICAgICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGxldCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgbGV0IG5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIGxldCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICBsZXQgbm9ydGhDYXAgPSBmYWxzZTsKICAgICAgICBsZXQgc291dGhDYXAgPSBmYWxzZTsKICAgICAgICBpZiAobm9ydGggPT09IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTykgewogICAgICAgICAgbm9ydGhDYXAgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAoc291dGggPT09IC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08pIHsKICAgICAgICAgIHNvdXRoQ2FwID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgbGV0IGR4OwogICAgICAgIGNvbnN0IGR5ID0gbm9ydGggLSBzb3V0aDsKICAgICAgICBpZiAod2VzdCA+IGVhc3QpIHsKICAgICAgICAgIGR4ID0gTWF0aF9kZWZhdWx0LlRXT19QSSAtIHdlc3QgKyBlYXN0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkeCA9IGVhc3QgLSB3ZXN0OwogICAgICAgIH0KICAgICAgICBjb25zdCB3aWR0aCA9IE1hdGguY2VpbChkeCAvIGdyYW51bGFyaXR5KSArIDE7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5jZWlsKGR5IC8gZ3JhbnVsYXJpdHkpICsgMTsKICAgICAgICBjb25zdCBncmFudWxhcml0eVggPSBkeCAvICh3aWR0aCAtIDEpOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5WSA9IGR5IC8gKGhlaWdodCAtIDEpOwogICAgICAgIGNvbnN0IG53Q29ybmVyID0gUmVjdGFuZ2xlX2RlZmF1bHQubm9ydGh3ZXN0KHJlY3RhbmdsZSwgbndDb3JuZXJSZXN1bHQpOwogICAgICAgIGNvbnN0IGNlbnRlciA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcihyZWN0YW5nbGUsIGNlbnRlclNjcmF0Y2gzKTsKICAgICAgICBpZiAocm90YXRpb24gIT09IDAgfHwgc3RSb3RhdGlvbiAhPT0gMCkgewogICAgICAgICAgaWYgKGNlbnRlci5sb25naXR1ZGUgPCBud0Nvcm5lci5sb25naXR1ZGUpIHsKICAgICAgICAgICAgY2VudGVyLmxvbmdpdHVkZSArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgICAgcHJvai5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdDsKICAgICAgICAgIGNlbnRlckNhcnRlc2lhbiA9IHByb2oucHJvamVjdChjZW50ZXIsIGNlbnRlckNhcnRlc2lhbik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdyYW5ZQ29zID0gZ3JhbnVsYXJpdHlZOwogICAgICAgIGNvbnN0IGdyYW5YQ29zID0gZ3JhbnVsYXJpdHlYOwogICAgICAgIGNvbnN0IGdyYW5ZU2luID0gMDsKICAgICAgICBjb25zdCBncmFuWFNpbiA9IDA7CiAgICAgICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgY29tcHV0ZWRPcHRpb25zID0gewogICAgICAgICAgZ3JhbllDb3MsCiAgICAgICAgICBncmFuWVNpbiwKICAgICAgICAgIGdyYW5YQ29zLAogICAgICAgICAgZ3JhblhTaW4sCiAgICAgICAgICBud0Nvcm5lciwKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLAogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBub3J0aENhcCwKICAgICAgICAgIHNvdXRoQ2FwCiAgICAgICAgfTsKICAgICAgICBpZiAocm90YXRpb24gIT09IDApIHsKICAgICAgICAgIGNvbnN0IHJvdGF0aW9uT3B0aW9ucyA9IGdldFJvdGF0aW9uT3B0aW9ucygKICAgICAgICAgICAgbndDb3JuZXIsCiAgICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgICBncmFudWxhcml0eVgsCiAgICAgICAgICAgIGdyYW51bGFyaXR5WSwKICAgICAgICAgICAgY2VudGVyLAogICAgICAgICAgICB3aWR0aCwKICAgICAgICAgICAgaGVpZ2h0CiAgICAgICAgICApOwogICAgICAgICAgbm9ydGggPSByb3RhdGlvbk9wdGlvbnMubm9ydGg7CiAgICAgICAgICBzb3V0aCA9IHJvdGF0aW9uT3B0aW9ucy5zb3V0aDsKICAgICAgICAgIGVhc3QgPSByb3RhdGlvbk9wdGlvbnMuZWFzdDsKICAgICAgICAgIHdlc3QgPSByb3RhdGlvbk9wdGlvbnMud2VzdDsKICAgICAgICAgIGlmIChub3J0aCA8IC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gfHwgbm9ydGggPiBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gfHwgc291dGggPCAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIHx8IHNvdXRoID4gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgICJSb3RhdGVkIHJlY3RhbmdsZSBpcyBpbnZhbGlkLiAgSXQgY3Jvc3NlcyBvdmVyIGVpdGhlciB0aGUgbm9ydGggb3Igc291dGggcG9sZS4iCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuZ3JhbllDb3MgPSByb3RhdGlvbk9wdGlvbnMuZ3JhbllDb3M7CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuZ3JhbllTaW4gPSByb3RhdGlvbk9wdGlvbnMuZ3JhbllTaW47CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuZ3JhblhDb3MgPSByb3RhdGlvbk9wdGlvbnMuZ3JhblhDb3M7CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuZ3JhblhTaW4gPSByb3RhdGlvbk9wdGlvbnMuZ3JhblhTaW47CiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZS5ub3J0aCA9IG5vcnRoOwogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUuc291dGggPSBzb3V0aDsKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLmVhc3QgPSBlYXN0OwogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUud2VzdCA9IHdlc3Q7CiAgICAgICAgfQogICAgICAgIGlmIChzdFJvdGF0aW9uICE9PSAwKSB7CiAgICAgICAgICByb3RhdGlvbiA9IHJvdGF0aW9uIC0gc3RSb3RhdGlvbjsKICAgICAgICAgIGNvbnN0IHN0TndDb3JuZXIgPSBSZWN0YW5nbGVfZGVmYXVsdC5ub3J0aHdlc3QoYm91bmRpbmdSZWN0YW5nbGUsIHN0TndDb3JuZXJSZXN1bHQpOwogICAgICAgICAgY29uc3Qgc3RSb3RhdGlvbk9wdGlvbnMgPSBnZXRSb3RhdGlvbk9wdGlvbnMoCiAgICAgICAgICAgIHN0TndDb3JuZXIsCiAgICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgICBncmFudWxhcml0eVgsCiAgICAgICAgICAgIGdyYW51bGFyaXR5WSwKICAgICAgICAgICAgY2VudGVyLAogICAgICAgICAgICB3aWR0aCwKICAgICAgICAgICAgaGVpZ2h0CiAgICAgICAgICApOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLnN0R3JhbllDb3MgPSBzdFJvdGF0aW9uT3B0aW9ucy5ncmFuWUNvczsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5YQ29zID0gc3RSb3RhdGlvbk9wdGlvbnMuZ3JhblhDb3M7CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3RHcmFuWVNpbiA9IHN0Um90YXRpb25PcHRpb25zLmdyYW5ZU2luOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLnN0R3JhblhTaW4gPSBzdFJvdGF0aW9uT3B0aW9ucy5ncmFuWFNpbjsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdE53Q29ybmVyID0gc3ROd0Nvcm5lcjsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdFdlc3QgPSBzdFJvdGF0aW9uT3B0aW9ucy53ZXN0OwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLnN0U291dGggPSBzdFJvdGF0aW9uT3B0aW9ucy5zb3V0aDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXB1dGVkT3B0aW9uczsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNyZWF0ZUF0dHJpYnV0ZXModmVydGV4Rm9ybWF0LCBhdHRyaWJ1dGVzKSB7CiAgICBjb25zdCBnZW8gPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICB9KTsKICAgIGdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgIHZhbHVlczogYXR0cmlidXRlcy5wb3NpdGlvbnMKICAgIH0pOwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBhdHRyaWJ1dGVzLm5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYXR0cmlidXRlcy50YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGdlby5hdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYXR0cmlidXRlcy5iaXRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGdlbzsKICB9CiAgZnVuY3Rpb24gY2FsY3VsYXRlQXR0cmlidXRlcyhwb3NpdGlvbnMsIHZlcnRleEZvcm1hdCwgZWxsaXBzb2lkLCB0YW5nZW50Um90YXRpb25NYXRyaXgpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBub3JtYWxzID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgIGxldCBhdHRySW5kZXggPSAwOwogICAgY29uc3QgYml0YW5nZW50ID0gYml0YW5nZW50U2NyYXRjaDI7CiAgICBjb25zdCB0YW5nZW50ID0gdGFuZ2VudFNjcmF0Y2gyOwogICAgbGV0IG5vcm1hbDIgPSBub3JtYWxTY3JhdGNoNDsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgIGNvbnN0IHAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgcG9zaXRpb25TY3JhdGNoMik7CiAgICAgICAgY29uc3QgYXR0ckluZGV4MSA9IGF0dHJJbmRleCArIDE7CiAgICAgICAgY29uc3QgYXR0ckluZGV4MiA9IGF0dHJJbmRleCArIDI7CiAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCwgbm9ybWFsMik7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCBub3JtYWwyLCB0YW5nZW50KTsKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRhbmdlbnRSb3RhdGlvbk1hdHJpeCwgdGFuZ2VudCwgdGFuZ2VudCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHRhbmdlbnQsIHRhbmdlbnQpOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgdGFuZ2VudCwgYml0YW5nZW50KSwKICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4XSA9IG5vcm1hbDIueDsKICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4MV0gPSBub3JtYWwyLnk7CiAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDJdID0gbm9ybWFsMi56OwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleF0gPSB0YW5nZW50Lng7CiAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgxXSA9IHRhbmdlbnQueTsKICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDJdID0gdGFuZ2VudC56OwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXhdID0gYml0YW5nZW50Lng7CiAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDFdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDJdID0gYml0YW5nZW50Lno7CiAgICAgICAgfQogICAgICAgIGF0dHJJbmRleCArPSAzOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gY3JlYXRlQXR0cmlidXRlcyh2ZXJ0ZXhGb3JtYXQsIHsKICAgICAgcG9zaXRpb25zLAogICAgICBub3JtYWxzLAogICAgICB0YW5nZW50cywKICAgICAgYml0YW5nZW50cwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGNhbGN1bGF0ZUF0dHJpYnV0ZXNXYWxsKHBvc2l0aW9ucywgdmVydGV4Rm9ybWF0LCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBub3JtYWxzID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgIGxldCBub3JtYWxJbmRleCA9IDA7CiAgICBsZXQgdGFuZ2VudEluZGV4ID0gMDsKICAgIGxldCBiaXRhbmdlbnRJbmRleCA9IDA7CiAgICBsZXQgcmVjb21wdXRlTm9ybWFsID0gdHJ1ZTsKICAgIGxldCBiaXRhbmdlbnQgPSBiaXRhbmdlbnRTY3JhdGNoMjsKICAgIGxldCB0YW5nZW50ID0gdGFuZ2VudFNjcmF0Y2gyOwogICAgbGV0IG5vcm1hbDIgPSBub3JtYWxTY3JhdGNoNDsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gNikgewogICAgICAgIGNvbnN0IHAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgcG9zaXRpb25TY3JhdGNoMik7CiAgICAgICAgY29uc3QgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgKGkgKyA2KSAlIGxlbmd0aCwgdjFTY3JhdGNoKTsKICAgICAgICBpZiAocmVjb21wdXRlTm9ybWFsKSB7CiAgICAgICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCAoaSArIDMpICUgbGVuZ3RoLCB2MlNjcmF0Y2gpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAxLCBwLCBwMSk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDIsIHAsIHAyKTsKICAgICAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhwMiwgcDEsIG5vcm1hbDIpLCBub3JtYWwyKTsKICAgICAgICAgIHJlY29tcHV0ZU5vcm1hbCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocDEsIHAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50ID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBiaXRhbmdlbnQpOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhiaXRhbmdlbnQsIG5vcm1hbDIsIHRhbmdlbnQpLAogICAgICAgICAgICAgIHRhbmdlbnQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLng7CiAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIuejsKICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLng7CiAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIuejsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lng7CiAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lnk7CiAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lng7CiAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lnk7CiAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lno7CiAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lno7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gY3JlYXRlQXR0cmlidXRlcyh2ZXJ0ZXhGb3JtYXQsIHsKICAgICAgcG9zaXRpb25zLAogICAgICBub3JtYWxzLAogICAgICB0YW5nZW50cywKICAgICAgYml0YW5nZW50cwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGNvbnN0cnVjdFJlY3RhbmdsZShyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKSB7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSByZWN0YW5nbGVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgY29uc3QgZWxsaXBzb2lkID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgIGNvbnN0IGhlaWdodCA9IGNvbXB1dGVkT3B0aW9ucy5oZWlnaHQ7CiAgICBjb25zdCB3aWR0aCA9IGNvbXB1dGVkT3B0aW9ucy53aWR0aDsKICAgIGNvbnN0IG5vcnRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLm5vcnRoQ2FwOwogICAgY29uc3Qgc291dGhDYXAgPSBjb21wdXRlZE9wdGlvbnMuc291dGhDYXA7CiAgICBsZXQgcm93U3RhcnQgPSAwOwogICAgbGV0IHJvd0VuZCA9IGhlaWdodDsKICAgIGxldCByb3dIZWlnaHQgPSBoZWlnaHQ7CiAgICBsZXQgc2l6ZSA9IDA7CiAgICBpZiAobm9ydGhDYXApIHsKICAgICAgcm93U3RhcnQgPSAxOwogICAgICByb3dIZWlnaHQgLT0gMTsKICAgICAgc2l6ZSArPSAxOwogICAgfQogICAgaWYgKHNvdXRoQ2FwKSB7CiAgICAgIHJvd0VuZCAtPSAxOwogICAgICByb3dIZWlnaHQgLT0gMTsKICAgICAgc2l6ZSArPSAxOwogICAgfQogICAgc2l6ZSArPSB3aWR0aCAqIHJvd0hlaWdodDsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZlcnRleEZvcm1hdC5wb3NpdGlvbiA/IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMikgOiB2b2lkIDA7CiAgICBsZXQgcG9zSW5kZXggPSAwOwogICAgbGV0IHN0SW5kZXggPSAwOwogICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvblNjcmF0Y2gyOwogICAgY29uc3Qgc3QgPSBzdFNjcmF0Y2gyOwogICAgbGV0IG1pblggPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgbGV0IG1pblkgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgbGV0IG1heFggPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgIGxldCBtYXhZID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICBmb3IgKGxldCByb3cgPSByb3dTdGFydDsgcm93IDwgcm93RW5kOyArK3JvdykgewogICAgICBmb3IgKGxldCBjb2wgPSAwOyBjb2wgPCB3aWR0aDsgKytjb2wpIHsKICAgICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQuc3QsCiAgICAgICAgICByb3csCiAgICAgICAgICBjb2wsCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHN0CiAgICAgICAgKTsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHN0Lng7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHN0Lnk7CiAgICAgICAgICBtaW5YID0gTWF0aC5taW4obWluWCwgc3QueCk7CiAgICAgICAgICBtaW5ZID0gTWF0aC5taW4obWluWSwgc3QueSk7CiAgICAgICAgICBtYXhYID0gTWF0aC5tYXgobWF4WCwgc3QueCk7CiAgICAgICAgICBtYXhZID0gTWF0aC5tYXgobWF4WSwgc3QueSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAobm9ydGhDYXApIHsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgdmVydGV4Rm9ybWF0LnN0LAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICBwb3NpdGlvbiwKICAgICAgICBzdAogICAgICApOwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdC54OwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gc3QueTsKICAgICAgICBtaW5YID0gc3QueDsKICAgICAgICBtaW5ZID0gc3QueTsKICAgICAgICBtYXhYID0gc3QueDsKICAgICAgICBtYXhZID0gc3QueTsKICAgICAgfQogICAgfQogICAgaWYgKHNvdXRoQ2FwKSB7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIHZlcnRleEZvcm1hdC5zdCwKICAgICAgICBoZWlnaHQgLSAxLAogICAgICAgIDAsCiAgICAgICAgcG9zaXRpb24sCiAgICAgICAgc3QKICAgICAgKTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4XSA9IHBvc2l0aW9uLno7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHN0Lng7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXhdID0gc3QueTsKICAgICAgICBtaW5YID0gTWF0aC5taW4obWluWCwgc3QueCk7CiAgICAgICAgbWluWSA9IE1hdGgubWluKG1pblksIHN0LnkpOwogICAgICAgIG1heFggPSBNYXRoLm1heChtYXhYLCBzdC54KTsKICAgICAgICBtYXhZID0gTWF0aC5tYXgobWF4WSwgc3QueSk7CiAgICAgIH0KICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QgJiYgKG1pblggPCAwIHx8IG1pblkgPCAwIHx8IG1heFggPiAxIHx8IG1heFkgPiAxKSkgewogICAgICBmb3IgKGxldCBrID0gMDsgayA8IHRleHR1cmVDb29yZGluYXRlcy5sZW5ndGg7IGsgKz0gMikgewogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1trXSA9ICh0ZXh0dXJlQ29vcmRpbmF0ZXNba10gLSBtaW5YKSAvIChtYXhYIC0gbWluWCk7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW2sgKyAxXSA9ICh0ZXh0dXJlQ29vcmRpbmF0ZXNbayArIDFdIC0gbWluWSkgLyAobWF4WSAtIG1pblkpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBnZW8gPSBjYWxjdWxhdGVBdHRyaWJ1dGVzKAogICAgICBwb3NpdGlvbnMsCiAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgZWxsaXBzb2lkLAogICAgICBjb21wdXRlZE9wdGlvbnMudGFuZ2VudFJvdGF0aW9uTWF0cml4CiAgICApOwogICAgbGV0IGluZGljZXNTaXplID0gNiAqICh3aWR0aCAtIDEpICogKHJvd0hlaWdodCAtIDEpOwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIGluZGljZXNTaXplICs9IDMgKiAod2lkdGggLSAxKTsKICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICBpbmRpY2VzU2l6ZSArPSAzICogKHdpZHRoIC0gMSk7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoc2l6ZSwgaW5kaWNlc1NpemUpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGxldCBpbmRpY2VzSW5kZXggPSAwOwogICAgbGV0IGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgcm93SGVpZ2h0IC0gMTsgKytpKSB7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgd2lkdGggLSAxOyArK2opIHsKICAgICAgICBjb25zdCB1cHBlckxlZnQgPSBpbmRleDsKICAgICAgICBjb25zdCBsb3dlckxlZnQgPSB1cHBlckxlZnQgKyB3aWR0aDsKICAgICAgICBjb25zdCBsb3dlclJpZ2h0ID0gbG93ZXJMZWZ0ICsgMTsKICAgICAgICBjb25zdCB1cHBlclJpZ2h0ID0gdXBwZXJMZWZ0ICsgMTsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHVwcGVyTGVmdDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGxvd2VyTGVmdDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHVwcGVyUmlnaHQ7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB1cHBlclJpZ2h0OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gbG93ZXJMZWZ0OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gbG93ZXJSaWdodDsKICAgICAgICArK2luZGV4OwogICAgICB9CiAgICAgICsraW5kZXg7CiAgICB9CiAgICBpZiAobm9ydGhDYXAgfHwgc291dGhDYXApIHsKICAgICAgbGV0IG5vcnRoSW5kZXggPSBzaXplIC0gMTsKICAgICAgY29uc3Qgc291dGhJbmRleCA9IHNpemUgLSAxOwogICAgICBpZiAobm9ydGhDYXAgJiYgc291dGhDYXApIHsKICAgICAgICBub3J0aEluZGV4ID0gc2l6ZSAtIDI7CiAgICAgIH0KICAgICAgbGV0IHAxOwogICAgICBsZXQgcDI7CiAgICAgIGluZGV4ID0gMDsKICAgICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHdpZHRoIC0gMTsgaSsrKSB7CiAgICAgICAgICBwMSA9IGluZGV4OwogICAgICAgICAgcDIgPSBwMSArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IG5vcnRoSW5kZXg7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHAxOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwMjsKICAgICAgICAgICsraW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChzb3V0aENhcCkgewogICAgICAgIGluZGV4ID0gKHJvd0hlaWdodCAtIDEpICogd2lkdGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHdpZHRoIC0gMTsgaSsrKSB7CiAgICAgICAgICBwMSA9IGluZGV4OwogICAgICAgICAgcDIgPSBwMSArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHAxOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBzb3V0aEluZGV4OwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwMjsKICAgICAgICAgICsraW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBnZW8uaW5kaWNlcyA9IGluZGljZXM7CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGdlby5hdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiB0ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gZ2VvOwogIH0KICBmdW5jdGlvbiBhZGRXYWxsUG9zaXRpb25zMih3YWxsUG9zaXRpb25zLCBwb3NJbmRleCwgaSwgdG9wUG9zaXRpb25zLCBib3R0b21Qb3NpdGlvbnMpIHsKICAgIHdhbGxQb3NpdGlvbnNbcG9zSW5kZXgrK10gPSB0b3BQb3NpdGlvbnNbaV07CiAgICB3YWxsUG9zaXRpb25zW3Bvc0luZGV4KytdID0gdG9wUG9zaXRpb25zW2kgKyAxXTsKICAgIHdhbGxQb3NpdGlvbnNbcG9zSW5kZXgrK10gPSB0b3BQb3NpdGlvbnNbaSArIDJdOwogICAgd2FsbFBvc2l0aW9uc1twb3NJbmRleCsrXSA9IGJvdHRvbVBvc2l0aW9uc1tpXTsKICAgIHdhbGxQb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbnNbaSArIDFdOwogICAgd2FsbFBvc2l0aW9uc1twb3NJbmRleF0gPSBib3R0b21Qb3NpdGlvbnNbaSArIDJdOwogICAgcmV0dXJuIHdhbGxQb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMod2FsbFRleHR1cmVzLCBzdEluZGV4LCBpLCBzdCkgewogICAgd2FsbFRleHR1cmVzW3N0SW5kZXgrK10gPSBzdFtpXTsKICAgIHdhbGxUZXh0dXJlc1tzdEluZGV4KytdID0gc3RbaSArIDFdOwogICAgd2FsbFRleHR1cmVzW3N0SW5kZXgrK10gPSBzdFtpXTsKICAgIHdhbGxUZXh0dXJlc1tzdEluZGV4XSA9IHN0W2kgKyAxXTsKICAgIHJldHVybiB3YWxsVGV4dHVyZXM7CiAgfQogIGZ1bmN0aW9uIGNvbnN0cnVjdEV4dHJ1ZGVkUmVjdGFuZ2xlKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpIHsKICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zaGFkb3dWb2x1bWU7CiAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGVWYWx1ZSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGU7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSByZWN0YW5nbGVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgY29uc3QgbWluSGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgY29uc3QgbWF4SGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3N1cmZhY2VIZWlnaHQ7CiAgICBjb25zdCBlbGxpcHNvaWQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgY29uc3QgaGVpZ2h0ID0gY29tcHV0ZWRPcHRpb25zLmhlaWdodDsKICAgIGNvbnN0IHdpZHRoID0gY29tcHV0ZWRPcHRpb25zLndpZHRoOwogICAgbGV0IGk7CiAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgIGNvbnN0IG5ld1ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTIKICAgICAgKTsKICAgICAgbmV3VmVydGV4Rm9ybWF0Lm5vcm1hbCA9IHRydWU7CiAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQgPSBuZXdWZXJ0ZXhGb3JtYXQ7CiAgICB9CiAgICBjb25zdCB0b3BCb3R0b21HZW8gPSBjb25zdHJ1Y3RSZWN0YW5nbGUocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucyk7CiAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQgPSB2ZXJ0ZXhGb3JtYXQ7CiAgICB9CiAgICBsZXQgdG9wUG9zaXRpb25zID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgIG1heEhlaWdodCwKICAgICAgZWxsaXBzb2lkLAogICAgICBmYWxzZQogICAgKTsKICAgIHRvcFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkodG9wUG9zaXRpb25zKTsKICAgIGxldCBsZW5ndGggPSB0b3BQb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3QgbmV3TGVuZ3RoID0gbGVuZ3RoICogMjsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobmV3TGVuZ3RoKTsKICAgIHBvc2l0aW9ucy5zZXQodG9wUG9zaXRpb25zKTsKICAgIGNvbnN0IGJvdHRvbVBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICBtaW5IZWlnaHQsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIHBvc2l0aW9ucy5zZXQoYm90dG9tUG9zaXRpb25zLCBsZW5ndGgpOwogICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gcG9zaXRpb25zOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KG5ld0xlbmd0aCkgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShuZXdMZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KG5ld0xlbmd0aCkgOiB2b2lkIDA7CiAgICBjb25zdCB0ZXh0dXJlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkobmV3TGVuZ3RoIC8gMyAqIDIpIDogdm9pZCAwOwogICAgbGV0IHRvcFN0OwogICAgbGV0IHRvcE5vcm1hbHM7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICB0b3BOb3JtYWxzID0gdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgbm9ybWFscy5zZXQodG9wTm9ybWFscyk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRvcE5vcm1hbHNbaV0gPSAtdG9wTm9ybWFsc1tpXTsKICAgICAgfQogICAgICBub3JtYWxzLnNldCh0b3BOb3JtYWxzLCBsZW5ndGgpOwogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzID0gbm9ybWFsczsKICAgIH0KICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgdG9wTm9ybWFscyA9IHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXM7CiAgICAgIGlmICghdmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLm5vcm1hbCA9IHZvaWQgMDsKICAgICAgfQogICAgICBjb25zdCBleHRydWRlTm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkobmV3TGVuZ3RoKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG9wTm9ybWFsc1tpXSA9IC10b3BOb3JtYWxzW2ldOwogICAgICB9CiAgICAgIGV4dHJ1ZGVOb3JtYWxzLnNldCh0b3BOb3JtYWxzLCBsZW5ndGgpOwogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBleHRydWRlTm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGxldCBvZmZzZXRWYWx1ZTsKICAgIGNvbnN0IGhhc09mZnNldHMgPSBkZWZpbmVkX2RlZmF1bHQob2Zmc2V0QXR0cmlidXRlVmFsdWUpOwogICAgaWYgKGhhc09mZnNldHMpIHsKICAgICAgY29uc3Qgc2l6ZSA9IGxlbmd0aCAvIDMgKiAyOwogICAgICBsZXQgb2Zmc2V0QXR0cmlidXRlID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7CiAgICAgIGlmIChvZmZzZXRBdHRyaWJ1dGVWYWx1ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxLCAwLCBzaXplIC8gMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2Zmc2V0VmFsdWUgPSBvZmZzZXRBdHRyaWJ1dGVWYWx1ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICB2YWx1ZXM6IG9mZnNldEF0dHJpYnV0ZQogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBjb25zdCB0b3BUYW5nZW50cyA9IHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLnRhbmdlbnQudmFsdWVzOwogICAgICB0YW5nZW50cy5zZXQodG9wVGFuZ2VudHMpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB0b3BUYW5nZW50c1tpXSA9IC10b3BUYW5nZW50c1tpXTsKICAgICAgfQogICAgICB0YW5nZW50cy5zZXQodG9wVGFuZ2VudHMsIGxlbmd0aCk7CiAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLnRhbmdlbnQudmFsdWVzID0gdGFuZ2VudHM7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBjb25zdCB0b3BCaXRhbmdlbnRzID0gdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMuYml0YW5nZW50LnZhbHVlczsKICAgICAgYml0YW5nZW50cy5zZXQodG9wQml0YW5nZW50cyk7CiAgICAgIGJpdGFuZ2VudHMuc2V0KHRvcEJpdGFuZ2VudHMsIGxlbmd0aCk7CiAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLmJpdGFuZ2VudC52YWx1ZXMgPSBiaXRhbmdlbnRzOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICB0b3BTdCA9IHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLnN0LnZhbHVlczsKICAgICAgdGV4dHVyZXMuc2V0KHRvcFN0KTsKICAgICAgdGV4dHVyZXMuc2V0KHRvcFN0LCBsZW5ndGggLyAzICogMik7CiAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLnN0LnZhbHVlcyA9IHRleHR1cmVzOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IHRvcEJvdHRvbUdlby5pbmRpY2VzOwogICAgY29uc3QgaW5kaWNlc0xlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgY29uc3QgcG9zTGVuZ3RoID0gbGVuZ3RoIC8gMzsKICAgIGNvbnN0IG5ld0luZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbmV3TGVuZ3RoIC8gMywKICAgICAgaW5kaWNlc0xlbmd0aCAqIDIKICAgICk7CiAgICBuZXdJbmRpY2VzLnNldChpbmRpY2VzKTsKICAgIGZvciAoaSA9IDA7IGkgPCBpbmRpY2VzTGVuZ3RoOyBpICs9IDMpIHsKICAgICAgbmV3SW5kaWNlc1tpICsgaW5kaWNlc0xlbmd0aF0gPSBpbmRpY2VzW2kgKyAyXSArIHBvc0xlbmd0aDsKICAgICAgbmV3SW5kaWNlc1tpICsgMSArIGluZGljZXNMZW5ndGhdID0gaW5kaWNlc1tpICsgMV0gKyBwb3NMZW5ndGg7CiAgICAgIG5ld0luZGljZXNbaSArIDIgKyBpbmRpY2VzTGVuZ3RoXSA9IGluZGljZXNbaV0gKyBwb3NMZW5ndGg7CiAgICB9CiAgICB0b3BCb3R0b21HZW8uaW5kaWNlcyA9IG5ld0luZGljZXM7CiAgICBjb25zdCBub3J0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5ub3J0aENhcDsKICAgIGNvbnN0IHNvdXRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLnNvdXRoQ2FwOwogICAgbGV0IHJvd0hlaWdodCA9IGhlaWdodDsKICAgIGxldCB3aWR0aE11bHRpcGxpZXIgPSAyOwogICAgbGV0IHBlcmltZXRlclBvc2l0aW9ucyA9IDA7CiAgICBsZXQgY29ybmVycyA9IDQ7CiAgICBsZXQgZHVwbGlhdGVDb3JuZXJzID0gNDsKICAgIGlmIChub3J0aENhcCkgewogICAgICB3aWR0aE11bHRpcGxpZXIgLT0gMTsKICAgICAgcm93SGVpZ2h0IC09IDE7CiAgICAgIHBlcmltZXRlclBvc2l0aW9ucyArPSAxOwogICAgICBjb3JuZXJzIC09IDI7CiAgICAgIGR1cGxpYXRlQ29ybmVycyAtPSAxOwogICAgfQogICAgaWYgKHNvdXRoQ2FwKSB7CiAgICAgIHdpZHRoTXVsdGlwbGllciAtPSAxOwogICAgICByb3dIZWlnaHQgLT0gMTsKICAgICAgcGVyaW1ldGVyUG9zaXRpb25zICs9IDE7CiAgICAgIGNvcm5lcnMgLT0gMjsKICAgICAgZHVwbGlhdGVDb3JuZXJzIC09IDE7CiAgICB9CiAgICBwZXJpbWV0ZXJQb3NpdGlvbnMgKz0gd2lkdGhNdWx0aXBsaWVyICogd2lkdGggKyAyICogcm93SGVpZ2h0IC0gY29ybmVyczsKICAgIGNvbnN0IHdhbGxDb3VudCA9IChwZXJpbWV0ZXJQb3NpdGlvbnMgKyBkdXBsaWF0ZUNvcm5lcnMpICogMjsKICAgIGxldCB3YWxsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSh3YWxsQ291bnQgKiAzKTsKICAgIGNvbnN0IHdhbGxFeHRydWRlTm9ybWFscyA9IHNoYWRvd1ZvbHVtZSA/IG5ldyBGbG9hdDMyQXJyYXkod2FsbENvdW50ICogMykgOiB2b2lkIDA7CiAgICBsZXQgd2FsbE9mZnNldEF0dHJpYnV0ZSA9IGhhc09mZnNldHMgPyBuZXcgVWludDhBcnJheSh3YWxsQ291bnQpIDogdm9pZCAwOwogICAgbGV0IHdhbGxUZXh0dXJlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkod2FsbENvdW50ICogMikgOiB2b2lkIDA7CiAgICBjb25zdCBjb21wdXRlVG9wT2Zmc2V0cyA9IG9mZnNldEF0dHJpYnV0ZVZhbHVlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUDsKICAgIGlmIChoYXNPZmZzZXRzICYmICFjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICBvZmZzZXRWYWx1ZSA9IG9mZnNldEF0dHJpYnV0ZVZhbHVlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LkFMTCA/IDEgOiAwOwogICAgICB3YWxsT2Zmc2V0QXR0cmlidXRlID0gd2FsbE9mZnNldEF0dHJpYnV0ZS5maWxsKG9mZnNldFZhbHVlKTsKICAgIH0KICAgIGxldCBwb3NJbmRleCA9IDA7CiAgICBsZXQgc3RJbmRleCA9IDA7CiAgICBsZXQgZXh0cnVkZU5vcm1hbEluZGV4ID0gMDsKICAgIGxldCB3YWxsT2Zmc2V0SW5kZXggPSAwOwogICAgY29uc3QgYXJlYTIgPSB3aWR0aCAqIHJvd0hlaWdodDsKICAgIGxldCB0aHJlZUk7CiAgICBmb3IgKGkgPSAwOyBpIDwgYXJlYTI7IGkgKz0gd2lkdGgpIHsKICAgICAgdGhyZWVJID0gaSAqIDM7CiAgICAgIHdhbGxQb3NpdGlvbnMgPSBhZGRXYWxsUG9zaXRpb25zMigKICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgIHBvc0luZGV4LAogICAgICAgIHRocmVlSSwKICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgYm90dG9tUG9zaXRpb25zCiAgICAgICk7CiAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICB3YWxsVGV4dHVyZXMgPSBhZGRXYWxsVGV4dHVyZUNvb3JkaW5hdGVzKAogICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgc3RJbmRleCwKICAgICAgICAgIGkgKiAyLAogICAgICAgICAgdG9wU3QKICAgICAgICApOwogICAgICAgIHN0SW5kZXggKz0gNDsKICAgICAgfQogICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgZXh0cnVkZU5vcm1hbEluZGV4ICs9IDM7CiAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAxXTsKICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAyXTsKICAgICAgfQogICAgICBpZiAoY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgICB3YWxsT2Zmc2V0QXR0cmlidXRlW3dhbGxPZmZzZXRJbmRleCsrXSA9IDE7CiAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgIH0KICAgIH0KICAgIGlmICghc291dGhDYXApIHsKICAgICAgZm9yIChpID0gYXJlYTIgLSB3aWR0aDsgaSA8IGFyZWEyOyBpKyspIHsKICAgICAgICB0aHJlZUkgPSBpICogMzsKICAgICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgICB0aHJlZUksCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgICBpICogMiwKICAgICAgICAgICAgdG9wU3QKICAgICAgICAgICk7CiAgICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgICAgfQogICAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBzb3V0aEluZGV4ID0gbm9ydGhDYXAgPyBhcmVhMiArIDEgOiBhcmVhMjsKICAgICAgdGhyZWVJID0gc291dGhJbmRleCAqIDM7CiAgICAgIGZvciAoaSA9IDA7IGkgPCAyOyBpKyspIHsKICAgICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgICB0aHJlZUksCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgICBzb3V0aEluZGV4ICogMiwKICAgICAgICAgICAgdG9wU3QKICAgICAgICAgICk7CiAgICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgICAgfQogICAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmb3IgKGkgPSBhcmVhMiAtIDE7IGkgPiAwOyBpIC09IHdpZHRoKSB7CiAgICAgIHRocmVlSSA9IGkgKiAzOwogICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICBwb3NJbmRleCwKICAgICAgICB0aHJlZUksCiAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgIGJvdHRvbVBvc2l0aW9ucwogICAgICApOwogICAgICBwb3NJbmRleCArPSA2OwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgIHdhbGxUZXh0dXJlcywKICAgICAgICAgIHN0SW5kZXgsCiAgICAgICAgICBpICogMiwKICAgICAgICAgIHRvcFN0CiAgICAgICAgKTsKICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgIH0KICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSV07CiAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMV07CiAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgIH0KICAgICAgaWYgKGNvbXB1dGVUb3BPZmZzZXRzKSB7CiAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgIHdhbGxPZmZzZXRJbmRleCArPSAxOwogICAgICB9CiAgICB9CiAgICBpZiAoIW5vcnRoQ2FwKSB7CiAgICAgIGZvciAoaSA9IHdpZHRoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB0aHJlZUkgPSBpICogMzsKICAgICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgICB0aHJlZUksCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgICBpICogMiwKICAgICAgICAgICAgdG9wU3QKICAgICAgICAgICk7CiAgICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgICAgfQogICAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBub3J0aEluZGV4ID0gYXJlYTI7CiAgICAgIHRocmVlSSA9IG5vcnRoSW5kZXggKiAzOwogICAgICBmb3IgKGkgPSAwOyBpIDwgMjsgaSsrKSB7CiAgICAgICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMyKAogICAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICAgIHBvc0luZGV4LAogICAgICAgICAgdGhyZWVJLAogICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgYm90dG9tUG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBwb3NJbmRleCArPSA2OwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIHdhbGxUZXh0dXJlcyA9IGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIHdhbGxUZXh0dXJlcywKICAgICAgICAgICAgc3RJbmRleCwKICAgICAgICAgICAgbm9ydGhJbmRleCAqIDIsCiAgICAgICAgICAgIHRvcFN0CiAgICAgICAgICApOwogICAgICAgICAgc3RJbmRleCArPSA0OwogICAgICAgIH0KICAgICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICBleHRydWRlTm9ybWFsSW5kZXggKz0gMzsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSV07CiAgICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAxXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDJdOwogICAgICAgIH0KICAgICAgICBpZiAoY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGVbd2FsbE9mZnNldEluZGV4KytdID0gMTsKICAgICAgICAgIHdhbGxPZmZzZXRJbmRleCArPSAxOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IGdlbyA9IGNhbGN1bGF0ZUF0dHJpYnV0ZXNXYWxsKHdhbGxQb3NpdGlvbnMsIHZlcnRleEZvcm1hdCwgZWxsaXBzb2lkKTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IHdhbGxUZXh0dXJlcwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogd2FsbEV4dHJ1ZGVOb3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKGhhc09mZnNldHMpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogd2FsbE9mZnNldEF0dHJpYnV0ZQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHdhbGxJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIHdhbGxDb3VudCwKICAgICAgcGVyaW1ldGVyUG9zaXRpb25zICogNgogICAgKTsKICAgIGxldCB1cHBlckxlZnQ7CiAgICBsZXQgbG93ZXJMZWZ0OwogICAgbGV0IGxvd2VyUmlnaHQ7CiAgICBsZXQgdXBwZXJSaWdodDsKICAgIGxlbmd0aCA9IHdhbGxQb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSArPSAyKSB7CiAgICAgIHVwcGVyTGVmdCA9IGk7CiAgICAgIHVwcGVyUmlnaHQgPSAodXBwZXJMZWZ0ICsgMikgJSBsZW5ndGg7CiAgICAgIGNvbnN0IHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh3YWxsUG9zaXRpb25zLCB1cHBlckxlZnQgKiAzLCB2MVNjcmF0Y2gpOwogICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkod2FsbFBvc2l0aW9ucywgdXBwZXJSaWdodCAqIDMsIHYyU2NyYXRjaCk7CiAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwMSwgcDIsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgbG93ZXJMZWZ0ID0gKHVwcGVyTGVmdCArIDEpICUgbGVuZ3RoOwogICAgICBsb3dlclJpZ2h0ID0gKGxvd2VyTGVmdCArIDIpICUgbGVuZ3RoOwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IHVwcGVyTGVmdDsKICAgICAgd2FsbEluZGljZXNbaW5kZXgrK10gPSBsb3dlckxlZnQ7CiAgICAgIHdhbGxJbmRpY2VzW2luZGV4KytdID0gdXBwZXJSaWdodDsKICAgICAgd2FsbEluZGljZXNbaW5kZXgrK10gPSB1cHBlclJpZ2h0OwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IGxvd2VyTGVmdDsKICAgICAgd2FsbEluZGljZXNbaW5kZXgrK10gPSBsb3dlclJpZ2h0OwogICAgfQogICAgZ2VvLmluZGljZXMgPSB3YWxsSW5kaWNlczsKICAgIGdlbyA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21iaW5lSW5zdGFuY2VzKFsKICAgICAgbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IHRvcEJvdHRvbUdlbwogICAgICB9KSwKICAgICAgbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IGdlbwogICAgICB9KQogICAgXSk7CiAgICByZXR1cm4gZ2VvWzBdOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUmVjdGFuZ2xlMyhyZWN0YW5nbGUsIGdyYW51bGFyaXR5LCByb3RhdGlvbiwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgIGlmIChyb3RhdGlvbiA9PT0gMCkgewogICAgICByZXR1cm4gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlLCByZXN1bHQpOwogICAgfQogICAgY29uc3QgY29tcHV0ZWRPcHRpb25zID0gUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZU9wdGlvbnMoCiAgICAgIHJlY3RhbmdsZSwKICAgICAgZ3JhbnVsYXJpdHksCiAgICAgIHJvdGF0aW9uLAogICAgICAwLAogICAgICByZWN0YW5nbGVTY3JhdGNoLAogICAgICBud1NjcmF0Y2gKICAgICk7CiAgICBjb25zdCBoZWlnaHQgPSBjb21wdXRlZE9wdGlvbnMuaGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSBjb21wdXRlZE9wdGlvbnMud2lkdGg7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBzY3JhdGNoUmVjdGFuZ2xlUG9pbnRzOwogICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgZmFsc2UsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIHBvc2l0aW9uc1swXQogICAgKTsKICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGZhbHNlLAogICAgICAwLAogICAgICB3aWR0aCAtIDEsCiAgICAgIHBvc2l0aW9uc1sxXQogICAgKTsKICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGZhbHNlLAogICAgICBoZWlnaHQgLSAxLAogICAgICAwLAogICAgICBwb3NpdGlvbnNbMl0KICAgICk7CiAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgZWxsaXBzb2lkLAogICAgICBmYWxzZSwKICAgICAgaGVpZ2h0IC0gMSwKICAgICAgd2lkdGggLSAxLAogICAgICBwb3NpdGlvbnNbM10KICAgICk7CiAgICByZXR1cm4gUmVjdGFuZ2xlX2RlZmF1bHQuZnJvbUNhcnRlc2lhbkFycmF5KHBvc2l0aW9ucywgZWxsaXBzb2lkLCByZXN1bHQpOwogIH0KICBmdW5jdGlvbiBSZWN0YW5nbGVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IG9wdGlvbnMucmVjdGFuZ2xlOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQuX3ZhbGlkYXRlKHJlY3RhbmdsZSk7CiAgICBpZiAocmVjdGFuZ2xlLm5vcnRoIDwgcmVjdGFuZ2xlLnNvdXRoKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnJlY3RhbmdsZS5ub3J0aCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byBvcHRpb25zLnJlY3RhbmdsZS5zb3V0aCIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX3JlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZSk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KQogICAgKTsKICAgIHRoaXMuX3N1cmZhY2VIZWlnaHQgPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX3JvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICB0aGlzLl9zdFJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdFJvdGF0aW9uLCAwKTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCkKICAgICk7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fc2hhZG93Vm9sdW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zaGFkb3dWb2x1bWUsIGZhbHNlKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkiOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl9yb3RhdGVkUmVjdGFuZ2xlID0gdm9pZCAwOwogICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czMocmVjdGFuZ2xlR2VvbWV0cnkpIHsKICAgIGlmIChyZWN0YW5nbGVHZW9tZXRyeS5fc3RSb3RhdGlvbiA9PT0gMCkgewogICAgICByZXR1cm4gWzAsIDAsIDAsIDEsIDEsIDBdOwogICAgfQogICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUoCiAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUsCiAgICAgIHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGVTY3JhdGNoCiAgICApOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSByZWN0YW5nbGVHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICBjb25zdCBlbGxpcHNvaWQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgY29uc3Qgcm90YXRpb24gPSByZWN0YW5nbGVHZW9tZXRyeS5fcm90YXRpb24gLSByZWN0YW5nbGVHZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgIGNvbnN0IHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGUgPSBjb21wdXRlUmVjdGFuZ2xlMygKICAgICAgcmVjdGFuZ2xlLAogICAgICBncmFudWxhcml0eSwKICAgICAgcm90YXRpb24sCiAgICAgIGVsbGlwc29pZCwKICAgICAgdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZVNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBwb2ludHMyRCA9IHBvaW50czJEU2NyYXRjaDI7CiAgICBwb2ludHMyRFswXS54ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS53ZXN0OwogICAgcG9pbnRzMkRbMF0ueSA9IHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGUuc291dGg7CiAgICBwb2ludHMyRFsxXS54ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS53ZXN0OwogICAgcG9pbnRzMkRbMV0ueSA9IHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGUubm9ydGg7CiAgICBwb2ludHMyRFsyXS54ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS5lYXN0OwogICAgcG9pbnRzMkRbMl0ueSA9IHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGUuc291dGg7CiAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IHJlY3RhbmdsZUdlb21ldHJ5LnJlY3RhbmdsZTsKICAgIGNvbnN0IHRvRGVzaXJlZEluQ29tcHV0ZWQgPSBNYXRyaXgyX2RlZmF1bHQuZnJvbVJvdGF0aW9uKAogICAgICByZWN0YW5nbGVHZW9tZXRyeS5fc3RSb3RhdGlvbiwKICAgICAgcm90YXRpb24yRFNjcmF0Y2gyCiAgICApOwogICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIgPSBSZWN0YW5nbGVfZGVmYXVsdC5jZW50ZXIoCiAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLAogICAgICByZWN0YW5nbGVDZW50ZXJTY3JhdGNoMgogICAgKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgKytpKSB7CiAgICAgIGNvbnN0IHBvaW50MkQgPSBwb2ludHMyRFtpXTsKICAgICAgcG9pbnQyRC54IC09IGJvdW5kaW5nUmVjdGFuZ2xlQ2VudGVyLmxvbmdpdHVkZTsKICAgICAgcG9pbnQyRC55IC09IGJvdW5kaW5nUmVjdGFuZ2xlQ2VudGVyLmxhdGl0dWRlOwogICAgICBNYXRyaXgyX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0b0Rlc2lyZWRJbkNvbXB1dGVkLCBwb2ludDJELCBwb2ludDJEKTsKICAgICAgcG9pbnQyRC54ICs9IGJvdW5kaW5nUmVjdGFuZ2xlQ2VudGVyLmxvbmdpdHVkZTsKICAgICAgcG9pbnQyRC55ICs9IGJvdW5kaW5nUmVjdGFuZ2xlQ2VudGVyLmxhdGl0dWRlOwogICAgICBwb2ludDJELnggPSAocG9pbnQyRC54IC0gYm91bmRpbmdSZWN0YW5nbGUud2VzdCkgLyBib3VuZGluZ1JlY3RhbmdsZS53aWR0aDsKICAgICAgcG9pbnQyRC55ID0gKHBvaW50MkQueSAtIGJvdW5kaW5nUmVjdGFuZ2xlLnNvdXRoKSAvIGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodDsKICAgIH0KICAgIGNvbnN0IG1pblhZQ29ybmVyID0gcG9pbnRzMkRbMF07CiAgICBjb25zdCBtYXhZQ29ybmVyID0gcG9pbnRzMkRbMV07CiAgICBjb25zdCBtYXhYQ29ybmVyID0gcG9pbnRzMkRbMl07CiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkoNik7CiAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhtaW5YWUNvcm5lciwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKG1heFlDb3JuZXIsIHJlc3VsdCwgMik7CiAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhtYXhYQ29ybmVyLCByZXN1bHQsIDQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHBvc2l0aW9uU2NyYXRjaDIsIG5vcm1hbFNjcmF0Y2g0LCB0YW5nZW50U2NyYXRjaDIsIGJpdGFuZ2VudFNjcmF0Y2gyLCByZWN0YW5nbGVTY3JhdGNoLCBzdFNjcmF0Y2gyLCBib3R0b21Cb3VuZGluZ1NwaGVyZTMsIHRvcEJvdW5kaW5nU3BoZXJlMywgdjFTY3JhdGNoLCB2MlNjcmF0Y2gsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMiwgc2NyYXRjaFJlY3RhbmdsZVBvaW50cywgbndTY3JhdGNoLCBzdE53U2NyYXRjaCwgc2NyYXRjaFJlY3RhbmdsZSwgc2NyYXRjaEVsbGlwc29pZDExLCBzY3JhdGNoT3B0aW9uczE5LCB0YW5nZW50Um90YXRpb25NYXRyaXhTY3JhdGNoLCBxdWF0ZXJuaW9uU2NyYXRjaDQsIGNlbnRlclNjcmF0Y2g0LCB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlU2NyYXRjaCwgcG9pbnRzMkRTY3JhdGNoMiwgcm90YXRpb24yRFNjcmF0Y2gyLCByZWN0YW5nbGVDZW50ZXJTY3JhdGNoMiwgUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9SZWN0YW5nbGVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDIoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgcG9zaXRpb25TY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbm9ybWFsU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRhbmdlbnRTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYml0YW5nZW50U2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJlY3RhbmdsZVNjcmF0Y2ggPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc3RTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmUzID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgdG9wQm91bmRpbmdTcGhlcmUzID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgdjFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2MlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMiA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUmVjdGFuZ2xlUG9pbnRzID0gWwogICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKQogICAgICBdOwogICAgICBud1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc3ROd1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNzsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQucGFjayh2YWx1ZS5fcmVjdGFuZ2xlLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N1cmZhY2VIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9yb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0Um90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9leHRydWRlZEhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NoYWRvd1ZvbHVtZSA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZSA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTEgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTkgPSB7CiAgICAgICAgcmVjdGFuZ2xlOiBzY3JhdGNoUmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDExLAogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdDEyLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgcm90YXRpb246IHZvaWQgMCwKICAgICAgICBzdFJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBzaGFkb3dWb2x1bWU6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUmVjdGFuZ2xlKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQxMSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDEyCiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3VyZmFjZUhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuaGVpZ2h0ID0gc3VyZmFjZUhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkucm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuc3RSb3RhdGlvbiA9IHN0Um90YXRpb247CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE5LmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE5LnNoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxOSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlLCByZXN1bHQuX3JlY3RhbmdsZSk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQuX3N1cmZhY2VIZWlnaHQgPSBzdXJmYWNlSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fcm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICByZXN1bHQuX3N0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX3NoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZSA9IGZ1bmN0aW9uKG9wdGlvbnMsIHJlc3VsdCkgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IG9wdGlvbnMucmVjdGFuZ2xlOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5fdmFsaWRhdGUocmVjdGFuZ2xlKTsKICAgICAgICBpZiAocmVjdGFuZ2xlLm5vcnRoIDwgcmVjdGFuZ2xlLnNvdXRoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIm9wdGlvbnMucmVjdGFuZ2xlLm5vcnRoIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIG9wdGlvbnMucmVjdGFuZ2xlLnNvdXRoIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCk7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJvdGF0aW9uLCAwKTsKICAgICAgICByZXR1cm4gY29tcHV0ZVJlY3RhbmdsZTMocmVjdGFuZ2xlLCBncmFudWxhcml0eSwgcm90YXRpb24sIGVsbGlwc29pZCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgdGFuZ2VudFJvdGF0aW9uTWF0cml4U2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgcXVhdGVybmlvblNjcmF0Y2g0ID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBjZW50ZXJTY3JhdGNoNCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHJlY3RhbmdsZUdlb21ldHJ5KSB7CiAgICAgICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS5ub3J0aCwKICAgICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUuc291dGgsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgKSB8fCBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUuZWFzdCwKICAgICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUud2VzdCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBsZXQgcmVjdGFuZ2xlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3JvdGF0aW9uOwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSByZWN0YW5nbGVHZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSByZWN0YW5nbGVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IGNvbXB1dGVkT3B0aW9ucyA9IFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVPcHRpb25zKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX2dyYW51bGFyaXR5LAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgcmVjdGFuZ2xlU2NyYXRjaCwKICAgICAgICAgIG53U2NyYXRjaCwKICAgICAgICAgIHN0TndTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0YW5nZW50Um90YXRpb25NYXRyaXggPSB0YW5nZW50Um90YXRpb25NYXRyaXhTY3JhdGNoOwogICAgICAgIGlmIChzdFJvdGF0aW9uICE9PSAwIHx8IHJvdGF0aW9uICE9PSAwKSB7CiAgICAgICAgICBjb25zdCBjZW50ZXIgPSBSZWN0YW5nbGVfZGVmYXVsdC5jZW50ZXIocmVjdGFuZ2xlLCBjZW50ZXJTY3JhdGNoNCk7CiAgICAgICAgICBjb25zdCBheGlzID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyhjZW50ZXIsIHYxU2NyYXRjaCk7CiAgICAgICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZShheGlzLCAtc3RSb3RhdGlvbiwgcXVhdGVybmlvblNjcmF0Y2g0KTsKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihxdWF0ZXJuaW9uU2NyYXRjaDQsIHRhbmdlbnRSb3RhdGlvbk1hdHJpeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5jbG9uZShNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFksIHRhbmdlbnRSb3RhdGlvbk1hdHJpeCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN1cmZhY2VIZWlnaHQgPSByZWN0YW5nbGVHZW9tZXRyeS5fc3VyZmFjZUhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgY29tcHV0ZWRPcHRpb25zLmxvblNjYWxhciA9IDEgLyByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlLndpZHRoOwogICAgICAgIGNvbXB1dGVkT3B0aW9ucy5sYXRTY2FsYXIgPSAxIC8gcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS5oZWlnaHQ7CiAgICAgICAgY29tcHV0ZWRPcHRpb25zLnRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IHRhbmdlbnRSb3RhdGlvbk1hdHJpeDsKICAgICAgICBsZXQgZ2VvbWV0cnk7CiAgICAgICAgbGV0IGJvdW5kaW5nU3BoZXJlOwogICAgICAgIHJlY3RhbmdsZSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGU7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIGdlb21ldHJ5ID0gY29uc3RydWN0RXh0cnVkZWRSZWN0YW5nbGUocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucyk7CiAgICAgICAgICBjb25zdCB0b3BCUyA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgICAgdG9wQm91bmRpbmdTcGhlcmUzCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgYm90dG9tQlMgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRCgKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTMKICAgICAgICAgICk7CiAgICAgICAgICBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24odG9wQlMsIGJvdHRvbUJTKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VvbWV0cnkgPSBjb25zdHJ1Y3RSZWN0YW5nbGUocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucyk7CiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgIHN1cmZhY2VIZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBzdXJmYWNlSGVpZ2h0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoIXZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgZGVsZXRlIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb247CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiBnZW9tZXRyeS5hdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogZ2VvbWV0cnkuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogcmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5jcmVhdGVTaGFkb3dWb2x1bWUgPSBmdW5jdGlvbihyZWN0YW5nbGVHZW9tZXRyeSwgbWluSGVpZ2h0RnVuYywgbWF4SGVpZ2h0RnVuYykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0ID0gbWluSGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSBtYXhIZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlR2VvbWV0cnkoewogICAgICAgICAgcmVjdGFuZ2xlOiByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlLAogICAgICAgICAgcm90YXRpb246IHJlY3RhbmdsZUdlb21ldHJ5Ll9yb3RhdGlvbiwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN0Um90YXRpb246IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBleHRydWRlZEhlaWdodDogbWF4SGVpZ2h0LAogICAgICAgICAgaGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFksCiAgICAgICAgICBzaGFkb3dWb2x1bWU6IHRydWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZVNjcmF0Y2ggPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgcG9pbnRzMkRTY3JhdGNoMiA9IFtuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpXTsKICAgICAgcm90YXRpb24yRFNjcmF0Y2gyID0gbmV3IE1hdHJpeDJfZGVmYXVsdCgpOwogICAgICByZWN0YW5nbGVDZW50ZXJTY3JhdGNoMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhSZWN0YW5nbGVHZW9tZXRyeS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHJlY3RhbmdsZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fcm90YXRlZFJlY3RhbmdsZSkpIHsKICAgICAgICAgICAgICB0aGlzLl9yb3RhdGVkUmVjdGFuZ2xlID0gY29tcHV0ZVJlY3RhbmdsZTMoCiAgICAgICAgICAgICAgICB0aGlzLl9yZWN0YW5nbGUsCiAgICAgICAgICAgICAgICB0aGlzLl9ncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIHRoaXMuX3JvdGF0aW9uLAogICAgICAgICAgICAgICAgdGhpcy5fZWxsaXBzb2lkCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcm90YXRlZFJlY3RhbmdsZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEZvciByZW1hcHBpbmcgdGV4dHVyZSBjb29yZGluYXRlcyB3aGVuIHJlbmRlcmluZyBSZWN0YW5nbGVHZW9tZXRyaWVzIGFzIEdyb3VuZFByaW1pdGl2ZXMuCiAgICAgICAgICogVGhpcyB2ZXJzaW9uIHBlcm1pdHMgc2tldyBpbiB0ZXh0dXJlcyBieSBjb21wdXRpbmcgb2Zmc2V0cyBkaXJlY3RseSBpbiBjYXJ0b2dyYXBoaWMgc3BhY2UgYW5kCiAgICAgICAgICogbW9yZSBhY2N1cmF0ZWx5IGFwcHJveGltYXRlcyByZW5kZXJpbmcgUmVjdGFuZ2xlR2VvbWV0cmllcyB3aXRoIGhlaWdodCBhcyBzdGFuZGFyZCBQcmltaXRpdmVzLgogICAgICAgICAqIEBzZWUgR2VvbWV0cnkjX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMpKSB7CiAgICAgICAgICAgICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyA9IHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMzKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5X2RlZmF1bHQgPSBSZWN0YW5nbGVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkocmVjdGFuZ2xlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHJlY3RhbmdsZUdlb21ldHJ5ID0gUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socmVjdGFuZ2xlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZSk7CiAgICByZXR1cm4gUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShyZWN0YW5nbGVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVSZWN0YW5nbGVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1JlY3RhbmdsZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNvbnN0cnVjdFJlY3RhbmdsZTIoZ2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucykgewogICAgY29uc3QgZWxsaXBzb2lkID0gZ2VvbWV0cnkuX2VsbGlwc29pZDsKICAgIGNvbnN0IGhlaWdodCA9IGNvbXB1dGVkT3B0aW9ucy5oZWlnaHQ7CiAgICBjb25zdCB3aWR0aCA9IGNvbXB1dGVkT3B0aW9ucy53aWR0aDsKICAgIGNvbnN0IG5vcnRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLm5vcnRoQ2FwOwogICAgY29uc3Qgc291dGhDYXAgPSBjb21wdXRlZE9wdGlvbnMuc291dGhDYXA7CiAgICBsZXQgcm93SGVpZ2h0ID0gaGVpZ2h0OwogICAgbGV0IHdpZHRoTXVsdGlwbGllciA9IDI7CiAgICBsZXQgc2l6ZSA9IDA7CiAgICBsZXQgY29ybmVycyA9IDQ7CiAgICBpZiAobm9ydGhDYXApIHsKICAgICAgd2lkdGhNdWx0aXBsaWVyIC09IDE7CiAgICAgIHJvd0hlaWdodCAtPSAxOwogICAgICBzaXplICs9IDE7CiAgICAgIGNvcm5lcnMgLT0gMjsKICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICB3aWR0aE11bHRpcGxpZXIgLT0gMTsKICAgICAgcm93SGVpZ2h0IC09IDE7CiAgICAgIHNpemUgKz0gMTsKICAgICAgY29ybmVycyAtPSAyOwogICAgfQogICAgc2l6ZSArPSB3aWR0aE11bHRpcGxpZXIgKiB3aWR0aCArIDIgKiByb3dIZWlnaHQgLSBjb3JuZXJzOwogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICBsZXQgcG9zSW5kZXggPSAwOwogICAgbGV0IHJvdyA9IDA7CiAgICBsZXQgY29sOwogICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvblNjcmF0Y2gzOwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGZhbHNlLAogICAgICAgIHJvdywKICAgICAgICAwLAogICAgICAgIHBvc2l0aW9uCiAgICAgICk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICB9IGVsc2UgewogICAgICBmb3IgKGNvbCA9IDA7IGNvbCA8IHdpZHRoOyBjb2wrKykgewogICAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgcm93LAogICAgICAgICAgY29sLAogICAgICAgICAgcG9zaXRpb24KICAgICAgICApOwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICB9CiAgICB9CiAgICBjb2wgPSB3aWR0aCAtIDE7CiAgICBmb3IgKHJvdyA9IDE7IHJvdyA8IGhlaWdodDsgcm93KyspIHsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgZmFsc2UsCiAgICAgICAgcm93LAogICAgICAgIGNvbCwKICAgICAgICBwb3NpdGlvbgogICAgICApOwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgfQogICAgcm93ID0gaGVpZ2h0IC0gMTsKICAgIGlmICghc291dGhDYXApIHsKICAgICAgZm9yIChjb2wgPSB3aWR0aCAtIDI7IGNvbCA+PSAwOyBjb2wtLSkgewogICAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgcm93LAogICAgICAgICAgY29sLAogICAgICAgICAgcG9zaXRpb24KICAgICAgICApOwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICB9CiAgICB9CiAgICBjb2wgPSAwOwogICAgZm9yIChyb3cgPSBoZWlnaHQgLSAyOyByb3cgPiAwOyByb3ctLSkgewogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBmYWxzZSwKICAgICAgICByb3csCiAgICAgICAgY29sLAogICAgICAgIHBvc2l0aW9uCiAgICAgICk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzU2l6ZSA9IHBvc2l0aW9ucy5sZW5ndGggLyAzICogMjsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgcG9zaXRpb25zLmxlbmd0aCAvIDMsCiAgICAgIGluZGljZXNTaXplCiAgICApOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOyBpKyspIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgMTsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBwb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICBpbmRpY2VzW2luZGV4KytdID0gMDsKICAgIGNvbnN0IGdlbyA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlczogbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCksCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgfSk7CiAgICBnZW8uYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgfSk7CiAgICBnZW8uaW5kaWNlcyA9IGluZGljZXM7CiAgICByZXR1cm4gZ2VvOwogIH0KICBmdW5jdGlvbiBjb25zdHJ1Y3RFeHRydWRlZFJlY3RhbmdsZTIocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucykgewogICAgY29uc3QgbWF4SGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3N1cmZhY2VIZWlnaHQ7CiAgICBjb25zdCBtaW5IZWlnaHQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICBjb25zdCBlbGxpcHNvaWQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgY29uc3QgZ2VvID0gY29uc3RydWN0UmVjdGFuZ2xlMihyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKTsKICAgIGNvbnN0IGhlaWdodCA9IGNvbXB1dGVkT3B0aW9ucy5oZWlnaHQ7CiAgICBjb25zdCB3aWR0aCA9IGNvbXB1dGVkT3B0aW9ucy53aWR0aDsKICAgIGNvbnN0IHRvcFBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgZ2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICBtYXhIZWlnaHQsCiAgICAgIGVsbGlwc29pZCwKICAgICAgZmFsc2UKICAgICk7CiAgICBsZXQgbGVuZ3RoID0gdG9wUG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoICogMik7CiAgICBwb3NpdGlvbnMuc2V0KHRvcFBvc2l0aW9ucyk7CiAgICBjb25zdCBib3R0b21Qb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIGdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgbWluSGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBwb3NpdGlvbnMuc2V0KGJvdHRvbVBvc2l0aW9ucywgbGVuZ3RoKTsKICAgIGdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IHBvc2l0aW9uczsKICAgIGNvbnN0IG5vcnRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLm5vcnRoQ2FwOwogICAgY29uc3Qgc291dGhDYXAgPSBjb21wdXRlZE9wdGlvbnMuc291dGhDYXA7CiAgICBsZXQgY29ybmVycyA9IDQ7CiAgICBpZiAobm9ydGhDYXApIHsKICAgICAgY29ybmVycyAtPSAxOwogICAgfQogICAgaWYgKHNvdXRoQ2FwKSB7CiAgICAgIGNvcm5lcnMgLT0gMTsKICAgIH0KICAgIGNvbnN0IGluZGljZXNTaXplID0gKHBvc2l0aW9ucy5sZW5ndGggLyAzICsgY29ybmVycykgKiAyOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBwb3NpdGlvbnMubGVuZ3RoIC8gMywKICAgICAgaW5kaWNlc1NpemUKICAgICk7CiAgICBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gNjsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyAxOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIGxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBsZW5ndGggKyAxOwogICAgfQogICAgaW5kaWNlc1tpbmRleCsrXSA9IGxlbmd0aCAtIDE7CiAgICBpbmRpY2VzW2luZGV4KytdID0gMDsKICAgIGluZGljZXNbaW5kZXgrK10gPSBsZW5ndGggKyBsZW5ndGggLSAxOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IGxlbmd0aDsKICAgIGluZGljZXNbaW5kZXgrK10gPSAwOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IGxlbmd0aDsKICAgIGxldCBib3R0b21Db3JuZXI7CiAgICBpZiAobm9ydGhDYXApIHsKICAgICAgYm90dG9tQ29ybmVyID0gaGVpZ2h0IC0gMTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHRvcFJpZ2h0Q29ybmVyID0gd2lkdGggLSAxOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wUmlnaHRDb3JuZXI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BSaWdodENvcm5lciArIGxlbmd0aDsKICAgICAgYm90dG9tQ29ybmVyID0gd2lkdGggKyBoZWlnaHQgLSAyOwogICAgfQogICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbUNvcm5lcjsKICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21Db3JuZXIgKyBsZW5ndGg7CiAgICBpZiAoIXNvdXRoQ2FwKSB7CiAgICAgIGNvbnN0IGJvdHRvbUxlZnRDb3JuZXIgPSB3aWR0aCArIGJvdHRvbUNvcm5lciAtIDE7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21MZWZ0Q29ybmVyOwogICAgICBpbmRpY2VzW2luZGV4XSA9IGJvdHRvbUxlZnRDb3JuZXIgKyBsZW5ndGg7CiAgICB9CiAgICBnZW8uaW5kaWNlcyA9IGluZGljZXM7CiAgICByZXR1cm4gZ2VvOwogIH0KICBmdW5jdGlvbiBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCByZWN0YW5nbGUgPSBvcHRpb25zLnJlY3RhbmdsZTsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCk7CiAgICBjb25zdCByb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucm90YXRpb24sIDApOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVjdGFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgUmVjdGFuZ2xlX2RlZmF1bHQuX3ZhbGlkYXRlKHJlY3RhbmdsZSk7CiAgICBpZiAocmVjdGFuZ2xlLm5vcnRoIDwgcmVjdGFuZ2xlLnNvdXRoKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnJlY3RhbmdsZS5ub3J0aCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvcHRpb25zLnJlY3RhbmdsZS5zb3V0aCIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX3JlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZSk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5fZWxsaXBzb2lkID0gZWxsaXBzb2lkOwogICAgdGhpcy5fc3VyZmFjZUhlaWdodCA9IE1hdGgubWF4KGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fcm90YXRpb24gPSByb3RhdGlvbjsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIGJvdHRvbUJvdW5kaW5nU3BoZXJlNCwgdG9wQm91bmRpbmdTcGhlcmU0LCBwb3NpdGlvblNjcmF0Y2gzLCByZWN0YW5nbGVTY3JhdGNoMiwgc2NyYXRjaFJlY3RhbmdsZTIsIHNjcmF0Y2hFbGxpcHNvaWQxMiwgc2NyYXRjaE9wdGlvbnMyMCwgbndTY3JhdGNoMiwgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlNCA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlNCA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIHBvc2l0aW9uU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJlY3RhbmdsZVNjcmF0Y2gyID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA1OwogICAgICBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrKHZhbHVlLl9yZWN0YW5nbGUsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3VyZmFjZUhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3JvdGF0aW9uOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoUmVjdGFuZ2xlMiA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTIgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMjAgPSB7CiAgICAgICAgcmVjdGFuZ2xlOiBzY3JhdGNoUmVjdGFuZ2xlMiwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQxMiwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIHJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hSZWN0YW5nbGUyKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQxMik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIwLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIwLmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjAucm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjAuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjAub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMjApOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3JlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZSwgcmVzdWx0Ll9yZWN0YW5nbGUpOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll9zdXJmYWNlSGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJlc3VsdC5fcm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICByZXN1bHQuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIG53U2NyYXRjaDIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocmVjdGFuZ2xlR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCByZWN0YW5nbGUgPSByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgY29tcHV0ZWRPcHRpb25zID0gUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZU9wdGlvbnMoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICByZWN0YW5nbGVHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICByZWN0YW5nbGVHZW9tZXRyeS5fcm90YXRpb24sCiAgICAgICAgICAwLAogICAgICAgICAgcmVjdGFuZ2xlU2NyYXRjaDIsCiAgICAgICAgICBud1NjcmF0Y2gyCiAgICAgICAgKTsKICAgICAgICBsZXQgZ2VvbWV0cnk7CiAgICAgICAgbGV0IGJvdW5kaW5nU3BoZXJlOwogICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApIHx8IE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgcmVjdGFuZ2xlLmVhc3QsCiAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdXJmYWNlSGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3N1cmZhY2VIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHN1cmZhY2VIZWlnaHQsCiAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgIDAsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjIKICAgICAgICApOwogICAgICAgIGxldCBvZmZzZXRWYWx1ZTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgZ2VvbWV0cnkgPSBjb25zdHJ1Y3RFeHRydWRlZFJlY3RhbmdsZTIocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucyk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgICAgICAgICBsZXQgb2Zmc2V0QXR0cmlidXRlID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7CiAgICAgICAgICAgIGlmIChyZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKDEsIDAsIHNpemUgLyAyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBvZmZzZXRWYWx1ZSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICB2YWx1ZXM6IG9mZnNldEF0dHJpYnV0ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHRvcEJTID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgICB0b3BCb3VuZGluZ1NwaGVyZTQKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21CUyA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlNAogICAgICAgICAgKTsKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbih0b3BCUywgYm90dG9tQlMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW9tZXRyeSA9IGNvbnN0cnVjdFJlY3RhbmdsZTIocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucyk7CiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgIHN1cmZhY2VIZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgb2Zmc2V0VmFsdWUgPSByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBzdXJmYWNlSGVpZ2h0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlczogZ2VvbWV0cnkuYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogcmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeShyZWN0YW5nbGVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkgPSBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnksCiAgICAgICAgb2Zmc2V0CiAgICAgICk7CiAgICB9CiAgICByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZSk7CiAgICByZXR1cm4gUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocmVjdGFuZ2xlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TaW1wbGVQb2x5bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gaW50ZXJwb2xhdGVDb2xvcnMyKHAwLCBwMSwgY29sb3IwLCBjb2xvcjEsIG1pbkRpc3RhbmNlLCBhcnJheSwgb2Zmc2V0KSB7CiAgICBjb25zdCBudW1Qb2ludHMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQubnVtYmVyT2ZQb2ludHMocDAsIHAxLCBtaW5EaXN0YW5jZSk7CiAgICBsZXQgaTsKICAgIGNvbnN0IHIwID0gY29sb3IwLnJlZDsKICAgIGNvbnN0IGcwID0gY29sb3IwLmdyZWVuOwogICAgY29uc3QgYjAgPSBjb2xvcjAuYmx1ZTsKICAgIGNvbnN0IGEwID0gY29sb3IwLmFscGhhOwogICAgY29uc3QgcjEgPSBjb2xvcjEucmVkOwogICAgY29uc3QgZzEgPSBjb2xvcjEuZ3JlZW47CiAgICBjb25zdCBiMSA9IGNvbG9yMS5ibHVlOwogICAgY29uc3QgYTEgPSBjb2xvcjEuYWxwaGE7CiAgICBpZiAoQ29sb3JfZGVmYXVsdC5lcXVhbHMoY29sb3IwLCBjb2xvcjEpKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICAgIGFycmF5W29mZnNldCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUocjApOwogICAgICAgIGFycmF5W29mZnNldCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoZzApOwogICAgICAgIGFycmF5W29mZnNldCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoYjApOwogICAgICAgIGFycmF5W29mZnNldCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoYTApOwogICAgICB9CiAgICAgIHJldHVybiBvZmZzZXQ7CiAgICB9CiAgICBjb25zdCByZWRQZXJWZXJ0ZXggPSAocjEgLSByMCkgLyBudW1Qb2ludHM7CiAgICBjb25zdCBncmVlblBlclZlcnRleCA9IChnMSAtIGcwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGJsdWVQZXJWZXJ0ZXggPSAoYjEgLSBiMCkgLyBudW1Qb2ludHM7CiAgICBjb25zdCBhbHBoYVBlclZlcnRleCA9IChhMSAtIGEwKSAvIG51bVBvaW50czsKICAgIGxldCBpbmRleCA9IG9mZnNldDsKICAgIGZvciAoaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICBhcnJheVtpbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUocjAgKyBpICogcmVkUGVyVmVydGV4KTsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGcwICsgaSAqIGdyZWVuUGVyVmVydGV4KTsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGIwICsgaSAqIGJsdWVQZXJWZXJ0ZXgpOwogICAgICBhcnJheVtpbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoYTAgKyBpICogYWxwaGFQZXJWZXJ0ZXgpOwogICAgfQogICAgcmV0dXJuIGluZGV4OwogIH0KICBmdW5jdGlvbiBTaW1wbGVQb2x5bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCBjb2xvcnMgPSBvcHRpb25zLmNvbG9yczsKICAgIGNvbnN0IGNvbG9yc1BlclZlcnRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY29sb3JzUGVyVmVydGV4LCBmYWxzZSk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpIHx8IHBvc2l0aW9ucy5sZW5ndGggPCAyKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBdCBsZWFzdCB0d28gcG9zaXRpb25zIGFyZSByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSAmJiAoY29sb3JzUGVyVmVydGV4ICYmIGNvbG9ycy5sZW5ndGggPCBwb3NpdGlvbnMubGVuZ3RoIHx8ICFjb2xvcnNQZXJWZXJ0ZXggJiYgY29sb3JzLmxlbmd0aCA8IHBvc2l0aW9ucy5sZW5ndGggLSAxKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY29sb3JzIGhhcyBhbiBpbnZhbGlkIGxlbmd0aC4iKTsKICAgIH0KICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgIHRoaXMuX2NvbG9ycyA9IGNvbG9yczsKICAgIHRoaXMuX2NvbG9yc1BlclZlcnRleCA9IGNvbG9yc1BlclZlcnRleDsKICAgIHRoaXMuX2FyY1R5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUsIEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LmRlZmF1bHQpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgbnVtQ29tcG9uZW50cyArPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSA/IDEgKyBjb2xvcnMubGVuZ3RoICogQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGggOiAxOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMzsKICB9CiAgdmFyIHNjcmF0Y2hBcnJheTEsIHNjcmF0Y2hBcnJheTIsIGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2gsIFNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9TaW1wbGVQb2x5bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TaW1wbGVQb2x5bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29sb3IoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlsaW5lUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIFNpbXBsZVBvbHlsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb2xvcnMgPSB2YWx1ZS5fY29sb3JzOwogICAgICAgIGxlbmd0aCA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gY29sb3JzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENvbG9yX2RlZmF1bHQucGFjayhjb2xvcnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9jb2xvcnNQZXJWZXJ0ZXggPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2FyY1R5cGU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBTaW1wbGVQb2x5bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGNvbG9ycyA9IGxlbmd0aCA+IDAgPyBuZXcgQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIGNvbG9yc1tpXSA9IENvbG9yX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBjb2xvcnNQZXJWZXJ0ZXggPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBTaW1wbGVQb2x5bGluZUdlb21ldHJ5KHsKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBjb2xvcnMsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgY29sb3JzUGVyVmVydGV4LAogICAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgICBncmFudWxhcml0eQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fY29sb3JzID0gY29sb3JzOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gZWxsaXBzb2lkOwogICAgICAgIHJlc3VsdC5fY29sb3JzUGVyVmVydGV4ID0gY29sb3JzUGVyVmVydGV4OwogICAgICAgIHJlc3VsdC5fYXJjVHlwZSA9IGFyY1R5cGU7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hBcnJheTEgPSBuZXcgQXJyYXkoMik7CiAgICAgIHNjcmF0Y2hBcnJheTIgPSBuZXcgQXJyYXkoMik7CiAgICAgIGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2ggPSB7CiAgICAgICAgcG9zaXRpb25zOiBzY3JhdGNoQXJyYXkxLAogICAgICAgIGhlaWdodDogc2NyYXRjaEFycmF5MiwKICAgICAgICBlbGxpcHNvaWQ6IHZvaWQgMCwKICAgICAgICBtaW5EaXN0YW5jZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAKICAgICAgfTsKICAgICAgU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBzaW1wbGVQb2x5bGluZUdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgY29sb3JzID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fY29sb3JzOwogICAgICAgIGNvbnN0IGNvbG9yc1BlclZlcnRleCA9IHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2NvbG9yc1BlclZlcnRleDsKICAgICAgICBjb25zdCBhcmNUeXBlID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fYXJjVHlwZTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aCgKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMKICAgICAgICApOwogICAgICAgIGNvbnN0IHBlclNlZ21lbnRDb2xvcnMgPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSAmJiAhY29sb3JzUGVyVmVydGV4OwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IHBvc2l0aW9uVmFsdWVzOwogICAgICAgIGxldCBudW1iZXJPZlBvc2l0aW9uczsKICAgICAgICBsZXQgY29sb3JWYWx1ZXM7CiAgICAgICAgbGV0IGNvbG9yOwogICAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMgfHwgYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICBsZXQgc3ViZGl2aXNpb25TaXplOwogICAgICAgICAgbGV0IG51bWJlck9mUG9pbnRzRnVuY3Rpb247CiAgICAgICAgICBsZXQgZ2VuZXJhdGVBcmNGdW5jdGlvbjsKICAgICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgc3ViZGl2aXNpb25TaXplID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG51bWJlck9mUG9pbnRzRnVuY3Rpb24gPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQubnVtYmVyT2ZQb2ludHM7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjRnVuY3Rpb24gPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdWJkaXZpc2lvblNpemUgPSBncmFudWxhcml0eTsKICAgICAgICAgICAgbnVtYmVyT2ZQb2ludHNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5udW1iZXJPZlBvaW50c1JodW1iTGluZTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZVJodW1iQXJjOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaGVpZ2h0cyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5leHRyYWN0SGVpZ2h0cyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICAgICAgICBjb25zdCBnZW5lcmF0ZUFyY09wdGlvbnMgPSBnZW5lcmF0ZUFyY09wdGlvbnNTY3JhdGNoOwogICAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMubWluRGlzdGFuY2UgPSBtaW5EaXN0YW5jZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgfQogICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmVsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgICAgICAgIGlmIChwZXJTZWdtZW50Q29sb3JzKSB7CiAgICAgICAgICAgIGxldCBwb3NpdGlvbkNvdW50ID0gMDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICAgIHBvc2l0aW9uQ291bnQgKz0gbnVtYmVyT2ZQb2ludHNGdW5jdGlvbigKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMV0sCiAgICAgICAgICAgICAgICBzdWJkaXZpc2lvblNpemUKICAgICAgICAgICAgICApICsgMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb3NpdGlvblZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkocG9zaXRpb25Db3VudCAqIDMpOwogICAgICAgICAgICBjb2xvclZhbHVlcyA9IG5ldyBVaW50OEFycmF5KHBvc2l0aW9uQ291bnQgKiA0KTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLnBvc2l0aW9ucyA9IHNjcmF0Y2hBcnJheTE7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5oZWlnaHQgPSBzY3JhdGNoQXJyYXkyOwogICAgICAgICAgICBsZXQgY2kgPSAwOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgc2NyYXRjaEFycmF5MVswXSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgICBzY3JhdGNoQXJyYXkxWzFdID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgICAgICBzY3JhdGNoQXJyYXkyWzBdID0gaGVpZ2h0c1tpXTsKICAgICAgICAgICAgICBzY3JhdGNoQXJyYXkyWzFdID0gaGVpZ2h0c1tpICsgMV07CiAgICAgICAgICAgICAgY29uc3QgcG9zID0gZ2VuZXJhdGVBcmNGdW5jdGlvbihnZW5lcmF0ZUFyY09wdGlvbnMpOwogICAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSkgewogICAgICAgICAgICAgICAgY29uc3Qgc2VnTGVuID0gcG9zLmxlbmd0aCAvIDM7CiAgICAgICAgICAgICAgICBjb2xvciA9IGNvbG9yc1tpXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgc2VnTGVuOyArK2spIHsKICAgICAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY2krK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLnJlZCk7CiAgICAgICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NpKytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ncmVlbik7CiAgICAgICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NpKytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ibHVlKTsKICAgICAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY2krK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmFscGhhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcG9zaXRpb25WYWx1ZXMuc2V0KHBvcywgb2Zmc2V0KTsKICAgICAgICAgICAgICBvZmZzZXQgKz0gcG9zLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLnBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmhlaWdodCA9IGhlaWdodHM7CiAgICAgICAgICAgIHBvc2l0aW9uVmFsdWVzID0gbmV3IEZsb2F0NjRBcnJheSgKICAgICAgICAgICAgICBnZW5lcmF0ZUFyY0Z1bmN0aW9uKGdlbmVyYXRlQXJjT3B0aW9ucykKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpKSB7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXMgPSBuZXcgVWludDhBcnJheShwb3NpdGlvblZhbHVlcy5sZW5ndGggLyAzICogNCk7CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7ICsraSkgewogICAgICAgICAgICAgICAgY29uc3QgcDAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgICAgICBjb25zdCBwMSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICAgICAgICBjb25zdCBjMCA9IGNvbG9yc1tpXTsKICAgICAgICAgICAgICAgIGNvbnN0IGMxID0gY29sb3JzW2kgKyAxXTsKICAgICAgICAgICAgICAgIG9mZnNldCA9IGludGVycG9sYXRlQ29sb3JzMigKICAgICAgICAgICAgICAgICAgcDAsCiAgICAgICAgICAgICAgICAgIHAxLAogICAgICAgICAgICAgICAgICBjMCwKICAgICAgICAgICAgICAgICAgYzEsCiAgICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgICAgICBjb2xvclZhbHVlcywKICAgICAgICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBsYXN0Q29sb3IgPSBjb2xvcnNbbGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShsYXN0Q29sb3IucmVkKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGxhc3RDb2xvci5ncmVlbik7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShsYXN0Q29sb3IuYmx1ZSk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShsYXN0Q29sb3IuYWxwaGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG51bWJlck9mUG9zaXRpb25zID0gcGVyU2VnbWVudENvbG9ycyA/IGxlbmd0aCAqIDIgLSAyIDogbGVuZ3RoOwogICAgICAgICAgcG9zaXRpb25WYWx1ZXMgPSBuZXcgRmxvYXQ2NEFycmF5KG51bWJlck9mUG9zaXRpb25zICogMyk7CiAgICAgICAgICBjb2xvclZhbHVlcyA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gbmV3IFVpbnQ4QXJyYXkobnVtYmVyT2ZQb3NpdGlvbnMgKiA0KSA6IHZvaWQgMDsKICAgICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICAgIGxldCBjb2xvckluZGV4ID0gMDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBjb25zdCBwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICBpZiAocGVyU2VnbWVudENvbG9ycyAmJiBpID4gMCkgewogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHAsIHBvc2l0aW9uVmFsdWVzLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICAgICAgICBwb3NpdGlvbkluZGV4ICs9IDM7CiAgICAgICAgICAgICAgY29sb3IgPSBjb2xvcnNbaSAtIDFdOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLnJlZCk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuZ3JlZW4pOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmJsdWUpOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmFscGhhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGVyU2VnbWVudENvbG9ycyAmJiBpID09PSBsZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socCwgcG9zaXRpb25WYWx1ZXMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgICBwb3NpdGlvbkluZGV4ICs9IDM7CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSkgewogICAgICAgICAgICAgIGNvbG9yID0gY29sb3JzW2ldOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLnJlZCk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuZ3JlZW4pOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmJsdWUpOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmFscGhhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9uVmFsdWVzCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmNvbG9yID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiA0LAogICAgICAgICAgICB2YWx1ZXM6IGNvbG9yVmFsdWVzLAogICAgICAgICAgICBub3JtYWxpemU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBudW1iZXJPZlBvc2l0aW9ucyA9IHBvc2l0aW9uVmFsdWVzLmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgbnVtYmVyT2ZJbmRpY2VzID0gKG51bWJlck9mUG9zaXRpb25zIC0gMSkgKiAyOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIG51bWJlck9mUG9zaXRpb25zLAogICAgICAgICAgbnVtYmVyT2ZJbmRpY2VzCiAgICAgICAgKTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1iZXJPZlBvc2l0aW9ucyAtIDE7ICsraSkgewogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBTaW1wbGVQb2x5bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkoc2ltcGxlUG9seWxpbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgc2ltcGxlUG9seWxpbmVHZW9tZXRyeSA9IFNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgc2ltcGxlUG9seWxpbmVHZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBzaW1wbGVQb2x5bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQKICAgICk7CiAgICByZXR1cm4gU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9TaW1wbGVQb2x5bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TcGhlcmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFNwaGVyZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIGNvbnN0IHJhZGl1cyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucmFkaXVzLCAxKTsKICAgIGNvbnN0IHJhZGlpID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdChyYWRpdXMsIHJhZGl1cywgcmFkaXVzKTsKICAgIGNvbnN0IGVsbGlwc29pZE9wdGlvbnMgPSB7CiAgICAgIHJhZGlpLAogICAgICBzdGFja1BhcnRpdGlvbnM6IG9wdGlvbnMuc3RhY2tQYXJ0aXRpb25zLAogICAgICBzbGljZVBhcnRpdGlvbnM6IG9wdGlvbnMuc2xpY2VQYXJ0aXRpb25zLAogICAgICB2ZXJ0ZXhGb3JtYXQ6IG9wdGlvbnMudmVydGV4Rm9ybWF0CiAgICB9OwogICAgdGhpcy5fZWxsaXBzb2lkR2VvbWV0cnkgPSBuZXcgRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdChlbGxpcHNvaWRPcHRpb25zKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlU3BoZXJlR2VvbWV0cnkiOwogIH0KICB2YXIgc2NyYXRjaEVsbGlwc29pZEdlb21ldHJ5LCBzY3JhdGNoT3B0aW9uczIxLCBTcGhlcmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1NwaGVyZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TcGhlcmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZEdlb21ldHJ5KCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIFNwaGVyZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBTcGhlcmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICByZXR1cm4gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWRHZW9tZXRyeSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkR2VvbWV0cnkgPSBuZXcgRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczIxID0gewogICAgICAgIHJhZGl1czogdm9pZCAwLAogICAgICAgIHJhZGlpOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgdmVydGV4Rm9ybWF0OiBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKSwKICAgICAgICBzdGFja1BhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzbGljZVBhcnRpdGlvbnM6IHZvaWQgMAogICAgICB9OwogICAgICBTcGhlcmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeQogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMS52ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIGVsbGlwc29pZEdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIxLnZlcnRleEZvcm1hdAogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMS5zdGFja1BhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc3RhY2tQYXJ0aXRpb25zOwogICAgICAgIHNjcmF0Y2hPcHRpb25zMjEuc2xpY2VQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3NsaWNlUGFydGl0aW9uczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIxLnJhZGl1cyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaS54OwogICAgICAgICAgcmV0dXJuIG5ldyBTcGhlcmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIxKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaSwgc2NyYXRjaE9wdGlvbnMyMS5yYWRpaSk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0KHNjcmF0Y2hPcHRpb25zMjEpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFNwaGVyZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oc3BoZXJlR2VvbWV0cnkpIHsKICAgICAgICByZXR1cm4gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShzcGhlcmVHZW9tZXRyeS5fZWxsaXBzb2lkR2VvbWV0cnkpOwogICAgICB9OwogICAgICBTcGhlcmVHZW9tZXRyeV9kZWZhdWx0ID0gU3BoZXJlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVTcGhlcmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVTcGhlcmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlU3BoZXJlR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlU3BoZXJlR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVNwaGVyZUdlb21ldHJ5KHNwaGVyZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBzcGhlcmVHZW9tZXRyeSA9IFNwaGVyZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHNwaGVyZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIFNwaGVyZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoc3BoZXJlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlU3BoZXJlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVTcGhlcmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlU3BoZXJlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9TcGhlcmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVTcGhlcmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlU3BoZXJlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TcGhlcmVPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBTcGhlcmVPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgY29uc3QgcmFkaXVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yYWRpdXMsIDEpOwogICAgY29uc3QgcmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHJhZGl1cywgcmFkaXVzLCByYWRpdXMpOwogICAgY29uc3QgZWxsaXBzb2lkT3B0aW9ucyA9IHsKICAgICAgcmFkaWksCiAgICAgIHN0YWNrUGFydGl0aW9uczogb3B0aW9ucy5zdGFja1BhcnRpdGlvbnMsCiAgICAgIHNsaWNlUGFydGl0aW9uczogb3B0aW9ucy5zbGljZVBhcnRpdGlvbnMsCiAgICAgIHN1YmRpdmlzaW9uczogb3B0aW9ucy5zdWJkaXZpc2lvbnMKICAgIH07CiAgICB0aGlzLl9lbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdChlbGxpcHNvaWRPcHRpb25zKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeTIsIHNjcmF0Y2hPcHRpb25zMjIsIFNwaGVyZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1NwaGVyZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvU3BoZXJlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIFNwaGVyZU91dGxpbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIFNwaGVyZU91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICByZXR1cm4gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQucGFjaygKICAgICAgICAgIHZhbHVlLl9lbGxpcHNvaWRHZW9tZXRyeSwKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleAogICAgICAgICk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeTIgPSBuZXcgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMyMiA9IHsKICAgICAgICByYWRpdXM6IHZvaWQgMCwKICAgICAgICByYWRpaTogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHN0YWNrUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIHNsaWNlUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIHN1YmRpdmlzaW9uczogdm9pZCAwCiAgICAgIH07CiAgICAgIFNwaGVyZU91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoRWxsaXBzb2lkR2VvbWV0cnkyCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczIyLnN0YWNrUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zdGFja1BhcnRpdGlvbnM7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMi5zbGljZVBhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIHNjcmF0Y2hPcHRpb25zMjIuc3ViZGl2aXNpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3N1YmRpdmlzaW9uczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIyLnJhZGl1cyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaS54OwogICAgICAgICAgcmV0dXJuIG5ldyBTcGhlcmVPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMyMik7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWRHZW9tZXRyeS5fcmFkaWksIHNjcmF0Y2hPcHRpb25zMjIucmFkaWkpOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkR2VvbWV0cnkgPSBuZXcgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoc2NyYXRjaE9wdGlvbnMyMik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgU3BoZXJlT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oc3BoZXJlR2VvbWV0cnkpIHsKICAgICAgICByZXR1cm4gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoCiAgICAgICAgICBzcGhlcmVHZW9tZXRyeS5fZWxsaXBzb2lkR2VvbWV0cnkKICAgICAgICApOwogICAgICB9OwogICAgICBTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFNwaGVyZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeShzcGhlcmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgc3BoZXJlR2VvbWV0cnkgPSBTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soc3BoZXJlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gU3BoZXJlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoc3BoZXJlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9TcGhlcmVPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lcy5qcwogIHZhciBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lc19leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXNfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGRlY29kZVBvc2l0aW9ucyh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIsIHJlY3RhbmdsZSwgbWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSB1QnVmZmVyLmxlbmd0aDsKICAgIGNvbnN0IGRlY29kZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHBvc2l0aW9uc0xlbmd0aCAqIDMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBjb25zdCB1MyA9IHVCdWZmZXJbaV07CiAgICAgIGNvbnN0IHYzID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodEJ1ZmZlcltpXTsKICAgICAgY29uc3QgbG9uID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5lYXN0LCB1MyAvIE1BWF9TSE9SVCk7CiAgICAgIGNvbnN0IGxhdCA9IE1hdGhfZGVmYXVsdC5sZXJwKAogICAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgICAgdjMgLyBNQVhfU0hPUlQKICAgICAgKTsKICAgICAgY29uc3QgYWx0ID0gTWF0aF9kZWZhdWx0LmxlcnAobWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgaCAvIE1BWF9TSE9SVCk7CiAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICBsb24sCiAgICAgICAgbGF0LAogICAgICAgIGFsdCwKICAgICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMKICAgICAgKTsKICAgICAgY29uc3QgZGVjb2RlZFBvc2l0aW9uID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgIGNhcnRvZ3JhcGhpYzIsCiAgICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbgogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhkZWNvZGVkUG9zaXRpb24sIGRlY29kZWRQb3NpdGlvbnMsIGkgKiAzKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVkUG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBnZXRQb3NpdGlvbk9mZnNldHMoY291bnRzKSB7CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgY29uc3QgcG9zaXRpb25PZmZzZXRzID0gbmV3IFVpbnQzMkFycmF5KGNvdW50c0xlbmd0aCArIDEpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIHBvc2l0aW9uT2Zmc2V0c1tpXSA9IG9mZnNldDsKICAgICAgb2Zmc2V0ICs9IGNvdW50c1tpXTsKICAgIH0KICAgIHBvc2l0aW9uT2Zmc2V0c1tjb3VudHNMZW5ndGhdID0gb2Zmc2V0OwogICAgcmV0dXJuIHBvc2l0aW9uT2Zmc2V0czsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlRHVwbGljYXRlcyh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIsIGNvdW50cykgewogICAgY29uc3QgY291bnRzTGVuZ3RoID0gY291bnRzLmxlbmd0aDsKICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHVCdWZmZXIubGVuZ3RoOwogICAgY29uc3QgbWFya1JlbW92YWwgPSBuZXcgVWludDhBcnJheShwb3NpdGlvbnNMZW5ndGgpOwogICAgY29uc3QgcHJldmlvdXMgPSBwcmV2aW91c0NvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoOwogICAgY29uc3QgY3VycmVudCA9IGN1cnJlbnRDb21wcmVzc2VkQ2FydG9ncmFwaGljU2NyYXRjaDsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjb3VudCA9IGNvdW50c1tpXTsKICAgICAgbGV0IHVwZGF0ZWRDb3VudCA9IGNvdW50OwogICAgICBmb3IgKGxldCBqID0gMTsgaiA8IGNvdW50OyBqKyspIHsKICAgICAgICBjb25zdCBpbmRleCA9IG9mZnNldCArIGo7CiAgICAgICAgY29uc3QgcHJldmlvdXNJbmRleCA9IGluZGV4IC0gMTsKICAgICAgICBjdXJyZW50LmxvbmdpdHVkZSA9IHVCdWZmZXJbaW5kZXhdOwogICAgICAgIGN1cnJlbnQubGF0aXR1ZGUgPSB2QnVmZmVyW2luZGV4XTsKICAgICAgICBwcmV2aW91cy5sb25naXR1ZGUgPSB1QnVmZmVyW3ByZXZpb3VzSW5kZXhdOwogICAgICAgIHByZXZpb3VzLmxhdGl0dWRlID0gdkJ1ZmZlcltwcmV2aW91c0luZGV4XTsKICAgICAgICBpZiAoQ2FydG9ncmFwaGljX2RlZmF1bHQuZXF1YWxzKGN1cnJlbnQsIHByZXZpb3VzKSkgewogICAgICAgICAgdXBkYXRlZENvdW50LS07CiAgICAgICAgICBtYXJrUmVtb3ZhbFtwcmV2aW91c0luZGV4XSA9IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvdW50c1tpXSA9IHVwZGF0ZWRDb3VudDsKICAgICAgb2Zmc2V0ICs9IGNvdW50OwogICAgfQogICAgbGV0IG5leHRBdmFpbGFibGVJbmRleCA9IDA7CiAgICBmb3IgKGxldCBrID0gMDsgayA8IHBvc2l0aW9uc0xlbmd0aDsgaysrKSB7CiAgICAgIGlmIChtYXJrUmVtb3ZhbFtrXSAhPT0gMSkgewogICAgICAgIHVCdWZmZXJbbmV4dEF2YWlsYWJsZUluZGV4XSA9IHVCdWZmZXJba107CiAgICAgICAgdkJ1ZmZlcltuZXh0QXZhaWxhYmxlSW5kZXhdID0gdkJ1ZmZlcltrXTsKICAgICAgICBoZWlnaHRCdWZmZXJbbmV4dEF2YWlsYWJsZUluZGV4XSA9IGhlaWdodEJ1ZmZlcltrXTsKICAgICAgICBuZXh0QXZhaWxhYmxlSW5kZXgrKzsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBWZXJ0ZXhBdHRyaWJ1dGVzQW5kSW5kaWNlcyh2b2x1bWVzQ291bnQpIHsKICAgIGNvbnN0IHZlcnRleENvdW50ID0gdm9sdW1lc0NvdW50ICogODsKICAgIGNvbnN0IHZlYzNGbG9hdHMgPSB2ZXJ0ZXhDb3VudCAqIDM7CiAgICBjb25zdCB2ZWM0RmxvYXRzID0gdmVydGV4Q291bnQgKiA0OwogICAgdGhpcy5zdGFydEVsbGlwc29pZE5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzNGbG9hdHMpOwogICAgdGhpcy5lbmRFbGxpcHNvaWROb3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheSh2ZWMzRmxvYXRzKTsKICAgIHRoaXMuc3RhcnRQb3NpdGlvbkFuZEhlaWdodHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzRGbG9hdHMpOwogICAgdGhpcy5zdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzRGbG9hdHMpOwogICAgdGhpcy5lbmRQb3NpdGlvbkFuZEhlaWdodHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzRGbG9hdHMpOwogICAgdGhpcy5lbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRocyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjNEZsb2F0cyk7CiAgICB0aGlzLnZlcnRleEJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KHZlcnRleENvdW50KTsKICAgIHRoaXMuaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHZlcnRleENvdW50LCAzNiAqIHZvbHVtZXNDb3VudCk7CiAgICB0aGlzLnZlYzNPZmZzZXQgPSAwOwogICAgdGhpcy52ZWM0T2Zmc2V0ID0gMDsKICAgIHRoaXMuYmF0Y2hJZE9mZnNldCA9IDA7CiAgICB0aGlzLmluZGV4T2Zmc2V0ID0gMDsKICAgIHRoaXMudm9sdW1lU3RhcnRJbmRleCA9IDA7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVNaXRlcmVkTm9ybWFsKHByZXZpb3VzUG9zaXRpb24sIHBvc2l0aW9uLCBuZXh0UG9zaXRpb24sIGVsbGlwc29pZFN1cmZhY2VOb3JtYWwsIHJlc3VsdCkgewogICAgY29uc3QgdG93YXJkTmV4dCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgbmV4dFBvc2l0aW9uLAogICAgICBwb3NpdGlvbiwKICAgICAgdG93YXJkTmV4dFNjcmF0Y2gKICAgICk7CiAgICBsZXQgdG93YXJkQ3VyciA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgcG9zaXRpb24sCiAgICAgIHByZXZpb3VzUG9zaXRpb24sCiAgICAgIHRvd2FyZEN1cnJTY3JhdGNoCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh0b3dhcmROZXh0LCB0b3dhcmROZXh0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodG93YXJkQ3VyciwgdG93YXJkQ3Vycik7CiAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0b3dhcmROZXh0LCB0b3dhcmRDdXJyKSA8IE1JVEVSX0JSRUFLKSB7CiAgICAgIHRvd2FyZEN1cnIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICB0b3dhcmRDdXJyLAogICAgICAgIC0xLAogICAgICAgIHRvd2FyZEN1cnJTY3JhdGNoCiAgICAgICk7CiAgICB9CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHRvd2FyZE5leHQsIHRvd2FyZEN1cnIsIHJlc3VsdCk7CiAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhyZXN1bHQsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocHJldmlvdXNQb3NpdGlvbiwgcG9zaXRpb24pOwogICAgfQogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHJlc3VsdCwgZWxsaXBzb2lkU3VyZmFjZU5vcm1hbCwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhlbGxpcHNvaWRTdXJmYWNlTm9ybWFsLCByZXN1bHQsIHJlc3VsdCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGVuY29kZWRQb3NpdGlvbnMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5wb3NpdGlvbnMpOwogICAgY29uc3Qgd2lkdGhzID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMud2lkdGhzKTsKICAgIGNvbnN0IGNvdW50cyA9IG5ldyBVaW50MzJBcnJheShwYXJhbWV0ZXJzLmNvdW50cyk7CiAgICBjb25zdCBiYXRjaElkcyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLmJhdGNoSWRzKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IHNjcmF0Y2hSZWN0YW5nbGUzOwogICAgY29uc3QgZWxsaXBzb2lkID0gc2NyYXRjaEVsbGlwc29pZDEzOwogICAgY29uc3QgY2VudGVyID0gc2NyYXRjaENlbnRlcjQ7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KHBhcmFtZXRlcnMucGFja2VkQnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgY29uc3QgbWluaW11bUhlaWdodCA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBjb25zdCBtYXhpbXVtSGVpZ2h0ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIFJlY3RhbmdsZV9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgcmVjdGFuZ2xlKTsKICAgIG9mZnNldCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIGVsbGlwc29pZCk7CiAgICBvZmZzZXQgKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgY2VudGVyKTsKICAgIGxldCBpOwogICAgbGV0IHBvc2l0aW9uc0xlbmd0aCA9IGVuY29kZWRQb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHVCdWZmZXIgPSBlbmNvZGVkUG9zaXRpb25zLnN1YmFycmF5KDAsIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCB2QnVmZmVyID0gZW5jb2RlZFBvc2l0aW9ucy5zdWJhcnJheSgKICAgICAgcG9zaXRpb25zTGVuZ3RoLAogICAgICAyICogcG9zaXRpb25zTGVuZ3RoCiAgICApOwogICAgY29uc3QgaGVpZ2h0QnVmZmVyID0gZW5jb2RlZFBvc2l0aW9ucy5zdWJhcnJheSgKICAgICAgMiAqIHBvc2l0aW9uc0xlbmd0aCwKICAgICAgMyAqIHBvc2l0aW9uc0xlbmd0aAogICAgKTsKICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuemlnWmFnRGVsdGFEZWNvZGUodUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyKTsKICAgIHJlbW92ZUR1cGxpY2F0ZXModUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyLCBjb3VudHMpOwogICAgY29uc3QgY291bnRzTGVuZ3RoID0gY291bnRzLmxlbmd0aDsKICAgIGxldCB2b2x1bWVzQ291bnQgPSAwOwogICAgZm9yIChpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHBvbHlsaW5lUG9zaXRpb25Db3VudCA9IGNvdW50c1tpXTsKICAgICAgdm9sdW1lc0NvdW50ICs9IHBvbHlsaW5lUG9zaXRpb25Db3VudCAtIDE7CiAgICB9CiAgICBjb25zdCBhdHRyaWJzQW5kSW5kaWNlcyA9IG5ldyBWZXJ0ZXhBdHRyaWJ1dGVzQW5kSW5kaWNlcyh2b2x1bWVzQ291bnQpOwogICAgY29uc3QgcG9zaXRpb25zID0gZGVjb2RlUG9zaXRpb25zKAogICAgICB1QnVmZmVyLAogICAgICB2QnVmZmVyLAogICAgICBoZWlnaHRCdWZmZXIsCiAgICAgIHJlY3RhbmdsZSwKICAgICAgbWluaW11bUhlaWdodCwKICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgZWxsaXBzb2lkLAogICAgICBjZW50ZXIKICAgICk7CiAgICBwb3NpdGlvbnNMZW5ndGggPSB1QnVmZmVyLmxlbmd0aDsKICAgIGNvbnN0IHBvc2l0aW9uc1JUQyA9IG5ldyBGbG9hdDMyQXJyYXkocG9zaXRpb25zTGVuZ3RoICogMyk7CiAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2kpIHsKICAgICAgcG9zaXRpb25zUlRDW2kgKiAzXSA9IHBvc2l0aW9uc1tpICogM10gLSBjZW50ZXIueDsKICAgICAgcG9zaXRpb25zUlRDW2kgKiAzICsgMV0gPSBwb3NpdGlvbnNbaSAqIDMgKyAxXSAtIGNlbnRlci55OwogICAgICBwb3NpdGlvbnNSVENbaSAqIDMgKyAyXSA9IHBvc2l0aW9uc1tpICogMyArIDJdIC0gY2VudGVyLno7CiAgICB9CiAgICBsZXQgY3VycmVudFBvc2l0aW9uSW5kZXggPSAwOwogICAgbGV0IGN1cnJlbnRIZWlnaHRJbmRleCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgY291bnRzTGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9seWxpbmVWb2x1bWVDb3VudCA9IGNvdW50c1tpXSAtIDE7CiAgICAgIGNvbnN0IGhhbGZXaWR0aCA9IHdpZHRoc1tpXSAqIDAuNTsKICAgICAgY29uc3QgYmF0Y2hJZCA9IGJhdGNoSWRzW2ldOwogICAgICBjb25zdCB2b2x1bWVGaXJzdFBvc2l0aW9uSW5kZXggPSBjdXJyZW50UG9zaXRpb25JbmRleDsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBwb2x5bGluZVZvbHVtZUNvdW50OyBqKyspIHsKICAgICAgICBjb25zdCB2b2x1bWVTdGFydCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBwb3NpdGlvbnNSVEMsCiAgICAgICAgICBjdXJyZW50UG9zaXRpb25JbmRleCwKICAgICAgICAgIHNjcmF0Y2hQMAogICAgICAgICk7CiAgICAgICAgY29uc3Qgdm9sdW1lRW5kID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIHBvc2l0aW9uc1JUQywKICAgICAgICAgIGN1cnJlbnRQb3NpdGlvbkluZGV4ICsgMywKICAgICAgICAgIHNjcmF0Y2hQMQogICAgICAgICk7CiAgICAgICAgbGV0IHN0YXJ0SGVpZ2h0ID0gaGVpZ2h0QnVmZmVyW2N1cnJlbnRIZWlnaHRJbmRleF07CiAgICAgICAgbGV0IGVuZEhlaWdodCA9IGhlaWdodEJ1ZmZlcltjdXJyZW50SGVpZ2h0SW5kZXggKyAxXTsKICAgICAgICBzdGFydEhlaWdodCA9IE1hdGhfZGVmYXVsdC5sZXJwKAogICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBzdGFydEhlaWdodCAvIE1BWF9TSE9SVAogICAgICAgICk7CiAgICAgICAgZW5kSGVpZ2h0ID0gTWF0aF9kZWZhdWx0LmxlcnAoCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVuZEhlaWdodCAvIE1BWF9TSE9SVAogICAgICAgICk7CiAgICAgICAgY3VycmVudEhlaWdodEluZGV4Kys7CiAgICAgICAgbGV0IHByZVN0YXJ0ID0gc2NyYXRjaFByZXY7CiAgICAgICAgbGV0IHBvc3RFbmQgPSBzY3JhdGNoTmV4dDsKICAgICAgICBpZiAoaiA9PT0gMCkgewogICAgICAgICAgY29uc3QgZmluYWxQb3NpdGlvbkluZGV4ID0gdm9sdW1lRmlyc3RQb3NpdGlvbkluZGV4ICsgcG9seWxpbmVWb2x1bWVDb3VudCAqIDM7CiAgICAgICAgICBjb25zdCBmaW5hbFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgcG9zaXRpb25zUlRDLAogICAgICAgICAgICBmaW5hbFBvc2l0aW9uSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hQcmV2CiAgICAgICAgICApOwogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoZmluYWxQb3NpdGlvbiwgdm9sdW1lU3RhcnQpKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zUlRDLCBmaW5hbFBvc2l0aW9uSW5kZXggLSAzLCBwcmVTdGFydCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBvZmZzZXRQYXN0U3RhcnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICAgICAgdm9sdW1lU3RhcnQsCiAgICAgICAgICAgICAgdm9sdW1lRW5kLAogICAgICAgICAgICAgIHNjcmF0Y2hQcmV2CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHByZVN0YXJ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChvZmZzZXRQYXN0U3RhcnQsIHZvbHVtZVN0YXJ0LCBzY3JhdGNoUHJldik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zUlRDLCBjdXJyZW50UG9zaXRpb25JbmRleCAtIDMsIHByZVN0YXJ0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGogPT09IHBvbHlsaW5lVm9sdW1lQ291bnQgLSAxKSB7CiAgICAgICAgICBjb25zdCBmaXJzdFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgcG9zaXRpb25zUlRDLAogICAgICAgICAgICB2b2x1bWVGaXJzdFBvc2l0aW9uSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hOZXh0CiAgICAgICAgICApOwogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoZmlyc3RQb3NpdGlvbiwgdm9sdW1lRW5kKSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgIHBvc2l0aW9uc1JUQywKICAgICAgICAgICAgICB2b2x1bWVGaXJzdFBvc2l0aW9uSW5kZXggKyAzLAogICAgICAgICAgICAgIHBvc3RFbmQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IG9mZnNldFBhc3RFbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICAgICAgdm9sdW1lRW5kLAogICAgICAgICAgICAgIHZvbHVtZVN0YXJ0LAogICAgICAgICAgICAgIHNjcmF0Y2hOZXh0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHBvc3RFbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG9mZnNldFBhc3RFbmQsIHZvbHVtZUVuZCwgc2NyYXRjaE5leHQpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBvc2l0aW9uc1JUQywgY3VycmVudFBvc2l0aW9uSW5kZXggKyA2LCBwb3N0RW5kKTsKICAgICAgICB9CiAgICAgICAgYXR0cmlic0FuZEluZGljZXMuYWRkVm9sdW1lKAogICAgICAgICAgcHJlU3RhcnQsCiAgICAgICAgICB2b2x1bWVTdGFydCwKICAgICAgICAgIHZvbHVtZUVuZCwKICAgICAgICAgIHBvc3RFbmQsCiAgICAgICAgICBzdGFydEhlaWdodCwKICAgICAgICAgIGVuZEhlaWdodCwKICAgICAgICAgIGhhbGZXaWR0aCwKICAgICAgICAgIGJhdGNoSWQsCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICApOwogICAgICAgIGN1cnJlbnRQb3NpdGlvbkluZGV4ICs9IDM7CiAgICAgIH0KICAgICAgY3VycmVudFBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgY3VycmVudEhlaWdodEluZGV4Kys7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gYXR0cmlic0FuZEluZGljZXMuaW5kaWNlczsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5zdGFydEVsbGlwc29pZE5vcm1hbHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5lbmRFbGxpcHNvaWROb3JtYWxzLmJ1ZmZlcik7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goYXR0cmlic0FuZEluZGljZXMuc3RhcnRQb3NpdGlvbkFuZEhlaWdodHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgYXR0cmlic0FuZEluZGljZXMuc3RhcnRGYWNlTm9ybWFsQW5kVmVydGV4Q29ybmVySWRzLmJ1ZmZlcgogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5lbmRQb3NpdGlvbkFuZEhlaWdodHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5lbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRocy5idWZmZXIpOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLnZlcnRleEJhdGNoSWRzLmJ1ZmZlcik7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goaW5kaWNlcy5idWZmZXIpOwogICAgbGV0IHJlc3VsdHMgPSB7CiAgICAgIGluZGV4RGF0YXR5cGU6IGluZGljZXMuQllURVNfUEVSX0VMRU1FTlQgPT09IDIgPyBJbmRleERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfU0hPUlQgOiBJbmRleERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICBzdGFydEVsbGlwc29pZE5vcm1hbHM6IGF0dHJpYnNBbmRJbmRpY2VzLnN0YXJ0RWxsaXBzb2lkTm9ybWFscy5idWZmZXIsCiAgICAgIGVuZEVsbGlwc29pZE5vcm1hbHM6IGF0dHJpYnNBbmRJbmRpY2VzLmVuZEVsbGlwc29pZE5vcm1hbHMuYnVmZmVyLAogICAgICBzdGFydFBvc2l0aW9uQW5kSGVpZ2h0czogYXR0cmlic0FuZEluZGljZXMuc3RhcnRQb3NpdGlvbkFuZEhlaWdodHMuYnVmZmVyLAogICAgICBzdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHM6IGF0dHJpYnNBbmRJbmRpY2VzLnN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkcy5idWZmZXIsCiAgICAgIGVuZFBvc2l0aW9uQW5kSGVpZ2h0czogYXR0cmlic0FuZEluZGljZXMuZW5kUG9zaXRpb25BbmRIZWlnaHRzLmJ1ZmZlciwKICAgICAgZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHM6IGF0dHJpYnNBbmRJbmRpY2VzLmVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzLmJ1ZmZlciwKICAgICAgdmVydGV4QmF0Y2hJZHM6IGF0dHJpYnNBbmRJbmRpY2VzLnZlcnRleEJhdGNoSWRzLmJ1ZmZlciwKICAgICAgaW5kaWNlczogaW5kaWNlcy5idWZmZXIKICAgIH07CiAgICBpZiAocGFyYW1ldGVycy5rZWVwRGVjb2RlZFBvc2l0aW9ucykgewogICAgICBjb25zdCBwb3NpdGlvbk9mZnNldHMgPSBnZXRQb3NpdGlvbk9mZnNldHMoY291bnRzKTsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHBvc2l0aW9ucy5idWZmZXIsIHBvc2l0aW9uT2Zmc2V0cy5idWZmZXIpOwogICAgICByZXN1bHRzID0gY29tYmluZV9kZWZhdWx0KHJlc3VsdHMsIHsKICAgICAgICBkZWNvZGVkUG9zaXRpb25zOiBwb3NpdGlvbnMuYnVmZmVyLAogICAgICAgIGRlY29kZWRQb3NpdGlvbk9mZnNldHM6IHBvc2l0aW9uT2Zmc2V0cy5idWZmZXIKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgdmFyIE1BWF9TSE9SVCwgTUlURVJfQlJFQUssIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYywgc2NyYXRjaEVuY29kZWRQb3NpdGlvbiwgcHJldmlvdXNDb21wcmVzc2VkQ2FydG9ncmFwaGljU2NyYXRjaCwgY3VycmVudENvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoLCB0b3dhcmRDdXJyU2NyYXRjaCwgdG93YXJkTmV4dFNjcmF0Y2gsIFJFRkVSRU5DRV9JTkRJQ0VTMiwgUkVGRVJFTkNFX0lORElDRVNfTEVOR1RIMiwgcG9zaXRpb25TY3JhdGNoNCwgc2NyYXRjaFN0YXJ0RWxsaXBzb2lkTm9ybWFsLCBzY3JhdGNoU3RhcnRGYWNlTm9ybWFsLCBzY3JhdGNoRW5kRWxsaXBzb2lkTm9ybWFsLCBzY3JhdGNoRW5kRmFjZU5vcm1hbCwgc2NyYXRjaFJlY3RhbmdsZTMsIHNjcmF0Y2hFbGxpcHNvaWQxMywgc2NyYXRjaENlbnRlcjQsIHNjcmF0Y2hQcmV2LCBzY3JhdGNoUDAsIHNjcmF0Y2hQMSwgc2NyYXRjaE5leHQsIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9jb21iaW5lKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIE1BWF9TSE9SVCA9IDMyNzY3OwogICAgICBNSVRFUl9CUkVBSyA9IE1hdGguY29zKE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMTUwKSk7CiAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcmV2aW91c0NvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGN1cnJlbnRDb21wcmVzc2VkQ2FydG9ncmFwaGljU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICB0b3dhcmRDdXJyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdG93YXJkTmV4dFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFJFRkVSRU5DRV9JTkRJQ0VTMiA9IFsKICAgICAgICAwLAogICAgICAgIDIsCiAgICAgICAgNiwKICAgICAgICAwLAogICAgICAgIDYsCiAgICAgICAgNCwKICAgICAgICAvLyByaWdodAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICAzLAogICAgICAgIDAsCiAgICAgICAgMywKICAgICAgICAyLAogICAgICAgIC8vIHN0YXJ0IGZhY2UKICAgICAgICAwLAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICAwLAogICAgICAgIDUsCiAgICAgICAgMSwKICAgICAgICAvLyBib3R0b20KICAgICAgICA1LAogICAgICAgIDMsCiAgICAgICAgMSwKICAgICAgICA1LAogICAgICAgIDcsCiAgICAgICAgMywKICAgICAgICAvLyBsZWZ0CiAgICAgICAgNywKICAgICAgICA1LAogICAgICAgIDQsCiAgICAgICAgNywKICAgICAgICA0LAogICAgICAgIDYsCiAgICAgICAgLy8gZW5kIGZhY2UKICAgICAgICA3LAogICAgICAgIDYsCiAgICAgICAgMiwKICAgICAgICA3LAogICAgICAgIDIsCiAgICAgICAgMwogICAgICAgIC8vIHRvcAogICAgICBdOwogICAgICBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEgyID0gUkVGRVJFTkNFX0lORElDRVMyLmxlbmd0aDsKICAgICAgcG9zaXRpb25TY3JhdGNoNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFN0YXJ0RWxsaXBzb2lkTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU3RhcnRGYWNlTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRW5kRWxsaXBzb2lkTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRW5kRmFjZU5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVmVydGV4QXR0cmlidXRlc0FuZEluZGljZXMucHJvdG90eXBlLmFkZFZvbHVtZSA9IGZ1bmN0aW9uKHByZVN0YXJ0UlRDLCBzdGFydFJUQywgZW5kUlRDLCBwb3N0RW5kUlRDLCBzdGFydEhlaWdodCwgZW5kSGVpZ2h0LCBoYWxmV2lkdGgsIGJhdGNoSWQsIGNlbnRlciwgZWxsaXBzb2lkKSB7CiAgICAgICAgbGV0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChzdGFydFJUQywgY2VudGVyLCBwb3NpdGlvblNjcmF0Y2g0KTsKICAgICAgICBjb25zdCBzdGFydEVsbGlwc29pZE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hTdGFydEVsbGlwc29pZE5vcm1hbAogICAgICAgICk7CiAgICAgICAgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGVuZFJUQywgY2VudGVyLCBwb3NpdGlvblNjcmF0Y2g0KTsKICAgICAgICBjb25zdCBlbmRFbGxpcHNvaWROb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoRW5kRWxsaXBzb2lkTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzdGFydEZhY2VOb3JtYWwgPSBjb21wdXRlTWl0ZXJlZE5vcm1hbCgKICAgICAgICAgIHByZVN0YXJ0UlRDLAogICAgICAgICAgc3RhcnRSVEMsCiAgICAgICAgICBlbmRSVEMsCiAgICAgICAgICBzdGFydEVsbGlwc29pZE5vcm1hbCwKICAgICAgICAgIHNjcmF0Y2hTdGFydEZhY2VOb3JtYWwKICAgICAgICApOwogICAgICAgIGNvbnN0IGVuZEZhY2VOb3JtYWwgPSBjb21wdXRlTWl0ZXJlZE5vcm1hbCgKICAgICAgICAgIHBvc3RFbmRSVEMsCiAgICAgICAgICBlbmRSVEMsCiAgICAgICAgICBzdGFydFJUQywKICAgICAgICAgIGVuZEVsbGlwc29pZE5vcm1hbCwKICAgICAgICAgIHNjcmF0Y2hFbmRGYWNlTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzdGFydEVsbGlwc29pZE5vcm1hbHMgPSB0aGlzLnN0YXJ0RWxsaXBzb2lkTm9ybWFsczsKICAgICAgICBjb25zdCBlbmRFbGxpcHNvaWROb3JtYWxzID0gdGhpcy5lbmRFbGxpcHNvaWROb3JtYWxzOwogICAgICAgIGNvbnN0IHN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzID0gdGhpcy5zdGFydFBvc2l0aW9uQW5kSGVpZ2h0czsKICAgICAgICBjb25zdCBzdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHMgPSB0aGlzLnN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkczsKICAgICAgICBjb25zdCBlbmRQb3NpdGlvbkFuZEhlaWdodHMgPSB0aGlzLmVuZFBvc2l0aW9uQW5kSGVpZ2h0czsKICAgICAgICBjb25zdCBlbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRocyA9IHRoaXMuZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHM7CiAgICAgICAgY29uc3QgdmVydGV4QmF0Y2hJZHMgPSB0aGlzLnZlcnRleEJhdGNoSWRzOwogICAgICAgIGxldCBiYXRjaElkT2Zmc2V0ID0gdGhpcy5iYXRjaElkT2Zmc2V0OwogICAgICAgIGxldCB2ZWMzT2Zmc2V0ID0gdGhpcy52ZWMzT2Zmc2V0OwogICAgICAgIGxldCB2ZWM0T2Zmc2V0ID0gdGhpcy52ZWM0T2Zmc2V0OwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHN0YXJ0RWxsaXBzb2lkTm9ybWFsLCBzdGFydEVsbGlwc29pZE5vcm1hbHMsIHZlYzNPZmZzZXQpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZW5kRWxsaXBzb2lkTm9ybWFsLCBlbmRFbGxpcHNvaWROb3JtYWxzLCB2ZWMzT2Zmc2V0KTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHN0YXJ0UlRDLCBzdGFydFBvc2l0aW9uQW5kSGVpZ2h0cywgdmVjNE9mZnNldCk7CiAgICAgICAgICBzdGFydFBvc2l0aW9uQW5kSGVpZ2h0c1t2ZWM0T2Zmc2V0ICsgM10gPSBzdGFydEhlaWdodDsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGVuZFJUQywgZW5kUG9zaXRpb25BbmRIZWlnaHRzLCB2ZWM0T2Zmc2V0KTsKICAgICAgICAgIGVuZFBvc2l0aW9uQW5kSGVpZ2h0c1t2ZWM0T2Zmc2V0ICsgM10gPSBlbmRIZWlnaHQ7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICAgICAgc3RhcnRGYWNlTm9ybWFsLAogICAgICAgICAgICBzdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHMsCiAgICAgICAgICAgIHZlYzRPZmZzZXQKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHNbdmVjNE9mZnNldCArIDNdID0gaTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGVuZEZhY2VOb3JtYWwsIGVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzLCB2ZWM0T2Zmc2V0KTsKICAgICAgICAgIGVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzW3ZlYzRPZmZzZXQgKyAzXSA9IGhhbGZXaWR0aDsKICAgICAgICAgIHZlcnRleEJhdGNoSWRzW2JhdGNoSWRPZmZzZXQrK10gPSBiYXRjaElkOwogICAgICAgICAgdmVjM09mZnNldCArPSAzOwogICAgICAgICAgdmVjNE9mZnNldCArPSA0OwogICAgICAgIH0KICAgICAgICB0aGlzLmJhdGNoSWRPZmZzZXQgPSBiYXRjaElkT2Zmc2V0OwogICAgICAgIHRoaXMudmVjM09mZnNldCA9IHZlYzNPZmZzZXQ7CiAgICAgICAgdGhpcy52ZWM0T2Zmc2V0ID0gdmVjNE9mZnNldDsKICAgICAgICBjb25zdCBpbmRpY2VzID0gdGhpcy5pbmRpY2VzOwogICAgICAgIGNvbnN0IHZvbHVtZVN0YXJ0SW5kZXggPSB0aGlzLnZvbHVtZVN0YXJ0SW5kZXg7CiAgICAgICAgY29uc3QgaW5kZXhPZmZzZXQgPSB0aGlzLmluZGV4T2Zmc2V0OwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEgyOyBpKyspIHsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXQgKyBpXSA9IFJFRkVSRU5DRV9JTkRJQ0VTMltpXSArIHZvbHVtZVN0YXJ0SW5kZXg7CiAgICAgICAgfQogICAgICAgIHRoaXMudm9sdW1lU3RhcnRJbmRleCArPSA4OwogICAgICAgIHRoaXMuaW5kZXhPZmZzZXQgKz0gUkVGRVJFTkNFX0lORElDRVNfTEVOR1RIMjsKICAgICAgfTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTMgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDEzID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXI0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJldiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFAwID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUDEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOZXh0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lc19kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9WZWN0b3IzRFRpbGVCYXRjaC5qcwogIGZ1bmN0aW9uIFZlY3RvcjNEVGlsZUJhdGNoKG9wdGlvbnMpIHsKICAgIHRoaXMub2Zmc2V0ID0gb3B0aW9ucy5vZmZzZXQ7CiAgICB0aGlzLmNvdW50ID0gb3B0aW9ucy5jb3VudDsKICAgIHRoaXMuY29sb3IgPSBvcHRpb25zLmNvbG9yOwogICAgdGhpcy5iYXRjaElkcyA9IG9wdGlvbnMuYmF0Y2hJZHM7CiAgfQogIHZhciBWZWN0b3IzRFRpbGVCYXRjaF9kZWZhdWx0OwogIHZhciBpbml0X1ZlY3RvcjNEVGlsZUJhdGNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvU2NlbmUvVmVjdG9yM0RUaWxlQmF0Y2guanMiKCkgewogICAgICBWZWN0b3IzRFRpbGVCYXRjaF9kZWZhdWx0ID0gVmVjdG9yM0RUaWxlQmF0Y2g7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcy5qcwogIHZhciBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllc19leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXNfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGJveE1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoYm94ZXMsIGluZGV4KSB7CiAgICBsZXQgYm94SW5kZXggPSBpbmRleCAqIHBhY2tlZEJveExlbmd0aDsKICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGJveGVzLCBib3hJbmRleCwgc2NyYXRjaENhcnRlc2lhbjExKTsKICAgIGJveEluZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBjb25zdCBib3hNb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC51bnBhY2soCiAgICAgIGJveGVzLAogICAgICBib3hJbmRleCwKICAgICAgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYubW9kZWxNYXRyaXgKICAgICk7CiAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKGJveE1vZGVsTWF0cml4LCBkaW1lbnNpb25zLCBib3hNb2RlbE1hdHJpeCk7CiAgICBjb25zdCBib3VuZGluZ1ZvbHVtZSA9IHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWLmJvdW5kaW5nVm9sdW1lOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBib3VuZGluZ1ZvbHVtZS5jZW50ZXIpOwogICAgYm91bmRpbmdWb2x1bWUucmFkaXVzID0gTWF0aC5zcXJ0KDMpOwogICAgcmV0dXJuIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWOwogIH0KICBmdW5jdGlvbiBjeWxpbmRlck1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoY3lsaW5kZXJzLCBpbmRleCkgewogICAgbGV0IGN5bGluZGVySW5kZXggPSBpbmRleCAqIHBhY2tlZEN5bGluZGVyTGVuZ3RoOwogICAgY29uc3QgY3lsaW5kZXJSYWRpdXMgPSBjeWxpbmRlcnNbY3lsaW5kZXJJbmRleCsrXTsKICAgIGNvbnN0IGxlbmd0aCA9IGN5bGluZGVyc1tjeWxpbmRlckluZGV4KytdOwogICAgY29uc3Qgc2NhbGUgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKAogICAgICBjeWxpbmRlclJhZGl1cywKICAgICAgY3lsaW5kZXJSYWRpdXMsCiAgICAgIGxlbmd0aCwKICAgICAgc2NyYXRjaENhcnRlc2lhbjExCiAgICApOwogICAgY29uc3QgY3lsaW5kZXJNb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC51bnBhY2soCiAgICAgIGN5bGluZGVycywKICAgICAgY3lsaW5kZXJJbmRleCwKICAgICAgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYubW9kZWxNYXRyaXgKICAgICk7CiAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKGN5bGluZGVyTW9kZWxNYXRyaXgsIHNjYWxlLCBjeWxpbmRlck1vZGVsTWF0cml4KTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lID0gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWU7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGJvdW5kaW5nVm9sdW1lLmNlbnRlcik7CiAgICBib3VuZGluZ1ZvbHVtZS5yYWRpdXMgPSBNYXRoLnNxcnQoMik7CiAgICByZXR1cm4gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlY7CiAgfQogIGZ1bmN0aW9uIGVsbGlwc29pZE1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoZWxsaXBzb2lkcywgaW5kZXgpIHsKICAgIGxldCBlbGxpcHNvaWRJbmRleCA9IGluZGV4ICogcGFja2VkRWxsaXBzb2lkTGVuZ3RoOwogICAgY29uc3QgcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGVsbGlwc29pZHMsIGVsbGlwc29pZEluZGV4LCBzY3JhdGNoQ2FydGVzaWFuMTEpOwogICAgZWxsaXBzb2lkSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIGNvbnN0IGVsbGlwc29pZE1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LnVucGFjaygKICAgICAgZWxsaXBzb2lkcywKICAgICAgZWxsaXBzb2lkSW5kZXgsCiAgICAgIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWLm1vZGVsTWF0cml4CiAgICApOwogICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsZShlbGxpcHNvaWRNb2RlbE1hdHJpeCwgcmFkaWksIGVsbGlwc29pZE1vZGVsTWF0cml4KTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lID0gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWU7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGJvdW5kaW5nVm9sdW1lLmNlbnRlcik7CiAgICBib3VuZGluZ1ZvbHVtZS5yYWRpdXMgPSAxOwogICAgcmV0dXJuIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWOwogIH0KICBmdW5jdGlvbiBzcGhlcmVNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lKHNwaGVyZXMsIGluZGV4KSB7CiAgICBsZXQgc3BoZXJlSW5kZXggPSBpbmRleCAqIHBhY2tlZFNwaGVyZUxlbmd0aDsKICAgIGNvbnN0IHNwaGVyZVJhZGl1cyA9IHNwaGVyZXNbc3BoZXJlSW5kZXgrK107CiAgICBjb25zdCBzcGhlcmVUcmFuc2xhdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgIHNwaGVyZXMsCiAgICAgIHNwaGVyZUluZGV4LAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTEKICAgICk7CiAgICBjb25zdCBzcGhlcmVNb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5mcm9tVHJhbnNsYXRpb24oCiAgICAgIHNwaGVyZVRyYW5zbGF0aW9uLAogICAgICBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5tb2RlbE1hdHJpeAogICAgKTsKICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VW5pZm9ybVNjYWxlKAogICAgICBzcGhlcmVNb2RlbE1hdHJpeCwKICAgICAgc3BoZXJlUmFkaXVzLAogICAgICBzcGhlcmVNb2RlbE1hdHJpeAogICAgKTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lID0gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWU7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGJvdW5kaW5nVm9sdW1lLmNlbnRlcik7CiAgICBib3VuZGluZ1ZvbHVtZS5yYWRpdXMgPSAxOwogICAgcmV0dXJuIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWOwogIH0KICBmdW5jdGlvbiBjcmVhdGVQcmltaXRpdmUob3B0aW9ucywgcHJpbWl0aXZlLCBwcmltaXRpdmVCYXRjaElkcywgZ2VvbWV0cnksIGdldE1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHByaW1pdGl2ZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgbnVtYmVyT2ZQcmltaXRpdmVzID0gcHJpbWl0aXZlQmF0Y2hJZHMubGVuZ3RoOwogICAgY29uc3QgZ2VvbWV0cnlQb3NpdGlvbnMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGdlb21ldHJ5SW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IHZlcnRleEJhdGNoSWRzID0gb3B0aW9ucy52ZXJ0ZXhCYXRjaElkczsKICAgIGNvbnN0IGluZGljZXMgPSBvcHRpb25zLmluZGljZXM7CiAgICBjb25zdCBiYXRjaElkcyA9IG9wdGlvbnMuYmF0Y2hJZHM7CiAgICBjb25zdCBiYXRjaFRhYmxlQ29sb3JzID0gb3B0aW9ucy5iYXRjaFRhYmxlQ29sb3JzOwogICAgY29uc3QgYmF0Y2hlZEluZGljZXMgPSBvcHRpb25zLmJhdGNoZWRJbmRpY2VzOwogICAgY29uc3QgaW5kZXhPZmZzZXRzID0gb3B0aW9ucy5pbmRleE9mZnNldHM7CiAgICBjb25zdCBpbmRleENvdW50cyA9IG9wdGlvbnMuaW5kZXhDb3VudHM7CiAgICBjb25zdCBib3VuZGluZ1ZvbHVtZXMgPSBvcHRpb25zLmJvdW5kaW5nVm9sdW1lczsKICAgIGNvbnN0IG1vZGVsTWF0cml4ID0gb3B0aW9ucy5tb2RlbE1hdHJpeDsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgbGV0IHBvc2l0aW9uT2Zmc2V0ID0gb3B0aW9ucy5wb3NpdGlvbk9mZnNldDsKICAgIGxldCBiYXRjaElkSW5kZXggPSBvcHRpb25zLmJhdGNoSWRJbmRleDsKICAgIGxldCBpbmRleE9mZnNldCA9IG9wdGlvbnMuaW5kZXhPZmZzZXQ7CiAgICBjb25zdCBiYXRjaGVkSW5kaWNlc09mZnNldCA9IG9wdGlvbnMuYmF0Y2hlZEluZGljZXNPZmZzZXQ7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mUHJpbWl0aXZlczsgKytpKSB7CiAgICAgIGNvbnN0IHByaW1pdGl2ZU1vZGVsTWF0cml4QW5kQlYgPSBnZXRNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lKAogICAgICAgIHByaW1pdGl2ZSwKICAgICAgICBpCiAgICAgICk7CiAgICAgIGNvbnN0IHByaW1pdGl2ZU1vZGVsTWF0cml4ID0gcHJpbWl0aXZlTW9kZWxNYXRyaXhBbmRCVi5tb2RlbE1hdHJpeDsKICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KG1vZGVsTWF0cml4LCBwcmltaXRpdmVNb2RlbE1hdHJpeCwgcHJpbWl0aXZlTW9kZWxNYXRyaXgpOwogICAgICBjb25zdCBiYXRjaElkID0gcHJpbWl0aXZlQmF0Y2hJZHNbaV07CiAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IGdlb21ldHJ5UG9zaXRpb25zLmxlbmd0aDsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBwb3NpdGlvbnNMZW5ndGg7IGogKz0gMykgewogICAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhnZW9tZXRyeVBvc2l0aW9ucywgaiwgc2NyYXRjaFBvc2l0aW9uNSk7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludChwcmltaXRpdmVNb2RlbE1hdHJpeCwgcG9zaXRpb24sIHBvc2l0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9zaXRpb24sIGNlbnRlciwgcG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uLCBwb3NpdGlvbnMsIHBvc2l0aW9uT2Zmc2V0ICogMyArIGopOwogICAgICAgIHZlcnRleEJhdGNoSWRzW2JhdGNoSWRJbmRleCsrXSA9IGJhdGNoSWQ7CiAgICAgIH0KICAgICAgY29uc3QgaW5kaWNlc0xlbmd0aCA9IGdlb21ldHJ5SW5kaWNlcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgaW5kaWNlc0xlbmd0aDsgKytrKSB7CiAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldCArIGtdID0gZ2VvbWV0cnlJbmRpY2VzW2tdICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgIH0KICAgICAgY29uc3Qgb2Zmc2V0ID0gaSArIGJhdGNoZWRJbmRpY2VzT2Zmc2V0OwogICAgICBiYXRjaGVkSW5kaWNlc1tvZmZzZXRdID0gbmV3IFZlY3RvcjNEVGlsZUJhdGNoX2RlZmF1bHQoewogICAgICAgIG9mZnNldDogaW5kZXhPZmZzZXQsCiAgICAgICAgY291bnQ6IGluZGljZXNMZW5ndGgsCiAgICAgICAgY29sb3I6IENvbG9yX2RlZmF1bHQuZnJvbVJnYmEoYmF0Y2hUYWJsZUNvbG9yc1tiYXRjaElkXSksCiAgICAgICAgYmF0Y2hJZHM6IFtiYXRjaElkXQogICAgICB9KTsKICAgICAgYmF0Y2hJZHNbb2Zmc2V0XSA9IGJhdGNoSWQ7CiAgICAgIGluZGV4T2Zmc2V0c1tvZmZzZXRdID0gaW5kZXhPZmZzZXQ7CiAgICAgIGluZGV4Q291bnRzW29mZnNldF0gPSBpbmRpY2VzTGVuZ3RoOwogICAgICBib3VuZGluZ1ZvbHVtZXNbb2Zmc2V0XSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudHJhbnNmb3JtKAogICAgICAgIHByaW1pdGl2ZU1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWUsCiAgICAgICAgcHJpbWl0aXZlTW9kZWxNYXRyaXgKICAgICAgKTsKICAgICAgcG9zaXRpb25PZmZzZXQgKz0gcG9zaXRpb25zTGVuZ3RoIC8gMzsKICAgICAgaW5kZXhPZmZzZXQgKz0gaW5kaWNlc0xlbmd0aDsKICAgIH0KICAgIG9wdGlvbnMucG9zaXRpb25PZmZzZXQgPSBwb3NpdGlvbk9mZnNldDsKICAgIG9wdGlvbnMuYmF0Y2hJZEluZGV4ID0gYmF0Y2hJZEluZGV4OwogICAgb3B0aW9ucy5pbmRleE9mZnNldCA9IGluZGV4T2Zmc2V0OwogICAgb3B0aW9ucy5iYXRjaGVkSW5kaWNlc09mZnNldCArPSBudW1iZXJPZlByaW1pdGl2ZXM7CiAgfQogIGZ1bmN0aW9uIHVucGFja0J1ZmZlcihidWZmZXIpIHsKICAgIGNvbnN0IHBhY2tlZEJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkoYnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaENlbnRlcjUpOwogICAgb2Zmc2V0ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBNYXRyaXg0X2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoTWF0cml4NCk7CiAgfQogIGZ1bmN0aW9uIHBhY2tlZEJhdGNoZWRJbmRpY2VzTGVuZ3RoKGJhdGNoZWRJbmRpY2VzKSB7CiAgICBjb25zdCBsZW5ndGggPSBiYXRjaGVkSW5kaWNlcy5sZW5ndGg7CiAgICBsZXQgY291bnQgPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb3VudCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDMgKyBiYXRjaGVkSW5kaWNlc1tpXS5iYXRjaElkcy5sZW5ndGg7CiAgICB9CiAgICByZXR1cm4gY291bnQ7CiAgfQogIGZ1bmN0aW9uIHBhY2tCdWZmZXIoaW5kaWNlc0J5dGVzUGVyRWxlbWVudCwgYmF0Y2hlZEluZGljZXMsIGJvdW5kaW5nVm9sdW1lcykgewogICAgY29uc3QgbnVtQlZzID0gYm91bmRpbmdWb2x1bWVzLmxlbmd0aDsKICAgIGNvbnN0IGxlbmd0aCA9IDEgKyAxICsgbnVtQlZzICogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxICsgcGFja2VkQmF0Y2hlZEluZGljZXNMZW5ndGgoYmF0Y2hlZEluZGljZXMpOwogICAgY29uc3QgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGgpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gaW5kaWNlc0J5dGVzUGVyRWxlbWVudDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBudW1CVnM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUJWczsgKytpKSB7CiAgICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFjayhib3VuZGluZ1ZvbHVtZXNbaV0sIHBhY2tlZEJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgb2Zmc2V0ICs9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfQogICAgY29uc3QgaW5kaWNlc0xlbmd0aCA9IGJhdGNoZWRJbmRpY2VzLmxlbmd0aDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBpbmRpY2VzTGVuZ3RoOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBpbmRpY2VzTGVuZ3RoOyArK2opIHsKICAgICAgY29uc3QgYmF0Y2hlZEluZGV4ID0gYmF0Y2hlZEluZGljZXNbal07CiAgICAgIENvbG9yX2RlZmF1bHQucGFjayhiYXRjaGVkSW5kZXguY29sb3IsIHBhY2tlZEJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgb2Zmc2V0ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hlZEluZGV4Lm9mZnNldDsKICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoZWRJbmRleC5jb3VudDsKICAgICAgY29uc3QgYmF0Y2hJZHMgPSBiYXRjaGVkSW5kZXguYmF0Y2hJZHM7CiAgICAgIGNvbnN0IGJhdGNoSWRzTGVuZ3RoID0gYmF0Y2hJZHMubGVuZ3RoOwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hJZHNMZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgYmF0Y2hJZHNMZW5ndGg7ICsraykgewogICAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaElkc1trXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHBhY2tlZEJ1ZmZlcjsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgYm94ZXMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5ib3hlcykgPyBuZXcgRmxvYXQzMkFycmF5KHBhcmFtZXRlcnMuYm94ZXMpIDogdm9pZCAwOwogICAgY29uc3QgYm94QmF0Y2hJZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5ib3hCYXRjaElkcykgPyBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5ib3hCYXRjaElkcykgOiB2b2lkIDA7CiAgICBjb25zdCBjeWxpbmRlcnMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5jeWxpbmRlcnMpID8gbmV3IEZsb2F0MzJBcnJheShwYXJhbWV0ZXJzLmN5bGluZGVycykgOiB2b2lkIDA7CiAgICBjb25zdCBjeWxpbmRlckJhdGNoSWRzID0gZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuY3lsaW5kZXJCYXRjaElkcykgPyBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5jeWxpbmRlckJhdGNoSWRzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGVsbGlwc29pZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5lbGxpcHNvaWRzKSA/IG5ldyBGbG9hdDMyQXJyYXkocGFyYW1ldGVycy5lbGxpcHNvaWRzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGVsbGlwc29pZEJhdGNoSWRzID0gZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuZWxsaXBzb2lkQmF0Y2hJZHMpID8gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMuZWxsaXBzb2lkQmF0Y2hJZHMpIDogdm9pZCAwOwogICAgY29uc3Qgc3BoZXJlcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLnNwaGVyZXMpID8gbmV3IEZsb2F0MzJBcnJheShwYXJhbWV0ZXJzLnNwaGVyZXMpIDogdm9pZCAwOwogICAgY29uc3Qgc3BoZXJlQmF0Y2hJZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5zcGhlcmVCYXRjaElkcykgPyBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5zcGhlcmVCYXRjaElkcykgOiB2b2lkIDA7CiAgICBjb25zdCBudW1iZXJPZkJveGVzID0gZGVmaW5lZF9kZWZhdWx0KGJveGVzKSA/IGJveEJhdGNoSWRzLmxlbmd0aCA6IDA7CiAgICBjb25zdCBudW1iZXJPZkN5bGluZGVycyA9IGRlZmluZWRfZGVmYXVsdChjeWxpbmRlcnMpID8gY3lsaW5kZXJCYXRjaElkcy5sZW5ndGggOiAwOwogICAgY29uc3QgbnVtYmVyT2ZFbGxpcHNvaWRzID0gZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZHMpID8gZWxsaXBzb2lkQmF0Y2hJZHMubGVuZ3RoIDogMDsKICAgIGNvbnN0IG51bWJlck9mU3BoZXJlcyA9IGRlZmluZWRfZGVmYXVsdChzcGhlcmVzKSA/IHNwaGVyZUJhdGNoSWRzLmxlbmd0aCA6IDA7CiAgICBjb25zdCBib3hHZW9tZXRyeSA9IEJveEdlb21ldHJ5X2RlZmF1bHQuZ2V0VW5pdEJveCgpOwogICAgY29uc3QgY3lsaW5kZXJHZW9tZXRyeSA9IEN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdC5nZXRVbml0Q3lsaW5kZXIoKTsKICAgIGNvbnN0IGVsbGlwc29pZEdlb21ldHJ5ID0gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC5nZXRVbml0RWxsaXBzb2lkKCk7CiAgICBjb25zdCBib3hQb3NpdGlvbnMgPSBib3hHZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGN5bGluZGVyUG9zaXRpb25zID0gY3lsaW5kZXJHZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGVsbGlwc29pZFBvc2l0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgbGV0IG51bWJlck9mUG9zaXRpb25zID0gYm94UG9zaXRpb25zLmxlbmd0aCAqIG51bWJlck9mQm94ZXM7CiAgICBudW1iZXJPZlBvc2l0aW9ucyArPSBjeWxpbmRlclBvc2l0aW9ucy5sZW5ndGggKiBudW1iZXJPZkN5bGluZGVyczsKICAgIG51bWJlck9mUG9zaXRpb25zICs9IGVsbGlwc29pZFBvc2l0aW9ucy5sZW5ndGggKiAobnVtYmVyT2ZFbGxpcHNvaWRzICsgbnVtYmVyT2ZTcGhlcmVzKTsKICAgIGNvbnN0IGJveEluZGljZXMgPSBib3hHZW9tZXRyeS5pbmRpY2VzOwogICAgY29uc3QgY3lsaW5kZXJJbmRpY2VzID0gY3lsaW5kZXJHZW9tZXRyeS5pbmRpY2VzOwogICAgY29uc3QgZWxsaXBzb2lkSW5kaWNlcyA9IGVsbGlwc29pZEdlb21ldHJ5LmluZGljZXM7CiAgICBsZXQgbnVtYmVyT2ZJbmRpY2VzID0gYm94SW5kaWNlcy5sZW5ndGggKiBudW1iZXJPZkJveGVzOwogICAgbnVtYmVyT2ZJbmRpY2VzICs9IGN5bGluZGVySW5kaWNlcy5sZW5ndGggKiBudW1iZXJPZkN5bGluZGVyczsKICAgIG51bWJlck9mSW5kaWNlcyArPSBlbGxpcHNvaWRJbmRpY2VzLmxlbmd0aCAqIChudW1iZXJPZkVsbGlwc29pZHMgKyBudW1iZXJPZlNwaGVyZXMpOwogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShudW1iZXJPZlBvc2l0aW9ucyk7CiAgICBjb25zdCB2ZXJ0ZXhCYXRjaElkcyA9IG5ldyBVaW50MTZBcnJheShudW1iZXJPZlBvc2l0aW9ucyAvIDMpOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlBvc2l0aW9ucyAvIDMsCiAgICAgIG51bWJlck9mSW5kaWNlcwogICAgKTsKICAgIGNvbnN0IG51bWJlck9mR2VvbWV0cmllcyA9IG51bWJlck9mQm94ZXMgKyBudW1iZXJPZkN5bGluZGVycyArIG51bWJlck9mRWxsaXBzb2lkcyArIG51bWJlck9mU3BoZXJlczsKICAgIGNvbnN0IGJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICBjb25zdCBiYXRjaGVkSW5kaWNlcyA9IG5ldyBBcnJheShudW1iZXJPZkdlb21ldHJpZXMpOwogICAgY29uc3QgaW5kZXhPZmZzZXRzID0gbmV3IFVpbnQzMkFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICBjb25zdCBpbmRleENvdW50cyA9IG5ldyBVaW50MzJBcnJheShudW1iZXJPZkdlb21ldHJpZXMpOwogICAgY29uc3QgYm91bmRpbmdWb2x1bWVzID0gbmV3IEFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICB1bnBhY2tCdWZmZXIocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgYmF0Y2hUYWJsZUNvbG9yczogbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuYmF0Y2hUYWJsZUNvbG9ycyksCiAgICAgIHBvc2l0aW9ucywKICAgICAgdmVydGV4QmF0Y2hJZHMsCiAgICAgIGluZGljZXMsCiAgICAgIGJhdGNoSWRzLAogICAgICBiYXRjaGVkSW5kaWNlcywKICAgICAgaW5kZXhPZmZzZXRzLAogICAgICBpbmRleENvdW50cywKICAgICAgYm91bmRpbmdWb2x1bWVzLAogICAgICBwb3NpdGlvbk9mZnNldDogMCwKICAgICAgYmF0Y2hJZEluZGV4OiAwLAogICAgICBpbmRleE9mZnNldDogMCwKICAgICAgYmF0Y2hlZEluZGljZXNPZmZzZXQ6IDAsCiAgICAgIG1vZGVsTWF0cml4OiBzY3JhdGNoTWF0cml4NCwKICAgICAgY2VudGVyOiBzY3JhdGNoQ2VudGVyNQogICAgfTsKICAgIGNyZWF0ZVByaW1pdGl2ZSgKICAgICAgb3B0aW9ucywKICAgICAgYm94ZXMsCiAgICAgIGJveEJhdGNoSWRzLAogICAgICBib3hHZW9tZXRyeSwKICAgICAgYm94TW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZQogICAgKTsKICAgIGNyZWF0ZVByaW1pdGl2ZSgKICAgICAgb3B0aW9ucywKICAgICAgY3lsaW5kZXJzLAogICAgICBjeWxpbmRlckJhdGNoSWRzLAogICAgICBjeWxpbmRlckdlb21ldHJ5LAogICAgICBjeWxpbmRlck1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUKICAgICk7CiAgICBjcmVhdGVQcmltaXRpdmUoCiAgICAgIG9wdGlvbnMsCiAgICAgIGVsbGlwc29pZHMsCiAgICAgIGVsbGlwc29pZEJhdGNoSWRzLAogICAgICBlbGxpcHNvaWRHZW9tZXRyeSwKICAgICAgZWxsaXBzb2lkTW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZQogICAgKTsKICAgIGNyZWF0ZVByaW1pdGl2ZSgKICAgICAgb3B0aW9ucywKICAgICAgc3BoZXJlcywKICAgICAgc3BoZXJlQmF0Y2hJZHMsCiAgICAgIGVsbGlwc29pZEdlb21ldHJ5LAogICAgICBzcGhlcmVNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lCiAgICApOwogICAgY29uc3QgcGFja2VkQnVmZmVyID0gcGFja0J1ZmZlcigKICAgICAgaW5kaWNlcy5CWVRFU19QRVJfRUxFTUVOVCwKICAgICAgYmF0Y2hlZEluZGljZXMsCiAgICAgIGJvdW5kaW5nVm9sdW1lcwogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgcG9zaXRpb25zLmJ1ZmZlciwKICAgICAgdmVydGV4QmF0Y2hJZHMuYnVmZmVyLAogICAgICBpbmRpY2VzLmJ1ZmZlcgogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgYmF0Y2hJZHMuYnVmZmVyLAogICAgICBpbmRleE9mZnNldHMuYnVmZmVyLAogICAgICBpbmRleENvdW50cy5idWZmZXIKICAgICk7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocGFja2VkQnVmZmVyLmJ1ZmZlcik7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbnM6IHBvc2l0aW9ucy5idWZmZXIsCiAgICAgIHZlcnRleEJhdGNoSWRzOiB2ZXJ0ZXhCYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGljZXM6IGluZGljZXMuYnVmZmVyLAogICAgICBpbmRleE9mZnNldHM6IGluZGV4T2Zmc2V0cy5idWZmZXIsCiAgICAgIGluZGV4Q291bnRzOiBpbmRleENvdW50cy5idWZmZXIsCiAgICAgIGJhdGNoSWRzOiBiYXRjaElkcy5idWZmZXIsCiAgICAgIHBhY2tlZEJ1ZmZlcjogcGFja2VkQnVmZmVyLmJ1ZmZlcgogICAgfTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xMSwgcGFja2VkQm94TGVuZ3RoLCBwYWNrZWRDeWxpbmRlckxlbmd0aCwgcGFja2VkRWxsaXBzb2lkTGVuZ3RoLCBwYWNrZWRTcGhlcmVMZW5ndGgsIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWLCBzY3JhdGNoUG9zaXRpb241LCBzY3JhdGNoQ2VudGVyNSwgc2NyYXRjaE1hdHJpeDQsIGNyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzLmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0JveEdlb21ldHJ5KCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbG9yKCk7CiAgICAgIGluaXRfQ3lsaW5kZXJHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRHZW9tZXRyeSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfVmVjdG9yM0RUaWxlQmF0Y2goKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcGFja2VkQm94TGVuZ3RoID0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIHBhY2tlZEN5bGluZGVyTGVuZ3RoID0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDI7CiAgICAgIHBhY2tlZEVsbGlwc29pZExlbmd0aCA9IE1hdHJpeDRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBwYWNrZWRTcGhlcmVMZW5ndGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICAgICAgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYgPSB7CiAgICAgICAgbW9kZWxNYXRyaXg6IG5ldyBNYXRyaXg0X2RlZmF1bHQoKSwKICAgICAgICBib3VuZGluZ1ZvbHVtZTogbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKQogICAgICB9OwogICAgICBzY3JhdGNoUG9zaXRpb241ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2VudGVyNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1hdHJpeDQgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZVBvaW50cy5qcwogIHZhciBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVZlY3RvclRpbGVQb2ludHNfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIHVucGFja0J1ZmZlcjIocGFja2VkQnVmZmVyKSB7CiAgICBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KHBhY2tlZEJ1ZmZlcik7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHNjcmF0Y2hNaW5NYXhIZWlnaHRzLm1pbiA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBzY3JhdGNoTWluTWF4SGVpZ2h0cy5tYXggPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoUmVjdGFuZ2xlNCk7CiAgICBvZmZzZXQgKz0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoRWxsaXBzb2lkMTQpOwogIH0KICBmdW5jdGlvbiBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLnBvc2l0aW9ucyk7CiAgICB1bnBhY2tCdWZmZXIyKHBhcmFtZXRlcnMucGFja2VkQnVmZmVyKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IHNjcmF0Y2hSZWN0YW5nbGU0OwogICAgY29uc3QgZWxsaXBzb2lkID0gc2NyYXRjaEVsbGlwc29pZDE0OwogICAgY29uc3QgbWluaW11bUhlaWdodCA9IHNjcmF0Y2hNaW5NYXhIZWlnaHRzLm1pbjsKICAgIGNvbnN0IG1heGltdW1IZWlnaHQgPSBzY3JhdGNoTWluTWF4SGVpZ2h0cy5tYXg7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHVCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMCwgcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IHZCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkocG9zaXRpb25zTGVuZ3RoLCAyICogcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IGhlaWdodEJ1ZmZlciA9IHBvc2l0aW9ucy5zdWJhcnJheSgKICAgICAgMiAqIHBvc2l0aW9uc0xlbmd0aCwKICAgICAgMyAqIHBvc2l0aW9uc0xlbmd0aAogICAgKTsKICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuemlnWmFnRGVsdGFEZWNvZGUodUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyKTsKICAgIGNvbnN0IGRlY29kZWQgPSBuZXcgRmxvYXQ2NEFycmF5KHBvc2l0aW9ucy5sZW5ndGgpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBjb25zdCB1MyA9IHVCdWZmZXJbaV07CiAgICAgIGNvbnN0IHYzID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodEJ1ZmZlcltpXTsKICAgICAgY29uc3QgbG9uID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5lYXN0LCB1MyAvIG1heFNob3J0KTsKICAgICAgY29uc3QgbGF0ID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLnNvdXRoLCByZWN0YW5nbGUubm9ydGgsIHYzIC8gbWF4U2hvcnQpOwogICAgICBjb25zdCBhbHQgPSBNYXRoX2RlZmF1bHQubGVycChtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBoIC8gbWF4U2hvcnQpOwogICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgbG9uLAogICAgICAgIGxhdCwKICAgICAgICBhbHQsCiAgICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljMgogICAgICApOwogICAgICBjb25zdCBkZWNvZGVkUG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMgogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhkZWNvZGVkUG9zaXRpb24sIGRlY29kZWQsIGkgKiAzKTsKICAgIH0KICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChkZWNvZGVkLmJ1ZmZlcik7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbnM6IGRlY29kZWQuYnVmZmVyCiAgICB9OwogIH0KICB2YXIgbWF4U2hvcnQsIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzIsIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24yLCBzY3JhdGNoUmVjdGFuZ2xlNCwgc2NyYXRjaEVsbGlwc29pZDE0LCBzY3JhdGNoTWluTWF4SGVpZ2h0cywgY3JlYXRlVmVjdG9yVGlsZVBvaW50c19kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2ludHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVQb2ludHMuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIG1heFNob3J0ID0gMzI3Njc7CiAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGU0ID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxNCA9IG5ldyBFbGxpcHNvaWRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluTWF4SGVpZ2h0cyA9IHsKICAgICAgICBtaW46IHZvaWQgMCwKICAgICAgICBtYXg6IHZvaWQgMAogICAgICB9OwogICAgICBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZVBvaW50cyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMuanMKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiB1bnBhY2tCdWZmZXIzKGJ1ZmZlcikgewogICAgY29uc3QgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShidWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBzY3JhdGNoU2NhbGFycy5pbmRleEJ5dGVzUGVyRWxlbWVudCA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBzY3JhdGNoU2NhbGFycy5taW4gPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgc2NyYXRjaFNjYWxhcnMubWF4ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hDZW50ZXI2KTsKICAgIG9mZnNldCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoRWxsaXBzb2lkMTUpOwogICAgb2Zmc2V0ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIFJlY3RhbmdsZV9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaFJlY3RhbmdsZTUpOwogIH0KICBmdW5jdGlvbiBwYWNrZWRCYXRjaGVkSW5kaWNlc0xlbmd0aDIoYmF0Y2hlZEluZGljZXMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGJhdGNoZWRJbmRpY2VzLmxlbmd0aDsKICAgIGxldCBjb3VudCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvdW50ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMyArIGJhdGNoZWRJbmRpY2VzW2ldLmJhdGNoSWRzLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiBjb3VudDsKICB9CiAgZnVuY3Rpb24gcGFja0J1ZmZlcjIoaW5kZXhEYXRhdHlwZSwgYm91bmRpbmdWb2x1bWVzLCBiYXRjaGVkSW5kaWNlcykgewogICAgY29uc3QgbnVtQlZzID0gYm91bmRpbmdWb2x1bWVzLmxlbmd0aDsKICAgIGNvbnN0IGxlbmd0aCA9IDEgKyAxICsgbnVtQlZzICogT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDEgKyBwYWNrZWRCYXRjaGVkSW5kaWNlc0xlbmd0aDIoYmF0Y2hlZEluZGljZXMpOwogICAgY29uc3QgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGgpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gaW5kZXhEYXRhdHlwZTsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBudW1CVnM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUJWczsgKytpKSB7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdC5wYWNrKGJvdW5kaW5nVm9sdW1lc1tpXSwgcGFja2VkQnVmZmVyLCBvZmZzZXQpOwogICAgICBvZmZzZXQgKz0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0KICAgIGNvbnN0IGluZGljZXNMZW5ndGggPSBiYXRjaGVkSW5kaWNlcy5sZW5ndGg7CiAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gaW5kaWNlc0xlbmd0aDsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgaW5kaWNlc0xlbmd0aDsgKytqKSB7CiAgICAgIGNvbnN0IGJhdGNoZWRJbmRleCA9IGJhdGNoZWRJbmRpY2VzW2pdOwogICAgICBDb2xvcl9kZWZhdWx0LnBhY2soYmF0Y2hlZEluZGV4LmNvbG9yLCBwYWNrZWRCdWZmZXIsIG9mZnNldCk7CiAgICAgIG9mZnNldCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoZWRJbmRleC5vZmZzZXQ7CiAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaGVkSW5kZXguY291bnQ7CiAgICAgIGNvbnN0IGJhdGNoSWRzID0gYmF0Y2hlZEluZGV4LmJhdGNoSWRzOwogICAgICBjb25zdCBiYXRjaElkc0xlbmd0aCA9IGJhdGNoSWRzLmxlbmd0aDsKICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoSWRzTGVuZ3RoOwogICAgICBmb3IgKGxldCBrID0gMDsgayA8IGJhdGNoSWRzTGVuZ3RoOyArK2spIHsKICAgICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hJZHNba107CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwYWNrZWRCdWZmZXI7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29ucyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICB1bnBhY2tCdWZmZXIzKHBhcmFtZXRlcnMucGFja2VkQnVmZmVyKTsKICAgIGxldCBpbmRpY2VzOwogICAgY29uc3QgaW5kZXhCeXRlc1BlckVsZW1lbnQgPSBzY3JhdGNoU2NhbGFycy5pbmRleEJ5dGVzUGVyRWxlbWVudDsKICAgIGlmIChpbmRleEJ5dGVzUGVyRWxlbWVudCA9PT0gMikgewogICAgICBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMuaW5kaWNlcyk7CiAgICB9IGVsc2UgewogICAgICBpbmRpY2VzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuaW5kaWNlcyk7CiAgICB9CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5wb3NpdGlvbnMpOwogICAgY29uc3QgY291bnRzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuY291bnRzKTsKICAgIGNvbnN0IGluZGV4Q291bnRzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuaW5kZXhDb3VudHMpOwogICAgY29uc3QgYmF0Y2hJZHMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5iYXRjaElkcyk7CiAgICBjb25zdCBiYXRjaFRhYmxlQ29sb3JzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuYmF0Y2hUYWJsZUNvbG9ycyk7CiAgICBjb25zdCBib3VuZGluZ1ZvbHVtZXMgPSBuZXcgQXJyYXkoY291bnRzLmxlbmd0aCk7CiAgICBjb25zdCBjZW50ZXIgPSBzY3JhdGNoQ2VudGVyNjsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHNjcmF0Y2hFbGxpcHNvaWQxNTsKICAgIGxldCByZWN0YW5nbGUgPSBzY3JhdGNoUmVjdGFuZ2xlNTsKICAgIGNvbnN0IG1pbkhlaWdodCA9IHNjcmF0Y2hTY2FsYXJzLm1pbjsKICAgIGNvbnN0IG1heEhlaWdodCA9IHNjcmF0Y2hTY2FsYXJzLm1heDsKICAgIGxldCBtaW5pbXVtSGVpZ2h0cyA9IHBhcmFtZXRlcnMubWluaW11bUhlaWdodHM7CiAgICBsZXQgbWF4aW11bUhlaWdodHMgPSBwYXJhbWV0ZXJzLm1heGltdW1IZWlnaHRzOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykgJiYgZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSkgewogICAgICBtaW5pbXVtSGVpZ2h0cyA9IG5ldyBGbG9hdDMyQXJyYXkobWluaW11bUhlaWdodHMpOwogICAgICBtYXhpbXVtSGVpZ2h0cyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4aW11bUhlaWdodHMpOwogICAgfQogICAgbGV0IGk7CiAgICBsZXQgajsKICAgIGxldCByZ2JhOwogICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDI7CiAgICBjb25zdCB1QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KDAsIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCB2QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KHBvc2l0aW9uc0xlbmd0aCwgMiAqIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LnppZ1phZ0RlbHRhRGVjb2RlKHVCdWZmZXIsIHZCdWZmZXIpOwogICAgY29uc3QgZGVjb2RlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkocG9zaXRpb25zTGVuZ3RoICogMyk7CiAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgdTMgPSB1QnVmZmVyW2ldOwogICAgICBjb25zdCB2MyA9IHZCdWZmZXJbaV07CiAgICAgIGNvbnN0IHggPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLmVhc3QsIHUzIC8gbWF4U2hvcnQyKTsKICAgICAgY29uc3QgeSA9IE1hdGhfZGVmYXVsdC5sZXJwKHJlY3RhbmdsZS5zb3V0aCwgcmVjdGFuZ2xlLm5vcnRoLCB2MyAvIG1heFNob3J0Mik7CiAgICAgIGNvbnN0IGNhcnQgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucyh4LCB5LCAwLCBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMzKTsKICAgICAgY29uc3QgZGVjb2RlZFBvc2l0aW9uID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgIGNhcnQsCiAgICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjMKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZGVjb2RlZFBvc2l0aW9uLCBkZWNvZGVkUG9zaXRpb25zLCBpICogMyk7CiAgICB9CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgY29uc3Qgb2Zmc2V0cyA9IG5ldyBBcnJheShjb3VudHNMZW5ndGgpOwogICAgY29uc3QgaW5kZXhPZmZzZXRzID0gbmV3IEFycmF5KGNvdW50c0xlbmd0aCk7CiAgICBsZXQgY3VycmVudE9mZnNldCA9IDA7CiAgICBsZXQgY3VycmVudEluZGV4T2Zmc2V0ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7ICsraSkgewogICAgICBvZmZzZXRzW2ldID0gY3VycmVudE9mZnNldDsKICAgICAgaW5kZXhPZmZzZXRzW2ldID0gY3VycmVudEluZGV4T2Zmc2V0OwogICAgICBjdXJyZW50T2Zmc2V0ICs9IGNvdW50c1tpXTsKICAgICAgY3VycmVudEluZGV4T2Zmc2V0ICs9IGluZGV4Q291bnRzW2ldOwogICAgfQogICAgY29uc3QgYmF0Y2hlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkocG9zaXRpb25zTGVuZ3RoICogMyAqIDIpOwogICAgY29uc3QgYmF0Y2hlZElkcyA9IG5ldyBVaW50MTZBcnJheShwb3NpdGlvbnNMZW5ndGggKiAyKTsKICAgIGNvbnN0IGJhdGNoZWRJbmRleE9mZnNldHMgPSBuZXcgVWludDMyQXJyYXkoaW5kZXhPZmZzZXRzLmxlbmd0aCk7CiAgICBjb25zdCBiYXRjaGVkSW5kZXhDb3VudHMgPSBuZXcgVWludDMyQXJyYXkoaW5kZXhDb3VudHMubGVuZ3RoKTsKICAgIGxldCBiYXRjaGVkSW5kaWNlcyA9IFtdOwogICAgY29uc3QgY29sb3JUb0J1ZmZlcnMgPSB7fTsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7ICsraSkgewogICAgICByZ2JhID0gYmF0Y2hUYWJsZUNvbG9yc1tpXTsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29sb3JUb0J1ZmZlcnNbcmdiYV0pKSB7CiAgICAgICAgY29sb3JUb0J1ZmZlcnNbcmdiYV0gPSB7CiAgICAgICAgICBwb3NpdGlvbkxlbmd0aDogY291bnRzW2ldLAogICAgICAgICAgaW5kZXhMZW5ndGg6IGluZGV4Q291bnRzW2ldLAogICAgICAgICAgb2Zmc2V0OiAwLAogICAgICAgICAgaW5kZXhPZmZzZXQ6IDAsCiAgICAgICAgICBiYXRjaElkczogW2ldCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb2xvclRvQnVmZmVyc1tyZ2JhXS5wb3NpdGlvbkxlbmd0aCArPSBjb3VudHNbaV07CiAgICAgICAgY29sb3JUb0J1ZmZlcnNbcmdiYV0uaW5kZXhMZW5ndGggKz0gaW5kZXhDb3VudHNbaV07CiAgICAgICAgY29sb3JUb0J1ZmZlcnNbcmdiYV0uYmF0Y2hJZHMucHVzaChpKTsKICAgICAgfQogICAgfQogICAgbGV0IGJ1ZmZlcjsKICAgIGxldCBieUNvbG9yUG9zaXRpb25PZmZzZXQgPSAwOwogICAgbGV0IGJ5Q29sb3JJbmRleE9mZnNldCA9IDA7CiAgICBmb3IgKHJnYmEgaW4gY29sb3JUb0J1ZmZlcnMpIHsKICAgICAgaWYgKGNvbG9yVG9CdWZmZXJzLmhhc093blByb3BlcnR5KHJnYmEpKSB7CiAgICAgICAgYnVmZmVyID0gY29sb3JUb0J1ZmZlcnNbcmdiYV07CiAgICAgICAgYnVmZmVyLm9mZnNldCA9IGJ5Q29sb3JQb3NpdGlvbk9mZnNldDsKICAgICAgICBidWZmZXIuaW5kZXhPZmZzZXQgPSBieUNvbG9ySW5kZXhPZmZzZXQ7CiAgICAgICAgY29uc3QgcG9zaXRpb25MZW5ndGggPSBidWZmZXIucG9zaXRpb25MZW5ndGggKiAyOwogICAgICAgIGNvbnN0IGluZGV4TGVuZ3RoID0gYnVmZmVyLmluZGV4TGVuZ3RoICogMiArIGJ1ZmZlci5wb3NpdGlvbkxlbmd0aCAqIDY7CiAgICAgICAgYnlDb2xvclBvc2l0aW9uT2Zmc2V0ICs9IHBvc2l0aW9uTGVuZ3RoOwogICAgICAgIGJ5Q29sb3JJbmRleE9mZnNldCArPSBpbmRleExlbmd0aDsKICAgICAgICBidWZmZXIuaW5kZXhMZW5ndGggPSBpbmRleExlbmd0aDsKICAgICAgfQogICAgfQogICAgY29uc3QgYmF0Y2hlZERyYXdDYWxscyA9IFtdOwogICAgZm9yIChyZ2JhIGluIGNvbG9yVG9CdWZmZXJzKSB7CiAgICAgIGlmIChjb2xvclRvQnVmZmVycy5oYXNPd25Qcm9wZXJ0eShyZ2JhKSkgewogICAgICAgIGJ1ZmZlciA9IGNvbG9yVG9CdWZmZXJzW3JnYmFdOwogICAgICAgIGJhdGNoZWREcmF3Q2FsbHMucHVzaCh7CiAgICAgICAgICBjb2xvcjogQ29sb3JfZGVmYXVsdC5mcm9tUmdiYShwYXJzZUludChyZ2JhKSksCiAgICAgICAgICBvZmZzZXQ6IGJ1ZmZlci5pbmRleE9mZnNldCwKICAgICAgICAgIGNvdW50OiBidWZmZXIuaW5kZXhMZW5ndGgsCiAgICAgICAgICBiYXRjaElkczogYnVmZmVyLmJhdGNoSWRzCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7ICsraSkgewogICAgICByZ2JhID0gYmF0Y2hUYWJsZUNvbG9yc1tpXTsKICAgICAgYnVmZmVyID0gY29sb3JUb0J1ZmZlcnNbcmdiYV07CiAgICAgIGNvbnN0IHBvc2l0aW9uT2Zmc2V0ID0gYnVmZmVyLm9mZnNldDsKICAgICAgbGV0IHBvc2l0aW9uSW5kZXggPSBwb3NpdGlvbk9mZnNldCAqIDM7CiAgICAgIGxldCBiYXRjaElkSW5kZXggPSBwb3NpdGlvbk9mZnNldDsKICAgICAgY29uc3QgcG9seWdvbk9mZnNldCA9IG9mZnNldHNbaV07CiAgICAgIGNvbnN0IHBvbHlnb25Db3VudCA9IGNvdW50c1tpXTsKICAgICAgY29uc3QgYmF0Y2hJZCA9IGJhdGNoSWRzW2ldOwogICAgICBsZXQgcG9seWdvbk1pbmltdW1IZWlnaHQgPSBtaW5IZWlnaHQ7CiAgICAgIGxldCBwb2x5Z29uTWF4aW11bUhlaWdodCA9IG1heEhlaWdodDsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykgJiYgZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSkgewogICAgICAgIHBvbHlnb25NaW5pbXVtSGVpZ2h0ID0gbWluaW11bUhlaWdodHNbaV07CiAgICAgICAgcG9seWdvbk1heGltdW1IZWlnaHQgPSBtYXhpbXVtSGVpZ2h0c1tpXTsKICAgICAgfQogICAgICBsZXQgbWluTGF0ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICBsZXQgbWF4TGF0ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICBsZXQgbWluTG9uID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICBsZXQgbWF4TG9uID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICBmb3IgKGogPSAwOyBqIDwgcG9seWdvbkNvdW50OyArK2opIHsKICAgICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBkZWNvZGVkUG9zaXRpb25zLAogICAgICAgICAgcG9seWdvbk9mZnNldCAqIDMgKyBqICogMywKICAgICAgICAgIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24zCiAgICAgICAgKTsKICAgICAgICBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgIGNvbnN0IGNhcnRvID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsYXQgPSBjYXJ0by5sYXRpdHVkZTsKICAgICAgICBjb25zdCBsb24gPSBjYXJ0by5sb25naXR1ZGU7CiAgICAgICAgbWluTGF0ID0gTWF0aC5taW4obGF0LCBtaW5MYXQpOwogICAgICAgIG1heExhdCA9IE1hdGgubWF4KGxhdCwgbWF4TGF0KTsKICAgICAgICBtaW5Mb24gPSBNYXRoLm1pbihsb24sIG1pbkxvbik7CiAgICAgICAgbWF4TG9uID0gTWF0aC5tYXgobG9uLCBtYXhMb24pOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBzY3JhdGNoTm9ybWFsNyk7CiAgICAgICAgbGV0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgIHBvbHlnb25NaW5pbXVtSGVpZ2h0LAogICAgICAgICAgc2NyYXRjaFNjYWxlZE5vcm1hbAogICAgICAgICk7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0UG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY2FsZWROb3JtYWwsCiAgICAgICAgICBzY3JhdGNoTWluSGVpZ2h0UG9zaXRpb24KICAgICAgICApOwogICAgICAgIHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgIHBvbHlnb25NYXhpbXVtSGVpZ2h0LAogICAgICAgICAgc2NhbGVkTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBjb25zdCBtYXhIZWlnaHRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgICAgIHNjcmF0Y2hNYXhIZWlnaHRQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG1heEhlaWdodFBvc2l0aW9uLCBjZW50ZXIsIG1heEhlaWdodFBvc2l0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobWluSGVpZ2h0UG9zaXRpb24sIGNlbnRlciwgbWluSGVpZ2h0UG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKG1heEhlaWdodFBvc2l0aW9uLCBiYXRjaGVkUG9zaXRpb25zLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhtaW5IZWlnaHRQb3NpdGlvbiwgYmF0Y2hlZFBvc2l0aW9ucywgcG9zaXRpb25JbmRleCArIDMpOwogICAgICAgIGJhdGNoZWRJZHNbYmF0Y2hJZEluZGV4XSA9IGJhdGNoSWQ7CiAgICAgICAgYmF0Y2hlZElkc1tiYXRjaElkSW5kZXggKyAxXSA9IGJhdGNoSWQ7CiAgICAgICAgcG9zaXRpb25JbmRleCArPSA2OwogICAgICAgIGJhdGNoSWRJbmRleCArPSAyOwogICAgICB9CiAgICAgIHJlY3RhbmdsZSA9IHNjcmF0Y2hCVlJlY3RhbmdsZTsKICAgICAgcmVjdGFuZ2xlLndlc3QgPSBtaW5Mb247CiAgICAgIHJlY3RhbmdsZS5lYXN0ID0gbWF4TG9uOwogICAgICByZWN0YW5nbGUuc291dGggPSBtaW5MYXQ7CiAgICAgIHJlY3RhbmdsZS5ub3J0aCA9IG1heExhdDsKICAgICAgYm91bmRpbmdWb2x1bWVzW2ldID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIG1pbkhlaWdodCwKICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgZWxsaXBzb2lkCiAgICAgICk7CiAgICAgIGxldCBpbmRpY2VzSW5kZXggPSBidWZmZXIuaW5kZXhPZmZzZXQ7CiAgICAgIGNvbnN0IGluZGV4T2Zmc2V0ID0gaW5kZXhPZmZzZXRzW2ldOwogICAgICBjb25zdCBpbmRleENvdW50ID0gaW5kZXhDb3VudHNbaV07CiAgICAgIGJhdGNoZWRJbmRleE9mZnNldHNbaV0gPSBpbmRpY2VzSW5kZXg7CiAgICAgIGZvciAoaiA9IDA7IGogPCBpbmRleENvdW50OyBqICs9IDMpIHsKICAgICAgICBjb25zdCBpMCA9IGluZGljZXNbaW5kZXhPZmZzZXQgKyBqXSAtIHBvbHlnb25PZmZzZXQ7CiAgICAgICAgY29uc3QgaTEgPSBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgaiArIDFdIC0gcG9seWdvbk9mZnNldDsKICAgICAgICBjb25zdCBpMiA9IGluZGljZXNbaW5kZXhPZmZzZXQgKyBqICsgMl0gLSBwb2x5Z29uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkwICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkxICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkyICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkyICogMiArIDEgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpMSAqIDIgKyAxICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTAgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICB9CiAgICAgIGZvciAoaiA9IDA7IGogPCBwb2x5Z29uQ291bnQ7ICsraikgewogICAgICAgIGNvbnN0IHYwMiA9IGo7CiAgICAgICAgY29uc3QgdjEyID0gKGogKyAxKSAlIHBvbHlnb25Db3VudDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB2MDIgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYxMiAqIDIgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB2MDIgKiAyICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdjAyICogMiArIDEgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB2MTIgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYxMiAqIDIgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgfQogICAgICBidWZmZXIub2Zmc2V0ICs9IHBvbHlnb25Db3VudCAqIDI7CiAgICAgIGJ1ZmZlci5pbmRleE9mZnNldCA9IGluZGljZXNJbmRleDsKICAgICAgYmF0Y2hlZEluZGV4Q291bnRzW2ldID0gaW5kaWNlc0luZGV4IC0gYmF0Y2hlZEluZGV4T2Zmc2V0c1tpXTsKICAgIH0KICAgIGJhdGNoZWRJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIGJhdGNoZWRQb3NpdGlvbnMubGVuZ3RoIC8gMywKICAgICAgYmF0Y2hlZEluZGljZXMKICAgICk7CiAgICBjb25zdCBiYXRjaGVkSW5kaWNlc0xlbmd0aCA9IGJhdGNoZWREcmF3Q2FsbHMubGVuZ3RoOwogICAgZm9yIChsZXQgbSA9IDA7IG0gPCBiYXRjaGVkSW5kaWNlc0xlbmd0aDsgKyttKSB7CiAgICAgIGNvbnN0IHRlbXBJZHMgPSBiYXRjaGVkRHJhd0NhbGxzW21dLmJhdGNoSWRzOwogICAgICBsZXQgY291bnQgPSAwOwogICAgICBjb25zdCB0ZW1wSWRzTGVuZ3RoID0gdGVtcElkcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IG4gPSAwOyBuIDwgdGVtcElkc0xlbmd0aDsgKytuKSB7CiAgICAgICAgY291bnQgKz0gYmF0Y2hlZEluZGV4Q291bnRzW3RlbXBJZHNbbl1dOwogICAgICB9CiAgICAgIGJhdGNoZWREcmF3Q2FsbHNbbV0uY291bnQgPSBjb3VudDsKICAgIH0KICAgIGNvbnN0IGluZGV4RGF0YXR5cGUgPSBiYXRjaGVkSW5kaWNlcy5CWVRFU19QRVJfRUxFTUVOVCA9PT0gMiA/IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCA6IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9JTlQ7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBwYWNrQnVmZmVyMigKICAgICAgaW5kZXhEYXRhdHlwZSwKICAgICAgYm91bmRpbmdWb2x1bWVzLAogICAgICBiYXRjaGVkRHJhd0NhbGxzCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBiYXRjaGVkUG9zaXRpb25zLmJ1ZmZlciwKICAgICAgYmF0Y2hlZEluZGljZXMuYnVmZmVyLAogICAgICBiYXRjaGVkSW5kZXhPZmZzZXRzLmJ1ZmZlciwKICAgICAgYmF0Y2hlZEluZGV4Q291bnRzLmJ1ZmZlciwKICAgICAgYmF0Y2hlZElkcy5idWZmZXIsCiAgICAgIHBhY2tlZEJ1ZmZlci5idWZmZXIKICAgICk7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbnM6IGJhdGNoZWRQb3NpdGlvbnMuYnVmZmVyLAogICAgICBpbmRpY2VzOiBiYXRjaGVkSW5kaWNlcy5idWZmZXIsCiAgICAgIGluZGV4T2Zmc2V0czogYmF0Y2hlZEluZGV4T2Zmc2V0cy5idWZmZXIsCiAgICAgIGluZGV4Q291bnRzOiBiYXRjaGVkSW5kZXhDb3VudHMuYnVmZmVyLAogICAgICBiYXRjaElkczogYmF0Y2hlZElkcy5idWZmZXIsCiAgICAgIHBhY2tlZEJ1ZmZlcjogcGFja2VkQnVmZmVyLmJ1ZmZlcgogICAgfTsKICB9CiAgdmFyIHNjcmF0Y2hDZW50ZXI2LCBzY3JhdGNoRWxsaXBzb2lkMTUsIHNjcmF0Y2hSZWN0YW5nbGU1LCBzY3JhdGNoU2NhbGFycywgbWF4U2hvcnQyLCBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMywgc2NyYXRjaE5vcm1hbDcsIHNjcmF0Y2hTY2FsZWROb3JtYWwsIHNjcmF0Y2hNaW5IZWlnaHRQb3NpdGlvbiwgc2NyYXRjaE1heEhlaWdodFBvc2l0aW9uLCBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMzLCBzY3JhdGNoQlZSZWN0YW5nbGUsIGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29uc19kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2x5Z29ucyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9Db2xvcigpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X09yaWVudGVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIHNjcmF0Y2hDZW50ZXI2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTUgPSBuZXcgRWxsaXBzb2lkX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTUgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFNjYWxhcnMgPSB7CiAgICAgICAgbWluOiB2b2lkIDAsCiAgICAgICAgbWF4OiB2b2lkIDAsCiAgICAgICAgaW5kZXhCeXRlc1BlckVsZW1lbnQ6IHZvaWQgMAogICAgICB9OwogICAgICBtYXhTaG9ydDIgPSAzMjc2NzsKICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWw3ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU2NhbGVkTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluSGVpZ2h0UG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNYXhIZWlnaHRQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljMyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQlZSZWN0YW5nbGUgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zLmpzCiAgZnVuY3Rpb24gZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnMocG9zaXRpb25zLCByZWN0YW5nbGUsIG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIGVsbGlwc29pZCkgewogICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCB1QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KDAsIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCB2QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KHBvc2l0aW9uc0xlbmd0aCwgMiAqIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCBoZWlnaHRCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkoCiAgICAgIDIgKiBwb3NpdGlvbnNMZW5ndGgsCiAgICAgIDMgKiBwb3NpdGlvbnNMZW5ndGgKICAgICk7CiAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LnppZ1phZ0RlbHRhRGVjb2RlKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlcik7CiAgICBjb25zdCBkZWNvZGVkID0gbmV3IEZsb2F0NjRBcnJheShwb3NpdGlvbnMubGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgdTMgPSB1QnVmZmVyW2ldOwogICAgICBjb25zdCB2MyA9IHZCdWZmZXJbaV07CiAgICAgIGNvbnN0IGggPSBoZWlnaHRCdWZmZXJbaV07CiAgICAgIGNvbnN0IGxvbiA9IE1hdGhfZGVmYXVsdC5sZXJwKHJlY3RhbmdsZS53ZXN0LCByZWN0YW5nbGUuZWFzdCwgdTMgLyBtYXhTaG9ydDMpOwogICAgICBjb25zdCBsYXQgPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUuc291dGgsIHJlY3RhbmdsZS5ub3J0aCwgdjMgLyBtYXhTaG9ydDMpOwogICAgICBjb25zdCBhbHQgPSBNYXRoX2RlZmF1bHQubGVycChtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBoIC8gbWF4U2hvcnQzKTsKICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgIGxvbiwKICAgICAgICBsYXQsCiAgICAgICAgYWx0LAogICAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzQKICAgICAgKTsKICAgICAgY29uc3QgZGVjb2RlZFBvc2l0aW9uID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgIGNhcnRvZ3JhcGhpYzIsCiAgICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjQKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZGVjb2RlZFBvc2l0aW9uLCBkZWNvZGVkLCBpICogMyk7CiAgICB9CiAgICByZXR1cm4gZGVjb2RlZDsKICB9CiAgdmFyIG1heFNob3J0Mywgc2NyYXRjaEJWQ2FydG9ncmFwaGljNCwgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjQsIGRlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIG1heFNob3J0MyA9IDMyNzY3OwogICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWM0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb240ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBkZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9uc19kZWZhdWx0ID0gZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzLmpzCiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXNfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lc19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gdW5wYWNrQnVmZmVyNChwYWNrZWRCdWZmZXIpIHsKICAgIHBhY2tlZEJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkocGFja2VkQnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgc2NyYXRjaE1pbk1heEhlaWdodHMyLm1pbiA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBzY3JhdGNoTWluTWF4SGVpZ2h0czIubWF4ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIFJlY3RhbmdsZV9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaFJlY3RhbmdsZTYpOwogICAgb2Zmc2V0ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaEVsbGlwc29pZDE2KTsKICAgIG9mZnNldCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoQ2VudGVyNyk7CiAgfQogIGZ1bmN0aW9uIGdldFBvc2l0aW9uT2Zmc2V0czIoY291bnRzKSB7CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgY29uc3QgcG9zaXRpb25PZmZzZXRzID0gbmV3IFVpbnQzMkFycmF5KGNvdW50c0xlbmd0aCArIDEpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIHBvc2l0aW9uT2Zmc2V0c1tpXSA9IG9mZnNldDsKICAgICAgb2Zmc2V0ICs9IGNvdW50c1tpXTsKICAgIH0KICAgIHBvc2l0aW9uT2Zmc2V0c1tjb3VudHNMZW5ndGhdID0gb2Zmc2V0OwogICAgcmV0dXJuIHBvc2l0aW9uT2Zmc2V0czsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBlbmNvZGVkUG9zaXRpb25zID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMucG9zaXRpb25zKTsKICAgIGNvbnN0IHdpZHRocyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLndpZHRocyk7CiAgICBjb25zdCBjb3VudHMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5jb3VudHMpOwogICAgY29uc3QgYmF0Y2hJZHMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5iYXRjaElkcyk7CiAgICB1bnBhY2tCdWZmZXI0KHBhcmFtZXRlcnMucGFja2VkQnVmZmVyKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IHNjcmF0Y2hSZWN0YW5nbGU2OwogICAgY29uc3QgZWxsaXBzb2lkID0gc2NyYXRjaEVsbGlwc29pZDE2OwogICAgY29uc3QgY2VudGVyID0gc2NyYXRjaENlbnRlcjc7CiAgICBjb25zdCBtaW5pbXVtSGVpZ2h0ID0gc2NyYXRjaE1pbk1heEhlaWdodHMyLm1pbjsKICAgIGNvbnN0IG1heGltdW1IZWlnaHQgPSBzY3JhdGNoTWluTWF4SGVpZ2h0czIubWF4OwogICAgY29uc3QgcG9zaXRpb25zID0gZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnNfZGVmYXVsdCgKICAgICAgZW5jb2RlZFBvc2l0aW9ucywKICAgICAgcmVjdGFuZ2xlLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHNpemUgPSBwb3NpdGlvbnNMZW5ndGggKiA0IC0gNDsKICAgIGNvbnN0IGN1clBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpOwogICAgY29uc3QgcHJldlBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpOwogICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpOwogICAgY29uc3QgZXhwYW5kQW5kV2lkdGggPSBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKTsKICAgIGNvbnN0IHZlcnRleEJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KHNpemUpOwogICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgbGV0IGV4cGFuZEFuZFdpZHRoSW5kZXggPSAwOwogICAgbGV0IGJhdGNoSWRJbmRleCA9IDA7CiAgICBsZXQgaTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgbGV0IGxlbmd0aCA9IGNvdW50cy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgY291bnQgPSBjb3VudHNbaV07CiAgICAgIGNvbnN0IHdpZHRoID0gd2lkdGhzW2ldOwogICAgICBjb25zdCBiYXRjaElkID0gYmF0Y2hJZHNbaV07CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgY291bnQ7ICsraikgewogICAgICAgIGxldCBwcmV2aW91czsKICAgICAgICBpZiAoaiA9PT0gMCkgewogICAgICAgICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBvc2l0aW9ucywgb2Zmc2V0ICogMywgc2NyYXRjaFAwMik7CiAgICAgICAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zLCAob2Zmc2V0ICsgMSkgKiAzLCBzY3JhdGNoUDEyKTsKICAgICAgICAgIHByZXZpb3VzID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAwLCBwMSwgc2NyYXRjaFByZXYyKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocDAsIHByZXZpb3VzLCBwcmV2aW91cyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByZXZpb3VzID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICAob2Zmc2V0ICsgaiAtIDEpICogMywKICAgICAgICAgICAgc2NyYXRjaFByZXYyCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBjdXJyZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIChvZmZzZXQgKyBqKSAqIDMsCiAgICAgICAgICBzY3JhdGNoQ3VyCiAgICAgICAgKTsKICAgICAgICBsZXQgbmV4dDsKICAgICAgICBpZiAoaiA9PT0gY291bnQgLSAxKSB7CiAgICAgICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgKG9mZnNldCArIGNvdW50IC0gMSkgKiAzLAogICAgICAgICAgICBzY3JhdGNoUDAyCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcDMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIChvZmZzZXQgKyBjb3VudCAtIDIpICogMywKICAgICAgICAgICAgc2NyYXRjaFAxMgogICAgICAgICAgKTsKICAgICAgICAgIG5leHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDIsIHAzLCBzY3JhdGNoTmV4dDIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMiwgbmV4dCwgbmV4dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5leHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBvc2l0aW9ucywgKG9mZnNldCArIGogKyAxKSAqIDMsIHNjcmF0Y2hOZXh0Mik7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwcmV2aW91cywgY2VudGVyLCBwcmV2aW91cyk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGN1cnJlbnQsIGNlbnRlciwgY3VycmVudCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHQsIGNlbnRlciwgbmV4dCk7CiAgICAgICAgY29uc3Qgc3RhcnRLID0gaiA9PT0gMCA/IDIgOiAwOwogICAgICAgIGNvbnN0IGVuZEsgPSBqID09PSBjb3VudCAtIDEgPyAyIDogNDsKICAgICAgICBmb3IgKGxldCBrID0gc3RhcnRLOyBrIDwgZW5kSzsgKytrKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjdXJyZW50LCBjdXJQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socHJldmlvdXMsIHByZXZQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sobmV4dCwgbmV4dFBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICBwb3NpdGlvbkluZGV4ICs9IDM7CiAgICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gayAtIDIgPCAwID8gLTEgOiAxOwogICAgICAgICAgZXhwYW5kQW5kV2lkdGhbZXhwYW5kQW5kV2lkdGhJbmRleCsrXSA9IDIgKiAoayAlIDIpIC0gMTsKICAgICAgICAgIGV4cGFuZEFuZFdpZHRoW2V4cGFuZEFuZFdpZHRoSW5kZXgrK10gPSBkaXJlY3Rpb24yICogd2lkdGg7CiAgICAgICAgICB2ZXJ0ZXhCYXRjaElkc1tiYXRjaElkSW5kZXgrK10gPSBiYXRjaElkOwogICAgICAgIH0KICAgICAgfQogICAgICBvZmZzZXQgKz0gY291bnQ7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoc2l6ZSwgcG9zaXRpb25zTGVuZ3RoICogNiAtIDYpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGxldCBpbmRpY2VzSW5kZXggPSAwOwogICAgbGVuZ3RoID0gcG9zaXRpb25zTGVuZ3RoIC0gMTsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMjsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAxOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMjsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDM7CiAgICAgIGluZGV4ICs9IDQ7CiAgICB9CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goCiAgICAgIGN1clBvc2l0aW9ucy5idWZmZXIsCiAgICAgIHByZXZQb3NpdGlvbnMuYnVmZmVyLAogICAgICBuZXh0UG9zaXRpb25zLmJ1ZmZlcgogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgZXhwYW5kQW5kV2lkdGguYnVmZmVyLAogICAgICB2ZXJ0ZXhCYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGljZXMuYnVmZmVyCiAgICApOwogICAgbGV0IHJlc3VsdHMgPSB7CiAgICAgIGluZGV4RGF0YXR5cGU6IGluZGljZXMuQllURVNfUEVSX0VMRU1FTlQgPT09IDIgPyBJbmRleERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfU0hPUlQgOiBJbmRleERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICBjdXJyZW50UG9zaXRpb25zOiBjdXJQb3NpdGlvbnMuYnVmZmVyLAogICAgICBwcmV2aW91c1Bvc2l0aW9uczogcHJldlBvc2l0aW9ucy5idWZmZXIsCiAgICAgIG5leHRQb3NpdGlvbnM6IG5leHRQb3NpdGlvbnMuYnVmZmVyLAogICAgICBleHBhbmRBbmRXaWR0aDogZXhwYW5kQW5kV2lkdGguYnVmZmVyLAogICAgICBiYXRjaElkczogdmVydGV4QmF0Y2hJZHMuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRpY2VzLmJ1ZmZlcgogICAgfTsKICAgIGlmIChwYXJhbWV0ZXJzLmtlZXBEZWNvZGVkUG9zaXRpb25zKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uT2Zmc2V0cyA9IGdldFBvc2l0aW9uT2Zmc2V0czIoY291bnRzKTsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHBvc2l0aW9ucy5idWZmZXIsIHBvc2l0aW9uT2Zmc2V0cy5idWZmZXIpOwogICAgICByZXN1bHRzID0gY29tYmluZV9kZWZhdWx0KHJlc3VsdHMsIHsKICAgICAgICBkZWNvZGVkUG9zaXRpb25zOiBwb3NpdGlvbnMuYnVmZmVyLAogICAgICAgIGRlY29kZWRQb3NpdGlvbk9mZnNldHM6IHBvc2l0aW9uT2Zmc2V0cy5idWZmZXIKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgdmFyIHNjcmF0Y2hSZWN0YW5nbGU2LCBzY3JhdGNoRWxsaXBzb2lkMTYsIHNjcmF0Y2hDZW50ZXI3LCBzY3JhdGNoTWluTWF4SGVpZ2h0czIsIHNjcmF0Y2hQMDIsIHNjcmF0Y2hQMTIsIHNjcmF0Y2hQcmV2Miwgc2NyYXRjaEN1ciwgc2NyYXRjaE5leHQyLCBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X2NvbWJpbmUoKTsKICAgICAgaW5pdF9kZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9ucygpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGU2ID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxNiA9IG5ldyBFbGxpcHNvaWRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2VudGVyNyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1pbk1heEhlaWdodHMyID0gewogICAgICAgIG1pbjogdm9pZCAwLAogICAgICAgIG1heDogdm9pZCAwCiAgICAgIH07CiAgICAgIHNjcmF0Y2hQMDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQMTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQcmV2MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEN1ciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5leHQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRhbE9jY2x1ZGVyLmpzCiAgZnVuY3Rpb24gRWxsaXBzb2lkYWxPY2NsdWRlcihlbGxpcHNvaWQsIGNhbWVyYVBvc2l0aW9uKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVsbGlwc29pZCIsIGVsbGlwc29pZCk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBlbGxpcHNvaWQ7CiAgICB0aGlzLl9jYW1lcmFQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIHRoaXMuX2NhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIHRoaXMuX2Rpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQgPSAwOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChjYW1lcmFQb3NpdGlvbikpIHsKICAgICAgdGhpcy5jYW1lcmFQb3NpdGlvbiA9IGNhbWVyYVBvc2l0aW9uOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRQb3NzaWJseVNocnVua0VsbGlwc29pZChlbGxpcHNvaWQsIG1pbmltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0KSAmJiBtaW5pbXVtSGVpZ2h0IDwgMCAmJiBlbGxpcHNvaWQubWluaW11bVJhZGl1cyA+IC1taW5pbXVtSGVpZ2h0KSB7CiAgICAgIGNvbnN0IGVsbGlwc29pZFNocnVua1JhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgICBlbGxpcHNvaWQucmFkaWkueCArIG1pbmltdW1IZWlnaHQsCiAgICAgICAgZWxsaXBzb2lkLnJhZGlpLnkgKyBtaW5pbXVtSGVpZ2h0LAogICAgICAgIGVsbGlwc29pZC5yYWRpaS56ICsgbWluaW11bUhlaWdodCwKICAgICAgICBzY3JhdGNoRWxsaXBzb2lkU2hydW5rUmFkaWkKICAgICAgKTsKICAgICAgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjMoZWxsaXBzb2lkU2hydW5rUmFkaWksIHJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gZWxsaXBzb2lkOwogIH0KICBmdW5jdGlvbiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21Qb3NpdGlvbnMoZWxsaXBzb2lkLCBkaXJlY3Rpb25Ub1BvaW50LCBwb3NpdGlvbnMsIHJlc3VsdCkgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb25Ub1BvaW50IiwgZGlyZWN0aW9uVG9Qb2ludCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIH0KICAgIGNvbnN0IHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCA9IGNvbXB1dGVTY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQoCiAgICAgIGVsbGlwc29pZCwKICAgICAgZGlyZWN0aW9uVG9Qb2ludAogICAgKTsKICAgIGxldCByZXN1bHRNYWduaXR1ZGUgPSAwOwogICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHBvc2l0aW9ucy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICBjb25zdCBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsKICAgICAgY29uc3QgY2FuZGlkYXRlTWFnbml0dWRlID0gY29tcHV0ZU1hZ25pdHVkZSgKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgcG9zaXRpb24sCiAgICAgICAgc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50CiAgICAgICk7CiAgICAgIGlmIChjYW5kaWRhdGVNYWduaXR1ZGUgPCAwKSB7CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfQogICAgICByZXN1bHRNYWduaXR1ZGUgPSBNYXRoLm1heChyZXN1bHRNYWduaXR1ZGUsIGNhbmRpZGF0ZU1hZ25pdHVkZSk7CiAgICB9CiAgICByZXR1cm4gbWFnbml0dWRlVG9Qb2ludChzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQsIHJlc3VsdE1hZ25pdHVkZSwgcmVzdWx0KTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRGcm9tVmVydGljZXMoZWxsaXBzb2lkLCBkaXJlY3Rpb25Ub1BvaW50LCB2ZXJ0aWNlcywgc3RyaWRlLCBjZW50ZXIsIHJlc3VsdCkgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb25Ub1BvaW50IiwgZGlyZWN0aW9uVG9Qb2ludCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZlcnRpY2VzIiwgdmVydGljZXMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzdHJpZGUiLCBzdHJpZGUpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICB9CiAgICBzdHJpZGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdHJpZGUsIDMpOwogICAgY2VudGVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICBjb25zdCBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQgPSBjb21wdXRlU2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50KAogICAgICBlbGxpcHNvaWQsCiAgICAgIGRpcmVjdGlvblRvUG9pbnQKICAgICk7CiAgICBsZXQgcmVzdWx0TWFnbml0dWRlID0gMDsKICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB2ZXJ0aWNlcy5sZW5ndGg7IGkgPCBsZW47IGkgKz0gc3RyaWRlKSB7CiAgICAgIHBvc2l0aW9uU2NyYXRjaDUueCA9IHZlcnRpY2VzW2ldICsgY2VudGVyLng7CiAgICAgIHBvc2l0aW9uU2NyYXRjaDUueSA9IHZlcnRpY2VzW2kgKyAxXSArIGNlbnRlci55OwogICAgICBwb3NpdGlvblNjcmF0Y2g1LnogPSB2ZXJ0aWNlc1tpICsgMl0gKyBjZW50ZXIuejsKICAgICAgY29uc3QgY2FuZGlkYXRlTWFnbml0dWRlID0gY29tcHV0ZU1hZ25pdHVkZSgKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgcG9zaXRpb25TY3JhdGNoNSwKICAgICAgICBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQKICAgICAgKTsKICAgICAgaWYgKGNhbmRpZGF0ZU1hZ25pdHVkZSA8IDApIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICAgIHJlc3VsdE1hZ25pdHVkZSA9IE1hdGgubWF4KHJlc3VsdE1hZ25pdHVkZSwgY2FuZGlkYXRlTWFnbml0dWRlKTsKICAgIH0KICAgIHJldHVybiBtYWduaXR1ZGVUb1BvaW50KHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwgcmVzdWx0TWFnbml0dWRlLCByZXN1bHQpOwogIH0KICBmdW5jdGlvbiBpc1NjYWxlZFNwYWNlUG9pbnRWaXNpYmxlKG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbiwgY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlLCBkaXN0YW5jZVRvTGltYkluU2NhbGVkU3BhY2VTcXVhcmVkKSB7CiAgICBjb25zdCBjdiA9IGNhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZTsKICAgIGNvbnN0IHZoTWFnbml0dWRlU3F1YXJlZCA9IGRpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQ7CiAgICBjb25zdCB2dCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgb2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLAogICAgICBjdiwKICAgICAgc2NyYXRjaENhcnRlc2lhbjE5CiAgICApOwogICAgY29uc3QgdnREb3RWYyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHZ0LCBjdik7CiAgICBjb25zdCBpc09jY2x1ZGVkID0gdmhNYWduaXR1ZGVTcXVhcmVkIDwgMCA/IHZ0RG90VmMgPiAwIDogdnREb3RWYyA+IHZoTWFnbml0dWRlU3F1YXJlZCAmJiB2dERvdFZjICogdnREb3RWYyAvIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKHZ0KSA+IHZoTWFnbml0dWRlU3F1YXJlZDsKICAgIHJldHVybiAhaXNPY2NsdWRlZDsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZU1hZ25pdHVkZShlbGxpcHNvaWQsIHBvc2l0aW9uLCBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQpIHsKICAgIGNvbnN0IHNjYWxlZFNwYWNlUG9zaXRpb24gPSBlbGxpcHNvaWQudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlKAogICAgICBwb3NpdGlvbiwKICAgICAgc2NhbGVkU3BhY2VTY3JhdGNoCiAgICApOwogICAgbGV0IG1hZ25pdHVkZVNxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZChzY2FsZWRTcGFjZVBvc2l0aW9uKTsKICAgIGxldCBtYWduaXR1ZGUgPSBNYXRoLnNxcnQobWFnbml0dWRlU3F1YXJlZCk7CiAgICBjb25zdCBkaXJlY3Rpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpdmlkZUJ5U2NhbGFyKAogICAgICBzY2FsZWRTcGFjZVBvc2l0aW9uLAogICAgICBtYWduaXR1ZGUsCiAgICAgIGRpcmVjdGlvblNjcmF0Y2gKICAgICk7CiAgICBtYWduaXR1ZGVTcXVhcmVkID0gTWF0aC5tYXgoMSwgbWFnbml0dWRlU3F1YXJlZCk7CiAgICBtYWduaXR1ZGUgPSBNYXRoLm1heCgxLCBtYWduaXR1ZGUpOwogICAgY29uc3QgY29zQWxwaGEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCk7CiAgICBjb25zdCBzaW5BbHBoYSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhkaXJlY3Rpb24yLCBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQsIGRpcmVjdGlvbjIpCiAgICApOwogICAgY29uc3QgY29zQmV0YSA9IDEgLyBtYWduaXR1ZGU7CiAgICBjb25zdCBzaW5CZXRhID0gTWF0aC5zcXJ0KG1hZ25pdHVkZVNxdWFyZWQgLSAxKSAqIGNvc0JldGE7CiAgICByZXR1cm4gMSAvIChjb3NBbHBoYSAqIGNvc0JldGEgLSBzaW5BbHBoYSAqIHNpbkJldGEpOwogIH0KICBmdW5jdGlvbiBtYWduaXR1ZGVUb1BvaW50KHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwgcmVzdWx0TWFnbml0dWRlLCByZXN1bHQpIHsKICAgIGlmIChyZXN1bHRNYWduaXR1ZGUgPD0gMCB8fCByZXN1bHRNYWduaXR1ZGUgPT09IDEgLyAwIHx8IHJlc3VsdE1hZ25pdHVkZSAhPT0gcmVzdWx0TWFnbml0dWRlKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwKICAgICAgcmVzdWx0TWFnbml0dWRlLAogICAgICByZXN1bHQKICAgICk7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVTY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQoZWxsaXBzb2lkLCBkaXJlY3Rpb25Ub1BvaW50KSB7CiAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhkaXJlY3Rpb25Ub1BvaW50LCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpIHsKICAgICAgcmV0dXJuIGRpcmVjdGlvblRvUG9pbnQ7CiAgICB9CiAgICBlbGxpcHNvaWQudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlKAogICAgICBkaXJlY3Rpb25Ub1BvaW50LAogICAgICBkaXJlY3Rpb25Ub1BvaW50U2NyYXRjaAogICAgKTsKICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoLCBkaXJlY3Rpb25Ub1BvaW50U2NyYXRjaCk7CiAgfQogIHZhciBzY3JhdGNoQ2FydGVzaWFuMTksIHNjcmF0Y2hDYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2VTaHJ1bmssIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmssIHN1YnNhbXBsZVNjcmF0Y2gsIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmtSYWRpaSwgcG9zaXRpb25TY3JhdGNoNSwgc2NhbGVkU3BhY2VTY3JhdGNoLCBkaXJlY3Rpb25TY3JhdGNoLCBkaXJlY3Rpb25Ub1BvaW50U2NyYXRjaCwgRWxsaXBzb2lkYWxPY2NsdWRlcl9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZGFsT2NjbHVkZXIgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZGFsT2NjbHVkZXIuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG9jY2x1ZGluZyBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIG9yIHNldHMgdGhlIHBvc2l0aW9uIG9mIHRoZSBjYW1lcmEuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRlc2lhbjN9CiAgICAgICAgICovCiAgICAgICAgY2FtZXJhUG9zaXRpb246IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jYW1lcmFQb3NpdGlvbjsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGNhbWVyYVBvc2l0aW9uKSB7CiAgICAgICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgICAgY29uc3QgY3YgPSBlbGxpcHNvaWQudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlKAogICAgICAgICAgICAgIGNhbWVyYVBvc2l0aW9uLAogICAgICAgICAgICAgIHRoaXMuX2NhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZQogICAgICAgICAgICApOwogICAgICAgICAgICBjb25zdCB2aE1hZ25pdHVkZVNxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZChjdikgLSAxOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2FtZXJhUG9zaXRpb24sIHRoaXMuX2NhbWVyYVBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5fY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlID0gY3Y7CiAgICAgICAgICAgIHRoaXMuX2Rpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQgPSB2aE1hZ25pdHVkZVNxdWFyZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjE5ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5pc1BvaW50VmlzaWJsZSA9IGZ1bmN0aW9uKG9jY2x1ZGVlKSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbiA9IGVsbGlwc29pZC50cmFuc2Zvcm1Qb3NpdGlvblRvU2NhbGVkU3BhY2UoCiAgICAgICAgICBvY2NsdWRlZSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xOQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGlzU2NhbGVkU3BhY2VQb2ludFZpc2libGUoCiAgICAgICAgICBvY2NsdWRlZVNjYWxlZFNwYWNlUG9zaXRpb24sCiAgICAgICAgICB0aGlzLl9jYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2UsCiAgICAgICAgICB0aGlzLl9kaXN0YW5jZVRvTGltYkluU2NhbGVkU3BhY2VTcXVhcmVkCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuaXNTY2FsZWRTcGFjZVBvaW50VmlzaWJsZSA9IGZ1bmN0aW9uKG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbikgewogICAgICAgIHJldHVybiBpc1NjYWxlZFNwYWNlUG9pbnRWaXNpYmxlKAogICAgICAgICAgb2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLAogICAgICAgICAgdGhpcy5fY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlLAogICAgICAgICAgdGhpcy5fZGlzdGFuY2VUb0xpbWJJblNjYWxlZFNwYWNlU3F1YXJlZAogICAgICAgICk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2VTaHJ1bmsgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLmlzU2NhbGVkU3BhY2VQb2ludFZpc2libGVQb3NzaWJseVVuZGVyRWxsaXBzb2lkID0gZnVuY3Rpb24ob2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLCBtaW5pbXVtSGVpZ2h0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgIGxldCB2aE1hZ25pdHVkZVNxdWFyZWQ7CiAgICAgICAgbGV0IGN2OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodCkgJiYgbWluaW11bUhlaWdodCA8IDAgJiYgZWxsaXBzb2lkLm1pbmltdW1SYWRpdXMgPiAtbWluaW11bUhlaWdodCkgewogICAgICAgICAgY3YgPSBzY3JhdGNoQ2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlU2hydW5rOwogICAgICAgICAgY3YueCA9IHRoaXMuX2NhbWVyYVBvc2l0aW9uLnggLyAoZWxsaXBzb2lkLnJhZGlpLnggKyBtaW5pbXVtSGVpZ2h0KTsKICAgICAgICAgIGN2LnkgPSB0aGlzLl9jYW1lcmFQb3NpdGlvbi55IC8gKGVsbGlwc29pZC5yYWRpaS55ICsgbWluaW11bUhlaWdodCk7CiAgICAgICAgICBjdi56ID0gdGhpcy5fY2FtZXJhUG9zaXRpb24ueiAvIChlbGxpcHNvaWQucmFkaWkueiArIG1pbmltdW1IZWlnaHQpOwogICAgICAgICAgdmhNYWduaXR1ZGVTcXVhcmVkID0gY3YueCAqIGN2LnggKyBjdi55ICogY3YueSArIGN2LnogKiBjdi56IC0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3YgPSB0aGlzLl9jYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2U7CiAgICAgICAgICB2aE1hZ25pdHVkZVNxdWFyZWQgPSB0aGlzLl9kaXN0YW5jZVRvTGltYkluU2NhbGVkU3BhY2VTcXVhcmVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNTY2FsZWRTcGFjZVBvaW50VmlzaWJsZSgKICAgICAgICAgIG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbiwKICAgICAgICAgIGN2LAogICAgICAgICAgdmhNYWduaXR1ZGVTcXVhcmVkCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnQgPSBmdW5jdGlvbihkaXJlY3Rpb25Ub1BvaW50LCBwb3NpdGlvbnMsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21Qb3NpdGlvbnMoCiAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICBkaXJlY3Rpb25Ub1BvaW50LAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZFNocnVuayA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRQb3NzaWJseVVuZGVyRWxsaXBzb2lkID0gZnVuY3Rpb24oZGlyZWN0aW9uVG9Qb2ludCwgcG9zaXRpb25zLCBtaW5pbXVtSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBwb3NzaWJseVNocnVua0VsbGlwc29pZCA9IGdldFBvc3NpYmx5U2hydW5rRWxsaXBzb2lkKAogICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLAogICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmsKICAgICAgICApOwogICAgICAgIHJldHVybiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21Qb3NpdGlvbnMoCiAgICAgICAgICBwb3NzaWJseVNocnVua0VsbGlwc29pZCwKICAgICAgICAgIGRpcmVjdGlvblRvUG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21WZXJ0aWNlcyA9IGZ1bmN0aW9uKGRpcmVjdGlvblRvUG9pbnQsIHZlcnRpY2VzLCBzdHJpZGUsIGNlbnRlciwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVZlcnRpY2VzKAogICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLAogICAgICAgICAgZGlyZWN0aW9uVG9Qb2ludCwKICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgc3RyaWRlLAogICAgICAgICAgY2VudGVyLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRGcm9tVmVydGljZXNQb3NzaWJseVVuZGVyRWxsaXBzb2lkID0gZnVuY3Rpb24oZGlyZWN0aW9uVG9Qb2ludCwgdmVydGljZXMsIHN0cmlkZSwgY2VudGVyLCBtaW5pbXVtSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBwb3NzaWJseVNocnVua0VsbGlwc29pZCA9IGdldFBvc3NpYmx5U2hydW5rRWxsaXBzb2lkKAogICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLAogICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmsKICAgICAgICApOwogICAgICAgIHJldHVybiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21WZXJ0aWNlcygKICAgICAgICAgIHBvc3NpYmx5U2hydW5rRWxsaXBzb2lkLAogICAgICAgICAgZGlyZWN0aW9uVG9Qb2ludCwKICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgc3RyaWRlLAogICAgICAgICAgY2VudGVyLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgc3Vic2FtcGxlU2NyYXRjaCA9IFtdOwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21SZWN0YW5nbGUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IFJlY3RhbmdsZV9kZWZhdWx0LnN1YnNhbXBsZSgKICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIDAsCiAgICAgICAgICBzdWJzYW1wbGVTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBicyA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMpOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGJzLmNlbnRlcikgPCAwLjEgKiBlbGxpcHNvaWQubWluaW11bVJhZGl1cykgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnQoYnMuY2VudGVyLCBwb3NpdGlvbnMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmtSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcG9zaXRpb25TY3JhdGNoNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVkU3BhY2VTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBkaXJlY3Rpb25TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBkaXJlY3Rpb25Ub1BvaW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlcl9kZWZhdWx0ID0gRWxsaXBzb2lkYWxPY2NsdWRlcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1ZlcnRpY2FsRXhhZ2dlcmF0aW9uLmpzCiAgdmFyIFZlcnRpY2FsRXhhZ2dlcmF0aW9uLCBzY3JhdGNoQ2FydG9ncmFwaGljNiwgVmVydGljYWxFeGFnZ2VyYXRpb25fZGVmYXVsdDsKICB2YXIgaW5pdF9WZXJ0aWNhbEV4YWdnZXJhdGlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVmVydGljYWxFeGFnZ2VyYXRpb24uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgVmVydGljYWxFeGFnZ2VyYXRpb24gPSB7fTsKICAgICAgVmVydGljYWxFeGFnZ2VyYXRpb24uZ2V0SGVpZ2h0ID0gZnVuY3Rpb24oaGVpZ2h0LCBzY2FsZSwgcmVsYXRpdmVIZWlnaHQpIHsKICAgICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShzY2FsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzY2FsZSBtdXN0IGJlIGEgZmluaXRlIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUocmVsYXRpdmVIZWlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVsYXRpdmVIZWlnaHQgbXVzdCBiZSBhIGZpbml0ZSBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiAoaGVpZ2h0IC0gcmVsYXRpdmVIZWlnaHQpICogc2NhbGUgKyByZWxhdGl2ZUhlaWdodDsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzYgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgVmVydGljYWxFeGFnZ2VyYXRpb24uZ2V0UG9zaXRpb24gPSBmdW5jdGlvbihwb3NpdGlvbiwgZWxsaXBzb2lkLCB2ZXJ0aWNhbEV4YWdnZXJhdGlvbiwgdmVydGljYWxFeGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzYKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRvZ3JhcGhpYzIpKSB7CiAgICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdIZWlnaHQgPSBWZXJ0aWNhbEV4YWdnZXJhdGlvbi5nZXRIZWlnaHQoCiAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmhlaWdodCwKICAgICAgICAgIHZlcnRpY2FsRXhhZ2dlcmF0aW9uLAogICAgICAgICAgdmVydGljYWxFeGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlLAogICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgIG5ld0hlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIFZlcnRpY2FsRXhhZ2dlcmF0aW9uX2RlZmF1bHQgPSBWZXJ0aWNhbEV4YWdnZXJhdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RlcnJhaW5RdWFudGl6YXRpb24uanMKICB2YXIgVGVycmFpblF1YW50aXphdGlvbiwgVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X1RlcnJhaW5RdWFudGl6YXRpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RlcnJhaW5RdWFudGl6YXRpb24uanMiKCkgewogICAgICBUZXJyYWluUXVhbnRpemF0aW9uID0gewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSB2ZXJ0aWNlcyBhcmUgbm90IGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE5PTkU6IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHZlcnRpY2VzIGFyZSBjb21wcmVzc2VkIHRvIDEyIGJpdHMuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEJJVFMxMjogMQogICAgICB9OwogICAgICBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFRlcnJhaW5RdWFudGl6YXRpb24pOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpbkVuY29kaW5nLmpzCiAgZnVuY3Rpb24gVGVycmFpbkVuY29kaW5nKGNlbnRlciwgYXhpc0FsaWduZWRCb3VuZGluZ0JveCwgbWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgZnJvbUVOVSwgaGFzVmVydGV4Tm9ybWFscywgaGFzV2ViTWVyY2F0b3JULCBoYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLCBleGFnZ2VyYXRpb24sIGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0KSB7CiAgICBsZXQgcXVhbnRpemF0aW9uID0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0Lk5PTkU7CiAgICBsZXQgdG9FTlU7CiAgICBsZXQgbWF0cml4OwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChheGlzQWxpZ25lZEJvdW5kaW5nQm94KSAmJiBkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodCkgJiYgZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHQpICYmIGRlZmluZWRfZGVmYXVsdChmcm9tRU5VKSkgewogICAgICBjb25zdCBtaW5pbXVtID0gYXhpc0FsaWduZWRCb3VuZGluZ0JveC5taW5pbXVtOwogICAgICBjb25zdCBtYXhpbXVtID0gYXhpc0FsaWduZWRCb3VuZGluZ0JveC5tYXhpbXVtOwogICAgICBjb25zdCBkaW1lbnNpb25zID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIG1heGltdW0sCiAgICAgICAgbWluaW11bSwKICAgICAgICBjYXJ0ZXNpYW4zRGltU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBoRGltID0gbWF4aW11bUhlaWdodCAtIG1pbmltdW1IZWlnaHQ7CiAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KENhcnRlc2lhbjNfZGVmYXVsdC5tYXhpbXVtQ29tcG9uZW50KGRpbWVuc2lvbnMpLCBoRGltKTsKICAgICAgaWYgKG1heERpbSA8IFNISUZUX0xFRlRfMTIgLSAxKSB7CiAgICAgICAgcXVhbnRpemF0aW9uID0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMjsKICAgICAgfSBlbHNlIHsKICAgICAgICBxdWFudGl6YXRpb24gPSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuTk9ORTsKICAgICAgfQogICAgICB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgICAgY29uc3QgdHJhbnNsYXRpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShtaW5pbXVtLCBjYXJ0ZXNpYW4zU2NyYXRjaCk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSgKICAgICAgICBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uKHRyYW5zbGF0aW9uMiwgbWF0cml4NFNjcmF0Y2gpLAogICAgICAgIHRvRU5VLAogICAgICAgIHRvRU5VCiAgICAgICk7CiAgICAgIGNvbnN0IHNjYWxlID0gY2FydGVzaWFuM1NjcmF0Y2g7CiAgICAgIHNjYWxlLnggPSAxIC8gZGltZW5zaW9ucy54OwogICAgICBzY2FsZS55ID0gMSAvIGRpbWVuc2lvbnMueTsKICAgICAgc2NhbGUueiA9IDEgLyBkaW1lbnNpb25zLno7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShNYXRyaXg0X2RlZmF1bHQuZnJvbVNjYWxlKHNjYWxlLCBtYXRyaXg0U2NyYXRjaCksIHRvRU5VLCB0b0VOVSk7CiAgICAgIG1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jbG9uZShmcm9tRU5VKTsKICAgICAgTWF0cml4NF9kZWZhdWx0LnNldFRyYW5zbGF0aW9uKG1hdHJpeCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIG1hdHJpeCk7CiAgICAgIGZyb21FTlUgPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgICAgY29uc3QgdHJhbnNsYXRpb25NYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uKG1pbmltdW0sIG1hdHJpeDRTY3JhdGNoKTsKICAgICAgY29uc3Qgc2NhbGVNYXRyaXgyID0gTWF0cml4NF9kZWZhdWx0LmZyb21TY2FsZShkaW1lbnNpb25zLCBtYXRyaXg0U2NyYXRjaDIpOwogICAgICBjb25zdCBzdCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSh0cmFuc2xhdGlvbk1hdHJpeCwgc2NhbGVNYXRyaXgyLCBtYXRyaXg0U2NyYXRjaCk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShmcm9tRU5VLCBzdCwgZnJvbUVOVSk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShtYXRyaXgsIHN0LCBtYXRyaXgpOwogICAgfQogICAgdGhpcy5xdWFudGl6YXRpb24gPSBxdWFudGl6YXRpb247CiAgICB0aGlzLm1pbmltdW1IZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgdGhpcy5tYXhpbXVtSGVpZ2h0ID0gbWF4aW11bUhlaWdodDsKICAgIHRoaXMuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB0aGlzLnRvU2NhbGVkRU5VID0gdG9FTlU7CiAgICB0aGlzLmZyb21TY2FsZWRFTlUgPSBmcm9tRU5VOwogICAgdGhpcy5tYXRyaXggPSBtYXRyaXg7CiAgICB0aGlzLmhhc1ZlcnRleE5vcm1hbHMgPSBoYXNWZXJ0ZXhOb3JtYWxzOwogICAgdGhpcy5oYXNXZWJNZXJjYXRvclQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoYXNXZWJNZXJjYXRvclQsIGZhbHNlKTsKICAgIHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBoYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBmYWxzZQogICAgKTsKICAgIHRoaXMuZXhhZ2dlcmF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZXhhZ2dlcmF0aW9uLCAxKTsKICAgIHRoaXMuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQsCiAgICAgIDAKICAgICk7CiAgICB0aGlzLnN0cmlkZSA9IDA7CiAgICB0aGlzLl9vZmZzZXRHZW9kZXRpY1N1cmZhY2VOb3JtYWwgPSAwOwogICAgdGhpcy5fb2Zmc2V0VmVydGV4Tm9ybWFsID0gMDsKICAgIHRoaXMuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMoKTsKICB9CiAgdmFyIGNhcnRlc2lhbjNTY3JhdGNoLCBjYXJ0ZXNpYW4zRGltU2NyYXRjaCwgY2FydGVzaWFuMlNjcmF0Y2gsIG1hdHJpeDRTY3JhdGNoLCBtYXRyaXg0U2NyYXRjaDIsIFNISUZUX0xFRlRfMTIsIHNjcmF0Y2hQb3NpdGlvbjYsIHNjcmF0Y2hHZW9kZXRpY1N1cmZhY2VOb3JtYWwsIGF0dHJpYnV0ZXNJbmRpY2VzTm9uZSwgYXR0cmlidXRlc0luZGljZXNCaXRzMTIsIFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0OwogIHZhciBpbml0X1RlcnJhaW5FbmNvZGluZyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpbkVuY29kaW5nLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9WZXJ0aWNhbEV4YWdnZXJhdGlvbigpOwogICAgICBpbml0X1RlcnJhaW5RdWFudGl6YXRpb24oKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNEaW1TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4yU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgbWF0cml4NFNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIG1hdHJpeDRTY3JhdGNoMiA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgU0hJRlRfTEVGVF8xMiA9IE1hdGgucG93KDIsIDEyKTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5lbmNvZGUgPSBmdW5jdGlvbih2ZXJ0ZXhCdWZmZXIsIGJ1ZmZlckluZGV4LCBwb3NpdGlvbiwgdXYsIGhlaWdodCwgbm9ybWFsVG9QYWNrLCB3ZWJNZXJjYXRvclQsIGdlb2RldGljU3VyZmFjZU5vcm1hbCkgewogICAgICAgIGNvbnN0IHUzID0gdXYueDsKICAgICAgICBjb25zdCB2MyA9IHV2Lnk7CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuQklUUzEyKSB7CiAgICAgICAgICBwb3NpdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICAgIHRoaXMudG9TY2FsZWRFTlUsCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHBvc2l0aW9uLnggPSBNYXRoX2RlZmF1bHQuY2xhbXAocG9zaXRpb24ueCwgMCwgMSk7CiAgICAgICAgICBwb3NpdGlvbi55ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHBvc2l0aW9uLnksIDAsIDEpOwogICAgICAgICAgcG9zaXRpb24ueiA9IE1hdGhfZGVmYXVsdC5jbGFtcChwb3NpdGlvbi56LCAwLCAxKTsKICAgICAgICAgIGNvbnN0IGhEaW0gPSB0aGlzLm1heGltdW1IZWlnaHQgLSB0aGlzLm1pbmltdW1IZWlnaHQ7CiAgICAgICAgICBjb25zdCBoID0gTWF0aF9kZWZhdWx0LmNsYW1wKChoZWlnaHQgLSB0aGlzLm1pbmltdW1IZWlnaHQpIC8gaERpbSwgMCwgMSk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIGNhcnRlc2lhbjJTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWQwID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcyhjYXJ0ZXNpYW4yU2NyYXRjaCk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHBvc2l0aW9uLnosIGgsIGNhcnRlc2lhbjJTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWQxID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcyhjYXJ0ZXNpYW4yU2NyYXRjaCk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHUzLCB2MywgY2FydGVzaWFuMlNjcmF0Y2gpOwogICAgICAgICAgY29uc3QgY29tcHJlc3NlZDIgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmNvbXByZXNzVGV4dHVyZUNvb3JkaW5hdGVzKGNhcnRlc2lhbjJTY3JhdGNoKTsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGNvbXByZXNzZWQwOwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY29tcHJlc3NlZDE7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjb21wcmVzc2VkMjsKICAgICAgICAgIGlmICh0aGlzLmhhc1dlYk1lcmNhdG9yVCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHdlYk1lcmNhdG9yVCwgMCwgY2FydGVzaWFuMlNjcmF0Y2gpOwogICAgICAgICAgICBjb25zdCBjb21wcmVzc2VkMyA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoY2FydGVzaWFuMlNjcmF0Y2gpOwogICAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjb21wcmVzc2VkMzsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvc2l0aW9uLCB0aGlzLmNlbnRlciwgY2FydGVzaWFuM1NjcmF0Y2gpOwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY2FydGVzaWFuM1NjcmF0Y2gueDsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGNhcnRlc2lhbjNTY3JhdGNoLnk7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjYXJ0ZXNpYW4zU2NyYXRjaC56OwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gaGVpZ2h0OwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gdTM7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSB2MzsKICAgICAgICAgIGlmICh0aGlzLmhhc1dlYk1lcmNhdG9yVCkgewogICAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSB3ZWJNZXJjYXRvclQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0UGFja0Zsb2F0KG5vcm1hbFRvUGFjayk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGdlb2RldGljU3VyZmFjZU5vcm1hbC54OwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gZ2VvZGV0aWNTdXJmYWNlTm9ybWFsLnk7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwuejsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1ZmZlckluZGV4OwogICAgICB9OwogICAgICBzY3JhdGNoUG9zaXRpb242ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoR2VvZGV0aWNTdXJmYWNlTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLmFkZEdlb2RldGljU3VyZmFjZU5vcm1hbHMgPSBmdW5jdGlvbihvbGRCdWZmZXIsIG5ld0J1ZmZlciwgZWxsaXBzb2lkKSB7CiAgICAgICAgaWYgKHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBvbGRTdHJpZGUgPSB0aGlzLnN0cmlkZTsKICAgICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IG9sZEJ1ZmZlci5sZW5ndGggLyBvbGRTdHJpZGU7CiAgICAgICAgdGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gdHJ1ZTsKICAgICAgICB0aGlzLl9jYWxjdWxhdGVTdHJpZGVBbmRPZmZzZXRzKCk7CiAgICAgICAgY29uc3QgbmV3U3RyaWRlID0gdGhpcy5zdHJpZGU7CiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHZlcnRleENvdW50OyBpbmRleCsrKSB7CiAgICAgICAgICBmb3IgKGxldCBvZmZzZXQgPSAwOyBvZmZzZXQgPCBvbGRTdHJpZGU7IG9mZnNldCsrKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZEluZGV4ID0gaW5kZXggKiBvbGRTdHJpZGUgKyBvZmZzZXQ7CiAgICAgICAgICAgIGNvbnN0IG5ld0luZGV4ID0gaW5kZXggKiBuZXdTdHJpZGUgKyBvZmZzZXQ7CiAgICAgICAgICAgIG5ld0J1ZmZlcltuZXdJbmRleF0gPSBvbGRCdWZmZXJbb2xkSW5kZXhdOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSB0aGlzLmRlY29kZVBvc2l0aW9uKG5ld0J1ZmZlciwgaW5kZXgsIHNjcmF0Y2hQb3NpdGlvbjYpOwogICAgICAgICAgY29uc3QgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgIHNjcmF0Y2hHZW9kZXRpY1N1cmZhY2VOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBidWZmZXJJbmRleCA9IGluZGV4ICogbmV3U3RyaWRlICsgdGhpcy5fb2Zmc2V0R2VvZGV0aWNTdXJmYWNlTm9ybWFsOwogICAgICAgICAgbmV3QnVmZmVyW2J1ZmZlckluZGV4XSA9IGdlb2RldGljU3VyZmFjZU5vcm1hbC54OwogICAgICAgICAgbmV3QnVmZmVyW2J1ZmZlckluZGV4ICsgMV0gPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueTsKICAgICAgICAgIG5ld0J1ZmZlcltidWZmZXJJbmRleCArIDJdID0gZ2VvZGV0aWNTdXJmYWNlTm9ybWFsLno7CiAgICAgICAgfQogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLnJlbW92ZUdlb2RldGljU3VyZmFjZU5vcm1hbHMgPSBmdW5jdGlvbihvbGRCdWZmZXIsIG5ld0J1ZmZlcikgewogICAgICAgIGlmICghdGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9sZFN0cmlkZSA9IHRoaXMuc3RyaWRlOwogICAgICAgIGNvbnN0IHZlcnRleENvdW50ID0gb2xkQnVmZmVyLmxlbmd0aCAvIG9sZFN0cmlkZTsKICAgICAgICB0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMgPSBmYWxzZTsKICAgICAgICB0aGlzLl9jYWxjdWxhdGVTdHJpZGVBbmRPZmZzZXRzKCk7CiAgICAgICAgY29uc3QgbmV3U3RyaWRlID0gdGhpcy5zdHJpZGU7CiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHZlcnRleENvdW50OyBpbmRleCsrKSB7CiAgICAgICAgICBmb3IgKGxldCBvZmZzZXQgPSAwOyBvZmZzZXQgPCBuZXdTdHJpZGU7IG9mZnNldCsrKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZEluZGV4ID0gaW5kZXggKiBvbGRTdHJpZGUgKyBvZmZzZXQ7CiAgICAgICAgICAgIGNvbnN0IG5ld0luZGV4ID0gaW5kZXggKiBuZXdTdHJpZGUgKyBvZmZzZXQ7CiAgICAgICAgICAgIG5ld0J1ZmZlcltuZXdJbmRleF0gPSBvbGRCdWZmZXJbb2xkSW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5kZWNvZGVQb3NpdGlvbiA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgaW5kZXggKj0gdGhpcy5zdHJpZGU7CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuQklUUzEyKSB7CiAgICAgICAgICBjb25zdCB4eSA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuZGVjb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgYnVmZmVyW2luZGV4XSwKICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICByZXN1bHQueCA9IHh5Lng7CiAgICAgICAgICByZXN1bHQueSA9IHh5Lnk7CiAgICAgICAgICBjb25zdCB6aCA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuZGVjb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgYnVmZmVyW2luZGV4ICsgMV0sCiAgICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgcmVzdWx0LnogPSB6aC54OwogICAgICAgICAgcmV0dXJuIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQodGhpcy5mcm9tU2NhbGVkRU5VLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gYnVmZmVyW2luZGV4XTsKICAgICAgICByZXN1bHQueSA9IGJ1ZmZlcltpbmRleCArIDFdOwogICAgICAgIHJlc3VsdC56ID0gYnVmZmVyW2luZGV4ICsgMl07CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0LCB0aGlzLmNlbnRlciwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5nZXRFeGFnZ2VyYXRlZFBvc2l0aW9uID0gZnVuY3Rpb24oYnVmZmVyLCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgcmVzdWx0ID0gdGhpcy5kZWNvZGVQb3NpdGlvbihidWZmZXIsIGluZGV4LCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4YWdnZXJhdGlvbiA9IHRoaXMuZXhhZ2dlcmF0aW9uOwogICAgICAgIGNvbnN0IGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0ID0gdGhpcy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodDsKICAgICAgICBjb25zdCBoYXNFeGFnZ2VyYXRpb24gPSBleGFnZ2VyYXRpb24gIT09IDE7CiAgICAgICAgaWYgKGhhc0V4YWdnZXJhdGlvbiAmJiB0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbCA9IHRoaXMuZGVjb2RlR2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgICAgICBidWZmZXIsCiAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICBzY3JhdGNoR2VvZGV0aWNTdXJmYWNlTm9ybWFsCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcmF3SGVpZ2h0ID0gdGhpcy5kZWNvZGVIZWlnaHQoYnVmZmVyLCBpbmRleCk7CiAgICAgICAgICBjb25zdCBoZWlnaHREaWZmZXJlbmNlID0gVmVydGljYWxFeGFnZ2VyYXRpb25fZGVmYXVsdC5nZXRIZWlnaHQoCiAgICAgICAgICAgIHJhd0hlaWdodCwKICAgICAgICAgICAgZXhhZ2dlcmF0aW9uLAogICAgICAgICAgICBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgICAgICAgKSAtIHJhd0hlaWdodDsKICAgICAgICAgIHJlc3VsdC54ICs9IGdlb2RldGljU3VyZmFjZU5vcm1hbC54ICogaGVpZ2h0RGlmZmVyZW5jZTsKICAgICAgICAgIHJlc3VsdC55ICs9IGdlb2RldGljU3VyZmFjZU5vcm1hbC55ICogaGVpZ2h0RGlmZmVyZW5jZTsKICAgICAgICAgIHJlc3VsdC56ICs9IGdlb2RldGljU3VyZmFjZU5vcm1hbC56ICogaGVpZ2h0RGlmZmVyZW5jZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5kZWNvZGVUZXh0dXJlQ29vcmRpbmF0ZXMgPSBmdW5jdGlvbihidWZmZXIsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGluZGV4ICo9IHRoaXMuc3RyaWRlOwogICAgICAgIGlmICh0aGlzLnF1YW50aXphdGlvbiA9PT0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMikgewogICAgICAgICAgcmV0dXJuIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuZGVjb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgYnVmZmVyW2luZGV4ICsgMl0sCiAgICAgICAgICAgIHJlc3VsdAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoYnVmZmVyW2luZGV4ICsgNF0sIGJ1ZmZlcltpbmRleCArIDVdLCByZXN1bHQpOwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLmRlY29kZUhlaWdodCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgpIHsKICAgICAgICBpbmRleCAqPSB0aGlzLnN0cmlkZTsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTIpIHsKICAgICAgICAgIGNvbnN0IHpoID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5kZWNvbXByZXNzVGV4dHVyZUNvb3JkaW5hdGVzKAogICAgICAgICAgICBidWZmZXJbaW5kZXggKyAxXSwKICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm4gemgueSAqICh0aGlzLm1heGltdW1IZWlnaHQgLSB0aGlzLm1pbmltdW1IZWlnaHQpICsgdGhpcy5taW5pbXVtSGVpZ2h0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmZmVyW2luZGV4ICsgM107CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZGVjb2RlV2ViTWVyY2F0b3JUID0gZnVuY3Rpb24oYnVmZmVyLCBpbmRleCkgewogICAgICAgIGluZGV4ICo9IHRoaXMuc3RyaWRlOwogICAgICAgIGlmICh0aGlzLnF1YW50aXphdGlvbiA9PT0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMikgewogICAgICAgICAgcmV0dXJuIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuZGVjb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgYnVmZmVyW2luZGV4ICsgM10sCiAgICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoCiAgICAgICAgICApLng7CiAgICAgICAgfQogICAgICAgIHJldHVybiBidWZmZXJbaW5kZXggKyA2XTsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5nZXRPY3RFbmNvZGVkTm9ybWFsID0gZnVuY3Rpb24oYnVmZmVyLCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaW5kZXggPSBpbmRleCAqIHRoaXMuc3RyaWRlICsgdGhpcy5fb2Zmc2V0VmVydGV4Tm9ybWFsOwogICAgICAgIGNvbnN0IHRlbXAgPSBidWZmZXJbaW5kZXhdIC8gMjU2OwogICAgICAgIGNvbnN0IHggPSBNYXRoLmZsb29yKHRlbXApOwogICAgICAgIGNvbnN0IHkgPSAodGVtcCAtIHgpICogMjU2OwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHgsIHksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZGVjb2RlR2VvZGV0aWNTdXJmYWNlTm9ybWFsID0gZnVuY3Rpb24oYnVmZmVyLCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaW5kZXggPSBpbmRleCAqIHRoaXMuc3RyaWRlICsgdGhpcy5fb2Zmc2V0R2VvZGV0aWNTdXJmYWNlTm9ybWFsOwogICAgICAgIHJlc3VsdC54ID0gYnVmZmVyW2luZGV4XTsKICAgICAgICByZXN1bHQueSA9IGJ1ZmZlcltpbmRleCArIDFdOwogICAgICAgIHJlc3VsdC56ID0gYnVmZmVyW2luZGV4ICsgMl07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5fY2FsY3VsYXRlU3RyaWRlQW5kT2Zmc2V0cyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGxldCB2ZXJ0ZXhTdHJpZGUgPSAwOwogICAgICAgIHN3aXRjaCAodGhpcy5xdWFudGl6YXRpb24pIHsKICAgICAgICAgIGNhc2UgVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMjoKICAgICAgICAgICAgdmVydGV4U3RyaWRlICs9IDM7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdmVydGV4U3RyaWRlICs9IDY7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmhhc1dlYk1lcmNhdG9yVCkgewogICAgICAgICAgdmVydGV4U3RyaWRlICs9IDE7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICAgIHRoaXMuX29mZnNldFZlcnRleE5vcm1hbCA9IHZlcnRleFN0cmlkZTsKICAgICAgICAgIHZlcnRleFN0cmlkZSArPSAxOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICB0aGlzLl9vZmZzZXRHZW9kZXRpY1N1cmZhY2VOb3JtYWwgPSB2ZXJ0ZXhTdHJpZGU7CiAgICAgICAgICB2ZXJ0ZXhTdHJpZGUgKz0gMzsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdHJpZGUgPSB2ZXJ0ZXhTdHJpZGU7CiAgICAgIH07CiAgICAgIGF0dHJpYnV0ZXNJbmRpY2VzTm9uZSA9IHsKICAgICAgICBwb3NpdGlvbjNEQW5kSGVpZ2h0OiAwLAogICAgICAgIHRleHR1cmVDb29yZEFuZEVuY29kZWROb3JtYWxzOiAxLAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbDogMgogICAgICB9OwogICAgICBhdHRyaWJ1dGVzSW5kaWNlc0JpdHMxMiA9IHsKICAgICAgICBjb21wcmVzc2VkMDogMCwKICAgICAgICBjb21wcmVzc2VkMTogMSwKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWw6IDIKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24oYnVmZmVyKSB7CiAgICAgICAgY29uc3QgZGF0YXR5cGUgPSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FUOwogICAgICAgIGNvbnN0IHNpemVJbkJ5dGVzID0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5nZXRTaXplSW5CeXRlcyhkYXRhdHlwZSk7CiAgICAgICAgY29uc3Qgc3RyaWRlSW5CeXRlcyA9IHRoaXMuc3RyaWRlICogc2l6ZUluQnl0ZXM7CiAgICAgICAgbGV0IG9mZnNldEluQnl0ZXMgPSAwOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICBmdW5jdGlvbiBhZGRBdHRyaWJ1dGUoaW5kZXgsIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMucHVzaCh7CiAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICB2ZXJ0ZXhCdWZmZXI6IGJ1ZmZlciwKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IGRhdGF0eXBlLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlLAogICAgICAgICAgICBvZmZzZXRJbkJ5dGVzLAogICAgICAgICAgICBzdHJpZGVJbkJ5dGVzCiAgICAgICAgICB9KTsKICAgICAgICAgIG9mZnNldEluQnl0ZXMgKz0gY29tcG9uZW50c1BlckF0dHJpYnV0ZSAqIHNpemVJbkJ5dGVzOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5OT05FKSB7CiAgICAgICAgICBhZGRBdHRyaWJ1dGUoYXR0cmlidXRlc0luZGljZXNOb25lLnBvc2l0aW9uM0RBbmRIZWlnaHQsIDQpOwogICAgICAgICAgbGV0IGNvbXBvbmVudHNUZXhDb29yZEFuZE5vcm1hbHMgPSAyOwogICAgICAgICAgY29tcG9uZW50c1RleENvb3JkQW5kTm9ybWFscyArPSB0aGlzLmhhc1dlYk1lcmNhdG9yVCA/IDEgOiAwOwogICAgICAgICAgY29tcG9uZW50c1RleENvb3JkQW5kTm9ybWFscyArPSB0aGlzLmhhc1ZlcnRleE5vcm1hbHMgPyAxIDogMDsKICAgICAgICAgIGFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgYXR0cmlidXRlc0luZGljZXNOb25lLnRleHR1cmVDb29yZEFuZEVuY29kZWROb3JtYWxzLAogICAgICAgICAgICBjb21wb25lbnRzVGV4Q29vcmRBbmROb3JtYWxzCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgICBhZGRBdHRyaWJ1dGUoYXR0cmlidXRlc0luZGljZXNOb25lLmdlb2RldGljU3VyZmFjZU5vcm1hbCwgMyk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHVzaW5nQXR0cmlidXRlMENvbXBvbmVudDQgPSB0aGlzLmhhc1dlYk1lcmNhdG9yVCB8fCB0aGlzLmhhc1ZlcnRleE5vcm1hbHM7CiAgICAgICAgICBjb25zdCB1c2luZ0F0dHJpYnV0ZTFDb21wb25lbnQxID0gdGhpcy5oYXNXZWJNZXJjYXRvclQgJiYgdGhpcy5oYXNWZXJ0ZXhOb3JtYWxzOwogICAgICAgICAgYWRkQXR0cmlidXRlKAogICAgICAgICAgICBhdHRyaWJ1dGVzSW5kaWNlc0JpdHMxMi5jb21wcmVzc2VkMCwKICAgICAgICAgICAgdXNpbmdBdHRyaWJ1dGUwQ29tcG9uZW50NCA/IDQgOiAzCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHVzaW5nQXR0cmlidXRlMUNvbXBvbmVudDEpIHsKICAgICAgICAgICAgYWRkQXR0cmlidXRlKGF0dHJpYnV0ZXNJbmRpY2VzQml0czEyLmNvbXByZXNzZWQxLCAxKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgICAgYWRkQXR0cmlidXRlKGF0dHJpYnV0ZXNJbmRpY2VzQml0czEyLmdlb2RldGljU3VyZmFjZU5vcm1hbCwgMyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVzOwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLmdldEF0dHJpYnV0ZUxvY2F0aW9ucyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnF1YW50aXphdGlvbiA9PT0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0Lk5PTkUpIHsKICAgICAgICAgIHJldHVybiBhdHRyaWJ1dGVzSW5kaWNlc05vbmU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVzSW5kaWNlc0JpdHMxMjsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLmNsb25lID0gZnVuY3Rpb24oZW5jb2RpbmcsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVuY29kaW5nKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFRlcnJhaW5FbmNvZGluZygpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucXVhbnRpemF0aW9uID0gZW5jb2RpbmcucXVhbnRpemF0aW9uOwogICAgICAgIHJlc3VsdC5taW5pbXVtSGVpZ2h0ID0gZW5jb2RpbmcubWluaW11bUhlaWdodDsKICAgICAgICByZXN1bHQubWF4aW11bUhlaWdodCA9IGVuY29kaW5nLm1heGltdW1IZWlnaHQ7CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbmNvZGluZy5jZW50ZXIpOwogICAgICAgIHJlc3VsdC50b1NjYWxlZEVOVSA9IE1hdHJpeDRfZGVmYXVsdC5jbG9uZShlbmNvZGluZy50b1NjYWxlZEVOVSk7CiAgICAgICAgcmVzdWx0LmZyb21TY2FsZWRFTlUgPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcuZnJvbVNjYWxlZEVOVSk7CiAgICAgICAgcmVzdWx0Lm1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jbG9uZShlbmNvZGluZy5tYXRyaXgpOwogICAgICAgIHJlc3VsdC5oYXNWZXJ0ZXhOb3JtYWxzID0gZW5jb2RpbmcuaGFzVmVydGV4Tm9ybWFsczsKICAgICAgICByZXN1bHQuaGFzV2ViTWVyY2F0b3JUID0gZW5jb2RpbmcuaGFzV2ViTWVyY2F0b3JUOwogICAgICAgIHJlc3VsdC5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZW5jb2RpbmcuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFsczsKICAgICAgICByZXN1bHQuZXhhZ2dlcmF0aW9uID0gZW5jb2RpbmcuZXhhZ2dlcmF0aW9uOwogICAgICAgIHJlc3VsdC5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCA9IGVuY29kaW5nLmV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fY2FsY3VsYXRlU3RyaWRlQW5kT2Zmc2V0cygpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0ID0gVGVycmFpbkVuY29kaW5nOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyLmpzCiAgdmFyIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gaW5kZXhPZkVwc2lsb24oYXJyLCBlbGVtLCBlbGVtVHlwZSkgewogICAgZWxlbVR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGVtVHlwZSwgTWF0aF9kZWZhdWx0KTsKICAgIGNvbnN0IGNvdW50ID0gYXJyLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7ICsraSkgewogICAgICBpZiAoZWxlbVR5cGUuZXF1YWxzRXBzaWxvbihhcnJbaV0sIGVsZW0sIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIpKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIHBhcmFtZXRlcnMuZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5lbGxpcHNvaWQpOwogICAgcGFyYW1ldGVycy5yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShwYXJhbWV0ZXJzLnJlY3RhbmdsZSk7CiAgICBjb25zdCBzdGF0aXN0aWNzMiA9IHByb2Nlc3NCdWZmZXIoCiAgICAgIHBhcmFtZXRlcnMuYnVmZmVyLAogICAgICBwYXJhbWV0ZXJzLnJlbGF0aXZlVG9DZW50ZXIsCiAgICAgIHBhcmFtZXRlcnMuZWxsaXBzb2lkLAogICAgICBwYXJhbWV0ZXJzLnJlY3RhbmdsZSwKICAgICAgcGFyYW1ldGVycy5uYXRpdmVSZWN0YW5nbGUsCiAgICAgIHBhcmFtZXRlcnMuZXhhZ2dlcmF0aW9uLAogICAgICBwYXJhbWV0ZXJzLmV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0LAogICAgICBwYXJhbWV0ZXJzLnNraXJ0SGVpZ2h0LAogICAgICBwYXJhbWV0ZXJzLmluY2x1ZGVXZWJNZXJjYXRvclQsCiAgICAgIHBhcmFtZXRlcnMubmVnYXRpdmVBbHRpdHVkZUV4cG9uZW50QmlhcywKICAgICAgcGFyYW1ldGVycy5uZWdhdGl2ZUVsZXZhdGlvblRocmVzaG9sZAogICAgKTsKICAgIGNvbnN0IHZlcnRpY2VzID0gc3RhdGlzdGljczIudmVydGljZXM7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2godmVydGljZXMuYnVmZmVyKTsKICAgIGNvbnN0IGluZGljZXMgPSBzdGF0aXN0aWNzMi5pbmRpY2VzOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGluZGljZXMuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzOiB2ZXJ0aWNlcy5idWZmZXIsCiAgICAgIGluZGljZXM6IGluZGljZXMuYnVmZmVyLAogICAgICBudW1iZXJPZkF0dHJpYnV0ZXM6IHN0YXRpc3RpY3MyLmVuY29kaW5nLnN0cmlkZSwKICAgICAgbWluaW11bUhlaWdodDogc3RhdGlzdGljczIubWluaW11bUhlaWdodCwKICAgICAgbWF4aW11bUhlaWdodDogc3RhdGlzdGljczIubWF4aW11bUhlaWdodCwKICAgICAgYm91bmRpbmdTcGhlcmUzRDogc3RhdGlzdGljczIuYm91bmRpbmdTcGhlcmUzRCwKICAgICAgb3JpZW50ZWRCb3VuZGluZ0JveDogc3RhdGlzdGljczIub3JpZW50ZWRCb3VuZGluZ0JveCwKICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2U6IHN0YXRpc3RpY3MyLm9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlLAogICAgICBlbmNvZGluZzogc3RhdGlzdGljczIuZW5jb2RpbmcsCiAgICAgIHZlcnRleENvdW50V2l0aG91dFNraXJ0czogc3RhdGlzdGljczIudmVydGV4Q291bnRXaXRob3V0U2tpcnRzLAogICAgICBpbmRleENvdW50V2l0aG91dFNraXJ0czogc3RhdGlzdGljczIuaW5kZXhDb3VudFdpdGhvdXRTa2lydHMsCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoOiBzdGF0aXN0aWNzMi53ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdDogc3RhdGlzdGljczIuc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGg6IHN0YXRpc3RpY3MyLmVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0OiBzdGF0aXN0aWNzMi5ub3J0aEluZGljZXNXZXN0VG9FYXN0CiAgICB9OwogIH0KICBmdW5jdGlvbiBwcm9jZXNzQnVmZmVyKGJ1ZmZlciwgcmVsYXRpdmVUb0NlbnRlciwgZWxsaXBzb2lkLCByZWN0YW5nbGUsIG5hdGl2ZVJlY3RhbmdsZSwgZXhhZ2dlcmF0aW9uLCBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwgc2tpcnRIZWlnaHQsIGluY2x1ZGVXZWJNZXJjYXRvclQsIG5lZ2F0aXZlQWx0aXR1ZGVFeHBvbmVudEJpYXMsIG5lZ2F0aXZlRWxldmF0aW9uVGhyZXNob2xkKSB7CiAgICBsZXQgZ2VvZ3JhcGhpY1dlc3Q7CiAgICBsZXQgZ2VvZ3JhcGhpY1NvdXRoOwogICAgbGV0IGdlb2dyYXBoaWNFYXN0OwogICAgbGV0IGdlb2dyYXBoaWNOb3J0aDsKICAgIGxldCByZWN0YW5nbGVXaWR0aCwgcmVjdGFuZ2xlSGVpZ2h0OwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICBnZW9ncmFwaGljV2VzdCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobmF0aXZlUmVjdGFuZ2xlLndlc3QpOwogICAgICBnZW9ncmFwaGljU291dGggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5zb3V0aCk7CiAgICAgIGdlb2dyYXBoaWNFYXN0ID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhuYXRpdmVSZWN0YW5nbGUuZWFzdCk7CiAgICAgIGdlb2dyYXBoaWNOb3J0aCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobmF0aXZlUmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgcmVjdGFuZ2xlV2lkdGggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHJlY3RhbmdsZS53aWR0aCk7CiAgICAgIHJlY3RhbmdsZUhlaWdodCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMocmVjdGFuZ2xlLmhlaWdodCk7CiAgICB9IGVsc2UgewogICAgICBnZW9ncmFwaGljV2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICBnZW9ncmFwaGljU291dGggPSByZWN0YW5nbGUuc291dGg7CiAgICAgIGdlb2dyYXBoaWNFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgIGdlb2dyYXBoaWNOb3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgcmVjdGFuZ2xlV2lkdGggPSByZWN0YW5nbGUud2lkdGg7CiAgICAgIHJlY3RhbmdsZUhlaWdodCA9IHJlY3RhbmdsZS5oZWlnaHQ7CiAgICB9CiAgICBjb25zdCBxdWFkQm9yZGVyTGF0aXR1ZGVzID0gW2dlb2dyYXBoaWNTb3V0aCwgZ2VvZ3JhcGhpY05vcnRoXTsKICAgIGNvbnN0IHF1YWRCb3JkZXJMb25naXR1ZGVzID0gW2dlb2dyYXBoaWNXZXN0LCBnZW9ncmFwaGljRWFzdF07CiAgICBjb25zdCBmcm9tRU5VID0gVHJhbnNmb3Jtc19kZWZhdWx0LmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKAogICAgICByZWxhdGl2ZVRvQ2VudGVyLAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbWF0cml4NFNjcmF0Y2gzKTsKICAgIGxldCBzb3V0aE1lcmNhdG9yWTsKICAgIGxldCBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICBzb3V0aE1lcmNhdG9yWSA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoZ2VvZ3JhcGhpY1NvdXRoKTsKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0ID0gMSAvIChXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKGdlb2dyYXBoaWNOb3J0aCkgLSBzb3V0aE1lcmNhdG9yWSk7CiAgICB9CiAgICBjb25zdCBoYXNFeGFnZ2VyYXRpb24gPSBleGFnZ2VyYXRpb24gIT09IDE7CiAgICBjb25zdCBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGhhc0V4YWdnZXJhdGlvbjsKICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICBsZXQgbWluSGVpZ2h0ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IG1heEhlaWdodCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGNvbnN0IG1pbmltdW0gPSBtaW5pbXVtU2NyYXRjaDsKICAgIG1pbmltdW0ueCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGNvbnN0IG1heGltdW0gPSBtYXhpbXVtU2NyYXRjaDsKICAgIG1heGltdW0ueCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueiA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgbGV0IHNpemUgPSAwOwogICAgbGV0IGluZGljZXNTaXplID0gMDsKICAgIGxldCBxdWFkU2l6ZTsKICAgIGxldCBxdWFkOwogICAgZm9yIChxdWFkID0gMDsgcXVhZCA8IDQ7ICsrcXVhZCkgewogICAgICBsZXQgbyA9IG9mZnNldDsKICAgICAgcXVhZFNpemUgPSBkdi5nZXRVaW50MzIobywgdHJ1ZSk7CiAgICAgIG8gKz0gc2l6ZU9mVWludDMyOwogICAgICBjb25zdCB4ID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhkdi5nZXRGbG9hdDY0KG8sIHRydWUpICogMTgwKTsKICAgICAgbyArPSBzaXplT2ZEb3VibGU7CiAgICAgIGlmIChpbmRleE9mRXBzaWxvbihxdWFkQm9yZGVyTG9uZ2l0dWRlcywgeCkgPT09IC0xKSB7CiAgICAgICAgcXVhZEJvcmRlckxvbmdpdHVkZXMucHVzaCh4KTsKICAgICAgfQogICAgICBjb25zdCB5ID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhkdi5nZXRGbG9hdDY0KG8sIHRydWUpICogMTgwKTsKICAgICAgbyArPSBzaXplT2ZEb3VibGU7CiAgICAgIGlmIChpbmRleE9mRXBzaWxvbihxdWFkQm9yZGVyTGF0aXR1ZGVzLCB5KSA9PT0gLTEpIHsKICAgICAgICBxdWFkQm9yZGVyTGF0aXR1ZGVzLnB1c2goeSk7CiAgICAgIH0KICAgICAgbyArPSAyICogc2l6ZU9mRG91YmxlOwogICAgICBsZXQgYyA9IGR2LmdldEludDMyKG8sIHRydWUpOwogICAgICBvICs9IHNpemVPZkludDMyOwogICAgICBzaXplICs9IGM7CiAgICAgIGMgPSBkdi5nZXRJbnQzMihvLCB0cnVlKTsKICAgICAgaW5kaWNlc1NpemUgKz0gYyAqIDM7CiAgICAgIG9mZnNldCArPSBxdWFkU2l6ZSArIHNpemVPZlVpbnQzMjsKICAgIH0KICAgIGNvbnN0IHF1YWRCb3JkZXJQb2ludHMgPSBbXTsKICAgIGNvbnN0IHF1YWRCb3JkZXJJbmRpY2VzID0gW107CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkoc2l6ZSk7CiAgICBjb25zdCB1dnMgPSBuZXcgQXJyYXkoc2l6ZSk7CiAgICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KHNpemUpOwogICAgY29uc3Qgd2ViTWVyY2F0b3JUcyA9IGluY2x1ZGVXZWJNZXJjYXRvclQgPyBuZXcgQXJyYXkoc2l6ZSkgOiBbXTsKICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbHMgPSBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA/IG5ldyBBcnJheShzaXplKSA6IFtdOwogICAgY29uc3QgaW5kaWNlcyA9IG5ldyBBcnJheShpbmRpY2VzU2l6ZSk7CiAgICBjb25zdCB3ZXN0Qm9yZGVyID0gW107CiAgICBjb25zdCBzb3V0aEJvcmRlciA9IFtdOwogICAgY29uc3QgZWFzdEJvcmRlciA9IFtdOwogICAgY29uc3Qgbm9ydGhCb3JkZXIgPSBbXTsKICAgIGxldCBwb2ludE9mZnNldCA9IDA7CiAgICBsZXQgaW5kaWNlc09mZnNldCA9IDA7CiAgICBvZmZzZXQgPSAwOwogICAgZm9yIChxdWFkID0gMDsgcXVhZCA8IDQ7ICsrcXVhZCkgewogICAgICBxdWFkU2l6ZSA9IGR2LmdldFVpbnQzMihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyOwogICAgICBjb25zdCBzdGFydFF1YWQgPSBvZmZzZXQ7CiAgICAgIGNvbnN0IG9yaWdpblggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQob2Zmc2V0LCB0cnVlKSAqIDE4MCk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZEb3VibGU7CiAgICAgIGNvbnN0IG9yaWdpblkgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQob2Zmc2V0LCB0cnVlKSAqIDE4MCk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZEb3VibGU7CiAgICAgIGNvbnN0IHN0ZXBYID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhkdi5nZXRGbG9hdDY0KG9mZnNldCwgdHJ1ZSkgKiAxODApOwogICAgICBjb25zdCBoYWxmU3RlcFggPSBzdGVwWCAqIDAuNTsKICAgICAgb2Zmc2V0ICs9IHNpemVPZkRvdWJsZTsKICAgICAgY29uc3Qgc3RlcFkgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQob2Zmc2V0LCB0cnVlKSAqIDE4MCk7CiAgICAgIGNvbnN0IGhhbGZTdGVwWSA9IHN0ZXBZICogMC41OwogICAgICBvZmZzZXQgKz0gc2l6ZU9mRG91YmxlOwogICAgICBjb25zdCBudW1Qb2ludHMgPSBkdi5nZXRJbnQzMihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzI7CiAgICAgIGNvbnN0IG51bUZhY2VzID0gZHYuZ2V0SW50MzIob2Zmc2V0LCB0cnVlKTsKICAgICAgb2Zmc2V0ICs9IHNpemVPZkludDMyOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzI7CiAgICAgIGNvbnN0IGluZGljZXNNYXBwaW5nID0gbmV3IEFycmF5KG51bVBvaW50cyk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtUG9pbnRzOyArK2kpIHsKICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBvcmlnaW5YICsgZHYuZ2V0VWludDgob2Zmc2V0KyspICogc3RlcFg7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgIGNvbnN0IGxhdGl0dWRlID0gb3JpZ2luWSArIGR2LmdldFVpbnQ4KG9mZnNldCsrKSAqIHN0ZXBZOwogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgbGV0IGhlaWdodCA9IGR2LmdldEZsb2F0MzIob2Zmc2V0LCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gc2l6ZU9mRmxvYXQ7CiAgICAgICAgaWYgKGhlaWdodCAhPT0gMCAmJiBoZWlnaHQgPCBuZWdhdGl2ZUVsZXZhdGlvblRocmVzaG9sZCkgewogICAgICAgICAgaGVpZ2h0ICo9IC1NYXRoLnBvdygyLCBuZWdhdGl2ZUFsdGl0dWRlRXhwb25lbnRCaWFzKTsKICAgICAgICB9CiAgICAgICAgaGVpZ2h0ICo9IDYzNzEwMTA7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIGlmIChpbmRleE9mRXBzaWxvbihxdWFkQm9yZGVyTG9uZ2l0dWRlcywgbG9uZ2l0dWRlKSAhPT0gLTEgfHwgaW5kZXhPZkVwc2lsb24ocXVhZEJvcmRlckxhdGl0dWRlcywgbGF0aXR1ZGUpICE9PSAtMSkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpbmRleE9mRXBzaWxvbigKICAgICAgICAgICAgcXVhZEJvcmRlclBvaW50cywKICAgICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcsCiAgICAgICAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0CiAgICAgICAgICApOwogICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkgewogICAgICAgICAgICBxdWFkQm9yZGVyUG9pbnRzLnB1c2goQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc2NyYXRjaENhcnRvZ3JhcGhpYzcpKTsKICAgICAgICAgICAgcXVhZEJvcmRlckluZGljZXMucHVzaChwb2ludE9mZnNldCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbmRpY2VzTWFwcGluZ1tpXSA9IHF1YWRCb3JkZXJJbmRpY2VzW2luZGV4XTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGljZXNNYXBwaW5nW2ldID0gcG9pbnRPZmZzZXQ7CiAgICAgICAgaWYgKE1hdGguYWJzKGxvbmdpdHVkZSAtIGdlb2dyYXBoaWNXZXN0KSA8IGhhbGZTdGVwWCkgewogICAgICAgICAgd2VzdEJvcmRlci5wdXNoKHsKICAgICAgICAgICAgaW5kZXg6IHBvaW50T2Zmc2V0LAogICAgICAgICAgICBjYXJ0b2dyYXBoaWM6IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKHNjcmF0Y2hDYXJ0b2dyYXBoaWM3KQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChNYXRoLmFicyhsb25naXR1ZGUgLSBnZW9ncmFwaGljRWFzdCkgPCBoYWxmU3RlcFgpIHsKICAgICAgICAgIGVhc3RCb3JkZXIucHVzaCh7CiAgICAgICAgICAgIGluZGV4OiBwb2ludE9mZnNldCwKICAgICAgICAgICAgY2FydG9ncmFwaGljOiBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShzY3JhdGNoQ2FydG9ncmFwaGljNykKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAoTWF0aC5hYnMobGF0aXR1ZGUgLSBnZW9ncmFwaGljU291dGgpIDwgaGFsZlN0ZXBZKSB7CiAgICAgICAgICBzb3V0aEJvcmRlci5wdXNoKHsKICAgICAgICAgICAgaW5kZXg6IHBvaW50T2Zmc2V0LAogICAgICAgICAgICBjYXJ0b2dyYXBoaWM6IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKHNjcmF0Y2hDYXJ0b2dyYXBoaWM3KQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChNYXRoLmFicyhsYXRpdHVkZSAtIGdlb2dyYXBoaWNOb3J0aCkgPCBoYWxmU3RlcFkpIHsKICAgICAgICAgIG5vcnRoQm9yZGVyLnB1c2goewogICAgICAgICAgICBpbmRleDogcG9pbnRPZmZzZXQsCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzogQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc2NyYXRjaENhcnRvZ3JhcGhpYzcpCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgbWluSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBtaW5IZWlnaHQpOwogICAgICAgIG1heEhlaWdodCA9IE1hdGgubWF4KGhlaWdodCwgbWF4SGVpZ2h0KTsKICAgICAgICBoZWlnaHRzW3BvaW50T2Zmc2V0XSA9IGhlaWdodDsKICAgICAgICBjb25zdCBwb3MgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc2NyYXRjaENhcnRvZ3JhcGhpYzcpOwogICAgICAgIHBvc2l0aW9uc1twb2ludE9mZnNldF0gPSBwb3M7CiAgICAgICAgaWYgKGluY2x1ZGVXZWJNZXJjYXRvclQpIHsKICAgICAgICAgIHdlYk1lcmNhdG9yVHNbcG9pbnRPZmZzZXRdID0gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUobGF0aXR1ZGUpIC0gc291dGhNZXJjYXRvclkpICogb25lT3Zlck1lcmNhdG9ySGVpZ2h0OwogICAgICAgIH0KICAgICAgICBpZiAoaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgIGNvbnN0IG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvcyk7CiAgICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzW3BvaW50T2Zmc2V0XSA9IG5vcm1hbDI7CiAgICAgICAgfQogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQodG9FTlUsIHBvcywgc2NyYXRjaENhcnRlc2lhbjIwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWluaW11bUJ5Q29tcG9uZW50KHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWluaW11bSwgbWluaW11bSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1CeUNvbXBvbmVudChzY3JhdGNoQ2FydGVzaWFuMjAsIG1heGltdW0sIG1heGltdW0pOwogICAgICAgIGxldCB1MyA9IChsb25naXR1ZGUgLSBnZW9ncmFwaGljV2VzdCkgLyAoZ2VvZ3JhcGhpY0Vhc3QgLSBnZW9ncmFwaGljV2VzdCk7CiAgICAgICAgdTMgPSBNYXRoX2RlZmF1bHQuY2xhbXAodTMsIDAsIDEpOwogICAgICAgIGxldCB2MyA9IChsYXRpdHVkZSAtIGdlb2dyYXBoaWNTb3V0aCkgLyAoZ2VvZ3JhcGhpY05vcnRoIC0gZ2VvZ3JhcGhpY1NvdXRoKTsKICAgICAgICB2MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2MywgMCwgMSk7CiAgICAgICAgdXZzW3BvaW50T2Zmc2V0XSA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQodTMsIHYzKTsKICAgICAgICArK3BvaW50T2Zmc2V0OwogICAgICB9CiAgICAgIGNvbnN0IGZhY2VzRWxlbWVudENvdW50ID0gbnVtRmFjZXMgKiAzOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGZhY2VzRWxlbWVudENvdW50OyArK2osICsraW5kaWNlc09mZnNldCkgewogICAgICAgIGluZGljZXNbaW5kaWNlc09mZnNldF0gPSBpbmRpY2VzTWFwcGluZ1tkdi5nZXRVaW50MTYob2Zmc2V0LCB0cnVlKV07CiAgICAgICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQxNjsKICAgICAgfQogICAgICBpZiAocXVhZFNpemUgIT09IG9mZnNldCAtIHN0YXJ0UXVhZCkgewogICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCB0ZXJyYWluIHRpbGUuIik7CiAgICAgIH0KICAgIH0KICAgIHBvc2l0aW9ucy5sZW5ndGggPSBwb2ludE9mZnNldDsKICAgIHV2cy5sZW5ndGggPSBwb2ludE9mZnNldDsKICAgIGhlaWdodHMubGVuZ3RoID0gcG9pbnRPZmZzZXQ7CiAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICB3ZWJNZXJjYXRvclRzLmxlbmd0aCA9IHBvaW50T2Zmc2V0OwogICAgfQogICAgaWYgKGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHMubGVuZ3RoID0gcG9pbnRPZmZzZXQ7CiAgICB9CiAgICBjb25zdCB2ZXJ0ZXhDb3VudFdpdGhvdXRTa2lydHMgPSBwb2ludE9mZnNldDsKICAgIGNvbnN0IGluZGV4Q291bnRXaXRob3V0U2tpcnRzID0gaW5kaWNlc09mZnNldDsKICAgIGNvbnN0IHNraXJ0T3B0aW9ucyA9IHsKICAgICAgaE1pbjogbWluSGVpZ2h0LAogICAgICBsYXN0Qm9yZGVyUG9pbnQ6IHZvaWQgMCwKICAgICAgc2tpcnRIZWlnaHQsCiAgICAgIHRvRU5VLAogICAgICBlbGxpcHNvaWQsCiAgICAgIG1pbmltdW0sCiAgICAgIG1heGltdW0KICAgIH07CiAgICB3ZXN0Qm9yZGVyLnNvcnQoZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIGIuY2FydG9ncmFwaGljLmxhdGl0dWRlIC0gYTMuY2FydG9ncmFwaGljLmxhdGl0dWRlOwogICAgfSk7CiAgICBzb3V0aEJvcmRlci5zb3J0KGZ1bmN0aW9uKGEzLCBiKSB7CiAgICAgIHJldHVybiBhMy5jYXJ0b2dyYXBoaWMubG9uZ2l0dWRlIC0gYi5jYXJ0b2dyYXBoaWMubG9uZ2l0dWRlOwogICAgfSk7CiAgICBlYXN0Qm9yZGVyLnNvcnQoZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIGEzLmNhcnRvZ3JhcGhpYy5sYXRpdHVkZSAtIGIuY2FydG9ncmFwaGljLmxhdGl0dWRlOwogICAgfSk7CiAgICBub3J0aEJvcmRlci5zb3J0KGZ1bmN0aW9uKGEzLCBiKSB7CiAgICAgIHJldHVybiBiLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGUgLSBhMy5jYXJ0b2dyYXBoaWMubG9uZ2l0dWRlOwogICAgfSk7CiAgICBjb25zdCBwZXJjZW50YWdlID0gMWUtNTsKICAgIGFkZFNraXJ0KAogICAgICBwb3NpdGlvbnMsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgd2ViTWVyY2F0b3JUcywKICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscywKICAgICAgaW5kaWNlcywKICAgICAgc2tpcnRPcHRpb25zLAogICAgICB3ZXN0Qm9yZGVyLAogICAgICAtcGVyY2VudGFnZSAqIHJlY3RhbmdsZVdpZHRoLAogICAgICB0cnVlLAogICAgICAtcGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodAogICAgKTsKICAgIGFkZFNraXJ0KAogICAgICBwb3NpdGlvbnMsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgd2ViTWVyY2F0b3JUcywKICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscywKICAgICAgaW5kaWNlcywKICAgICAgc2tpcnRPcHRpb25zLAogICAgICBzb3V0aEJvcmRlciwKICAgICAgLXBlcmNlbnRhZ2UgKiByZWN0YW5nbGVIZWlnaHQsCiAgICAgIGZhbHNlCiAgICApOwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIGVhc3RCb3JkZXIsCiAgICAgIHBlcmNlbnRhZ2UgKiByZWN0YW5nbGVXaWR0aCwKICAgICAgdHJ1ZSwKICAgICAgcGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodAogICAgKTsKICAgIGFkZFNraXJ0KAogICAgICBwb3NpdGlvbnMsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgd2ViTWVyY2F0b3JUcywKICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscywKICAgICAgaW5kaWNlcywKICAgICAgc2tpcnRPcHRpb25zLAogICAgICBub3J0aEJvcmRlciwKICAgICAgcGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodCwKICAgICAgZmFsc2UKICAgICk7CiAgICBpZiAod2VzdEJvcmRlci5sZW5ndGggPiAwICYmIG5vcnRoQm9yZGVyLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgZmlyc3RCb3JkZXJJbmRleCA9IHdlc3RCb3JkZXJbMF0uaW5kZXg7CiAgICAgIGNvbnN0IGZpcnN0U2tpcnRJbmRleCA9IHZlcnRleENvdW50V2l0aG91dFNraXJ0czsKICAgICAgY29uc3QgbGFzdEJvcmRlckluZGV4ID0gbm9ydGhCb3JkZXJbbm9ydGhCb3JkZXIubGVuZ3RoIC0gMV0uaW5kZXg7CiAgICAgIGNvbnN0IGxhc3RTa2lydEluZGV4ID0gcG9zaXRpb25zLmxlbmd0aCAtIDE7CiAgICAgIGluZGljZXMucHVzaCgKICAgICAgICBsYXN0Qm9yZGVySW5kZXgsCiAgICAgICAgbGFzdFNraXJ0SW5kZXgsCiAgICAgICAgZmlyc3RTa2lydEluZGV4LAogICAgICAgIGZpcnN0U2tpcnRJbmRleCwKICAgICAgICBmaXJzdEJvcmRlckluZGV4LAogICAgICAgIGxhc3RCb3JkZXJJbmRleAogICAgICApOwogICAgfQogICAgc2l6ZSA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZTNEID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucyk7CiAgICBsZXQgb3JpZW50ZWRCb3VuZGluZ0JveDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICBvcmllbnRlZEJvdW5kaW5nQm94ID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIG1pbkhlaWdodCwKICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgZWxsaXBzb2lkCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBvY2NsdWRlciA9IG5ldyBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgIGNvbnN0IG9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlID0gb2NjbHVkZXIuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRQb3NzaWJseVVuZGVyRWxsaXBzb2lkKAogICAgICByZWxhdGl2ZVRvQ2VudGVyLAogICAgICBwb3NpdGlvbnMsCiAgICAgIG1pbkhlaWdodAogICAgKTsKICAgIGNvbnN0IGFhQm94ID0gbmV3IEF4aXNBbGlnbmVkQm91bmRpbmdCb3hfZGVmYXVsdChtaW5pbXVtLCBtYXhpbXVtLCByZWxhdGl2ZVRvQ2VudGVyKTsKICAgIGNvbnN0IGVuY29kaW5nID0gbmV3IFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0KAogICAgICByZWxhdGl2ZVRvQ2VudGVyLAogICAgICBhYUJveCwKICAgICAgc2tpcnRPcHRpb25zLmhNaW4sCiAgICAgIG1heEhlaWdodCwKICAgICAgZnJvbUVOVSwKICAgICAgZmFsc2UsCiAgICAgIGluY2x1ZGVXZWJNZXJjYXRvclQsCiAgICAgIGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBleGFnZ2VyYXRpb24sCiAgICAgIGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0CiAgICApOwogICAgY29uc3QgdmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiBlbmNvZGluZy5zdHJpZGUpOwogICAgbGV0IGJ1ZmZlckluZGV4ID0gMDsKICAgIGZvciAobGV0IGsgPSAwOyBrIDwgc2l6ZTsgKytrKSB7CiAgICAgIGJ1ZmZlckluZGV4ID0gZW5jb2RpbmcuZW5jb2RlKAogICAgICAgIHZlcnRpY2VzLAogICAgICAgIGJ1ZmZlckluZGV4LAogICAgICAgIHBvc2l0aW9uc1trXSwKICAgICAgICB1dnNba10sCiAgICAgICAgaGVpZ2h0c1trXSwKICAgICAgICB2b2lkIDAsCiAgICAgICAgd2ViTWVyY2F0b3JUc1trXSwKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzW2tdCiAgICAgICk7CiAgICB9CiAgICBjb25zdCB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCA9IHdlc3RCb3JkZXIubWFwKGZ1bmN0aW9uKHZlcnRleCkgewogICAgICByZXR1cm4gdmVydGV4LmluZGV4OwogICAgfSkucmV2ZXJzZSgpOwogICAgY29uc3Qgc291dGhJbmRpY2VzRWFzdFRvV2VzdCA9IHNvdXRoQm9yZGVyLm1hcChmdW5jdGlvbih2ZXJ0ZXgpIHsKICAgICAgcmV0dXJuIHZlcnRleC5pbmRleDsKICAgIH0pLnJldmVyc2UoKTsKICAgIGNvbnN0IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoID0gZWFzdEJvcmRlci5tYXAoZnVuY3Rpb24odmVydGV4KSB7CiAgICAgIHJldHVybiB2ZXJ0ZXguaW5kZXg7CiAgICB9KS5yZXZlcnNlKCk7CiAgICBjb25zdCBub3J0aEluZGljZXNXZXN0VG9FYXN0ID0gbm9ydGhCb3JkZXIubWFwKGZ1bmN0aW9uKHZlcnRleCkgewogICAgICByZXR1cm4gdmVydGV4LmluZGV4OwogICAgfSkucmV2ZXJzZSgpOwogICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdC51bnNoaWZ0KAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aFtlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aC5sZW5ndGggLSAxXQogICAgKTsKICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QucHVzaCh3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aFswXSk7CiAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LnVuc2hpZnQoCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoW3dlc3RJbmRpY2VzU291dGhUb05vcnRoLmxlbmd0aCAtIDFdCiAgICApOwogICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdC5wdXNoKGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoWzBdKTsKICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzLAogICAgICBpbmRpY2VzOiBuZXcgVWludDE2QXJyYXkoaW5kaWNlcyksCiAgICAgIG1heGltdW1IZWlnaHQ6IG1heEhlaWdodCwKICAgICAgbWluaW11bUhlaWdodDogbWluSGVpZ2h0LAogICAgICBlbmNvZGluZywKICAgICAgYm91bmRpbmdTcGhlcmUzRCwKICAgICAgb3JpZW50ZWRCb3VuZGluZ0JveCwKICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UsCiAgICAgIHZlcnRleENvdW50V2l0aG91dFNraXJ0cywKICAgICAgaW5kZXhDb3VudFdpdGhvdXRTa2lydHMsCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdAogICAgfTsKICB9CiAgZnVuY3Rpb24gYWRkU2tpcnQocG9zaXRpb25zLCBoZWlnaHRzLCB1dnMsIHdlYk1lcmNhdG9yVHMsIGdlb2RldGljU3VyZmFjZU5vcm1hbHMsIGluZGljZXMsIHNraXJ0T3B0aW9ucywgYm9yZGVyUG9pbnRzLCBmdWRnZUZhY3RvciwgZWFzdE9yV2VzdCwgY29ybmVyRnVkZ2UpIHsKICAgIGNvbnN0IGNvdW50ID0gYm9yZGVyUG9pbnRzLmxlbmd0aDsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgY291bnQ7ICsraikgewogICAgICBjb25zdCBib3JkZXJQb2ludCA9IGJvcmRlclBvaW50c1tqXTsKICAgICAgY29uc3QgYm9yZGVyQ2FydG9ncmFwaGljID0gYm9yZGVyUG9pbnQuY2FydG9ncmFwaGljOwogICAgICBjb25zdCBib3JkZXJJbmRleCA9IGJvcmRlclBvaW50LmluZGV4OwogICAgICBjb25zdCBjdXJyZW50SW5kZXggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICBjb25zdCBsb25naXR1ZGUgPSBib3JkZXJDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlOwogICAgICBsZXQgbGF0aXR1ZGUgPSBib3JkZXJDYXJ0b2dyYXBoaWMubGF0aXR1ZGU7CiAgICAgIGxhdGl0dWRlID0gTWF0aF9kZWZhdWx0LmNsYW1wKAogICAgICAgIGxhdGl0dWRlLAogICAgICAgIC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08sCiAgICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICk7CiAgICAgIGNvbnN0IGhlaWdodCA9IGJvcmRlckNhcnRvZ3JhcGhpYy5oZWlnaHQgLSBza2lydE9wdGlvbnMuc2tpcnRIZWlnaHQ7CiAgICAgIHNraXJ0T3B0aW9ucy5oTWluID0gTWF0aC5taW4oc2tpcnRPcHRpb25zLmhNaW4sIGhlaWdodCk7CiAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCwgc2NyYXRjaENhcnRvZ3JhcGhpYzcpOwogICAgICBpZiAoZWFzdE9yV2VzdCkgewogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3LmxvbmdpdHVkZSArPSBmdWRnZUZhY3RvcjsKICAgICAgfQogICAgICBpZiAoIWVhc3RPcldlc3QpIHsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5sYXRpdHVkZSArPSBmdWRnZUZhY3RvcjsKICAgICAgfSBlbHNlIGlmIChqID09PSBjb3VudCAtIDEpIHsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5sYXRpdHVkZSArPSBjb3JuZXJGdWRnZTsKICAgICAgfSBlbHNlIGlmIChqID09PSAwKSB7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcubGF0aXR1ZGUgLT0gY29ybmVyRnVkZ2U7CiAgICAgIH0KICAgICAgY29uc3QgcG9zID0gc2tpcnRPcHRpb25zLmVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihzY3JhdGNoQ2FydG9ncmFwaGljNyk7CiAgICAgIHBvc2l0aW9ucy5wdXNoKHBvcyk7CiAgICAgIGhlaWdodHMucHVzaChoZWlnaHQpOwogICAgICB1dnMucHVzaChDYXJ0ZXNpYW4yX2RlZmF1bHQuY2xvbmUodXZzW2JvcmRlckluZGV4XSkpOwogICAgICBpZiAod2ViTWVyY2F0b3JUcy5sZW5ndGggPiAwKSB7CiAgICAgICAgd2ViTWVyY2F0b3JUcy5wdXNoKHdlYk1lcmNhdG9yVHNbYm9yZGVySW5kZXhdKTsKICAgICAgfQogICAgICBpZiAoZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5sZW5ndGggPiAwKSB7CiAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5wdXNoKGdlb2RldGljU3VyZmFjZU5vcm1hbHNbYm9yZGVySW5kZXhdKTsKICAgICAgfQogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHNraXJ0T3B0aW9ucy50b0VOVSwgcG9zLCBzY3JhdGNoQ2FydGVzaWFuMjApOwogICAgICBjb25zdCBtaW5pbXVtID0gc2tpcnRPcHRpb25zLm1pbmltdW07CiAgICAgIGNvbnN0IG1heGltdW0gPSBza2lydE9wdGlvbnMubWF4aW11bTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pbmltdW1CeUNvbXBvbmVudChzY3JhdGNoQ2FydGVzaWFuMjAsIG1pbmltdW0sIG1pbmltdW0pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgIGNvbnN0IGxhc3RCb3JkZXJQb2ludCA9IHNraXJ0T3B0aW9ucy5sYXN0Qm9yZGVyUG9pbnQ7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobGFzdEJvcmRlclBvaW50KSkgewogICAgICAgIGNvbnN0IGxhc3RCb3JkZXJJbmRleCA9IGxhc3RCb3JkZXJQb2ludC5pbmRleDsKICAgICAgICBpbmRpY2VzLnB1c2goCiAgICAgICAgICBsYXN0Qm9yZGVySW5kZXgsCiAgICAgICAgICBjdXJyZW50SW5kZXggLSAxLAogICAgICAgICAgY3VycmVudEluZGV4LAogICAgICAgICAgY3VycmVudEluZGV4LAogICAgICAgICAgYm9yZGVySW5kZXgsCiAgICAgICAgICBsYXN0Qm9yZGVySW5kZXgKICAgICAgICApOwogICAgICB9CiAgICAgIHNraXJ0T3B0aW9ucy5sYXN0Qm9yZGVyUG9pbnQgPSBib3JkZXJQb2ludDsKICAgIH0KICB9CiAgdmFyIHNpemVPZlVpbnQxNiwgc2l6ZU9mSW50MzIsIHNpemVPZlVpbnQzMiwgc2l6ZU9mRmxvYXQsIHNpemVPZkRvdWJsZSwgc2NyYXRjaENhcnRvZ3JhcGhpYzcsIHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWluaW11bVNjcmF0Y2gsIG1heGltdW1TY3JhdGNoLCBtYXRyaXg0U2NyYXRjaDMsIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyLmpzIigpIHsKICAgICAgaW5pdF9BeGlzQWxpZ25lZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRhbE9jY2x1ZGVyKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9PcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGluaXRfVGVycmFpbkVuY29kaW5nKCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2l6ZU9mVWludDE2ID0gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNpemVPZkludDMyID0gSW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mVWludDMyID0gVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNpemVPZkZsb2F0ID0gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBzaXplT2ZEb3VibGUgPSBGbG9hdDY0QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbWluaW11bVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG1heGltdW1TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXRyaXg0U2NyYXRjaDMgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KAogICAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcgogICAgICApOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwRW5jb2RpbmcuanMKICB2YXIgSGVpZ2h0bWFwRW5jb2RpbmcsIEhlaWdodG1hcEVuY29kaW5nX2RlZmF1bHQ7CiAgdmFyIGluaXRfSGVpZ2h0bWFwRW5jb2RpbmcgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0hlaWdodG1hcEVuY29kaW5nLmpzIigpIHsKICAgICAgSGVpZ2h0bWFwRW5jb2RpbmcgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogTm8gZW5jb2RpbmcKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTk9ORTogMCwKICAgICAgICAvKioKICAgICAgICAgKiBMRVJDIGVuY29kaW5nCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqCiAgICAgICAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL0VzcmkvbGVyY3xUaGUgTEVSQyBzcGVjaWZpY2F0aW9ufQogICAgICAgICAqLwogICAgICAgIExFUkM6IDEKICAgICAgfTsKICAgICAgSGVpZ2h0bWFwRW5jb2RpbmdfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoSGVpZ2h0bWFwRW5jb2RpbmcpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwVGVzc2VsbGF0b3IuanMKICB2YXIgSGVpZ2h0bWFwVGVzc2VsbGF0b3IsIGNhcnRlc2lhbjNTY3JhdGNoNywgbWF0cml4NFNjcmF0Y2g0LCBtaW5pbXVtU2NyYXRjaDIsIG1heGltdW1TY3JhdGNoMiwgSGVpZ2h0bWFwVGVzc2VsbGF0b3JfZGVmYXVsdDsKICB2YXIgaW5pdF9IZWlnaHRtYXBUZXNzZWxsYXRvciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwVGVzc2VsbGF0b3IuanMiKCkgewogICAgICBpbml0X0F4aXNBbGlnbmVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkYWxPY2NsdWRlcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1RlcnJhaW5FbmNvZGluZygpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgaW5pdF9XZWJNZXJjYXRvclByb2plY3Rpb24oKTsKICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IgPSB7fTsKICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUgPSBPYmplY3QuZnJlZXplKHsKICAgICAgICBoZWlnaHRTY2FsZTogMSwKICAgICAgICBoZWlnaHRPZmZzZXQ6IDAsCiAgICAgICAgZWxlbWVudHNQZXJIZWlnaHQ6IDEsCiAgICAgICAgc3RyaWRlOiAxLAogICAgICAgIGVsZW1lbnRNdWx0aXBsaWVyOiAyNTYsCiAgICAgICAgaXNCaWdFbmRpYW46IGZhbHNlCiAgICAgIH0pOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG1hdHJpeDRTY3JhdGNoNCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgbWluaW11bVNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXhpbXVtU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLmNvbXB1dGVWZXJ0aWNlcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0bWFwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuaGVpZ2h0bWFwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLndpZHRoKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMud2lkdGggYW5kIG9wdGlvbnMuaGVpZ2h0IGFyZSByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuc2tpcnRIZWlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5za2lydEhlaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29zNCA9IE1hdGguY29zOwogICAgICAgIGNvbnN0IHNpbjQgPSBNYXRoLnNpbjsKICAgICAgICBjb25zdCBzcXJ0MiA9IE1hdGguc3FydDsKICAgICAgICBjb25zdCBhdGFuID0gTWF0aC5hdGFuOwogICAgICAgIGNvbnN0IGV4cCA9IE1hdGguZXhwOwogICAgICAgIGNvbnN0IHBpT3ZlclR3byA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICBjb25zdCB0b1JhZGlhbnMgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zOwogICAgICAgIGNvbnN0IGhlaWdodG1hcCA9IG9wdGlvbnMuaGVpZ2h0bWFwOwogICAgICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSBvcHRpb25zLmhlaWdodDsKICAgICAgICBjb25zdCBza2lydEhlaWdodCA9IG9wdGlvbnMuc2tpcnRIZWlnaHQ7CiAgICAgICAgY29uc3QgaGFzU2tpcnRzID0gc2tpcnRIZWlnaHQgPiAwOwogICAgICAgIGNvbnN0IGlzR2VvZ3JhcGhpYyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaXNHZW9ncmFwaGljLCB0cnVlKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCk7CiAgICAgICAgY29uc3Qgb25lT3Zlckdsb2JlU2VtaW1ham9yQXhpcyA9IDEgLyBlbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgICAgICBjb25zdCBuYXRpdmVSZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShvcHRpb25zLm5hdGl2ZVJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUob3B0aW9ucy5yZWN0YW5nbGUpOwogICAgICAgIGxldCBnZW9ncmFwaGljV2VzdDsKICAgICAgICBsZXQgZ2VvZ3JhcGhpY1NvdXRoOwogICAgICAgIGxldCBnZW9ncmFwaGljRWFzdDsKICAgICAgICBsZXQgZ2VvZ3JhcGhpY05vcnRoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIGlmIChpc0dlb2dyYXBoaWMpIHsKICAgICAgICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSB0b1JhZGlhbnMobmF0aXZlUmVjdGFuZ2xlLndlc3QpOwogICAgICAgICAgICBnZW9ncmFwaGljU291dGggPSB0b1JhZGlhbnMobmF0aXZlUmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICAgICAgZ2VvZ3JhcGhpY0Vhc3QgPSB0b1JhZGlhbnMobmF0aXZlUmVjdGFuZ2xlLmVhc3QpOwogICAgICAgICAgICBnZW9ncmFwaGljTm9ydGggPSB0b1JhZGlhbnMobmF0aXZlUmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdlb2dyYXBoaWNXZXN0ID0gbmF0aXZlUmVjdGFuZ2xlLndlc3QgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzOwogICAgICAgICAgICBnZW9ncmFwaGljU291dGggPSBwaU92ZXJUd28gLSAyICogYXRhbihleHAoLW5hdGl2ZVJlY3RhbmdsZS5zb3V0aCAqIG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXMpKTsKICAgICAgICAgICAgZ2VvZ3JhcGhpY0Vhc3QgPSBuYXRpdmVSZWN0YW5nbGUuZWFzdCAqIG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXM7CiAgICAgICAgICAgIGdlb2dyYXBoaWNOb3J0aCA9IHBpT3ZlclR3byAtIDIgKiBhdGFuKGV4cCgtbmF0aXZlUmVjdGFuZ2xlLm5vcnRoICogb25lT3Zlckdsb2JlU2VtaW1ham9yQXhpcykpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW9ncmFwaGljV2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICAgICAgZ2VvZ3JhcGhpY0Vhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICAgIGdlb2dyYXBoaWNOb3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICB9CiAgICAgICAgbGV0IHJlbGF0aXZlVG9DZW50ZXIgPSBvcHRpb25zLnJlbGF0aXZlVG9DZW50ZXI7CiAgICAgICAgY29uc3QgaGFzUmVsYXRpdmVUb0NlbnRlciA9IGRlZmluZWRfZGVmYXVsdChyZWxhdGl2ZVRvQ2VudGVyKTsKICAgICAgICByZWxhdGl2ZVRvQ2VudGVyID0gaGFzUmVsYXRpdmVUb0NlbnRlciA/IHJlbGF0aXZlVG9DZW50ZXIgOiBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTzsKICAgICAgICBjb25zdCBpbmNsdWRlV2ViTWVyY2F0b3JUID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5pbmNsdWRlV2ViTWVyY2F0b3JULCBmYWxzZSk7CiAgICAgICAgY29uc3QgZXhhZ2dlcmF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leGFnZ2VyYXRpb24sIDEpOwogICAgICAgIGNvbnN0IGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBvcHRpb25zLmV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0LAogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgY29uc3QgaGFzRXhhZ2dlcmF0aW9uID0gZXhhZ2dlcmF0aW9uICE9PSAxOwogICAgICAgIGNvbnN0IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaGFzRXhhZ2dlcmF0aW9uOwogICAgICAgIGNvbnN0IHN0cnVjdHVyZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5zdHJ1Y3R1cmUsCiAgICAgICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvci5ERUZBVUxUX1NUUlVDVFVSRQogICAgICAgICk7CiAgICAgICAgY29uc3QgaGVpZ2h0U2NhbGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIHN0cnVjdHVyZS5oZWlnaHRTY2FsZSwKICAgICAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLkRFRkFVTFRfU1RSVUNUVVJFLmhlaWdodFNjYWxlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoZWlnaHRPZmZzZXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIHN0cnVjdHVyZS5oZWlnaHRPZmZzZXQsCiAgICAgICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvci5ERUZBVUxUX1NUUlVDVFVSRS5oZWlnaHRPZmZzZXQKICAgICAgICApOwogICAgICAgIGNvbnN0IGVsZW1lbnRzUGVySGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBzdHJ1Y3R1cmUuZWxlbWVudHNQZXJIZWlnaHQsCiAgICAgICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvci5ERUZBVUxUX1NUUlVDVFVSRS5lbGVtZW50c1BlckhlaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3Qgc3RyaWRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBzdHJ1Y3R1cmUuc3RyaWRlLAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuc3RyaWRlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlbGVtZW50TXVsdGlwbGllciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLmVsZW1lbnRNdWx0aXBsaWVyLAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuZWxlbWVudE11bHRpcGxpZXIKICAgICAgICApOwogICAgICAgIGNvbnN0IGlzQmlnRW5kaWFuID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBzdHJ1Y3R1cmUuaXNCaWdFbmRpYW4sCiAgICAgICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvci5ERUZBVUxUX1NUUlVDVFVSRS5pc0JpZ0VuZGlhbgogICAgICAgICk7CiAgICAgICAgbGV0IHJlY3RhbmdsZVdpZHRoID0gUmVjdGFuZ2xlX2RlZmF1bHQuY29tcHV0ZVdpZHRoKG5hdGl2ZVJlY3RhbmdsZSk7CiAgICAgICAgbGV0IHJlY3RhbmdsZUhlaWdodCA9IFJlY3RhbmdsZV9kZWZhdWx0LmNvbXB1dGVIZWlnaHQobmF0aXZlUmVjdGFuZ2xlKTsKICAgICAgICBjb25zdCBncmFudWxhcml0eVggPSByZWN0YW5nbGVXaWR0aCAvICh3aWR0aCAtIDEpOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5WSA9IHJlY3RhbmdsZUhlaWdodCAvIChoZWlnaHQgLSAxKTsKICAgICAgICBpZiAoIWlzR2VvZ3JhcGhpYykgewogICAgICAgICAgcmVjdGFuZ2xlV2lkdGggKj0gb25lT3Zlckdsb2JlU2VtaW1ham9yQXhpczsKICAgICAgICAgIHJlY3RhbmdsZUhlaWdodCAqPSBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzOwogICAgICAgIH0KICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSBlbGxpcHNvaWQucmFkaWlTcXVhcmVkOwogICAgICAgIGNvbnN0IHJhZGlpU3F1YXJlZFggPSByYWRpaVNxdWFyZWQueDsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWRZID0gcmFkaWlTcXVhcmVkLnk7CiAgICAgICAgY29uc3QgcmFkaWlTcXVhcmVkWiA9IHJhZGlpU3F1YXJlZC56OwogICAgICAgIGxldCBtaW5pbXVtSGVpZ2h0ID0gNjU1MzY7CiAgICAgICAgbGV0IG1heGltdW1IZWlnaHQgPSAtNjU1MzY7CiAgICAgICAgY29uc3QgZnJvbUVOVSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSgKICAgICAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICApOwogICAgICAgIGNvbnN0IHRvRU5VID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2VUcmFuc2Zvcm1hdGlvbihmcm9tRU5VLCBtYXRyaXg0U2NyYXRjaDQpOwogICAgICAgIGxldCBzb3V0aE1lcmNhdG9yWTsKICAgICAgICBsZXQgb25lT3Zlck1lcmNhdG9ySGVpZ2h0OwogICAgICAgIGlmIChpbmNsdWRlV2ViTWVyY2F0b3JUKSB7CiAgICAgICAgICBzb3V0aE1lcmNhdG9yWSA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoZ2VvZ3JhcGhpY1NvdXRoKTsKICAgICAgICAgIG9uZU92ZXJNZXJjYXRvckhlaWdodCA9IDEgLyAoV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQuZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZShnZW9ncmFwaGljTm9ydGgpIC0gc291dGhNZXJjYXRvclkpOwogICAgICAgIH0KICAgICAgICBjb25zdCBtaW5pbXVtID0gbWluaW11bVNjcmF0Y2gyOwogICAgICAgIG1pbmltdW0ueCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBtaW5pbXVtLnkgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbWluaW11bS56ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGNvbnN0IG1heGltdW0gPSBtYXhpbXVtU2NyYXRjaDI7CiAgICAgICAgbWF4aW11bS54ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIG1heGltdW0ueSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBtYXhpbXVtLnogPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IGhNaW4gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgY29uc3QgZ3JpZFZlcnRleENvdW50ID0gd2lkdGggKiBoZWlnaHQ7CiAgICAgICAgY29uc3QgZWRnZVZlcnRleENvdW50ID0gc2tpcnRIZWlnaHQgPiAwID8gd2lkdGggKiAyICsgaGVpZ2h0ICogMiA6IDA7CiAgICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBncmlkVmVydGV4Q291bnQgKyBlZGdlVmVydGV4Q291bnQ7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KHZlcnRleENvdW50KTsKICAgICAgICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KHZlcnRleENvdW50KTsKICAgICAgICBjb25zdCB1dnMgPSBuZXcgQXJyYXkodmVydGV4Q291bnQpOwogICAgICAgIGNvbnN0IHdlYk1lcmNhdG9yVHMgPSBpbmNsdWRlV2ViTWVyY2F0b3JUID8gbmV3IEFycmF5KHZlcnRleENvdW50KSA6IFtdOwogICAgICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbHMgPSBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA/IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCkgOiBbXTsKICAgICAgICBsZXQgc3RhcnRSb3cgPSAwOwogICAgICAgIGxldCBlbmRSb3cgPSBoZWlnaHQ7CiAgICAgICAgbGV0IHN0YXJ0Q29sID0gMDsKICAgICAgICBsZXQgZW5kQ29sID0gd2lkdGg7CiAgICAgICAgaWYgKGhhc1NraXJ0cykgewogICAgICAgICAgLS1zdGFydFJvdzsKICAgICAgICAgICsrZW5kUm93OwogICAgICAgICAgLS1zdGFydENvbDsKICAgICAgICAgICsrZW5kQ29sOwogICAgICAgIH0KICAgICAgICBjb25zdCBza2lydE9mZnNldFBlcmNlbnRhZ2UgPSAxZS01OwogICAgICAgIGZvciAobGV0IHJvd0luZGV4ID0gc3RhcnRSb3c7IHJvd0luZGV4IDwgZW5kUm93OyArK3Jvd0luZGV4KSB7CiAgICAgICAgICBsZXQgcm93ID0gcm93SW5kZXg7CiAgICAgICAgICBpZiAocm93IDwgMCkgewogICAgICAgICAgICByb3cgPSAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJvdyA+PSBoZWlnaHQpIHsKICAgICAgICAgICAgcm93ID0gaGVpZ2h0IC0gMTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBsYXRpdHVkZSA9IG5hdGl2ZVJlY3RhbmdsZS5ub3J0aCAtIGdyYW51bGFyaXR5WSAqIHJvdzsKICAgICAgICAgIGlmICghaXNHZW9ncmFwaGljKSB7CiAgICAgICAgICAgIGxhdGl0dWRlID0gcGlPdmVyVHdvIC0gMiAqIGF0YW4oZXhwKC1sYXRpdHVkZSAqIG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXMpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxhdGl0dWRlID0gdG9SYWRpYW5zKGxhdGl0dWRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCB2MyA9IChsYXRpdHVkZSAtIGdlb2dyYXBoaWNTb3V0aCkgLyAoZ2VvZ3JhcGhpY05vcnRoIC0gZ2VvZ3JhcGhpY1NvdXRoKTsKICAgICAgICAgIHYzID0gTWF0aF9kZWZhdWx0LmNsYW1wKHYzLCAwLCAxKTsKICAgICAgICAgIGNvbnN0IGlzTm9ydGhFZGdlID0gcm93SW5kZXggPT09IHN0YXJ0Um93OwogICAgICAgICAgY29uc3QgaXNTb3V0aEVkZ2UgPSByb3dJbmRleCA9PT0gZW5kUm93IC0gMTsKICAgICAgICAgIGlmIChza2lydEhlaWdodCA+IDApIHsKICAgICAgICAgICAgaWYgKGlzTm9ydGhFZGdlKSB7CiAgICAgICAgICAgICAgbGF0aXR1ZGUgKz0gc2tpcnRPZmZzZXRQZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0OwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzU291dGhFZGdlKSB7CiAgICAgICAgICAgICAgbGF0aXR1ZGUgLT0gc2tpcnRPZmZzZXRQZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBjb3NMYXRpdHVkZSA9IGNvczQobGF0aXR1ZGUpOwogICAgICAgICAgY29uc3QgblogPSBzaW40KGxhdGl0dWRlKTsKICAgICAgICAgIGNvbnN0IGtaID0gcmFkaWlTcXVhcmVkWiAqIG5aOwogICAgICAgICAgbGV0IHdlYk1lcmNhdG9yVDsKICAgICAgICAgIGlmIChpbmNsdWRlV2ViTWVyY2F0b3JUKSB7CiAgICAgICAgICAgIHdlYk1lcmNhdG9yVCA9IChXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKGxhdGl0dWRlKSAtIHNvdXRoTWVyY2F0b3JZKSAqIG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAobGV0IGNvbEluZGV4ID0gc3RhcnRDb2w7IGNvbEluZGV4IDwgZW5kQ29sOyArK2NvbEluZGV4KSB7CiAgICAgICAgICAgIGxldCBjb2wgPSBjb2xJbmRleDsKICAgICAgICAgICAgaWYgKGNvbCA8IDApIHsKICAgICAgICAgICAgICBjb2wgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb2wgPj0gd2lkdGgpIHsKICAgICAgICAgICAgICBjb2wgPSB3aWR0aCAtIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgdGVycmFpbk9mZnNldCA9IHJvdyAqICh3aWR0aCAqIHN0cmlkZSkgKyBjb2wgKiBzdHJpZGU7CiAgICAgICAgICAgIGxldCBoZWlnaHRTYW1wbGU7CiAgICAgICAgICAgIGlmIChlbGVtZW50c1BlckhlaWdodCA9PT0gMSkgewogICAgICAgICAgICAgIGhlaWdodFNhbXBsZSA9IGhlaWdodG1hcFt0ZXJyYWluT2Zmc2V0XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBoZWlnaHRTYW1wbGUgPSAwOwogICAgICAgICAgICAgIGxldCBlbGVtZW50T2Zmc2V0OwogICAgICAgICAgICAgIGlmIChpc0JpZ0VuZGlhbikgewogICAgICAgICAgICAgICAgZm9yIChlbGVtZW50T2Zmc2V0ID0gMDsgZWxlbWVudE9mZnNldCA8IGVsZW1lbnRzUGVySGVpZ2h0OyArK2VsZW1lbnRPZmZzZXQpIHsKICAgICAgICAgICAgICAgICAgaGVpZ2h0U2FtcGxlID0gaGVpZ2h0U2FtcGxlICogZWxlbWVudE11bHRpcGxpZXIgKyBoZWlnaHRtYXBbdGVycmFpbk9mZnNldCArIGVsZW1lbnRPZmZzZXRdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKGVsZW1lbnRPZmZzZXQgPSBlbGVtZW50c1BlckhlaWdodCAtIDE7IGVsZW1lbnRPZmZzZXQgPj0gMDsgLS1lbGVtZW50T2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAgIGhlaWdodFNhbXBsZSA9IGhlaWdodFNhbXBsZSAqIGVsZW1lbnRNdWx0aXBsaWVyICsgaGVpZ2h0bWFwW3RlcnJhaW5PZmZzZXQgKyBlbGVtZW50T2Zmc2V0XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGVpZ2h0U2FtcGxlID0gaGVpZ2h0U2FtcGxlICogaGVpZ2h0U2NhbGUgKyBoZWlnaHRPZmZzZXQ7CiAgICAgICAgICAgIG1heGltdW1IZWlnaHQgPSBNYXRoLm1heChtYXhpbXVtSGVpZ2h0LCBoZWlnaHRTYW1wbGUpOwogICAgICAgICAgICBtaW5pbXVtSGVpZ2h0ID0gTWF0aC5taW4obWluaW11bUhlaWdodCwgaGVpZ2h0U2FtcGxlKTsKICAgICAgICAgICAgbGV0IGxvbmdpdHVkZSA9IG5hdGl2ZVJlY3RhbmdsZS53ZXN0ICsgZ3JhbnVsYXJpdHlYICogY29sOwogICAgICAgICAgICBpZiAoIWlzR2VvZ3JhcGhpYykgewogICAgICAgICAgICAgIGxvbmdpdHVkZSA9IGxvbmdpdHVkZSAqIG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbG9uZ2l0dWRlID0gdG9SYWRpYW5zKGxvbmdpdHVkZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IHUzID0gKGxvbmdpdHVkZSAtIGdlb2dyYXBoaWNXZXN0KSAvIChnZW9ncmFwaGljRWFzdCAtIGdlb2dyYXBoaWNXZXN0KTsKICAgICAgICAgICAgdTMgPSBNYXRoX2RlZmF1bHQuY2xhbXAodTMsIDAsIDEpOwogICAgICAgICAgICBsZXQgaW5kZXggPSByb3cgKiB3aWR0aCArIGNvbDsKICAgICAgICAgICAgaWYgKHNraXJ0SGVpZ2h0ID4gMCkgewogICAgICAgICAgICAgIGNvbnN0IGlzV2VzdEVkZ2UgPSBjb2xJbmRleCA9PT0gc3RhcnRDb2w7CiAgICAgICAgICAgICAgY29uc3QgaXNFYXN0RWRnZSA9IGNvbEluZGV4ID09PSBlbmRDb2wgLSAxOwogICAgICAgICAgICAgIGNvbnN0IGlzRWRnZTIgPSBpc05vcnRoRWRnZSB8fCBpc1NvdXRoRWRnZSB8fCBpc1dlc3RFZGdlIHx8IGlzRWFzdEVkZ2U7CiAgICAgICAgICAgICAgY29uc3QgaXNDb3JuZXIgPSAoaXNOb3J0aEVkZ2UgfHwgaXNTb3V0aEVkZ2UpICYmIChpc1dlc3RFZGdlIHx8IGlzRWFzdEVkZ2UpOwogICAgICAgICAgICAgIGlmIChpc0Nvcm5lcikgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0VkZ2UyKSB7CiAgICAgICAgICAgICAgICBoZWlnaHRTYW1wbGUgLT0gc2tpcnRIZWlnaHQ7CiAgICAgICAgICAgICAgICBpZiAoaXNXZXN0RWRnZSkgewogICAgICAgICAgICAgICAgICBpbmRleCA9IGdyaWRWZXJ0ZXhDb3VudCArIChoZWlnaHQgLSByb3cgLSAxKTsKICAgICAgICAgICAgICAgICAgbG9uZ2l0dWRlIC09IHNraXJ0T2Zmc2V0UGVyY2VudGFnZSAqIHJlY3RhbmdsZVdpZHRoOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1NvdXRoRWRnZSkgewogICAgICAgICAgICAgICAgICBpbmRleCA9IGdyaWRWZXJ0ZXhDb3VudCArIGhlaWdodCArICh3aWR0aCAtIGNvbCAtIDEpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Vhc3RFZGdlKSB7CiAgICAgICAgICAgICAgICAgIGluZGV4ID0gZ3JpZFZlcnRleENvdW50ICsgaGVpZ2h0ICsgd2lkdGggKyByb3c7CiAgICAgICAgICAgICAgICAgIGxvbmdpdHVkZSArPSBza2lydE9mZnNldFBlcmNlbnRhZ2UgKiByZWN0YW5nbGVXaWR0aDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOb3J0aEVkZ2UpIHsKICAgICAgICAgICAgICAgICAgaW5kZXggPSBncmlkVmVydGV4Q291bnQgKyBoZWlnaHQgKyB3aWR0aCArIGhlaWdodCArIGNvbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgblggPSBjb3NMYXRpdHVkZSAqIGNvczQobG9uZ2l0dWRlKTsKICAgICAgICAgICAgY29uc3QgblkgPSBjb3NMYXRpdHVkZSAqIHNpbjQobG9uZ2l0dWRlKTsKICAgICAgICAgICAgY29uc3Qga1ggPSByYWRpaVNxdWFyZWRYICogblg7CiAgICAgICAgICAgIGNvbnN0IGtZID0gcmFkaWlTcXVhcmVkWSAqIG5ZOwogICAgICAgICAgICBjb25zdCBnYW1tYSA9IHNxcnQyKGtYICogblggKyBrWSAqIG5ZICsga1ogKiBuWik7CiAgICAgICAgICAgIGNvbnN0IG9uZU92ZXJHYW1tYSA9IDEgLyBnYW1tYTsKICAgICAgICAgICAgY29uc3QgclN1cmZhY2VYID0ga1ggKiBvbmVPdmVyR2FtbWE7CiAgICAgICAgICAgIGNvbnN0IHJTdXJmYWNlWSA9IGtZICogb25lT3ZlckdhbW1hOwogICAgICAgICAgICBjb25zdCByU3VyZmFjZVogPSBrWiAqIG9uZU92ZXJHYW1tYTsKICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgICAgIHBvc2l0aW9uLnggPSByU3VyZmFjZVggKyBuWCAqIGhlaWdodFNhbXBsZTsKICAgICAgICAgICAgcG9zaXRpb24ueSA9IHJTdXJmYWNlWSArIG5ZICogaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBwb3NpdGlvbi56ID0gclN1cmZhY2VaICsgblogKiBoZWlnaHRTYW1wbGU7CiAgICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQodG9FTlUsIHBvc2l0aW9uLCBjYXJ0ZXNpYW4zU2NyYXRjaDcpOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWluaW11bUJ5Q29tcG9uZW50KGNhcnRlc2lhbjNTY3JhdGNoNywgbWluaW11bSwgbWluaW11bSk7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYXhpbXVtQnlDb21wb25lbnQoY2FydGVzaWFuM1NjcmF0Y2g3LCBtYXhpbXVtLCBtYXhpbXVtKTsKICAgICAgICAgICAgaE1pbiA9IE1hdGgubWluKGhNaW4sIGhlaWdodFNhbXBsZSk7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleF0gPSBwb3NpdGlvbjsKICAgICAgICAgICAgdXZzW2luZGV4XSA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQodTMsIHYzKTsKICAgICAgICAgICAgaGVpZ2h0c1tpbmRleF0gPSBoZWlnaHRTYW1wbGU7CiAgICAgICAgICAgIGlmIChpbmNsdWRlV2ViTWVyY2F0b3JUKSB7CiAgICAgICAgICAgICAgd2ViTWVyY2F0b3JUc1tpbmRleF0gPSB3ZWJNZXJjYXRvclQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsc1tpbmRleF0gPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZTNEID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucyk7CiAgICAgICAgbGV0IG9yaWVudGVkQm91bmRpbmdCb3g7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICBvcmllbnRlZEJvdW5kaW5nQm94ID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZXQgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2U7CiAgICAgICAgaWYgKGhhc1JlbGF0aXZlVG9DZW50ZXIpIHsKICAgICAgICAgIGNvbnN0IG9jY2x1ZGVyID0gbmV3IEVsbGlwc29pZGFsT2NjbHVkZXJfZGVmYXVsdChlbGxpcHNvaWQpOwogICAgICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgICAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgbWluaW11bUhlaWdodAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYWFCb3ggPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KG1pbmltdW0sIG1heGltdW0sIHJlbGF0aXZlVG9DZW50ZXIpOwogICAgICAgIGNvbnN0IGVuY29kaW5nID0gbmV3IFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0KAogICAgICAgICAgcmVsYXRpdmVUb0NlbnRlciwKICAgICAgICAgIGFhQm94LAogICAgICAgICAgaE1pbiwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBmcm9tRU5VLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICBpbmNsdWRlV2ViTWVyY2F0b3JULAogICAgICAgICAgaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgICAgICBleGFnZ2VyYXRpb24sCiAgICAgICAgICBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogZW5jb2Rpbmcuc3RyaWRlKTsKICAgICAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdmVydGV4Q291bnQ7ICsraikgewogICAgICAgICAgYnVmZmVySW5kZXggPSBlbmNvZGluZy5lbmNvZGUoCiAgICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgICBidWZmZXJJbmRleCwKICAgICAgICAgICAgcG9zaXRpb25zW2pdLAogICAgICAgICAgICB1dnNbal0sCiAgICAgICAgICAgIGhlaWdodHNbal0sCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgd2ViTWVyY2F0b3JUc1tqXSwKICAgICAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsc1tqXQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgICBlbmNvZGluZywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlM0QsCiAgICAgICAgICBvcmllbnRlZEJvdW5kaW5nQm94LAogICAgICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UKICAgICAgICB9OwogICAgICB9OwogICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvcl9kZWZhdWx0ID0gSGVpZ2h0bWFwVGVzc2VsbGF0b3I7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9sZXJjL0xlcmNEZWNvZGUuanMKICB2YXIgcmVxdWlyZV9MZXJjRGVjb2RlID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL2xlcmMvTGVyY0RlY29kZS5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiBDb3B5cmlnaHQgMjAxNS0yMDE4IEVzcmkuIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdCBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAgQHByZXNlcnZlICovCiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgTGVyY0RlY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIENudFpJbWFnZSA9IHt9OwogICAgICAgICAgQ250WkltYWdlLmRlZmF1bHROb0RhdGFWYWx1ZSA9IC0zNDAyNzk5OTM4NzkwMTQ4NGUyMjsKICAgICAgICAgIENudFpJbWFnZS5kZWNvZGUgPSBmdW5jdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIHNraXBNYXNrID0gb3B0aW9ucy5lbmNvZGVkTWFza0RhdGEgfHwgb3B0aW9ucy5lbmNvZGVkTWFza0RhdGEgPT09IG51bGw7CiAgICAgICAgICAgIHZhciBwYXJzZWREYXRhID0gcGFyc2UoaW5wdXQsIG9wdGlvbnMuaW5wdXRPZmZzZXQgfHwgMCwgc2tpcE1hc2spOwogICAgICAgICAgICB2YXIgbm9EYXRhVmFsdWUgPSBvcHRpb25zLm5vRGF0YVZhbHVlICE9PSBudWxsID8gb3B0aW9ucy5ub0RhdGFWYWx1ZSA6IENudFpJbWFnZS5kZWZhdWx0Tm9EYXRhVmFsdWU7CiAgICAgICAgICAgIHZhciB1bmNvbXByZXNzZWREYXRhID0gdW5jb21wcmVzc1BpeGVsVmFsdWVzKAogICAgICAgICAgICAgIHBhcnNlZERhdGEsCiAgICAgICAgICAgICAgb3B0aW9ucy5waXhlbFR5cGUgfHwgRmxvYXQzMkFycmF5LAogICAgICAgICAgICAgIG9wdGlvbnMuZW5jb2RlZE1hc2tEYXRhLAogICAgICAgICAgICAgIG5vRGF0YVZhbHVlLAogICAgICAgICAgICAgIG9wdGlvbnMucmV0dXJuTWFzawogICAgICAgICAgICApOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICAgIHdpZHRoOiBwYXJzZWREYXRhLndpZHRoLAogICAgICAgICAgICAgIGhlaWdodDogcGFyc2VkRGF0YS5oZWlnaHQsCiAgICAgICAgICAgICAgcGl4ZWxEYXRhOiB1bmNvbXByZXNzZWREYXRhLnJlc3VsdFBpeGVscywKICAgICAgICAgICAgICBtaW5WYWx1ZTogdW5jb21wcmVzc2VkRGF0YS5taW5WYWx1ZSwKICAgICAgICAgICAgICBtYXhWYWx1ZTogcGFyc2VkRGF0YS5waXhlbHMubWF4VmFsdWUsCiAgICAgICAgICAgICAgbm9EYXRhVmFsdWUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHVuY29tcHJlc3NlZERhdGEucmVzdWx0TWFzaykgewogICAgICAgICAgICAgIHJlc3VsdC5tYXNrRGF0YSA9IHVuY29tcHJlc3NlZERhdGEucmVzdWx0TWFzazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy5yZXR1cm5FbmNvZGVkTWFzayAmJiBwYXJzZWREYXRhLm1hc2spIHsKICAgICAgICAgICAgICByZXN1bHQuZW5jb2RlZE1hc2tEYXRhID0gcGFyc2VkRGF0YS5tYXNrLmJpdHNldCA/IHBhcnNlZERhdGEubWFzay5iaXRzZXQgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLnJldHVybkZpbGVJbmZvKSB7CiAgICAgICAgICAgICAgcmVzdWx0LmZpbGVJbmZvID0gZm9ybWF0RmlsZUluZm8ocGFyc2VkRGF0YSk7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29tcHV0ZVVzZWRCaXREZXB0aHMpIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5maWxlSW5mby5iaXREZXB0aHMgPSBjb21wdXRlVXNlZEJpdERlcHRocyhwYXJzZWREYXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdW5jb21wcmVzc1BpeGVsVmFsdWVzID0gZnVuY3Rpb24oZGF0YSwgVHlwZWRBcnJheUNsYXNzLCBtYXNrQml0c2V0LCBub0RhdGFWYWx1ZSwgc3RvcmVEZWNvZGVkTWFzaykgewogICAgICAgICAgICB2YXIgYmxvY2tJZHggPSAwOwogICAgICAgICAgICB2YXIgbnVtWCA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1g7CiAgICAgICAgICAgIHZhciBudW1ZID0gZGF0YS5waXhlbHMubnVtQmxvY2tzWTsKICAgICAgICAgICAgdmFyIGJsb2NrV2lkdGggPSBNYXRoLmZsb29yKGRhdGEud2lkdGggLyBudW1YKTsKICAgICAgICAgICAgdmFyIGJsb2NrSGVpZ2h0ID0gTWF0aC5mbG9vcihkYXRhLmhlaWdodCAvIG51bVkpOwogICAgICAgICAgICB2YXIgc2NhbGUgPSAyICogZGF0YS5tYXhaRXJyb3I7CiAgICAgICAgICAgIHZhciBtaW5WYWx1ZSA9IE51bWJlci5NQVhfVkFMVUUsIGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgbWFza0JpdHNldCA9IG1hc2tCaXRzZXQgfHwgKGRhdGEubWFzayA/IGRhdGEubWFzay5iaXRzZXQgOiBudWxsKTsKICAgICAgICAgICAgdmFyIHJlc3VsdFBpeGVscywgcmVzdWx0TWFzazsKICAgICAgICAgICAgcmVzdWx0UGl4ZWxzID0gbmV3IFR5cGVkQXJyYXlDbGFzcyhkYXRhLndpZHRoICogZGF0YS5oZWlnaHQpOwogICAgICAgICAgICBpZiAoc3RvcmVEZWNvZGVkTWFzayAmJiBtYXNrQml0c2V0KSB7CiAgICAgICAgICAgICAgcmVzdWx0TWFzayA9IG5ldyBVaW50OEFycmF5KGRhdGEud2lkdGggKiBkYXRhLmhlaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGJsb2NrRGF0YUJ1ZmZlciA9IG5ldyBGbG9hdDMyQXJyYXkoYmxvY2tXaWR0aCAqIGJsb2NrSGVpZ2h0KTsKICAgICAgICAgICAgdmFyIHh4LCB5eTsKICAgICAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPD0gbnVtWTsgeSsrKSB7CiAgICAgICAgICAgICAgdmFyIHRoaXNCbG9ja0hlaWdodCA9IHkgIT09IG51bVkgPyBibG9ja0hlaWdodCA6IGRhdGEuaGVpZ2h0ICUgbnVtWTsKICAgICAgICAgICAgICBpZiAodGhpc0Jsb2NrSGVpZ2h0ID09PSAwKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPD0gbnVtWDsgeCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhpc0Jsb2NrV2lkdGggPSB4ICE9PSBudW1YID8gYmxvY2tXaWR0aCA6IGRhdGEud2lkdGggJSBudW1YOwogICAgICAgICAgICAgICAgaWYgKHRoaXNCbG9ja1dpZHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dFB0ciA9IHkgKiBkYXRhLndpZHRoICogYmxvY2tIZWlnaHQgKyB4ICogYmxvY2tXaWR0aDsKICAgICAgICAgICAgICAgIHZhciBvdXRTdHJpZGUgPSBkYXRhLndpZHRoIC0gdGhpc0Jsb2NrV2lkdGg7CiAgICAgICAgICAgICAgICB2YXIgYmxvY2sgPSBkYXRhLnBpeGVscy5ibG9ja3NbYmxvY2tJZHhdOwogICAgICAgICAgICAgICAgdmFyIGJsb2NrRGF0YSwgYmxvY2tQdHIsIGNvbnN0VmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPCAyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJsb2NrRGF0YSA9IGJsb2NrLnJhd0RhdGE7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdW5zdHVmZihibG9jay5zdHVmZmVkRGF0YSwgYmxvY2suYml0c1BlclBpeGVsLCBibG9jay5udW1WYWxpZFBpeGVscywgYmxvY2sub2Zmc2V0LCBzY2FsZSwgYmxvY2tEYXRhQnVmZmVyLCBkYXRhLnBpeGVscy5tYXhWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tEYXRhID0gYmxvY2tEYXRhQnVmZmVyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJsb2NrUHRyID0gMDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgY29uc3RWYWx1ZSA9IDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb25zdFZhbHVlID0gYmxvY2sub2Zmc2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG1hc2tCeXRlOwogICAgICAgICAgICAgICAgaWYgKG1hc2tCaXRzZXQpIHsKICAgICAgICAgICAgICAgICAgZm9yICh5eSA9IDA7IHl5IDwgdGhpc0Jsb2NrSGVpZ2h0OyB5eSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG91dFB0ciAmIDcpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hc2tCeXRlID0gbWFza0JpdHNldFtvdXRQdHIgPj4gM107CiAgICAgICAgICAgICAgICAgICAgICBtYXNrQnl0ZSA8PD0gb3V0UHRyICYgNzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yICh4eCA9IDA7IHh4IDwgdGhpc0Jsb2NrV2lkdGg7IHh4KyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghKG91dFB0ciAmIDcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hc2tCeXRlID0gbWFza0JpdHNldFtvdXRQdHIgPj4gM107CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAobWFza0J5dGUgJiAxMjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdE1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRNYXNrW291dFB0cl0gPSAxOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGJsb2NrLmVuY29kaW5nIDwgMiA/IGJsb2NrRGF0YVtibG9ja1B0cisrXSA6IGNvbnN0VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pblZhbHVlID0gbWluVmFsdWUgPiBjdXJyZW50VmFsdWUgPyBjdXJyZW50VmFsdWUgOiBtaW5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cisrXSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRNYXNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0TWFza1tvdXRQdHJdID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyKytdID0gbm9EYXRhVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBtYXNrQnl0ZSA8PD0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nIDwgMikgewogICAgICAgICAgICAgICAgICAgIGZvciAoeXkgPSAwOyB5eSA8IHRoaXNCbG9ja0hlaWdodDsgeXkrKykgewogICAgICAgICAgICAgICAgICAgICAgZm9yICh4eCA9IDA7IHh4IDwgdGhpc0Jsb2NrV2lkdGg7IHh4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gYmxvY2tEYXRhW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICBtaW5WYWx1ZSA9IG1pblZhbHVlID4gY3VycmVudFZhbHVlID8gY3VycmVudFZhbHVlIDogbWluVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIgKz0gb3V0U3RyaWRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtaW5WYWx1ZSA9IG1pblZhbHVlID4gY29uc3RWYWx1ZSA/IGNvbnN0VmFsdWUgOiBtaW5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHl5ID0gMDsgeXkgPCB0aGlzQmxvY2tIZWlnaHQ7IHl5KyspIHsKICAgICAgICAgICAgICAgICAgICAgIGZvciAoeHggPSAwOyB4eCA8IHRoaXNCbG9ja1dpZHRoOyB4eCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSBjb25zdFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMSAmJiBibG9ja1B0ciAhPT0gYmxvY2subnVtVmFsaWRQaXhlbHMpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgIkJsb2NrIGFuZCBNYXNrIGRvIG5vdCBtYXRjaCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBibG9ja0lkeCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHJlc3VsdFBpeGVscywKICAgICAgICAgICAgICByZXN1bHRNYXNrLAogICAgICAgICAgICAgIG1pblZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZvcm1hdEZpbGVJbmZvID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICJmaWxlSWRlbnRpZmllclN0cmluZyI6IGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmcsCiAgICAgICAgICAgICAgImZpbGVWZXJzaW9uIjogZGF0YS5maWxlVmVyc2lvbiwKICAgICAgICAgICAgICAiaW1hZ2VUeXBlIjogZGF0YS5pbWFnZVR5cGUsCiAgICAgICAgICAgICAgImhlaWdodCI6IGRhdGEuaGVpZ2h0LAogICAgICAgICAgICAgICJ3aWR0aCI6IGRhdGEud2lkdGgsCiAgICAgICAgICAgICAgIm1heFpFcnJvciI6IGRhdGEubWF4WkVycm9yLAogICAgICAgICAgICAgICJlb2ZPZmZzZXQiOiBkYXRhLmVvZk9mZnNldCwKICAgICAgICAgICAgICAibWFzayI6IGRhdGEubWFzayA/IHsKICAgICAgICAgICAgICAgICJudW1CbG9ja3NYIjogZGF0YS5tYXNrLm51bUJsb2Nrc1gsCiAgICAgICAgICAgICAgICAibnVtQmxvY2tzWSI6IGRhdGEubWFzay5udW1CbG9ja3NZLAogICAgICAgICAgICAgICAgIm51bUJ5dGVzIjogZGF0YS5tYXNrLm51bUJ5dGVzLAogICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5tYXNrLm1heFZhbHVlCiAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgInBpeGVscyI6IHsKICAgICAgICAgICAgICAgICJudW1CbG9ja3NYIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWCwKICAgICAgICAgICAgICAgICJudW1CbG9ja3NZIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWSwKICAgICAgICAgICAgICAgICJudW1CeXRlcyI6IGRhdGEucGl4ZWxzLm51bUJ5dGVzLAogICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5waXhlbHMubWF4VmFsdWUsCiAgICAgICAgICAgICAgICAibm9EYXRhVmFsdWUiOiBkYXRhLm5vRGF0YVZhbHVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wdXRlVXNlZEJpdERlcHRocyA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgdmFyIG51bUJsb2NrcyA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1ggKiBkYXRhLnBpeGVscy5udW1CbG9ja3NZOwogICAgICAgICAgICB2YXIgYml0RGVwdGhzID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtQmxvY2tzOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgYmxvY2sgPSBkYXRhLnBpeGVscy5ibG9ja3NbaV07CiAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICBiaXREZXB0aHMuZmxvYXQzMiA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChibG9jay5lbmNvZGluZyA9PT0gMSkgewogICAgICAgICAgICAgICAgYml0RGVwdGhzW2Jsb2NrLmJpdHNQZXJQaXhlbF0gPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBiaXREZXB0aHNbMF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMoYml0RGVwdGhzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGFyc2UgPSBmdW5jdGlvbihpbnB1dCwgZnAsIHNraXBNYXNrKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0ge307CiAgICAgICAgICAgIHZhciBmaWxlSWRWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQsIGZwLCAxMCk7CiAgICAgICAgICAgIGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGZpbGVJZFZpZXcpOwogICAgICAgICAgICBpZiAoZGF0YS5maWxlSWRlbnRpZmllclN0cmluZy50cmltKCkgIT09ICJDbnRaSW1hZ2UiKSB7CiAgICAgICAgICAgICAgdGhyb3cgIlVuZXhwZWN0ZWQgZmlsZSBpZGVudGlmaWVyIHN0cmluZzogIiArIGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnAgKz0gMTA7CiAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBmcCwgMjQpOwogICAgICAgICAgICBkYXRhLmZpbGVWZXJzaW9uID0gdmlldy5nZXRJbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgZGF0YS5pbWFnZVR5cGUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICBkYXRhLmhlaWdodCA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICBkYXRhLndpZHRoID0gdmlldy5nZXRVaW50MzIoMTIsIHRydWUpOwogICAgICAgICAgICBkYXRhLm1heFpFcnJvciA9IHZpZXcuZ2V0RmxvYXQ2NCgxNiwgdHJ1ZSk7CiAgICAgICAgICAgIGZwICs9IDI0OwogICAgICAgICAgICBpZiAoIXNraXBNYXNrKSB7CiAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZnAsIDE2KTsKICAgICAgICAgICAgICBkYXRhLm1hc2sgPSB7fTsKICAgICAgICAgICAgICBkYXRhLm1hc2subnVtQmxvY2tzWSA9IHZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgICAgICAgIGRhdGEubWFzay5udW1CbG9ja3NYID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgZGF0YS5tYXNrLm51bUJ5dGVzID0gdmlldy5nZXRVaW50MzIoOCwgdHJ1ZSk7CiAgICAgICAgICAgICAgZGF0YS5tYXNrLm1heFZhbHVlID0gdmlldy5nZXRGbG9hdDMyKDEyLCB0cnVlKTsKICAgICAgICAgICAgICBmcCArPSAxNjsKICAgICAgICAgICAgICBpZiAoZGF0YS5tYXNrLm51bUJ5dGVzID4gMCkgewogICAgICAgICAgICAgICAgdmFyIGJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChkYXRhLndpZHRoICogZGF0YS5oZWlnaHQgLyA4KSk7CiAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBmcCwgZGF0YS5tYXNrLm51bUJ5dGVzKTsKICAgICAgICAgICAgICAgIHZhciBjbnQgPSB2aWV3LmdldEludDE2KDAsIHRydWUpOwogICAgICAgICAgICAgICAgdmFyIGlwID0gMiwgb3AgPSAwOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBpZiAoY250ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChjbnQtLSkgewogICAgICAgICAgICAgICAgICAgICAgYml0c2V0W29wKytdID0gdmlldy5nZXRVaW50OChpcCsrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IHZpZXcuZ2V0VWludDgoaXArKyk7CiAgICAgICAgICAgICAgICAgICAgY250ID0gLWNudDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY250LS0pIHsKICAgICAgICAgICAgICAgICAgICAgIGJpdHNldFtvcCsrXSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY250ID0gdmlldy5nZXRJbnQxNihpcCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGlwICs9IDI7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChpcCA8IGRhdGEubWFzay5udW1CeXRlcyk7CiAgICAgICAgICAgICAgICBpZiAoY250ICE9PSAtMzI3NjggfHwgb3AgPCBiaXRzZXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJVbmV4cGVjdGVkIGVuZCBvZiBtYXNrIFJMRSBlbmNvZGluZyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRhLm1hc2suYml0c2V0ID0gYml0c2V0OwogICAgICAgICAgICAgICAgZnAgKz0gZGF0YS5tYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGRhdGEubWFzay5udW1CeXRlcyB8IGRhdGEubWFzay5udW1CbG9ja3NZIHwgZGF0YS5tYXNrLm1heFZhbHVlKSA9PT0gMCkgewogICAgICAgICAgICAgICAgZGF0YS5tYXNrLmJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChkYXRhLndpZHRoICogZGF0YS5oZWlnaHQgLyA4KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIGZwLCAxNik7CiAgICAgICAgICAgIGRhdGEucGl4ZWxzID0ge307CiAgICAgICAgICAgIGRhdGEucGl4ZWxzLm51bUJsb2Nrc1kgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgZGF0YS5waXhlbHMubnVtQmxvY2tzWCA9IHZpZXcuZ2V0VWludDMyKDQsIHRydWUpOwogICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CeXRlcyA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICBkYXRhLnBpeGVscy5tYXhWYWx1ZSA9IHZpZXcuZ2V0RmxvYXQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgIGZwICs9IDE2OwogICAgICAgICAgICB2YXIgbnVtQmxvY2tzWCA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1g7CiAgICAgICAgICAgIHZhciBudW1CbG9ja3NZID0gZGF0YS5waXhlbHMubnVtQmxvY2tzWTsKICAgICAgICAgICAgdmFyIGFjdHVhbE51bUJsb2Nrc1ggPSBudW1CbG9ja3NYICsgKGRhdGEud2lkdGggJSBudW1CbG9ja3NYID4gMCA/IDEgOiAwKTsKICAgICAgICAgICAgdmFyIGFjdHVhbE51bUJsb2Nrc1kgPSBudW1CbG9ja3NZICsgKGRhdGEuaGVpZ2h0ICUgbnVtQmxvY2tzWSA+IDAgPyAxIDogMCk7CiAgICAgICAgICAgIGRhdGEucGl4ZWxzLmJsb2NrcyA9IG5ldyBBcnJheShhY3R1YWxOdW1CbG9ja3NYICogYWN0dWFsTnVtQmxvY2tzWSk7CiAgICAgICAgICAgIHZhciBibG9ja0kgPSAwOwogICAgICAgICAgICBmb3IgKHZhciBibG9ja1kgPSAwOyBibG9ja1kgPCBhY3R1YWxOdW1CbG9ja3NZOyBibG9ja1krKykgewogICAgICAgICAgICAgIGZvciAodmFyIGJsb2NrWCA9IDA7IGJsb2NrWCA8IGFjdHVhbE51bUJsb2Nrc1g7IGJsb2NrWCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgc2l6ZSA9IDA7CiAgICAgICAgICAgICAgICB2YXIgYnl0ZXNMZWZ0ID0gaW5wdXQuYnl0ZUxlbmd0aCAtIGZwOwogICAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZnAsIE1hdGgubWluKDEwLCBieXRlc0xlZnQpKTsKICAgICAgICAgICAgICAgIHZhciBibG9jayA9IHt9OwogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMuYmxvY2tzW2Jsb2NrSSsrXSA9IGJsb2NrOwogICAgICAgICAgICAgICAgdmFyIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgICAgICAgYmxvY2suZW5jb2RpbmcgPSBoZWFkZXJCeXRlICYgNjM7CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPiAzKSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGJsb2NrIGVuY29kaW5nICgiICsgYmxvY2suZW5jb2RpbmcgKyAiKSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgZnArKzsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSAhPT0gMCAmJiBoZWFkZXJCeXRlICE9PSAyKSB7CiAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPj49IDY7CiAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldFR5cGUgPSBoZWFkZXJCeXRlOwogICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldCA9IHZpZXcuZ2V0SW50OCgxKTsKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVhZGVyQnl0ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldCA9IHZpZXcuZ2V0SW50MTYoMSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSArPSAyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWRlckJ5dGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBibG9jay5vZmZzZXQgPSB2aWV3LmdldEZsb2F0MzIoMSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSArPSA0OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGJsb2NrIG9mZnNldCB0eXBlIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBoZWFkZXJCeXRlID0gdmlldy5nZXRVaW50OChzaXplKTsKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgICAgICAgICAgYmxvY2suYml0c1BlclBpeGVsID0gaGVhZGVyQnl0ZSAmIDYzOwogICAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPj49IDY7CiAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHNUeXBlID0gaGVhZGVyQnl0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHMgPSB2aWV3LmdldFVpbnQ4KHNpemUpOwogICAgICAgICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVhZGVyQnl0ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHMgPSB2aWV3LmdldFVpbnQxNihzaXplLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgIHNpemUgKz0gMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWRlckJ5dGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJsb2NrLm51bVZhbGlkUGl4ZWxzID0gdmlldy5nZXRVaW50MzIoc2l6ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICBzaXplICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIHZhbGlkIHBpeGVsIGNvdW50IHR5cGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZnAgKz0gc2l6ZTsKICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMykgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBhcnJheUJ1Ziwgc3RvcmU4OwogICAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSAoZGF0YS5waXhlbHMubnVtQnl0ZXMgLSAxKSAvIDQ7CiAgICAgICAgICAgICAgICAgIGlmIChudW1QaXhlbHMgIT09IE1hdGguZmxvb3IobnVtUGl4ZWxzKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJ1bmNvbXByZXNzZWQgYmxvY2sgaGFzIGludmFsaWQgbGVuZ3RoIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1QaXhlbHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBmcCwgbnVtUGl4ZWxzICogNCkpOwogICAgICAgICAgICAgICAgICB2YXIgcmF3RGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBibG9jay5yYXdEYXRhID0gcmF3RGF0YTsKICAgICAgICAgICAgICAgICAgZnAgKz0gbnVtUGl4ZWxzICogNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgdmFyIGRhdGFCeXRlcyA9IE1hdGguY2VpbChibG9jay5udW1WYWxpZFBpeGVscyAqIGJsb2NrLmJpdHNQZXJQaXhlbCAvIDgpOwogICAgICAgICAgICAgICAgICB2YXIgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBmcCwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgIGJsb2NrLnN0dWZmZWREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZnAgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkYXRhLmVvZk9mZnNldCA9IGZwOwogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdW5zdHVmZiA9IGZ1bmN0aW9uKHNyYywgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIG9mZnNldCwgc2NhbGUsIGRlc3QsIG1heFZhbHVlKSB7CiAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgdmFyIGJpdHNMZWZ0ID0gMDsKICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlcjsKICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgdmFyIG51bUludmFsaWRUYWlsQnl0ZXMgPSBzcmMubGVuZ3RoICogNCAtIE1hdGguY2VpbChiaXRzUGVyUGl4ZWwgKiBudW1QaXhlbHMgLyA4KTsKICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgIGZvciAobyA9IDA7IG8gPCBudW1QaXhlbHM7IG8rKykgewogICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRzTGVmdCAtIGJpdHNQZXJQaXhlbCAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlc3Q7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIENudFpJbWFnZTsKICAgICAgICB9KCk7CiAgICAgICAgdmFyIExlcmMyRGVjb2RlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgICB2YXIgQml0U3R1ZmZlciA9IHsKICAgICAgICAgICAgLy9tZXRob2RzIGVuZGluZyB3aXRoIDIgYXJlIGZvciB0aGUgbmV3IGJ5dGUgb3JkZXIgdXNlZCBieSBMZXJjMi4zIGFuZCBhYm92ZS4KICAgICAgICAgICAgLy9vcmlnaW5hbFVuc3R1ZmYgaXMgdXNlZCB0byB1bnBhY2sgSHVmZm1hbiBjb2RlIHRhYmxlLiBjb2RlIGlzIGR1cGxpY2F0ZWQgdG8gdW5zdHVmZnggZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMuCiAgICAgICAgICAgIHVuc3R1ZmY6IGZ1bmN0aW9uKHNyYywgZGVzdCwgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIGx1dEFyciwgb2Zmc2V0LCBzY2FsZSwgbWF4VmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgICB2YXIgYml0c0xlZnQgPSAwOwogICAgICAgICAgICAgIHZhciBuLCBidWZmZXIsIG1pc3NpbmdCaXRzLCBubWF4OwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgaWYgKGx1dEFycikgewogICAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGJpdHNMZWZ0ID49IGJpdHNQZXJQaXhlbCkgewogICAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdHNMZWZ0IC0gYml0c1BlclBpeGVsICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgICBuID0gKGJ1ZmZlciAmIGJpdE1hc2spIDw8IG1pc3NpbmdCaXRzICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgbiArPSBidWZmZXIgPj4+IGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBsdXRBcnJbbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICAgIGZvciAobyA9IDA7IG8gPCBudW1QaXhlbHM7IG8rKykgewogICAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRzTGVmdCAtIGJpdHNQZXJQaXhlbCAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMiAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZXN0W29dID0gbiA8IG5tYXggPyBvZmZzZXQgKyBuICogc2NhbGUgOiBtYXhWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3R1ZmZMVVQ6IGZ1bmN0aW9uKHNyYywgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIG9mZnNldCwgc2NhbGUsIG1heFZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIGJpdE1hc2sgPSAoMSA8PCBiaXRzUGVyUGl4ZWwpIC0gMTsKICAgICAgICAgICAgICB2YXIgaSA9IDAsIG8gPSAwLCBtaXNzaW5nQml0cyA9IDAsIGJpdHNMZWZ0ID0gMCwgbiA9IDA7CiAgICAgICAgICAgICAgdmFyIGJ1ZmZlcjsKICAgICAgICAgICAgICB2YXIgZGVzdCA9IFtdOwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0c0xlZnQgLSBiaXRzUGVyUGl4ZWwgJiBiaXRNYXNrOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICBuID0gKGJ1ZmZlciAmIGJpdE1hc2spIDw8IG1pc3NpbmdCaXRzICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgICAgbiArPSBidWZmZXIgPj4+IGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlc3QudW5zaGlmdChvZmZzZXQpOwogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0dWZmMjogZnVuY3Rpb24oc3JjLCBkZXN0LCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscywgbHV0QXJyLCBvZmZzZXQsIHNjYWxlLCBtYXhWYWx1ZSkgewogICAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBvOwogICAgICAgICAgICAgIHZhciBiaXRzTGVmdCA9IDAsIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlciwgbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgaWYgKGx1dEFycikgewogICAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMiAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIG4gfD0gKGJ1ZmZlciAmICgxIDw8IG1pc3NpbmdCaXRzKSAtIDEpIDw8IGJpdHNQZXJQaXhlbCAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBsdXRBcnJbbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBubWF4ID0gTWF0aC5jZWlsKChtYXhWYWx1ZSAtIG9mZnNldCkgLyBzY2FsZSk7CiAgICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGJpdHNMZWZ0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSAwOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRQb3MgJiBiaXRNYXNrOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0IC09IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgbiB8PSAoYnVmZmVyICYgKDEgPDwgbWlzc2luZ0JpdHMpIC0gMSkgPDwgYml0c1BlclBpeGVsIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zID0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0dWZmTFVUMjogZnVuY3Rpb24oc3JjLCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscywgb2Zmc2V0LCBzY2FsZSwgbWF4VmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbyA9IDAsIG1pc3NpbmdCaXRzID0gMCwgYml0c0xlZnQgPSAwLCBuID0gMCwgYml0UG9zID0gMDsKICAgICAgICAgICAgICB2YXIgYnVmZmVyOwogICAgICAgICAgICAgIHZhciBkZXN0ID0gW107CiAgICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgICAgbiB8PSAoYnVmZmVyICYgKDEgPDwgbWlzc2luZ0JpdHMpIC0gMSkgPDwgYml0c1BlclBpeGVsIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlc3QudW5zaGlmdChvZmZzZXQpOwogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBvcmlnaW5hbFVuc3R1ZmY6IGZ1bmN0aW9uKHNyYywgZGVzdCwgYml0c1BlclBpeGVsLCBudW1QaXhlbHMpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgICB2YXIgYml0c0xlZnQgPSAwOwogICAgICAgICAgICAgIHZhciBuLCBidWZmZXIsIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdHNMZWZ0IC0gYml0c1BlclBpeGVsICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3JpZ2luYWxVbnN0dWZmMjogZnVuY3Rpb24oc3JjLCBkZXN0LCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscykgewogICAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBvOwogICAgICAgICAgICAgIHZhciBiaXRzTGVmdCA9IDAsIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlciwgbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0IC09IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIG4gfD0gKGJ1ZmZlciAmICgxIDw8IG1pc3NpbmdCaXRzKSAtIDEpIDw8IGJpdHNQZXJQaXhlbCAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICBiaXRQb3MgPSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBMZXJjMkhlbHBlcnMgPSB7CiAgICAgICAgICAgIEhVRkZNQU5fTFVUX0JJVFNfTUFYOiAxMiwKICAgICAgICAgICAgLy91c2UgMl4xMiBsdXQsIHRyZWF0IGl0IGxpa2UgY29uc3RhbnQKICAgICAgICAgICAgY29tcHV0ZUNoZWNrc3VtRmxldGNoZXIzMjogZnVuY3Rpb24oaW5wdXQpIHsKICAgICAgICAgICAgICB2YXIgc3VtMSA9IDY1NTM1LCBzdW0yID0gNjU1MzU7CiAgICAgICAgICAgICAgdmFyIGxlbiA9IGlucHV0Lmxlbmd0aDsKICAgICAgICAgICAgICB2YXIgd29yZHMgPSBNYXRoLmZsb29yKGxlbiAvIDIpOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB3aGlsZSAod29yZHMpIHsKICAgICAgICAgICAgICAgIHZhciB0bGVuID0gd29yZHMgPj0gMzU5ID8gMzU5IDogd29yZHM7CiAgICAgICAgICAgICAgICB3b3JkcyAtPSB0bGVuOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBzdW0xICs9IGlucHV0W2krK10gPDwgODsKICAgICAgICAgICAgICAgICAgc3VtMiArPSBzdW0xICs9IGlucHV0W2krK107CiAgICAgICAgICAgICAgICB9IHdoaWxlICgtLXRsZW4pOwogICAgICAgICAgICAgICAgc3VtMSA9IChzdW0xICYgNjU1MzUpICsgKHN1bTEgPj4+IDE2KTsKICAgICAgICAgICAgICAgIHN1bTIgPSAoc3VtMiAmIDY1NTM1KSArIChzdW0yID4+PiAxNik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsZW4gJiAxKSB7CiAgICAgICAgICAgICAgICBzdW0yICs9IHN1bTEgKz0gaW5wdXRbaV0gPDwgODsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3VtMSA9IChzdW0xICYgNjU1MzUpICsgKHN1bTEgPj4+IDE2KTsKICAgICAgICAgICAgICBzdW0yID0gKHN1bTIgJiA2NTUzNSkgKyAoc3VtMiA+Pj4gMTYpOwogICAgICAgICAgICAgIHJldHVybiAoc3VtMiA8PCAxNiB8IHN1bTEpID4+PiAwOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSGVhZGVySW5mbzogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGZpbGVJZFZpZXcgPSBuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCA2KTsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IHt9OwogICAgICAgICAgICAgIGhlYWRlckluZm8uZmlsZUlkZW50aWZpZXJTdHJpbmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGZpbGVJZFZpZXcpOwogICAgICAgICAgICAgIGlmIChoZWFkZXJJbmZvLmZpbGVJZGVudGlmaWVyU3RyaW5nLmxhc3RJbmRleE9mKCJMZXJjMiIsIDApICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiVW5leHBlY3RlZCBmaWxlIGlkZW50aWZpZXIgc3RyaW5nIChleHBlY3QgTGVyYzIgKTogIiArIGhlYWRlckluZm8uZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB0ciArPSA2OwogICAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBwdHIsIDgpOwogICAgICAgICAgICAgIHZhciBmaWxlVmVyc2lvbiA9IHZpZXcuZ2V0SW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5maWxlVmVyc2lvbiA9IGZpbGVWZXJzaW9uOwogICAgICAgICAgICAgIHB0ciArPSA0OwogICAgICAgICAgICAgIGlmIChmaWxlVmVyc2lvbiA+PSAzKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJJbmZvLmNoZWNrc3VtID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBwdHIgKz0gNDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgcHRyLCAxMik7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5oZWlnaHQgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgICBoZWFkZXJJbmZvLndpZHRoID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgcHRyICs9IDg7CiAgICAgICAgICAgICAgaWYgKGZpbGVWZXJzaW9uID49IDQpIHsKICAgICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtRGltcyA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICAgICAgcHRyICs9IDQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtRGltcyA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIHB0ciwgNDApOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbCA9IHZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubWljcm9CbG9ja1NpemUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uYmxvYlNpemUgPSB2aWV3LmdldEludDMyKDgsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uaW1hZ2VUeXBlID0gdmlldy5nZXRJbnQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5tYXhaRXJyb3IgPSB2aWV3LmdldEZsb2F0NjQoMTYsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uek1pbiA9IHZpZXcuZ2V0RmxvYXQ2NCgyNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby56TWF4ID0gdmlldy5nZXRGbG9hdDY0KDMyLCB0cnVlKTsKICAgICAgICAgICAgICBwdHIgKz0gNDA7CiAgICAgICAgICAgICAgZGF0YS5oZWFkZXJJbmZvID0gaGVhZGVySW5mbzsKICAgICAgICAgICAgICBkYXRhLnB0ciA9IHB0cjsKICAgICAgICAgICAgICB2YXIgY2hlY2tzdW0sIGtleUxlbmd0aDsKICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAga2V5TGVuZ3RoID0gZmlsZVZlcnNpb24gPj0gNCA/IDUyIDogNDg7CiAgICAgICAgICAgICAgICBjaGVja3N1bSA9IHRoaXMuY29tcHV0ZUNoZWNrc3VtRmxldGNoZXIzMihuZXcgVWludDhBcnJheShpbnB1dCwgcHRyIC0ga2V5TGVuZ3RoLCBoZWFkZXJJbmZvLmJsb2JTaXplIC0gMTQpKTsKICAgICAgICAgICAgICAgIGlmIChjaGVja3N1bSAhPT0gaGVhZGVySW5mby5jaGVja3N1bSkgewogICAgICAgICAgICAgICAgICB0aHJvdyAiQ2hlY2tzdW0gZmFpbGVkLiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGVja01pbk1heFJhbmdlczogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgT3V0UGl4ZWxUeXBlQXJyYXkgPSB0aGlzLmdldERhdGFUeXBlQXJyYXkoaGVhZGVySW5mby5pbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciByYW5nZUJ5dGVzID0gaGVhZGVySW5mby5udW1EaW1zICogdGhpcy5nZXREYXRhVHlwZVNpemUoaGVhZGVySW5mby5pbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciBtaW5WYWx1ZXMgPSB0aGlzLnJlYWRTdWJBcnJheShpbnB1dCwgZGF0YS5wdHIsIE91dFBpeGVsVHlwZUFycmF5LCByYW5nZUJ5dGVzKTsKICAgICAgICAgICAgICB2YXIgbWF4VmFsdWVzID0gdGhpcy5yZWFkU3ViQXJyYXkoaW5wdXQsIGRhdGEucHRyICsgcmFuZ2VCeXRlcywgT3V0UGl4ZWxUeXBlQXJyYXksIHJhbmdlQnl0ZXMpOwogICAgICAgICAgICAgIGRhdGEucHRyICs9IDIgKiByYW5nZUJ5dGVzOwogICAgICAgICAgICAgIHZhciBpLCBlcXVhbCA9IHRydWU7CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGhlYWRlckluZm8ubnVtRGltczsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobWluVmFsdWVzW2ldICE9PSBtYXhWYWx1ZXNbaV0pIHsKICAgICAgICAgICAgICAgICAgZXF1YWwgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhlYWRlckluZm8ubWluVmFsdWVzID0gbWluVmFsdWVzOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubWF4VmFsdWVzID0gbWF4VmFsdWVzOwogICAgICAgICAgICAgIHJldHVybiBlcXVhbDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVhZFN1YkFycmF5OiBmdW5jdGlvbihpbnB1dCwgcHRyLCBPdXRQaXhlbFR5cGVBcnJheSwgbnVtQnl0ZXMpIHsKICAgICAgICAgICAgICB2YXIgcmF3RGF0YTsKICAgICAgICAgICAgICBpZiAoT3V0UGl4ZWxUeXBlQXJyYXkgPT09IFVpbnQ4QXJyYXkpIHsKICAgICAgICAgICAgICAgIHJhd0RhdGEgPSBuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCBudW1CeXRlcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1CeXRlcyk7CiAgICAgICAgICAgICAgICB2YXIgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCBudW1CeXRlcykpOwogICAgICAgICAgICAgICAgcmF3RGF0YSA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShhcnJheUJ1Zik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByYXdEYXRhOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkTWFzazogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgbnVtVmFsaWRQaXhlbCA9IGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbDsKICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgcHRyLCA0KTsKICAgICAgICAgICAgICB2YXIgbWFzayA9IHt9OwogICAgICAgICAgICAgIG1hc2subnVtQnl0ZXMgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgICBwdHIgKz0gNDsKICAgICAgICAgICAgICBpZiAoKDAgPT09IG51bVZhbGlkUGl4ZWwgfHwgbnVtUGl4ZWxzID09PSBudW1WYWxpZFBpeGVsKSAmJiAwICE9PSBtYXNrLm51bUJ5dGVzKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiaW52YWxpZCBtYXNrIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJpdHNldCwgcmVzdWx0TWFzazsKICAgICAgICAgICAgICBpZiAobnVtVmFsaWRQaXhlbCA9PT0gMCkgewogICAgICAgICAgICAgICAgYml0c2V0ID0gbmV3IFVpbnQ4QXJyYXkoTWF0aC5jZWlsKG51bVBpeGVscyAvIDgpKTsKICAgICAgICAgICAgICAgIG1hc2suYml0c2V0ID0gYml0c2V0OwogICAgICAgICAgICAgICAgcmVzdWx0TWFzayA9IG5ldyBVaW50OEFycmF5KG51bVBpeGVscyk7CiAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRNYXNrID0gcmVzdWx0TWFzazsKICAgICAgICAgICAgICAgIHB0ciArPSBtYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobWFzay5udW1CeXRlcyA+IDApIHsKICAgICAgICAgICAgICAgIGJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChudW1QaXhlbHMgLyA4KSk7CiAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBwdHIsIG1hc2subnVtQnl0ZXMpOwogICAgICAgICAgICAgICAgdmFyIGNudCA9IHZpZXcuZ2V0SW50MTYoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB2YXIgaXAgPSAyLCBvcCA9IDAsIHZhbCA9IDA7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIGlmIChjbnQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNudC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzZXRbb3ArK10gPSB2aWV3LmdldFVpbnQ4KGlwKyspOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2aWV3LmdldFVpbnQ4KGlwKyspOwogICAgICAgICAgICAgICAgICAgIGNudCA9IC1jbnQ7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNudC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzZXRbb3ArK10gPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNudCA9IHZpZXcuZ2V0SW50MTYoaXAsIHRydWUpOwogICAgICAgICAgICAgICAgICBpcCArPSAyOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoaXAgPCBtYXNrLm51bUJ5dGVzKTsKICAgICAgICAgICAgICAgIGlmIChjbnQgIT09IC0zMjc2OCB8fCBvcCA8IGJpdHNldC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgIlVuZXhwZWN0ZWQgZW5kIG9mIG1hc2sgUkxFIGVuY29kaW5nIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc3VsdE1hc2sgPSBuZXcgVWludDhBcnJheShudW1QaXhlbHMpOwogICAgICAgICAgICAgICAgdmFyIG1iID0gMCwgayA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbnVtUGl4ZWxzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGsgJiA3KSB7CiAgICAgICAgICAgICAgICAgICAgbWIgPSBiaXRzZXRbayA+PiAzXTsKICAgICAgICAgICAgICAgICAgICBtYiA8PD0gayAmIDc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWIgPSBiaXRzZXRbayA+PiAzXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobWIgJiAxMjgpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRNYXNrW2tdID0gMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0TWFzayA9IHJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgICBtYXNrLmJpdHNldCA9IGJpdHNldDsKICAgICAgICAgICAgICAgIHB0ciArPSBtYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhLnB0ciA9IHB0cjsKICAgICAgICAgICAgICBkYXRhLm1hc2sgPSBtYXNrOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkRGF0YU9uZVN3ZWVwOiBmdW5jdGlvbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bURpbXMgPSBoZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgaW1hZ2VUeXBlID0gaGVhZGVySW5mby5pbWFnZVR5cGU7CiAgICAgICAgICAgICAgdmFyIG51bUJ5dGVzID0gaGVhZGVySW5mby5udW1WYWxpZFBpeGVsICogTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShpbWFnZVR5cGUpICogbnVtRGltczsKICAgICAgICAgICAgICB2YXIgcmF3RGF0YTsKICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgaWYgKE91dFBpeGVsVHlwZUFycmF5ID09PSBVaW50OEFycmF5KSB7CiAgICAgICAgICAgICAgICByYXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQsIHB0ciwgbnVtQnl0ZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXlCdWYgPSBuZXcgQXJyYXlCdWZmZXIobnVtQnl0ZXMpOwogICAgICAgICAgICAgICAgdmFyIHN0b3JlOCA9IG5ldyBVaW50OEFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgIHN0b3JlOC5zZXQobmV3IFVpbnQ4QXJyYXkoaW5wdXQsIHB0ciwgbnVtQnl0ZXMpKTsKICAgICAgICAgICAgICAgIHJhd0RhdGEgPSBuZXcgT3V0UGl4ZWxUeXBlQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmF3RGF0YS5sZW5ndGggPT09IG51bVBpeGVscyAqIG51bURpbXMpIHsKICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVscyA9IHJhd0RhdGE7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVscyA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShudW1QaXhlbHMgKiBudW1EaW1zKTsKICAgICAgICAgICAgICAgIHZhciB6ID0gMCwgayA9IDAsIGkgPSAwLCBuU3RhcnQgPSAwOwogICAgICAgICAgICAgICAgaWYgKG51bURpbXMgPiAxKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1EaW1zOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBuU3RhcnQgPSBpICogbnVtUGl4ZWxzOwogICAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1QaXhlbHM7IGsrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tba10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzW25TdGFydCArIGtdID0gcmF3RGF0YVt6KytdOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG51bVBpeGVsczsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tba10pIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVsc1trXSA9IHJhd0RhdGFbeisrXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHRyICs9IG51bUJ5dGVzOwogICAgICAgICAgICAgIGRhdGEucHRyID0gcHRyOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSHVmZm1hblRyZWU6IGZ1bmN0aW9uKGlucHV0LCBkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIEJJVFNfTUFYID0gdGhpcy5IVUZGTUFOX0xVVF9CSVRTX01BWDsKICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZGF0YS5wdHIsIDE2KTsKICAgICAgICAgICAgICBkYXRhLnB0ciArPSAxNjsKICAgICAgICAgICAgICB2YXIgdmVyc2lvbiA9IHZpZXcuZ2V0SW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKHZlcnNpb24gPCAyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAidW5zdXBwb3J0ZWQgSHVmZm1hbiB2ZXJzaW9uIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNpemUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICAgIHZhciBpMCA9IHZpZXcuZ2V0SW50MzIoOCwgdHJ1ZSk7CiAgICAgICAgICAgICAgdmFyIGkxID0gdmlldy5nZXRJbnQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKGkwID49IGkxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBibG9ja0RhdGFCdWZmZXIgPSBuZXcgVWludDMyQXJyYXkoaTEgLSBpMCk7CiAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLmRlY29kZUJpdHMoaW5wdXQsIGRhdGEsIGJsb2NrRGF0YUJ1ZmZlcik7CiAgICAgICAgICAgICAgdmFyIGNvZGVUYWJsZSA9IFtdOwogICAgICAgICAgICAgIHZhciBpLCBqLCBrLCBsZW47CiAgICAgICAgICAgICAgZm9yIChpID0gaTA7IGkgPCBpMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBqID0gaSAtIChpIDwgc2l6ZSA/IDAgOiBzaXplKTsKICAgICAgICAgICAgICAgIGNvZGVUYWJsZVtqXSA9IHsgZmlyc3Q6IGJsb2NrRGF0YUJ1ZmZlcltpIC0gaTBdLCBzZWNvbmQ6IG51bGwgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRhdGFCeXRlcyA9IGlucHV0LmJ5dGVMZW5ndGggLSBkYXRhLnB0cjsKICAgICAgICAgICAgICB2YXIgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgIHZhciBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICB2YXIgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIHN0b3JlOC5zZXQobmV3IFVpbnQ4QXJyYXkoaW5wdXQsIGRhdGEucHRyLCBkYXRhQnl0ZXMpKTsKICAgICAgICAgICAgICB2YXIgc3R1ZmZlZERhdGEgPSBuZXcgVWludDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIHZhciBiaXRQb3MgPSAwLCB3b3JkLCBzcmNQdHIgPSAwOwogICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVswXTsKICAgICAgICAgICAgICBmb3IgKGkgPSBpMDsgaSA8IGkxOyBpKyspIHsKICAgICAgICAgICAgICAgIGogPSBpIC0gKGkgPCBzaXplID8gMCA6IHNpemUpOwogICAgICAgICAgICAgICAgbGVuID0gY29kZVRhYmxlW2pdLmZpcnN0OwogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgY29kZVRhYmxlW2pdLnNlY29uZCA9IHdvcmQgPDwgYml0UG9zID4+PiAzMiAtIGxlbjsKICAgICAgICAgICAgICAgICAgaWYgKDMyIC0gYml0UG9zID49IGxlbikgewogICAgICAgICAgICAgICAgICAgIGJpdFBvcyArPSBsZW47CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpdFBvcyA9PT0gMzIpIHsKICAgICAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICBzcmNQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gbGVuIC0gMzI7CiAgICAgICAgICAgICAgICAgICAgc3JjUHRyKys7CiAgICAgICAgICAgICAgICAgICAgd29yZCA9IHN0dWZmZWREYXRhW3NyY1B0cl07CiAgICAgICAgICAgICAgICAgICAgY29kZVRhYmxlW2pdLnNlY29uZCB8PSB3b3JkID4+PiAzMiAtIGJpdFBvczsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbnVtQml0c0xVVCA9IDAsIG51bUJpdHNMVVRRaWNrID0gMDsKICAgICAgICAgICAgICB2YXIgdHJlZSA9IG5ldyBUcmVlTm9kZSgpOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb2RlVGFibGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChjb2RlVGFibGVbaV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBudW1CaXRzTFVUID0gTWF0aC5tYXgobnVtQml0c0xVVCwgY29kZVRhYmxlW2ldLmZpcnN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG51bUJpdHNMVVQgPj0gQklUU19NQVgpIHsKICAgICAgICAgICAgICAgIG51bUJpdHNMVVRRaWNrID0gQklUU19NQVg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG51bUJpdHNMVVRRaWNrID0gbnVtQml0c0xVVDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG51bUJpdHNMVVQgPj0gMzApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJXQVJuaW5nLCBsYXJnZSBOVU0gTFVUIEJJVFMgSVMgIiArIG51bUJpdHNMVVQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZGVjb2RlTHV0ID0gW10sIGVudHJ5LCBjb2RlLCBudW1FbnRyaWVzLCBqaiwgY3VycmVudEJpdCwgbm9kZTsKICAgICAgICAgICAgICBmb3IgKGkgPSBpMDsgaSA8IGkxOyBpKyspIHsKICAgICAgICAgICAgICAgIGogPSBpIC0gKGkgPCBzaXplID8gMCA6IHNpemUpOwogICAgICAgICAgICAgICAgbGVuID0gY29kZVRhYmxlW2pdLmZpcnN0OwogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgZW50cnkgPSBbbGVuLCBqXTsKICAgICAgICAgICAgICAgICAgaWYgKGxlbiA8PSBudW1CaXRzTFVUUWljaykgewogICAgICAgICAgICAgICAgICAgIGNvZGUgPSBjb2RlVGFibGVbal0uc2Vjb25kIDw8IG51bUJpdHNMVVRRaWNrIC0gbGVuOwogICAgICAgICAgICAgICAgICAgIG51bUVudHJpZXMgPSAxIDw8IG51bUJpdHNMVVRRaWNrIC0gbGVuOwogICAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1FbnRyaWVzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGRlY29kZUx1dFtjb2RlIHwga10gPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGVUYWJsZVtqXS5zZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHRyZWU7CiAgICAgICAgICAgICAgICAgICAgZm9yIChqaiA9IGxlbiAtIDE7IGpqID49IDA7IGpqLS0pIHsKICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCaXQgPSBjb2RlID4+PiBqaiAmIDE7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEJpdCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUucmlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJpZ2h0ID0gbmV3IFRyZWVOb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUubGVmdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubGVmdCA9IG5ldyBUcmVlTm9kZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmxlZnQ7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoamogPT09IDAgJiYgIW5vZGUudmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUudmFsID0gZW50cnlbMV07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBkZWNvZGVMdXQsCiAgICAgICAgICAgICAgICBudW1CaXRzTFVUUWljaywKICAgICAgICAgICAgICAgIG51bUJpdHNMVVQsCiAgICAgICAgICAgICAgICB0cmVlLAogICAgICAgICAgICAgICAgc3R1ZmZlZERhdGEsCiAgICAgICAgICAgICAgICBzcmNQdHIsCiAgICAgICAgICAgICAgICBiaXRQb3MKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSHVmZm1hbjogZnVuY3Rpb24oaW5wdXQsIGRhdGEsIE91dFBpeGVsVHlwZUFycmF5KSB7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bURpbXMgPSBoZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IGRhdGEuaGVhZGVySW5mby5oZWlnaHQ7CiAgICAgICAgICAgICAgdmFyIHdpZHRoID0gZGF0YS5oZWFkZXJJbmZvLndpZHRoOwogICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSB3aWR0aCAqIGhlaWdodDsKICAgICAgICAgICAgICB2YXIgaHVmZm1hbkluZm8gPSB0aGlzLnJlYWRIdWZmbWFuVHJlZShpbnB1dCwgZGF0YSk7CiAgICAgICAgICAgICAgdmFyIGRlY29kZUx1dCA9IGh1ZmZtYW5JbmZvLmRlY29kZUx1dDsKICAgICAgICAgICAgICB2YXIgdHJlZSA9IGh1ZmZtYW5JbmZvLnRyZWU7CiAgICAgICAgICAgICAgdmFyIHN0dWZmZWREYXRhID0gaHVmZm1hbkluZm8uc3R1ZmZlZERhdGE7CiAgICAgICAgICAgICAgdmFyIHNyY1B0ciA9IGh1ZmZtYW5JbmZvLnNyY1B0cjsKICAgICAgICAgICAgICB2YXIgYml0UG9zID0gaHVmZm1hbkluZm8uYml0UG9zOwogICAgICAgICAgICAgIHZhciBudW1CaXRzTFVUUWljayA9IGh1ZmZtYW5JbmZvLm51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgIHZhciBudW1CaXRzTFVUID0gaHVmZm1hbkluZm8ubnVtQml0c0xVVDsKICAgICAgICAgICAgICB2YXIgb2Zmc2V0ID0gZGF0YS5oZWFkZXJJbmZvLmltYWdlVHlwZSA9PT0gMCA/IDEyOCA6IDA7CiAgICAgICAgICAgICAgdmFyIG5vZGUsIHZhbCwgZGVsdGEsIG1hc2sgPSBkYXRhLnBpeGVscy5yZXN1bHRNYXNrLCB2YWxUbXAsIHZhbFRtcFF1aWNrLCBjdXJyZW50Qml0OwogICAgICAgICAgICAgIHZhciBpLCBqLCBrLCBpaTsKICAgICAgICAgICAgICB2YXIgcHJldlZhbCA9IDA7CiAgICAgICAgICAgICAgaWYgKGJpdFBvcyA+IDApIHsKICAgICAgICAgICAgICAgIHNyY1B0cisrOwogICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgIHZhciBkZWx0YUVuY29kZSA9IGRhdGEuZW5jb2RlTW9kZSA9PT0gMTsKICAgICAgICAgICAgICB2YXIgcmVzdWx0UGl4ZWxzQWxsRGltID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KG51bVBpeGVscyAqIG51bURpbXMpOwogICAgICAgICAgICAgIHZhciByZXN1bHRQaXhlbHMgPSByZXN1bHRQaXhlbHNBbGxEaW07CiAgICAgICAgICAgICAgdmFyIGlEaW07CiAgICAgICAgICAgICAgZm9yIChpRGltID0gMDsgaURpbSA8IGhlYWRlckluZm8ubnVtRGltczsgaURpbSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobnVtRGltcyA+IDEpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KHJlc3VsdFBpeGVsc0FsbERpbS5idWZmZXIsIG51bVBpeGVscyAqIGlEaW0sIG51bVBpeGVscyk7CiAgICAgICAgICAgICAgICAgIHByZXZWYWwgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRhdGEuaGVhZGVySW5mby5udW1WYWxpZFBpeGVsID09PSB3aWR0aCAqIGhlaWdodCkgewogICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwLCBpID0gMDsgaSA8IGhlaWdodDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHdpZHRoOyBqKyssIGsrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFsID0gMDsKICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCA9IHdvcmQgPDwgYml0UG9zID4+PiAzMiAtIG51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoMzIgLSBiaXRQb3MgPCBudW1CaXRzTFVUUWljaykgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgfD0gc3R1ZmZlZERhdGFbc3JjUHRyICsgMV0gPj4+IDY0IC0gYml0UG9zIC0gbnVtQml0c0xVVFFpY2s7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY29kZUx1dFt2YWxUbXBRdWlja10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGRlY29kZUx1dFt2YWxUbXBRdWlja11bMF07CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXBRdWljayA9IHZhbFRtcDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDMyIC0gYml0UG9zIDwgbnVtQml0c0xVVCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCB8PSBzdHVmZmVkRGF0YVtzcmNQdHIgKyAxXSA+Pj4gNjQgLSBiaXRQb3MgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0cmVlOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGlpID0gMDsgaWkgPCBudW1CaXRzTFVUOyBpaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEJpdCA9IHZhbFRtcCA+Pj4gbnVtQml0c0xVVCAtIGlpIC0gMSAmIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGN1cnJlbnRCaXQgPyBub2RlLnJpZ2h0IDogbm9kZS5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG5vZGUubGVmdCB8fCBub2RlLnJpZ2h0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gbm9kZS52YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSBiaXRQb3MgKyBpaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChiaXRQb3MgPj0gMzIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zIC09IDMyOwogICAgICAgICAgICAgICAgICAgICAgICBzcmNQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgd29yZCA9IHN0dWZmZWREYXRhW3NyY1B0cl07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBkZWx0YSA9IHZhbCAtIG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWx0YUVuY29kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSArPSBwcmV2VmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgKz0gcmVzdWx0UGl4ZWxzW2sgLSB3aWR0aF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgKz0gcHJldlZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSAmPSAyNTU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1trXSA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICBwcmV2VmFsID0gZGVsdGE7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNba10gPSBkZWx0YTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAoayA9IDAsIGkgPSAwOyBpIDwgaGVpZ2h0OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgd2lkdGg7IGorKywgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobWFza1trXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUUWljazsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgzMiAtIGJpdFBvcyA8IG51bUJpdHNMVVRRaWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wIHw9IHN0dWZmZWREYXRhW3NyY1B0ciArIDFdID4+PiA2NCAtIGJpdFBvcyAtIG51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNvZGVMdXRbdmFsVG1wUXVpY2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgzMiAtIGJpdFBvcyA8IG51bUJpdHNMVVQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCB8PSBzdHVmZmVkRGF0YVtzcmNQdHIgKyAxXSA+Pj4gNjQgLSBiaXRQb3MgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0cmVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaWkgPSAwOyBpaSA8IG51bUJpdHNMVVQ7IGlpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCaXQgPSB2YWxUbXAgPj4+IG51bUJpdHNMVVQgLSBpaSAtIDEgJiAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGN1cnJlbnRCaXQgPyBub2RlLnJpZ2h0IDogbm9kZS5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobm9kZS5sZWZ0IHx8IG5vZGUucmlnaHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IG5vZGUudmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSBiaXRQb3MgKyBpaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYml0UG9zID49IDMyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zIC09IDMyOwogICAgICAgICAgICAgICAgICAgICAgICAgIHNyY1B0cisrOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhID0gdmFsIC0gb2Zmc2V0OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsdGFFbmNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDAgJiYgbWFza1trIC0gMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhICs9IHByZXZWYWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpID4gMCAmJiBtYXNrW2sgLSB3aWR0aF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhICs9IHJlc3VsdFBpeGVsc1trIC0gd2lkdGhdOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSArPSBwcmV2VmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSAmPSAyNTU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW2tdID0gZGVsdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldlZhbCA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1trXSA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRhLnB0ciA9IGRhdGEucHRyICsgKHNyY1B0ciArIDEpICogNCArIChiaXRQb3MgPiAwID8gNCA6IDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMgPSByZXN1bHRQaXhlbHNBbGxEaW07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlY29kZUJpdHM6IGZ1bmN0aW9uKGlucHV0LCBkYXRhLCBibG9ja0RhdGFCdWZmZXIsIG9mZnNldCwgaURpbSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBoZWFkZXJJbmZvID0gZGF0YS5oZWFkZXJJbmZvOwogICAgICAgICAgICAgICAgdmFyIGZpbGVWZXJzaW9uID0gaGVhZGVySW5mby5maWxlVmVyc2lvbjsKICAgICAgICAgICAgICAgIHZhciBibG9ja1B0ciA9IDA7CiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZGF0YS5wdHIsIDUpOwogICAgICAgICAgICAgICAgdmFyIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgYmxvY2tQdHIrKzsKICAgICAgICAgICAgICAgIHZhciBiaXRzNjcgPSBoZWFkZXJCeXRlID4+IDY7CiAgICAgICAgICAgICAgICB2YXIgbiA9IGJpdHM2NyA9PT0gMCA/IDQgOiAzIC0gYml0czY3OwogICAgICAgICAgICAgICAgdmFyIGRvTHV0ID0gKGhlYWRlckJ5dGUgJiAzMikgPiAwID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgdmFyIG51bUJpdHMgPSBoZWFkZXJCeXRlICYgMzE7CiAgICAgICAgICAgICAgICB2YXIgbnVtRWxlbWVudHMgPSAwOwogICAgICAgICAgICAgICAgaWYgKG4gPT09IDEpIHsKICAgICAgICAgICAgICAgICAgbnVtRWxlbWVudHMgPSB2aWV3LmdldFVpbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobiA9PT0gMikgewogICAgICAgICAgICAgICAgICBudW1FbGVtZW50cyA9IHZpZXcuZ2V0VWludDE2KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobiA9PT0gNCkgewogICAgICAgICAgICAgICAgICBudW1FbGVtZW50cyA9IHZpZXcuZ2V0VWludDMyKGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gNDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIHZhbGlkIHBpeGVsIGNvdW50IHR5cGUiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNjYWxlID0gMiAqIGhlYWRlckluZm8ubWF4WkVycm9yOwogICAgICAgICAgICAgICAgdmFyIHN0dWZmZWREYXRhLCBhcnJheUJ1Ziwgc3RvcmU4LCBkYXRhQnl0ZXMsIGRhdGFXb3JkczsKICAgICAgICAgICAgICAgIHZhciBsdXRBcnIsIGx1dERhdGEsIGx1dEJ5dGVzLCBsdXRCaXRzUGVyRWxlbWVudCwgYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgdmFyIHpNYXggPSBoZWFkZXJJbmZvLm51bURpbXMgPiAxID8gaGVhZGVySW5mby5tYXhWYWx1ZXNbaURpbV0gOiBoZWFkZXJJbmZvLnpNYXg7CiAgICAgICAgICAgICAgICBpZiAoZG9MdXQpIHsKICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmx1dCsrOwogICAgICAgICAgICAgICAgICBsdXRCeXRlcyA9IHZpZXcuZ2V0VWludDgoYmxvY2tQdHIpOwogICAgICAgICAgICAgICAgICBsdXRCaXRzUGVyRWxlbWVudCA9IG51bUJpdHM7CiAgICAgICAgICAgICAgICAgIGJsb2NrUHRyKys7CiAgICAgICAgICAgICAgICAgIGRhdGFCeXRlcyA9IE1hdGguY2VpbCgobHV0Qnl0ZXMgLSAxKSAqIG51bUJpdHMgLyA4KTsKICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgZGF0YS5wdHIsIGRhdGFCeXRlcykpOwogICAgICAgICAgICAgICAgICBsdXREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgICBiaXRzUGVyUGl4ZWwgPSAwOwogICAgICAgICAgICAgICAgICB3aGlsZSAobHV0Qnl0ZXMgLSAxID4+PiBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBiaXRzUGVyUGl4ZWwrKzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkYXRhQnl0ZXMgPSBNYXRoLmNlaWwobnVtRWxlbWVudHMgKiBiaXRzUGVyUGl4ZWwgLyA4KTsKICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBkYXRhLnB0ciwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgIHN0dWZmZWREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgIGx1dEFyciA9IEJpdFN0dWZmZXIudW5zdHVmZkxVVDIobHV0RGF0YSwgbnVtQml0cywgbHV0Qnl0ZXMgLSAxLCBvZmZzZXQsIHNjYWxlLCB6TWF4KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsdXRBcnIgPSBCaXRTdHVmZmVyLnVuc3R1ZmZMVVQobHV0RGF0YSwgbnVtQml0cywgbHV0Qnl0ZXMgLSAxLCBvZmZzZXQsIHNjYWxlLCB6TWF4KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIudW5zdHVmZjIoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgbHV0QXJyKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBCaXRTdHVmZmVyLnVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgbHV0QXJyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmJpdHN0dWZmZXIrKzsKICAgICAgICAgICAgICAgICAgYml0c1BlclBpeGVsID0gbnVtQml0czsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gYmxvY2tQdHI7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzUGVyUGl4ZWwgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YUJ5dGVzID0gTWF0aC5jZWlsKG51bUVsZW1lbnRzICogYml0c1BlclBpeGVsIC8gOCk7CiAgICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICAgIGFycmF5QnVmID0gbmV3IEFycmF5QnVmZmVyKGRhdGFXb3JkcyAqIDQpOwogICAgICAgICAgICAgICAgICAgIHN0b3JlOCA9IG5ldyBVaW50OEFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBkYXRhLnB0ciwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgICAgc3R1ZmZlZERhdGEgPSBuZXcgVWludDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGRhdGFCeXRlczsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG9mZnNldCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIub3JpZ2luYWxVbnN0dWZmMihzdHVmZmVkRGF0YSwgYmxvY2tEYXRhQnVmZmVyLCBiaXRzUGVyUGl4ZWwsIG51bUVsZW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIudW5zdHVmZjIoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgZmFsc2UsIG9mZnNldCwgc2NhbGUsIHpNYXgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAob2Zmc2V0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgQml0U3R1ZmZlci5vcmlnaW5hbFVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBCaXRTdHVmZmVyLnVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgZmFsc2UsIG9mZnNldCwgc2NhbGUsIHpNYXgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVhZFRpbGVzOiBmdW5jdGlvbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpIHsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgd2lkdGggPSBoZWFkZXJJbmZvLndpZHRoOwogICAgICAgICAgICAgIHZhciBoZWlnaHQgPSBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgbWljcm9CbG9ja1NpemUgPSBoZWFkZXJJbmZvLm1pY3JvQmxvY2tTaXplOwogICAgICAgICAgICAgIHZhciBpbWFnZVR5cGUgPSBoZWFkZXJJbmZvLmltYWdlVHlwZTsKICAgICAgICAgICAgICB2YXIgZGF0YVR5cGVTaXplID0gTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShpbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciBudW1CbG9ja3NYID0gTWF0aC5jZWlsKHdpZHRoIC8gbWljcm9CbG9ja1NpemUpOwogICAgICAgICAgICAgIHZhciBudW1CbG9ja3NZID0gTWF0aC5jZWlsKGhlaWdodCAvIG1pY3JvQmxvY2tTaXplKTsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CbG9ja3NZID0gbnVtQmxvY2tzWTsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CbG9ja3NYID0gbnVtQmxvY2tzWDsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5wdHIgPSAwOwogICAgICAgICAgICAgIHZhciByb3cgPSAwLCBjb2wgPSAwLCBibG9ja1kgPSAwLCBibG9ja1ggPSAwLCB0aGlzQmxvY2tIZWlnaHQgPSAwLCB0aGlzQmxvY2tXaWR0aCA9IDAsIGJ5dGVzTGVmdCA9IDAsIGhlYWRlckJ5dGUgPSAwLCBiaXRzNjcgPSAwLCB0ZXN0Q29kZSA9IDAsIG91dFB0ciA9IDAsIG91dFN0cmlkZSA9IDAsIG51bUJ5dGVzID0gMCwgYnl0ZXNsZWZ0ID0gMCwgeiA9IDAsIGJsb2NrUHRyID0gMDsKICAgICAgICAgICAgICB2YXIgdmlldywgYmxvY2ssIGFycmF5QnVmLCBzdG9yZTgsIHJhd0RhdGE7CiAgICAgICAgICAgICAgdmFyIGJsb2NrRW5jb2Rpbmc7CiAgICAgICAgICAgICAgdmFyIGJsb2NrRGF0YUJ1ZmZlciA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShtaWNyb0Jsb2NrU2l6ZSAqIG1pY3JvQmxvY2tTaXplKTsKICAgICAgICAgICAgICB2YXIgbGFzdEJsb2NrSGVpZ2h0ID0gaGVpZ2h0ICUgbWljcm9CbG9ja1NpemUgfHwgbWljcm9CbG9ja1NpemU7CiAgICAgICAgICAgICAgdmFyIGxhc3RCbG9ja1dpZHRoID0gd2lkdGggJSBtaWNyb0Jsb2NrU2l6ZSB8fCBtaWNyb0Jsb2NrU2l6ZTsKICAgICAgICAgICAgICB2YXIgb2Zmc2V0VHlwZSwgb2Zmc2V0OwogICAgICAgICAgICAgIHZhciBudW1EaW1zID0gaGVhZGVySW5mby5udW1EaW1zLCBpRGltOwogICAgICAgICAgICAgIHZhciBtYXNrID0gZGF0YS5waXhlbHMucmVzdWx0TWFzazsKICAgICAgICAgICAgICB2YXIgcmVzdWx0UGl4ZWxzID0gZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzOwogICAgICAgICAgICAgIGZvciAoYmxvY2tZID0gMDsgYmxvY2tZIDwgbnVtQmxvY2tzWTsgYmxvY2tZKyspIHsKICAgICAgICAgICAgICAgIHRoaXNCbG9ja0hlaWdodCA9IGJsb2NrWSAhPT0gbnVtQmxvY2tzWSAtIDEgPyBtaWNyb0Jsb2NrU2l6ZSA6IGxhc3RCbG9ja0hlaWdodDsKICAgICAgICAgICAgICAgIGZvciAoYmxvY2tYID0gMDsgYmxvY2tYIDwgbnVtQmxvY2tzWDsgYmxvY2tYKyspIHsKICAgICAgICAgICAgICAgICAgdGhpc0Jsb2NrV2lkdGggPSBibG9ja1ggIT09IG51bUJsb2Nrc1ggLSAxID8gbWljcm9CbG9ja1NpemUgOiBsYXN0QmxvY2tXaWR0aDsKICAgICAgICAgICAgICAgICAgb3V0UHRyID0gYmxvY2tZICogd2lkdGggKiBtaWNyb0Jsb2NrU2l6ZSArIGJsb2NrWCAqIG1pY3JvQmxvY2tTaXplOwogICAgICAgICAgICAgICAgICBvdXRTdHJpZGUgPSB3aWR0aCAtIHRoaXNCbG9ja1dpZHRoOwogICAgICAgICAgICAgICAgICBmb3IgKGlEaW0gPSAwOyBpRGltIDwgbnVtRGltczsgaURpbSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG51bURpbXMgPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHMgPSBuZXcgT3V0UGl4ZWxUeXBlQXJyYXkoZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzLmJ1ZmZlciwgd2lkdGggKiBoZWlnaHQgKiBpRGltICogZGF0YVR5cGVTaXplLCB3aWR0aCAqIGhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJ5dGVzTGVmdCA9IGlucHV0LmJ5dGVMZW5ndGggLSBkYXRhLnB0cjsKICAgICAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBkYXRhLnB0ciwgTWF0aC5taW4oMTAsIGJ5dGVzTGVmdCkpOwogICAgICAgICAgICAgICAgICAgIGJsb2NrID0ge307CiAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgPSAwOwogICAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgICAgIGJsb2NrUHRyKys7CiAgICAgICAgICAgICAgICAgICAgYml0czY3ID0gaGVhZGVyQnl0ZSA+PiA2ICYgMjU1OwogICAgICAgICAgICAgICAgICAgIHRlc3RDb2RlID0gaGVhZGVyQnl0ZSA+PiAyICYgMTU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RDb2RlICE9PSAoYmxvY2tYICogbWljcm9CbG9ja1NpemUgPj4gMyAmIDE1KSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgImludGVncml0eSBpc3N1ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJsb2NrRW5jb2RpbmcgPSBoZWFkZXJCeXRlICYgMzsKICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2tFbmNvZGluZyA+IDMpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGJsb2NrUHRyOwogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgIkludmFsaWQgYmxvY2sgZW5jb2RpbmcgKCIgKyBibG9ja0VuY29kaW5nICsgIikiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tFbmNvZGluZyA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmNvbnN0YW50Kys7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tFbmNvZGluZyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLnVuY29tcHJlc3NlZCsrOwogICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gYmxvY2tQdHI7CiAgICAgICAgICAgICAgICAgICAgICBudW1CeXRlcyA9IHRoaXNCbG9ja0hlaWdodCAqIHRoaXNCbG9ja1dpZHRoICogZGF0YVR5cGVTaXplOwogICAgICAgICAgICAgICAgICAgICAgYnl0ZXNsZWZ0ID0gaW5wdXQuYnl0ZUxlbmd0aCAtIGRhdGEucHRyOwogICAgICAgICAgICAgICAgICAgICAgbnVtQnl0ZXMgPSBudW1CeXRlcyA8IGJ5dGVzbGVmdCA/IG51bUJ5dGVzIDogYnl0ZXNsZWZ0OwogICAgICAgICAgICAgICAgICAgICAgYXJyYXlCdWYgPSBuZXcgQXJyYXlCdWZmZXIobnVtQnl0ZXMgJSBkYXRhVHlwZVNpemUgPT09IDAgPyBudW1CeXRlcyA6IG51bUJ5dGVzICsgZGF0YVR5cGVTaXplIC0gbnVtQnl0ZXMgJSBkYXRhVHlwZVNpemUpOwogICAgICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgZGF0YS5wdHIsIG51bUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICByYXdEYXRhID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgICAgIHogPSAwOwogICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW291dFB0cl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cl0gPSByYXdEYXRhW3orK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSByYXdEYXRhW3orK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IHogKiBkYXRhVHlwZVNpemU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFR5cGUgPSBMZXJjMkhlbHBlcnMuZ2V0RGF0YVR5cGVVc2VkKGltYWdlVHlwZSwgYml0czY3KTsKICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IExlcmMySGVscGVycy5nZXRPbmVQaXhlbChibG9jaywgYmxvY2tQdHIsIG9mZnNldFR5cGUsIHZpZXcpOwogICAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShvZmZzZXRUeXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9ja0VuY29kaW5nID09PSAzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGJsb2NrUHRyOwogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmNvdW50ZXIuY29uc3RhbnRvZmZzZXQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHJvdyA9IDA7IHJvdyA8IHRoaXNCbG9ja0hlaWdodDsgcm93KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29sID0gMDsgY29sIDwgdGhpc0Jsb2NrV2lkdGg7IGNvbCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW291dFB0cl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyXSA9IG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpc0Jsb2NrSGVpZ2h0OyByb3crKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cisrXSA9IG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLmRlY29kZUJpdHMoaW5wdXQsIGRhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgb2Zmc2V0LCBpRGltKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFzaykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpc0Jsb2NrSGVpZ2h0OyByb3crKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tbb3V0UHRyXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHJdID0gYmxvY2tEYXRhQnVmZmVyW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0cisrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbCA9IDA7IGNvbCA8IHRoaXNCbG9ja1dpZHRoOyBjb2wrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyKytdID0gYmxvY2tEYXRhQnVmZmVyW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKioqKioqKioqKioqKioqKgogICAgICAgICAgICAqICBwcml2YXRlIG1ldGhvZHMgKGhlbHBlciBtZXRob2RzKQogICAgICAgICAgICAqKioqKioqKioqKioqKioqKi8KICAgICAgICAgICAgZm9ybWF0RmlsZUluZm86IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgImZpbGVJZGVudGlmaWVyU3RyaW5nIjogZGF0YS5oZWFkZXJJbmZvLmZpbGVJZGVudGlmaWVyU3RyaW5nLAogICAgICAgICAgICAgICAgImZpbGVWZXJzaW9uIjogZGF0YS5oZWFkZXJJbmZvLmZpbGVWZXJzaW9uLAogICAgICAgICAgICAgICAgImltYWdlVHlwZSI6IGRhdGEuaGVhZGVySW5mby5pbWFnZVR5cGUsCiAgICAgICAgICAgICAgICAiaGVpZ2h0IjogZGF0YS5oZWFkZXJJbmZvLmhlaWdodCwKICAgICAgICAgICAgICAgICJ3aWR0aCI6IGRhdGEuaGVhZGVySW5mby53aWR0aCwKICAgICAgICAgICAgICAgICJudW1WYWxpZFBpeGVsIjogZGF0YS5oZWFkZXJJbmZvLm51bVZhbGlkUGl4ZWwsCiAgICAgICAgICAgICAgICAibWljcm9CbG9ja1NpemUiOiBkYXRhLmhlYWRlckluZm8ubWljcm9CbG9ja1NpemUsCiAgICAgICAgICAgICAgICAiYmxvYlNpemUiOiBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUsCiAgICAgICAgICAgICAgICAibWF4WkVycm9yIjogZGF0YS5oZWFkZXJJbmZvLm1heFpFcnJvciwKICAgICAgICAgICAgICAgICJwaXhlbFR5cGUiOiBMZXJjMkhlbHBlcnMuZ2V0UGl4ZWxUeXBlKGRhdGEuaGVhZGVySW5mby5pbWFnZVR5cGUpLAogICAgICAgICAgICAgICAgImVvZk9mZnNldCI6IGRhdGEuZW9mT2Zmc2V0LAogICAgICAgICAgICAgICAgIm1hc2siOiBkYXRhLm1hc2sgPyB7CiAgICAgICAgICAgICAgICAgICJudW1CeXRlcyI6IGRhdGEubWFzay5udW1CeXRlcwogICAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgICAicGl4ZWxzIjogewogICAgICAgICAgICAgICAgICAibnVtQmxvY2tzWCI6IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1gsCiAgICAgICAgICAgICAgICAgICJudW1CbG9ja3NZIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWSwKICAgICAgICAgICAgICAgICAgLy8ibnVtQnl0ZXMiOiBkYXRhLnBpeGVscy5udW1CeXRlcywKICAgICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5oZWFkZXJJbmZvLnpNYXgsCiAgICAgICAgICAgICAgICAgICJtaW5WYWx1ZSI6IGRhdGEuaGVhZGVySW5mby56TWluLAogICAgICAgICAgICAgICAgICAibm9EYXRhVmFsdWUiOiBkYXRhLm5vRGF0YVZhbHVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uc3RydWN0Q29uc3RhbnRTdXJmYWNlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIHZhbCA9IGRhdGEuaGVhZGVySW5mby56TWF4OwogICAgICAgICAgICAgIHZhciBudW1EaW1zID0gZGF0YS5oZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGRhdGEuaGVhZGVySW5mby5oZWlnaHQgKiBkYXRhLmhlYWRlckluZm8ud2lkdGg7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVsQWxsRGltcyA9IG51bVBpeGVscyAqIG51bURpbXM7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBrID0gMCwgblN0YXJ0ID0gMDsKICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgIGlmIChudW1EaW1zID4gMSkgewogICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtRGltczsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgblN0YXJ0ID0gaSAqIG51bVBpeGVsczsKICAgICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbnVtUGl4ZWxzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVsc1tuU3RhcnQgKyBrXSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1QaXhlbHM7IGsrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHNba10gPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMuZmlsbCkgewogICAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMuZmlsbCh2YWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG51bVBpeGVsQWxsRGltczsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzW2tdID0gdmFsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0RGF0YVR5cGVBcnJheTogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHZhciB0cDsKICAgICAgICAgICAgICBzd2l0Y2ggKHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgdHAgPSBJbnQ4QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICB0cCA9IFVpbnQ4QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB0cCA9IEludDE2QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICB0cCA9IFVpbnQxNkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgdHAgPSBJbnQzMkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgdHAgPSBVaW50MzJBcnJheTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIHRwID0gRmxvYXQzMkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgdHAgPSBGbG9hdDY0QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdHAgPSBGbG9hdDMyQXJyYXk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0UGl4ZWxUeXBlOiBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgdmFyIHRwOwogICAgICAgICAgICAgIHN3aXRjaCAodCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICB0cCA9ICJTOCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICB0cCA9ICJVOCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB0cCA9ICJTMTYiOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgdHAgPSAiVTE2IjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIHRwID0gIlMzMiI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICB0cCA9ICJVMzIiOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgdHAgPSAiRjMyIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgIHRwID0gIkY2NCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdHAgPSAiRjMyIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRwOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc1ZhbGlkUGl4ZWxWYWx1ZTogZnVuY3Rpb24odCwgdmFsKSB7CiAgICAgICAgICAgICAgaWYgKHZhbCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpc1ZhbGlkOwogICAgICAgICAgICAgIHN3aXRjaCAodCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IC0xMjggJiYgdmFsIDw9IDEyNzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSB2YWwgPj0gMCAmJiB2YWwgPD0gMjU1OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCA+PSAtMzI3NjggJiYgdmFsIDw9IDMyNzY3OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCA+PSAwICYmIHZhbCA8PSA2NTUzNjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSB2YWwgPj0gLTIxNDc0ODM2NDggJiYgdmFsIDw9IDIxNDc0ODM2NDc7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IDAgJiYgdmFsIDw9IDQyOTQ5NjcyOTY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IC0zNDAyNzk5OTM4NzkwMTQ4NGUyMiAmJiB2YWwgPD0gMzQwMjc5OTkzODc5MDE0ODRlMjI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IDVlLTMyNCAmJiB2YWwgPD0gMTc5NzY5MzEzNDg2MjMxNTdlMjkyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldERhdGFUeXBlU2l6ZTogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHZhciBzID0gMDsKICAgICAgICAgICAgICBzd2l0Y2ggKHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIC8vdWJ5dGUKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgcyA9IDE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgLy9zaG9ydAogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICBzID0gMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIHMgPSA0OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgcyA9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgcyA9IHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXREYXRhVHlwZVVzZWQ6IGZ1bmN0aW9uKGR0LCB0YykgewogICAgICAgICAgICAgIHZhciB0ID0gZHQ7CiAgICAgICAgICAgICAgc3dpdGNoIChkdCkgewogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgLy9zaG9ydAogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICB0ID0gZHQgLSB0YzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAvL3VzaG9ydAogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICB0ID0gZHQgLSAyICogdGM7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgICAgICBpZiAoMCA9PT0gdGMpIHsKICAgICAgICAgICAgICAgICAgICB0ID0gZHQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoMSA9PT0gdGMpIHsKICAgICAgICAgICAgICAgICAgICB0ID0gMjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ID0gMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgaWYgKDAgPT09IHRjKSB7CiAgICAgICAgICAgICAgICAgICAgdCA9IGR0OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHQgPSBkdCAtIDIgKiB0YyArIDE7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0ID0gZHQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0T25lUGl4ZWw6IGZ1bmN0aW9uKGJsb2NrLCBibG9ja1B0ciwgb2Zmc2V0VHlwZSwgdmlldykgewogICAgICAgICAgICAgIHZhciB0ZW1wID0gMDsKICAgICAgICAgICAgICBzd2l0Y2ggKG9mZnNldFR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgdGVtcCA9IHZpZXcuZ2V0SW50OChibG9ja1B0cik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRVaW50OChibG9ja1B0cik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRJbnQxNihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRVaW50MTYoYmxvY2tQdHIsIHRydWUpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgdGVtcCA9IHZpZXcuZ2V0SW50MzIoYmxvY2tQdHIsIHRydWUpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgdGVtcCA9IHZpZXcuZ2V0VUludDMyKGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldEZsb2F0MzIoYmxvY2tQdHIsIHRydWUpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgdGVtcCA9IHZpZXcuZ2V0RmxvYXQ2NChibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdGhyb3cgInRoZSBkZWNvZGVyIGRvZXMgbm90IHVuZGVyc3RhbmQgdGhpcyBwaXhlbCB0eXBlIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRlbXA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgVHJlZU5vZGUgPSBmdW5jdGlvbih2YWwsIGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMudmFsID0gdmFsOwogICAgICAgICAgICB0aGlzLmxlZnQgPSBsZWZ0OwogICAgICAgICAgICB0aGlzLnJpZ2h0ID0gcmlnaHQ7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIExlcmMyRGVjb2RlMiA9IHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgKiAqKioqKioqKnJlbW92ZWQgb3B0aW9ucyBjb21wYXJlZCB0byBMRVJDMS4gV2UgY2FuIGJyaW5nIHNvbWUgb2YgdGhlbSBiYWNrIGlmIG5lZWRlZC4KICAgICAgICAgICAgICogcmVtb3ZlZCBwaXhlbCB0eXBlLiBMRVJDMiBpcyB0eXBlZCBhbmQgZG9lc24ndCByZXF1aXJlIHVzZXIgdG8gZ2l2ZSBwaXhlbCB0eXBlCiAgICAgICAgICAgICAqIGNoYW5nZWQgZW5jb2RlZE1hc2tEYXRhIHRvIG1hc2tEYXRhLiBMRVJDMiAncyBqcyB2ZXJzaW9uIG1ha2UgaXQgZmFzdGVyIHRvIHVzZSBtYXNrRGF0YSBkaXJlY3RseS4KICAgICAgICAgICAgICogcmVtb3ZlZCByZXR1cm5NYXNrLiBtYXNrIGlzIHVzZWQgYnkgTEVSQzIgaW50ZXJuYWxseSBhbmQgaXMgY29zdCBmcmVlLiBJbiBjYXNlIG9mIHVzZXIgaW5wdXQgbWFzaywgaXQncyByZXR1cm5lZCBhcyB3ZWxsIGFuZCBoYXMgbmVnbGlibGUgY29zdC4KICAgICAgICAgICAgICogcmVtb3ZlZCBub2RhdGF2YWx1ZS4gQmVjYXVzZSBMRVJDMiBwaXhlbHMgYXJlIHR5cGVkLCBub2RhdGF2YWx1ZSB3aWxsIHNhY3JpZnkgYSB1c2VmdWwgdmFsdWUgZm9yIG1hbnkgdHlwZXMgKDhiaXQsIDE2Yml0KSBldGMsCiAgICAgICAgICAgICAqICAgICAgIHVzZXIgaGFzIHRvIGJlIGtub3dsZWRnYWJsZSBlbm91Z2ggYWJvdXQgcmFzdGVyIGFuZCB0aGVpciBkYXRhIHRvIGF2b2lkIHVzYWJpbGl0eSBpc3N1ZXMuIHNvIG5vZGF0YSB2YWx1ZSBpcyBzaW1wbHkgcmVtb3ZlZCBub3cuCiAgICAgICAgICAgICAqICAgICAgIFdlIGNhbiBhZGQgaXQgYmFjayBsYXRlciBpZiB0aGVpcidzIGEgY2xlYXIgcmVxdWlyZW1lbnQuCiAgICAgICAgICAgICAqIHJlbW92ZWQgZW5jb2RlZE1hc2suIFRoaXMgb3B0aW9uIHdhcyBub3QgaW1wbGVtZW50ZWQgaW4gTGVyY0RlY29kZS4gSXQgY2FuIGJlIGRvbmUgYWZ0ZXIgZGVjb2RpbmcgKGxlc3MgZWZmaWNpZW50KQogICAgICAgICAgICAgKiByZW1vdmVkIGNvbXB1dGVVc2VkQml0RGVwdGhzLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiByZXNwb25zZSBjaGFuZ2VzIGNvbXBhcmVkIHRvIExFUkMxCiAgICAgICAgICAgICAqIDEuIGVuY29kZWRNYXNrRGF0YSBpcyBub3QgYXZhaWxhYmxlCiAgICAgICAgICAgICAqIDIuIG5vRGF0YVZhbHVlIGlzIG9wdGlvbmFsIChyZXR1cm5zIG9ubHkgaWYgdXNlcidzIG5vRGF0YVZhbHVlIGlzIHdpdGggaW4gdGhlIHZhbGlkIGRhdGEgdHlwZSByYW5nZSkKICAgICAgICAgICAgICogMy4gbWFza0RhdGEgaXMgYWx3YXlzIGF2YWlsYWJsZQogICAgICAgICAgICAqLwogICAgICAgICAgICAvKioqKioqKioqKioqKioqKioKICAgICAgICAgICAgKiAgcHVibGljIHByb3BlcnRpZXMKICAgICAgICAgICAgKioqKioqKioqKioqKioqKioqLwogICAgICAgICAgICAvL0hVRkZNQU5fTFVUX0JJVFNfTUFYOiAxMiwgLy91c2UgMl4xMiBsdXQsIG5vdCBjb25maWd1cmFibGUKICAgICAgICAgICAgLyoqKioqKioqKioqKioqKioqCiAgICAgICAgICAgICogIHB1YmxpYyBtZXRob2RzCiAgICAgICAgICAgICoqKioqKioqKioqKioqKioqLwogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRGVjb2RlIGEgTEVSQzIgYnl0ZSBzdHJlYW0gYW5kIHJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyB0aGUgcGl4ZWwgZGF0YSBhbmQgb3B0aW9uYWwgbWV0YWRhdGEuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7QXJyYXlCdWZmZXJ9IGlucHV0IFRoZSBMRVJDIGlucHV0IGJ5dGUgc3RyZWFtCiAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gb3B0aW9ucyBEZWNvZGluZyBvcHRpb25zCiAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0aW9ucy5pbnB1dE9mZnNldF0gVGhlIG51bWJlciBvZiBieXRlcyB0byBza2lwIGluIHRoZSBpbnB1dCBieXRlIHN0cmVhbS4gQSB2YWxpZCBMRVJDIGZpbGUgaXMgZXhwZWN0ZWQgYXQgdGhhdCBwb3NpdGlvbgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLnJldHVybkZpbGVJbmZvXSBJZiB0cnVlLCB0aGUgcmV0dXJuIHZhbHVlIHdpbGwgaGF2ZSBhIGZpbGVJbmZvIHByb3BlcnR5IHRoYXQgY29udGFpbnMgbWV0YWRhdGEgb2J0YWluZWQgZnJvbSB0aGUgTEVSQyBoZWFkZXJzIGFuZCB0aGUgZGVjb2RpbmcgcHJvY2VzcwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZGVjb2RlOiBmdW5jdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICAgIHZhciBub0RhdGFWYWx1ZSA9IG9wdGlvbnMubm9EYXRhVmFsdWU7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBkYXRhID0ge307CiAgICAgICAgICAgICAgZGF0YS5wdHIgPSBvcHRpb25zLmlucHV0T2Zmc2V0IHx8IDA7CiAgICAgICAgICAgICAgZGF0YS5waXhlbHMgPSB7fTsKICAgICAgICAgICAgICBpZiAoIUxlcmMySGVscGVycy5yZWFkSGVhZGVySW5mbyhpbnB1dCwgZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIGZpbGVWZXJzaW9uID0gaGVhZGVySW5mby5maWxlVmVyc2lvbjsKICAgICAgICAgICAgICB2YXIgT3V0UGl4ZWxUeXBlQXJyYXkgPSBMZXJjMkhlbHBlcnMuZ2V0RGF0YVR5cGVBcnJheShoZWFkZXJJbmZvLmltYWdlVHlwZSk7CiAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLnJlYWRNYXNrKGlucHV0LCBkYXRhKTsKICAgICAgICAgICAgICBpZiAoaGVhZGVySW5mby5udW1WYWxpZFBpeGVsICE9PSBoZWFkZXJJbmZvLndpZHRoICogaGVhZGVySW5mby5oZWlnaHQgJiYgIWRhdGEucGl4ZWxzLnJlc3VsdE1hc2spIHsKICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdE1hc2sgPSBvcHRpb25zLm1hc2tEYXRhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbnVtUGl4ZWxzID0gaGVhZGVySW5mby53aWR0aCAqIGhlYWRlckluZm8uaGVpZ2h0OwogICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVscyA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShudW1QaXhlbHMgKiBoZWFkZXJJbmZvLm51bURpbXMpOwogICAgICAgICAgICAgIGRhdGEuY291bnRlciA9IHsKICAgICAgICAgICAgICAgIG9uZXN3ZWVwOiAwLAogICAgICAgICAgICAgICAgdW5jb21wcmVzc2VkOiAwLAogICAgICAgICAgICAgICAgbHV0OiAwLAogICAgICAgICAgICAgICAgYml0c3R1ZmZlcjogMCwKICAgICAgICAgICAgICAgIGNvbnN0YW50OiAwLAogICAgICAgICAgICAgICAgY29uc3RhbnRvZmZzZXQ6IDAKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChoZWFkZXJJbmZvLm51bVZhbGlkUGl4ZWwgIT09IDApIHsKICAgICAgICAgICAgICAgIGlmIChoZWFkZXJJbmZvLnpNYXggPT09IGhlYWRlckluZm8uek1pbikgewogICAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMuY29uc3RydWN0Q29uc3RhbnRTdXJmYWNlKGRhdGEpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWxlVmVyc2lvbiA+PSA0ICYmIExlcmMySGVscGVycy5jaGVja01pbk1heFJhbmdlcyhpbnB1dCwgZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLmNvbnN0cnVjdENvbnN0YW50U3VyZmFjZShkYXRhKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBkYXRhLnB0ciwgMik7CiAgICAgICAgICAgICAgICAgIHZhciBiUmVhZERhdGFPbmVTd2VlcCA9IHZpZXcuZ2V0VWludDgoMCk7CiAgICAgICAgICAgICAgICAgIGRhdGEucHRyKys7CiAgICAgICAgICAgICAgICAgIGlmIChiUmVhZERhdGFPbmVTd2VlcCkgewogICAgICAgICAgICAgICAgICAgIExlcmMySGVscGVycy5yZWFkRGF0YU9uZVN3ZWVwKGlucHV0LCBkYXRhLCBPdXRQaXhlbFR5cGVBcnJheSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGVWZXJzaW9uID4gMSAmJiBoZWFkZXJJbmZvLmltYWdlVHlwZSA8PSAxICYmIE1hdGguYWJzKGhlYWRlckluZm8ubWF4WkVycm9yIC0gMC41KSA8IDFlLTUpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBmbGFnSHVmZm1hbiA9IHZpZXcuZ2V0VWludDgoMSk7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB0cisrOwogICAgICAgICAgICAgICAgICAgICAgZGF0YS5lbmNvZGVNb2RlID0gZmxhZ0h1ZmZtYW47CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZmxhZ0h1ZmZtYW4gPiAyIHx8IGZpbGVWZXJzaW9uIDwgNCAmJiBmbGFnSHVmZm1hbiA+IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgIkludmFsaWQgSHVmZm1hbiBmbGFnICIgKyBmbGFnSHVmZm1hbjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFnSHVmZm1hbikgewogICAgICAgICAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZEh1ZmZtYW4oaW5wdXQsIGRhdGEsIE91dFBpeGVsVHlwZUFycmF5KTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExlcmMySGVscGVycy5yZWFkVGlsZXMoaW5wdXQsIGRhdGEsIE91dFBpeGVsVHlwZUFycmF5KTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLnJlYWRUaWxlcyhpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhLmVvZk9mZnNldCA9IGRhdGEucHRyOwogICAgICAgICAgICAgIHZhciBkaWZmOwogICAgICAgICAgICAgIGlmIChvcHRpb25zLmlucHV0T2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBkaWZmID0gZGF0YS5oZWFkZXJJbmZvLmJsb2JTaXplICsgb3B0aW9ucy5pbnB1dE9mZnNldCAtIGRhdGEucHRyOwogICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGRpZmYpID49IDEpIHsKICAgICAgICAgICAgICAgICAgZGF0YS5lb2ZPZmZzZXQgPSBvcHRpb25zLmlucHV0T2Zmc2V0ICsgZGF0YS5oZWFkZXJJbmZvLmJsb2JTaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkaWZmID0gZGF0YS5oZWFkZXJJbmZvLmJsb2JTaXplIC0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGlmZikgPj0gMSkgewogICAgICAgICAgICAgICAgICBkYXRhLmVvZk9mZnNldCA9IGRhdGEuaGVhZGVySW5mby5ibG9iU2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICAgICAgICAgIHdpZHRoOiBoZWFkZXJJbmZvLndpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWFkZXJJbmZvLmhlaWdodCwKICAgICAgICAgICAgICAgIHBpeGVsRGF0YTogZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzLAogICAgICAgICAgICAgICAgbWluVmFsdWU6IGhlYWRlckluZm8uek1pbiwKICAgICAgICAgICAgICAgIG1heFZhbHVlOiBoZWFkZXJJbmZvLnpNYXgsCiAgICAgICAgICAgICAgICB2YWxpZFBpeGVsQ291bnQ6IGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbCwKICAgICAgICAgICAgICAgIGRpbUNvdW50OiBoZWFkZXJJbmZvLm51bURpbXMsCiAgICAgICAgICAgICAgICBkaW1TdGF0czogewogICAgICAgICAgICAgICAgICBtaW5WYWx1ZXM6IGhlYWRlckluZm8ubWluVmFsdWVzLAogICAgICAgICAgICAgICAgICBtYXhWYWx1ZXM6IGhlYWRlckluZm8ubWF4VmFsdWVzCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbWFza0RhdGE6IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2sKICAgICAgICAgICAgICAgIC8vbm9EYXRhVmFsdWU6IG5vRGF0YVZhbHVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAoZGF0YS5waXhlbHMucmVzdWx0TWFzayAmJiBMZXJjMkhlbHBlcnMuaXNWYWxpZFBpeGVsVmFsdWUoaGVhZGVySW5mby5pbWFnZVR5cGUsIG5vRGF0YVZhbHVlKSkgewogICAgICAgICAgICAgICAgdmFyIG1hc2sgPSBkYXRhLnBpeGVscy5yZXN1bHRNYXNrOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVBpeGVsczsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGlmICghbWFza1tpXSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5waXhlbERhdGFbaV0gPSBub0RhdGFWYWx1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzdWx0Lm5vRGF0YVZhbHVlID0gbm9EYXRhVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRhdGEubm9EYXRhVmFsdWUgPSBub0RhdGFWYWx1ZTsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZXR1cm5GaWxlSW5mbykgewogICAgICAgICAgICAgICAgcmVzdWx0LmZpbGVJbmZvID0gTGVyYzJIZWxwZXJzLmZvcm1hdEZpbGVJbmZvKGRhdGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRCYW5kQ291bnQ6IGZ1bmN0aW9uKGlucHV0KSB7CiAgICAgICAgICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgICAgdmFyIHRlbXAgPSB7fTsKICAgICAgICAgICAgICB0ZW1wLnB0ciA9IDA7CiAgICAgICAgICAgICAgdGVtcC5waXhlbHMgPSB7fTsKICAgICAgICAgICAgICB3aGlsZSAoaSA8IGlucHV0LmJ5dGVMZW5ndGggLSA1OCkgewogICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLnJlYWRIZWFkZXJJbmZvKGlucHV0LCB0ZW1wKTsKICAgICAgICAgICAgICAgIGkgKz0gdGVtcC5oZWFkZXJJbmZvLmJsb2JTaXplOwogICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgIHRlbXAucHRyID0gaTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNvdW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIExlcmMyRGVjb2RlMjsKICAgICAgICB9KCk7CiAgICAgICAgdmFyIGlzUGxhdGZvcm1MaXR0bGVFbmRpYW4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBhMyA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICAgIHZhciBiID0gbmV3IFVpbnQ4QXJyYXkoYTMpOwogICAgICAgICAgdmFyIGMgPSBuZXcgVWludDMyQXJyYXkoYTMpOwogICAgICAgICAgY1swXSA9IDE7CiAgICAgICAgICByZXR1cm4gYlswXSA9PT0gMTsKICAgICAgICB9KCk7CiAgICAgICAgdmFyIExlcmMyID0gewogICAgICAgICAgLyoqKioqKioqKioqKndyYXBwZXIqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBBIHdyYXBwZXIgZm9yIGRlY29kaW5nIGJvdGggTEVSQzEgYW5kIExFUkMyIGJ5dGUgc3RyZWFtcyBjYXBhYmxlIG9mIGhhbmRsaW5nIG11bHRpYmFuZCBwaXhlbCBibG9ja3MgZm9yIHZhcmlvdXMgcGl4ZWwgdHlwZXMuCiAgICAgICAgICAgKgogICAgICAgICAgICogQGFsaWFzIG1vZHVsZTpMZXJjCiAgICAgICAgICAgKiBAcGFyYW0ge0FycmF5QnVmZmVyfSBpbnB1dCBUaGUgTEVSQyBpbnB1dCBieXRlIHN0cmVhbQogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSBUaGUgZGVjb2Rpbmcgb3B0aW9ucyBiZWxvdyBhcmUgb3B0aW9uYWwuCiAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gW29wdGlvbnMuaW5wdXRPZmZzZXRdIFRoZSBudW1iZXIgb2YgYnl0ZXMgdG8gc2tpcCBpbiB0aGUgaW5wdXQgYnl0ZSBzdHJlYW0uIEEgdmFsaWQgTGVyYyBmaWxlIGlzIGV4cGVjdGVkIGF0IHRoYXQgcG9zaXRpb24uCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gW29wdGlvbnMucGl4ZWxUeXBlXSAoTEVSQzEgb25seSkgRGVmYXVsdCB2YWx1ZSBpcyBGMzIuIFZhbGlkIHBpeGVsIHR5cGVzIGZvciBpbnB1dCBhcmUgVTgvUzgvUzE2L1UxNi9TMzIvVTMyL0YzMi4KICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0aW9ucy5ub0RhdGFWYWx1ZV0gKExFUkMxIG9ubHkpLiBJdCBpcyByZWNvbW1lbmRlZCB0byB1c2UgdGhlIHJldHVybmVkIG1hc2sgaW5zdGVhZCBvZiBzZXR0aW5nIHRoaXMgdmFsdWUuCiAgICAgICAgICAgKiBAcmV0dXJucyB7e3dpZHRoLCBoZWlnaHQsIHBpeGVscywgcGl4ZWxUeXBlLCBtYXNrLCBzdGF0aXN0aWNzfX0KICAgICAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIFdpZHRoIG9mIGRlY29kZWQgaW1hZ2UuCiAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgSGVpZ2h0IG9mIGRlY29kZWQgaW1hZ2UuCiAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IHBpeGVscyBbYmFuZDEsIGJhbmQyLCDigKZdIEVhY2ggYmFuZCBpcyBhIHR5cGVkIGFycmF5IG9mIHdpZHRoKmhlaWdodC4KICAgICAgICAgICAgICogQHByb3BlcnR5IHtzdHJpbmd9IHBpeGVsVHlwZSBUaGUgdHlwZSBvZiBwaXhlbHMgcmVwcmVzZW50ZWQgaW4gdGhlIG91dHB1dC4KICAgICAgICAgICAgICogQHByb3BlcnR5IHttYXNrfSBtYXNrIFR5cGVkIGFycmF5IHdpdGggYSBzaXplIG9mIHdpZHRoKmhlaWdodCwgb3IgbnVsbCBpZiBhbGwgcGl4ZWxzIGFyZSB2YWxpZC4KICAgICAgICAgICAgICogQHByb3BlcnR5IHthcnJheX0gc3RhdGlzdGljcyBbc3RhdGlzdGljc19iYW5kMSwgc3RhdGlzdGljc19iYW5kMiwg4oCmXSBFYWNoIGVsZW1lbnQgaXMgYSBzdGF0aXN0aWNzIG9iamVjdCByZXByZXNlbnRpbmcgbWluIGFuZCBtYXggdmFsdWVzCiAgICAgICAgICAqKi8KICAgICAgICAgIGRlY29kZTogZnVuY3Rpb24oZW5jb2RlZERhdGEsIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCFpc1BsYXRmb3JtTGl0dGxlRW5kaWFuKSB7CiAgICAgICAgICAgICAgdGhyb3cgIkJpZyBlbmRpYW4gc3lzdGVtIGlzIG5vdCBzdXBwb3J0ZWQuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIGlucHV0T2Zmc2V0ID0gb3B0aW9ucy5pbnB1dE9mZnNldCB8fCAwOwogICAgICAgICAgICB2YXIgZmlsZUlkVmlldyA9IG5ldyBVaW50OEFycmF5KGVuY29kZWREYXRhLCBpbnB1dE9mZnNldCwgMTApOwogICAgICAgICAgICB2YXIgZmlsZUlkZW50aWZpZXJTdHJpbmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGZpbGVJZFZpZXcpOwogICAgICAgICAgICB2YXIgbGVyYywgbWFqb3JWZXJzaW9uOwogICAgICAgICAgICBpZiAoZmlsZUlkZW50aWZpZXJTdHJpbmcudHJpbSgpID09PSAiQ250WkltYWdlIikgewogICAgICAgICAgICAgIGxlcmMgPSBMZXJjRGVjb2RlOwogICAgICAgICAgICAgIG1ham9yVmVyc2lvbiA9IDE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsZUlkZW50aWZpZXJTdHJpbmcuc3Vic3RyaW5nKDAsIDUpID09PSAiTGVyYzIiKSB7CiAgICAgICAgICAgICAgbGVyYyA9IExlcmMyRGVjb2RlOwogICAgICAgICAgICAgIG1ham9yVmVyc2lvbiA9IDI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhyb3cgIlVuZXhwZWN0ZWQgZmlsZSBpZGVudGlmaWVyIHN0cmluZzogIiArIGZpbGVJZGVudGlmaWVyU3RyaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpUGxhbmUgPSAwLCBlb2YgPSBlbmNvZGVkRGF0YS5ieXRlTGVuZ3RoIC0gMTAsIGVuY29kZWRNYXNrRGF0YSwgYmFuZE1hc2tzID0gW10sIGJhbmRNYXNrLCBtYXNrRGF0YTsKICAgICAgICAgICAgdmFyIGRlY29kZWRQaXhlbEJsb2NrID0gewogICAgICAgICAgICAgIHdpZHRoOiAwLAogICAgICAgICAgICAgIGhlaWdodDogMCwKICAgICAgICAgICAgICBwaXhlbHM6IFtdLAogICAgICAgICAgICAgIHBpeGVsVHlwZTogb3B0aW9ucy5waXhlbFR5cGUsCiAgICAgICAgICAgICAgbWFzazogbnVsbCwKICAgICAgICAgICAgICBzdGF0aXN0aWNzOiBbXQogICAgICAgICAgICB9OwogICAgICAgICAgICB3aGlsZSAoaW5wdXRPZmZzZXQgPCBlb2YpIHsKICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gbGVyYy5kZWNvZGUoZW5jb2RlZERhdGEsIHsKICAgICAgICAgICAgICAgIGlucHV0T2Zmc2V0LAogICAgICAgICAgICAgICAgLy9mb3IgYm90aCBsZXJjMSBhbmQgbGVyYzIKICAgICAgICAgICAgICAgIGVuY29kZWRNYXNrRGF0YSwKICAgICAgICAgICAgICAgIC8vbGVyYzEgb25seQogICAgICAgICAgICAgICAgbWFza0RhdGEsCiAgICAgICAgICAgICAgICAvL2xlcmMyIG9ubHkKICAgICAgICAgICAgICAgIHJldHVybk1hc2s6IGlQbGFuZSA9PT0gMCA/IHRydWUgOiBmYWxzZSwKICAgICAgICAgICAgICAgIC8vbGVyYzEgb25seQogICAgICAgICAgICAgICAgcmV0dXJuRW5jb2RlZE1hc2s6IGlQbGFuZSA9PT0gMCA/IHRydWUgOiBmYWxzZSwKICAgICAgICAgICAgICAgIC8vbGVyYzEgb25seQogICAgICAgICAgICAgICAgcmV0dXJuRmlsZUluZm86IHRydWUsCiAgICAgICAgICAgICAgICAvL2ZvciBib3RoIGxlcmMxIGFuZCBsZXJjMgogICAgICAgICAgICAgICAgcGl4ZWxUeXBlOiBvcHRpb25zLnBpeGVsVHlwZSB8fCBudWxsLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICBub0RhdGFWYWx1ZTogb3B0aW9ucy5ub0RhdGFWYWx1ZSB8fCBudWxsCiAgICAgICAgICAgICAgICAvL2xlcmMxIG9ubHkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpbnB1dE9mZnNldCA9IHJlc3VsdC5maWxlSW5mby5lb2ZPZmZzZXQ7CiAgICAgICAgICAgICAgaWYgKGlQbGFuZSA9PT0gMCkgewogICAgICAgICAgICAgICAgZW5jb2RlZE1hc2tEYXRhID0gcmVzdWx0LmVuY29kZWRNYXNrRGF0YTsKICAgICAgICAgICAgICAgIG1hc2tEYXRhID0gcmVzdWx0Lm1hc2tEYXRhOwogICAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2sud2lkdGggPSByZXN1bHQud2lkdGg7CiAgICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5oZWlnaHQgPSByZXN1bHQuaGVpZ2h0OwogICAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2suZGltQ291bnQgPSByZXN1bHQuZGltQ291bnQgfHwgMTsKICAgICAgICAgICAgICAgIGRlY29kZWRQaXhlbEJsb2NrLnBpeGVsVHlwZSA9IHJlc3VsdC5waXhlbFR5cGUgfHwgcmVzdWx0LmZpbGVJbmZvLnBpeGVsVHlwZTsKICAgICAgICAgICAgICAgIGRlY29kZWRQaXhlbEJsb2NrLm1hc2sgPSByZXN1bHQubWFza0RhdGE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChtYWpvclZlcnNpb24gPiAxICYmIHJlc3VsdC5maWxlSW5mby5tYXNrICYmIHJlc3VsdC5maWxlSW5mby5tYXNrLm51bUJ5dGVzID4gMCkgewogICAgICAgICAgICAgICAgYmFuZE1hc2tzLnB1c2gocmVzdWx0Lm1hc2tEYXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaVBsYW5lKys7CiAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2sucGl4ZWxzLnB1c2gocmVzdWx0LnBpeGVsRGF0YSk7CiAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2suc3RhdGlzdGljcy5wdXNoKHsKICAgICAgICAgICAgICAgIG1pblZhbHVlOiByZXN1bHQubWluVmFsdWUsCiAgICAgICAgICAgICAgICBtYXhWYWx1ZTogcmVzdWx0Lm1heFZhbHVlLAogICAgICAgICAgICAgICAgbm9EYXRhVmFsdWU6IHJlc3VsdC5ub0RhdGFWYWx1ZSwKICAgICAgICAgICAgICAgIGRpbVN0YXRzOiByZXN1bHQuZGltU3RhdHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaSwgaiwgbnVtUGl4ZWxzOwogICAgICAgICAgICBpZiAobWFqb3JWZXJzaW9uID4gMSAmJiBiYW5kTWFza3MubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgIG51bVBpeGVscyA9IGRlY29kZWRQaXhlbEJsb2NrLndpZHRoICogZGVjb2RlZFBpeGVsQmxvY2suaGVpZ2h0OwogICAgICAgICAgICAgIGRlY29kZWRQaXhlbEJsb2NrLmJhbmRNYXNrcyA9IGJhbmRNYXNrczsKICAgICAgICAgICAgICBtYXNrRGF0YSA9IG5ldyBVaW50OEFycmF5KG51bVBpeGVscyk7CiAgICAgICAgICAgICAgbWFza0RhdGEuc2V0KGJhbmRNYXNrc1swXSk7CiAgICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IGJhbmRNYXNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgYmFuZE1hc2sgPSBiYW5kTWFza3NbaV07CiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbnVtUGl4ZWxzOyBqKyspIHsKICAgICAgICAgICAgICAgICAgbWFza0RhdGFbal0gPSBtYXNrRGF0YVtqXSAmIGJhbmRNYXNrW2pdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5tYXNrRGF0YSA9IG1hc2tEYXRhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkZWNvZGVkUGl4ZWxCbG9jazsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgICAgICAgIGRlZmluZShbXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBMZXJjMjsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG1vZHVsZSAhPT0gInVuZGVmaW5lZCIgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gTGVyYzI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuTGVyYyA9IExlcmMyOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcC5qcwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXBfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXBfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcChwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBpZiAocGFyYW1ldGVycy5lbmNvZGluZyA9PT0gSGVpZ2h0bWFwRW5jb2RpbmdfZGVmYXVsdC5MRVJDKSB7CiAgICAgIGxldCByZXN1bHQ7CiAgICAgIHRyeSB7CiAgICAgICAgcmVzdWx0ID0gaW1wb3J0X2xlcmMuZGVmYXVsdC5kZWNvZGUocGFyYW1ldGVycy5oZWlnaHRtYXApOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdChlcnJvcik7CiAgICAgIH0KICAgICAgY29uc3QgbGVyY1N0YXRpc3RpY3MgPSByZXN1bHQuc3RhdGlzdGljc1swXTsKICAgICAgaWYgKGxlcmNTdGF0aXN0aWNzLm1pblZhbHVlID09PSBOdW1iZXIuTUFYX1ZBTFVFKSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIHRpbGUgZGF0YSIpOwogICAgICB9CiAgICAgIHBhcmFtZXRlcnMuaGVpZ2h0bWFwID0gcmVzdWx0LnBpeGVsc1swXTsKICAgICAgcGFyYW1ldGVycy53aWR0aCA9IHJlc3VsdC53aWR0aDsKICAgICAgcGFyYW1ldGVycy5oZWlnaHQgPSByZXN1bHQuaGVpZ2h0OwogICAgfQogICAgcGFyYW1ldGVycy5lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwYXJhbWV0ZXJzLmVsbGlwc29pZCk7CiAgICBwYXJhbWV0ZXJzLnJlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMucmVjdGFuZ2xlKTsKICAgIGNvbnN0IHN0YXRpc3RpY3MyID0gSGVpZ2h0bWFwVGVzc2VsbGF0b3JfZGVmYXVsdC5jb21wdXRlVmVydGljZXMocGFyYW1ldGVycyk7CiAgICBjb25zdCB2ZXJ0aWNlcyA9IHN0YXRpc3RpY3MyLnZlcnRpY2VzOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHZlcnRpY2VzLmJ1ZmZlcik7CiAgICByZXR1cm4gewogICAgICB2ZXJ0aWNlczogdmVydGljZXMuYnVmZmVyLAogICAgICBudW1iZXJPZkF0dHJpYnV0ZXM6IHN0YXRpc3RpY3MyLmVuY29kaW5nLnN0cmlkZSwKICAgICAgbWluaW11bUhlaWdodDogc3RhdGlzdGljczIubWluaW11bUhlaWdodCwKICAgICAgbWF4aW11bUhlaWdodDogc3RhdGlzdGljczIubWF4aW11bUhlaWdodCwKICAgICAgZ3JpZFdpZHRoOiBwYXJhbWV0ZXJzLndpZHRoLAogICAgICBncmlkSGVpZ2h0OiBwYXJhbWV0ZXJzLmhlaWdodCwKICAgICAgYm91bmRpbmdTcGhlcmUzRDogc3RhdGlzdGljczIuYm91bmRpbmdTcGhlcmUzRCwKICAgICAgb3JpZW50ZWRCb3VuZGluZ0JveDogc3RhdGlzdGljczIub3JpZW50ZWRCb3VuZGluZ0JveCwKICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2U6IHN0YXRpc3RpY3MyLm9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlLAogICAgICBlbmNvZGluZzogc3RhdGlzdGljczIuZW5jb2RpbmcsCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoOiBzdGF0aXN0aWNzMi53ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdDogc3RhdGlzdGljczIuc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGg6IHN0YXRpc3RpY3MyLmVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0OiBzdGF0aXN0aWNzMi5ub3J0aEluZGljZXNXZXN0VG9FYXN0CiAgICB9OwogIH0KICB2YXIgaW1wb3J0X2xlcmMsIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwLmpzIigpIHsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9IZWlnaHRtYXBFbmNvZGluZygpOwogICAgICBpbml0X0hlaWdodG1hcFRlc3NlbGxhdG9yKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGltcG9ydF9sZXJjID0gX190b0VTTShyZXF1aXJlX0xlcmNEZWNvZGUoKSwgMSk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXBfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXApOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpblByb3ZpZGVyLmpzCiAgZnVuY3Rpb24gVGVycmFpblByb3ZpZGVyKCkgewogICAgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcigpOwogIH0KICBmdW5jdGlvbiBnZXRFZGdlSW5kaWNlcyh3aWR0aCwgaGVpZ2h0KSB7CiAgICBjb25zdCB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCA9IG5ldyBBcnJheShoZWlnaHQpOwogICAgY29uc3Qgc291dGhJbmRpY2VzRWFzdFRvV2VzdCA9IG5ldyBBcnJheSh3aWR0aCk7CiAgICBjb25zdCBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCA9IG5ldyBBcnJheShoZWlnaHQpOwogICAgY29uc3Qgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCA9IG5ldyBBcnJheSh3aWR0aCk7CiAgICBsZXQgaTsKICAgIGZvciAoaSA9IDA7IGkgPCB3aWR0aDsgKytpKSB7CiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3RbaV0gPSBpOwogICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0W2ldID0gd2lkdGggKiBoZWlnaHQgLSAxIC0gaTsKICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCBoZWlnaHQ7ICsraSkgewogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aFtpXSA9IChpICsgMSkgKiB3aWR0aCAtIDE7CiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoW2ldID0gKGhlaWdodCAtIGkgLSAxKSAqIHdpZHRoOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0CiAgICB9OwogIH0KICBmdW5jdGlvbiBhZGRSZWd1bGFyR3JpZEluZGljZXMod2lkdGgsIGhlaWdodCwgaW5kaWNlcywgb2Zmc2V0KSB7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBoZWlnaHQgLSAxOyArK2opIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3aWR0aCAtIDE7ICsraSkgewogICAgICAgIGNvbnN0IHVwcGVyTGVmdCA9IGluZGV4OwogICAgICAgIGNvbnN0IGxvd2VyTGVmdCA9IHVwcGVyTGVmdCArIHdpZHRoOwogICAgICAgIGNvbnN0IGxvd2VyUmlnaHQgPSBsb3dlckxlZnQgKyAxOwogICAgICAgIGNvbnN0IHVwcGVyUmlnaHQgPSB1cHBlckxlZnQgKyAxOwogICAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gdXBwZXJMZWZ0OwogICAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gbG93ZXJMZWZ0OwogICAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gdXBwZXJSaWdodDsKICAgICAgICBpbmRpY2VzW29mZnNldCsrXSA9IHVwcGVyUmlnaHQ7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBsb3dlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBsb3dlclJpZ2h0OwogICAgICAgICsraW5kZXg7CiAgICAgIH0KICAgICAgKytpbmRleDsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWRkU2tpcnRJbmRpY2VzKGVkZ2VJbmRpY2VzLCB2ZXJ0ZXhJbmRleCwgaW5kaWNlcywgb2Zmc2V0KSB7CiAgICBsZXQgcHJldmlvdXNJbmRleCA9IGVkZ2VJbmRpY2VzWzBdOwogICAgY29uc3QgbGVuZ3RoID0gZWRnZUluZGljZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBpbmRleCA9IGVkZ2VJbmRpY2VzW2ldOwogICAgICBpbmRpY2VzW29mZnNldCsrXSA9IHByZXZpb3VzSW5kZXg7CiAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gaW5kZXg7CiAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gdmVydGV4SW5kZXg7CiAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gdmVydGV4SW5kZXg7CiAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gaW5kZXg7CiAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gdmVydGV4SW5kZXggKyAxOwogICAgICBwcmV2aW91c0luZGV4ID0gaW5kZXg7CiAgICAgICsrdmVydGV4SW5kZXg7CiAgICB9CiAgICByZXR1cm4gb2Zmc2V0OwogIH0KICB2YXIgcmVndWxhckdyaWRJbmRpY2VzQ2FjaGUsIHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZSwgcmVndWxhckdyaWRBbmRTa2lydEFuZEVkZ2VJbmRpY2VzQ2FjaGUsIFRlcnJhaW5Qcm92aWRlcl9kZWZhdWx0OwogIHZhciBpbml0X1RlcnJhaW5Qcm92aWRlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpblByb3ZpZGVyLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBhbiBldmVudCB0aGF0IGlzIHJhaXNlZCB3aGVuIHRoZSB0ZXJyYWluIHByb3ZpZGVyIGVuY291bnRlcnMgYW4gYXN5bmNocm9ub3VzIGVycm9yLiAgQnkgc3Vic2NyaWJpbmcKICAgICAgICAgKiB0byB0aGUgZXZlbnQsIHlvdSB3aWxsIGJlIG5vdGlmaWVkIG9mIHRoZSBlcnJvciBhbmQgY2FuIHBvdGVudGlhbGx5IHJlY292ZXIgZnJvbSBpdC4gIEV2ZW50IGxpc3RlbmVycwogICAgICAgICAqIGFyZSBwYXNzZWQgYW4gaW5zdGFuY2Ugb2Yge0BsaW5rIFRpbGVQcm92aWRlckVycm9yfS4KICAgICAgICAgKiBAbWVtYmVyb2YgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtFdmVudDxUZXJyYWluUHJvdmlkZXIuRXJyb3JFdmVudD59CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZXJyb3JFdmVudDogewogICAgICAgICAgZ2V0OiBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBjcmVkaXQgdG8gZGlzcGxheSB3aGVuIHRoaXMgdGVycmFpbiBwcm92aWRlciBpcyBhY3RpdmUuICBUeXBpY2FsbHkgdGhpcyBpcyB1c2VkIHRvIGNyZWRpdAogICAgICAgICAqIHRoZSBzb3VyY2Ugb2YgdGhlIHRlcnJhaW4uCiAgICAgICAgICogQG1lbWJlcm9mIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q3JlZGl0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGNyZWRpdDogewogICAgICAgICAgZ2V0OiBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSB0aWxpbmcgc2NoZW1lIHVzZWQgYnkgdGhlIHByb3ZpZGVyLgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge1RpbGluZ1NjaGVtZX0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICB0aWxpbmdTY2hlbWU6IHsKICAgICAgICAgIGdldDogRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcgogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBhIHZhbHVlIGluZGljYXRpbmcgd2hldGhlciBvciBub3QgdGhlIHByb3ZpZGVyIGluY2x1ZGVzIGEgd2F0ZXIgbWFzay4gIFRoZSB3YXRlciBtYXNrCiAgICAgICAgICogaW5kaWNhdGVzIHdoaWNoIGFyZWFzIG9mIHRoZSBnbG9iZSBhcmUgd2F0ZXIgcmF0aGVyIHRoYW4gbGFuZCwgc28gdGhleSBjYW4gYmUgcmVuZGVyZWQKICAgICAgICAgKiBhcyBhIHJlZmxlY3RpdmUgc3VyZmFjZSB3aXRoIGFuaW1hdGVkIHdhdmVzLgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgaGFzV2F0ZXJNYXNrOiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgYSB2YWx1ZSBpbmRpY2F0aW5nIHdoZXRoZXIgb3Igbm90IHRoZSByZXF1ZXN0ZWQgdGlsZXMgaW5jbHVkZSB2ZXJ0ZXggbm9ybWFscy4KICAgICAgICAgKiBAbWVtYmVyb2YgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGhhc1ZlcnRleE5vcm1hbHM6IHsKICAgICAgICAgIGdldDogRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcgogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBhbiBvYmplY3QgdGhhdCBjYW4gYmUgdXNlZCB0byBkZXRlcm1pbmUgYXZhaWxhYmlsaXR5IG9mIHRlcnJhaW4gZnJvbSB0aGlzIHByb3ZpZGVyLCBzdWNoIGFzCiAgICAgICAgICogYXQgcG9pbnRzIGFuZCBpbiByZWN0YW5nbGVzLiBUaGlzIHByb3BlcnR5IG1heSBiZSB1bmRlZmluZWQgaWYgYXZhaWxhYmlsaXR5CiAgICAgICAgICogaW5mb3JtYXRpb24gaXMgbm90IGF2YWlsYWJsZS4KICAgICAgICAgKiBAbWVtYmVyb2YgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtUaWxlQXZhaWxhYmlsaXR5fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGF2YWlsYWJpbGl0eTogewogICAgICAgICAgZ2V0OiBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yCiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmVndWxhckdyaWRJbmRpY2VzQ2FjaGUgPSBbXTsKICAgICAgVGVycmFpblByb3ZpZGVyLmdldFJlZ3VsYXJHcmlkSW5kaWNlcyA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICBpZiAod2lkdGggKiBoZWlnaHQgPj0gTWF0aF9kZWZhdWx0LkZPVVJfR0lHQUJZVEVTKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIlRoZSB0b3RhbCBudW1iZXIgb2YgdmVydGljZXMgKHdpZHRoICogaGVpZ2h0KSBtdXN0IGJlIGxlc3MgdGhhbiA0LDI5NCw5NjcsMjk2LiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGxldCBieVdpZHRoID0gcmVndWxhckdyaWRJbmRpY2VzQ2FjaGVbd2lkdGhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJ5V2lkdGgpKSB7CiAgICAgICAgICByZWd1bGFyR3JpZEluZGljZXNDYWNoZVt3aWR0aF0gPSBieVdpZHRoID0gW107CiAgICAgICAgfQogICAgICAgIGxldCBpbmRpY2VzID0gYnlXaWR0aFtoZWlnaHRdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICBpZiAod2lkdGggKiBoZWlnaHQgPCBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgICAgaW5kaWNlcyA9IGJ5V2lkdGhbaGVpZ2h0XSA9IG5ldyBVaW50MTZBcnJheSgKICAgICAgICAgICAgICAod2lkdGggLSAxKSAqIChoZWlnaHQgLSAxKSAqIDYKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluZGljZXMgPSBieVdpZHRoW2hlaWdodF0gPSBuZXcgVWludDMyQXJyYXkoCiAgICAgICAgICAgICAgKHdpZHRoIC0gMSkgKiAoaGVpZ2h0IC0gMSkgKiA2CiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBhZGRSZWd1bGFyR3JpZEluZGljZXMod2lkdGgsIGhlaWdodCwgaW5kaWNlcywgMCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbmRpY2VzOwogICAgICB9OwogICAgICByZWd1bGFyR3JpZEFuZEVkZ2VJbmRpY2VzQ2FjaGUgPSBbXTsKICAgICAgVGVycmFpblByb3ZpZGVyLmdldFJlZ3VsYXJHcmlkSW5kaWNlc0FuZEVkZ2VJbmRpY2VzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA+PSBNYXRoX2RlZmF1bHQuRk9VUl9HSUdBQllURVMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiVGhlIHRvdGFsIG51bWJlciBvZiB2ZXJ0aWNlcyAod2lkdGggKiBoZWlnaHQpIG11c3QgYmUgbGVzcyB0aGFuIDQsMjk0LDk2NywyOTYuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5V2lkdGggPSByZWd1bGFyR3JpZEFuZEVkZ2VJbmRpY2VzQ2FjaGVbd2lkdGhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJ5V2lkdGgpKSB7CiAgICAgICAgICByZWd1bGFyR3JpZEFuZEVkZ2VJbmRpY2VzQ2FjaGVbd2lkdGhdID0gYnlXaWR0aCA9IFtdOwogICAgICAgIH0KICAgICAgICBsZXQgaW5kaWNlc0FuZEVkZ2VzID0gYnlXaWR0aFtoZWlnaHRdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluZGljZXNBbmRFZGdlcykpIHsKICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBUZXJyYWluUHJvdmlkZXIuZ2V0UmVndWxhckdyaWRJbmRpY2VzKHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgY29uc3QgZWRnZUluZGljZXMgPSBnZXRFZGdlSW5kaWNlcyh3aWR0aCwgaGVpZ2h0KTsKICAgICAgICAgIGNvbnN0IHdlc3RJbmRpY2VzU291dGhUb05vcnRoID0gZWRnZUluZGljZXMud2VzdEluZGljZXNTb3V0aFRvTm9ydGg7CiAgICAgICAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gZWRnZUluZGljZXMuc291dGhJbmRpY2VzRWFzdFRvV2VzdDsKICAgICAgICAgIGNvbnN0IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoID0gZWRnZUluZGljZXMuZWFzdEluZGljZXNOb3J0aFRvU291dGg7CiAgICAgICAgICBjb25zdCBub3J0aEluZGljZXNXZXN0VG9FYXN0ID0gZWRnZUluZGljZXMubm9ydGhJbmRpY2VzV2VzdFRvRWFzdDsKICAgICAgICAgIGluZGljZXNBbmRFZGdlcyA9IGJ5V2lkdGhbaGVpZ2h0XSA9IHsKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgICAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgICAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICAgICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5kaWNlc0FuZEVkZ2VzOwogICAgICB9OwogICAgICByZWd1bGFyR3JpZEFuZFNraXJ0QW5kRWRnZUluZGljZXNDYWNoZSA9IFtdOwogICAgICBUZXJyYWluUHJvdmlkZXIuZ2V0UmVndWxhckdyaWRBbmRTa2lydEluZGljZXNBbmRFZGdlSW5kaWNlcyA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICBpZiAod2lkdGggKiBoZWlnaHQgPj0gTWF0aF9kZWZhdWx0LkZPVVJfR0lHQUJZVEVTKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIlRoZSB0b3RhbCBudW1iZXIgb2YgdmVydGljZXMgKHdpZHRoICogaGVpZ2h0KSBtdXN0IGJlIGxlc3MgdGhhbiA0LDI5NCw5NjcsMjk2LiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGxldCBieVdpZHRoID0gcmVndWxhckdyaWRBbmRTa2lydEFuZEVkZ2VJbmRpY2VzQ2FjaGVbd2lkdGhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJ5V2lkdGgpKSB7CiAgICAgICAgICByZWd1bGFyR3JpZEFuZFNraXJ0QW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF0gPSBieVdpZHRoID0gW107CiAgICAgICAgfQogICAgICAgIGxldCBpbmRpY2VzQW5kRWRnZXMgPSBieVdpZHRoW2hlaWdodF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlc0FuZEVkZ2VzKSkgewogICAgICAgICAgY29uc3QgZ3JpZFZlcnRleENvdW50ID0gd2lkdGggKiBoZWlnaHQ7CiAgICAgICAgICBjb25zdCBncmlkSW5kZXhDb3VudCA9ICh3aWR0aCAtIDEpICogKGhlaWdodCAtIDEpICogNjsKICAgICAgICAgIGNvbnN0IGVkZ2VWZXJ0ZXhDb3VudCA9IHdpZHRoICogMiArIGhlaWdodCAqIDI7CiAgICAgICAgICBjb25zdCBlZGdlSW5kZXhDb3VudCA9IE1hdGgubWF4KDAsIGVkZ2VWZXJ0ZXhDb3VudCAtIDQpICogNjsKICAgICAgICAgIGNvbnN0IHZlcnRleENvdW50ID0gZ3JpZFZlcnRleENvdW50ICsgZWRnZVZlcnRleENvdW50OwogICAgICAgICAgY29uc3QgaW5kZXhDb3VudCA9IGdyaWRJbmRleENvdW50ICsgZWRnZUluZGV4Q291bnQ7CiAgICAgICAgICBjb25zdCBlZGdlSW5kaWNlcyA9IGdldEVkZ2VJbmRpY2VzKHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgY29uc3Qgd2VzdEluZGljZXNTb3V0aFRvTm9ydGggPSBlZGdlSW5kaWNlcy53ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aDsKICAgICAgICAgIGNvbnN0IHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QgPSBlZGdlSW5kaWNlcy5zb3V0aEluZGljZXNFYXN0VG9XZXN0OwogICAgICAgICAgY29uc3QgZWFzdEluZGljZXNOb3J0aFRvU291dGggPSBlZGdlSW5kaWNlcy5lYXN0SW5kaWNlc05vcnRoVG9Tb3V0aDsKICAgICAgICAgIGNvbnN0IG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QgPSBlZGdlSW5kaWNlcy5ub3J0aEluZGljZXNXZXN0VG9FYXN0OwogICAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHZlcnRleENvdW50LCBpbmRleENvdW50KTsKICAgICAgICAgIGFkZFJlZ3VsYXJHcmlkSW5kaWNlcyh3aWR0aCwgaGVpZ2h0LCBpbmRpY2VzLCAwKTsKICAgICAgICAgIFRlcnJhaW5Qcm92aWRlci5hZGRTa2lydEluZGljZXMoCiAgICAgICAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICAgICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgICAgICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwKICAgICAgICAgICAgZ3JpZFZlcnRleENvdW50LAogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICBncmlkSW5kZXhDb3VudAogICAgICAgICAgKTsKICAgICAgICAgIGluZGljZXNBbmRFZGdlcyA9IGJ5V2lkdGhbaGVpZ2h0XSA9IHsKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgICAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgICAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICAgICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LAogICAgICAgICAgICBpbmRleENvdW50V2l0aG91dFNraXJ0czogZ3JpZEluZGV4Q291bnQKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbmRpY2VzQW5kRWRnZXM7CiAgICAgIH07CiAgICAgIFRlcnJhaW5Qcm92aWRlci5hZGRTa2lydEluZGljZXMgPSBmdW5jdGlvbih3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwgZWFzdEluZGljZXNOb3J0aFRvU291dGgsIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsIHZlcnRleENvdW50LCBpbmRpY2VzLCBvZmZzZXQpIHsKICAgICAgICBsZXQgdmVydGV4SW5kZXggPSB2ZXJ0ZXhDb3VudDsKICAgICAgICBvZmZzZXQgPSBhZGRTa2lydEluZGljZXMoCiAgICAgICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgICAgIHZlcnRleEluZGV4LAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIG9mZnNldAogICAgICAgICk7CiAgICAgICAgdmVydGV4SW5kZXggKz0gd2VzdEluZGljZXNTb3V0aFRvTm9ydGgubGVuZ3RoOwogICAgICAgIG9mZnNldCA9IGFkZFNraXJ0SW5kaWNlcygKICAgICAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgICAgICB2ZXJ0ZXhJbmRleCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBvZmZzZXQKICAgICAgICApOwogICAgICAgIHZlcnRleEluZGV4ICs9IHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QubGVuZ3RoOwogICAgICAgIG9mZnNldCA9IGFkZFNraXJ0SW5kaWNlcygKICAgICAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICAgICAgdmVydGV4SW5kZXgsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgb2Zmc2V0CiAgICAgICAgKTsKICAgICAgICB2ZXJ0ZXhJbmRleCArPSBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aC5sZW5ndGg7CiAgICAgICAgYWRkU2tpcnRJbmRpY2VzKG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsIHZlcnRleEluZGV4LCBpbmRpY2VzLCBvZmZzZXQpOwogICAgICB9OwogICAgICBUZXJyYWluUHJvdmlkZXIuaGVpZ2h0bWFwVGVycmFpblF1YWxpdHkgPSAwLjI1OwogICAgICBUZXJyYWluUHJvdmlkZXIuZ2V0RXN0aW1hdGVkTGV2ZWxaZXJvR2VvbWV0cmljRXJyb3JGb3JBSGVpZ2h0bWFwID0gZnVuY3Rpb24oZWxsaXBzb2lkLCB0aWxlSW1hZ2VXaWR0aCwgbnVtYmVyT2ZUaWxlc0F0TGV2ZWxaZXJvKSB7CiAgICAgICAgcmV0dXJuIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzICogMiAqIE1hdGguUEkgKiBUZXJyYWluUHJvdmlkZXIuaGVpZ2h0bWFwVGVycmFpblF1YWxpdHkgLyAodGlsZUltYWdlV2lkdGggKiBudW1iZXJPZlRpbGVzQXRMZXZlbFplcm8pOwogICAgICB9OwogICAgICBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlLnJlcXVlc3RUaWxlR2VvbWV0cnkgPSBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yOwogICAgICBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlLmdldExldmVsTWF4aW11bUdlb21ldHJpY0Vycm9yID0gRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcjsKICAgICAgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZS5nZXRUaWxlRGF0YUF2YWlsYWJsZSA9IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3I7CiAgICAgIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUubG9hZFRpbGVEYXRhQXZhaWxhYmlsaXR5ID0gRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcjsKICAgICAgVGVycmFpblByb3ZpZGVyX2RlZmF1bHQgPSBUZXJyYWluUHJvdmlkZXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaC5qcwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2hfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2hfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHF1YW50aXplZFZlcnRpY2VzID0gcGFyYW1ldGVycy5xdWFudGl6ZWRWZXJ0aWNlczsKICAgIGNvbnN0IHF1YW50aXplZFZlcnRleENvdW50ID0gcXVhbnRpemVkVmVydGljZXMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IG9jdEVuY29kZWROb3JtYWxzID0gcGFyYW1ldGVycy5vY3RFbmNvZGVkTm9ybWFsczsKICAgIGNvbnN0IGVkZ2VWZXJ0ZXhDb3VudCA9IHBhcmFtZXRlcnMud2VzdEluZGljZXMubGVuZ3RoICsgcGFyYW1ldGVycy5lYXN0SW5kaWNlcy5sZW5ndGggKyBwYXJhbWV0ZXJzLnNvdXRoSW5kaWNlcy5sZW5ndGggKyBwYXJhbWV0ZXJzLm5vcnRoSW5kaWNlcy5sZW5ndGg7CiAgICBjb25zdCBpbmNsdWRlV2ViTWVyY2F0b3JUID0gcGFyYW1ldGVycy5pbmNsdWRlV2ViTWVyY2F0b3JUOwogICAgY29uc3QgZXhhZ2dlcmF0aW9uID0gcGFyYW1ldGVycy5leGFnZ2VyYXRpb247CiAgICBjb25zdCBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCA9IHBhcmFtZXRlcnMuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQ7CiAgICBjb25zdCBoYXNFeGFnZ2VyYXRpb24gPSBleGFnZ2VyYXRpb24gIT09IDE7CiAgICBjb25zdCBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGhhc0V4YWdnZXJhdGlvbjsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMucmVjdGFuZ2xlKTsKICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgY29uc3QgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgY29uc3Qgbm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwYXJhbWV0ZXJzLmVsbGlwc29pZCk7CiAgICBjb25zdCBtaW5pbXVtSGVpZ2h0ID0gcGFyYW1ldGVycy5taW5pbXVtSGVpZ2h0OwogICAgY29uc3QgbWF4aW11bUhlaWdodCA9IHBhcmFtZXRlcnMubWF4aW11bUhlaWdodDsKICAgIGNvbnN0IGNlbnRlciA9IHBhcmFtZXRlcnMucmVsYXRpdmVUb0NlbnRlcjsKICAgIGNvbnN0IGZyb21FTlUgPSBUcmFuc2Zvcm1zX2RlZmF1bHQuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUoY2VudGVyLCBlbGxpcHNvaWQpOwogICAgY29uc3QgdG9FTlUgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKGZyb21FTlUsIG5ldyBNYXRyaXg0X2RlZmF1bHQoKSk7CiAgICBsZXQgc291dGhNZXJjYXRvclk7CiAgICBsZXQgb25lT3Zlck1lcmNhdG9ySGVpZ2h0OwogICAgaWYgKGluY2x1ZGVXZWJNZXJjYXRvclQpIHsKICAgICAgc291dGhNZXJjYXRvclkgPSBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKHNvdXRoKTsKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0ID0gMSAvIChXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKG5vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgIH0KICAgIGNvbnN0IHVCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgwLCBxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCB2QnVmZmVyID0gcXVhbnRpemVkVmVydGljZXMuc3ViYXJyYXkoCiAgICAgIHF1YW50aXplZFZlcnRleENvdW50LAogICAgICAyICogcXVhbnRpemVkVmVydGV4Q291bnQKICAgICk7CiAgICBjb25zdCBoZWlnaHRCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgKICAgICAgcXVhbnRpemVkVmVydGV4Q291bnQgKiAyLAogICAgICAzICogcXVhbnRpemVkVmVydGV4Q291bnQKICAgICk7CiAgICBjb25zdCBoYXNWZXJ0ZXhOb3JtYWxzID0gZGVmaW5lZF9kZWZhdWx0KG9jdEVuY29kZWROb3JtYWxzKTsKICAgIGNvbnN0IHV2cyA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCkgOiBbXTsKICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbHMgPSBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA/IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCkgOiBbXTsKICAgIGNvbnN0IG1pbmltdW0gPSBzY3JhdGNoTWluaW11bTsKICAgIG1pbmltdW0ueCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGNvbnN0IG1heGltdW0gPSBzY3JhdGNoTWF4aW11bTsKICAgIG1heGltdW0ueCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueiA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGxldCBtaW5Mb25naXR1ZGUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4TG9uZ2l0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IG1pbkxhdGl0dWRlID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IG1heExhdGl0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWFudGl6ZWRWZXJ0ZXhDb3VudDsgKytpKSB7CiAgICAgIGNvbnN0IHJhd1UgPSB1QnVmZmVyW2ldOwogICAgICBjb25zdCByYXdWID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgdTMgPSByYXdVIC8gbWF4U2hvcnQ0OwogICAgICBjb25zdCB2MyA9IHJhd1YgLyBtYXhTaG9ydDQ7CiAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGhfZGVmYXVsdC5sZXJwKAogICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICBoZWlnaHRCdWZmZXJbaV0gLyBtYXhTaG9ydDQKICAgICAgKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5sb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycCh3ZXN0LCBlYXN0LCB1Myk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHYzKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIG1pbkxvbmdpdHVkZSA9IE1hdGgubWluKGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlLCBtaW5Mb25naXR1ZGUpOwogICAgICBtYXhMb25naXR1ZGUgPSBNYXRoLm1heChjYXJ0b2dyYXBoaWNTY3JhdGNoLmxvbmdpdHVkZSwgbWF4TG9uZ2l0dWRlKTsKICAgICAgbWluTGF0aXR1ZGUgPSBNYXRoLm1pbihjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlLCBtaW5MYXRpdHVkZSk7CiAgICAgIG1heExhdGl0dWRlID0gTWF0aC5tYXgoY2FydG9ncmFwaGljU2NyYXRjaC5sYXRpdHVkZSwgbWF4TGF0aXR1ZGUpOwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0b2dyYXBoaWNTY3JhdGNoKTsKICAgICAgdXZzW2ldID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh1MywgdjMpOwogICAgICBoZWlnaHRzW2ldID0gaGVpZ2h0OwogICAgICBwb3NpdGlvbnNbaV0gPSBwb3NpdGlvbjsKICAgICAgaWYgKGluY2x1ZGVXZWJNZXJjYXRvclQpIHsKICAgICAgICB3ZWJNZXJjYXRvclRzW2ldID0gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlCiAgICAgICAgKSAtIHNvdXRoTWVyY2F0b3JZKSAqIG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgfQogICAgICBpZiAoaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzW2ldID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbik7CiAgICAgIH0KICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCh0b0VOVSwgcG9zaXRpb24sIGNhcnRlc2lhbjNTY3JhdGNoOCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5taW5pbXVtQnlDb21wb25lbnQoY2FydGVzaWFuM1NjcmF0Y2g4LCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1CeUNvbXBvbmVudChjYXJ0ZXNpYW4zU2NyYXRjaDgsIG1heGltdW0sIG1heGltdW0pOwogICAgfQogICAgY29uc3Qgd2VzdEluZGljZXNTb3V0aFRvTm9ydGggPSBjb3B5QW5kU29ydCgKICAgICAgcGFyYW1ldGVycy53ZXN0SW5kaWNlcywKICAgICAgZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgICByZXR1cm4gdXZzW2EzXS55IC0gdXZzW2JdLnk7CiAgICAgIH0KICAgICk7CiAgICBjb25zdCBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCA9IGNvcHlBbmRTb3J0KAogICAgICBwYXJhbWV0ZXJzLmVhc3RJbmRpY2VzLAogICAgICBmdW5jdGlvbihhMywgYikgewogICAgICAgIHJldHVybiB1dnNbYl0ueSAtIHV2c1thM10ueTsKICAgICAgfQogICAgKTsKICAgIGNvbnN0IHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QgPSBjb3B5QW5kU29ydCgKICAgICAgcGFyYW1ldGVycy5zb3V0aEluZGljZXMsCiAgICAgIGZ1bmN0aW9uKGEzLCBiKSB7CiAgICAgICAgcmV0dXJuIHV2c1tiXS54IC0gdXZzW2EzXS54OwogICAgICB9CiAgICApOwogICAgY29uc3Qgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCA9IGNvcHlBbmRTb3J0KAogICAgICBwYXJhbWV0ZXJzLm5vcnRoSW5kaWNlcywKICAgICAgZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgICByZXR1cm4gdXZzW2EzXS54IC0gdXZzW2JdLng7CiAgICAgIH0KICAgICk7CiAgICBsZXQgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2U7CiAgICBpZiAobWluaW11bUhlaWdodCA8IDApIHsKICAgICAgY29uc3Qgb2NjbHVkZXIgPSBuZXcgRWxsaXBzb2lkYWxPY2NsdWRlcl9kZWZhdWx0KGVsbGlwc29pZCk7CiAgICAgIG9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlID0gb2NjbHVkZXIuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRQb3NzaWJseVVuZGVyRWxsaXBzb2lkKAogICAgICAgIGNlbnRlciwKICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgbWluaW11bUhlaWdodAogICAgICApOwogICAgfQogICAgbGV0IGhNaW4gPSBtaW5pbXVtSGVpZ2h0OwogICAgaE1pbiA9IE1hdGgubWluKAogICAgICBoTWluLAogICAgICBmaW5kTWluTWF4U2tpcnRzKAogICAgICAgIHBhcmFtZXRlcnMud2VzdEluZGljZXMsCiAgICAgICAgcGFyYW1ldGVycy53ZXN0U2tpcnRIZWlnaHQsCiAgICAgICAgaGVpZ2h0cywKICAgICAgICB1dnMsCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB0b0VOVSwKICAgICAgICBtaW5pbXVtLAogICAgICAgIG1heGltdW0KICAgICAgKQogICAgKTsKICAgIGhNaW4gPSBNYXRoLm1pbigKICAgICAgaE1pbiwKICAgICAgZmluZE1pbk1heFNraXJ0cygKICAgICAgICBwYXJhbWV0ZXJzLnNvdXRoSW5kaWNlcywKICAgICAgICBwYXJhbWV0ZXJzLnNvdXRoU2tpcnRIZWlnaHQsCiAgICAgICAgaGVpZ2h0cywKICAgICAgICB1dnMsCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB0b0VOVSwKICAgICAgICBtaW5pbXVtLAogICAgICAgIG1heGltdW0KICAgICAgKQogICAgKTsKICAgIGhNaW4gPSBNYXRoLm1pbigKICAgICAgaE1pbiwKICAgICAgZmluZE1pbk1heFNraXJ0cygKICAgICAgICBwYXJhbWV0ZXJzLmVhc3RJbmRpY2VzLAogICAgICAgIHBhcmFtZXRlcnMuZWFzdFNraXJ0SGVpZ2h0LAogICAgICAgIGhlaWdodHMsCiAgICAgICAgdXZzLAogICAgICAgIHJlY3RhbmdsZSwKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgdG9FTlUsCiAgICAgICAgbWluaW11bSwKICAgICAgICBtYXhpbXVtCiAgICAgICkKICAgICk7CiAgICBoTWluID0gTWF0aC5taW4oCiAgICAgIGhNaW4sCiAgICAgIGZpbmRNaW5NYXhTa2lydHMoCiAgICAgICAgcGFyYW1ldGVycy5ub3J0aEluZGljZXMsCiAgICAgICAgcGFyYW1ldGVycy5ub3J0aFNraXJ0SGVpZ2h0LAogICAgICAgIGhlaWdodHMsCiAgICAgICAgdXZzLAogICAgICAgIHJlY3RhbmdsZSwKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgdG9FTlUsCiAgICAgICAgbWluaW11bSwKICAgICAgICBtYXhpbXVtCiAgICAgICkKICAgICk7CiAgICBjb25zdCBhYUJveCA9IG5ldyBBeGlzQWxpZ25lZEJvdW5kaW5nQm94X2RlZmF1bHQobWluaW11bSwgbWF4aW11bSwgY2VudGVyKTsKICAgIGNvbnN0IGVuY29kaW5nID0gbmV3IFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0KAogICAgICBjZW50ZXIsCiAgICAgIGFhQm94LAogICAgICBoTWluLAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICBmcm9tRU5VLAogICAgICBoYXNWZXJ0ZXhOb3JtYWxzLAogICAgICBpbmNsdWRlV2ViTWVyY2F0b3JULAogICAgICBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscywKICAgICAgZXhhZ2dlcmF0aW9uLAogICAgICBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgKTsKICAgIGNvbnN0IHZlcnRleFN0cmlkZSA9IGVuY29kaW5nLnN0cmlkZTsKICAgIGNvbnN0IHNpemUgPSBxdWFudGl6ZWRWZXJ0ZXhDb3VudCAqIHZlcnRleFN0cmlkZSArIGVkZ2VWZXJ0ZXhDb3VudCAqIHZlcnRleFN0cmlkZTsKICAgIGNvbnN0IHZlcnRleEJ1ZmZlciA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSk7CiAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBxdWFudGl6ZWRWZXJ0ZXhDb3VudDsgKytqKSB7CiAgICAgIGlmIChoYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgY29uc3QgbiA9IGogKiAyOwogICAgICAgIHRvUGFjay54ID0gb2N0RW5jb2RlZE5vcm1hbHNbbl07CiAgICAgICAgdG9QYWNrLnkgPSBvY3RFbmNvZGVkTm9ybWFsc1tuICsgMV07CiAgICAgIH0KICAgICAgYnVmZmVySW5kZXggPSBlbmNvZGluZy5lbmNvZGUoCiAgICAgICAgdmVydGV4QnVmZmVyLAogICAgICAgIGJ1ZmZlckluZGV4LAogICAgICAgIHBvc2l0aW9uc1tqXSwKICAgICAgICB1dnNbal0sCiAgICAgICAgaGVpZ2h0c1tqXSwKICAgICAgICB0b1BhY2ssCiAgICAgICAgd2ViTWVyY2F0b3JUc1tqXSwKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzW2pdCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBlZGdlVHJpYW5nbGVDb3VudCA9IE1hdGgubWF4KDAsIChlZGdlVmVydGV4Q291bnQgLSA0KSAqIDIpOwogICAgY29uc3QgaW5kZXhCdWZmZXJMZW5ndGggPSBwYXJhbWV0ZXJzLmluZGljZXMubGVuZ3RoICsgZWRnZVRyaWFuZ2xlQ291bnQgKiAzOwogICAgY29uc3QgaW5kZXhCdWZmZXIgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgcXVhbnRpemVkVmVydGV4Q291bnQgKyBlZGdlVmVydGV4Q291bnQsCiAgICAgIGluZGV4QnVmZmVyTGVuZ3RoCiAgICApOwogICAgaW5kZXhCdWZmZXIuc2V0KHBhcmFtZXRlcnMuaW5kaWNlcywgMCk7CiAgICBjb25zdCBwZXJjZW50YWdlID0gMWUtNDsKICAgIGNvbnN0IGxvbk9mZnNldCA9IChtYXhMb25naXR1ZGUgLSBtaW5Mb25naXR1ZGUpICogcGVyY2VudGFnZTsKICAgIGNvbnN0IGxhdE9mZnNldCA9IChtYXhMYXRpdHVkZSAtIG1pbkxhdGl0dWRlKSAqIHBlcmNlbnRhZ2U7CiAgICBjb25zdCB3ZXN0TG9uZ2l0dWRlT2Zmc2V0ID0gLWxvbk9mZnNldDsKICAgIGNvbnN0IHdlc3RMYXRpdHVkZU9mZnNldCA9IDA7CiAgICBjb25zdCBlYXN0TG9uZ2l0dWRlT2Zmc2V0ID0gbG9uT2Zmc2V0OwogICAgY29uc3QgZWFzdExhdGl0dWRlT2Zmc2V0ID0gMDsKICAgIGNvbnN0IG5vcnRoTG9uZ2l0dWRlT2Zmc2V0ID0gMDsKICAgIGNvbnN0IG5vcnRoTGF0aXR1ZGVPZmZzZXQgPSBsYXRPZmZzZXQ7CiAgICBjb25zdCBzb3V0aExvbmdpdHVkZU9mZnNldCA9IDA7CiAgICBjb25zdCBzb3V0aExhdGl0dWRlT2Zmc2V0ID0gLWxhdE9mZnNldDsKICAgIGxldCB2ZXJ0ZXhCdWZmZXJJbmRleCA9IHF1YW50aXplZFZlcnRleENvdW50ICogdmVydGV4U3RyaWRlOwogICAgYWRkU2tpcnQyKAogICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgIHZlcnRleEJ1ZmZlckluZGV4LAogICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgZW5jb2RpbmcsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgb2N0RW5jb2RlZE5vcm1hbHMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgcmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLndlc3RTa2lydEhlaWdodCwKICAgICAgc291dGhNZXJjYXRvclksCiAgICAgIG9uZU92ZXJNZXJjYXRvckhlaWdodCwKICAgICAgd2VzdExvbmdpdHVkZU9mZnNldCwKICAgICAgd2VzdExhdGl0dWRlT2Zmc2V0CiAgICApOwogICAgdmVydGV4QnVmZmVySW5kZXggKz0gcGFyYW1ldGVycy53ZXN0SW5kaWNlcy5sZW5ndGggKiB2ZXJ0ZXhTdHJpZGU7CiAgICBhZGRTa2lydDIoCiAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgdmVydGV4QnVmZmVySW5kZXgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVuY29kaW5nLAogICAgICBoZWlnaHRzLAogICAgICB1dnMsCiAgICAgIG9jdEVuY29kZWROb3JtYWxzLAogICAgICBlbGxpcHNvaWQsCiAgICAgIHJlY3RhbmdsZSwKICAgICAgcGFyYW1ldGVycy5zb3V0aFNraXJ0SGVpZ2h0LAogICAgICBzb3V0aE1lcmNhdG9yWSwKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0LAogICAgICBzb3V0aExvbmdpdHVkZU9mZnNldCwKICAgICAgc291dGhMYXRpdHVkZU9mZnNldAogICAgKTsKICAgIHZlcnRleEJ1ZmZlckluZGV4ICs9IHBhcmFtZXRlcnMuc291dGhJbmRpY2VzLmxlbmd0aCAqIHZlcnRleFN0cmlkZTsKICAgIGFkZFNraXJ0MigKICAgICAgdmVydGV4QnVmZmVyLAogICAgICB2ZXJ0ZXhCdWZmZXJJbmRleCwKICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgIGVuY29kaW5nLAogICAgICBoZWlnaHRzLAogICAgICB1dnMsCiAgICAgIG9jdEVuY29kZWROb3JtYWxzLAogICAgICBlbGxpcHNvaWQsCiAgICAgIHJlY3RhbmdsZSwKICAgICAgcGFyYW1ldGVycy5lYXN0U2tpcnRIZWlnaHQsCiAgICAgIHNvdXRoTWVyY2F0b3JZLAogICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQsCiAgICAgIGVhc3RMb25naXR1ZGVPZmZzZXQsCiAgICAgIGVhc3RMYXRpdHVkZU9mZnNldAogICAgKTsKICAgIHZlcnRleEJ1ZmZlckluZGV4ICs9IHBhcmFtZXRlcnMuZWFzdEluZGljZXMubGVuZ3RoICogdmVydGV4U3RyaWRlOwogICAgYWRkU2tpcnQyKAogICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgIHZlcnRleEJ1ZmZlckluZGV4LAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LAogICAgICBlbmNvZGluZywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICBvY3RFbmNvZGVkTm9ybWFscywKICAgICAgZWxsaXBzb2lkLAogICAgICByZWN0YW5nbGUsCiAgICAgIHBhcmFtZXRlcnMubm9ydGhTa2lydEhlaWdodCwKICAgICAgc291dGhNZXJjYXRvclksCiAgICAgIG9uZU92ZXJNZXJjYXRvckhlaWdodCwKICAgICAgbm9ydGhMb25naXR1ZGVPZmZzZXQsCiAgICAgIG5vcnRoTGF0aXR1ZGVPZmZzZXQKICAgICk7CiAgICBUZXJyYWluUHJvdmlkZXJfZGVmYXVsdC5hZGRTa2lydEluZGljZXMoCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwKICAgICAgcXVhbnRpemVkVmVydGV4Q291bnQsCiAgICAgIGluZGV4QnVmZmVyLAogICAgICBwYXJhbWV0ZXJzLmluZGljZXMubGVuZ3RoCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHZlcnRleEJ1ZmZlci5idWZmZXIsIGluZGV4QnVmZmVyLmJ1ZmZlcik7CiAgICByZXR1cm4gewogICAgICB2ZXJ0aWNlczogdmVydGV4QnVmZmVyLmJ1ZmZlciwKICAgICAgaW5kaWNlczogaW5kZXhCdWZmZXIuYnVmZmVyLAogICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsCiAgICAgIHZlcnRleFN0cmlkZSwKICAgICAgY2VudGVyLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZSwKICAgICAgZW5jb2RpbmcsCiAgICAgIGluZGV4Q291bnRXaXRob3V0U2tpcnRzOiBwYXJhbWV0ZXJzLmluZGljZXMubGVuZ3RoCiAgICB9OwogIH0KICBmdW5jdGlvbiBmaW5kTWluTWF4U2tpcnRzKGVkZ2VJbmRpY2VzLCBlZGdlSGVpZ2h0LCBoZWlnaHRzLCB1dnMsIHJlY3RhbmdsZSwgZWxsaXBzb2lkLCB0b0VOVSwgbWluaW11bSwgbWF4aW11bSkgewogICAgbGV0IGhNaW4gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgIGlmIChlYXN0IDwgd2VzdCkgewogICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSBlZGdlSW5kaWNlcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gZWRnZUluZGljZXNbaV07CiAgICAgIGNvbnN0IGggPSBoZWlnaHRzW2luZGV4XTsKICAgICAgY29uc3QgdXYgPSB1dnNbaW5kZXhdOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5sZXJwKHdlc3QsIGVhc3QsIHV2LngpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAoc291dGgsIG5vcnRoLCB1di55KTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5oZWlnaHQgPSBoIC0gZWRnZUhlaWdodDsKICAgICAgY29uc3QgcG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydG9ncmFwaGljU2NyYXRjaCwKICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDgKICAgICAgKTsKICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCh0b0VOVSwgcG9zaXRpb24sIHBvc2l0aW9uKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pbmltdW1CeUNvbXBvbmVudChwb3NpdGlvbiwgbWluaW11bSwgbWluaW11bSk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYXhpbXVtQnlDb21wb25lbnQocG9zaXRpb24sIG1heGltdW0sIG1heGltdW0pOwogICAgICBoTWluID0gTWF0aC5taW4oaE1pbiwgY2FydG9ncmFwaGljU2NyYXRjaC5oZWlnaHQpOwogICAgfQogICAgcmV0dXJuIGhNaW47CiAgfQogIGZ1bmN0aW9uIGFkZFNraXJ0Mih2ZXJ0ZXhCdWZmZXIsIHZlcnRleEJ1ZmZlckluZGV4LCBlZGdlVmVydGljZXMsIGVuY29kaW5nLCBoZWlnaHRzLCB1dnMsIG9jdEVuY29kZWROb3JtYWxzLCBlbGxpcHNvaWQsIHJlY3RhbmdsZSwgc2tpcnRMZW5ndGgsIHNvdXRoTWVyY2F0b3JZLCBvbmVPdmVyTWVyY2F0b3JIZWlnaHQsIGxvbmdpdHVkZU9mZnNldCwgbGF0aXR1ZGVPZmZzZXQpIHsKICAgIGNvbnN0IGhhc1ZlcnRleE5vcm1hbHMgPSBkZWZpbmVkX2RlZmF1bHQob2N0RW5jb2RlZE5vcm1hbHMpOwogICAgY29uc3Qgbm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICBjb25zdCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICBpZiAoZWFzdCA8IHdlc3QpIHsKICAgICAgZWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgfQogICAgY29uc3QgbGVuZ3RoID0gZWRnZVZlcnRpY2VzLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgaW5kZXggPSBlZGdlVmVydGljZXNbaV07CiAgICAgIGNvbnN0IGggPSBoZWlnaHRzW2luZGV4XTsKICAgICAgY29uc3QgdXYgPSB1dnNbaW5kZXhdOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5sZXJwKHdlc3QsIGVhc3QsIHV2LngpICsgbG9uZ2l0dWRlT2Zmc2V0OwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAoc291dGgsIG5vcnRoLCB1di55KSArIGxhdGl0dWRlT2Zmc2V0OwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCA9IGggLSBza2lydExlbmd0aDsKICAgICAgY29uc3QgcG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydG9ncmFwaGljU2NyYXRjaCwKICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDgKICAgICAgKTsKICAgICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICBjb25zdCBuID0gaW5kZXggKiAyOwogICAgICAgIHRvUGFjay54ID0gb2N0RW5jb2RlZE5vcm1hbHNbbl07CiAgICAgICAgdG9QYWNrLnkgPSBvY3RFbmNvZGVkTm9ybWFsc1tuICsgMV07CiAgICAgIH0KICAgICAgbGV0IHdlYk1lcmNhdG9yVDsKICAgICAgaWYgKGVuY29kaW5nLmhhc1dlYk1lcmNhdG9yVCkgewogICAgICAgIHdlYk1lcmNhdG9yVCA9IChXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKAogICAgICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5sYXRpdHVkZQogICAgICAgICkgLSBzb3V0aE1lcmNhdG9yWSkgKiBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICAgIH0KICAgICAgbGV0IGdlb2RldGljU3VyZmFjZU5vcm1hbDsKICAgICAgaWYgKGVuY29kaW5nLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uKTsKICAgICAgfQogICAgICB2ZXJ0ZXhCdWZmZXJJbmRleCA9IGVuY29kaW5nLmVuY29kZSgKICAgICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgICAgdmVydGV4QnVmZmVySW5kZXgsCiAgICAgICAgcG9zaXRpb24sCiAgICAgICAgdXYsCiAgICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5oZWlnaHQsCiAgICAgICAgdG9QYWNrLAogICAgICAgIHdlYk1lcmNhdG9yVCwKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWwKICAgICAgKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gY29weUFuZFNvcnQodHlwZWRBcnJheSwgY29tcGFyYXRvcikgewogICAgbGV0IGNvcHk7CiAgICBpZiAodHlwZW9mIHR5cGVkQXJyYXkuc2xpY2UgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgY29weSA9IHR5cGVkQXJyYXkuc2xpY2UoKTsKICAgICAgaWYgKHR5cGVvZiBjb3B5LnNvcnQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBjb3B5ID0gdm9pZCAwOwogICAgICB9CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb3B5KSkgewogICAgICBjb3B5ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodHlwZWRBcnJheSk7CiAgICB9CiAgICBjb3B5LnNvcnQoY29tcGFyYXRvcik7CiAgICByZXR1cm4gY29weTsKICB9CiAgdmFyIG1heFNob3J0NCwgY2FydGVzaWFuM1NjcmF0Y2g4LCBzY3JhdGNoTWluaW11bSwgc2NyYXRjaE1heGltdW0sIGNhcnRvZ3JhcGhpY1NjcmF0Y2gsIHRvUGFjaywgY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2hfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2guanMiKCkgewogICAgICBpbml0X0F4aXNBbGlnbmVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRhbE9jY2x1ZGVyKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfVGVycmFpbkVuY29kaW5nKCk7CiAgICAgIGluaXRfVGVycmFpblByb3ZpZGVyKCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgbWF4U2hvcnQ0ID0gMzI3Njc7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1pbmltdW0gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNYXhpbXVtID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHRvUGFjayA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2hfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdCgKICAgICAgICBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaAogICAgICApOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2FsbEdlb21ldHJ5TGlicmFyeS5qcwogIGZ1bmN0aW9uIGxhdExvbkVxdWFscyhjMCwgYzEpIHsKICAgIHJldHVybiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihjMC5sYXRpdHVkZSwgYzEubGF0aXR1ZGUsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGMwLmxvbmdpdHVkZSwgYzEubG9uZ2l0dWRlLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKTsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlRHVwbGljYXRlczIoZWxsaXBzb2lkLCBwb3NpdGlvbnMsIHRvcEhlaWdodHMsIGJvdHRvbUhlaWdodHMpIHsKICAgIHBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KHBvc2l0aW9ucywgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24pOwogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGlmIChsZW5ndGggPCAyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGhhc0JvdHRvbUhlaWdodHMgPSBkZWZpbmVkX2RlZmF1bHQoYm90dG9tSGVpZ2h0cyk7CiAgICBjb25zdCBoYXNUb3BIZWlnaHRzID0gZGVmaW5lZF9kZWZhdWx0KHRvcEhlaWdodHMpOwogICAgY29uc3QgY2xlYW5lZFBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgY29uc3QgY2xlYW5lZFRvcEhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGNvbnN0IGNsZWFuZWRCb3R0b21IZWlnaHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBjb25zdCB2MDIgPSBwb3NpdGlvbnNbMF07CiAgICBjbGVhbmVkUG9zaXRpb25zWzBdID0gdjAyOwogICAgY29uc3QgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWModjAyLCBzY3JhdGNoQ2FydG9ncmFwaGljMTMpOwogICAgaWYgKGhhc1RvcEhlaWdodHMpIHsKICAgICAgYzAuaGVpZ2h0ID0gdG9wSGVpZ2h0c1swXTsKICAgIH0KICAgIGNsZWFuZWRUb3BIZWlnaHRzWzBdID0gYzAuaGVpZ2h0OwogICAgaWYgKGhhc0JvdHRvbUhlaWdodHMpIHsKICAgICAgY2xlYW5lZEJvdHRvbUhlaWdodHNbMF0gPSBib3R0b21IZWlnaHRzWzBdOwogICAgfSBlbHNlIHsKICAgICAgY2xlYW5lZEJvdHRvbUhlaWdodHNbMF0gPSAwOwogICAgfQogICAgY29uc3Qgc3RhcnRUb3BIZWlnaHQgPSBjbGVhbmVkVG9wSGVpZ2h0c1swXTsKICAgIGNvbnN0IHN0YXJ0Qm90dG9tSGVpZ2h0ID0gY2xlYW5lZEJvdHRvbUhlaWdodHNbMF07CiAgICBsZXQgaGFzQWxsU2FtZUhlaWdodHMgPSBzdGFydFRvcEhlaWdodCA9PT0gc3RhcnRCb3R0b21IZWlnaHQ7CiAgICBsZXQgaW5kZXggPSAxOwogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCB2MTIgPSBwb3NpdGlvbnNbaV07CiAgICAgIGNvbnN0IGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHYxMiwgc2NyYXRjaENhcnRvZ3JhcGhpYzIzKTsKICAgICAgaWYgKGhhc1RvcEhlaWdodHMpIHsKICAgICAgICBjMS5oZWlnaHQgPSB0b3BIZWlnaHRzW2ldOwogICAgICB9CiAgICAgIGhhc0FsbFNhbWVIZWlnaHRzID0gaGFzQWxsU2FtZUhlaWdodHMgJiYgYzEuaGVpZ2h0ID09PSAwOwogICAgICBpZiAoIWxhdExvbkVxdWFscyhjMCwgYzEpKSB7CiAgICAgICAgY2xlYW5lZFBvc2l0aW9uc1tpbmRleF0gPSB2MTI7CiAgICAgICAgY2xlYW5lZFRvcEhlaWdodHNbaW5kZXhdID0gYzEuaGVpZ2h0OwogICAgICAgIGlmIChoYXNCb3R0b21IZWlnaHRzKSB7CiAgICAgICAgICBjbGVhbmVkQm90dG9tSGVpZ2h0c1tpbmRleF0gPSBib3R0b21IZWlnaHRzW2ldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjbGVhbmVkQm90dG9tSGVpZ2h0c1tpbmRleF0gPSAwOwogICAgICAgIH0KICAgICAgICBoYXNBbGxTYW1lSGVpZ2h0cyA9IGhhc0FsbFNhbWVIZWlnaHRzICYmIGNsZWFuZWRUb3BIZWlnaHRzW2luZGV4XSA9PT0gY2xlYW5lZEJvdHRvbUhlaWdodHNbaW5kZXhdOwogICAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKGMxLCBjMCk7CiAgICAgICAgKytpbmRleDsKICAgICAgfSBlbHNlIGlmIChjMC5oZWlnaHQgPCBjMS5oZWlnaHQpIHsKICAgICAgICBjbGVhbmVkVG9wSGVpZ2h0c1tpbmRleCAtIDFdID0gYzEuaGVpZ2h0OwogICAgICB9CiAgICB9CiAgICBpZiAoaGFzQWxsU2FtZUhlaWdodHMgfHwgaW5kZXggPCAyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNsZWFuZWRQb3NpdGlvbnMubGVuZ3RoID0gaW5kZXg7CiAgICBjbGVhbmVkVG9wSGVpZ2h0cy5sZW5ndGggPSBpbmRleDsKICAgIGNsZWFuZWRCb3R0b21IZWlnaHRzLmxlbmd0aCA9IGluZGV4OwogICAgcmV0dXJuIHsKICAgICAgcG9zaXRpb25zOiBjbGVhbmVkUG9zaXRpb25zLAogICAgICB0b3BIZWlnaHRzOiBjbGVhbmVkVG9wSGVpZ2h0cywKICAgICAgYm90dG9tSGVpZ2h0czogY2xlYW5lZEJvdHRvbUhlaWdodHMKICAgIH07CiAgfQogIHZhciBXYWxsR2VvbWV0cnlMaWJyYXJ5LCBzY3JhdGNoQ2FydG9ncmFwaGljMTMsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyMywgcG9zaXRpb25zQXJyYXlTY3JhdGNoLCBoZWlnaHRzQXJyYXlTY3JhdGNoLCBnZW5lcmF0ZUFyY09wdGlvbnNTY3JhdGNoMiwgV2FsbEdlb21ldHJ5TGlicmFyeV9kZWZhdWx0OwogIHZhciBpbml0X1dhbGxHZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxHZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlsaW5lUGlwZWxpbmUoKTsKICAgICAgV2FsbEdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMTMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzIzID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHBvc2l0aW9uc0FycmF5U2NyYXRjaCA9IG5ldyBBcnJheSgyKTsKICAgICAgaGVpZ2h0c0FycmF5U2NyYXRjaCA9IG5ldyBBcnJheSgyKTsKICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zU2NyYXRjaDIgPSB7CiAgICAgICAgcG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHZvaWQgMAogICAgICB9OwogICAgICBXYWxsR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVQb3NpdGlvbnMgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHdhbGxQb3NpdGlvbnMsIG1heGltdW1IZWlnaHRzLCBtaW5pbXVtSGVpZ2h0cywgZ3JhbnVsYXJpdHksIGR1cGxpY2F0ZUNvcm5lcnMpIHsKICAgICAgICBjb25zdCBvID0gcmVtb3ZlRHVwbGljYXRlczIoCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgbWF4aW11bUhlaWdodHMsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0cwogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobykpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgd2FsbFBvc2l0aW9ucyA9IG8ucG9zaXRpb25zOwogICAgICAgIG1heGltdW1IZWlnaHRzID0gby50b3BIZWlnaHRzOwogICAgICAgIG1pbmltdW1IZWlnaHRzID0gby5ib3R0b21IZWlnaHRzOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHdhbGxQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IG51bUNvcm5lcnMgPSBsZW5ndGggLSAyOwogICAgICAgIGxldCB0b3BQb3NpdGlvbnM7CiAgICAgICAgbGV0IGJvdHRvbVBvc2l0aW9uczsKICAgICAgICBjb25zdCBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aCgKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMKICAgICAgICApOwogICAgICAgIGNvbnN0IGdlbmVyYXRlQXJjT3B0aW9ucyA9IGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2gyOwogICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5taW5EaXN0YW5jZSA9IG1pbkRpc3RhbmNlOwogICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5lbGxpcHNvaWQgPSBlbGxpcHNvaWQ7CiAgICAgICAgaWYgKGR1cGxpY2F0ZUNvcm5lcnMpIHsKICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICBsZXQgaTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgY291bnQgKz0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0Lm51bWJlck9mUG9pbnRzKAogICAgICAgICAgICAgIHdhbGxQb3NpdGlvbnNbaV0sCiAgICAgICAgICAgICAgd2FsbFBvc2l0aW9uc1tpICsgMV0sCiAgICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICAgKSArIDE7CiAgICAgICAgICB9CiAgICAgICAgICB0b3BQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGNvdW50ICogMyk7CiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGNvdW50ICogMyk7CiAgICAgICAgICBjb25zdCBnZW5lcmF0ZUFyY1Bvc2l0aW9ucyA9IHBvc2l0aW9uc0FycmF5U2NyYXRjaDsKICAgICAgICAgIGNvbnN0IGdlbmVyYXRlQXJjSGVpZ2h0cyA9IGhlaWdodHNBcnJheVNjcmF0Y2g7CiAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMucG9zaXRpb25zID0gZ2VuZXJhdGVBcmNQb3NpdGlvbnM7CiAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMuaGVpZ2h0ID0gZ2VuZXJhdGVBcmNIZWlnaHRzOwogICAgICAgICAgbGV0IG9mZnNldCA9IDA7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjUG9zaXRpb25zWzBdID0gd2FsbFBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNQb3NpdGlvbnNbMV0gPSB3YWxsUG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNIZWlnaHRzWzBdID0gbWF4aW11bUhlaWdodHNbaV07CiAgICAgICAgICAgIGdlbmVyYXRlQXJjSGVpZ2h0c1sxXSA9IG1heGltdW1IZWlnaHRzW2kgKyAxXTsKICAgICAgICAgICAgY29uc3QgcG9zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKGdlbmVyYXRlQXJjT3B0aW9ucyk7CiAgICAgICAgICAgIHRvcFBvc2l0aW9ucy5zZXQocG9zLCBvZmZzZXQpOwogICAgICAgICAgICBnZW5lcmF0ZUFyY0hlaWdodHNbMF0gPSBtaW5pbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNIZWlnaHRzWzFdID0gbWluaW11bUhlaWdodHNbaSArIDFdOwogICAgICAgICAgICBib3R0b21Qb3NpdGlvbnMuc2V0KAogICAgICAgICAgICAgIFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyhnZW5lcmF0ZUFyY09wdGlvbnMpLAogICAgICAgICAgICAgIG9mZnNldAogICAgICAgICAgICApOwogICAgICAgICAgICBvZmZzZXQgKz0gcG9zLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLnBvc2l0aW9ucyA9IHdhbGxQb3NpdGlvbnM7CiAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMuaGVpZ2h0ID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgICB0b3BQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KAogICAgICAgICAgICBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoZ2VuZXJhdGVBcmNPcHRpb25zKQogICAgICAgICAgKTsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5oZWlnaHQgPSBtaW5pbXVtSGVpZ2h0czsKICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoCiAgICAgICAgICAgIFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyhnZW5lcmF0ZUFyY09wdGlvbnMpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgYm90dG9tUG9zaXRpb25zLAogICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgbnVtQ29ybmVycwogICAgICAgIH07CiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IFdhbGxHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XYWxsR2VvbWV0cnkuanMKICBmdW5jdGlvbiBXYWxsR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCB3YWxsUG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCBtYXhpbXVtSGVpZ2h0cyA9IG9wdGlvbnMubWF4aW11bUhlaWdodHM7CiAgICBjb25zdCBtaW5pbXVtSGVpZ2h0cyA9IG9wdGlvbnMubWluaW11bUhlaWdodHM7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh3YWxsUG9zaXRpb25zKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5wb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSAmJiBtYXhpbXVtSGVpZ2h0cy5sZW5ndGggIT09IHdhbGxQb3NpdGlvbnMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnBvc2l0aW9ucyBhbmQgb3B0aW9ucy5tYXhpbXVtSGVpZ2h0cyBtdXN0IGhhdmUgdGhlIHNhbWUgbGVuZ3RoLiIKICAgICAgKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpICYmIG1pbmltdW1IZWlnaHRzLmxlbmd0aCAhPT0gd2FsbFBvc2l0aW9ucy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMucG9zaXRpb25zIGFuZCBvcHRpb25zLm1pbmltdW1IZWlnaHRzIG11c3QgaGF2ZSB0aGUgc2FtZSBsZW5ndGguIgogICAgICApOwogICAgfQogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5kZWZhdWx0KTsKICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHdhbGxQb3NpdGlvbnM7CiAgICB0aGlzLl9taW5pbXVtSGVpZ2h0cyA9IG1pbmltdW1IZWlnaHRzOwogICAgdGhpcy5fbWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlV2FsbEdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHdhbGxQb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIDI7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSkgewogICAgICBudW1Db21wb25lbnRzICs9IG1pbmltdW1IZWlnaHRzLmxlbmd0aDsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgIG51bUNvbXBvbmVudHMgKz0gbWF4aW11bUhlaWdodHMubGVuZ3RoOwogICAgfQogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xLCBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMiwgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQsIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241LCBzY3JhdGNoQml0YW5nZW50NSwgc2NyYXRjaFRhbmdlbnQ1LCBzY3JhdGNoTm9ybWFsOCwgc2NyYXRjaEVsbGlwc29pZDE3LCBzY3JhdGNoVmVydGV4Rm9ybWF0MTMsIHNjcmF0Y2hPcHRpb25zMjMsIFdhbGxHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1dhbGxHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2FsbEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgaW5pdF9XYWxsR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQml0YW5nZW50NSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRhbmdlbnQ1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsOCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgV2FsbEdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bUhlaWdodHMgPSB2YWx1ZS5fbWluaW11bUhlaWdodHM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSA/IG1pbmltdW1IZWlnaHRzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBtaW5pbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgbWF4aW11bUhlaWdodHMgPSB2YWx1ZS5fbWF4aW11bUhlaWdodHM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSA/IG1heGltdW1IZWlnaHRzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBtYXhpbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTcgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMyA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczIzID0gewogICAgICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIG1pbmltdW1IZWlnaHRzOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUhlaWdodHM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQxNywKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMywKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwCiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBsZXQgbWluaW11bUhlaWdodHM7CiAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgIG1pbmltdW1IZWlnaHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgbWluaW11bUhlaWdodHNbaV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGxldCBtYXhpbXVtSGVpZ2h0czsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgbWF4aW11bUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0c1tpXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDE3KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTMKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMy5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLm1pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLm1heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFdhbGxHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtSGVpZ2h0cyA9IG1pbmltdW1IZWlnaHRzOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeS5mcm9tQ29uc3RhbnRIZWlnaHRzID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkhlaWdodHM7CiAgICAgICAgbGV0IG1heEhlaWdodHM7CiAgICAgICAgY29uc3QgbWluMyA9IG9wdGlvbnMubWluaW11bUhlaWdodDsKICAgICAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIGNvbnN0IGRvTWluID0gZGVmaW5lZF9kZWZhdWx0KG1pbjMpOwogICAgICAgIGNvbnN0IGRvTWF4ID0gZGVmaW5lZF9kZWZhdWx0KG1heDMpOwogICAgICAgIGlmIChkb01pbiB8fCBkb01heCkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIG1pbkhlaWdodHMgPSBkb01pbiA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgICAgbWF4SGVpZ2h0cyA9IGRvTWF4ID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChkb01pbikgewogICAgICAgICAgICAgIG1pbkhlaWdodHNbaV0gPSBtaW4zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb01heCkgewogICAgICAgICAgICAgIG1heEhlaWdodHNbaV0gPSBtYXgzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0czogbWF4SGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzOiBtaW5IZWlnaHRzLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgV2FsbEdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBXYWxsR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbih3YWxsR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB3YWxsUG9zaXRpb25zID0gd2FsbEdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbWluaW11bUhlaWdodHMgPSB3YWxsR2VvbWV0cnkuX21pbmltdW1IZWlnaHRzOwogICAgICAgIGNvbnN0IG1heGltdW1IZWlnaHRzID0gd2FsbEdlb21ldHJ5Ll9tYXhpbXVtSGVpZ2h0czsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSB3YWxsR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHdhbGxHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gd2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgcG9zID0gV2FsbEdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgbWF4aW11bUhlaWdodHMsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0cywKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbnMgPSBwb3MuYm90dG9tUG9zaXRpb25zOwogICAgICAgIGNvbnN0IHRvcFBvc2l0aW9ucyA9IHBvcy50b3BQb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbnVtQ29ybmVycyA9IHBvcy5udW1Db3JuZXJzOwogICAgICAgIGxldCBsZW5ndGggPSB0b3BQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBzaXplID0gbGVuZ3RoICogMjsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2ZXJ0ZXhGb3JtYXQucG9zaXRpb24gPyBuZXcgRmxvYXQ2NEFycmF5KHNpemUpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShzaXplIC8gMyAqIDIpIDogdm9pZCAwOwogICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgICAgIGxldCBiaXRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IHRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IHN0SW5kZXggPSAwOwogICAgICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDg7CiAgICAgICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDU7CiAgICAgICAgbGV0IGJpdGFuZ2VudCA9IHNjcmF0Y2hCaXRhbmdlbnQ1OwogICAgICAgIGxldCByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgIGxlbmd0aCAvPSAzOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBzID0gMDsKICAgICAgICBjb25zdCBkcyA9IDEgLyAobGVuZ3RoIC0gbnVtQ29ybmVycyAtIDEpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICAgIGNvbnN0IHRvcFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgICBpMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucywKICAgICAgICAgICAgaTMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGJvdHRvbVBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbi56OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHRvcFBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSB0b3BQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHM7CiAgICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gMDsKICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzOwogICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGxldCBuZXh0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IGdyb3VuZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMgogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoaSArIDEgPCBsZW5ndGgpIHsKICAgICAgICAgICAgICBuZXh0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICAgIHRvcFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGkzICsgMywKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVjb21wdXRlTm9ybWFsKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2NhbGVkbmV4dFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgICAgbmV4dFRvcCwKICAgICAgICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNvbnN0IHNjYWxlZEdyb3VuZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgICAgZ3JvdW5kUG9zaXRpb24sCiAgICAgICAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhzY2FsZWRHcm91bmRQb3NpdGlvbiwgc2NhbGVkbmV4dFBvc2l0aW9uLCBub3JtYWwyKSwKICAgICAgICAgICAgICAgIG5vcm1hbDIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJlY29tcHV0ZU5vcm1hbCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbih0b3BQb3NpdGlvbiwgbmV4dFRvcCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHMgKz0gZHM7CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHRUb3AsIHRvcFBvc2l0aW9uLCB0YW5nZW50KSwKICAgICAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gc2l6ZSAvIDM7CiAgICAgICAgc2l6ZSAtPSA2ICogKG51bUNvcm5lcnMgKyAxKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIHNpemUpOwogICAgICAgIGxldCBlZGdlSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlcyAtIDI7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgTEwgPSBpOwogICAgICAgICAgY29uc3QgTFIgPSBpICsgMjsKICAgICAgICAgIGNvbnN0IHBsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMTCAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcHIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIExSICogMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjIKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocGwsIHByLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IFVMID0gaSArIDE7CiAgICAgICAgICBjb25zdCBVUiA9IGkgKyAzOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVUjsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExSOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeV9kZWZhdWx0ID0gV2FsbEdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlV2FsbEdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVdhbGxHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlV2FsbEdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVdhbGxHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlV2FsbEdlb21ldHJ5KHdhbGxHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgd2FsbEdlb21ldHJ5ID0gV2FsbEdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHdhbGxHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUod2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIFdhbGxHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHdhbGxHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVXYWxsR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVXYWxsR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVdhbGxHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1dhbGxHZW9tZXRyeSgpOwogICAgICBjcmVhdGVXYWxsR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVdhbGxHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBXYWxsT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3Qgd2FsbFBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgbWF4aW11bUhlaWdodHMgPSBvcHRpb25zLm1heGltdW1IZWlnaHRzOwogICAgY29uc3QgbWluaW11bUhlaWdodHMgPSBvcHRpb25zLm1pbmltdW1IZWlnaHRzOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQod2FsbFBvc2l0aW9ucykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSGVpZ2h0cykgJiYgbWF4aW11bUhlaWdodHMubGVuZ3RoICE9PSB3YWxsUG9zaXRpb25zLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5wb3NpdGlvbnMgYW5kIG9wdGlvbnMubWF4aW11bUhlaWdodHMgbXVzdCBoYXZlIHRoZSBzYW1lIGxlbmd0aC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSAmJiBtaW5pbXVtSGVpZ2h0cy5sZW5ndGggIT09IHdhbGxQb3NpdGlvbnMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnBvc2l0aW9ucyBhbmQgb3B0aW9ucy5taW5pbXVtSGVpZ2h0cyBtdXN0IGhhdmUgdGhlIHNhbWUgbGVuZ3RoLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuZGVmYXVsdCk7CiAgICB0aGlzLl9wb3NpdGlvbnMgPSB3YWxsUG9zaXRpb25zOwogICAgdGhpcy5fbWluaW11bUhlaWdodHMgPSBtaW5pbXVtSGVpZ2h0czsKICAgIHRoaXMuX21heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeSI7CiAgICBsZXQgbnVtQ29tcG9uZW50cyA9IDEgKyB3YWxsUG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAyOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykpIHsKICAgICAgbnVtQ29tcG9uZW50cyArPSBtaW5pbXVtSGVpZ2h0cy5sZW5ndGg7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSkgewogICAgICBudW1Db21wb25lbnRzICs9IG1heGltdW1IZWlnaHRzLmxlbmd0aDsKICAgIH0KICAgIHRoaXMucGFja2VkTGVuZ3RoID0gbnVtQ29tcG9uZW50cyArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDE7CiAgfQogIHZhciBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMTIsIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yMiwgc2NyYXRjaEVsbGlwc29pZDE4LCBzY3JhdGNoT3B0aW9uczI0LCBXYWxsT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfV2FsbE91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2FsbE91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfV2FsbEdlb21ldHJ5TGlicmFyeSgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgV2FsbE91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pbmltdW1IZWlnaHRzID0gdmFsdWUuX21pbmltdW1IZWlnaHRzOwogICAgICAgIGxlbmd0aCA9IGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykgPyBtaW5pbXVtSGVpZ2h0cy5sZW5ndGggOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbWluaW11bUhlaWdodHNbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1heGltdW1IZWlnaHRzID0gdmFsdWUuX21heGltdW1IZWlnaHRzOwogICAgICAgIGxlbmd0aCA9IGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSGVpZ2h0cykgPyBtYXhpbXVtSGVpZ2h0cy5sZW5ndGggOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSGVpZ2h0cykpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbWF4aW11bUhlaWdodHNbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDE4ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoT3B0aW9uczI0ID0gewogICAgICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIG1pbmltdW1IZWlnaHRzOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUhlaWdodHM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQxOCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwCiAgICAgIH07CiAgICAgIFdhbGxPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgbGV0IG1pbmltdW1IZWlnaHRzOwogICAgICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgICAgICBtaW5pbXVtSGVpZ2h0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIG1pbmltdW1IZWlnaHRzW2ldID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBsZXQgbWF4aW11bUhlaWdodHM7CiAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgIG1heGltdW1IZWlnaHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgbWF4aW11bUhlaWdodHNbaV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQxOCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0LnBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjQubWluaW11bUhlaWdodHMgPSBtaW5pbXVtSGVpZ2h0czsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjQubWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjQuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHJldHVybiBuZXcgV2FsbE91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczI0KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtSGVpZ2h0cyA9IG1pbmltdW1IZWlnaHRzOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5LmZyb21Db25zdGFudEhlaWdodHMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgbWluSGVpZ2h0czsKICAgICAgICBsZXQgbWF4SGVpZ2h0czsKICAgICAgICBjb25zdCBtaW4zID0gb3B0aW9ucy5taW5pbXVtSGVpZ2h0OwogICAgICAgIGNvbnN0IG1heDMgPSBvcHRpb25zLm1heGltdW1IZWlnaHQ7CiAgICAgICAgY29uc3QgZG9NaW4gPSBkZWZpbmVkX2RlZmF1bHQobWluMyk7CiAgICAgICAgY29uc3QgZG9NYXggPSBkZWZpbmVkX2RlZmF1bHQobWF4Myk7CiAgICAgICAgaWYgKGRvTWluIHx8IGRvTWF4KSB7CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgbWluSGVpZ2h0cyA9IGRvTWluID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgICBtYXhIZWlnaHRzID0gZG9NYXggPyBuZXcgQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgaWYgKGRvTWluKSB7CiAgICAgICAgICAgICAgbWluSGVpZ2h0c1tpXSA9IG1pbjM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRvTWF4KSB7CiAgICAgICAgICAgICAgbWF4SGVpZ2h0c1tpXSA9IG1heDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IHsKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG1heGltdW1IZWlnaHRzOiBtYXhIZWlnaHRzLAogICAgICAgICAgbWluaW11bUhlaWdodHM6IG1pbkhlaWdodHMsCiAgICAgICAgICBlbGxpcHNvaWQ6IG9wdGlvbnMuZWxsaXBzb2lkCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbmV3IFdhbGxPdXRsaW5lR2VvbWV0cnkobmV3T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFdhbGxPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbih3YWxsR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB3YWxsUG9zaXRpb25zID0gd2FsbEdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbWluaW11bUhlaWdodHMgPSB3YWxsR2VvbWV0cnkuX21pbmltdW1IZWlnaHRzOwogICAgICAgIGNvbnN0IG1heGltdW1IZWlnaHRzID0gd2FsbEdlb21ldHJ5Ll9tYXhpbXVtSGVpZ2h0czsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHdhbGxHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gd2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgcG9zID0gV2FsbEdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgbWF4aW11bUhlaWdodHMsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0cywKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvcykpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgYm90dG9tUG9zaXRpb25zID0gcG9zLmJvdHRvbVBvc2l0aW9uczsKICAgICAgICBjb25zdCB0b3BQb3NpdGlvbnMgPSBwb3MudG9wUG9zaXRpb25zOwogICAgICAgIGxldCBsZW5ndGggPSB0b3BQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBzaXplID0gbGVuZ3RoICogMjsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUpOwogICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICBsZW5ndGggLz0gMzsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNvbnN0IGkzID0gaSAqIDM7CiAgICAgICAgICBjb25zdCB0b3BQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHRvcFBvc2l0aW9ucywKICAgICAgICAgICAgaTMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xMgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGJvdHRvbVBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgYm90dG9tUG9zaXRpb25zLAogICAgICAgICAgICBpMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjIyCiAgICAgICAgICApOwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbi54OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbi55OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbi56OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSB0b3BQb3NpdGlvbi54OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSB0b3BQb3NpdGlvbi55OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSB0b3BQb3NpdGlvbi56OwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KHsKICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pCiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBzaXplIC8gMzsKICAgICAgICBzaXplID0gMiAqIG51bVZlcnRpY2VzIC0gNCArIG51bVZlcnRpY2VzOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShudW1WZXJ0aWNlcywgc2l6ZSk7CiAgICAgICAgbGV0IGVkZ2VJbmRleCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVZlcnRpY2VzIC0gMjsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBMTCA9IGk7CiAgICAgICAgICBjb25zdCBMUiA9IGkgKyAyOwogICAgICAgICAgY29uc3QgcGwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIExMICogMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEyCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcHIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIExSICogMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjIyCiAgICAgICAgICApOwogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHBsLCBwciwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBVTCA9IGkgKyAxOwogICAgICAgICAgY29uc3QgVVIgPSBpICsgMzsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gVUw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExMOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gVVI7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExMOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMUjsKICAgICAgICB9CiAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBudW1WZXJ0aWNlcyAtIDI7CiAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBudW1WZXJ0aWNlcyAtIDE7CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFdhbGxPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeSh3YWxsR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHdhbGxHZW9tZXRyeSA9IFdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2sod2FsbEdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgd2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSh3YWxsR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gV2FsbE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHdhbGxHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1dhbGxPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL2RyYWNvM2QvZHJhY29fZGVjb2Rlcl9ub2RlanMuanMKICB2YXIgcmVxdWlyZV9kcmFjb19kZWNvZGVyX25vZGVqcyA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9kcmFjbzNkL2RyYWNvX2RlY29kZXJfbm9kZWpzLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIHZhciAkanNjb21wID0gJGpzY29tcCB8fCB7fTsKICAgICAgJGpzY29tcC5zY29wZSA9IHt9OwogICAgICAkanNjb21wLmFycmF5SXRlcmF0b3JJbXBsID0gZnVuY3Rpb24oaykgewogICAgICAgIHZhciBuID0gMDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gbiA8IGsubGVuZ3RoID8geyBkb25lOiBmYWxzZSwgdmFsdWU6IGtbbisrXSB9IDogeyBkb25lOiB0cnVlIH07CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgJGpzY29tcC5hcnJheUl0ZXJhdG9yID0gZnVuY3Rpb24oaykgewogICAgICAgIHJldHVybiB7IG5leHQ6ICRqc2NvbXAuYXJyYXlJdGVyYXRvckltcGwoaykgfTsKICAgICAgfTsKICAgICAgJGpzY29tcC5tYWtlSXRlcmF0b3IgPSBmdW5jdGlvbihrKSB7CiAgICAgICAgdmFyIG4gPSAidW5kZWZpbmVkIiAhPSB0eXBlb2YgU3ltYm9sICYmIFN5bWJvbC5pdGVyYXRvciAmJiBrW1N5bWJvbC5pdGVyYXRvcl07CiAgICAgICAgcmV0dXJuIG4gPyBuLmNhbGwoaykgOiAkanNjb21wLmFycmF5SXRlcmF0b3Ioayk7CiAgICAgIH07CiAgICAgICRqc2NvbXAuQVNTVU1FX0VTNSA9IGZhbHNlOwogICAgICAkanNjb21wLkFTU1VNRV9OT19OQVRJVkVfTUFQID0gZmFsc2U7CiAgICAgICRqc2NvbXAuQVNTVU1FX05PX05BVElWRV9TRVQgPSBmYWxzZTsKICAgICAgJGpzY29tcC5TSU1QTEVfRlJPVU5EX1BPTFlGSUxMID0gZmFsc2U7CiAgICAgICRqc2NvbXAuSVNPTEFURV9QT0xZRklMTFMgPSBmYWxzZTsKICAgICAgJGpzY29tcC5GT1JDRV9QT0xZRklMTF9QUk9NSVNFID0gZmFsc2U7CiAgICAgICRqc2NvbXAuRk9SQ0VfUE9MWUZJTExfUFJPTUlTRV9XSEVOX05PX1VOSEFORExFRF9SRUpFQ1RJT04gPSBmYWxzZTsKICAgICAgJGpzY29tcC5nZXRHbG9iYWwgPSBmdW5jdGlvbihrKSB7CiAgICAgICAgayA9IFsib2JqZWN0IiA9PSB0eXBlb2YgZ2xvYmFsVGhpcyAmJiBnbG9iYWxUaGlzLCBrLCAib2JqZWN0IiA9PSB0eXBlb2Ygd2luZG93ICYmIHdpbmRvdywgIm9iamVjdCIgPT0gdHlwZW9mIHNlbGYgJiYgc2VsZiwgIm9iamVjdCIgPT0gdHlwZW9mIGdsb2JhbCAmJiBnbG9iYWxdOwogICAgICAgIGZvciAodmFyIG4gPSAwOyBuIDwgay5sZW5ndGg7ICsrbikgewogICAgICAgICAgdmFyIGwgPSBrW25dOwogICAgICAgICAgaWYgKGwgJiYgbC5NYXRoID09IE1hdGgpIHJldHVybiBsOwogICAgICAgIH0KICAgICAgICB0aHJvdyBFcnJvcigiQ2Fubm90IGZpbmQgZ2xvYmFsIG9iamVjdCIpOwogICAgICB9OwogICAgICAkanNjb21wLmdsb2JhbCA9ICRqc2NvbXAuZ2V0R2xvYmFsKGV4cG9ydHMyKTsKICAgICAgJGpzY29tcC5kZWZpbmVQcm9wZXJ0eSA9ICRqc2NvbXAuQVNTVU1FX0VTNSB8fCAiZnVuY3Rpb24iID09IHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydGllcyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSA6IGZ1bmN0aW9uKGssIG4sIGwpIHsKICAgICAgICBpZiAoayA9PSBBcnJheS5wcm90b3R5cGUgfHwgayA9PSBPYmplY3QucHJvdG90eXBlKSByZXR1cm4gazsKICAgICAgICBrW25dID0gbC52YWx1ZTsKICAgICAgICByZXR1cm4gazsKICAgICAgfTsKICAgICAgJGpzY29tcC5JU19TWU1CT0xfTkFUSVZFID0gImZ1bmN0aW9uIiA9PT0gdHlwZW9mIFN5bWJvbCAmJiAic3ltYm9sIiA9PT0gdHlwZW9mIFN5bWJvbCgieCIpOwogICAgICAkanNjb21wLlRSVVNUX0VTNl9QT0xZRklMTFMgPSAhJGpzY29tcC5JU09MQVRFX1BPTFlGSUxMUyB8fCAkanNjb21wLklTX1NZTUJPTF9OQVRJVkU7CiAgICAgICRqc2NvbXAucG9seWZpbGxzID0ge307CiAgICAgICRqc2NvbXAucHJvcGVydHlUb1BvbHlmaWxsU3ltYm9sID0ge307CiAgICAgICRqc2NvbXAuUE9MWUZJTExfUFJFRklYID0gIiRqc2NwJCI7CiAgICAgICRqc2NvbXAucG9seWZpbGwgPSBmdW5jdGlvbihrLCBuLCBsLCBwKSB7CiAgICAgICAgbiAmJiAoJGpzY29tcC5JU09MQVRFX1BPTFlGSUxMUyA/ICRqc2NvbXAucG9seWZpbGxJc29sYXRlZChrLCBuLCBsLCBwKSA6ICRqc2NvbXAucG9seWZpbGxVbmlzb2xhdGVkKGssIG4sIGwsIHApKTsKICAgICAgfTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbFVuaXNvbGF0ZWQgPSBmdW5jdGlvbihrLCBuLCBsLCBwKSB7CiAgICAgICAgbCA9ICRqc2NvbXAuZ2xvYmFsOwogICAgICAgIGsgPSBrLnNwbGl0KCIuIik7CiAgICAgICAgZm9yIChwID0gMDsgcCA8IGsubGVuZ3RoIC0gMTsgcCsrKSB7CiAgICAgICAgICB2YXIgaCA9IGtbcF07CiAgICAgICAgICBpZiAoIShoIGluIGwpKSByZXR1cm47CiAgICAgICAgICBsID0gbFtoXTsKICAgICAgICB9CiAgICAgICAgayA9IGtbay5sZW5ndGggLSAxXTsKICAgICAgICBwID0gbFtrXTsKICAgICAgICBuID0gbihwKTsKICAgICAgICBuICE9IHAgJiYgbnVsbCAhPSBuICYmICRqc2NvbXAuZGVmaW5lUHJvcGVydHkobCwgaywgeyBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlLCB2YWx1ZTogbiB9KTsKICAgICAgfTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbElzb2xhdGVkID0gZnVuY3Rpb24oaywgbiwgbCwgcCkgewogICAgICAgIHZhciBoID0gay5zcGxpdCgiLiIpOwogICAgICAgIGsgPSAxID09PSBoLmxlbmd0aDsKICAgICAgICBwID0gaFswXTsKICAgICAgICBwID0gIWsgJiYgcCBpbiAkanNjb21wLnBvbHlmaWxscyA/ICRqc2NvbXAucG9seWZpbGxzIDogJGpzY29tcC5nbG9iYWw7CiAgICAgICAgZm9yICh2YXIgQSA9IDA7IEEgPCBoLmxlbmd0aCAtIDE7IEErKykgewogICAgICAgICAgdmFyIGYgPSBoW0FdOwogICAgICAgICAgaWYgKCEoZiBpbiBwKSkgcmV0dXJuOwogICAgICAgICAgcCA9IHBbZl07CiAgICAgICAgfQogICAgICAgIGggPSBoW2gubGVuZ3RoIC0gMV07CiAgICAgICAgbCA9ICRqc2NvbXAuSVNfU1lNQk9MX05BVElWRSAmJiAiZXM2IiA9PT0gbCA/IHBbaF0gOiBudWxsOwogICAgICAgIG4gPSBuKGwpOwogICAgICAgIG51bGwgIT0gbiAmJiAoayA/ICRqc2NvbXAuZGVmaW5lUHJvcGVydHkoJGpzY29tcC5wb2x5ZmlsbHMsIGgsIHsgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSwgdmFsdWU6IG4gfSkgOiBuICE9PSBsICYmICh2b2lkIDAgPT09ICRqc2NvbXAucHJvcGVydHlUb1BvbHlmaWxsU3ltYm9sW2hdICYmIChsID0gMWU5ICogTWF0aC5yYW5kb20oKSA+Pj4gMCwgJGpzY29tcC5wcm9wZXJ0eVRvUG9seWZpbGxTeW1ib2xbaF0gPSAkanNjb21wLklTX1NZTUJPTF9OQVRJVkUgPyAkanNjb21wLmdsb2JhbC5TeW1ib2woaCkgOiAkanNjb21wLlBPTFlGSUxMX1BSRUZJWCArIGwgKyAiJCIgKyBoKSwgJGpzY29tcC5kZWZpbmVQcm9wZXJ0eShwLCAkanNjb21wLnByb3BlcnR5VG9Qb2x5ZmlsbFN5bWJvbFtoXSwgeyBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlLCB2YWx1ZTogbiB9KSkpOwogICAgICB9OwogICAgICAkanNjb21wLnBvbHlmaWxsKCJQcm9taXNlIiwgZnVuY3Rpb24oaykgewogICAgICAgIGZ1bmN0aW9uIG4oKSB7CiAgICAgICAgICB0aGlzLmJhdGNoXyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGwoZikgewogICAgICAgICAgcmV0dXJuIGYgaW5zdGFuY2VvZiBoID8gZiA6IG5ldyBoKGZ1bmN0aW9uKHEsIHYzKSB7CiAgICAgICAgICAgIHEoZik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGsgJiYgKCEoJGpzY29tcC5GT1JDRV9QT0xZRklMTF9QUk9NSVNFIHx8ICRqc2NvbXAuRk9SQ0VfUE9MWUZJTExfUFJPTUlTRV9XSEVOX05PX1VOSEFORExFRF9SRUpFQ1RJT04gJiYgInVuZGVmaW5lZCIgPT09IHR5cGVvZiAkanNjb21wLmdsb2JhbC5Qcm9taXNlUmVqZWN0aW9uRXZlbnQpIHx8ICEkanNjb21wLmdsb2JhbC5Qcm9taXNlIHx8IC0xID09PSAkanNjb21wLmdsb2JhbC5Qcm9taXNlLnRvU3RyaW5nKCkuaW5kZXhPZigiW25hdGl2ZSBjb2RlXSIpKSkgcmV0dXJuIGs7CiAgICAgICAgbi5wcm90b3R5cGUuYXN5bmNFeGVjdXRlID0gZnVuY3Rpb24oZikgewogICAgICAgICAgaWYgKG51bGwgPT0gdGhpcy5iYXRjaF8pIHsKICAgICAgICAgICAgdGhpcy5iYXRjaF8gPSBbXTsKICAgICAgICAgICAgdmFyIHEgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmFzeW5jRXhlY3V0ZUZ1bmN0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHEuZXhlY3V0ZUJhdGNoXygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuYmF0Y2hfLnB1c2goZik7CiAgICAgICAgfTsKICAgICAgICB2YXIgcCA9ICRqc2NvbXAuZ2xvYmFsLnNldFRpbWVvdXQ7CiAgICAgICAgbi5wcm90b3R5cGUuYXN5bmNFeGVjdXRlRnVuY3Rpb24gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICBwKGYsIDApOwogICAgICAgIH07CiAgICAgICAgbi5wcm90b3R5cGUuZXhlY3V0ZUJhdGNoXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgZm9yICg7IHRoaXMuYmF0Y2hfICYmIHRoaXMuYmF0Y2hfLmxlbmd0aDsgKSB7CiAgICAgICAgICAgIHZhciBmID0gdGhpcy5iYXRjaF87CiAgICAgICAgICAgIHRoaXMuYmF0Y2hfID0gW107CiAgICAgICAgICAgIGZvciAodmFyIHEgPSAwOyBxIDwgZi5sZW5ndGg7ICsrcSkgewogICAgICAgICAgICAgIHZhciB2MyA9IGZbcV07CiAgICAgICAgICAgICAgZltxXSA9IG51bGw7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHYzKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeikgewogICAgICAgICAgICAgICAgdGhpcy5hc3luY1Rocm93Xyh6KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuYmF0Y2hfID0gbnVsbDsKICAgICAgICB9OwogICAgICAgIG4ucHJvdG90eXBlLmFzeW5jVGhyb3dfID0gZnVuY3Rpb24oZikgewogICAgICAgICAgdGhpcy5hc3luY0V4ZWN1dGVGdW5jdGlvbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhyb3cgZjsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgdmFyIGggPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB0aGlzLnN0YXRlXyA9IDA7CiAgICAgICAgICB0aGlzLnJlc3VsdF8gPSB2b2lkIDA7CiAgICAgICAgICB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18gPSBbXTsKICAgICAgICAgIHRoaXMuaXNSZWplY3Rpb25IYW5kbGVkXyA9IGZhbHNlOwogICAgICAgICAgdmFyIHEgPSB0aGlzLmNyZWF0ZVJlc29sdmVBbmRSZWplY3RfKCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmKHEucmVzb2x2ZSwgcS5yZWplY3QpOwogICAgICAgICAgfSBjYXRjaCAodjMpIHsKICAgICAgICAgICAgcS5yZWplY3QodjMpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuY3JlYXRlUmVzb2x2ZUFuZFJlamVjdF8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGZ1bmN0aW9uIGYoeikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oTykgewogICAgICAgICAgICAgIHYzIHx8ICh2MyA9IHRydWUsIHouY2FsbChxLCBPKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcSA9IHRoaXMsIHYzID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4geyByZXNvbHZlOiBmKHRoaXMucmVzb2x2ZVRvXyksIHJlamVjdDogZih0aGlzLnJlamVjdF8pIH07CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5yZXNvbHZlVG9fID0gZnVuY3Rpb24oZikgewogICAgICAgICAgaWYgKGYgPT09IHRoaXMpIHRoaXMucmVqZWN0XyhuZXcgVHlwZUVycm9yKCJBIFByb21pc2UgY2Fubm90IHJlc29sdmUgdG8gaXRzZWxmIikpOwogICAgICAgICAgZWxzZSBpZiAoZiBpbnN0YW5jZW9mIGgpIHRoaXMuc2V0dGxlU2FtZUFzUHJvbWlzZV8oZik7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYTogc3dpdGNoICh0eXBlb2YgZikgewogICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICB2YXIgcSA9IG51bGwgIT0gZjsKICAgICAgICAgICAgICAgIGJyZWFrIGE7CiAgICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICAgICAgcSA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhayBhOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBxID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcSA/IHRoaXMucmVzb2x2ZVRvTm9uUHJvbWlzZU9ial8oZikgOiB0aGlzLmZ1bGZpbGxfKGYpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUucmVzb2x2ZVRvTm9uUHJvbWlzZU9ial8gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB2YXIgcSA9IHZvaWQgMDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHEgPSBmLnRoZW47CiAgICAgICAgICB9IGNhdGNoICh2MykgewogICAgICAgICAgICB0aGlzLnJlamVjdF8odjMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICAiZnVuY3Rpb24iID09IHR5cGVvZiBxID8gdGhpcy5zZXR0bGVTYW1lQXNUaGVuYWJsZV8ocSwgZikgOiB0aGlzLmZ1bGZpbGxfKGYpOwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUucmVqZWN0XyA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHRoaXMuc2V0dGxlXygyLCBmKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLmZ1bGZpbGxfID0gZnVuY3Rpb24oZikgewogICAgICAgICAgdGhpcy5zZXR0bGVfKDEsIGYpOwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuc2V0dGxlXyA9IGZ1bmN0aW9uKGYsIHEpIHsKICAgICAgICAgIGlmICgwICE9IHRoaXMuc3RhdGVfKSB0aHJvdyBFcnJvcigiQ2Fubm90IHNldHRsZSgiICsgZiArICIsICIgKyBxICsgIik6IFByb21pc2UgYWxyZWFkeSBzZXR0bGVkIGluIHN0YXRlIiArIHRoaXMuc3RhdGVfKTsKICAgICAgICAgIHRoaXMuc3RhdGVfID0gZjsKICAgICAgICAgIHRoaXMucmVzdWx0XyA9IHE7CiAgICAgICAgICAyID09PSB0aGlzLnN0YXRlXyAmJiB0aGlzLnNjaGVkdWxlVW5oYW5kbGVkUmVqZWN0aW9uQ2hlY2tfKCk7CiAgICAgICAgICB0aGlzLmV4ZWN1dGVPblNldHRsZWRDYWxsYmFja3NfKCk7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5zY2hlZHVsZVVuaGFuZGxlZFJlamVjdGlvbkNoZWNrXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGYgPSB0aGlzOwogICAgICAgICAgcChmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGYubm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uXygpKSB7CiAgICAgICAgICAgICAgdmFyIHEgPSAkanNjb21wLmdsb2JhbC5jb25zb2xlOwogICAgICAgICAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgcSAmJiBxLmVycm9yKGYucmVzdWx0Xyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIDEpOwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUubm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHRoaXMuaXNSZWplY3Rpb25IYW5kbGVkXykgcmV0dXJuIGZhbHNlOwogICAgICAgICAgdmFyIGYgPSAkanNjb21wLmdsb2JhbC5DdXN0b21FdmVudCwgcSA9ICRqc2NvbXAuZ2xvYmFsLkV2ZW50LCB2MyA9ICRqc2NvbXAuZ2xvYmFsLmRpc3BhdGNoRXZlbnQ7CiAgICAgICAgICBpZiAoInVuZGVmaW5lZCIgPT09IHR5cGVvZiB2MykgcmV0dXJuIHRydWU7CiAgICAgICAgICAiZnVuY3Rpb24iID09PSB0eXBlb2YgZiA/IGYgPSBuZXcgZigidW5oYW5kbGVkcmVqZWN0aW9uIiwgeyBjYW5jZWxhYmxlOiB0cnVlIH0pIDogImZ1bmN0aW9uIiA9PT0gdHlwZW9mIHEgPyBmID0gbmV3IHEoInVuaGFuZGxlZHJlamVjdGlvbiIsIHsgY2FuY2VsYWJsZTogdHJ1ZSB9KSA6IChmID0gJGpzY29tcC5nbG9iYWwuZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkN1c3RvbUV2ZW50IiksIGYuaW5pdEN1c3RvbUV2ZW50KCJ1bmhhbmRsZWRyZWplY3Rpb24iLCBmYWxzZSwgdHJ1ZSwgZikpOwogICAgICAgICAgZi5wcm9taXNlID0gdGhpczsKICAgICAgICAgIGYucmVhc29uID0gdGhpcy5yZXN1bHRfOwogICAgICAgICAgcmV0dXJuIHYzKGYpOwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuZXhlY3V0ZU9uU2V0dGxlZENhbGxiYWNrc18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChudWxsICE9IHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzXykgewogICAgICAgICAgICBmb3IgKHZhciBmID0gMDsgZiA8IHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzXy5sZW5ndGg7ICsrZikgQS5hc3luY0V4ZWN1dGUodGhpcy5vblNldHRsZWRDYWxsYmFja3NfW2ZdKTsKICAgICAgICAgICAgdGhpcy5vblNldHRsZWRDYWxsYmFja3NfID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBBID0gbmV3IG4oKTsKICAgICAgICBoLnByb3RvdHlwZS5zZXR0bGVTYW1lQXNQcm9taXNlXyA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHZhciBxID0gdGhpcy5jcmVhdGVSZXNvbHZlQW5kUmVqZWN0XygpOwogICAgICAgICAgZi5jYWxsV2hlblNldHRsZWRfKHEucmVzb2x2ZSwgcS5yZWplY3QpOwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuc2V0dGxlU2FtZUFzVGhlbmFibGVfID0gZnVuY3Rpb24oZiwgcSkgewogICAgICAgICAgdmFyIHYzID0gdGhpcy5jcmVhdGVSZXNvbHZlQW5kUmVqZWN0XygpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZi5jYWxsKHEsIHYzLnJlc29sdmUsIHYzLnJlamVjdCk7CiAgICAgICAgICB9IGNhdGNoICh6KSB7CiAgICAgICAgICAgIHYzLnJlamVjdCh6KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLnRoZW4gPSBmdW5jdGlvbihmLCBxKSB7CiAgICAgICAgICBmdW5jdGlvbiB2Myh0LCB4KSB7CiAgICAgICAgICAgIHJldHVybiAiZnVuY3Rpb24iID09IHR5cGVvZiB0ID8gZnVuY3Rpb24oRCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB6KHQoRCkpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKFIpIHsKICAgICAgICAgICAgICAgIE8oUik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IDogeDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB6LCBPLCBiYSA9IG5ldyBoKGZ1bmN0aW9uKHQsIHgpIHsKICAgICAgICAgICAgeiA9IHQ7CiAgICAgICAgICAgIE8gPSB4OwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmNhbGxXaGVuU2V0dGxlZF8odjMoZiwgeiksIHYzKHEsIE8pKTsKICAgICAgICAgIHJldHVybiBiYTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLmNhdGNoID0gZnVuY3Rpb24oZikgewogICAgICAgICAgcmV0dXJuIHRoaXMudGhlbih2b2lkIDAsIGYpOwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuY2FsbFdoZW5TZXR0bGVkXyA9IGZ1bmN0aW9uKGYsIHEpIHsKICAgICAgICAgIGZ1bmN0aW9uIHYzKCkgewogICAgICAgICAgICBzd2l0Y2ggKHouc3RhdGVfKSB7CiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgZih6LnJlc3VsdF8pOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgcSh6LnJlc3VsdF8pOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJVbmV4cGVjdGVkIHN0YXRlOiAiICsgei5zdGF0ZV8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgeiA9IHRoaXM7CiAgICAgICAgICBudWxsID09IHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzXyA/IEEuYXN5bmNFeGVjdXRlKHYzKSA6IHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzXy5wdXNoKHYzKTsKICAgICAgICAgIHRoaXMuaXNSZWplY3Rpb25IYW5kbGVkXyA9IHRydWU7CiAgICAgICAgfTsKICAgICAgICBoLnJlc29sdmUgPSBsOwogICAgICAgIGgucmVqZWN0ID0gZnVuY3Rpb24oZikgewogICAgICAgICAgcmV0dXJuIG5ldyBoKGZ1bmN0aW9uKHEsIHYzKSB7CiAgICAgICAgICAgIHYzKGYpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBoLnJhY2UgPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICByZXR1cm4gbmV3IGgoZnVuY3Rpb24ocSwgdjMpIHsKICAgICAgICAgICAgZm9yICh2YXIgeiA9ICRqc2NvbXAubWFrZUl0ZXJhdG9yKGYpLCBPID0gei5uZXh0KCk7ICFPLmRvbmU7IE8gPSB6Lm5leHQoKSkgbChPLnZhbHVlKS5jYWxsV2hlblNldHRsZWRfKHEsIHYzKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgaC5hbGwgPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB2YXIgcSA9ICRqc2NvbXAubWFrZUl0ZXJhdG9yKGYpLCB2MyA9IHEubmV4dCgpOwogICAgICAgICAgcmV0dXJuIHYzLmRvbmUgPyBsKFtdKSA6IG5ldyBoKGZ1bmN0aW9uKHosIE8pIHsKICAgICAgICAgICAgZnVuY3Rpb24gYmEoRCkgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihSKSB7CiAgICAgICAgICAgICAgICB0W0RdID0gUjsKICAgICAgICAgICAgICAgIHgtLTsKICAgICAgICAgICAgICAgIDAgPT0geCAmJiB6KHQpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHQgPSBbXSwgeCA9IDA7CiAgICAgICAgICAgIGRvCiAgICAgICAgICAgICAgdC5wdXNoKHZvaWQgMCksIHgrKywgbCh2My52YWx1ZSkuY2FsbFdoZW5TZXR0bGVkXyhiYSh0Lmxlbmd0aCAtIDEpLCBPKSwgdjMgPSBxLm5leHQoKTsKICAgICAgICAgICAgd2hpbGUgKCF2My5kb25lKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGg7CiAgICAgIH0sICJlczYiLCAiZXMzIik7CiAgICAgICRqc2NvbXAub3ducyA9IGZ1bmN0aW9uKGssIG4pIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGssIG4pOwogICAgICB9OwogICAgICAkanNjb21wLmFzc2lnbiA9ICRqc2NvbXAuVFJVU1RfRVM2X1BPTFlGSUxMUyAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbiA6IGZ1bmN0aW9uKGssIG4pIHsKICAgICAgICBmb3IgKHZhciBsID0gMTsgbCA8IGFyZ3VtZW50cy5sZW5ndGg7IGwrKykgewogICAgICAgICAgdmFyIHAgPSBhcmd1bWVudHNbbF07CiAgICAgICAgICBpZiAocCkgZm9yICh2YXIgaCBpbiBwKSAkanNjb21wLm93bnMocCwgaCkgJiYgKGtbaF0gPSBwW2hdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGs7CiAgICAgIH07CiAgICAgICRqc2NvbXAucG9seWZpbGwoIk9iamVjdC5hc3NpZ24iLCBmdW5jdGlvbihrKSB7CiAgICAgICAgcmV0dXJuIGsgfHwgJGpzY29tcC5hc3NpZ247CiAgICAgIH0sICJlczYiLCAiZXMzIik7CiAgICAgICRqc2NvbXAuY2hlY2tTdHJpbmdBcmdzID0gZnVuY3Rpb24oaywgbiwgbCkgewogICAgICAgIGlmIChudWxsID09IGspIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSAndGhpcycgdmFsdWUgZm9yIFN0cmluZy5wcm90b3R5cGUuIiArIGwgKyAiIG11c3Qgbm90IGJlIG51bGwgb3IgdW5kZWZpbmVkIik7CiAgICAgICAgaWYgKG4gaW5zdGFuY2VvZiBSZWdFeHApIHRocm93IG5ldyBUeXBlRXJyb3IoIkZpcnN0IGFyZ3VtZW50IHRvIFN0cmluZy5wcm90b3R5cGUuIiArIGwgKyAiIG11c3Qgbm90IGJlIGEgcmVndWxhciBleHByZXNzaW9uIik7CiAgICAgICAgcmV0dXJuIGsgKyAiIjsKICAgICAgfTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiU3RyaW5nLnByb3RvdHlwZS5zdGFydHNXaXRoIiwgZnVuY3Rpb24oaykgewogICAgICAgIHJldHVybiBrID8gayA6IGZ1bmN0aW9uKG4sIGwpIHsKICAgICAgICAgIHZhciBwID0gJGpzY29tcC5jaGVja1N0cmluZ0FyZ3ModGhpcywgbiwgInN0YXJ0c1dpdGgiKTsKICAgICAgICAgIG4gKz0gIiI7CiAgICAgICAgICB2YXIgaCA9IHAubGVuZ3RoLCBBID0gbi5sZW5ndGg7CiAgICAgICAgICBsID0gTWF0aC5tYXgoMCwgTWF0aC5taW4obCB8IDAsIHAubGVuZ3RoKSk7CiAgICAgICAgICBmb3IgKHZhciBmID0gMDsgZiA8IEEgJiYgbCA8IGg7ICkgaWYgKHBbbCsrXSAhPSBuW2YrK10pIHJldHVybiBmYWxzZTsKICAgICAgICAgIHJldHVybiBmID49IEE7CiAgICAgICAgfTsKICAgICAgfSwgImVzNiIsICJlczMiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCBmdW5jdGlvbihrKSB7CiAgICAgICAgZnVuY3Rpb24gbihsKSB7CiAgICAgICAgICBsID0gTnVtYmVyKGwpOwogICAgICAgICAgcmV0dXJuIEluZmluaXR5ID09PSBsIHx8IC1JbmZpbml0eSA9PT0gbCA/IGwgOiBsIHwgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGsgPyBrIDogZnVuY3Rpb24obCwgcCwgaCkgewogICAgICAgICAgdmFyIEEgPSB0aGlzLmxlbmd0aDsKICAgICAgICAgIGwgPSBuKGwpOwogICAgICAgICAgcCA9IG4ocCk7CiAgICAgICAgICBoID0gdm9pZCAwID09PSBoID8gQSA6IG4oaCk7CiAgICAgICAgICBsID0gMCA+IGwgPyBNYXRoLm1heChBICsgbCwgMCkgOiBNYXRoLm1pbihsLCBBKTsKICAgICAgICAgIHAgPSAwID4gcCA/IE1hdGgubWF4KEEgKyBwLCAwKSA6IE1hdGgubWluKHAsIEEpOwogICAgICAgICAgaCA9IDAgPiBoID8gTWF0aC5tYXgoQSArIGgsIDApIDogTWF0aC5taW4oaCwgQSk7CiAgICAgICAgICBpZiAobCA8IHApIGZvciAoOyBwIDwgaDsgKSBwIGluIHRoaXMgPyB0aGlzW2wrK10gPSB0aGlzW3ArK10gOiAoZGVsZXRlIHRoaXNbbCsrXSwgcCsrKTsKICAgICAgICAgIGVsc2UgZm9yIChoID0gTWF0aC5taW4oaCwgQSArIHAgLSBsKSwgbCArPSBoIC0gcDsgaCA+IHA7ICkgLS1oIGluIHRoaXMgPyB0aGlzWy0tbF0gPSB0aGlzW2hdIDogZGVsZXRlIHRoaXNbLS1sXTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgIH0sICJlczYiLCAiZXMzIik7CiAgICAgICRqc2NvbXAudHlwZWRBcnJheUNvcHlXaXRoaW4gPSBmdW5jdGlvbihrKSB7CiAgICAgICAgcmV0dXJuIGsgPyBrIDogQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW47CiAgICAgIH07CiAgICAgICRqc2NvbXAucG9seWZpbGwoIkludDhBcnJheS5wcm90b3R5cGUuY29weVdpdGhpbiIsICRqc2NvbXAudHlwZWRBcnJheUNvcHlXaXRoaW4sICJlczYiLCAiZXM1Iik7CiAgICAgICRqc2NvbXAucG9seWZpbGwoIlVpbnQ4QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJVaW50OENsYW1wZWRBcnJheS5wcm90b3R5cGUuY29weVdpdGhpbiIsICRqc2NvbXAudHlwZWRBcnJheUNvcHlXaXRoaW4sICJlczYiLCAiZXM1Iik7CiAgICAgICRqc2NvbXAucG9seWZpbGwoIkludDE2QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJVaW50MTZBcnJheS5wcm90b3R5cGUuY29weVdpdGhpbiIsICRqc2NvbXAudHlwZWRBcnJheUNvcHlXaXRoaW4sICJlczYiLCAiZXM1Iik7CiAgICAgICRqc2NvbXAucG9seWZpbGwoIkludDMyQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJVaW50MzJBcnJheS5wcm90b3R5cGUuY29weVdpdGhpbiIsICRqc2NvbXAudHlwZWRBcnJheUNvcHlXaXRoaW4sICJlczYiLCAiZXM1Iik7CiAgICAgICRqc2NvbXAucG9seWZpbGwoIkZsb2F0MzJBcnJheS5wcm90b3R5cGUuY29weVdpdGhpbiIsICRqc2NvbXAudHlwZWRBcnJheUNvcHlXaXRoaW4sICJlczYiLCAiZXM1Iik7CiAgICAgICRqc2NvbXAucG9seWZpbGwoIkZsb2F0NjRBcnJheS5wcm90b3R5cGUuY29weVdpdGhpbiIsICRqc2NvbXAudHlwZWRBcnJheUNvcHlXaXRoaW4sICJlczYiLCAiZXM1Iik7CiAgICAgIHZhciBEcmFjb0RlY29kZXJNb2R1bGUgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgayA9ICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgZG9jdW1lbnQgJiYgZG9jdW1lbnQuY3VycmVudFNjcmlwdCA/IGRvY3VtZW50LmN1cnJlbnRTY3JpcHQuc3JjIDogdm9pZCAwOwogICAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19maWxlbmFtZSAmJiAoayA9IGsgfHwgX19maWxlbmFtZSk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG4pIHsKICAgICAgICAgIGZ1bmN0aW9uIGwoZSkgewogICAgICAgICAgICByZXR1cm4gYTMubG9jYXRlRmlsZSA/IGEzLmxvY2F0ZUZpbGUoZSwgVSkgOiBVICsgZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHAoZSwgYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IGIgKyBjOwogICAgICAgICAgICBmb3IgKGMgPSBiOyBlW2NdICYmICEoYyA+PSBkKTsgKSArK2M7CiAgICAgICAgICAgIGlmICgxNiA8IGMgLSBiICYmIGUuYnVmZmVyICYmIHZhKSByZXR1cm4gdmEuZGVjb2RlKGUuc3ViYXJyYXkoYiwgYykpOwogICAgICAgICAgICBmb3IgKGQgPSAiIjsgYiA8IGM7ICkgewogICAgICAgICAgICAgIHZhciBnID0gZVtiKytdOwogICAgICAgICAgICAgIGlmIChnICYgMTI4KSB7CiAgICAgICAgICAgICAgICB2YXIgdTMgPSBlW2IrK10gJiA2MzsKICAgICAgICAgICAgICAgIGlmICgxOTIgPT0gKGcgJiAyMjQpKSBkICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKGcgJiAzMSkgPDwgNiB8IHUzKTsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgWCA9IGVbYisrXSAmIDYzOwogICAgICAgICAgICAgICAgICBnID0gMjI0ID09IChnICYgMjQwKSA/IChnICYgMTUpIDw8IDEyIHwgdTMgPDwgNiB8IFggOiAoZyAmIDcpIDw8IDE4IHwgdTMgPDwgMTIgfCBYIDw8IDYgfCBlW2IrK10gJiA2MzsKICAgICAgICAgICAgICAgICAgNjU1MzYgPiBnID8gZCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGcpIDogKGcgLT0gNjU1MzYsIGQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSg1NTI5NiB8IGcgPj4gMTAsIDU2MzIwIHwgZyAmIDEwMjMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgZCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaChlLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBlID8gcChlYSwgZSwgYikgOiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEEoKSB7CiAgICAgICAgICAgIHZhciBlID0gamEuYnVmZmVyOwogICAgICAgICAgICBhMy5IRUFQOCA9IFkgPSBuZXcgSW50OEFycmF5KGUpOwogICAgICAgICAgICBhMy5IRUFQMTYgPSBuZXcgSW50MTZBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUDMyID0gY2EgPSBuZXcgSW50MzJBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUFU4ID0gZWEgPSBuZXcgVWludDhBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUFUxNiA9IG5ldyBVaW50MTZBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUFUzMiA9IFYgPSBuZXcgVWludDMyQXJyYXkoZSk7CiAgICAgICAgICAgIGEzLkhFQVBGMzIgPSBuZXcgRmxvYXQzMkFycmF5KGUpOwogICAgICAgICAgICBhMy5IRUFQRjY0ID0gbmV3IEZsb2F0NjRBcnJheShlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGYoZSkgewogICAgICAgICAgICBpZiAoYTMub25BYm9ydCkgYTMub25BYm9ydChlKTsKICAgICAgICAgICAgZSA9ICJBYm9ydGVkKCIgKyBlICsgIikiOwogICAgICAgICAgICBkYShlKTsKICAgICAgICAgICAgd2EgPSB0cnVlOwogICAgICAgICAgICBlID0gbmV3IFdlYkFzc2VtYmx5LlJ1bnRpbWVFcnJvcihlICsgIi4gQnVpbGQgd2l0aCAtc0FTU0VSVElPTlMgZm9yIG1vcmUgaW5mby4iKTsKICAgICAgICAgICAga2EoZSk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBxKGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoZSA9PSBQICYmIGZhKSByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZmEpOwogICAgICAgICAgICAgIGlmIChtYSkgcmV0dXJuIG1hKGUpOwogICAgICAgICAgICAgIHRocm93ICJib3RoIGFzeW5jIGFuZCBzeW5jIGZldGNoaW5nIG9mIHRoZSB3YXNtIGZhaWxlZCI7CiAgICAgICAgICAgIH0gY2F0Y2ggKGIpIHsKICAgICAgICAgICAgICBmKGIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB2MygpIHsKICAgICAgICAgICAgaWYgKCFmYSAmJiAoeGEgfHwgaGEpKSB7CiAgICAgICAgICAgICAgaWYgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIGZldGNoICYmICFQLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSkgcmV0dXJuIGZldGNoKFAsIHsgY3JlZGVudGlhbHM6ICJzYW1lLW9yaWdpbiIgfSkudGhlbihmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWUub2spIHRocm93ICJmYWlsZWQgdG8gbG9hZCB3YXNtIGJpbmFyeSBmaWxlIGF0ICciICsgUCArICInIjsKICAgICAgICAgICAgICAgIHJldHVybiBlLmFycmF5QnVmZmVyKCk7CiAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcShQKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAobmEpIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihlLCBiKSB7CiAgICAgICAgICAgICAgICBuYShQLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICAgIGUobmV3IFVpbnQ4QXJyYXkoYykpOwogICAgICAgICAgICAgICAgfSwgYik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHEoUCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24geihlKSB7CiAgICAgICAgICAgIGZvciAoOyAwIDwgZS5sZW5ndGg7ICkgZS5zaGlmdCgpKGEzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIE8oZSkgewogICAgICAgICAgICB0aGlzLmV4Y1B0ciA9IGU7CiAgICAgICAgICAgIHRoaXMucHRyID0gZSAtIDI0OwogICAgICAgICAgICB0aGlzLnNldF90eXBlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICAgIFZbdGhpcy5wdHIgKyA0ID4+IDJdID0gYjsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5nZXRfdHlwZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBWW3RoaXMucHRyICsgNCA+PiAyXTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zZXRfZGVzdHJ1Y3RvciA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBWW3RoaXMucHRyICsgOCA+PiAyXSA9IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X2Rlc3RydWN0b3IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gVlt0aGlzLnB0ciArIDggPj4gMl07CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X3JlZmNvdW50ID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICAgIGNhW3RoaXMucHRyID4+IDJdID0gYjsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zZXRfY2F1Z2h0ID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICAgIFlbdGhpcy5wdHIgKyAxMiA+PiAwXSA9IGIgPyAxIDogMDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5nZXRfY2F1Z2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDAgIT0gWVt0aGlzLnB0ciArIDEyID4+IDBdOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNldF9yZXRocm93biA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBZW3RoaXMucHRyICsgMTMgPj4gMF0gPSBiID8gMSA6IDA7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X3JldGhyb3duID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDAgIT0gWVt0aGlzLnB0ciArIDEzID4+IDBdOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmluaXQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgICAgdGhpcy5zZXRfYWRqdXN0ZWRfcHRyKDApOwogICAgICAgICAgICAgIHRoaXMuc2V0X3R5cGUoYik7CiAgICAgICAgICAgICAgdGhpcy5zZXRfZGVzdHJ1Y3RvcihjKTsKICAgICAgICAgICAgICB0aGlzLnNldF9yZWZjb3VudCgwKTsKICAgICAgICAgICAgICB0aGlzLnNldF9jYXVnaHQoZmFsc2UpOwogICAgICAgICAgICAgIHRoaXMuc2V0X3JldGhyb3duKGZhbHNlKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5hZGRfcmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY2FbdGhpcy5wdHIgPj4gMl0gKz0gMTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5yZWxlYXNlX3JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBiID0gY2FbdGhpcy5wdHIgPj4gMl07CiAgICAgICAgICAgICAgY2FbdGhpcy5wdHIgPj4gMl0gPSBiIC0gMTsKICAgICAgICAgICAgICByZXR1cm4gMSA9PT0gYjsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zZXRfYWRqdXN0ZWRfcHRyID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICAgIFZbdGhpcy5wdHIgKyAxNiA+PiAyXSA9IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X2FkanVzdGVkX3B0ciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBWW3RoaXMucHRyICsgMTYgPj4gMl07CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X2V4Y2VwdGlvbl9wdHIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoeWEodGhpcy5nZXRfdHlwZSgpKSkgcmV0dXJuIFZbdGhpcy5leGNQdHIgPj4gMl07CiAgICAgICAgICAgICAgdmFyIGIgPSB0aGlzLmdldF9hZGp1c3RlZF9wdHIoKTsKICAgICAgICAgICAgICByZXR1cm4gMCAhPT0gYiA/IGIgOiB0aGlzLmV4Y1B0cjsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGJhKCkgewogICAgICAgICAgICBmdW5jdGlvbiBlKCkgewogICAgICAgICAgICAgIGlmICghbGEgJiYgKGxhID0gdHJ1ZSwgYTMuY2FsbGVkUnVuID0gdHJ1ZSwgIXdhKSkgewogICAgICAgICAgICAgICAgemEgPSB0cnVlOwogICAgICAgICAgICAgICAgeihvYSk7CiAgICAgICAgICAgICAgICBBYShhMyk7CiAgICAgICAgICAgICAgICBpZiAoYTMub25SdW50aW1lSW5pdGlhbGl6ZWQpIGEzLm9uUnVudGltZUluaXRpYWxpemVkKCk7CiAgICAgICAgICAgICAgICBpZiAoYTMucG9zdFJ1bikgZm9yICgiZnVuY3Rpb24iID09IHR5cGVvZiBhMy5wb3N0UnVuICYmIChhMy5wb3N0UnVuID0gW2EzLnBvc3RSdW5dKTsgYTMucG9zdFJ1bi5sZW5ndGg7ICkgQmEudW5zaGlmdChhMy5wb3N0UnVuLnNoaWZ0KCkpOwogICAgICAgICAgICAgICAgeihCYSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKDAgPCBhYSkpIHsKICAgICAgICAgICAgICBpZiAoYTMucHJlUnVuKSBmb3IgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIGEzLnByZVJ1biAmJiAoYTMucHJlUnVuID0gW2EzLnByZVJ1bl0pOyBhMy5wcmVSdW4ubGVuZ3RoOyApIENhLnVuc2hpZnQoYTMucHJlUnVuLnNoaWZ0KCkpOwogICAgICAgICAgICAgIHooQ2EpOwogICAgICAgICAgICAgIDAgPCBhYSB8fCAoYTMuc2V0U3RhdHVzID8gKGEzLnNldFN0YXR1cygiUnVubmluZy4uLiIpLCBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgYTMuc2V0U3RhdHVzKCIiKTsKICAgICAgICAgICAgICAgIH0sIDEpOwogICAgICAgICAgICAgICAgZSgpOwogICAgICAgICAgICAgIH0sIDEpKSA6IGUoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHQoKSB7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB4KGUpIHsKICAgICAgICAgICAgcmV0dXJuIChlIHx8IHQpLl9fY2FjaGVfXzsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEQoZSwgYikgewogICAgICAgICAgICB2YXIgYyA9IHgoYiksIGQgPSBjW2VdOwogICAgICAgICAgICBpZiAoZCkgcmV0dXJuIGQ7CiAgICAgICAgICAgIGQgPSBPYmplY3QuY3JlYXRlKChiIHx8IHQpLnByb3RvdHlwZSk7CiAgICAgICAgICAgIGQucHRyID0gZTsKICAgICAgICAgICAgcmV0dXJuIGNbZV0gPSBkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUihlKSB7CiAgICAgICAgICAgIGlmICgic3RyaW5nIiA9PT0gdHlwZW9mIGUpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBiID0gMCwgYyA9IDA7IGMgPCBlLmxlbmd0aDsgKytjKSB7CiAgICAgICAgICAgICAgICB2YXIgZCA9IGUuY2hhckNvZGVBdChjKTsKICAgICAgICAgICAgICAgIDEyNyA+PSBkID8gYisrIDogMjA0NyA+PSBkID8gYiArPSAyIDogNTUyOTYgPD0gZCAmJiA1NzM0MyA+PSBkID8gKGIgKz0gNCwgKytjKSA6IGIgKz0gMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYiA9IEFycmF5KGIgKyAxKTsKICAgICAgICAgICAgICBjID0gMDsKICAgICAgICAgICAgICBkID0gYi5sZW5ndGg7CiAgICAgICAgICAgICAgaWYgKDAgPCBkKSB7CiAgICAgICAgICAgICAgICBkID0gYyArIGQgLSAxOwogICAgICAgICAgICAgICAgZm9yICh2YXIgZyA9IDA7IGcgPCBlLmxlbmd0aDsgKytnKSB7CiAgICAgICAgICAgICAgICAgIHZhciB1MyA9IGUuY2hhckNvZGVBdChnKTsKICAgICAgICAgICAgICAgICAgaWYgKDU1Mjk2IDw9IHUzICYmIDU3MzQzID49IHUzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIFggPSBlLmNoYXJDb2RlQXQoKytnKTsKICAgICAgICAgICAgICAgICAgICB1MyA9IDY1NTM2ICsgKCh1MyAmIDEwMjMpIDw8IDEwKSB8IFggJiAxMDIzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICgxMjcgPj0gdTMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYyA+PSBkKSBicmVhazsKICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSB1MzsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoMjA0NyA+PSB1MykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgKyAxID49IGQpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgYltjKytdID0gMTkyIHwgdTMgPj4gNjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgaWYgKDY1NTM1ID49IHUzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjICsgMiA+PSBkKSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgYltjKytdID0gMjI0IHwgdTMgPj4gMTI7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYyArIDMgPj0gZCkgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IDI0MCB8IHUzID4+IDE4OwogICAgICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSAxMjggfCB1MyA+PiAxMiAmIDYzOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYltjKytdID0gMTI4IHwgdTMgPj4gNiAmIDYzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSAxMjggfCB1MyAmIDYzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBiW2NdID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZSA9IHIuYWxsb2MoYiwgWSk7CiAgICAgICAgICAgICAgci5jb3B5KGIsIFksIGUpOwogICAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcGEoZSkgewogICAgICAgICAgICBpZiAoIm9iamVjdCIgPT09IHR5cGVvZiBlKSB7CiAgICAgICAgICAgICAgdmFyIGIgPSByLmFsbG9jKGUsIFkpOwogICAgICAgICAgICAgIHIuY29weShlLCBZLCBiKTsKICAgICAgICAgICAgICByZXR1cm4gYjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFooKSB7CiAgICAgICAgICAgIHRocm93ICJjYW5ub3QgY29uc3RydWN0IGEgVm9pZFB0ciwgbm8gY29uc3RydWN0b3IgaW4gSURMIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFMoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gRGEoKTsKICAgICAgICAgICAgeChTKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUSgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBFYSgpOwogICAgICAgICAgICB4KFEpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBXKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IEZhKCk7CiAgICAgICAgICAgIHgoVylbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHcoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gR2EoKTsKICAgICAgICAgICAgeCh3KVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQygpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBIYSgpOwogICAgICAgICAgICB4KEMpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBGKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IElhKCk7CiAgICAgICAgICAgIHgoRilbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEcoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gSmEoKTsKICAgICAgICAgICAgeChHKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gRSgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBLYSgpOwogICAgICAgICAgICB4KEUpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBUKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IExhKCk7CiAgICAgICAgICAgIHgoVClbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEIoKSB7CiAgICAgICAgICAgIHRocm93ICJjYW5ub3QgY29uc3RydWN0IGEgU3RhdHVzLCBubyBjb25zdHJ1Y3RvciBpbiBJREwiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gSCgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBNYSgpOwogICAgICAgICAgICB4KEgpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBJKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IE5hKCk7CiAgICAgICAgICAgIHgoSSlbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEooKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gT2EoKTsKICAgICAgICAgICAgeChKKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gSygpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBQYSgpOwogICAgICAgICAgICB4KEspW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBMKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IFFhKCk7CiAgICAgICAgICAgIHgoTClbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIE0oKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gUmEoKTsKICAgICAgICAgICAgeChNKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gTigpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBTYSgpOwogICAgICAgICAgICB4KE4pW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB5KCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IFRhKCk7CiAgICAgICAgICAgIHgoeSlbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG0oKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gVWEoKTsKICAgICAgICAgICAgeChtKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgbiA9IHZvaWQgMCA9PT0gbiA/IHt9IDogbjsKICAgICAgICAgIHZhciBhMyA9ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBuID8gbiA6IHt9LCBBYSwga2E7CiAgICAgICAgICBhMy5yZWFkeSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKGUsIGIpIHsKICAgICAgICAgICAgQWEgPSBlOwogICAgICAgICAgICBrYSA9IGI7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBWYSA9IGZhbHNlLCBXYSA9IGZhbHNlOwogICAgICAgICAgYTMub25SdW50aW1lSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgVmEgPSB0cnVlOwogICAgICAgICAgICBpZiAoV2EgJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGEzLm9uTW9kdWxlTG9hZGVkKSBhMy5vbk1vZHVsZUxvYWRlZChhMyk7CiAgICAgICAgICB9OwogICAgICAgICAgYTMub25Nb2R1bGVQYXJzZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgV2EgPSB0cnVlOwogICAgICAgICAgICBpZiAoVmEgJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGEzLm9uTW9kdWxlTG9hZGVkKSBhMy5vbk1vZHVsZUxvYWRlZChhMyk7CiAgICAgICAgICB9OwogICAgICAgICAgYTMuaXNWZXJzaW9uU3VwcG9ydGVkID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICBpZiAoInN0cmluZyIgIT09IHR5cGVvZiBlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGUgPSBlLnNwbGl0KCIuIik7CiAgICAgICAgICAgIHJldHVybiAyID4gZS5sZW5ndGggfHwgMyA8IGUubGVuZ3RoID8gZmFsc2UgOiAxID09IGVbMF0gJiYgMCA8PSBlWzFdICYmIDUgPj0gZVsxXSA/IHRydWUgOiAwICE9IGVbMF0gfHwgMTAgPCBlWzFdID8gZmFsc2UgOiB0cnVlOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBYYSA9IE9iamVjdC5hc3NpZ24oe30sIGEzKSwgeGEgPSAib2JqZWN0IiA9PSB0eXBlb2Ygd2luZG93LCBoYSA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIGltcG9ydFNjcmlwdHMsIFlhID0gIm9iamVjdCIgPT0gdHlwZW9mIHByb2Nlc3MgJiYgIm9iamVjdCIgPT0gdHlwZW9mIHByb2Nlc3MudmVyc2lvbnMgJiYgInN0cmluZyIgPT0gdHlwZW9mIHByb2Nlc3MudmVyc2lvbnMubm9kZSwgVSA9ICIiOwogICAgICAgICAgaWYgKFlhKSB7CiAgICAgICAgICAgIHZhciBaYSA9IF9fcmVxdWlyZSgiZnMiKSwgcWEgPSBfX3JlcXVpcmUoInBhdGgiKTsKICAgICAgICAgICAgVSA9IGhhID8gcWEuZGlybmFtZShVKSArICIvIiA6IF9fZGlybmFtZSArICIvIjsKICAgICAgICAgICAgdmFyICRhID0gZnVuY3Rpb24oZSwgYikgewogICAgICAgICAgICAgIGUgPSBlLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSA/IG5ldyBVUkwoZSkgOiBxYS5ub3JtYWxpemUoZSk7CiAgICAgICAgICAgICAgcmV0dXJuIFphLnJlYWRGaWxlU3luYyhlLCBiID8gdm9pZCAwIDogInV0ZjgiKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG1hID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgIGUgPSAkYShlLCB0cnVlKTsKICAgICAgICAgICAgICBlLmJ1ZmZlciB8fCAoZSA9IG5ldyBVaW50OEFycmF5KGUpKTsKICAgICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG5hID0gZnVuY3Rpb24oZSwgYiwgYykgewogICAgICAgICAgICAgIGUgPSBlLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSA/IG5ldyBVUkwoZSkgOiBxYS5ub3JtYWxpemUoZSk7CiAgICAgICAgICAgICAgWmEucmVhZEZpbGUoZSwgZnVuY3Rpb24oZCwgZykgewogICAgICAgICAgICAgICAgZCA/IGMoZCkgOiBiKGcuYnVmZmVyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgMSA8IHByb2Nlc3MuYXJndi5sZW5ndGggJiYgcHJvY2Vzcy5hcmd2WzFdLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgICAgICAgIHByb2Nlc3MuYXJndi5zbGljZSgyKTsKICAgICAgICAgICAgYTMuaW5zcGVjdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAiW0Vtc2NyaXB0ZW4gTW9kdWxlIG9iamVjdF0iOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmICh4YSB8fCBoYSkgaGEgPyBVID0gc2VsZi5sb2NhdGlvbi5ocmVmIDogInVuZGVmaW5lZCIgIT0gdHlwZW9mIGRvY3VtZW50ICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQgJiYgKFUgPSBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYyksIGsgJiYgKFUgPSBrKSwgVSA9IDAgIT09IFUuaW5kZXhPZigiYmxvYjoiKSA/IFUuc3Vic3RyKDAsIFUucmVwbGFjZSgvWz8jXS4qLywgIiIpLmxhc3RJbmRleE9mKCIvIikgKyAxKSA6ICIiLCAkYSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIGIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgYi5vcGVuKCJHRVQiLCBlLCBmYWxzZSk7CiAgICAgICAgICAgIGIuc2VuZChudWxsKTsKICAgICAgICAgICAgcmV0dXJuIGIucmVzcG9uc2VUZXh0OwogICAgICAgICAgfSwgaGEgJiYgKG1hID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgYiA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICBiLm9wZW4oIkdFVCIsIGUsIGZhbHNlKTsKICAgICAgICAgICAgYi5yZXNwb25zZVR5cGUgPSAiYXJyYXlidWZmZXIiOwogICAgICAgICAgICBiLnNlbmQobnVsbCk7CiAgICAgICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShiLnJlc3BvbnNlKTsKICAgICAgICAgIH0pLCBuYSA9IGZ1bmN0aW9uKGUsIGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgZC5vcGVuKCJHRVQiLCBlLCB0cnVlKTsKICAgICAgICAgICAgZC5yZXNwb25zZVR5cGUgPSAiYXJyYXlidWZmZXIiOwogICAgICAgICAgICBkLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIDIwMCA9PSBkLnN0YXR1cyB8fCAwID09IGQuc3RhdHVzICYmIGQucmVzcG9uc2UgPyBiKGQucmVzcG9uc2UpIDogYygpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBkLm9uZXJyb3IgPSBjOwogICAgICAgICAgICBkLnNlbmQobnVsbCk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHVkID0gYTMucHJpbnQgfHwgY29uc29sZS5sb2cuYmluZChjb25zb2xlKSwgZGEgPSBhMy5wcmludEVyciB8fCBjb25zb2xlLndhcm4uYmluZChjb25zb2xlKTsKICAgICAgICAgIE9iamVjdC5hc3NpZ24oYTMsIFhhKTsKICAgICAgICAgIFhhID0gbnVsbDsKICAgICAgICAgIHZhciBmYTsKICAgICAgICAgIGEzLndhc21CaW5hcnkgJiYgKGZhID0gYTMud2FzbUJpbmFyeSk7CiAgICAgICAgICAib2JqZWN0IiAhPSB0eXBlb2YgV2ViQXNzZW1ibHkgJiYgZigibm8gbmF0aXZlIHdhc20gc3VwcG9ydCBkZXRlY3RlZCIpOwogICAgICAgICAgdmFyIGphLCB3YSA9IGZhbHNlLCB2YSA9ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBUZXh0RGVjb2RlciA/IG5ldyBUZXh0RGVjb2RlcigidXRmOCIpIDogdm9pZCAwLCBZLCBlYSwgY2EsIFYsIENhID0gW10sIG9hID0gW10sIEJhID0gW10sIHphID0gZmFsc2UsIGFhID0gMCwgcmEgPSBudWxsLCBpYSA9IG51bGw7CiAgICAgICAgICB2YXIgUCA9ICJkcmFjb19kZWNvZGVyLndhc20iOwogICAgICAgICAgUC5zdGFydHNXaXRoKCJkYXRhOmFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbTtiYXNlNjQsIikgfHwgKFAgPSBsKFApKTsKICAgICAgICAgIHZhciB2ZCA9IDAsIHdkID0gW251bGwsIFtdLCBbXV0sIHhkID0geyBiOiBmdW5jdGlvbihlLCBiLCBjKSB7CiAgICAgICAgICAgIG5ldyBPKGUpLmluaXQoYiwgYyk7CiAgICAgICAgICAgIHZkKys7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9LCBhOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZigiIik7CiAgICAgICAgICB9LCBnOiBmdW5jdGlvbihlLCBiLCBjKSB7CiAgICAgICAgICAgIGVhLmNvcHlXaXRoaW4oZSwgYiwgYiArIGMpOwogICAgICAgICAgfSwgZTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgYiA9IGVhLmxlbmd0aDsKICAgICAgICAgICAgZSA+Pj49IDA7CiAgICAgICAgICAgIGlmICgyMTQ3NDgzNjQ4IDwgZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBmb3IgKHZhciBjID0gMTsgNCA+PSBjOyBjICo9IDIpIHsKICAgICAgICAgICAgICB2YXIgZCA9IGIgKiAoMSArIDAuMiAvIGMpOwogICAgICAgICAgICAgIGQgPSBNYXRoLm1pbihkLCBlICsgMTAwNjYzMjk2KTsKICAgICAgICAgICAgICB2YXIgZyA9IE1hdGg7CiAgICAgICAgICAgICAgZCA9IE1hdGgubWF4KGUsIGQpOwogICAgICAgICAgICAgIGcgPSBnLm1pbi5jYWxsKGcsIDIxNDc0ODM2NDgsIGQgKyAoNjU1MzYgLSBkICUgNjU1MzYpICUgNjU1MzYpOwogICAgICAgICAgICAgIGE6IHsKICAgICAgICAgICAgICAgIGQgPSBqYS5idWZmZXI7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBqYS5ncm93KGcgLSBkLmJ5dGVMZW5ndGggKyA2NTUzNSA+Pj4gMTYpOwogICAgICAgICAgICAgICAgICBBKCk7CiAgICAgICAgICAgICAgICAgIHZhciB1MyA9IDE7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGE7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChYKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1MyA9IHZvaWQgMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHUzKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9LCBmOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiA1MjsKICAgICAgICAgIH0sIGQ6IGZ1bmN0aW9uKGUsIGIsIGMsIGQsIGcpIHsKICAgICAgICAgICAgcmV0dXJuIDcwOwogICAgICAgICAgfSwgYzogZnVuY3Rpb24oZSwgYiwgYywgZCkgewogICAgICAgICAgICBmb3IgKHZhciBnID0gMCwgdTMgPSAwOyB1MyA8IGM7IHUzKyspIHsKICAgICAgICAgICAgICB2YXIgWCA9IFZbYiA+PiAyXSwgYWIgPSBWW2IgKyA0ID4+IDJdOwogICAgICAgICAgICAgIGIgKz0gODsKICAgICAgICAgICAgICBmb3IgKHZhciBzYSA9IDA7IHNhIDwgYWI7IHNhKyspIHsKICAgICAgICAgICAgICAgIHZhciB0YSA9IGVhW1ggKyBzYV0sIHVhID0gd2RbZV07CiAgICAgICAgICAgICAgICAwID09PSB0YSB8fCAxMCA9PT0gdGEgPyAoKDEgPT09IGUgPyB1ZCA6IGRhKShwKHVhLCAwKSksIHVhLmxlbmd0aCA9IDApIDogdWEucHVzaCh0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGcgKz0gYWI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgVltkID4+IDJdID0gZzsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9IH07CiAgICAgICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGUoZywgdTMpIHsKICAgICAgICAgICAgICBhMy5hc20gPSBnLmV4cG9ydHM7CiAgICAgICAgICAgICAgamEgPSBhMy5hc20uaDsKICAgICAgICAgICAgICBBKCk7CiAgICAgICAgICAgICAgb2EudW5zaGlmdChhMy5hc20uaSk7CiAgICAgICAgICAgICAgYWEtLTsKICAgICAgICAgICAgICBhMy5tb25pdG9yUnVuRGVwZW5kZW5jaWVzICYmIGEzLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoYWEpOwogICAgICAgICAgICAgIDAgPT0gYWEgJiYgKG51bGwgIT09IHJhICYmIChjbGVhckludGVydmFsKHJhKSwgcmEgPSBudWxsKSwgaWEgJiYgKGcgPSBpYSwgaWEgPSBudWxsLCBnKCkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBiKGcpIHsKICAgICAgICAgICAgICBlKGcuaW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGMoZykgewogICAgICAgICAgICAgIHJldHVybiB2MygpLnRoZW4oZnVuY3Rpb24odTMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZSh1MywgZCk7CiAgICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbih1MykgewogICAgICAgICAgICAgICAgcmV0dXJuIHUzOwogICAgICAgICAgICAgIH0pLnRoZW4oZywgZnVuY3Rpb24odTMpIHsKICAgICAgICAgICAgICAgIGRhKCJmYWlsZWQgdG8gYXN5bmNocm9ub3VzbHkgcHJlcGFyZSB3YXNtOiAiICsgdTMpOwogICAgICAgICAgICAgICAgZih1Myk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGQgPSB7IGE6IHhkIH07CiAgICAgICAgICAgIGFhKys7CiAgICAgICAgICAgIGEzLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMgJiYgYTMubW9uaXRvclJ1bkRlcGVuZGVuY2llcyhhYSk7CiAgICAgICAgICAgIGlmIChhMy5pbnN0YW50aWF0ZVdhc20pIHRyeSB7CiAgICAgICAgICAgICAgcmV0dXJuIGEzLmluc3RhbnRpYXRlV2FzbShkLCBlKTsKICAgICAgICAgICAgfSBjYXRjaCAoZykgewogICAgICAgICAgICAgIGRhKCJNb2R1bGUuaW5zdGFudGlhdGVXYXNtIGNhbGxiYWNrIGZhaWxlZCB3aXRoIGVycm9yOiAiICsgZyksIGthKGcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZmEgfHwgImZ1bmN0aW9uIiAhPSB0eXBlb2YgV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmcgfHwgUC5zdGFydHNXaXRoKCJkYXRhOmFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbTtiYXNlNjQsIikgfHwgUC5zdGFydHNXaXRoKCJmaWxlOi8vIikgfHwgWWEgfHwgImZ1bmN0aW9uIiAhPSB0eXBlb2YgZmV0Y2ggPyBjKGIpIDogZmV0Y2goUCwgeyBjcmVkZW50aWFsczogInNhbWUtb3JpZ2luIiB9KS50aGVuKGZ1bmN0aW9uKGcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyhnLCBkKS50aGVuKGIsIGZ1bmN0aW9uKHUzKSB7CiAgICAgICAgICAgICAgICAgIGRhKCJ3YXNtIHN0cmVhbWluZyBjb21waWxlIGZhaWxlZDogIiArIHUzKTsKICAgICAgICAgICAgICAgICAgZGEoImZhbGxpbmcgYmFjayB0byBBcnJheUJ1ZmZlciBpbnN0YW50aWF0aW9uIik7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjKGIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pKCkuY2F0Y2goa2EpOwogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgICB9KSgpOwogICAgICAgICAgdmFyIGJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Wb2lkUHRyX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChiYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfVm9pZFB0cl9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLmspLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBEYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2RlckJ1ZmZlcl9EZWNvZGVyQnVmZmVyXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChEYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2RlckJ1ZmZlcl9EZWNvZGVyQnVmZmVyXzAgPSBhMy5hc20ubCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGNiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyQnVmZmVyX0luaXRfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGNiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyQnVmZmVyX0luaXRfMiA9IGEzLmFzbS5tKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJCdWZmZXJfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGRiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyQnVmZmVyX19fZGVzdHJveV9fXzAgPSBhMy5hc20ubikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEVhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEVhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfMCA9IGEzLmFzbS5vKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfdHJhbnNmb3JtX3R5cGVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGViID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhX3RyYW5zZm9ybV90eXBlXzAgPSBhMy5hc20ucCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChmYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLnEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBGYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfR2VvbWV0cnlBdHRyaWJ1dGVfR2VvbWV0cnlBdHRyaWJ1dGVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEZhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9HZW9tZXRyeUF0dHJpYnV0ZV9HZW9tZXRyeUF0dHJpYnV0ZV8wID0gYTMuYXNtLnIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBnYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfR2VvbWV0cnlBdHRyaWJ1dGVfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9HZW9tZXRyeUF0dHJpYnV0ZV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLnMpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBHYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfUG9pbnRBdHRyaWJ1dGVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEdhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9Qb2ludEF0dHJpYnV0ZV8wID0gYTMuYXNtLnQpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBoYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfc2l6ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoaGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX3NpemVfMCA9IGEzLmFzbS51KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgaWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX0dldEF0dHJpYnV0ZVRyYW5zZm9ybURhdGFfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGliID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9HZXRBdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhXzAgPSBhMy5hc20udikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9hdHRyaWJ1dGVfdHlwZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoamIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2F0dHJpYnV0ZV90eXBlXzAgPSBhMy5hc20udykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGtiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9kYXRhX3R5cGVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGtiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9kYXRhX3R5cGVfMCA9IGEzLmFzbS54KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX251bV9jb21wb25lbnRzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChsYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfbnVtX2NvbXBvbmVudHNfMCA9IGEzLmFzbS55KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX25vcm1hbGl6ZWRfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG1iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9ub3JtYWxpemVkXzAgPSBhMy5hc20ueikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG5iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9ieXRlX3N0cmlkZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2J5dGVfc3RyaWRlXzAgPSBhMy5hc20uQSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG9iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9ieXRlX29mZnNldF8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAob2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2J5dGVfb2Zmc2V0XzAgPSBhMy5hc20uQikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHBiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV91bmlxdWVfaWRfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHBiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV91bmlxdWVfaWRfMCA9IGEzLmFzbS5DKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChxYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfX19kZXN0cm95X19fMCA9IGEzLmFzbS5EKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEhhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtXzAgPSBhMy5hc20uRSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fSW5pdEZyb21BdHRyaWJ1dGVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fSW5pdEZyb21BdHRyaWJ1dGVfMSA9IGEzLmFzbS5GKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgc2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9xdWFudGl6YXRpb25fYml0c18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoc2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9xdWFudGl6YXRpb25fYml0c18wID0gYTMuYXNtLkcpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB0YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX21pbl92YWx1ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAodGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9taW5fdmFsdWVfMSA9IGEzLmFzbS5IKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgdWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9yYW5nZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAodWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9yYW5nZV8wID0gYTMuYXNtLkkpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB2YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh2YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX19fZGVzdHJveV9fXzAgPSBhMy5hc20uSikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIElhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKElhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fMCA9IGEzLmFzbS5LKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgd2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fSW5pdEZyb21BdHRyaWJ1dGVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX0luaXRGcm9tQXR0cmlidXRlXzEgPSBhMy5hc20uTCkuYXBwbHkoCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sIHhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX3F1YW50aXphdGlvbl9iaXRzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh4YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9xdWFudGl6YXRpb25fYml0c18wID0gYTMuYXNtLk0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB5YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoeWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fX19kZXN0cm95X19fMCA9IGEzLmFzbS5OKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50Q2xvdWRfUG9pbnRDbG91ZF8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50Q2xvdWRfUG9pbnRDbG91ZF8wID0gYTMuYXNtLk8pLmFwcGx5KAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgYXJndW1lbnRzCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LCB6YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9udW1fYXR0cmlidXRlc18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoemIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50Q2xvdWRfbnVtX2F0dHJpYnV0ZXNfMCA9IGEzLmFzbS5QKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgQWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50Q2xvdWRfbnVtX3BvaW50c18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoQWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50Q2xvdWRfbnVtX3BvaW50c18wID0gYTMuYXNtLlEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBCYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoQmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50Q2xvdWRfX19kZXN0cm95X19fMCA9IGEzLmFzbS5SKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgS2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfTWVzaF8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoS2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfTWVzaF8wID0gYTMuYXNtLlMpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBDYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9udW1fZmFjZXNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKENiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX251bV9mYWNlc18wID0gYTMuYXNtLlQpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBEYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9udW1fYXR0cmlidXRlc18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfbnVtX2F0dHJpYnV0ZXNfMCA9IGEzLmFzbS5VKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfbnVtX3BvaW50c18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfbnVtX3BvaW50c18wID0gYTMuYXNtLlYpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBGYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfX19kZXN0cm95X19fMCA9IGEzLmFzbS5XKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhX01ldGFkYXRhXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChMYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFfTWV0YWRhdGFfMCA9IGEzLmFzbS5YKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgR2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChHYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFfX19kZXN0cm95X19fMCA9IGEzLmFzbS5ZKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1N0YXR1c19jb2RlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChIYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX2NvZGVfMCA9IGEzLmFzbS5aKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1N0YXR1c19va18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1N0YXR1c19va18wID0gYTMuYXNtLl8pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBKYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX2Vycm9yX21zZ18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1N0YXR1c19lcnJvcl9tc2dfMCA9IGEzLmFzbS4kKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgS2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1N0YXR1c19fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoS2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1N0YXR1c19fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLmFhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X0RyYWNvRmxvYXQzMkFycmF5XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChNYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfRHJhY29GbG9hdDMyQXJyYXlfMCA9IGEzLmFzbS5iYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIExiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9HZXRWYWx1ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20uY2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBNYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfc2l6ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X3NpemVfMCA9IGEzLmFzbS5kYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE5iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X19fZGVzdHJveV9fXzAgPSBhMy5hc20uZWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBOYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfRHJhY29JbnQ4QXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE5hID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9EcmFjb0ludDhBcnJheV8wID0gYTMuYXNtLmZhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgT2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChPYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfR2V0VmFsdWVfMSA9IGEzLmFzbS5nYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFBiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChQYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfc2l6ZV8wID0gYTMuYXNtLmhhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChRYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS5pYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE9hID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfRHJhY29VSW50OEFycmF5XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChPYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X0RyYWNvVUludDhBcnJheV8wID0gYTMuYXNtLmphKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9HZXRWYWx1ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLmthKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgU2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChTYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X3NpemVfMCA9IGEzLmFzbS5sYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFRiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFRiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS5tYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFBhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfRHJhY29JbnQxNkFycmF5XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChQYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X0RyYWNvSW50MTZBcnJheV8wID0gYTMuYXNtLm5hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgVWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9HZXRWYWx1ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLm9hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgVmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChWYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X3NpemVfMCA9IGEzLmFzbS5wYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS5xYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFFhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQxNkFycmF5X0RyYWNvVUludDE2QXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFFhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQxNkFycmF5X0RyYWNvVUludDE2QXJyYXlfMCA9IGEzLmFzbS5yYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQxNkFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChYYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLnNhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgWWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfc2l6ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoWWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfc2l6ZV8wID0gYTMuYXNtLnRhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgWmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQxNkFycmF5X19fZGVzdHJveV9fXzAgPSBhMy5hc20udWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBSYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X0RyYWNvSW50MzJBcnJheV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9EcmFjb0ludDMyQXJyYXlfMCA9IGEzLmFzbS52YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sICRiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfR2V0VmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKCRiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfR2V0VmFsdWVfMSA9IGEzLmFzbS53YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGFjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfc2l6ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoYWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9zaXplXzAgPSBhMy5hc20ueGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBiYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChiYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X19fZGVzdHJveV9fXzAgPSBhMy5hc20ueWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBTYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MzJBcnJheV9EcmFjb1VJbnQzMkFycmF5XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChTYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MzJBcnJheV9EcmFjb1VJbnQzMkFycmF5XzAgPSBhMy5hc20uemEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBjYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MzJBcnJheV9HZXRWYWx1ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoY2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfR2V0VmFsdWVfMSA9IGEzLmFzbS5BYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGRjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGRjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X3NpemVfMCA9IGEzLmFzbS5CYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGVjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChlYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MzJBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLkNhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgVGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9NZXRhZGF0YVF1ZXJpZXJfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFRhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfTWV0YWRhdGFRdWVyaWVyXzAgPSBhMy5hc20uRGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBmYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0hhc0VudHJ5XzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChmYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0hhc0VudHJ5XzIgPSBhMy5hc20uRWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBnYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldEludEVudHJ5XzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChnYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldEludEVudHJ5XzIgPSBhMy5hc20uRmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBoYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldEludEVudHJ5QXJyYXlfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGhjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0SW50RW50cnlBcnJheV8zID0gYTMuYXNtLkdhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgaWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXREb3VibGVFbnRyeV8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoaWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXREb3VibGVFbnRyeV8yID0gYTMuYXNtLkhhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgamMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRTdHJpbmdFbnRyeV8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoamMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRTdHJpbmdFbnRyeV8yID0gYTMuYXNtLklhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwga2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9OdW1FbnRyaWVzXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChrYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX051bUVudHJpZXNfMSA9IGEzLmFzbS5KYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGxjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0RW50cnlOYW1lXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChsYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldEVudHJ5TmFtZV8yID0gYTMuYXNtLkthKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLkxhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgVWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2Rlcl8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2Rlcl8wID0gYTMuYXNtLk1hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQXJyYXlUb1BvaW50Q2xvdWRfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG5jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUFycmF5VG9Qb2ludENsb3VkXzMgPSBhMy5hc20uTmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBvYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVBcnJheVRvTWVzaF8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAob2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQXJyYXlUb01lc2hfMyA9IGEzLmFzbS5PYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHBjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUlkXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChwYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJZF8yID0gYTMuYXNtLlBhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSWRCeU5hbWVfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHFjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUlkQnlOYW1lXzIgPSBhMy5hc20uUWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCByYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJZEJ5TWV0YWRhdGFFbnRyeV8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSWRCeU1ldGFkYXRhRW50cnlfMyA9IGEzLmFzbS5SYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHNjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZV8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoc2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlXzIgPSBhMy5hc20uU2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB0YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVCeVVuaXF1ZUlkXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh0YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVCeVVuaXF1ZUlkXzIgPSBhMy5hc20uVGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB1YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRNZXRhZGF0YV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAodWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0TWV0YWRhdGFfMSA9IGEzLmFzbS5VYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHZjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZU1ldGFkYXRhXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh2YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVNZXRhZGF0YV8yID0gYTMuYXNtLlZhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgd2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0RmFjZUZyb21NZXNoXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh3YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRGYWNlRnJvbU1lc2hfMyA9IGEzLmFzbS5XYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHhjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldFRyaWFuZ2xlU3RyaXBzRnJvbU1lc2hfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHhjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldFRyaWFuZ2xlU3RyaXBzRnJvbU1lc2hfMiA9IGEzLmFzbS5YYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHljID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldFRyaWFuZ2xlc1VJbnQxNkFycmF5XzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh5YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRUcmlhbmdsZXNVSW50MTZBcnJheV8zID0gYTMuYXNtLllhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgemMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVzVUludDMyQXJyYXlfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHpjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldFRyaWFuZ2xlc1VJbnQzMkFycmF5XzMgPSBhMy5hc20uWmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBBYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVGbG9hdF8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoQWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlRmxvYXRfMyA9IGEzLmFzbS5fYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChCYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVGbG9hdEZvckFsbFBvaW50c18zID0gYTMuYXNtLiRhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgQ2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50Rm9yQWxsUG9pbnRzXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChDYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnRGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS5hYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIERjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUludDhGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKERjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUludDhGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS5iYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEVjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZVVJbnQ4Rm9yQWxsUG9pbnRzXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChFYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50c18zID0gYTMuYXNtLmNiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEZjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUludDE2Rm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uZGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBHYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVVSW50MTZGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50c18zID0gYTMuYXNtLmViKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50MzJGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEhjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUludDMyRm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uZmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBJYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEljID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZVVJbnQzMkZvckFsbFBvaW50c18zID0gYTMuYXNtLmdiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlRGF0YUFycmF5Rm9yQWxsUG9pbnRzXzUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChKYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVEYXRhQXJyYXlGb3JBbGxQb2ludHNfNSA9IGEzLmFzbS5oYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEtjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX1NraXBBdHRyaWJ1dGVUcmFuc2Zvcm1fMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEtjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX1NraXBBdHRyaWJ1dGVUcmFuc2Zvcm1fMSA9IGEzLmFzbS5pYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIExjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEVuY29kZWRHZW9tZXRyeVR5cGVfRGVwcmVjYXRlZF8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0RW5jb2RlZEdlb21ldHJ5VHlwZV9EZXByZWNhdGVkXzEgPSBhMy5hc20uamIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBNYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVCdWZmZXJUb1BvaW50Q2xvdWRfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE1jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUJ1ZmZlclRvUG9pbnRDbG91ZF8yID0gYTMuYXNtLmtiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQnVmZmVyVG9NZXNoXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChOYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVCdWZmZXJUb01lc2hfMiA9IGEzLmFzbS5sYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE9jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChPYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLm1iKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX0lOVkFMSURfVFJBTlNGT1JNID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX0lOVkFMSURfVFJBTlNGT1JNID0gYTMuYXNtLm5iKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUWMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX05PX1RSQU5TRk9STSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFFjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19BdHRyaWJ1dGVUcmFuc2Zvcm1UeXBlX0FUVFJJQlVURV9OT19UUkFOU0ZPUk0gPSBhMy5hc20ub2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBSYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfUVVBTlRJWkFUSU9OX1RSQU5TRk9STSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFJjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19BdHRyaWJ1dGVUcmFuc2Zvcm1UeXBlX0FUVFJJQlVURV9RVUFOVElaQVRJT05fVFJBTlNGT1JNID0gYTMuYXNtLnBiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgU2MgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX09DVEFIRURST05fVFJBTlNGT1JNID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoU2MgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX09DVEFIRURST05fVFJBTlNGT1JNID0gYTMuYXNtLnFiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgVGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfSU5WQUxJRCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFRjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX0lOVkFMSUQgPSBhMy5hc20ucmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBVYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9QT1NJVElPTiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFVjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX1BPU0lUSU9OID0gYTMuYXNtLnNiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgVmMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfTk9STUFMID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVmMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfTk9STUFMID0gYTMuYXNtLnRiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgV2MgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfQ09MT1IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChXYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9DT0xPUiA9IGEzLmFzbS51YikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFhjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX1RFWF9DT09SRCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFhjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX1RFWF9DT09SRCA9IGEzLmFzbS52YikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFljID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX0dFTkVSSUMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChZYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9HRU5FUklDID0gYTMuYXNtLndiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgWmMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0VuY29kZWRHZW9tZXRyeVR5cGVfSU5WQUxJRF9HRU9NRVRSWV9UWVBFID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoWmMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0VuY29kZWRHZW9tZXRyeVR5cGVfSU5WQUxJRF9HRU9NRVRSWV9UWVBFID0gYTMuYXNtLnhiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgJGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0VuY29kZWRHZW9tZXRyeVR5cGVfUE9JTlRfQ0xPVUQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICgkYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRW5jb2RlZEdlb21ldHJ5VHlwZV9QT0lOVF9DTE9VRCA9IGEzLmFzbS55YikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGFkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19FbmNvZGVkR2VvbWV0cnlUeXBlX1RSSUFOR1VMQVJfTUVTSCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGFkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19FbmNvZGVkR2VvbWV0cnlUeXBlX1RSSUFOR1VMQVJfTUVTSCA9IGEzLmFzbS56YikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGJkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlZBTElEID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoYmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVkFMSUQgPSBhMy5hc20uQWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBjZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UOCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGNkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQ4ID0gYTMuYXNtLkJiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQ4ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQ4ID0gYTMuYXNtLkNiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDE2ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDE2ID0gYTMuYXNtLkRiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQxNiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGZkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UMTYgPSBhMy5hc20uRWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBnZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UMzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChnZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UMzIgPSBhMy5hc20uRmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBoZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDMyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoaGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQzMiA9IGEzLmFzbS5HYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGlkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQ2NCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGlkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQ2NCA9IGEzLmFzbS5IYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGpkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UNjQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChqZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDY0ID0gYTMuYXNtLkliKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwga2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0ZMT0FUMzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChrZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfRkxPQVQzMiA9IGEzLmFzbS5KYikuYXBwbHkoCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sIGxkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9GTE9BVDY0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0ZMT0FUNjQgPSBhMy5hc20uS2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBtZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfQk9PTCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG1kID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9CT09MID0gYTMuYXNtLkxiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1RZUEVTX0NPVU5UID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1RZUEVTX0NPVU5UID0gYTMuYXNtLk1iKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgb2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfT0sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChvZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9PSyA9IGEzLmFzbS5OYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHBkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX0RSQUNPX0VSUk9SID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfRFJBQ09fRVJST1IgPSBhMy5hc20uT2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBxZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9JT19FUlJPUiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHFkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX0lPX0VSUk9SID0gYTMuYXNtLlBiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfSU5WQUxJRF9QQVJBTUVURVIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChyZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9JTlZBTElEX1BBUkFNRVRFUiA9IGEzLmFzbS5RYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHNkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX1VOU1VQUE9SVEVEX1ZFUlNJT04gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChzZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9VTlNVUFBPUlRFRF9WRVJTSU9OID0gYTMuYXNtLlJiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgdGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfVU5LTk9XTl9WRVJTSU9OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAodGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfVU5LTk9XTl9WRVJTSU9OID0gYTMuYXNtLlNiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLl9tYWxsb2MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChhMy5fbWFsbG9jID0gYTMuYXNtLlRiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLl9mcmVlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoYTMuX2ZyZWUgPSBhMy5hc20uVWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHlhID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoeWEgPSBhMy5hc20uVmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgYTMuX19fc3RhcnRfZW1fanMgPSAxNTg1NjsKICAgICAgICAgIGEzLl9fX3N0b3BfZW1fanMgPSAxNTk1NDsKICAgICAgICAgIHZhciBsYTsKICAgICAgICAgIGlhID0gZnVuY3Rpb24gYigpIHsKICAgICAgICAgICAgbGEgfHwgYmEoKTsKICAgICAgICAgICAgbGEgfHwgKGlhID0gYik7CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGEzLnByZUluaXQpIGZvciAoImZ1bmN0aW9uIiA9PSB0eXBlb2YgYTMucHJlSW5pdCAmJiAoYTMucHJlSW5pdCA9IFthMy5wcmVJbml0XSk7IDAgPCBhMy5wcmVJbml0Lmxlbmd0aDsgKSBhMy5wcmVJbml0LnBvcCgpKCk7CiAgICAgICAgICBiYSgpOwogICAgICAgICAgdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIHQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gdDsKICAgICAgICAgIHQucHJvdG90eXBlLl9fY2xhc3NfXyA9IHQ7CiAgICAgICAgICB0Ll9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuV3JhcHBlck9iamVjdCA9IHQ7CiAgICAgICAgICBhMy5nZXRDYWNoZSA9IHg7CiAgICAgICAgICBhMy53cmFwUG9pbnRlciA9IEQ7CiAgICAgICAgICBhMy5jYXN0T2JqZWN0ID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICByZXR1cm4gRChiLnB0ciwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgYTMuTlVMTCA9IEQoMCk7CiAgICAgICAgICBhMy5kZXN0cm95ID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICBpZiAoIWIuX19kZXN0cm95X18pIHRocm93ICJFcnJvcjogQ2Fubm90IGRlc3Ryb3kgb2JqZWN0LiAoRGlkIHlvdSBjcmVhdGUgaXQgeW91cnNlbGY/KSI7CiAgICAgICAgICAgIGIuX19kZXN0cm95X18oKTsKICAgICAgICAgICAgZGVsZXRlIHgoYi5fX2NsYXNzX18pW2IucHRyXTsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5jb21wYXJlID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICByZXR1cm4gYi5wdHIgPT09IGMucHRyOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLmdldFBvaW50ZXIgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHJldHVybiBiLnB0cjsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5nZXRDbGFzcyA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgcmV0dXJuIGIuX19jbGFzc19fOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciByID0geyBidWZmZXI6IDAsIHNpemU6IDAsIHBvczogMCwgdGVtcHM6IFtdLCBuZWVkZWQ6IDAsIHByZXBhcmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoci5uZWVkZWQpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBiID0gMDsgYiA8IHIudGVtcHMubGVuZ3RoOyBiKyspIGEzLl9mcmVlKHIudGVtcHNbYl0pOwogICAgICAgICAgICAgIHIudGVtcHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgICBhMy5fZnJlZShyLmJ1ZmZlcik7CiAgICAgICAgICAgICAgci5idWZmZXIgPSAwOwogICAgICAgICAgICAgIHIuc2l6ZSArPSByLm5lZWRlZDsKICAgICAgICAgICAgICByLm5lZWRlZCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgci5idWZmZXIgfHwgKHIuc2l6ZSArPSAxMjgsIHIuYnVmZmVyID0gYTMuX21hbGxvYyhyLnNpemUpLCByLmJ1ZmZlciB8fCBmKHZvaWQgMCkpOwogICAgICAgICAgICByLnBvcyA9IDA7CiAgICAgICAgICB9LCBhbGxvYzogZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICByLmJ1ZmZlciB8fCBmKHZvaWQgMCk7CiAgICAgICAgICAgIGIgPSBiLmxlbmd0aCAqIGMuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICAgIGIgPSBiICsgNyAmIC04OwogICAgICAgICAgICByLnBvcyArIGIgPj0gci5zaXplID8gKDAgPCBiIHx8IGYodm9pZCAwKSwgci5uZWVkZWQgKz0gYiwgYyA9IGEzLl9tYWxsb2MoYiksIHIudGVtcHMucHVzaChjKSkgOiAoYyA9IHIuYnVmZmVyICsgci5wb3MsIHIucG9zICs9IGIpOwogICAgICAgICAgICByZXR1cm4gYzsKICAgICAgICAgIH0sIGNvcHk6IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgZCA+Pj49IDA7CiAgICAgICAgICAgIHN3aXRjaCAoYy5CWVRFU19QRVJfRUxFTUVOVCkgewogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIGQgPj4+PSAxOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgZCA+Pj49IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICBkID4+Pj0gMzsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBnID0gMDsgZyA8IGIubGVuZ3RoOyBnKyspIGNbZCArIGddID0gYltnXTsKICAgICAgICAgIH0gfTsKICAgICAgICAgIFoucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBaLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFo7CiAgICAgICAgICBaLnByb3RvdHlwZS5fX2NsYXNzX18gPSBaOwogICAgICAgICAgWi5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLlZvaWRQdHIgPSBaOwogICAgICAgICAgWi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBaLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBiYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgUy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIFMucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUzsKICAgICAgICAgIFMucHJvdG90eXBlLl9fY2xhc3NfXyA9IFM7CiAgICAgICAgICBTLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRGVjb2RlckJ1ZmZlciA9IFM7CiAgICAgICAgICBTLnByb3RvdHlwZS5Jbml0ID0gUy5wcm90b3R5cGUuSW5pdCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgICJvYmplY3QiID09IHR5cGVvZiBiICYmIChiID0gcGEoYikpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgY2IoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgUy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBTLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgUS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIFEucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUTsKICAgICAgICAgIFEucHJvdG90eXBlLl9fY2xhc3NfXyA9IFE7CiAgICAgICAgICBRLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuQXR0cmlidXRlVHJhbnNmb3JtRGF0YSA9IFE7CiAgICAgICAgICBRLnByb3RvdHlwZS50cmFuc2Zvcm1fdHlwZSA9IFEucHJvdG90eXBlLnRyYW5zZm9ybV90eXBlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBlYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgUS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBRLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgVy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIFcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVzsKICAgICAgICAgIFcucHJvdG90eXBlLl9fY2xhc3NfXyA9IFc7CiAgICAgICAgICBXLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuR2VvbWV0cnlBdHRyaWJ1dGUgPSBXOwogICAgICAgICAgVy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBXLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBnYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIHcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gdzsKICAgICAgICAgIHcucHJvdG90eXBlLl9fY2xhc3NfXyA9IHc7CiAgICAgICAgICB3Ll9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuUG9pbnRBdHRyaWJ1dGUgPSB3OwogICAgICAgICAgdy5wcm90b3R5cGUuc2l6ZSA9IHcucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGhiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhID0gdy5wcm90b3R5cGUuR2V0QXR0cmlidXRlVHJhbnNmb3JtRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gRChpYih0aGlzLnB0ciksIFEpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlLmF0dHJpYnV0ZV90eXBlID0gdy5wcm90b3R5cGUuYXR0cmlidXRlX3R5cGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGpiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5kYXRhX3R5cGUgPSB3LnByb3RvdHlwZS5kYXRhX3R5cGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGtiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5udW1fY29tcG9uZW50cyA9IHcucHJvdG90eXBlLm51bV9jb21wb25lbnRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUubm9ybWFsaXplZCA9IHcucHJvdG90eXBlLm5vcm1hbGl6ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICEhbWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlLmJ5dGVfc3RyaWRlID0gdy5wcm90b3R5cGUuYnl0ZV9zdHJpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIG5iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5ieXRlX29mZnNldCA9IHcucHJvdG90eXBlLmJ5dGVfb2Zmc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBvYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUudW5pcXVlX2lkID0gdy5wcm90b3R5cGUudW5pcXVlX2lkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBwYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUuX19kZXN0cm95X18gPSB3LnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBxYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgQy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEMucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQzsKICAgICAgICAgIEMucHJvdG90eXBlLl9fY2xhc3NfXyA9IEM7CiAgICAgICAgICBDLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtID0gQzsKICAgICAgICAgIEMucHJvdG90eXBlLkluaXRGcm9tQXR0cmlidXRlID0gQy5wcm90b3R5cGUuSW5pdEZyb21BdHRyaWJ1dGUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFyYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBDLnByb3RvdHlwZS5xdWFudGl6YXRpb25fYml0cyA9IEMucHJvdG90eXBlLnF1YW50aXphdGlvbl9iaXRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBzYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgQy5wcm90b3R5cGUubWluX3ZhbHVlID0gQy5wcm90b3R5cGUubWluX3ZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIHRiKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIEMucHJvdG90eXBlLnJhbmdlID0gQy5wcm90b3R5cGUucmFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHViKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBDLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEMucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBGLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgRi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBGOwogICAgICAgICAgRi5wcm90b3R5cGUuX19jbGFzc19fID0gRjsKICAgICAgICAgIEYuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtID0gRjsKICAgICAgICAgIEYucHJvdG90eXBlLkluaXRGcm9tQXR0cmlidXRlID0gRi5wcm90b3R5cGUuSW5pdEZyb21BdHRyaWJ1dGUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gISF3YihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBGLnByb3RvdHlwZS5xdWFudGl6YXRpb25fYml0cyA9IEYucHJvdG90eXBlLnF1YW50aXphdGlvbl9iaXRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB4Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBGLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB5Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRzsKICAgICAgICAgIEcucHJvdG90eXBlLl9fY2xhc3NfXyA9IEc7CiAgICAgICAgICBHLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuUG9pbnRDbG91ZCA9IEc7CiAgICAgICAgICBHLnByb3RvdHlwZS5udW1fYXR0cmlidXRlcyA9IEcucHJvdG90eXBlLm51bV9hdHRyaWJ1dGVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB6Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRy5wcm90b3R5cGUubnVtX3BvaW50cyA9IEcucHJvdG90eXBlLm51bV9wb2ludHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBHLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEcucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIEJiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBFLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgRS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBFOwogICAgICAgICAgRS5wcm90b3R5cGUuX19jbGFzc19fID0gRTsKICAgICAgICAgIEUuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5NZXNoID0gRTsKICAgICAgICAgIEUucHJvdG90eXBlLm51bV9mYWNlcyA9IEUucHJvdG90eXBlLm51bV9mYWNlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQ2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEUucHJvdG90eXBlLm51bV9hdHRyaWJ1dGVzID0gRS5wcm90b3R5cGUubnVtX2F0dHJpYnV0ZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIERiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBFLnByb3RvdHlwZS5udW1fcG9pbnRzID0gRS5wcm90b3R5cGUubnVtX3BvaW50cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gRWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEUucHJvdG90eXBlLl9fZGVzdHJveV9fID0gRS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgRmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIFQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBULnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFQ7CiAgICAgICAgICBULnByb3RvdHlwZS5fX2NsYXNzX18gPSBUOwogICAgICAgICAgVC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLk1ldGFkYXRhID0gVDsKICAgICAgICAgIFQucHJvdG90eXBlLl9fZGVzdHJveV9fID0gVC5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgR2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBCLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEI7CiAgICAgICAgICBCLnByb3RvdHlwZS5fX2NsYXNzX18gPSBCOwogICAgICAgICAgQi5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLlN0YXR1cyA9IEI7CiAgICAgICAgICBCLnByb3RvdHlwZS5jb2RlID0gQi5wcm90b3R5cGUuY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gSGIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlLm9rID0gQi5wcm90b3R5cGUub2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICEhSWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlLmVycm9yX21zZyA9IEIucHJvdG90eXBlLmVycm9yX21zZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gaChKYih0aGlzLnB0cikpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlLl9fZGVzdHJveV9fID0gQi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgS2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEgucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBILnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEg7CiAgICAgICAgICBILnByb3RvdHlwZS5fX2NsYXNzX18gPSBIOwogICAgICAgICAgSC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvRmxvYXQzMkFycmF5ID0gSDsKICAgICAgICAgIEgucHJvdG90eXBlLkdldFZhbHVlID0gSC5wcm90b3R5cGUuR2V0VmFsdWUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gTGIoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgSC5wcm90b3R5cGUuc2l6ZSA9IEgucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBILnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEgucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIE5iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBJLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgSS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBJOwogICAgICAgICAgSS5wcm90b3R5cGUuX19jbGFzc19fID0gSTsKICAgICAgICAgIEkuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EcmFjb0ludDhBcnJheSA9IEk7CiAgICAgICAgICBJLnByb3RvdHlwZS5HZXRWYWx1ZSA9IEkucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIE9iKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIEkucHJvdG90eXBlLnNpemUgPSBJLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBQYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBJLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBRYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEoucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSjsKICAgICAgICAgIEoucHJvdG90eXBlLl9fY2xhc3NfXyA9IEo7CiAgICAgICAgICBKLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRHJhY29VSW50OEFycmF5ID0gSjsKICAgICAgICAgIEoucHJvdG90eXBlLkdldFZhbHVlID0gSi5wcm90b3R5cGUuR2V0VmFsdWUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gUmIoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgSi5wcm90b3R5cGUuc2l6ZSA9IEoucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFNiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBKLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEoucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIFRiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBLLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgSy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBLOwogICAgICAgICAgSy5wcm90b3R5cGUuX19jbGFzc19fID0gSzsKICAgICAgICAgIEsuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EcmFjb0ludDE2QXJyYXkgPSBLOwogICAgICAgICAgSy5wcm90b3R5cGUuR2V0VmFsdWUgPSBLLnByb3RvdHlwZS5HZXRWYWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBVYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBLLnByb3RvdHlwZS5zaXplID0gSy5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gVmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEsucHJvdG90eXBlLl9fZGVzdHJveV9fID0gSy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgV2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEwucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBMLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEw7CiAgICAgICAgICBMLnByb3RvdHlwZS5fX2NsYXNzX18gPSBMOwogICAgICAgICAgTC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvVUludDE2QXJyYXkgPSBMOwogICAgICAgICAgTC5wcm90b3R5cGUuR2V0VmFsdWUgPSBMLnByb3RvdHlwZS5HZXRWYWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBYYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBMLnByb3RvdHlwZS5zaXplID0gTC5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gWWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEwucHJvdG90eXBlLl9fZGVzdHJveV9fID0gTC5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgWmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIE0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBNLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE07CiAgICAgICAgICBNLnByb3RvdHlwZS5fX2NsYXNzX18gPSBNOwogICAgICAgICAgTS5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvSW50MzJBcnJheSA9IE07CiAgICAgICAgICBNLnByb3RvdHlwZS5HZXRWYWx1ZSA9IE0ucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuICRiKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIE0ucHJvdG90eXBlLnNpemUgPSBNLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBhYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgTS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBNLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBiYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgTi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIE4ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTjsKICAgICAgICAgIE4ucHJvdG90eXBlLl9fY2xhc3NfXyA9IE47CiAgICAgICAgICBOLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRHJhY29VSW50MzJBcnJheSA9IE47CiAgICAgICAgICBOLnByb3RvdHlwZS5HZXRWYWx1ZSA9IE4ucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIGNjKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIE4ucHJvdG90eXBlLnNpemUgPSBOLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgTi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBOLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgeS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIHkucHJvdG90eXBlLmNvbnN0cnVjdG9yID0geTsKICAgICAgICAgIHkucHJvdG90eXBlLl9fY2xhc3NfXyA9IHk7CiAgICAgICAgICB5Ll9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuTWV0YWRhdGFRdWVyaWVyID0geTsKICAgICAgICAgIHkucHJvdG90eXBlLkhhc0VudHJ5ID0geS5wcm90b3R5cGUuSGFzRW50cnkgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gISFmYyhkLCBiLCBjKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5HZXRJbnRFbnRyeSA9IHkucHJvdG90eXBlLkdldEludEVudHJ5ID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgPSBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyA/IGMucHRyIDogUihjKTsKICAgICAgICAgICAgcmV0dXJuIGdjKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLkdldEludEVudHJ5QXJyYXkgPSB5LnByb3RvdHlwZS5HZXRJbnRFbnRyeUFycmF5ID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgPSBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyA/IGMucHRyIDogUihjKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIGhjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLkdldERvdWJsZUVudHJ5ID0geS5wcm90b3R5cGUuR2V0RG91YmxlRW50cnkgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gaWMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgeS5wcm90b3R5cGUuR2V0U3RyaW5nRW50cnkgPSB5LnByb3RvdHlwZS5HZXRTdHJpbmdFbnRyeSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjID0gYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgPyBjLnB0ciA6IFIoYyk7CiAgICAgICAgICAgIHJldHVybiBoKGpjKGQsIGIsIGMpKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5OdW1FbnRyaWVzID0geS5wcm90b3R5cGUuTnVtRW50cmllcyA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBrYyhjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5HZXRFbnRyeU5hbWUgPSB5LnByb3RvdHlwZS5HZXRFbnRyeU5hbWUgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIGgobGMoZCwgYiwgYykpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLl9fZGVzdHJveV9fID0geS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbWModGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IG07CiAgICAgICAgICBtLnByb3RvdHlwZS5fX2NsYXNzX18gPSBtOwogICAgICAgICAgbS5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRlY29kZXIgPSBtOwogICAgICAgICAgbS5wcm90b3R5cGUuRGVjb2RlQXJyYXlUb1BvaW50Q2xvdWQgPSBtLnByb3RvdHlwZS5EZWNvZGVBcnJheVRvUG9pbnRDbG91ZCA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgICJvYmplY3QiID09IHR5cGVvZiBiICYmIChiID0gcGEoYikpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiBEKG5jKGcsIGIsIGMsIGQpLCBCKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5EZWNvZGVBcnJheVRvTWVzaCA9IG0ucHJvdG90eXBlLkRlY29kZUFycmF5VG9NZXNoID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgIm9iamVjdCIgPT0gdHlwZW9mIGIgJiYgKGIgPSBwYShiKSk7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQob2MoZywgYiwgYywgZCksIEIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUlkID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIHBjKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUlkQnlOYW1lID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWRCeU5hbWUgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gcWMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWRCeU1ldGFkYXRhRW50cnkgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJZEJ5TWV0YWRhdGFFbnRyeSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjID0gYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgPyBjLnB0ciA6IFIoYyk7CiAgICAgICAgICAgIGQgPSBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCA/IGQucHRyIDogUihkKTsKICAgICAgICAgICAgcmV0dXJuIHJjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZSA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4gRChzYyhkLCBiLCBjKSwgdyk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlQnlVbmlxdWVJZCA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQodGMoZCwgYiwgYyksIHcpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldE1ldGFkYXRhID0gbS5wcm90b3R5cGUuR2V0TWV0YWRhdGEgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gRCh1YyhjLCBiKSwgVCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlTWV0YWRhdGEgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVNZXRhZGF0YSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4gRCh2YyhkLCBiLCBjKSwgVCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0RmFjZUZyb21NZXNoID0gbS5wcm90b3R5cGUuR2V0RmFjZUZyb21NZXNoID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISF3YyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRUcmlhbmdsZVN0cmlwc0Zyb21NZXNoID0gbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVTdHJpcHNGcm9tTWVzaCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4geGMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVzVUludDE2QXJyYXkgPSBtLnByb3RvdHlwZS5HZXRUcmlhbmdsZXNVSW50MTZBcnJheSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEheWMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVzVUludDMyQXJyYXkgPSBtLnByb3RvdHlwZS5HZXRUcmlhbmdsZXNVSW50MzJBcnJheSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhemMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlRmxvYXQgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVGbG9hdCA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhQWMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVGbG9hdEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhQmMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50Rm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFDYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQ4Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhRGMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhRWMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQxNkZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhRmMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFHYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cyA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUludDMyRm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFIYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHMgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUljKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZURhdGFBcnJheUZvckFsbFBvaW50cyA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZURhdGFBcnJheUZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQsIGcsIHUzKSB7CiAgICAgICAgICAgIHZhciBYID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIGcgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBnICYmIChnID0gZy5wdHIpOwogICAgICAgICAgICB1MyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIHUzICYmICh1MyA9IHUzLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUpjKFgsIGIsIGMsIGQsIGcsIHUzKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5Ta2lwQXR0cmlidXRlVHJhbnNmb3JtID0gbS5wcm90b3R5cGUuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIEtjKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEVuY29kZWRHZW9tZXRyeVR5cGVfRGVwcmVjYXRlZCA9IG0ucHJvdG90eXBlLkdldEVuY29kZWRHZW9tZXRyeVR5cGVfRGVwcmVjYXRlZCA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBMYyhjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5EZWNvZGVCdWZmZXJUb1BvaW50Q2xvdWQgPSBtLnByb3RvdHlwZS5EZWNvZGVCdWZmZXJUb1BvaW50Q2xvdWQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQoTWMoZCwgYiwgYyksIEIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkRlY29kZUJ1ZmZlclRvTWVzaCA9IG0ucHJvdG90eXBlLkRlY29kZUJ1ZmZlclRvTWVzaCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4gRChOYyhkLCBiLCBjKSwgQik7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBtLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBPYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBiKCkgewogICAgICAgICAgICAgIGEzLkFUVFJJQlVURV9JTlZBTElEX1RSQU5TRk9STSA9IFBjKCk7CiAgICAgICAgICAgICAgYTMuQVRUUklCVVRFX05PX1RSQU5TRk9STSA9IFFjKCk7CiAgICAgICAgICAgICAgYTMuQVRUUklCVVRFX1FVQU5USVpBVElPTl9UUkFOU0ZPUk0gPSBSYygpOwogICAgICAgICAgICAgIGEzLkFUVFJJQlVURV9PQ1RBSEVEUk9OX1RSQU5TRk9STSA9IFNjKCk7CiAgICAgICAgICAgICAgYTMuSU5WQUxJRCA9IFRjKCk7CiAgICAgICAgICAgICAgYTMuUE9TSVRJT04gPSBVYygpOwogICAgICAgICAgICAgIGEzLk5PUk1BTCA9IFZjKCk7CiAgICAgICAgICAgICAgYTMuQ09MT1IgPSBXYygpOwogICAgICAgICAgICAgIGEzLlRFWF9DT09SRCA9IFhjKCk7CiAgICAgICAgICAgICAgYTMuR0VORVJJQyA9IFljKCk7CiAgICAgICAgICAgICAgYTMuSU5WQUxJRF9HRU9NRVRSWV9UWVBFID0gWmMoKTsKICAgICAgICAgICAgICBhMy5QT0lOVF9DTE9VRCA9ICRjKCk7CiAgICAgICAgICAgICAgYTMuVFJJQU5HVUxBUl9NRVNIID0gYWQoKTsKICAgICAgICAgICAgICBhMy5EVF9JTlZBTElEID0gYmQoKTsKICAgICAgICAgICAgICBhMy5EVF9JTlQ4ID0gY2QoKTsKICAgICAgICAgICAgICBhMy5EVF9VSU5UOCA9IGRkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UMTYgPSBlZCgpOwogICAgICAgICAgICAgIGEzLkRUX1VJTlQxNiA9IGZkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UMzIgPSBnZCgpOwogICAgICAgICAgICAgIGEzLkRUX1VJTlQzMiA9IGhkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UNjQgPSBpZCgpOwogICAgICAgICAgICAgIGEzLkRUX1VJTlQ2NCA9IGpkKCk7CiAgICAgICAgICAgICAgYTMuRFRfRkxPQVQzMiA9IGtkKCk7CiAgICAgICAgICAgICAgYTMuRFRfRkxPQVQ2NCA9IGxkKCk7CiAgICAgICAgICAgICAgYTMuRFRfQk9PTCA9IG1kKCk7CiAgICAgICAgICAgICAgYTMuRFRfVFlQRVNfQ09VTlQgPSBuZCgpOwogICAgICAgICAgICAgIGEzLk9LID0gb2QoKTsKICAgICAgICAgICAgICBhMy5EUkFDT19FUlJPUiA9IHBkKCk7CiAgICAgICAgICAgICAgYTMuSU9fRVJST1IgPSBxZCgpOwogICAgICAgICAgICAgIGEzLklOVkFMSURfUEFSQU1FVEVSID0gcmQoKTsKICAgICAgICAgICAgICBhMy5VTlNVUFBPUlRFRF9WRVJTSU9OID0gc2QoKTsKICAgICAgICAgICAgICBhMy5VTktOT1dOX1ZFUlNJT04gPSB0ZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHphID8gYigpIDogb2EudW5zaGlmdChiKTsKICAgICAgICAgIH0pKCk7CiAgICAgICAgICBpZiAoImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGEzLm9uTW9kdWxlUGFyc2VkKSBhMy5vbk1vZHVsZVBhcnNlZCgpOwogICAgICAgICAgYTMuRGVjb2Rlci5wcm90b3R5cGUuR2V0RW5jb2RlZEdlb21ldHJ5VHlwZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgaWYgKGIuX19jbGFzc19fICYmIGIuX19jbGFzc19fID09PSBhMy5EZWNvZGVyQnVmZmVyKSByZXR1cm4gYTMuRGVjb2Rlci5wcm90b3R5cGUuR2V0RW5jb2RlZEdlb21ldHJ5VHlwZV9EZXByZWNhdGVkKGIpOwogICAgICAgICAgICBpZiAoOCA+IGIuYnl0ZUxlbmd0aCkgcmV0dXJuIGEzLklOVkFMSURfR0VPTUVUUllfVFlQRTsKICAgICAgICAgICAgc3dpdGNoIChiWzddKSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIGEzLlBPSU5UX0NMT1VEOwogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIHJldHVybiBhMy5UUklBTkdVTEFSX01FU0g7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBhMy5JTlZBTElEX0dFT01FVFJZX1RZUEU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gbi5yZWFkeTsKICAgICAgICB9OwogICAgICB9KCk7CiAgICAgICJvYmplY3QiID09PSB0eXBlb2YgZXhwb3J0czIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBtb2R1bGUgPyBtb2R1bGUuZXhwb3J0cyA9IERyYWNvRGVjb2Rlck1vZHVsZSA6ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBkZWZpbmUgJiYgZGVmaW5lLmFtZCA/IGRlZmluZShbXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIERyYWNvRGVjb2Rlck1vZHVsZTsKICAgICAgfSkgOiAib2JqZWN0IiA9PT0gdHlwZW9mIGV4cG9ydHMyICYmIChleHBvcnRzMi5EcmFjb0RlY29kZXJNb2R1bGUgPSBEcmFjb0RlY29kZXJNb2R1bGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlRHJhY28uanMKICB2YXIgZGVjb2RlRHJhY29fZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGRlY29kZURyYWNvX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGRlY29kZURyYWNvX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBkZWNvZGVJbmRleEFycmF5KGRyYWNvR2VvbWV0cnksIGRyYWNvRGVjb2RlcikgewogICAgY29uc3QgbnVtUG9pbnRzID0gZHJhY29HZW9tZXRyeS5udW1fcG9pbnRzKCk7CiAgICBjb25zdCBudW1GYWNlcyA9IGRyYWNvR2VvbWV0cnkubnVtX2ZhY2VzKCk7CiAgICBjb25zdCBmYWNlSW5kaWNlcyA9IG5ldyBkcmFjby5EcmFjb0ludDMyQXJyYXkoKTsKICAgIGNvbnN0IG51bUluZGljZXMgPSBudW1GYWNlcyAqIDM7CiAgICBjb25zdCBpbmRleEFycmF5ID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtUG9pbnRzLCBudW1JbmRpY2VzKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1GYWNlczsgKytpKSB7CiAgICAgIGRyYWNvRGVjb2Rlci5HZXRGYWNlRnJvbU1lc2goZHJhY29HZW9tZXRyeSwgaSwgZmFjZUluZGljZXMpOwogICAgICBpbmRleEFycmF5W29mZnNldCArIDBdID0gZmFjZUluZGljZXMuR2V0VmFsdWUoMCk7CiAgICAgIGluZGV4QXJyYXlbb2Zmc2V0ICsgMV0gPSBmYWNlSW5kaWNlcy5HZXRWYWx1ZSgxKTsKICAgICAgaW5kZXhBcnJheVtvZmZzZXQgKyAyXSA9IGZhY2VJbmRpY2VzLkdldFZhbHVlKDIpOwogICAgICBvZmZzZXQgKz0gMzsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3koZmFjZUluZGljZXMpOwogICAgcmV0dXJuIHsKICAgICAgdHlwZWRBcnJheTogaW5kZXhBcnJheSwKICAgICAgbnVtYmVyT2ZJbmRpY2VzOiBudW1JbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBkZWNvZGVRdWFudGl6ZWREcmFjb1R5cGVkQXJyYXkoZHJhY29HZW9tZXRyeSwgZHJhY29EZWNvZGVyLCBkcmFjb0F0dHJpYnV0ZSwgcXVhbnRpemF0aW9uLCB2ZXJ0ZXhBcnJheUxlbmd0aCkgewogICAgbGV0IHZlcnRleEFycmF5OwogICAgbGV0IGF0dHJpYnV0ZURhdGE7CiAgICBpZiAocXVhbnRpemF0aW9uLnF1YW50aXphdGlvbkJpdHMgPD0gOCkgewogICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvVUludDhBcnJheSgpOwogICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50OEFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQ4Rm9yQWxsUG9pbnRzKAogICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICApOwogICAgfSBlbHNlIGlmIChxdWFudGl6YXRpb24ucXVhbnRpemF0aW9uQml0cyA8PSAxNikgewogICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvVUludDE2QXJyYXkoKTsKICAgICAgdmVydGV4QXJyYXkgPSBuZXcgVWludDE2QXJyYXkodmVydGV4QXJyYXlMZW5ndGgpOwogICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzKAogICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb0Zsb2F0MzJBcnJheSgpOwogICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4QXJyYXlMZW5ndGgpOwogICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHMoCiAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICBhdHRyaWJ1dGVEYXRhCiAgICAgICk7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleEFycmF5TGVuZ3RoOyArK2kpIHsKICAgICAgdmVydGV4QXJyYXlbaV0gPSBhdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgfQogICAgZHJhY28uZGVzdHJveShhdHRyaWJ1dGVEYXRhKTsKICAgIHJldHVybiB2ZXJ0ZXhBcnJheTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRHJhY29UeXBlZEFycmF5KGRyYWNvR2VvbWV0cnksIGRyYWNvRGVjb2RlciwgZHJhY29BdHRyaWJ1dGUsIHZlcnRleEFycmF5TGVuZ3RoKSB7CiAgICBsZXQgdmVydGV4QXJyYXk7CiAgICBsZXQgYXR0cmlidXRlRGF0YTsKICAgIHN3aXRjaCAoZHJhY29BdHRyaWJ1dGUuZGF0YV90eXBlKCkpIHsKICAgICAgY2FzZSAxOgogICAgICBjYXNlIDExOgogICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29JbnQ4QXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBJbnQ4QXJyYXkodmVydGV4QXJyYXlMZW5ndGgpOwogICAgICAgIGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVJbnQ4Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvVUludDhBcnJheSgpOwogICAgICAgIHZlcnRleEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkodmVydGV4QXJyYXlMZW5ndGgpOwogICAgICAgIGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb0ludDE2QXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBJbnQxNkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBhdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSA0OgogICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29VSW50MTZBcnJheSgpOwogICAgICAgIHZlcnRleEFycmF5ID0gbmV3IFVpbnQxNkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgNToKICAgICAgY2FzZSA3OgogICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29JbnQzMkFycmF5KCk7CiAgICAgICAgdmVydGV4QXJyYXkgPSBuZXcgSW50MzJBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDMyRm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgNjoKICAgICAgY2FzZSA4OgogICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29VSW50MzJBcnJheSgpOwogICAgICAgIHZlcnRleEFycmF5ID0gbmV3IFVpbnQzMkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDMyRm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgOToKICAgICAgY2FzZSAxMDoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvRmxvYXQzMkFycmF5KCk7CiAgICAgICAgdmVydGV4QXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBhdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydGV4QXJyYXlMZW5ndGg7ICsraSkgewogICAgICB2ZXJ0ZXhBcnJheVtpXSA9IGF0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGF0dHJpYnV0ZURhdGEpOwogICAgcmV0dXJuIHZlcnRleEFycmF5OwogIH0KICBmdW5jdGlvbiBkZWNvZGVBdHRyaWJ1dGUoZHJhY29HZW9tZXRyeSwgZHJhY29EZWNvZGVyLCBkcmFjb0F0dHJpYnV0ZSkgewogICAgY29uc3QgbnVtUG9pbnRzID0gZHJhY29HZW9tZXRyeS5udW1fcG9pbnRzKCk7CiAgICBjb25zdCBudW1Db21wb25lbnRzID0gZHJhY29BdHRyaWJ1dGUubnVtX2NvbXBvbmVudHMoKTsKICAgIGxldCBxdWFudGl6YXRpb247CiAgICBsZXQgdHJhbnNmb3JtMiA9IG5ldyBkcmFjby5BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm0oKTsKICAgIGlmICh0cmFuc2Zvcm0yLkluaXRGcm9tQXR0cmlidXRlKGRyYWNvQXR0cmlidXRlKSkgewogICAgICBjb25zdCBtaW5WYWx1ZXMgPSBuZXcgQXJyYXkobnVtQ29tcG9uZW50cyk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQ29tcG9uZW50czsgKytpKSB7CiAgICAgICAgbWluVmFsdWVzW2ldID0gdHJhbnNmb3JtMi5taW5fdmFsdWUoaSk7CiAgICAgIH0KICAgICAgcXVhbnRpemF0aW9uID0gewogICAgICAgIHF1YW50aXphdGlvbkJpdHM6IHRyYW5zZm9ybTIucXVhbnRpemF0aW9uX2JpdHMoKSwKICAgICAgICBtaW5WYWx1ZXMsCiAgICAgICAgcmFuZ2U6IHRyYW5zZm9ybTIucmFuZ2UoKSwKICAgICAgICBvY3RFbmNvZGVkOiBmYWxzZQogICAgICB9OwogICAgfQogICAgZHJhY28uZGVzdHJveSh0cmFuc2Zvcm0yKTsKICAgIHRyYW5zZm9ybTIgPSBuZXcgZHJhY28uQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybSgpOwogICAgaWYgKHRyYW5zZm9ybTIuSW5pdEZyb21BdHRyaWJ1dGUoZHJhY29BdHRyaWJ1dGUpKSB7CiAgICAgIHF1YW50aXphdGlvbiA9IHsKICAgICAgICBxdWFudGl6YXRpb25CaXRzOiB0cmFuc2Zvcm0yLnF1YW50aXphdGlvbl9iaXRzKCksCiAgICAgICAgb2N0RW5jb2RlZDogdHJ1ZQogICAgICB9OwogICAgfQogICAgZHJhY28uZGVzdHJveSh0cmFuc2Zvcm0yKTsKICAgIGNvbnN0IHZlcnRleEFycmF5TGVuZ3RoID0gbnVtUG9pbnRzICogbnVtQ29tcG9uZW50czsKICAgIGxldCB2ZXJ0ZXhBcnJheTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocXVhbnRpemF0aW9uKSkgewogICAgICB2ZXJ0ZXhBcnJheSA9IGRlY29kZVF1YW50aXplZERyYWNvVHlwZWRBcnJheSgKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvRGVjb2RlciwKICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICBxdWFudGl6YXRpb24sCiAgICAgICAgdmVydGV4QXJyYXlMZW5ndGgKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIHZlcnRleEFycmF5ID0gZGVjb2RlRHJhY29UeXBlZEFycmF5KAogICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgZHJhY29EZWNvZGVyLAogICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgIHZlcnRleEFycmF5TGVuZ3RoCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBjb21wb25lbnREYXRhdHlwZSA9IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuZnJvbVR5cGVkQXJyYXkodmVydGV4QXJyYXkpOwogICAgcmV0dXJuIHsKICAgICAgYXJyYXk6IHZlcnRleEFycmF5LAogICAgICBkYXRhOiB7CiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogbnVtQ29tcG9uZW50cywKICAgICAgICBjb21wb25lbnREYXRhdHlwZSwKICAgICAgICBieXRlT2Zmc2V0OiBkcmFjb0F0dHJpYnV0ZS5ieXRlX29mZnNldCgpLAogICAgICAgIGJ5dGVTdHJpZGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuZ2V0U2l6ZUluQnl0ZXMoY29tcG9uZW50RGF0YXR5cGUpICogbnVtQ29tcG9uZW50cywKICAgICAgICBub3JtYWxpemVkOiBkcmFjb0F0dHJpYnV0ZS5ub3JtYWxpemVkKCksCiAgICAgICAgcXVhbnRpemF0aW9uCiAgICAgIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIGRlY29kZVBvaW50Q2xvdWQocGFyYW1ldGVycykgewogICAgY29uc3QgZHJhY29EZWNvZGVyID0gbmV3IGRyYWNvLkRlY29kZXIoKTsKICAgIGlmIChwYXJhbWV0ZXJzLmRlcXVhbnRpemVJblNoYWRlcikgewogICAgICBkcmFjb0RlY29kZXIuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybShkcmFjby5QT1NJVElPTik7CiAgICAgIGRyYWNvRGVjb2Rlci5Ta2lwQXR0cmlidXRlVHJhbnNmb3JtKGRyYWNvLk5PUk1BTCk7CiAgICB9CiAgICBjb25zdCBidWZmZXIgPSBuZXcgZHJhY28uRGVjb2RlckJ1ZmZlcigpOwogICAgYnVmZmVyLkluaXQocGFyYW1ldGVycy5idWZmZXIsIHBhcmFtZXRlcnMuYnVmZmVyLmxlbmd0aCk7CiAgICBjb25zdCBnZW9tZXRyeVR5cGUgPSBkcmFjb0RlY29kZXIuR2V0RW5jb2RlZEdlb21ldHJ5VHlwZShidWZmZXIpOwogICAgaWYgKGdlb21ldHJ5VHlwZSAhPT0gZHJhY28uUE9JTlRfQ0xPVUQpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJEcmFjbyBnZW9tZXRyeSB0eXBlIG11c3QgYmUgUE9JTlRfQ0xPVUQuIik7CiAgICB9CiAgICBjb25zdCBkcmFjb1BvaW50Q2xvdWQgPSBuZXcgZHJhY28uUG9pbnRDbG91ZCgpOwogICAgY29uc3QgZGVjb2RpbmdTdGF0dXMgPSBkcmFjb0RlY29kZXIuRGVjb2RlQnVmZmVyVG9Qb2ludENsb3VkKAogICAgICBidWZmZXIsCiAgICAgIGRyYWNvUG9pbnRDbG91ZAogICAgKTsKICAgIGlmICghZGVjb2RpbmdTdGF0dXMub2soKSB8fCBkcmFjb1BvaW50Q2xvdWQucHRyID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICBgRXJyb3IgZGVjb2RpbmcgZHJhY28gcG9pbnQgY2xvdWQ6ICR7ZGVjb2RpbmdTdGF0dXMuZXJyb3JfbXNnKCl9YAogICAgICApOwogICAgfQogICAgZHJhY28uZGVzdHJveShidWZmZXIpOwogICAgY29uc3QgcmVzdWx0ID0ge307CiAgICBjb25zdCBwcm9wZXJ0aWVzID0gcGFyYW1ldGVycy5wcm9wZXJ0aWVzOwogICAgZm9yIChjb25zdCBwcm9wZXJ0eU5hbWUgaW4gcHJvcGVydGllcykgewogICAgICBpZiAocHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eU5hbWUpKSB7CiAgICAgICAgbGV0IGRyYWNvQXR0cmlidXRlOwogICAgICAgIGlmIChwcm9wZXJ0eU5hbWUgPT09ICJQT1NJVElPTiIgfHwgcHJvcGVydHlOYW1lID09PSAiTk9STUFMIikgewogICAgICAgICAgY29uc3QgZHJhY29BdHRyaWJ1dGVJZCA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVJZCgKICAgICAgICAgICAgZHJhY29Qb2ludENsb3VkLAogICAgICAgICAgICBkcmFjb1twcm9wZXJ0eU5hbWVdCiAgICAgICAgICApOwogICAgICAgICAgZHJhY29BdHRyaWJ1dGUgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlKAogICAgICAgICAgICBkcmFjb1BvaW50Q2xvdWQsCiAgICAgICAgICAgIGRyYWNvQXR0cmlidXRlSWQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZUlkID0gcHJvcGVydGllc1twcm9wZXJ0eU5hbWVdOwogICAgICAgICAgZHJhY29BdHRyaWJ1dGUgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlQnlVbmlxdWVJZCgKICAgICAgICAgICAgZHJhY29Qb2ludENsb3VkLAogICAgICAgICAgICBhdHRyaWJ1dGVJZAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0W3Byb3BlcnR5TmFtZV0gPSBkZWNvZGVBdHRyaWJ1dGUoCiAgICAgICAgICBkcmFjb1BvaW50Q2xvdWQsCiAgICAgICAgICBkcmFjb0RlY29kZXIsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGRyYWNvLmRlc3Ryb3koZHJhY29Qb2ludENsb3VkKTsKICAgIGRyYWNvLmRlc3Ryb3koZHJhY29EZWNvZGVyKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGRlY29kZVByaW1pdGl2ZShwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBkcmFjb0RlY29kZXIgPSBuZXcgZHJhY28uRGVjb2RlcigpOwogICAgaWYgKHBhcmFtZXRlcnMuZGVxdWFudGl6ZUluU2hhZGVyKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyYW1ldGVycy5hdHRyaWJ1dGVzVG9Ta2lwVHJhbnNmb3JtLmxlbmd0aDsgKytpKSB7CiAgICAgICAgZHJhY29EZWNvZGVyLlNraXBBdHRyaWJ1dGVUcmFuc2Zvcm0oCiAgICAgICAgICBkcmFjb1twYXJhbWV0ZXJzLmF0dHJpYnV0ZXNUb1NraXBUcmFuc2Zvcm1baV1dCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgY29uc3QgYnVmZmVyVmlldyA9IHBhcmFtZXRlcnMuYnVmZmVyVmlldzsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBkcmFjby5EZWNvZGVyQnVmZmVyKCk7CiAgICBidWZmZXIuSW5pdChwYXJhbWV0ZXJzLmFycmF5LCBidWZmZXJWaWV3LmJ5dGVMZW5ndGgpOwogICAgY29uc3QgZ2VvbWV0cnlUeXBlID0gZHJhY29EZWNvZGVyLkdldEVuY29kZWRHZW9tZXRyeVR5cGUoYnVmZmVyKTsKICAgIGlmIChnZW9tZXRyeVR5cGUgIT09IGRyYWNvLlRSSUFOR1VMQVJfTUVTSCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIlVuc3VwcG9ydGVkIGRyYWNvIG1lc2ggZ2VvbWV0cnkgdHlwZS4iKTsKICAgIH0KICAgIGNvbnN0IGRyYWNvR2VvbWV0cnkgPSBuZXcgZHJhY28uTWVzaCgpOwogICAgY29uc3QgZGVjb2RpbmdTdGF0dXMgPSBkcmFjb0RlY29kZXIuRGVjb2RlQnVmZmVyVG9NZXNoKGJ1ZmZlciwgZHJhY29HZW9tZXRyeSk7CiAgICBpZiAoIWRlY29kaW5nU3RhdHVzLm9rKCkgfHwgZHJhY29HZW9tZXRyeS5wdHIgPT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgIGBFcnJvciBkZWNvZGluZyBkcmFjbyBtZXNoIGdlb21ldHJ5OiAke2RlY29kaW5nU3RhdHVzLmVycm9yX21zZygpfWAKICAgICAgKTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3koYnVmZmVyKTsKICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEgPSB7fTsKICAgIGNvbnN0IGNvbXByZXNzZWRBdHRyaWJ1dGVzID0gcGFyYW1ldGVycy5jb21wcmVzc2VkQXR0cmlidXRlczsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlTmFtZSBpbiBjb21wcmVzc2VkQXR0cmlidXRlcykgewogICAgICBpZiAoY29tcHJlc3NlZEF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICBjb25zdCBjb21wcmVzc2VkQXR0cmlidXRlID0gY29tcHJlc3NlZEF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV07CiAgICAgICAgY29uc3QgZHJhY29BdHRyaWJ1dGUgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlQnlVbmlxdWVJZCgKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBjb21wcmVzc2VkQXR0cmlidXRlCiAgICAgICAgKTsKICAgICAgICBhdHRyaWJ1dGVEYXRhW2F0dHJpYnV0ZU5hbWVdID0gZGVjb2RlQXR0cmlidXRlKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvRGVjb2RlciwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgY29uc3QgcmVzdWx0ID0gewogICAgICBpbmRleEFycmF5OiBkZWNvZGVJbmRleEFycmF5KGRyYWNvR2VvbWV0cnksIGRyYWNvRGVjb2RlciksCiAgICAgIGF0dHJpYnV0ZURhdGEKICAgIH07CiAgICBkcmFjby5kZXN0cm95KGRyYWNvR2VvbWV0cnkpOwogICAgZHJhY28uZGVzdHJveShkcmFjb0RlY29kZXIpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgYXN5bmMgZnVuY3Rpb24gZGVjb2RlKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5idWZmZXJWaWV3KSkgewogICAgICByZXR1cm4gZGVjb2RlUHJpbWl0aXZlKHBhcmFtZXRlcnMpOwogICAgfQogICAgcmV0dXJuIGRlY29kZVBvaW50Q2xvdWQocGFyYW1ldGVycyk7CiAgfQogIGFzeW5jIGZ1bmN0aW9uIGluaXRXb3JrZXIocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgd2FzbUNvbmZpZyA9IHBhcmFtZXRlcnMud2ViQXNzZW1ibHlDb25maWc7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcpICYmIGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnLndhc21CaW5hcnlGaWxlKSkgewogICAgICBkcmFjbyA9IGF3YWl0ICgwLCBpbXBvcnRfZHJhY29fZGVjb2Rlcl9ub2RlanMuZGVmYXVsdCkod2FzbUNvbmZpZyk7CiAgICB9IGVsc2UgewogICAgICBkcmFjbyA9IGF3YWl0ICgwLCBpbXBvcnRfZHJhY29fZGVjb2Rlcl9ub2RlanMuZGVmYXVsdCkoKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICBhc3luYyBmdW5jdGlvbiBkZWNvZGVEcmFjbyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCB3YXNtQ29uZmlnID0gcGFyYW1ldGVycy53ZWJBc3NlbWJseUNvbmZpZzsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQod2FzbUNvbmZpZykpIHsKICAgICAgcmV0dXJuIGluaXRXb3JrZXIocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgICB9CiAgICByZXR1cm4gZGVjb2RlKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogIH0KICB2YXIgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzLCBkcmFjbywgZGVjb2RlRHJhY29fZGVmYXVsdDsKICB2YXIgaW5pdF9kZWNvZGVEcmFjbyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlRHJhY28uanMiKCkgewogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9SdW50aW1lRXJyb3IoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqcyA9IF9fdG9FU00ocmVxdWlyZV9kcmFjb19kZWNvZGVyX25vZGVqcygpLCAxKTsKICAgICAgZGVjb2RlRHJhY29fZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChkZWNvZGVEcmFjbyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhLmpzCiAgZnVuY3Rpb24gZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YShrZXksIGRhdGEpIHsKICAgIGlmIChkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhLnBhc3NUaHJvdWdoRGF0YUZvclRlc3RpbmcpIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImtleSIsIGtleSk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRhdGEiLCBkYXRhKTsKICAgIGNvbnN0IGtleUxlbmd0aCA9IGtleS5ieXRlTGVuZ3RoOwogICAgaWYgKGtleUxlbmd0aCA9PT0gMCB8fCBrZXlMZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAiVGhlIGxlbmd0aCBvZiBrZXkgbXVzdCBiZSBncmVhdGVyIHRoYW4gMCBhbmQgYSBtdWx0aXBsZSBvZiA0LiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGRhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGRhdGEpOwogICAgY29uc3QgbWFnaWMgPSBkYXRhVmlldy5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICBpZiAobWFnaWMgPT09IGNvbXByZXNzZWRNYWdpYyB8fCBtYWdpYyA9PT0gY29tcHJlc3NlZE1hZ2ljU3dhcCkgewogICAgICByZXR1cm4gZGF0YTsKICAgIH0KICAgIGNvbnN0IGtleVZpZXcgPSBuZXcgRGF0YVZpZXcoa2V5KTsKICAgIGxldCBkcCA9IDA7CiAgICBjb25zdCBkcGVuZCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgIGNvbnN0IGRwZW5kNjQgPSBkcGVuZCAtIGRwZW5kICUgODsKICAgIGNvbnN0IGtwZW5kID0ga2V5TGVuZ3RoOwogICAgbGV0IGtwOwogICAgbGV0IG9mZiA9IDg7CiAgICB3aGlsZSAoZHAgPCBkcGVuZDY0KSB7CiAgICAgIG9mZiA9IChvZmYgKyA4KSAlIDI0OwogICAgICBrcCA9IG9mZjsKICAgICAgd2hpbGUgKGRwIDwgZHBlbmQ2NCAmJiBrcCA8IGtwZW5kKSB7CiAgICAgICAgZGF0YVZpZXcuc2V0VWludDMyKAogICAgICAgICAgZHAsCiAgICAgICAgICBkYXRhVmlldy5nZXRVaW50MzIoZHAsIHRydWUpIF4ga2V5Vmlldy5nZXRVaW50MzIoa3AsIHRydWUpLAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgZGF0YVZpZXcuc2V0VWludDMyKAogICAgICAgICAgZHAgKyA0LAogICAgICAgICAgZGF0YVZpZXcuZ2V0VWludDMyKGRwICsgNCwgdHJ1ZSkgXiBrZXlWaWV3LmdldFVpbnQzMihrcCArIDQsIHRydWUpLAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgZHAgKz0gODsKICAgICAgICBrcCArPSAyNDsKICAgICAgfQogICAgfQogICAgaWYgKGRwIDwgZHBlbmQpIHsKICAgICAgaWYgKGtwID49IGtwZW5kKSB7CiAgICAgICAgb2ZmID0gKG9mZiArIDgpICUgMjQ7CiAgICAgICAga3AgPSBvZmY7CiAgICAgIH0KICAgICAgd2hpbGUgKGRwIDwgZHBlbmQpIHsKICAgICAgICBkYXRhVmlldy5zZXRVaW50OChkcCwgZGF0YVZpZXcuZ2V0VWludDgoZHApIF4ga2V5Vmlldy5nZXRVaW50OChrcCkpOwogICAgICAgIGRwKys7CiAgICAgICAga3ArKzsKICAgICAgfQogICAgfQogIH0KICB2YXIgY29tcHJlc3NlZE1hZ2ljLCBjb21wcmVzc2VkTWFnaWNTd2FwLCBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YS5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9SdW50aW1lRXJyb3IoKTsKICAgICAgY29tcHJlc3NlZE1hZ2ljID0gMTk1MzAyOTgwNTsKICAgICAgY29tcHJlc3NlZE1hZ2ljU3dhcCA9IDI5MTcwMzQxMDA7CiAgICAgIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEucGFzc1Rocm91Z2hEYXRhRm9yVGVzdGluZyA9IGZhbHNlOwogICAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhX2RlZmF1bHQgPSBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvaXNCaXRTZXQuanMKICBmdW5jdGlvbiBpc0JpdFNldChiaXRzLCBtYXNrKSB7CiAgICByZXR1cm4gKGJpdHMgJiBtYXNrKSAhPT0gMDsKICB9CiAgdmFyIGlzQml0U2V0X2RlZmF1bHQ7CiAgdmFyIGluaXRfaXNCaXRTZXQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQml0U2V0LmpzIigpIHsKICAgICAgaXNCaXRTZXRfZGVmYXVsdCA9IGlzQml0U2V0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLmpzCiAgZnVuY3Rpb24gR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uKGJpdHMsIGNub2RlVmVyc2lvbiwgaW1hZ2VyeVZlcnNpb24sIHRlcnJhaW5WZXJzaW9uLCBpbWFnZXJ5UHJvdmlkZXIsIHRlcnJhaW5Qcm92aWRlcikgewogICAgdGhpcy5fYml0cyA9IGJpdHM7CiAgICB0aGlzLmNub2RlVmVyc2lvbiA9IGNub2RlVmVyc2lvbjsKICAgIHRoaXMuaW1hZ2VyeVZlcnNpb24gPSBpbWFnZXJ5VmVyc2lvbjsKICAgIHRoaXMudGVycmFpblZlcnNpb24gPSB0ZXJyYWluVmVyc2lvbjsKICAgIHRoaXMuaW1hZ2VyeVByb3ZpZGVyID0gaW1hZ2VyeVByb3ZpZGVyOwogICAgdGhpcy50ZXJyYWluUHJvdmlkZXIgPSB0ZXJyYWluUHJvdmlkZXI7CiAgICB0aGlzLmFuY2VzdG9ySGFzVGVycmFpbiA9IGZhbHNlOwogICAgdGhpcy50ZXJyYWluU3RhdGUgPSB2b2lkIDA7CiAgfQogIHZhciBjaGlsZHJlbkJpdG1hc2tzLCBhbnlDaGlsZEJpdG1hc2ssIGNhY2hlRmxhZ0JpdG1hc2ssIGltYWdlQml0bWFzaywgdGVycmFpbkJpdG1hc2ssIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfaXNCaXRTZXQoKTsKICAgICAgY2hpbGRyZW5CaXRtYXNrcyA9IFsxLCAyLCA0LCA4XTsKICAgICAgYW55Q2hpbGRCaXRtYXNrID0gMTU7CiAgICAgIGNhY2hlRmxhZ0JpdG1hc2sgPSAxNjsKICAgICAgaW1hZ2VCaXRtYXNrID0gNjQ7CiAgICAgIHRlcnJhaW5CaXRtYXNrID0gMTI4OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24uY2xvbmUgPSBmdW5jdGlvbihpbmZvLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uKAogICAgICAgICAgICBpbmZvLl9iaXRzLAogICAgICAgICAgICBpbmZvLmNub2RlVmVyc2lvbiwKICAgICAgICAgICAgaW5mby5pbWFnZXJ5VmVyc2lvbiwKICAgICAgICAgICAgaW5mby50ZXJyYWluVmVyc2lvbiwKICAgICAgICAgICAgaW5mby5pbWFnZXJ5UHJvdmlkZXIsCiAgICAgICAgICAgIGluZm8udGVycmFpblByb3ZpZGVyCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQuX2JpdHMgPSBpbmZvLl9iaXRzOwogICAgICAgICAgcmVzdWx0LmNub2RlVmVyc2lvbiA9IGluZm8uY25vZGVWZXJzaW9uOwogICAgICAgICAgcmVzdWx0LmltYWdlcnlWZXJzaW9uID0gaW5mby5pbWFnZXJ5VmVyc2lvbjsKICAgICAgICAgIHJlc3VsdC50ZXJyYWluVmVyc2lvbiA9IGluZm8udGVycmFpblZlcnNpb247CiAgICAgICAgICByZXN1bHQuaW1hZ2VyeVByb3ZpZGVyID0gaW5mby5pbWFnZXJ5UHJvdmlkZXI7CiAgICAgICAgICByZXN1bHQudGVycmFpblByb3ZpZGVyID0gaW5mby50ZXJyYWluUHJvdmlkZXI7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5hbmNlc3Rvckhhc1RlcnJhaW4gPSBpbmZvLmFuY2VzdG9ySGFzVGVycmFpbjsKICAgICAgICByZXN1bHQudGVycmFpblN0YXRlID0gaW5mby50ZXJyYWluU3RhdGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5zZXRQYXJlbnQgPSBmdW5jdGlvbihwYXJlbnQpIHsKICAgICAgICB0aGlzLmFuY2VzdG9ySGFzVGVycmFpbiA9IHBhcmVudC5hbmNlc3Rvckhhc1RlcnJhaW4gfHwgdGhpcy5oYXNUZXJyYWluKCk7CiAgICAgIH07CiAgICAgIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5wcm90b3R5cGUuaGFzU3VidHJlZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBpc0JpdFNldF9kZWZhdWx0KHRoaXMuX2JpdHMsIGNhY2hlRmxhZ0JpdG1hc2spOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmhhc0ltYWdlcnkgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaXNCaXRTZXRfZGVmYXVsdCh0aGlzLl9iaXRzLCBpbWFnZUJpdG1hc2spOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmhhc1RlcnJhaW4gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaXNCaXRTZXRfZGVmYXVsdCh0aGlzLl9iaXRzLCB0ZXJyYWluQml0bWFzayk7CiAgICAgIH07CiAgICAgIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5wcm90b3R5cGUuaGFzQ2hpbGRyZW4gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaXNCaXRTZXRfZGVmYXVsdCh0aGlzLl9iaXRzLCBhbnlDaGlsZEJpdG1hc2spOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmhhc0NoaWxkID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICByZXR1cm4gaXNCaXRTZXRfZGVmYXVsdCh0aGlzLl9iaXRzLCBjaGlsZHJlbkJpdG1hc2tzW2luZGV4XSk7CiAgICAgIH07CiAgICAgIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5wcm90b3R5cGUuZ2V0Q2hpbGRCaXRtYXNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2JpdHMgJiBhbnlDaGlsZEJpdG1hc2s7CiAgICAgIH07CiAgICAgIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbl9kZWZhdWx0ID0gR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9hZGxlcjMyLmpzCiAgdmFyIHJlcXVpcmVfYWRsZXIzMiA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2FkbGVyMzIuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgYWRsZXIzMiA9IChhZGxlciwgYnVmLCBsZW4sIHBvcykgPT4gewogICAgICAgIGxldCBzMSA9IGFkbGVyICYgNjU1MzUgfCAwLCBzMiA9IGFkbGVyID4+PiAxNiAmIDY1NTM1IHwgMCwgbiA9IDA7CiAgICAgICAgd2hpbGUgKGxlbiAhPT0gMCkgewogICAgICAgICAgbiA9IGxlbiA+IDJlMyA/IDJlMyA6IGxlbjsKICAgICAgICAgIGxlbiAtPSBuOwogICAgICAgICAgZG8gewogICAgICAgICAgICBzMSA9IHMxICsgYnVmW3BvcysrXSB8IDA7CiAgICAgICAgICAgIHMyID0gczIgKyBzMSB8IDA7CiAgICAgICAgICB9IHdoaWxlICgtLW4pOwogICAgICAgICAgczEgJT0gNjU1MjE7CiAgICAgICAgICBzMiAlPSA2NTUyMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHMxIHwgczIgPDwgMTYgfCAwOwogICAgICB9OwogICAgICBtb2R1bGUuZXhwb3J0cyA9IGFkbGVyMzI7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2NyYzMyLmpzCiAgdmFyIHJlcXVpcmVfY3JjMzIgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jcmMzMi5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBtYWtlVGFibGUgPSAoKSA9PiB7CiAgICAgICAgbGV0IGMsIHRhYmxlID0gW107CiAgICAgICAgZm9yICh2YXIgbiA9IDA7IG4gPCAyNTY7IG4rKykgewogICAgICAgICAgYyA9IG47CiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IDg7IGsrKykgewogICAgICAgICAgICBjID0gYyAmIDEgPyAzOTg4MjkyMzg0IF4gYyA+Pj4gMSA6IGMgPj4+IDE7CiAgICAgICAgICB9CiAgICAgICAgICB0YWJsZVtuXSA9IGM7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0YWJsZTsKICAgICAgfTsKICAgICAgdmFyIGNyY1RhYmxlID0gbmV3IFVpbnQzMkFycmF5KG1ha2VUYWJsZSgpKTsKICAgICAgdmFyIGNyYzMyID0gKGNyYywgYnVmLCBsZW4sIHBvcykgPT4gewogICAgICAgIGNvbnN0IHQgPSBjcmNUYWJsZTsKICAgICAgICBjb25zdCBlbmQgPSBwb3MgKyBsZW47CiAgICAgICAgY3JjIF49IC0xOwogICAgICAgIGZvciAobGV0IGkgPSBwb3M7IGkgPCBlbmQ7IGkrKykgewogICAgICAgICAgY3JjID0gY3JjID4+PiA4IF4gdFsoY3JjIF4gYnVmW2ldKSAmIDI1NV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBjcmMgXiAtMTsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBjcmMzMjsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mZmFzdC5qcwogIHZhciByZXF1aXJlX2luZmZhc3QgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9pbmZmYXN0LmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIEJBRCA9IDE2MjA5OwogICAgICB2YXIgVFlQRSA9IDE2MTkxOwogICAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluZmxhdGVfZmFzdChzdHJtLCBzdGFydCkgewogICAgICAgIGxldCBfaW47CiAgICAgICAgbGV0IGxhc3Q7CiAgICAgICAgbGV0IF9vdXQ7CiAgICAgICAgbGV0IGJlZzsKICAgICAgICBsZXQgZW5kOwogICAgICAgIGxldCBkbWF4OwogICAgICAgIGxldCB3c2l6ZTsKICAgICAgICBsZXQgd2hhdmU7CiAgICAgICAgbGV0IHduZXh0OwogICAgICAgIGxldCBzX3dpbmRvdzsKICAgICAgICBsZXQgaG9sZDsKICAgICAgICBsZXQgYml0czsKICAgICAgICBsZXQgbGNvZGU7CiAgICAgICAgbGV0IGRjb2RlOwogICAgICAgIGxldCBsbWFzazsKICAgICAgICBsZXQgZG1hc2s7CiAgICAgICAgbGV0IGhlcmU7CiAgICAgICAgbGV0IG9wOwogICAgICAgIGxldCBsZW47CiAgICAgICAgbGV0IGRpc3Q7CiAgICAgICAgbGV0IGZyb207CiAgICAgICAgbGV0IGZyb21fc291cmNlOwogICAgICAgIGxldCBpbnB1dCwgb3V0cHV0OwogICAgICAgIGNvbnN0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBfaW4gPSBzdHJtLm5leHRfaW47CiAgICAgICAgaW5wdXQgPSBzdHJtLmlucHV0OwogICAgICAgIGxhc3QgPSBfaW4gKyAoc3RybS5hdmFpbF9pbiAtIDUpOwogICAgICAgIF9vdXQgPSBzdHJtLm5leHRfb3V0OwogICAgICAgIG91dHB1dCA9IHN0cm0ub3V0cHV0OwogICAgICAgIGJlZyA9IF9vdXQgLSAoc3RhcnQgLSBzdHJtLmF2YWlsX291dCk7CiAgICAgICAgZW5kID0gX291dCArIChzdHJtLmF2YWlsX291dCAtIDI1Nyk7CiAgICAgICAgZG1heCA9IHN0YXRlLmRtYXg7CiAgICAgICAgd3NpemUgPSBzdGF0ZS53c2l6ZTsKICAgICAgICB3aGF2ZSA9IHN0YXRlLndoYXZlOwogICAgICAgIHduZXh0ID0gc3RhdGUud25leHQ7CiAgICAgICAgc193aW5kb3cgPSBzdGF0ZS53aW5kb3c7CiAgICAgICAgaG9sZCA9IHN0YXRlLmhvbGQ7CiAgICAgICAgYml0cyA9IHN0YXRlLmJpdHM7CiAgICAgICAgbGNvZGUgPSBzdGF0ZS5sZW5jb2RlOwogICAgICAgIGRjb2RlID0gc3RhdGUuZGlzdGNvZGU7CiAgICAgICAgbG1hc2sgPSAoMSA8PCBzdGF0ZS5sZW5iaXRzKSAtIDE7CiAgICAgICAgZG1hc2sgPSAoMSA8PCBzdGF0ZS5kaXN0Yml0cykgLSAxOwogICAgICAgIHRvcDoKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgaWYgKGJpdHMgPCAxNSkgewogICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbX2luKytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbX2luKytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhlcmUgPSBsY29kZVtob2xkICYgbG1hc2tdOwogICAgICAgICAgICBkb2xlbjoKICAgICAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgICAgIG9wID0gaGVyZSA+Pj4gMjQ7CiAgICAgICAgICAgICAgICBob2xkID4+Pj0gb3A7CiAgICAgICAgICAgICAgICBiaXRzIC09IG9wOwogICAgICAgICAgICAgICAgb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgIGlmIChvcCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3AgJiAxNikgewogICAgICAgICAgICAgICAgICBsZW4gPSBoZXJlICYgNjU1MzU7CiAgICAgICAgICAgICAgICAgIG9wICY9IDE1OwogICAgICAgICAgICAgICAgICBpZiAob3ApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYml0cyA8IG9wKSB7CiAgICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBsZW4gKz0gaG9sZCAmICgxIDw8IG9wKSAtIDE7CiAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IG9wOwogICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gb3A7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGJpdHMgPCAxNSkgewogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbX2luKytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbX2luKytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhlcmUgPSBkY29kZVtob2xkICYgZG1hc2tdOwogICAgICAgICAgICAgICAgICBkb2Rpc3Q6CiAgICAgICAgICAgICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgICAgICAgICAgICBvcCA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IG9wOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSBvcDsKICAgICAgICAgICAgICAgICAgICAgIG9wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgJiAxNikgewogICAgICAgICAgICAgICAgICAgICAgICBkaXN0ID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICAgICAgICBvcCAmPSAxNTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJpdHMgPCBvcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbX2luKytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaXRzIDwgb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbX2luKytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3QgKz0gaG9sZCAmICgxIDw8IG9wKSAtIDE7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gZG1heCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgZGlzdGFuY2UgdG9vIGZhciBiYWNrIjsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIHRvcDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gX291dCAtIGJlZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiBvcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gZGlzdCAtIG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcCA+IHdoYXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuc2FuZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGRpc3RhbmNlIHRvbyBmYXIgYmFjayI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIHRvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBzX3dpbmRvdzsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod25leHQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gKz0gd3NpemUgLSBvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcCA8IGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4gLT0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IHNfd2luZG93W2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKC0tb3ApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gX291dCAtIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21fc291cmNlID0gb3V0cHV0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAod25leHQgPCBvcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSArPSB3c2l6ZSArIHduZXh0IC0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcCAtPSB3bmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcCA8IGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4gLT0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IHNfd2luZG93W2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKC0tb3ApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHduZXh0IDwgbGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSB3bmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4gLT0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBzX3dpbmRvd1tmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKC0tb3ApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gPSBfb3V0IC0gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tX3NvdXJjZSA9IG91dHB1dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tICs9IHduZXh0IC0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPCBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBzX3dpbmRvd1tmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSA9IF9vdXQgLSBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tX3NvdXJjZSA9IG91dHB1dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxlbiA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gZnJvbV9zb3VyY2VbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gZnJvbV9zb3VyY2VbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gZnJvbV9zb3VyY2VbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbiAtPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGVuID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gPSBfb3V0IC0gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IG91dHB1dFtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBvdXRwdXRbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gb3V0cHV0W2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4gLT0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChsZW4gPiAyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IG91dHB1dFtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbiA+IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBvdXRwdXRbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKG9wICYgNjQpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhlcmUgPSBkY29kZVsoaGVyZSAmIDY1NTM1KSArIChob2xkICYgKDEgPDwgb3ApIC0gMSldOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBkb2Rpc3Q7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGRpc3RhbmNlIGNvZGUiOwogICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChvcCAmIDY0KSA9PT0gMCkgewogICAgICAgICAgICAgICAgICBoZXJlID0gbGNvZGVbKGhlcmUgJiA2NTUzNSkgKyAoaG9sZCAmICgxIDw8IG9wKSAtIDEpXTsKICAgICAgICAgICAgICAgICAgY29udGludWUgZG9sZW47CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wICYgMzIpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRZUEU7CiAgICAgICAgICAgICAgICAgIGJyZWFrIHRvcDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgbGl0ZXJhbC9sZW5ndGggY29kZSI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrIHRvcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gd2hpbGUgKF9pbiA8IGxhc3QgJiYgX291dCA8IGVuZCk7CiAgICAgICAgbGVuID0gYml0cyA+PiAzOwogICAgICAgIF9pbiAtPSBsZW47CiAgICAgICAgYml0cyAtPSBsZW4gPDwgMzsKICAgICAgICBob2xkICY9ICgxIDw8IGJpdHMpIC0gMTsKICAgICAgICBzdHJtLm5leHRfaW4gPSBfaW47CiAgICAgICAgc3RybS5uZXh0X291dCA9IF9vdXQ7CiAgICAgICAgc3RybS5hdmFpbF9pbiA9IF9pbiA8IGxhc3QgPyA1ICsgKGxhc3QgLSBfaW4pIDogNSAtIChfaW4gLSBsYXN0KTsKICAgICAgICBzdHJtLmF2YWlsX291dCA9IF9vdXQgPCBlbmQgPyAyNTcgKyAoZW5kIC0gX291dCkgOiAyNTcgLSAoX291dCAtIGVuZCk7CiAgICAgICAgc3RhdGUuaG9sZCA9IGhvbGQ7CiAgICAgICAgc3RhdGUuYml0cyA9IGJpdHM7CiAgICAgICAgcmV0dXJuOwogICAgICB9OwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9pbmZ0cmVlcy5qcwogIHZhciByZXF1aXJlX2luZnRyZWVzID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mdHJlZXMuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgTUFYQklUUyA9IDE1OwogICAgICB2YXIgRU5PVUdIX0xFTlMgPSA4NTI7CiAgICAgIHZhciBFTk9VR0hfRElTVFMgPSA1OTI7CiAgICAgIHZhciBDT0RFUyA9IDA7CiAgICAgIHZhciBMRU5TID0gMTsKICAgICAgdmFyIERJU1RTID0gMjsKICAgICAgdmFyIGxiYXNlID0gbmV3IFVpbnQxNkFycmF5KFsKICAgICAgICAvKiBMZW5ndGggY29kZXMgMjU3Li4yODUgYmFzZSAqLwogICAgICAgIDMsCiAgICAgICAgNCwKICAgICAgICA1LAogICAgICAgIDYsCiAgICAgICAgNywKICAgICAgICA4LAogICAgICAgIDksCiAgICAgICAgMTAsCiAgICAgICAgMTEsCiAgICAgICAgMTMsCiAgICAgICAgMTUsCiAgICAgICAgMTcsCiAgICAgICAgMTksCiAgICAgICAgMjMsCiAgICAgICAgMjcsCiAgICAgICAgMzEsCiAgICAgICAgMzUsCiAgICAgICAgNDMsCiAgICAgICAgNTEsCiAgICAgICAgNTksCiAgICAgICAgNjcsCiAgICAgICAgODMsCiAgICAgICAgOTksCiAgICAgICAgMTE1LAogICAgICAgIDEzMSwKICAgICAgICAxNjMsCiAgICAgICAgMTk1LAogICAgICAgIDIyNywKICAgICAgICAyNTgsCiAgICAgICAgMCwKICAgICAgICAwCiAgICAgIF0pOwogICAgICB2YXIgbGV4dCA9IG5ldyBVaW50OEFycmF5KFsKICAgICAgICAvKiBMZW5ndGggY29kZXMgMjU3Li4yODUgZXh0cmEgKi8KICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNywKICAgICAgICAxNywKICAgICAgICAxNywKICAgICAgICAxNywKICAgICAgICAxOCwKICAgICAgICAxOCwKICAgICAgICAxOCwKICAgICAgICAxOCwKICAgICAgICAxOSwKICAgICAgICAxOSwKICAgICAgICAxOSwKICAgICAgICAxOSwKICAgICAgICAyMCwKICAgICAgICAyMCwKICAgICAgICAyMCwKICAgICAgICAyMCwKICAgICAgICAyMSwKICAgICAgICAyMSwKICAgICAgICAyMSwKICAgICAgICAyMSwKICAgICAgICAxNiwKICAgICAgICA3MiwKICAgICAgICA3OAogICAgICBdKTsKICAgICAgdmFyIGRiYXNlID0gbmV3IFVpbnQxNkFycmF5KFsKICAgICAgICAvKiBEaXN0YW5jZSBjb2RlcyAwLi4yOSBiYXNlICovCiAgICAgICAgMSwKICAgICAgICAyLAogICAgICAgIDMsCiAgICAgICAgNCwKICAgICAgICA1LAogICAgICAgIDcsCiAgICAgICAgOSwKICAgICAgICAxMywKICAgICAgICAxNywKICAgICAgICAyNSwKICAgICAgICAzMywKICAgICAgICA0OSwKICAgICAgICA2NSwKICAgICAgICA5NywKICAgICAgICAxMjksCiAgICAgICAgMTkzLAogICAgICAgIDI1NywKICAgICAgICAzODUsCiAgICAgICAgNTEzLAogICAgICAgIDc2OSwKICAgICAgICAxMDI1LAogICAgICAgIDE1MzcsCiAgICAgICAgMjA0OSwKICAgICAgICAzMDczLAogICAgICAgIDQwOTcsCiAgICAgICAgNjE0NSwKICAgICAgICA4MTkzLAogICAgICAgIDEyMjg5LAogICAgICAgIDE2Mzg1LAogICAgICAgIDI0NTc3LAogICAgICAgIDAsCiAgICAgICAgMAogICAgICBdKTsKICAgICAgdmFyIGRleHQgPSBuZXcgVWludDhBcnJheShbCiAgICAgICAgLyogRGlzdGFuY2UgY29kZXMgMC4uMjkgZXh0cmEgKi8KICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNiwKICAgICAgICAxNywKICAgICAgICAxNywKICAgICAgICAxOCwKICAgICAgICAxOCwKICAgICAgICAxOSwKICAgICAgICAxOSwKICAgICAgICAyMCwKICAgICAgICAyMCwKICAgICAgICAyMSwKICAgICAgICAyMSwKICAgICAgICAyMiwKICAgICAgICAyMiwKICAgICAgICAyMywKICAgICAgICAyMywKICAgICAgICAyNCwKICAgICAgICAyNCwKICAgICAgICAyNSwKICAgICAgICAyNSwKICAgICAgICAyNiwKICAgICAgICAyNiwKICAgICAgICAyNywKICAgICAgICAyNywKICAgICAgICAyOCwKICAgICAgICAyOCwKICAgICAgICAyOSwKICAgICAgICAyOSwKICAgICAgICA2NCwKICAgICAgICA2NAogICAgICBdKTsKICAgICAgdmFyIGluZmxhdGVfdGFibGUgPSAodHlwZSwgbGVucywgbGVuc19pbmRleCwgY29kZXMsIHRhYmxlLCB0YWJsZV9pbmRleCwgd29yaywgb3B0cykgPT4gewogICAgICAgIGNvbnN0IGJpdHMgPSBvcHRzLmJpdHM7CiAgICAgICAgbGV0IGxlbiA9IDA7CiAgICAgICAgbGV0IHN5bSA9IDA7CiAgICAgICAgbGV0IG1pbjMgPSAwLCBtYXgzID0gMDsKICAgICAgICBsZXQgcm9vdCA9IDA7CiAgICAgICAgbGV0IGN1cnIgPSAwOwogICAgICAgIGxldCBkcm9wID0gMDsKICAgICAgICBsZXQgbGVmdCA9IDA7CiAgICAgICAgbGV0IHVzZWQgPSAwOwogICAgICAgIGxldCBodWZmID0gMDsKICAgICAgICBsZXQgaW5jcjsKICAgICAgICBsZXQgZmlsbDsKICAgICAgICBsZXQgbG93OwogICAgICAgIGxldCBtYXNrOwogICAgICAgIGxldCBuZXh0OwogICAgICAgIGxldCBiYXNlID0gbnVsbDsKICAgICAgICBsZXQgbWF0Y2g7CiAgICAgICAgY29uc3QgY291bnQgPSBuZXcgVWludDE2QXJyYXkoTUFYQklUUyArIDEpOwogICAgICAgIGNvbnN0IG9mZnMgPSBuZXcgVWludDE2QXJyYXkoTUFYQklUUyArIDEpOwogICAgICAgIGxldCBleHRyYSA9IG51bGw7CiAgICAgICAgbGV0IGhlcmVfYml0cywgaGVyZV9vcCwgaGVyZV92YWw7CiAgICAgICAgZm9yIChsZW4gPSAwOyBsZW4gPD0gTUFYQklUUzsgbGVuKyspIHsKICAgICAgICAgIGNvdW50W2xlbl0gPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKHN5bSA9IDA7IHN5bSA8IGNvZGVzOyBzeW0rKykgewogICAgICAgICAgY291bnRbbGVuc1tsZW5zX2luZGV4ICsgc3ltXV0rKzsKICAgICAgICB9CiAgICAgICAgcm9vdCA9IGJpdHM7CiAgICAgICAgZm9yIChtYXgzID0gTUFYQklUUzsgbWF4MyA+PSAxOyBtYXgzLS0pIHsKICAgICAgICAgIGlmIChjb3VudFttYXgzXSAhPT0gMCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJvb3QgPiBtYXgzKSB7CiAgICAgICAgICByb290ID0gbWF4MzsKICAgICAgICB9CiAgICAgICAgaWYgKG1heDMgPT09IDApIHsKICAgICAgICAgIHRhYmxlW3RhYmxlX2luZGV4KytdID0gMSA8PCAyNCB8IDY0IDw8IDE2IHwgMDsKICAgICAgICAgIHRhYmxlW3RhYmxlX2luZGV4KytdID0gMSA8PCAyNCB8IDY0IDw8IDE2IHwgMDsKICAgICAgICAgIG9wdHMuYml0cyA9IDE7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChtaW4zID0gMTsgbWluMyA8IG1heDM7IG1pbjMrKykgewogICAgICAgICAgaWYgKGNvdW50W21pbjNdICE9PSAwKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocm9vdCA8IG1pbjMpIHsKICAgICAgICAgIHJvb3QgPSBtaW4zOwogICAgICAgIH0KICAgICAgICBsZWZ0ID0gMTsKICAgICAgICBmb3IgKGxlbiA9IDE7IGxlbiA8PSBNQVhCSVRTOyBsZW4rKykgewogICAgICAgICAgbGVmdCA8PD0gMTsKICAgICAgICAgIGxlZnQgLT0gY291bnRbbGVuXTsKICAgICAgICAgIGlmIChsZWZ0IDwgMCkgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChsZWZ0ID4gMCAmJiAodHlwZSA9PT0gQ09ERVMgfHwgbWF4MyAhPT0gMSkpIHsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgb2Zmc1sxXSA9IDA7CiAgICAgICAgZm9yIChsZW4gPSAxOyBsZW4gPCBNQVhCSVRTOyBsZW4rKykgewogICAgICAgICAgb2Zmc1tsZW4gKyAxXSA9IG9mZnNbbGVuXSArIGNvdW50W2xlbl07CiAgICAgICAgfQogICAgICAgIGZvciAoc3ltID0gMDsgc3ltIDwgY29kZXM7IHN5bSsrKSB7CiAgICAgICAgICBpZiAobGVuc1tsZW5zX2luZGV4ICsgc3ltXSAhPT0gMCkgewogICAgICAgICAgICB3b3JrW29mZnNbbGVuc1tsZW5zX2luZGV4ICsgc3ltXV0rK10gPSBzeW07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlID09PSBDT0RFUykgewogICAgICAgICAgYmFzZSA9IGV4dHJhID0gd29yazsKICAgICAgICAgIG1hdGNoID0gMjA7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBMRU5TKSB7CiAgICAgICAgICBiYXNlID0gbGJhc2U7CiAgICAgICAgICBleHRyYSA9IGxleHQ7CiAgICAgICAgICBtYXRjaCA9IDI1NzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzZSA9IGRiYXNlOwogICAgICAgICAgZXh0cmEgPSBkZXh0OwogICAgICAgICAgbWF0Y2ggPSAwOwogICAgICAgIH0KICAgICAgICBodWZmID0gMDsKICAgICAgICBzeW0gPSAwOwogICAgICAgIGxlbiA9IG1pbjM7CiAgICAgICAgbmV4dCA9IHRhYmxlX2luZGV4OwogICAgICAgIGN1cnIgPSByb290OwogICAgICAgIGRyb3AgPSAwOwogICAgICAgIGxvdyA9IC0xOwogICAgICAgIHVzZWQgPSAxIDw8IHJvb3Q7CiAgICAgICAgbWFzayA9IHVzZWQgLSAxOwogICAgICAgIGlmICh0eXBlID09PSBMRU5TICYmIHVzZWQgPiBFTk9VR0hfTEVOUyB8fCB0eXBlID09PSBESVNUUyAmJiB1c2VkID4gRU5PVUdIX0RJU1RTKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICBoZXJlX2JpdHMgPSBsZW4gLSBkcm9wOwogICAgICAgICAgaWYgKHdvcmtbc3ltXSArIDEgPCBtYXRjaCkgewogICAgICAgICAgICBoZXJlX29wID0gMDsKICAgICAgICAgICAgaGVyZV92YWwgPSB3b3JrW3N5bV07CiAgICAgICAgICB9IGVsc2UgaWYgKHdvcmtbc3ltXSA+PSBtYXRjaCkgewogICAgICAgICAgICBoZXJlX29wID0gZXh0cmFbd29ya1tzeW1dIC0gbWF0Y2hdOwogICAgICAgICAgICBoZXJlX3ZhbCA9IGJhc2Vbd29ya1tzeW1dIC0gbWF0Y2hdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGVyZV9vcCA9IDMyICsgNjQ7CiAgICAgICAgICAgIGhlcmVfdmFsID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGluY3IgPSAxIDw8IGxlbiAtIGRyb3A7CiAgICAgICAgICBmaWxsID0gMSA8PCBjdXJyOwogICAgICAgICAgbWluMyA9IGZpbGw7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGZpbGwgLT0gaW5jcjsKICAgICAgICAgICAgdGFibGVbbmV4dCArIChodWZmID4+IGRyb3ApICsgZmlsbF0gPSBoZXJlX2JpdHMgPDwgMjQgfCBoZXJlX29wIDw8IDE2IHwgaGVyZV92YWwgfCAwOwogICAgICAgICAgfSB3aGlsZSAoZmlsbCAhPT0gMCk7CiAgICAgICAgICBpbmNyID0gMSA8PCBsZW4gLSAxOwogICAgICAgICAgd2hpbGUgKGh1ZmYgJiBpbmNyKSB7CiAgICAgICAgICAgIGluY3IgPj49IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5jciAhPT0gMCkgewogICAgICAgICAgICBodWZmICY9IGluY3IgLSAxOwogICAgICAgICAgICBodWZmICs9IGluY3I7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBodWZmID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHN5bSsrOwogICAgICAgICAgaWYgKC0tY291bnRbbGVuXSA9PT0gMCkgewogICAgICAgICAgICBpZiAobGVuID09PSBtYXgzKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGVuID0gbGVuc1tsZW5zX2luZGV4ICsgd29ya1tzeW1dXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsZW4gPiByb290ICYmIChodWZmICYgbWFzaykgIT09IGxvdykgewogICAgICAgICAgICBpZiAoZHJvcCA9PT0gMCkgewogICAgICAgICAgICAgIGRyb3AgPSByb290OwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHQgKz0gbWluMzsKICAgICAgICAgICAgY3VyciA9IGxlbiAtIGRyb3A7CiAgICAgICAgICAgIGxlZnQgPSAxIDw8IGN1cnI7CiAgICAgICAgICAgIHdoaWxlIChjdXJyICsgZHJvcCA8IG1heDMpIHsKICAgICAgICAgICAgICBsZWZ0IC09IGNvdW50W2N1cnIgKyBkcm9wXTsKICAgICAgICAgICAgICBpZiAobGVmdCA8PSAwKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycisrOwogICAgICAgICAgICAgIGxlZnQgPDw9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXNlZCArPSAxIDw8IGN1cnI7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBMRU5TICYmIHVzZWQgPiBFTk9VR0hfTEVOUyB8fCB0eXBlID09PSBESVNUUyAmJiB1c2VkID4gRU5PVUdIX0RJU1RTKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG93ID0gaHVmZiAmIG1hc2s7CiAgICAgICAgICAgIHRhYmxlW2xvd10gPSByb290IDw8IDI0IHwgY3VyciA8PCAxNiB8IG5leHQgLSB0YWJsZV9pbmRleCB8IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChodWZmICE9PSAwKSB7CiAgICAgICAgICB0YWJsZVtuZXh0ICsgaHVmZl0gPSBsZW4gLSBkcm9wIDw8IDI0IHwgNjQgPDwgMTYgfCAwOwogICAgICAgIH0KICAgICAgICBvcHRzLmJpdHMgPSByb290OwogICAgICAgIHJldHVybiAwOwogICAgICB9OwogICAgICBtb2R1bGUuZXhwb3J0cyA9IGluZmxhdGVfdGFibGU7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2NvbnN0YW50cy5qcwogIHZhciByZXF1aXJlX2NvbnN0YW50cyA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2NvbnN0YW50cy5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICAgIC8qIEFsbG93ZWQgZmx1c2ggdmFsdWVzOyBzZWUgZGVmbGF0ZSgpIGFuZCBpbmZsYXRlKCkgYmVsb3cgZm9yIGRldGFpbHMgKi8KICAgICAgICBaX05PX0ZMVVNIOiAwLAogICAgICAgIFpfUEFSVElBTF9GTFVTSDogMSwKICAgICAgICBaX1NZTkNfRkxVU0g6IDIsCiAgICAgICAgWl9GVUxMX0ZMVVNIOiAzLAogICAgICAgIFpfRklOSVNIOiA0LAogICAgICAgIFpfQkxPQ0s6IDUsCiAgICAgICAgWl9UUkVFUzogNiwKICAgICAgICAvKiBSZXR1cm4gY29kZXMgZm9yIHRoZSBjb21wcmVzc2lvbi9kZWNvbXByZXNzaW9uIGZ1bmN0aW9ucy4gTmVnYXRpdmUgdmFsdWVzCiAgICAgICAgKiBhcmUgZXJyb3JzLCBwb3NpdGl2ZSB2YWx1ZXMgYXJlIHVzZWQgZm9yIHNwZWNpYWwgYnV0IG5vcm1hbCBldmVudHMuCiAgICAgICAgKi8KICAgICAgICBaX09LOiAwLAogICAgICAgIFpfU1RSRUFNX0VORDogMSwKICAgICAgICBaX05FRURfRElDVDogMiwKICAgICAgICBaX0VSUk5POiAtMSwKICAgICAgICBaX1NUUkVBTV9FUlJPUjogLTIsCiAgICAgICAgWl9EQVRBX0VSUk9SOiAtMywKICAgICAgICBaX01FTV9FUlJPUjogLTQsCiAgICAgICAgWl9CVUZfRVJST1I6IC01LAogICAgICAgIC8vWl9WRVJTSU9OX0VSUk9SOiAtNiwKICAgICAgICAvKiBjb21wcmVzc2lvbiBsZXZlbHMgKi8KICAgICAgICBaX05PX0NPTVBSRVNTSU9OOiAwLAogICAgICAgIFpfQkVTVF9TUEVFRDogMSwKICAgICAgICBaX0JFU1RfQ09NUFJFU1NJT046IDksCiAgICAgICAgWl9ERUZBVUxUX0NPTVBSRVNTSU9OOiAtMSwKICAgICAgICBaX0ZJTFRFUkVEOiAxLAogICAgICAgIFpfSFVGRk1BTl9PTkxZOiAyLAogICAgICAgIFpfUkxFOiAzLAogICAgICAgIFpfRklYRUQ6IDQsCiAgICAgICAgWl9ERUZBVUxUX1NUUkFURUdZOiAwLAogICAgICAgIC8qIFBvc3NpYmxlIHZhbHVlcyBvZiB0aGUgZGF0YV90eXBlIGZpZWxkICh0aG91Z2ggc2VlIGluZmxhdGUoKSkgKi8KICAgICAgICBaX0JJTkFSWTogMCwKICAgICAgICBaX1RFWFQ6IDEsCiAgICAgICAgLy9aX0FTQ0lJOiAgICAgICAgICAgICAgICAxLCAvLyA9IFpfVEVYVCAoZGVwcmVjYXRlZCkKICAgICAgICBaX1VOS05PV046IDIsCiAgICAgICAgLyogVGhlIGRlZmxhdGUgY29tcHJlc3Npb24gbWV0aG9kICovCiAgICAgICAgWl9ERUZMQVRFRDogOAogICAgICAgIC8vWl9OVUxMOiAgICAgICAgICAgICAgICAgbnVsbCAvLyBVc2UgLTEgb3IgbnVsbCBpbmxpbmUsIGRlcGVuZGluZyBvbiB2YXIgdHlwZQogICAgICB9OwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9pbmZsYXRlLmpzCiAgdmFyIHJlcXVpcmVfaW5mbGF0ZSA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2luZmxhdGUuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgYWRsZXIzMiA9IHJlcXVpcmVfYWRsZXIzMigpOwogICAgICB2YXIgY3JjMzIgPSByZXF1aXJlX2NyYzMyKCk7CiAgICAgIHZhciBpbmZsYXRlX2Zhc3QgPSByZXF1aXJlX2luZmZhc3QoKTsKICAgICAgdmFyIGluZmxhdGVfdGFibGUgPSByZXF1aXJlX2luZnRyZWVzKCk7CiAgICAgIHZhciBDT0RFUyA9IDA7CiAgICAgIHZhciBMRU5TID0gMTsKICAgICAgdmFyIERJU1RTID0gMjsKICAgICAgdmFyIHsKICAgICAgICBaX0ZJTklTSCwKICAgICAgICBaX0JMT0NLLAogICAgICAgIFpfVFJFRVMsCiAgICAgICAgWl9PSywKICAgICAgICBaX1NUUkVBTV9FTkQsCiAgICAgICAgWl9ORUVEX0RJQ1QsCiAgICAgICAgWl9TVFJFQU1fRVJST1IsCiAgICAgICAgWl9EQVRBX0VSUk9SLAogICAgICAgIFpfTUVNX0VSUk9SLAogICAgICAgIFpfQlVGX0VSUk9SLAogICAgICAgIFpfREVGTEFURUQKICAgICAgfSA9IHJlcXVpcmVfY29uc3RhbnRzKCk7CiAgICAgIHZhciBIRUFEID0gMTYxODA7CiAgICAgIHZhciBGTEFHUyA9IDE2MTgxOwogICAgICB2YXIgVElNRSA9IDE2MTgyOwogICAgICB2YXIgT1MgPSAxNjE4MzsKICAgICAgdmFyIEVYTEVOID0gMTYxODQ7CiAgICAgIHZhciBFWFRSQSA9IDE2MTg1OwogICAgICB2YXIgTkFNRSA9IDE2MTg2OwogICAgICB2YXIgQ09NTUVOVCA9IDE2MTg3OwogICAgICB2YXIgSENSQyA9IDE2MTg4OwogICAgICB2YXIgRElDVElEID0gMTYxODk7CiAgICAgIHZhciBESUNUID0gMTYxOTA7CiAgICAgIHZhciBUWVBFID0gMTYxOTE7CiAgICAgIHZhciBUWVBFRE8gPSAxNjE5MjsKICAgICAgdmFyIFNUT1JFRCA9IDE2MTkzOwogICAgICB2YXIgQ09QWV8gPSAxNjE5NDsKICAgICAgdmFyIENPUFkgPSAxNjE5NTsKICAgICAgdmFyIFRBQkxFID0gMTYxOTY7CiAgICAgIHZhciBMRU5MRU5TID0gMTYxOTc7CiAgICAgIHZhciBDT0RFTEVOUyA9IDE2MTk4OwogICAgICB2YXIgTEVOXyA9IDE2MTk5OwogICAgICB2YXIgTEVOID0gMTYyMDA7CiAgICAgIHZhciBMRU5FWFQgPSAxNjIwMTsKICAgICAgdmFyIERJU1QgPSAxNjIwMjsKICAgICAgdmFyIERJU1RFWFQgPSAxNjIwMzsKICAgICAgdmFyIE1BVENIID0gMTYyMDQ7CiAgICAgIHZhciBMSVQgPSAxNjIwNTsKICAgICAgdmFyIENIRUNLID0gMTYyMDY7CiAgICAgIHZhciBMRU5HVEggPSAxNjIwNzsKICAgICAgdmFyIERPTkUgPSAxNjIwODsKICAgICAgdmFyIEJBRCA9IDE2MjA5OwogICAgICB2YXIgTUVNID0gMTYyMTA7CiAgICAgIHZhciBTWU5DID0gMTYyMTE7CiAgICAgIHZhciBFTk9VR0hfTEVOUyA9IDg1MjsKICAgICAgdmFyIEVOT1VHSF9ESVNUUyA9IDU5MjsKICAgICAgdmFyIE1BWF9XQklUUyA9IDE1OwogICAgICB2YXIgREVGX1dCSVRTID0gTUFYX1dCSVRTOwogICAgICB2YXIgenN3YXAzMiA9IChxKSA9PiB7CiAgICAgICAgcmV0dXJuIChxID4+PiAyNCAmIDI1NSkgKyAocSA+Pj4gOCAmIDY1MjgwKSArICgocSAmIDY1MjgwKSA8PCA4KSArICgocSAmIDI1NSkgPDwgMjQpOwogICAgICB9OwogICAgICBmdW5jdGlvbiBJbmZsYXRlU3RhdGUoKSB7CiAgICAgICAgdGhpcy5zdHJtID0gbnVsbDsKICAgICAgICB0aGlzLm1vZGUgPSAwOwogICAgICAgIHRoaXMubGFzdCA9IGZhbHNlOwogICAgICAgIHRoaXMud3JhcCA9IDA7CiAgICAgICAgdGhpcy5oYXZlZGljdCA9IGZhbHNlOwogICAgICAgIHRoaXMuZmxhZ3MgPSAwOwogICAgICAgIHRoaXMuZG1heCA9IDA7CiAgICAgICAgdGhpcy5jaGVjayA9IDA7CiAgICAgICAgdGhpcy50b3RhbCA9IDA7CiAgICAgICAgdGhpcy5oZWFkID0gbnVsbDsKICAgICAgICB0aGlzLndiaXRzID0gMDsKICAgICAgICB0aGlzLndzaXplID0gMDsKICAgICAgICB0aGlzLndoYXZlID0gMDsKICAgICAgICB0aGlzLnduZXh0ID0gMDsKICAgICAgICB0aGlzLndpbmRvdyA9IG51bGw7CiAgICAgICAgdGhpcy5ob2xkID0gMDsKICAgICAgICB0aGlzLmJpdHMgPSAwOwogICAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgICAgdGhpcy5leHRyYSA9IDA7CiAgICAgICAgdGhpcy5sZW5jb2RlID0gbnVsbDsKICAgICAgICB0aGlzLmRpc3Rjb2RlID0gbnVsbDsKICAgICAgICB0aGlzLmxlbmJpdHMgPSAwOwogICAgICAgIHRoaXMuZGlzdGJpdHMgPSAwOwogICAgICAgIHRoaXMubmNvZGUgPSAwOwogICAgICAgIHRoaXMubmxlbiA9IDA7CiAgICAgICAgdGhpcy5uZGlzdCA9IDA7CiAgICAgICAgdGhpcy5oYXZlID0gMDsKICAgICAgICB0aGlzLm5leHQgPSBudWxsOwogICAgICAgIHRoaXMubGVucyA9IG5ldyBVaW50MTZBcnJheSgzMjApOwogICAgICAgIHRoaXMud29yayA9IG5ldyBVaW50MTZBcnJheSgyODgpOwogICAgICAgIHRoaXMubGVuZHluID0gbnVsbDsKICAgICAgICB0aGlzLmRpc3RkeW4gPSBudWxsOwogICAgICAgIHRoaXMuc2FuZSA9IDA7CiAgICAgICAgdGhpcy5iYWNrID0gMDsKICAgICAgICB0aGlzLndhcyA9IDA7CiAgICAgIH0KICAgICAgdmFyIGluZmxhdGVTdGF0ZUNoZWNrID0gKHN0cm0pID0+IHsKICAgICAgICBpZiAoIXN0cm0pIHsKICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKCFzdGF0ZSB8fCBzdGF0ZS5zdHJtICE9PSBzdHJtIHx8IHN0YXRlLm1vZGUgPCBIRUFEIHx8IHN0YXRlLm1vZGUgPiBTWU5DKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlUmVzZXRLZWVwID0gKHN0cm0pID0+IHsKICAgICAgICBpZiAoaW5mbGF0ZVN0YXRlQ2hlY2soc3RybSkpIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3RhdGUgPSBzdHJtLnN0YXRlOwogICAgICAgIHN0cm0udG90YWxfaW4gPSBzdHJtLnRvdGFsX291dCA9IHN0YXRlLnRvdGFsID0gMDsKICAgICAgICBzdHJtLm1zZyA9ICIiOwogICAgICAgIGlmIChzdGF0ZS53cmFwKSB7CiAgICAgICAgICBzdHJtLmFkbGVyID0gc3RhdGUud3JhcCAmIDE7CiAgICAgICAgfQogICAgICAgIHN0YXRlLm1vZGUgPSBIRUFEOwogICAgICAgIHN0YXRlLmxhc3QgPSAwOwogICAgICAgIHN0YXRlLmhhdmVkaWN0ID0gMDsKICAgICAgICBzdGF0ZS5mbGFncyA9IC0xOwogICAgICAgIHN0YXRlLmRtYXggPSAzMjc2ODsKICAgICAgICBzdGF0ZS5oZWFkID0gbnVsbDsKICAgICAgICBzdGF0ZS5ob2xkID0gMDsKICAgICAgICBzdGF0ZS5iaXRzID0gMDsKICAgICAgICBzdGF0ZS5sZW5jb2RlID0gc3RhdGUubGVuZHluID0gbmV3IEludDMyQXJyYXkoRU5PVUdIX0xFTlMpOwogICAgICAgIHN0YXRlLmRpc3Rjb2RlID0gc3RhdGUuZGlzdGR5biA9IG5ldyBJbnQzMkFycmF5KEVOT1VHSF9ESVNUUyk7CiAgICAgICAgc3RhdGUuc2FuZSA9IDE7CiAgICAgICAgc3RhdGUuYmFjayA9IC0xOwogICAgICAgIHJldHVybiBaX09LOwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZVJlc2V0ID0gKHN0cm0pID0+IHsKICAgICAgICBpZiAoaW5mbGF0ZVN0YXRlQ2hlY2soc3RybSkpIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3RhdGUgPSBzdHJtLnN0YXRlOwogICAgICAgIHN0YXRlLndzaXplID0gMDsKICAgICAgICBzdGF0ZS53aGF2ZSA9IDA7CiAgICAgICAgc3RhdGUud25leHQgPSAwOwogICAgICAgIHJldHVybiBpbmZsYXRlUmVzZXRLZWVwKHN0cm0pOwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZVJlc2V0MiA9IChzdHJtLCB3aW5kb3dCaXRzKSA9PiB7CiAgICAgICAgbGV0IHdyYXA7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBpZiAod2luZG93Qml0cyA8IDApIHsKICAgICAgICAgIHdyYXAgPSAwOwogICAgICAgICAgd2luZG93Qml0cyA9IC13aW5kb3dCaXRzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3cmFwID0gKHdpbmRvd0JpdHMgPj4gNCkgKyA1OwogICAgICAgICAgaWYgKHdpbmRvd0JpdHMgPCA0OCkgewogICAgICAgICAgICB3aW5kb3dCaXRzICY9IDE1OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAod2luZG93Qml0cyAmJiAod2luZG93Qml0cyA8IDggfHwgd2luZG93Qml0cyA+IDE1KSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhdGUud2luZG93ICE9PSBudWxsICYmIHN0YXRlLndiaXRzICE9PSB3aW5kb3dCaXRzKSB7CiAgICAgICAgICBzdGF0ZS53aW5kb3cgPSBudWxsOwogICAgICAgIH0KICAgICAgICBzdGF0ZS53cmFwID0gd3JhcDsKICAgICAgICBzdGF0ZS53Yml0cyA9IHdpbmRvd0JpdHM7CiAgICAgICAgcmV0dXJuIGluZmxhdGVSZXNldChzdHJtKTsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVJbml0MiA9IChzdHJtLCB3aW5kb3dCaXRzKSA9PiB7CiAgICAgICAgaWYgKCFzdHJtKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXRlID0gbmV3IEluZmxhdGVTdGF0ZSgpOwogICAgICAgIHN0cm0uc3RhdGUgPSBzdGF0ZTsKICAgICAgICBzdGF0ZS5zdHJtID0gc3RybTsKICAgICAgICBzdGF0ZS53aW5kb3cgPSBudWxsOwogICAgICAgIHN0YXRlLm1vZGUgPSBIRUFEOwogICAgICAgIGNvbnN0IHJldCA9IGluZmxhdGVSZXNldDIoc3RybSwgd2luZG93Qml0cyk7CiAgICAgICAgaWYgKHJldCAhPT0gWl9PSykgewogICAgICAgICAgc3RybS5zdGF0ZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlSW5pdCA9IChzdHJtKSA9PiB7CiAgICAgICAgcmV0dXJuIGluZmxhdGVJbml0MihzdHJtLCBERUZfV0JJVFMpOwogICAgICB9OwogICAgICB2YXIgdmlyZ2luID0gdHJ1ZTsKICAgICAgdmFyIGxlbmZpeDsKICAgICAgdmFyIGRpc3RmaXg7CiAgICAgIHZhciBmaXhlZHRhYmxlcyA9IChzdGF0ZSkgPT4gewogICAgICAgIGlmICh2aXJnaW4pIHsKICAgICAgICAgIGxlbmZpeCA9IG5ldyBJbnQzMkFycmF5KDUxMik7CiAgICAgICAgICBkaXN0Zml4ID0gbmV3IEludDMyQXJyYXkoMzIpOwogICAgICAgICAgbGV0IHN5bSA9IDA7CiAgICAgICAgICB3aGlsZSAoc3ltIDwgMTQ0KSB7CiAgICAgICAgICAgIHN0YXRlLmxlbnNbc3ltKytdID0gODsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChzeW0gPCAyNTYpIHsKICAgICAgICAgICAgc3RhdGUubGVuc1tzeW0rK10gPSA5OwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHN5bSA8IDI4MCkgewogICAgICAgICAgICBzdGF0ZS5sZW5zW3N5bSsrXSA9IDc7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoc3ltIDwgMjg4KSB7CiAgICAgICAgICAgIHN0YXRlLmxlbnNbc3ltKytdID0gODsKICAgICAgICAgIH0KICAgICAgICAgIGluZmxhdGVfdGFibGUoTEVOUywgc3RhdGUubGVucywgMCwgMjg4LCBsZW5maXgsIDAsIHN0YXRlLndvcmssIHsgYml0czogOSB9KTsKICAgICAgICAgIHN5bSA9IDA7CiAgICAgICAgICB3aGlsZSAoc3ltIDwgMzIpIHsKICAgICAgICAgICAgc3RhdGUubGVuc1tzeW0rK10gPSA1OwogICAgICAgICAgfQogICAgICAgICAgaW5mbGF0ZV90YWJsZShESVNUUywgc3RhdGUubGVucywgMCwgMzIsIGRpc3RmaXgsIDAsIHN0YXRlLndvcmssIHsgYml0czogNSB9KTsKICAgICAgICAgIHZpcmdpbiA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBzdGF0ZS5sZW5jb2RlID0gbGVuZml4OwogICAgICAgIHN0YXRlLmxlbmJpdHMgPSA5OwogICAgICAgIHN0YXRlLmRpc3Rjb2RlID0gZGlzdGZpeDsKICAgICAgICBzdGF0ZS5kaXN0Yml0cyA9IDU7CiAgICAgIH07CiAgICAgIHZhciB1cGRhdGV3aW5kb3cgPSAoc3RybSwgc3JjLCBlbmQsIGNvcHkpID0+IHsKICAgICAgICBsZXQgZGlzdDsKICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKHN0YXRlLndpbmRvdyA9PT0gbnVsbCkgewogICAgICAgICAgc3RhdGUud3NpemUgPSAxIDw8IHN0YXRlLndiaXRzOwogICAgICAgICAgc3RhdGUud25leHQgPSAwOwogICAgICAgICAgc3RhdGUud2hhdmUgPSAwOwogICAgICAgICAgc3RhdGUud2luZG93ID0gbmV3IFVpbnQ4QXJyYXkoc3RhdGUud3NpemUpOwogICAgICAgIH0KICAgICAgICBpZiAoY29weSA+PSBzdGF0ZS53c2l6ZSkgewogICAgICAgICAgc3RhdGUud2luZG93LnNldChzcmMuc3ViYXJyYXkoZW5kIC0gc3RhdGUud3NpemUsIGVuZCksIDApOwogICAgICAgICAgc3RhdGUud25leHQgPSAwOwogICAgICAgICAgc3RhdGUud2hhdmUgPSBzdGF0ZS53c2l6ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGlzdCA9IHN0YXRlLndzaXplIC0gc3RhdGUud25leHQ7CiAgICAgICAgICBpZiAoZGlzdCA+IGNvcHkpIHsKICAgICAgICAgICAgZGlzdCA9IGNvcHk7CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0ZS53aW5kb3cuc2V0KHNyYy5zdWJhcnJheShlbmQgLSBjb3B5LCBlbmQgLSBjb3B5ICsgZGlzdCksIHN0YXRlLnduZXh0KTsKICAgICAgICAgIGNvcHkgLT0gZGlzdDsKICAgICAgICAgIGlmIChjb3B5KSB7CiAgICAgICAgICAgIHN0YXRlLndpbmRvdy5zZXQoc3JjLnN1YmFycmF5KGVuZCAtIGNvcHksIGVuZCksIDApOwogICAgICAgICAgICBzdGF0ZS53bmV4dCA9IGNvcHk7CiAgICAgICAgICAgIHN0YXRlLndoYXZlID0gc3RhdGUud3NpemU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0ZS53bmV4dCArPSBkaXN0OwogICAgICAgICAgICBpZiAoc3RhdGUud25leHQgPT09IHN0YXRlLndzaXplKSB7CiAgICAgICAgICAgICAgc3RhdGUud25leHQgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdGF0ZS53aGF2ZSA8IHN0YXRlLndzaXplKSB7CiAgICAgICAgICAgICAgc3RhdGUud2hhdmUgKz0gZGlzdDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGUgPSAoc3RybSwgZmx1c2gpID0+IHsKICAgICAgICBsZXQgc3RhdGU7CiAgICAgICAgbGV0IGlucHV0LCBvdXRwdXQ7CiAgICAgICAgbGV0IG5leHQ7CiAgICAgICAgbGV0IHB1dDsKICAgICAgICBsZXQgaGF2ZSwgbGVmdDsKICAgICAgICBsZXQgaG9sZDsKICAgICAgICBsZXQgYml0czsKICAgICAgICBsZXQgX2luLCBfb3V0OwogICAgICAgIGxldCBjb3B5OwogICAgICAgIGxldCBmcm9tOwogICAgICAgIGxldCBmcm9tX3NvdXJjZTsKICAgICAgICBsZXQgaGVyZSA9IDA7CiAgICAgICAgbGV0IGhlcmVfYml0cywgaGVyZV9vcCwgaGVyZV92YWw7CiAgICAgICAgbGV0IGxhc3RfYml0cywgbGFzdF9vcCwgbGFzdF92YWw7CiAgICAgICAgbGV0IGxlbjsKICAgICAgICBsZXQgcmV0OwogICAgICAgIGNvbnN0IGhidWYgPSBuZXcgVWludDhBcnJheSg0KTsKICAgICAgICBsZXQgb3B0czsKICAgICAgICBsZXQgbjsKICAgICAgICBjb25zdCBvcmRlciA9ICgKICAgICAgICAgIC8qIHBlcm11dGF0aW9uIG9mIGNvZGUgbGVuZ3RocyAqLwogICAgICAgICAgbmV3IFVpbnQ4QXJyYXkoWzE2LCAxNywgMTgsIDAsIDgsIDcsIDksIDYsIDEwLCA1LCAxMSwgNCwgMTIsIDMsIDEzLCAyLCAxNCwgMSwgMTVdKQogICAgICAgICk7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pIHx8ICFzdHJtLm91dHB1dCB8fCAhc3RybS5pbnB1dCAmJiBzdHJtLmF2YWlsX2luICE9PSAwKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBpZiAoc3RhdGUubW9kZSA9PT0gVFlQRSkgewogICAgICAgICAgc3RhdGUubW9kZSA9IFRZUEVETzsKICAgICAgICB9CiAgICAgICAgcHV0ID0gc3RybS5uZXh0X291dDsKICAgICAgICBvdXRwdXQgPSBzdHJtLm91dHB1dDsKICAgICAgICBsZWZ0ID0gc3RybS5hdmFpbF9vdXQ7CiAgICAgICAgbmV4dCA9IHN0cm0ubmV4dF9pbjsKICAgICAgICBpbnB1dCA9IHN0cm0uaW5wdXQ7CiAgICAgICAgaGF2ZSA9IHN0cm0uYXZhaWxfaW47CiAgICAgICAgaG9sZCA9IHN0YXRlLmhvbGQ7CiAgICAgICAgYml0cyA9IHN0YXRlLmJpdHM7CiAgICAgICAgX2luID0gaGF2ZTsKICAgICAgICBfb3V0ID0gbGVmdDsKICAgICAgICByZXQgPSBaX09LOwogICAgICAgIGluZl9sZWF2ZToKICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICBzd2l0Y2ggKHN0YXRlLm1vZGUpIHsKICAgICAgICAgICAgICBjYXNlIEhFQUQ6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRURPOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgMTYpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLndyYXAgJiAyICYmIGhvbGQgPT09IDM1NjE1KSB7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53Yml0cyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHN0YXRlLndiaXRzID0gMTU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSAwOwogICAgICAgICAgICAgICAgICBoYnVmWzBdID0gaG9sZCAmIDI1NTsKICAgICAgICAgICAgICAgICAgaGJ1ZlsxXSA9IGhvbGQgPj4+IDggJiAyNTU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrID0gY3JjMzIoc3RhdGUuY2hlY2ssIGhidWYsIDIsIDApOwogICAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBGTEFHUzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmRvbmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghKHN0YXRlLndyYXAgJiAxKSB8fCAvKiBjaGVjayBpZiB6bGliIGhlYWRlciBhbGxvd2VkICovCiAgICAgICAgICAgICAgICAoKChob2xkICYgMjU1KSA8PCA4KSArIChob2xkID4+IDgpKSAlIDMxKSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImluY29ycmVjdCBoZWFkZXIgY2hlY2siOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgoaG9sZCAmIDE1KSAhPT0gWl9ERUZMQVRFRCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJ1bmtub3duIGNvbXByZXNzaW9uIG1ldGhvZCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaG9sZCA+Pj49IDQ7CiAgICAgICAgICAgICAgICBiaXRzIC09IDQ7CiAgICAgICAgICAgICAgICBsZW4gPSAoaG9sZCAmIDE1KSArIDg7CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUud2JpdHMgPT09IDApIHsKICAgICAgICAgICAgICAgICAgc3RhdGUud2JpdHMgPSBsZW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobGVuID4gMTUgfHwgbGVuID4gc3RhdGUud2JpdHMpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCB3aW5kb3cgc2l6ZSI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuZG1heCA9IDEgPDwgc3RhdGUud2JpdHM7CiAgICAgICAgICAgICAgICBzdGF0ZS5mbGFncyA9IDA7CiAgICAgICAgICAgICAgICBzdHJtLmFkbGVyID0gc3RhdGUuY2hlY2sgPSAxOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IGhvbGQgJiA1MTIgPyBESUNUSUQgOiBUWVBFOwogICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRkxBR1M6CiAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE2KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmZsYWdzID0gaG9sZDsKICAgICAgICAgICAgICAgIGlmICgoc3RhdGUuZmxhZ3MgJiAyNTUpICE9PSBaX0RFRkxBVEVEKSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gInVua25vd24gY29tcHJlc3Npb24gbWV0aG9kIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA1NzM0NCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJ1bmtub3duIGhlYWRlciBmbGFncyBzZXQiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5oZWFkKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQudGV4dCA9IGhvbGQgPj4gOCAmIDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA1MTIgJiYgc3RhdGUud3JhcCAmIDQpIHsKICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhidWZbMV0gPSBob2xkID4+PiA4ICYgMjU1OwogICAgICAgICAgICAgICAgICBzdGF0ZS5jaGVjayA9IGNyYzMyKHN0YXRlLmNoZWNrLCBoYnVmLCAyLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPSAwOwogICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVElNRTsKICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgY2FzZSBUSU1FOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnRpbWUgPSBob2xkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgIGhidWZbMF0gPSBob2xkICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzFdID0gaG9sZCA+Pj4gOCAmIDI1NTsKICAgICAgICAgICAgICAgICAgaGJ1ZlsyXSA9IGhvbGQgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzNdID0gaG9sZCA+Pj4gMjQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrID0gY3JjMzIoc3RhdGUuY2hlY2ssIGhidWYsIDQsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBPUzsKICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgY2FzZSBPUzoKICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgMTYpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC54ZmxhZ3MgPSBob2xkICYgMjU1OwogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLm9zID0gaG9sZCA+PiA4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgIGhidWZbMF0gPSBob2xkICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzFdID0gaG9sZCA+Pj4gOCAmIDI1NTsKICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaGJ1ZiwgMiwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEVYTEVOOwogICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgICBjYXNlIEVYTEVOOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgMTAyNCkgewogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggPSBob2xkOwogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQuZXh0cmFfbGVuID0gaG9sZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA1MTIgJiYgc3RhdGUud3JhcCAmIDQpIHsKICAgICAgICAgICAgICAgICAgICBoYnVmWzBdID0gaG9sZCAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoYnVmWzFdID0gaG9sZCA+Pj4gOCAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jaGVjayA9IGNyYzMyKHN0YXRlLmNoZWNrLCBoYnVmLCAyLCAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5leHRyYSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRVhUUkE7CiAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICAgIGNhc2UgRVhUUkE6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiAxMDI0KSB7CiAgICAgICAgICAgICAgICAgIGNvcHkgPSBzdGF0ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gaGF2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBoYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IHN0YXRlLmhlYWQuZXh0cmFfbGVuIC0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5oZWFkLmV4dHJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQuZXh0cmEgPSBuZXcgVWludDhBcnJheShzdGF0ZS5oZWFkLmV4dHJhX2xlbik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmV4dHJhLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuc3ViYXJyYXkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBleHRyYSBmaWVsZCBpcyBsaW1pdGVkIHRvIDY1NTM2IGJ5dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBubyBuZWVkIGZvciBhZGRpdGlvbmFsIHNpemUgY2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ICsgY29weQogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAvKmxlbiArIGNvcHkgPiBzdGF0ZS5oZWFkLmV4dHJhX21heCAtIGxlbiA/IHN0YXRlLmhlYWQuZXh0cmFfbWF4IDogY29weSwqLwogICAgICAgICAgICAgICAgICAgICAgICBsZW4KICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDUxMiAmJiBzdGF0ZS53cmFwICYgNCkgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCAtPSBjb3B5OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTkFNRTsKICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgY2FzZSBOQU1FOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgMjA0OCkgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb3B5ID0gMDsKICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGxlbiA9IGlucHV0W25leHQgKyBjb3B5KytdOwogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5oZWFkICYmIGxlbiAmJiBzdGF0ZS5sZW5ndGggPCA2NTUzNikgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5uYW1lICs9IFN0cmluZy5mcm9tQ2hhckNvZGUobGVuKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGxlbiAmJiBjb3B5IDwgaGF2ZSk7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDUxMiAmJiBzdGF0ZS53cmFwICYgNCkgewogICAgICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrID0gY3JjMzIoc3RhdGUuY2hlY2ssIGlucHV0LCBjb3B5LCBuZXh0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgIG5leHQgKz0gY29weTsKICAgICAgICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5oZWFkKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQubmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IENPTU1FTlQ7CiAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICAgIGNhc2UgQ09NTUVOVDoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDQwOTYpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29weSA9IDA7CiAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBsZW4gPSBpbnB1dFtuZXh0ICsgY29weSsrXTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCAmJiBsZW4gJiYgc3RhdGUubGVuZ3RoIDwgNjU1MzYpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQuY29tbWVudCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGxlbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IHdoaWxlIChsZW4gJiYgY29weSA8IGhhdmUpOwogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA1MTIgJiYgc3RhdGUud3JhcCAmIDQpIHsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jaGVjayA9IGNyYzMyKHN0YXRlLmNoZWNrLCBpbnB1dCwgY29weSwgbmV4dCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaGF2ZSAtPSBjb3B5OwogICAgICAgICAgICAgICAgICBuZXh0ICs9IGNvcHk7CiAgICAgICAgICAgICAgICAgIGlmIChsZW4pIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmNvbW1lbnQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEhDUkM7CiAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICAgIGNhc2UgSENSQzoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDUxMikgewogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCAmIDQgJiYgaG9sZCAhPT0gKHN0YXRlLmNoZWNrICYgNjU1MzUpKSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaGVhZGVyIGNyYyBtaXNtYXRjaCI7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmhjcmMgPSBzdGF0ZS5mbGFncyA+PiA5ICYgMTsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5kb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cm0uYWRsZXIgPSBzdGF0ZS5jaGVjayA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRElDVElEOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJtLmFkbGVyID0gc3RhdGUuY2hlY2sgPSB6c3dhcDMyKGhvbGQpOwogICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBESUNUOwogICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgICBjYXNlIERJQ1Q6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGF2ZWRpY3QgPT09IDApIHsKICAgICAgICAgICAgICAgICAgc3RybS5uZXh0X291dCA9IHB1dDsKICAgICAgICAgICAgICAgICAgc3RybS5hdmFpbF9vdXQgPSBsZWZ0OwogICAgICAgICAgICAgICAgICBzdHJtLm5leHRfaW4gPSBuZXh0OwogICAgICAgICAgICAgICAgICBzdHJtLmF2YWlsX2luID0gaGF2ZTsKICAgICAgICAgICAgICAgICAgc3RhdGUuaG9sZCA9IGhvbGQ7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmJpdHMgPSBiaXRzOwogICAgICAgICAgICAgICAgICByZXR1cm4gWl9ORUVEX0RJQ1Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJtLmFkbGVyID0gc3RhdGUuY2hlY2sgPSAxOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRZUEU7CiAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICAgIGNhc2UgVFlQRToKICAgICAgICAgICAgICAgIGlmIChmbHVzaCA9PT0gWl9CTE9DSyB8fCBmbHVzaCA9PT0gWl9UUkVFUykgewogICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICAgIGNhc2UgVFlQRURPOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmxhc3QpIHsKICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgICBiaXRzIC09IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ0hFQ0s7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxhc3QgPSBob2xkICYgMTsKICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAxOwogICAgICAgICAgICAgICAgYml0cyAtPSAxOwogICAgICAgICAgICAgICAgc3dpdGNoIChob2xkICYgMykgewogICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFNUT1JFRDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICAgIGZpeGVkdGFibGVzKHN0YXRlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOXzsKICAgICAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBUQUJMRTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgYmxvY2sgdHlwZSI7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBTVE9SRUQ6CiAgICAgICAgICAgICAgICBob2xkID4+Pj0gYml0cyAmIDc7CiAgICAgICAgICAgICAgICBiaXRzIC09IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKGhvbGQgJiA2NTUzNSkgIT09IChob2xkID4+PiAxNiBeIDY1NTM1KSkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIHN0b3JlZCBibG9jayBsZW5ndGhzIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggPSBob2xkICYgNjU1MzU7CiAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IENPUFlfOwogICAgICAgICAgICAgICAgaWYgKGZsdXNoID09PSBaX1RSRUVTKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgY2FzZSBDT1BZXzoKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBDT1BZOwogICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgICBjYXNlIENPUFk6CiAgICAgICAgICAgICAgICBjb3B5ID0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGNvcHkpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNvcHkgPiBoYXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29weSA9IGhhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGNvcHkgPiBsZWZ0KSB7CiAgICAgICAgICAgICAgICAgICAgY29weSA9IGxlZnQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGNvcHkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgb3V0cHV0LnNldChpbnB1dC5zdWJhcnJheShuZXh0LCBuZXh0ICsgY29weSksIHB1dCk7CiAgICAgICAgICAgICAgICAgIGhhdmUgLT0gY29weTsKICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICBsZWZ0IC09IGNvcHk7CiAgICAgICAgICAgICAgICAgIHB1dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggLT0gY29weTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgVEFCTEU6CiAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE0KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm5sZW4gPSAoaG9sZCAmIDMxKSArIDI1NzsKICAgICAgICAgICAgICAgIGhvbGQgPj4+PSA1OwogICAgICAgICAgICAgICAgYml0cyAtPSA1OwogICAgICAgICAgICAgICAgc3RhdGUubmRpc3QgPSAoaG9sZCAmIDMxKSArIDE7CiAgICAgICAgICAgICAgICBob2xkID4+Pj0gNTsKICAgICAgICAgICAgICAgIGJpdHMgLT0gNTsKICAgICAgICAgICAgICAgIHN0YXRlLm5jb2RlID0gKGhvbGQgJiAxNSkgKyA0OwogICAgICAgICAgICAgICAgaG9sZCA+Pj49IDQ7CiAgICAgICAgICAgICAgICBiaXRzIC09IDQ7CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUubmxlbiA+IDI4NiB8fCBzdGF0ZS5uZGlzdCA+IDMwKSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gInRvbyBtYW55IGxlbmd0aCBvciBkaXN0YW5jZSBzeW1ib2xzIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5oYXZlID0gMDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBMRU5MRU5TOwogICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgICBjYXNlIExFTkxFTlM6CiAgICAgICAgICAgICAgICB3aGlsZSAoc3RhdGUuaGF2ZSA8IHN0YXRlLm5jb2RlKSB7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgMykgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RhdGUubGVuc1tvcmRlcltzdGF0ZS5oYXZlKytdXSA9IGhvbGQgJiA3OwogICAgICAgICAgICAgICAgICBob2xkID4+Pj0gMzsKICAgICAgICAgICAgICAgICAgYml0cyAtPSAzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKHN0YXRlLmhhdmUgPCAxOSkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5zW29yZGVyW3N0YXRlLmhhdmUrK11dID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmNvZGUgPSBzdGF0ZS5sZW5keW47CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gNzsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmxlbmJpdHMgfTsKICAgICAgICAgICAgICAgIHJldCA9IGluZmxhdGVfdGFibGUoQ09ERVMsIHN0YXRlLmxlbnMsIDAsIDE5LCBzdGF0ZS5sZW5jb2RlLCAwLCBzdGF0ZS53b3JrLCBvcHRzKTsKICAgICAgICAgICAgICAgIHN0YXRlLmxlbmJpdHMgPSBvcHRzLmJpdHM7CiAgICAgICAgICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgY29kZSBsZW5ndGhzIHNldCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuaGF2ZSA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ09ERUxFTlM7CiAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICAgIGNhc2UgQ09ERUxFTlM6CiAgICAgICAgICAgICAgICB3aGlsZSAoc3RhdGUuaGF2ZSA8IHN0YXRlLm5sZW4gKyBzdGF0ZS5uZGlzdCkgewogICAgICAgICAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgICAgICAgICBoZXJlID0gc3RhdGUubGVuY29kZVtob2xkICYgKDEgPDwgc3RhdGUubGVuYml0cykgLSAxXTsKICAgICAgICAgICAgICAgICAgICBoZXJlX2JpdHMgPSBoZXJlID4+PiAyNDsKICAgICAgICAgICAgICAgICAgICBoZXJlX29wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICAgICAgaGVyZV92YWwgPSBoZXJlICYgNjU1MzU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhlcmVfYml0cyA8PSBiaXRzKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoaGVyZV92YWwgPCAxNikgewogICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyAtPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubGVuc1tzdGF0ZS5oYXZlKytdID0gaGVyZV92YWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhlcmVfdmFsID09PSAxNikgewogICAgICAgICAgICAgICAgICAgICAgbiA9IGhlcmVfYml0cyArIDI7CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBiaXQgbGVuZ3RoIHJlcGVhdCI7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgbGVuID0gc3RhdGUubGVuc1tzdGF0ZS5oYXZlIC0gMV07CiAgICAgICAgICAgICAgICAgICAgICBjb3B5ID0gMyArIChob2xkICYgMyk7CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gMjsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhlcmVfdmFsID09PSAxNykgewogICAgICAgICAgICAgICAgICAgICAgbiA9IGhlcmVfYml0cyArIDM7CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICAgICAgbGVuID0gMDsKICAgICAgICAgICAgICAgICAgICAgIGNvcHkgPSAzICsgKGhvbGQgJiA3KTsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAzOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSAzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBuID0gaGVyZV9iaXRzICsgNzsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBsZW4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgY29weSA9IDExICsgKGhvbGQgJiAxMjcpOwogICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IDc7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IDc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5oYXZlICsgY29weSA+IHN0YXRlLm5sZW4gKyBzdGF0ZS5uZGlzdCkgewogICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBiaXQgbGVuZ3RoIHJlcGVhdCI7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHdoaWxlIChjb3B5LS0pIHsKICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmxlbnNbc3RhdGUuaGF2ZSsrXSA9IGxlbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5tb2RlID09PSBCQUQpIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUubGVuc1syNTZdID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgY29kZSAtLSBtaXNzaW5nIGVuZC1vZi1ibG9jayI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubGVuYml0cyA9IDk7CiAgICAgICAgICAgICAgICBvcHRzID0geyBiaXRzOiBzdGF0ZS5sZW5iaXRzIH07CiAgICAgICAgICAgICAgICByZXQgPSBpbmZsYXRlX3RhYmxlKExFTlMsIHN0YXRlLmxlbnMsIDAsIHN0YXRlLm5sZW4sIHN0YXRlLmxlbmNvZGUsIDAsIHN0YXRlLndvcmssIG9wdHMpOwogICAgICAgICAgICAgICAgc3RhdGUubGVuYml0cyA9IG9wdHMuYml0czsKICAgICAgICAgICAgICAgIGlmIChyZXQpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBsaXRlcmFsL2xlbmd0aHMgc2V0IjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5kaXN0Yml0cyA9IDY7CiAgICAgICAgICAgICAgICBzdGF0ZS5kaXN0Y29kZSA9IHN0YXRlLmRpc3RkeW47CiAgICAgICAgICAgICAgICBvcHRzID0geyBiaXRzOiBzdGF0ZS5kaXN0Yml0cyB9OwogICAgICAgICAgICAgICAgcmV0ID0gaW5mbGF0ZV90YWJsZShESVNUUywgc3RhdGUubGVucywgc3RhdGUubmxlbiwgc3RhdGUubmRpc3QsIHN0YXRlLmRpc3Rjb2RlLCAwLCBzdGF0ZS53b3JrLCBvcHRzKTsKICAgICAgICAgICAgICAgIHN0YXRlLmRpc3RiaXRzID0gb3B0cy5iaXRzOwogICAgICAgICAgICAgICAgaWYgKHJldCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGRpc3RhbmNlcyBzZXQiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBMRU5fOwogICAgICAgICAgICAgICAgaWYgKGZsdXNoID09PSBaX1RSRUVTKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgY2FzZSBMRU5fOgogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTjsKICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgY2FzZSBMRU46CiAgICAgICAgICAgICAgICBpZiAoaGF2ZSA+PSA2ICYmIGxlZnQgPj0gMjU4KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubmV4dF9vdXQgPSBwdXQ7CiAgICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gbGVmdDsKICAgICAgICAgICAgICAgICAgc3RybS5uZXh0X2luID0gbmV4dDsKICAgICAgICAgICAgICAgICAgc3RybS5hdmFpbF9pbiA9IGhhdmU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhvbGQgPSBob2xkOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iaXRzID0gYml0czsKICAgICAgICAgICAgICAgICAgaW5mbGF0ZV9mYXN0KHN0cm0sIF9vdXQpOwogICAgICAgICAgICAgICAgICBwdXQgPSBzdHJtLm5leHRfb3V0OwogICAgICAgICAgICAgICAgICBvdXRwdXQgPSBzdHJtLm91dHB1dDsKICAgICAgICAgICAgICAgICAgbGVmdCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgICAgICAgICAgICBuZXh0ID0gc3RybS5uZXh0X2luOwogICAgICAgICAgICAgICAgICBpbnB1dCA9IHN0cm0uaW5wdXQ7CiAgICAgICAgICAgICAgICAgIGhhdmUgPSBzdHJtLmF2YWlsX2luOwogICAgICAgICAgICAgICAgICBob2xkID0gc3RhdGUuaG9sZDsKICAgICAgICAgICAgICAgICAgYml0cyA9IHN0YXRlLmJpdHM7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5tb2RlID09PSBUWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IC0xOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgICAgICAgaGVyZSA9IHN0YXRlLmxlbmNvZGVbaG9sZCAmICgxIDw8IHN0YXRlLmxlbmJpdHMpIC0gMV07CiAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICBoZXJlX29wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhlcmVfdmFsID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICBpZiAoaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCAmJiAoaGVyZV9vcCAmIDI0MCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgbGFzdF9iaXRzID0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICBsYXN0X29wID0gaGVyZV9vcDsKICAgICAgICAgICAgICAgICAgbGFzdF92YWwgPSBoZXJlX3ZhbDsKICAgICAgICAgICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgICAgICAgICAgaGVyZSA9IHN0YXRlLmxlbmNvZGVbbGFzdF92YWwgKyAoKGhvbGQgJiAoMSA8PCBsYXN0X2JpdHMgKyBsYXN0X29wKSAtIDEpID4+IGxhc3RfYml0cyldOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdF9iaXRzICsgaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBsYXN0X2JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgLT0gbGFzdF9iaXRzOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IGxhc3RfYml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgIHN0YXRlLmJhY2sgKz0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoID0gaGVyZV92YWw7CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTElUOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChoZXJlX29wICYgMzIpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IC0xOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCAmIDY0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgbGl0ZXJhbC9sZW5ndGggY29kZSI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuZXh0cmEgPSBoZXJlX29wICYgMTU7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVORVhUOwogICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgICBjYXNlIExFTkVYVDoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5leHRyYSkgewogICAgICAgICAgICAgICAgICBuID0gc3RhdGUuZXh0cmE7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgbikgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoICs9IGhvbGQgJiAoMSA8PCBzdGF0ZS5leHRyYSkgLSAxOwogICAgICAgICAgICAgICAgICBob2xkID4+Pj0gc3RhdGUuZXh0cmE7CiAgICAgICAgICAgICAgICAgIGJpdHMgLT0gc3RhdGUuZXh0cmE7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmJhY2sgKz0gc3RhdGUuZXh0cmE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS53YXMgPSBzdGF0ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRElTVDsKICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgY2FzZSBESVNUOgogICAgICAgICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgICAgICAgIGhlcmUgPSBzdGF0ZS5kaXN0Y29kZVtob2xkICYgKDEgPDwgc3RhdGUuZGlzdGJpdHMpIC0gMV07CiAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICBoZXJlX29wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhlcmVfdmFsID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICBpZiAoaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKGhlcmVfb3AgJiAyNDApID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RfYml0cyA9IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgbGFzdF9vcCA9IGhlcmVfb3A7CiAgICAgICAgICAgICAgICAgIGxhc3RfdmFsID0gaGVyZV92YWw7CiAgICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICAgIGhlcmUgPSBzdGF0ZS5kaXN0Y29kZVtsYXN0X3ZhbCArICgoaG9sZCAmICgxIDw8IGxhc3RfYml0cyArIGxhc3Rfb3ApIC0gMSkgPj4gbGFzdF9iaXRzKV07CiAgICAgICAgICAgICAgICAgICAgaGVyZV9iaXRzID0gaGVyZSA+Pj4gMjQ7CiAgICAgICAgICAgICAgICAgICAgaGVyZV9vcCA9IGhlcmUgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICAgIGhlcmVfdmFsID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICAgIGlmIChsYXN0X2JpdHMgKyBoZXJlX2JpdHMgPD0gYml0cykgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGxhc3RfYml0czsKICAgICAgICAgICAgICAgICAgYml0cyAtPSBsYXN0X2JpdHM7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmJhY2sgKz0gbGFzdF9iaXRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaG9sZCA+Pj49IGhlcmVfYml0czsKICAgICAgICAgICAgICAgIGJpdHMgLT0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgc3RhdGUuYmFjayArPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCAmIDY0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgZGlzdGFuY2UgY29kZSI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUub2Zmc2V0ID0gaGVyZV92YWw7CiAgICAgICAgICAgICAgICBzdGF0ZS5leHRyYSA9IGhlcmVfb3AgJiAxNTsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBESVNURVhUOwogICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgICBjYXNlIERJU1RFWFQ6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZXh0cmEpIHsKICAgICAgICAgICAgICAgICAgbiA9IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IG4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0YXRlLm9mZnNldCArPSBob2xkICYgKDEgPDwgc3RhdGUuZXh0cmEpIC0gMTsKICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICBiaXRzIC09IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9mZnNldCA+IHN0YXRlLmRtYXgpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBNQVRDSDsKICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgY2FzZSBNQVRDSDoKICAgICAgICAgICAgICAgIGlmIChsZWZ0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvcHkgPSBfb3V0IC0gbGVmdDsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5vZmZzZXQgPiBjb3B5KSB7CiAgICAgICAgICAgICAgICAgIGNvcHkgPSBzdGF0ZS5vZmZzZXQgLSBjb3B5OwogICAgICAgICAgICAgICAgICBpZiAoY29weSA+IHN0YXRlLndoYXZlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnNhbmUpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgZGlzdGFuY2UgdG9vIGZhciBiYWNrIjsKICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGNvcHkgPiBzdGF0ZS53bmV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgLT0gc3RhdGUud25leHQ7CiAgICAgICAgICAgICAgICAgICAgZnJvbSA9IHN0YXRlLndzaXplIC0gY29weTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmcm9tID0gc3RhdGUud25leHQgLSBjb3B5OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gc3RhdGUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY29weSA9IHN0YXRlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmcm9tX3NvdXJjZSA9IHN0YXRlLndpbmRvdzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZyb21fc291cmNlID0gb3V0cHV0OwogICAgICAgICAgICAgICAgICBmcm9tID0gcHV0IC0gc3RhdGUub2Zmc2V0OwogICAgICAgICAgICAgICAgICBjb3B5ID0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNvcHkgPiBsZWZ0KSB7CiAgICAgICAgICAgICAgICAgIGNvcHkgPSBsZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGVmdCAtPSBjb3B5OwogICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoIC09IGNvcHk7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIG91dHB1dFtwdXQrK10gPSBmcm9tX3NvdXJjZVtmcm9tKytdOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoLS1jb3B5KTsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgTElUOgogICAgICAgICAgICAgICAgaWYgKGxlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb3V0cHV0W3B1dCsrXSA9IHN0YXRlLmxlbmd0aDsKICAgICAgICAgICAgICAgIGxlZnQtLTsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBMRU47CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIENIRUNLOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLndyYXApIHsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkIHw9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgX291dCAtPSBsZWZ0OwogICAgICAgICAgICAgICAgICBzdHJtLnRvdGFsX291dCArPSBfb3V0OwogICAgICAgICAgICAgICAgICBzdGF0ZS50b3RhbCArPSBfb3V0OwogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCAmIDQgJiYgX291dCkgewogICAgICAgICAgICAgICAgICAgIHN0cm0uYWRsZXIgPSBzdGF0ZS5jaGVjayA9IC8qVVBEQVRFX0NIRUNLKHN0YXRlLmNoZWNrLCBwdXQgLSBfb3V0LCBfb3V0KTsqLwogICAgICAgICAgICAgICAgICAgIHN0YXRlLmZsYWdzID8gY3JjMzIoc3RhdGUuY2hlY2ssIG91dHB1dCwgX291dCwgcHV0IC0gX291dCkgOiBhZGxlcjMyKHN0YXRlLmNoZWNrLCBvdXRwdXQsIF9vdXQsIHB1dCAtIF9vdXQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIF9vdXQgPSBsZWZ0OwogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCAmIDQgJiYgKHN0YXRlLmZsYWdzID8gaG9sZCA6IHpzd2FwMzIoaG9sZCkpICE9PSBzdGF0ZS5jaGVjaykgewogICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImluY29ycmVjdCBkYXRhIGNoZWNrIjsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhvbGQgPSAwOwogICAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBMRU5HVEg7CiAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICAgIGNhc2UgTEVOR1RIOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLndyYXAgJiYgc3RhdGUuZmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLndyYXAgJiA0ICYmIGhvbGQgIT09IChzdGF0ZS50b3RhbCAmIDQyOTQ5NjcyOTUpKSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW5jb3JyZWN0IGxlbmd0aCBjaGVjayI7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRE9ORTsKICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgY2FzZSBET05FOgogICAgICAgICAgICAgICAgcmV0ID0gWl9TVFJFQU1fRU5EOwogICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgIGNhc2UgQkFEOgogICAgICAgICAgICAgICAgcmV0ID0gWl9EQVRBX0VSUk9SOwogICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgIGNhc2UgTUVNOgogICAgICAgICAgICAgICAgcmV0dXJuIFpfTUVNX0VSUk9SOwogICAgICAgICAgICAgIGNhc2UgU1lOQzoKICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIHN0cm0ubmV4dF9vdXQgPSBwdXQ7CiAgICAgICAgc3RybS5hdmFpbF9vdXQgPSBsZWZ0OwogICAgICAgIHN0cm0ubmV4dF9pbiA9IG5leHQ7CiAgICAgICAgc3RybS5hdmFpbF9pbiA9IGhhdmU7CiAgICAgICAgc3RhdGUuaG9sZCA9IGhvbGQ7CiAgICAgICAgc3RhdGUuYml0cyA9IGJpdHM7CiAgICAgICAgaWYgKHN0YXRlLndzaXplIHx8IF9vdXQgIT09IHN0cm0uYXZhaWxfb3V0ICYmIHN0YXRlLm1vZGUgPCBCQUQgJiYgKHN0YXRlLm1vZGUgPCBDSEVDSyB8fCBmbHVzaCAhPT0gWl9GSU5JU0gpKSB7CiAgICAgICAgICBpZiAodXBkYXRld2luZG93KHN0cm0sIHN0cm0ub3V0cHV0LCBzdHJtLm5leHRfb3V0LCBfb3V0IC0gc3RybS5hdmFpbF9vdXQpKSB7CiAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBNRU07CiAgICAgICAgICAgIHJldHVybiBaX01FTV9FUlJPUjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgX2luIC09IHN0cm0uYXZhaWxfaW47CiAgICAgICAgX291dCAtPSBzdHJtLmF2YWlsX291dDsKICAgICAgICBzdHJtLnRvdGFsX2luICs9IF9pbjsKICAgICAgICBzdHJtLnRvdGFsX291dCArPSBfb3V0OwogICAgICAgIHN0YXRlLnRvdGFsICs9IF9vdXQ7CiAgICAgICAgaWYgKHN0YXRlLndyYXAgJiA0ICYmIF9vdXQpIHsKICAgICAgICAgIHN0cm0uYWRsZXIgPSBzdGF0ZS5jaGVjayA9IC8qVVBEQVRFX0NIRUNLKHN0YXRlLmNoZWNrLCBzdHJtLm5leHRfb3V0IC0gX291dCwgX291dCk7Ki8KICAgICAgICAgIHN0YXRlLmZsYWdzID8gY3JjMzIoc3RhdGUuY2hlY2ssIG91dHB1dCwgX291dCwgc3RybS5uZXh0X291dCAtIF9vdXQpIDogYWRsZXIzMihzdGF0ZS5jaGVjaywgb3V0cHV0LCBfb3V0LCBzdHJtLm5leHRfb3V0IC0gX291dCk7CiAgICAgICAgfQogICAgICAgIHN0cm0uZGF0YV90eXBlID0gc3RhdGUuYml0cyArIChzdGF0ZS5sYXN0ID8gNjQgOiAwKSArIChzdGF0ZS5tb2RlID09PSBUWVBFID8gMTI4IDogMCkgKyAoc3RhdGUubW9kZSA9PT0gTEVOXyB8fCBzdGF0ZS5tb2RlID09PSBDT1BZXyA/IDI1NiA6IDApOwogICAgICAgIGlmICgoX2luID09PSAwICYmIF9vdXQgPT09IDAgfHwgZmx1c2ggPT09IFpfRklOSVNIKSAmJiByZXQgPT09IFpfT0spIHsKICAgICAgICAgIHJldCA9IFpfQlVGX0VSUk9SOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZUVuZCA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGxldCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKHN0YXRlLndpbmRvdykgewogICAgICAgICAgc3RhdGUud2luZG93ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgc3RybS5zdGF0ZSA9IG51bGw7CiAgICAgICAgcmV0dXJuIFpfT0s7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlR2V0SGVhZGVyID0gKHN0cm0sIGhlYWQpID0+IHsKICAgICAgICBpZiAoaW5mbGF0ZVN0YXRlQ2hlY2soc3RybSkpIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3RhdGUgPSBzdHJtLnN0YXRlOwogICAgICAgIGlmICgoc3RhdGUud3JhcCAmIDIpID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIHN0YXRlLmhlYWQgPSBoZWFkOwogICAgICAgIGhlYWQuZG9uZSA9IGZhbHNlOwogICAgICAgIHJldHVybiBaX09LOwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZVNldERpY3Rpb25hcnkgPSAoc3RybSwgZGljdGlvbmFyeSkgPT4gewogICAgICAgIGNvbnN0IGRpY3RMZW5ndGggPSBkaWN0aW9uYXJ5Lmxlbmd0aDsKICAgICAgICBsZXQgc3RhdGU7CiAgICAgICAgbGV0IGRpY3RpZDsKICAgICAgICBsZXQgcmV0OwogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKHN0YXRlLndyYXAgIT09IDAgJiYgc3RhdGUubW9kZSAhPT0gRElDVCkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhdGUubW9kZSA9PT0gRElDVCkgewogICAgICAgICAgZGljdGlkID0gMTsKICAgICAgICAgIGRpY3RpZCA9IGFkbGVyMzIoZGljdGlkLCBkaWN0aW9uYXJ5LCBkaWN0TGVuZ3RoLCAwKTsKICAgICAgICAgIGlmIChkaWN0aWQgIT09IHN0YXRlLmNoZWNrKSB7CiAgICAgICAgICAgIHJldHVybiBaX0RBVEFfRVJST1I7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldCA9IHVwZGF0ZXdpbmRvdyhzdHJtLCBkaWN0aW9uYXJ5LCBkaWN0TGVuZ3RoLCBkaWN0TGVuZ3RoKTsKICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICBzdGF0ZS5tb2RlID0gTUVNOwogICAgICAgICAgcmV0dXJuIFpfTUVNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBzdGF0ZS5oYXZlZGljdCA9IDE7CiAgICAgICAgcmV0dXJuIFpfT0s7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVSZXNldCA9IGluZmxhdGVSZXNldDsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVJlc2V0MiA9IGluZmxhdGVSZXNldDI7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVSZXNldEtlZXAgPSBpbmZsYXRlUmVzZXRLZWVwOwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlSW5pdCA9IGluZmxhdGVJbml0OwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlSW5pdDIgPSBpbmZsYXRlSW5pdDI7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGUgPSBpbmZsYXRlOwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlRW5kID0gaW5mbGF0ZUVuZDsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZUdldEhlYWRlciA9IGluZmxhdGVHZXRIZWFkZXI7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVTZXREaWN0aW9uYXJ5ID0gaW5mbGF0ZVNldERpY3Rpb25hcnk7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVJbmZvID0gInBha28gaW5mbGF0ZSAoZnJvbSBOb2RlY2EgcHJvamVjdCkiOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvdXRpbHMvY29tbW9uLmpzCiAgdmFyIHJlcXVpcmVfY29tbW9uID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3V0aWxzL2NvbW1vbi5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBfaGFzID0gKG9iaiwga2V5KSA9PiB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSk7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzLmFzc2lnbiA9IGZ1bmN0aW9uKG9iaikgewogICAgICAgIGNvbnN0IHNvdXJjZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIHdoaWxlIChzb3VyY2VzLmxlbmd0aCkgewogICAgICAgICAgY29uc3Qgc291cmNlID0gc291cmNlcy5zaGlmdCgpOwogICAgICAgICAgaWYgKCFzb3VyY2UpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHNvdXJjZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihzb3VyY2UgKyAibXVzdCBiZSBub24tb2JqZWN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGNvbnN0IHAgaW4gc291cmNlKSB7CiAgICAgICAgICAgIGlmIChfaGFzKHNvdXJjZSwgcCkpIHsKICAgICAgICAgICAgICBvYmpbcF0gPSBzb3VyY2VbcF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMuZmxhdHRlbkNodW5rcyA9IChjaHVua3MpID0+IHsKICAgICAgICBsZXQgbGVuID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGNodW5rcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGxlbiArPSBjaHVua3NbaV0ubGVuZ3RoOwogICAgICAgIH0KICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgVWludDhBcnJheShsZW4pOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBwb3MgPSAwLCBsID0gY2h1bmtzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgbGV0IGNodW5rID0gY2h1bmtzW2ldOwogICAgICAgICAgcmVzdWx0LnNldChjaHVuaywgcG9zKTsKICAgICAgICAgIHBvcyArPSBjaHVuay5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi91dGlscy9zdHJpbmdzLmpzCiAgdmFyIHJlcXVpcmVfc3RyaW5ncyA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi91dGlscy9zdHJpbmdzLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIFNUUl9BUFBMWV9VSUFfT0sgPSB0cnVlOwogICAgICB0cnkgewogICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgbmV3IFVpbnQ4QXJyYXkoMSkpOwogICAgICB9IGNhdGNoIChfXykgewogICAgICAgIFNUUl9BUFBMWV9VSUFfT0sgPSBmYWxzZTsKICAgICAgfQogICAgICB2YXIgX3V0ZjhsZW4gPSBuZXcgVWludDhBcnJheSgyNTYpOwogICAgICBmb3IgKGxldCBxID0gMDsgcSA8IDI1NjsgcSsrKSB7CiAgICAgICAgX3V0ZjhsZW5bcV0gPSBxID49IDI1MiA/IDYgOiBxID49IDI0OCA/IDUgOiBxID49IDI0MCA/IDQgOiBxID49IDIyNCA/IDMgOiBxID49IDE5MiA/IDIgOiAxOwogICAgICB9CiAgICAgIF91dGY4bGVuWzI1NF0gPSBfdXRmOGxlblsyNTRdID0gMTsKICAgICAgbW9kdWxlLmV4cG9ydHMuc3RyaW5nMmJ1ZiA9IChzdHIpID0+IHsKICAgICAgICBpZiAodHlwZW9mIFRleHRFbmNvZGVyID09PSAiZnVuY3Rpb24iICYmIFRleHRFbmNvZGVyLnByb3RvdHlwZS5lbmNvZGUpIHsKICAgICAgICAgIHJldHVybiBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3RyKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ1ZiwgYywgYzIsIG1fcG9zLCBpLCBzdHJfbGVuID0gc3RyLmxlbmd0aCwgYnVmX2xlbiA9IDA7CiAgICAgICAgZm9yIChtX3BvcyA9IDA7IG1fcG9zIDwgc3RyX2xlbjsgbV9wb3MrKykgewogICAgICAgICAgYyA9IHN0ci5jaGFyQ29kZUF0KG1fcG9zKTsKICAgICAgICAgIGlmICgoYyAmIDY0NTEyKSA9PT0gNTUyOTYgJiYgbV9wb3MgKyAxIDwgc3RyX2xlbikgewogICAgICAgICAgICBjMiA9IHN0ci5jaGFyQ29kZUF0KG1fcG9zICsgMSk7CiAgICAgICAgICAgIGlmICgoYzIgJiA2NDUxMikgPT09IDU2MzIwKSB7CiAgICAgICAgICAgICAgYyA9IDY1NTM2ICsgKGMgLSA1NTI5NiA8PCAxMCkgKyAoYzIgLSA1NjMyMCk7CiAgICAgICAgICAgICAgbV9wb3MrKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnVmX2xlbiArPSBjIDwgMTI4ID8gMSA6IGMgPCAyMDQ4ID8gMiA6IGMgPCA2NTUzNiA/IDMgOiA0OwogICAgICAgIH0KICAgICAgICBidWYgPSBuZXcgVWludDhBcnJheShidWZfbGVuKTsKICAgICAgICBmb3IgKGkgPSAwLCBtX3BvcyA9IDA7IGkgPCBidWZfbGVuOyBtX3BvcysrKSB7CiAgICAgICAgICBjID0gc3RyLmNoYXJDb2RlQXQobV9wb3MpOwogICAgICAgICAgaWYgKChjICYgNjQ1MTIpID09PSA1NTI5NiAmJiBtX3BvcyArIDEgPCBzdHJfbGVuKSB7CiAgICAgICAgICAgIGMyID0gc3RyLmNoYXJDb2RlQXQobV9wb3MgKyAxKTsKICAgICAgICAgICAgaWYgKChjMiAmIDY0NTEyKSA9PT0gNTYzMjApIHsKICAgICAgICAgICAgICBjID0gNjU1MzYgKyAoYyAtIDU1Mjk2IDw8IDEwKSArIChjMiAtIDU2MzIwKTsKICAgICAgICAgICAgICBtX3BvcysrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYyA8IDEyOCkgewogICAgICAgICAgICBidWZbaSsrXSA9IGM7CiAgICAgICAgICB9IGVsc2UgaWYgKGMgPCAyMDQ4KSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTkyIHwgYyA+Pj4gNjsKICAgICAgICAgICAgYnVmW2krK10gPSAxMjggfCBjICYgNjM7CiAgICAgICAgICB9IGVsc2UgaWYgKGMgPCA2NTUzNikgewogICAgICAgICAgICBidWZbaSsrXSA9IDIyNCB8IGMgPj4+IDEyOwogICAgICAgICAgICBidWZbaSsrXSA9IDEyOCB8IGMgPj4+IDYgJiA2MzsKICAgICAgICAgICAgYnVmW2krK10gPSAxMjggfCBjICYgNjM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBidWZbaSsrXSA9IDI0MCB8IGMgPj4+IDE4OwogICAgICAgICAgICBidWZbaSsrXSA9IDEyOCB8IGMgPj4+IDEyICYgNjM7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyA+Pj4gNiAmIDYzOwogICAgICAgICAgICBidWZbaSsrXSA9IDEyOCB8IGMgJiA2MzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1ZjsKICAgICAgfTsKICAgICAgdmFyIGJ1ZjJiaW5zdHJpbmcgPSAoYnVmLCBsZW4pID0+IHsKICAgICAgICBpZiAobGVuIDwgNjU1MzQpIHsKICAgICAgICAgIGlmIChidWYuc3ViYXJyYXkgJiYgU1RSX0FQUExZX1VJQV9PSykgewogICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBidWYubGVuZ3RoID09PSBsZW4gPyBidWYgOiBidWYuc3ViYXJyYXkoMCwgbGVuKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCByZXN1bHQgPSAiIjsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICByZXN1bHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBtb2R1bGUuZXhwb3J0cy5idWYyc3RyaW5nID0gKGJ1ZiwgbWF4MykgPT4gewogICAgICAgIGNvbnN0IGxlbiA9IG1heDMgfHwgYnVmLmxlbmd0aDsKICAgICAgICBpZiAodHlwZW9mIFRleHREZWNvZGVyID09PSAiZnVuY3Rpb24iICYmIFRleHREZWNvZGVyLnByb3RvdHlwZS5kZWNvZGUpIHsKICAgICAgICAgIHJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoYnVmLnN1YmFycmF5KDAsIG1heDMpKTsKICAgICAgICB9CiAgICAgICAgbGV0IGksIG91dDsKICAgICAgICBjb25zdCB1dGYxNmJ1ZiA9IG5ldyBBcnJheShsZW4gKiAyKTsKICAgICAgICBmb3IgKG91dCA9IDAsIGkgPSAwOyBpIDwgbGVuOyApIHsKICAgICAgICAgIGxldCBjID0gYnVmW2krK107CiAgICAgICAgICBpZiAoYyA8IDEyOCkgewogICAgICAgICAgICB1dGYxNmJ1ZltvdXQrK10gPSBjOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBjX2xlbiA9IF91dGY4bGVuW2NdOwogICAgICAgICAgaWYgKGNfbGVuID4gNCkgewogICAgICAgICAgICB1dGYxNmJ1ZltvdXQrK10gPSA2NTUzMzsKICAgICAgICAgICAgaSArPSBjX2xlbiAtIDE7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgYyAmPSBjX2xlbiA9PT0gMiA/IDMxIDogY19sZW4gPT09IDMgPyAxNSA6IDc7CiAgICAgICAgICB3aGlsZSAoY19sZW4gPiAxICYmIGkgPCBsZW4pIHsKICAgICAgICAgICAgYyA9IGMgPDwgNiB8IGJ1ZltpKytdICYgNjM7CiAgICAgICAgICAgIGNfbGVuLS07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY19sZW4gPiAxKSB7CiAgICAgICAgICAgIHV0ZjE2YnVmW291dCsrXSA9IDY1NTMzOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjIDwgNjU1MzYpIHsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gYzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGMgLT0gNjU1MzY7CiAgICAgICAgICAgIHV0ZjE2YnVmW291dCsrXSA9IDU1Mjk2IHwgYyA+PiAxMCAmIDEwMjM7CiAgICAgICAgICAgIHV0ZjE2YnVmW291dCsrXSA9IDU2MzIwIHwgYyAmIDEwMjM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBidWYyYmluc3RyaW5nKHV0ZjE2YnVmLCBvdXQpOwogICAgICB9OwogICAgICBtb2R1bGUuZXhwb3J0cy51dGY4Ym9yZGVyID0gKGJ1ZiwgbWF4MykgPT4gewogICAgICAgIG1heDMgPSBtYXgzIHx8IGJ1Zi5sZW5ndGg7CiAgICAgICAgaWYgKG1heDMgPiBidWYubGVuZ3RoKSB7CiAgICAgICAgICBtYXgzID0gYnVmLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgbGV0IHBvcyA9IG1heDMgLSAxOwogICAgICAgIHdoaWxlIChwb3MgPj0gMCAmJiAoYnVmW3Bvc10gJiAxOTIpID09PSAxMjgpIHsKICAgICAgICAgIHBvcy0tOwogICAgICAgIH0KICAgICAgICBpZiAocG9zIDwgMCkgewogICAgICAgICAgcmV0dXJuIG1heDM7CiAgICAgICAgfQogICAgICAgIGlmIChwb3MgPT09IDApIHsKICAgICAgICAgIHJldHVybiBtYXgzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcG9zICsgX3V0ZjhsZW5bYnVmW3Bvc11dID4gbWF4MyA/IHBvcyA6IG1heDM7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL21lc3NhZ2VzLmpzCiAgdmFyIHJlcXVpcmVfbWVzc2FnZXMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9tZXNzYWdlcy5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICAgIDI6ICJuZWVkIGRpY3Rpb25hcnkiLAogICAgICAgIC8qIFpfTkVFRF9ESUNUICAgICAgIDIgICovCiAgICAgICAgMTogInN0cmVhbSBlbmQiLAogICAgICAgIC8qIFpfU1RSRUFNX0VORCAgICAgIDEgICovCiAgICAgICAgMDogIiIsCiAgICAgICAgLyogWl9PSyAgICAgICAgICAgICAgMCAgKi8KICAgICAgICAiLTEiOiAiZmlsZSBlcnJvciIsCiAgICAgICAgLyogWl9FUlJOTyAgICAgICAgICgtMSkgKi8KICAgICAgICAiLTIiOiAic3RyZWFtIGVycm9yIiwKICAgICAgICAvKiBaX1NUUkVBTV9FUlJPUiAgKC0yKSAqLwogICAgICAgICItMyI6ICJkYXRhIGVycm9yIiwKICAgICAgICAvKiBaX0RBVEFfRVJST1IgICAgKC0zKSAqLwogICAgICAgICItNCI6ICJpbnN1ZmZpY2llbnQgbWVtb3J5IiwKICAgICAgICAvKiBaX01FTV9FUlJPUiAgICAgKC00KSAqLwogICAgICAgICItNSI6ICJidWZmZXIgZXJyb3IiLAogICAgICAgIC8qIFpfQlVGX0VSUk9SICAgICAoLTUpICovCiAgICAgICAgIi02IjogImluY29tcGF0aWJsZSB2ZXJzaW9uIgogICAgICAgIC8qIFpfVkVSU0lPTl9FUlJPUiAoLTYpICovCiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL3pzdHJlYW0uanMKICB2YXIgcmVxdWlyZV96c3RyZWFtID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvenN0cmVhbS5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIGZ1bmN0aW9uIFpTdHJlYW0oKSB7CiAgICAgICAgdGhpcy5pbnB1dCA9IG51bGw7CiAgICAgICAgdGhpcy5uZXh0X2luID0gMDsKICAgICAgICB0aGlzLmF2YWlsX2luID0gMDsKICAgICAgICB0aGlzLnRvdGFsX2luID0gMDsKICAgICAgICB0aGlzLm91dHB1dCA9IG51bGw7CiAgICAgICAgdGhpcy5uZXh0X291dCA9IDA7CiAgICAgICAgdGhpcy5hdmFpbF9vdXQgPSAwOwogICAgICAgIHRoaXMudG90YWxfb3V0ID0gMDsKICAgICAgICB0aGlzLm1zZyA9ICIiOwogICAgICAgIHRoaXMuc3RhdGUgPSBudWxsOwogICAgICAgIHRoaXMuZGF0YV90eXBlID0gMjsKICAgICAgICB0aGlzLmFkbGVyID0gMDsKICAgICAgfQogICAgICBtb2R1bGUuZXhwb3J0cyA9IFpTdHJlYW07CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2d6aGVhZGVyLmpzCiAgdmFyIHJlcXVpcmVfZ3poZWFkZXIgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9nemhlYWRlci5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIGZ1bmN0aW9uIEdaaGVhZGVyKCkgewogICAgICAgIHRoaXMudGV4dCA9IDA7CiAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICB0aGlzLnhmbGFncyA9IDA7CiAgICAgICAgdGhpcy5vcyA9IDA7CiAgICAgICAgdGhpcy5leHRyYSA9IG51bGw7CiAgICAgICAgdGhpcy5leHRyYV9sZW4gPSAwOwogICAgICAgIHRoaXMubmFtZSA9ICIiOwogICAgICAgIHRoaXMuY29tbWVudCA9ICIiOwogICAgICAgIHRoaXMuaGNyYyA9IDA7CiAgICAgICAgdGhpcy5kb25lID0gZmFsc2U7CiAgICAgIH0KICAgICAgbW9kdWxlLmV4cG9ydHMgPSBHWmhlYWRlcjsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL2luZmxhdGUuanMKICB2YXIgcmVxdWlyZV9pbmZsYXRlMiA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi9pbmZsYXRlLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIHpsaWJfaW5mbGF0ZSA9IHJlcXVpcmVfaW5mbGF0ZSgpOwogICAgICB2YXIgdXRpbHMgPSByZXF1aXJlX2NvbW1vbigpOwogICAgICB2YXIgc3RyaW5ncyA9IHJlcXVpcmVfc3RyaW5ncygpOwogICAgICB2YXIgbXNnID0gcmVxdWlyZV9tZXNzYWdlcygpOwogICAgICB2YXIgWlN0cmVhbSA9IHJlcXVpcmVfenN0cmVhbSgpOwogICAgICB2YXIgR1poZWFkZXIgPSByZXF1aXJlX2d6aGVhZGVyKCk7CiAgICAgIHZhciB0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CiAgICAgIHZhciB7CiAgICAgICAgWl9OT19GTFVTSCwKICAgICAgICBaX0ZJTklTSCwKICAgICAgICBaX09LLAogICAgICAgIFpfU1RSRUFNX0VORCwKICAgICAgICBaX05FRURfRElDVCwKICAgICAgICBaX1NUUkVBTV9FUlJPUiwKICAgICAgICBaX0RBVEFfRVJST1IsCiAgICAgICAgWl9NRU1fRVJST1IKICAgICAgfSA9IHJlcXVpcmVfY29uc3RhbnRzKCk7CiAgICAgIGZ1bmN0aW9uIEluZmxhdGUob3B0aW9ucykgewogICAgICAgIHRoaXMub3B0aW9ucyA9IHV0aWxzLmFzc2lnbih7CiAgICAgICAgICBjaHVua1NpemU6IDEwMjQgKiA2NCwKICAgICAgICAgIHdpbmRvd0JpdHM6IDE1LAogICAgICAgICAgdG86ICIiCiAgICAgICAgfSwgb3B0aW9ucyB8fCB7fSk7CiAgICAgICAgY29uc3Qgb3B0ID0gdGhpcy5vcHRpb25zOwogICAgICAgIGlmIChvcHQucmF3ICYmIG9wdC53aW5kb3dCaXRzID49IDAgJiYgb3B0LndpbmRvd0JpdHMgPCAxNikgewogICAgICAgICAgb3B0LndpbmRvd0JpdHMgPSAtb3B0LndpbmRvd0JpdHM7CiAgICAgICAgICBpZiAob3B0LndpbmRvd0JpdHMgPT09IDApIHsKICAgICAgICAgICAgb3B0LndpbmRvd0JpdHMgPSAtMTU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChvcHQud2luZG93Qml0cyA+PSAwICYmIG9wdC53aW5kb3dCaXRzIDwgMTYgJiYgIShvcHRpb25zICYmIG9wdGlvbnMud2luZG93Qml0cykpIHsKICAgICAgICAgIG9wdC53aW5kb3dCaXRzICs9IDMyOwogICAgICAgIH0KICAgICAgICBpZiAob3B0LndpbmRvd0JpdHMgPiAxNSAmJiBvcHQud2luZG93Qml0cyA8IDQ4KSB7CiAgICAgICAgICBpZiAoKG9wdC53aW5kb3dCaXRzICYgMTUpID09PSAwKSB7CiAgICAgICAgICAgIG9wdC53aW5kb3dCaXRzIHw9IDE1OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmVyciA9IDA7CiAgICAgICAgdGhpcy5tc2cgPSAiIjsKICAgICAgICB0aGlzLmVuZGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5jaHVua3MgPSBbXTsKICAgICAgICB0aGlzLnN0cm0gPSBuZXcgWlN0cmVhbSgpOwogICAgICAgIHRoaXMuc3RybS5hdmFpbF9vdXQgPSAwOwogICAgICAgIGxldCBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZUluaXQyKAogICAgICAgICAgdGhpcy5zdHJtLAogICAgICAgICAgb3B0LndpbmRvd0JpdHMKICAgICAgICApOwogICAgICAgIGlmIChzdGF0dXMgIT09IFpfT0spIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2dbc3RhdHVzXSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaGVhZGVyID0gbmV3IEdaaGVhZGVyKCk7CiAgICAgICAgemxpYl9pbmZsYXRlLmluZmxhdGVHZXRIZWFkZXIodGhpcy5zdHJtLCB0aGlzLmhlYWRlcik7CiAgICAgICAgaWYgKG9wdC5kaWN0aW9uYXJ5KSB7CiAgICAgICAgICBpZiAodHlwZW9mIG9wdC5kaWN0aW9uYXJ5ID09PSAic3RyaW5nIikgewogICAgICAgICAgICBvcHQuZGljdGlvbmFyeSA9IHN0cmluZ3Muc3RyaW5nMmJ1ZihvcHQuZGljdGlvbmFyeSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRvU3RyaW5nLmNhbGwob3B0LmRpY3Rpb25hcnkpID09PSAiW29iamVjdCBBcnJheUJ1ZmZlcl0iKSB7CiAgICAgICAgICAgIG9wdC5kaWN0aW9uYXJ5ID0gbmV3IFVpbnQ4QXJyYXkob3B0LmRpY3Rpb25hcnkpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9wdC5yYXcpIHsKICAgICAgICAgICAgc3RhdHVzID0gemxpYl9pbmZsYXRlLmluZmxhdGVTZXREaWN0aW9uYXJ5KHRoaXMuc3RybSwgb3B0LmRpY3Rpb25hcnkpOwogICAgICAgICAgICBpZiAoc3RhdHVzICE9PSBaX09LKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZ1tzdGF0dXNdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBJbmZsYXRlLnByb3RvdHlwZS5wdXNoID0gZnVuY3Rpb24oZGF0YSwgZmx1c2hfbW9kZSkgewogICAgICAgIGNvbnN0IHN0cm0gPSB0aGlzLnN0cm07CiAgICAgICAgY29uc3QgY2h1bmtTaXplID0gdGhpcy5vcHRpb25zLmNodW5rU2l6ZTsKICAgICAgICBjb25zdCBkaWN0aW9uYXJ5ID0gdGhpcy5vcHRpb25zLmRpY3Rpb25hcnk7CiAgICAgICAgbGV0IHN0YXR1cywgX2ZsdXNoX21vZGUsIGxhc3RfYXZhaWxfb3V0OwogICAgICAgIGlmICh0aGlzLmVuZGVkKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGZsdXNoX21vZGUgPT09IH5+Zmx1c2hfbW9kZSkgX2ZsdXNoX21vZGUgPSBmbHVzaF9tb2RlOwogICAgICAgIGVsc2UgX2ZsdXNoX21vZGUgPSBmbHVzaF9tb2RlID09PSB0cnVlID8gWl9GSU5JU0ggOiBaX05PX0ZMVVNIOwogICAgICAgIGlmICh0b1N0cmluZy5jYWxsKGRhdGEpID09PSAiW29iamVjdCBBcnJheUJ1ZmZlcl0iKSB7CiAgICAgICAgICBzdHJtLmlucHV0ID0gbmV3IFVpbnQ4QXJyYXkoZGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0cm0uaW5wdXQgPSBkYXRhOwogICAgICAgIH0KICAgICAgICBzdHJtLm5leHRfaW4gPSAwOwogICAgICAgIHN0cm0uYXZhaWxfaW4gPSBzdHJtLmlucHV0Lmxlbmd0aDsKICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgIGlmIChzdHJtLmF2YWlsX291dCA9PT0gMCkgewogICAgICAgICAgICBzdHJtLm91dHB1dCA9IG5ldyBVaW50OEFycmF5KGNodW5rU2l6ZSk7CiAgICAgICAgICAgIHN0cm0ubmV4dF9vdXQgPSAwOwogICAgICAgICAgICBzdHJtLmF2YWlsX291dCA9IGNodW5rU2l6ZTsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlKHN0cm0sIF9mbHVzaF9tb2RlKTsKICAgICAgICAgIGlmIChzdGF0dXMgPT09IFpfTkVFRF9ESUNUICYmIGRpY3Rpb25hcnkpIHsKICAgICAgICAgICAgc3RhdHVzID0gemxpYl9pbmZsYXRlLmluZmxhdGVTZXREaWN0aW9uYXJ5KHN0cm0sIGRpY3Rpb25hcnkpOwogICAgICAgICAgICBpZiAoc3RhdHVzID09PSBaX09LKSB7CiAgICAgICAgICAgICAgc3RhdHVzID0gemxpYl9pbmZsYXRlLmluZmxhdGUoc3RybSwgX2ZsdXNoX21vZGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gWl9EQVRBX0VSUk9SKSB7CiAgICAgICAgICAgICAgc3RhdHVzID0gWl9ORUVEX0RJQ1Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChzdHJtLmF2YWlsX2luID4gMCAmJiBzdGF0dXMgPT09IFpfU1RSRUFNX0VORCAmJiBzdHJtLnN0YXRlLndyYXAgPiAwICYmIGRhdGFbc3RybS5uZXh0X2luXSAhPT0gMCkgewogICAgICAgICAgICB6bGliX2luZmxhdGUuaW5mbGF0ZVJlc2V0KHN0cm0pOwogICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZShzdHJtLCBfZmx1c2hfbW9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHN0YXR1cykgewogICAgICAgICAgICBjYXNlIFpfU1RSRUFNX0VSUk9SOgogICAgICAgICAgICBjYXNlIFpfREFUQV9FUlJPUjoKICAgICAgICAgICAgY2FzZSBaX05FRURfRElDVDoKICAgICAgICAgICAgY2FzZSBaX01FTV9FUlJPUjoKICAgICAgICAgICAgICB0aGlzLm9uRW5kKHN0YXR1cyk7CiAgICAgICAgICAgICAgdGhpcy5lbmRlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgbGFzdF9hdmFpbF9vdXQgPSBzdHJtLmF2YWlsX291dDsKICAgICAgICAgIGlmIChzdHJtLm5leHRfb3V0KSB7CiAgICAgICAgICAgIGlmIChzdHJtLmF2YWlsX291dCA9PT0gMCB8fCBzdGF0dXMgPT09IFpfU1RSRUFNX0VORCkgewogICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMudG8gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBsZXQgbmV4dF9vdXRfdXRmOCA9IHN0cmluZ3MudXRmOGJvcmRlcihzdHJtLm91dHB1dCwgc3RybS5uZXh0X291dCk7CiAgICAgICAgICAgICAgICBsZXQgdGFpbCA9IHN0cm0ubmV4dF9vdXQgLSBuZXh0X291dF91dGY4OwogICAgICAgICAgICAgICAgbGV0IHV0ZjhzdHIgPSBzdHJpbmdzLmJ1ZjJzdHJpbmcoc3RybS5vdXRwdXQsIG5leHRfb3V0X3V0ZjgpOwogICAgICAgICAgICAgICAgc3RybS5uZXh0X291dCA9IHRhaWw7CiAgICAgICAgICAgICAgICBzdHJtLmF2YWlsX291dCA9IGNodW5rU2l6ZSAtIHRhaWw7CiAgICAgICAgICAgICAgICBpZiAodGFpbCkgc3RybS5vdXRwdXQuc2V0KHN0cm0ub3V0cHV0LnN1YmFycmF5KG5leHRfb3V0X3V0ZjgsIG5leHRfb3V0X3V0ZjggKyB0YWlsKSwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLm9uRGF0YSh1dGY4c3RyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5vbkRhdGEoc3RybS5vdXRwdXQubGVuZ3RoID09PSBzdHJtLm5leHRfb3V0ID8gc3RybS5vdXRwdXQgOiBzdHJtLm91dHB1dC5zdWJhcnJheSgwLCBzdHJtLm5leHRfb3V0KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3RhdHVzID09PSBaX09LICYmIGxhc3RfYXZhaWxfb3V0ID09PSAwKSBjb250aW51ZTsKICAgICAgICAgIGlmIChzdGF0dXMgPT09IFpfU1RSRUFNX0VORCkgewogICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZUVuZCh0aGlzLnN0cm0pOwogICAgICAgICAgICB0aGlzLm9uRW5kKHN0YXR1cyk7CiAgICAgICAgICAgIHRoaXMuZW5kZWQgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdHJtLmF2YWlsX2luID09PSAwKSBicmVhazsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH07CiAgICAgIEluZmxhdGUucHJvdG90eXBlLm9uRGF0YSA9IGZ1bmN0aW9uKGNodW5rKSB7CiAgICAgICAgdGhpcy5jaHVua3MucHVzaChjaHVuayk7CiAgICAgIH07CiAgICAgIEluZmxhdGUucHJvdG90eXBlLm9uRW5kID0gZnVuY3Rpb24oc3RhdHVzKSB7CiAgICAgICAgaWYgKHN0YXR1cyA9PT0gWl9PSykgewogICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50byA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhpcy5yZXN1bHQgPSB0aGlzLmNodW5rcy5qb2luKCIiKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMucmVzdWx0ID0gdXRpbHMuZmxhdHRlbkNodW5rcyh0aGlzLmNodW5rcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuY2h1bmtzID0gW107CiAgICAgICAgdGhpcy5lcnIgPSBzdGF0dXM7CiAgICAgICAgdGhpcy5tc2cgPSB0aGlzLnN0cm0ubXNnOwogICAgICB9OwogICAgICBmdW5jdGlvbiBpbmZsYXRlKGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgaW5mbGF0b3IgPSBuZXcgSW5mbGF0ZShvcHRpb25zKTsKICAgICAgICBpbmZsYXRvci5wdXNoKGlucHV0KTsKICAgICAgICBpZiAoaW5mbGF0b3IuZXJyKSB0aHJvdyBpbmZsYXRvci5tc2cgfHwgbXNnW2luZmxhdG9yLmVycl07CiAgICAgICAgcmV0dXJuIGluZmxhdG9yLnJlc3VsdDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbmZsYXRlUmF3KGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgb3B0aW9ucy5yYXcgPSB0cnVlOwogICAgICAgIHJldHVybiBpbmZsYXRlKGlucHV0LCBvcHRpb25zKTsKICAgICAgfQogICAgICBtb2R1bGUuZXhwb3J0cy5JbmZsYXRlID0gSW5mbGF0ZTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZSA9IGluZmxhdGU7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVSYXcgPSBpbmZsYXRlUmF3OwogICAgICBtb2R1bGUuZXhwb3J0cy51bmd6aXAgPSBpbmZsYXRlOwogICAgICBtb2R1bGUuZXhwb3J0cy5jb25zdGFudHMgPSByZXF1aXJlX2NvbnN0YW50cygpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0LmpzCiAgdmFyIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldF9leHBvcnRzID0ge307CiAgX19leHBvcnQoZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0KHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHR5cGUgPSBUeXBlcy5mcm9tU3RyaW5nKHBhcmFtZXRlcnMudHlwZSk7CiAgICBsZXQgYnVmZmVyID0gcGFyYW1ldGVycy5idWZmZXI7CiAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhX2RlZmF1bHQocGFyYW1ldGVycy5rZXksIGJ1ZmZlcik7CiAgICBjb25zdCB1bmNvbXByZXNzZWRUZXJyYWluID0gdW5jb21wcmVzc1BhY2tldChidWZmZXIpOwogICAgYnVmZmVyID0gdW5jb21wcmVzc2VkVGVycmFpbi5idWZmZXI7CiAgICBjb25zdCBsZW5ndGggPSB1bmNvbXByZXNzZWRUZXJyYWluLmxlbmd0aDsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlIFR5cGVzLk1FVEFEQVRBOgogICAgICAgIHJldHVybiBwcm9jZXNzTWV0YWRhdGEoYnVmZmVyLCBsZW5ndGgsIHBhcmFtZXRlcnMucXVhZEtleSk7CiAgICAgIGNhc2UgVHlwZXMuVEVSUkFJTjoKICAgICAgICByZXR1cm4gcHJvY2Vzc1RlcnJhaW4oYnVmZmVyLCBsZW5ndGgsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgICBjYXNlIFR5cGVzLkRCUk9PVDoKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goYnVmZmVyKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgYnVmZmVyCiAgICAgICAgfTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcHJvY2Vzc01ldGFkYXRhKGJ1ZmZlciwgdG90YWxTaXplLCBxdWFkS2V5KSB7CiAgICBjb25zdCBkdiA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBjb25zdCBtYWdpYyA9IGR2LmdldFVpbnQzMihvZmZzZXQsIHRydWUpOwogICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQzMjI7CiAgICBpZiAobWFnaWMgIT09IHF0TWFnaWMpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIG1hZ2ljIik7CiAgICB9CiAgICBjb25zdCBkYXRhVHlwZUlkID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGlmIChkYXRhVHlwZUlkICE9PSAxKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBkYXRhIHR5cGUuIE11c3QgYmUgMSBmb3IgUXVhZFRyZWVQYWNrZXQiKTsKICAgIH0KICAgIGNvbnN0IHF1YWRWZXJzaW9uID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGlmIChxdWFkVmVyc2lvbiAhPT0gMikgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIkludmFsaWQgUXVhZFRyZWVQYWNrZXQgdmVyc2lvbi4gT25seSB2ZXJzaW9uIDIgaXMgc3VwcG9ydGVkLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG51bUluc3RhbmNlcyA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgY29uc3QgZGF0YUluc3RhbmNlU2l6ZSA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgaWYgKGRhdGFJbnN0YW5jZVNpemUgIT09IDMyKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBpbnN0YW5jZSBzaXplLiIpOwogICAgfQogICAgY29uc3QgZGF0YUJ1ZmZlck9mZnNldCA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgY29uc3QgZGF0YUJ1ZmZlclNpemUgPSBkdi5nZXRJbnQzMihvZmZzZXQsIHRydWUpOwogICAgb2Zmc2V0ICs9IHNpemVPZkludDMyMjsKICAgIGNvbnN0IG1ldGFCdWZmZXJTaXplID0gZHYuZ2V0SW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjI7CiAgICBpZiAoZGF0YUJ1ZmZlck9mZnNldCAhPT0gbnVtSW5zdGFuY2VzICogZGF0YUluc3RhbmNlU2l6ZSArIG9mZnNldCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgZGF0YUJ1ZmZlck9mZnNldCIpOwogICAgfQogICAgaWYgKGRhdGFCdWZmZXJPZmZzZXQgKyBkYXRhQnVmZmVyU2l6ZSArIG1ldGFCdWZmZXJTaXplICE9PSB0b3RhbFNpemUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIHBhY2tldCBvZmZzZXRzIik7CiAgICB9CiAgICBjb25zdCBpbnN0YW5jZXMgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtSW5zdGFuY2VzOyArK2kpIHsKICAgICAgY29uc3QgYml0ZmllbGQgPSBkdi5nZXRVaW50OChvZmZzZXQpOwogICAgICArK29mZnNldDsKICAgICAgKytvZmZzZXQ7CiAgICAgIGNvbnN0IGNub2RlVmVyc2lvbiA9IGR2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgY29uc3QgaW1hZ2VWZXJzaW9uID0gZHYuZ2V0VWludDE2KG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MTYyOwogICAgICBjb25zdCB0ZXJyYWluVmVyc2lvbiA9IGR2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQxNjI7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MTYyOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgICBvZmZzZXQgKz0gODsKICAgICAgY29uc3QgaW1hZ2VQcm92aWRlciA9IGR2LmdldFVpbnQ4KG9mZnNldCsrKTsKICAgICAgY29uc3QgdGVycmFpblByb3ZpZGVyID0gZHYuZ2V0VWludDgob2Zmc2V0KyspOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgaW5zdGFuY2VzLnB1c2goCiAgICAgICAgbmV3IEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbl9kZWZhdWx0KAogICAgICAgICAgYml0ZmllbGQsCiAgICAgICAgICBjbm9kZVZlcnNpb24sCiAgICAgICAgICBpbWFnZVZlcnNpb24sCiAgICAgICAgICB0ZXJyYWluVmVyc2lvbiwKICAgICAgICAgIGltYWdlUHJvdmlkZXIsCiAgICAgICAgICB0ZXJyYWluUHJvdmlkZXIKICAgICAgICApCiAgICAgICk7CiAgICB9CiAgICBjb25zdCB0aWxlSW5mbyA9IFtdOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZ1bmN0aW9uIHBvcHVsYXRlVGlsZXMocGFyZW50S2V5LCBwYXJlbnQsIGxldmVsMikgewogICAgICBsZXQgaXNMZWFmID0gZmFsc2U7CiAgICAgIGlmIChsZXZlbDIgPT09IDQpIHsKICAgICAgICBpZiAocGFyZW50Lmhhc1N1YnRyZWUoKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpc0xlYWYgPSB0cnVlOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgKytpKSB7CiAgICAgICAgY29uc3QgY2hpbGRLZXkgPSBwYXJlbnRLZXkgKyBpLnRvU3RyaW5nKCk7CiAgICAgICAgaWYgKGlzTGVhZikgewogICAgICAgICAgdGlsZUluZm9bY2hpbGRLZXldID0gbnVsbDsKICAgICAgICB9IGVsc2UgaWYgKGxldmVsMiA8IDQpIHsKICAgICAgICAgIGlmICghcGFyZW50Lmhhc0NoaWxkKGkpKSB7CiAgICAgICAgICAgIHRpbGVJbmZvW2NoaWxkS2V5XSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaW5kZXggPT09IG51bUluc3RhbmNlcykgewogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbmNvcnJlY3QgbnVtYmVyIG9mIGluc3RhbmNlcyIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpbmRleCsrXTsKICAgICAgICAgICAgdGlsZUluZm9bY2hpbGRLZXldID0gaW5zdGFuY2U7CiAgICAgICAgICAgIHBvcHVsYXRlVGlsZXMoY2hpbGRLZXksIGluc3RhbmNlLCBsZXZlbDIgKyAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGxldCBsZXZlbCA9IDA7CiAgICBjb25zdCByb290ID0gaW5zdGFuY2VzW2luZGV4KytdOwogICAgaWYgKHF1YWRLZXkgPT09ICIiKSB7CiAgICAgICsrbGV2ZWw7CiAgICB9IGVsc2UgewogICAgICB0aWxlSW5mb1txdWFkS2V5XSA9IHJvb3Q7CiAgICB9CiAgICBwb3B1bGF0ZVRpbGVzKHF1YWRLZXksIHJvb3QsIGxldmVsKTsKICAgIHJldHVybiB0aWxlSW5mbzsKICB9CiAgZnVuY3Rpb24gcHJvY2Vzc1RlcnJhaW4oYnVmZmVyLCB0b3RhbFNpemUsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICBjb25zdCBhZHZhbmNlTWVzaCA9IGZ1bmN0aW9uKHBvcykgewogICAgICBmb3IgKGxldCBzdWIgPSAwOyBzdWIgPCBudW1TdWJNZXNoZXNQZXJNZXNoOyArK3N1YikgewogICAgICAgIGNvbnN0IHNpemUgPSBkdi5nZXRVaW50MzIocG9zLCB0cnVlKTsKICAgICAgICBwb3MgKz0gc2l6ZU9mVWludDMyMjsKICAgICAgICBwb3MgKz0gc2l6ZTsKICAgICAgICBpZiAocG9zID4gdG90YWxTaXplKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIk1hbGZvcm1lZCB0ZXJyYWluIHBhY2tldCBmb3VuZC4iKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHBvczsKICAgIH07CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGNvbnN0IHRlcnJhaW5NZXNoZXMgPSBbXTsKICAgIHdoaWxlICh0ZXJyYWluTWVzaGVzLmxlbmd0aCA8IG51bU1lc2hlc1BlclBhY2tldCkgewogICAgICBjb25zdCBzdGFydCA9IG9mZnNldDsKICAgICAgb2Zmc2V0ID0gYWR2YW5jZU1lc2gob2Zmc2V0KTsKICAgICAgY29uc3QgbWVzaCA9IGJ1ZmZlci5zbGljZShzdGFydCwgb2Zmc2V0KTsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKG1lc2gpOwogICAgICB0ZXJyYWluTWVzaGVzLnB1c2gobWVzaCk7CiAgICB9CiAgICByZXR1cm4gdGVycmFpbk1lc2hlczsKICB9CiAgZnVuY3Rpb24gdW5jb21wcmVzc1BhY2tldChkYXRhKSB7CiAgICBjb25zdCBkdiA9IG5ldyBEYXRhVmlldyhkYXRhKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgY29uc3QgbWFnaWMgPSBkdi5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZVaW50MzIyOwogICAgaWYgKG1hZ2ljICE9PSBjb21wcmVzc2VkTWFnaWMyICYmIG1hZ2ljICE9PSBjb21wcmVzc2VkTWFnaWNTd2FwMikgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgbWFnaWMiKTsKICAgIH0KICAgIGNvbnN0IHNpemUgPSBkdi5nZXRVaW50MzIob2Zmc2V0LCBtYWdpYyA9PT0gY29tcHJlc3NlZE1hZ2ljMik7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGNvbnN0IGNvbXByZXNzZWRQYWNrZXQgPSBuZXcgVWludDhBcnJheShkYXRhLCBvZmZzZXQpOwogICAgY29uc3QgdW5jb21wcmVzc2VkUGFja2V0ID0gaW1wb3J0X2luZmxhdGUuZGVmYXVsdC5pbmZsYXRlKGNvbXByZXNzZWRQYWNrZXQpOwogICAgaWYgKHVuY29tcHJlc3NlZFBhY2tldC5sZW5ndGggIT09IHNpemUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJTaXplIG9mIHBhY2tldCBkb2Vzbid0IG1hdGNoIGhlYWRlciIpOwogICAgfQogICAgcmV0dXJuIHVuY29tcHJlc3NlZFBhY2tldDsKICB9CiAgdmFyIGltcG9ydF9pbmZsYXRlLCBzaXplT2ZVaW50MTYyLCBzaXplT2ZJbnQzMjIsIHNpemVPZlVpbnQzMjIsIFR5cGVzLCBxdE1hZ2ljLCBudW1NZXNoZXNQZXJQYWNrZXQsIG51bVN1Yk1lc2hlc1Blck1lc2gsIGNvbXByZXNzZWRNYWdpYzIsIGNvbXByZXNzZWRNYWdpY1N3YXAyLCBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXRfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldC5qcyIoKSB7CiAgICAgIGluaXRfZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YSgpOwogICAgICBpbml0X0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbigpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBpbXBvcnRfaW5mbGF0ZSA9IF9fdG9FU00ocmVxdWlyZV9pbmZsYXRlMigpLCAxKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIHNpemVPZlVpbnQxNjIgPSBVaW50MTZBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mSW50MzIyID0gSW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mVWludDMyMiA9IFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBUeXBlcyA9IHsKICAgICAgICBNRVRBREFUQTogMCwKICAgICAgICBURVJSQUlOOiAxLAogICAgICAgIERCUk9PVDogMgogICAgICB9OwogICAgICBUeXBlcy5mcm9tU3RyaW5nID0gZnVuY3Rpb24ocykgewogICAgICAgIGlmIChzID09PSAiTWV0YWRhdGEiKSB7CiAgICAgICAgICByZXR1cm4gVHlwZXMuTUVUQURBVEE7CiAgICAgICAgfSBlbHNlIGlmIChzID09PSAiVGVycmFpbiIpIHsKICAgICAgICAgIHJldHVybiBUeXBlcy5URVJSQUlOOwogICAgICAgIH0gZWxzZSBpZiAocyA9PT0gIkRiUm9vdCIpIHsKICAgICAgICAgIHJldHVybiBUeXBlcy5EQlJPT1Q7CiAgICAgICAgfQogICAgICB9OwogICAgICBxdE1hZ2ljID0gMzIzMDE7CiAgICAgIG51bU1lc2hlc1BlclBhY2tldCA9IDU7CiAgICAgIG51bVN1Yk1lc2hlc1Blck1lc2ggPSA0OwogICAgICBjb21wcmVzc2VkTWFnaWMyID0gMTk1MzAyOTgwNTsKICAgICAgY29tcHJlc3NlZE1hZ2ljU3dhcDIgPSAyOTE3MDM0MTAwOwogICAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXRfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvc3JnYlRvTGluZWFyLmpzCiAgZnVuY3Rpb24gc3JnYlRvTGluZWFyKHZhbHVlKSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlIiwgdmFsdWUpOwogICAgaWYgKHZhbHVlIDw9IDAuMDQwNDUpIHsKICAgICAgcmV0dXJuIHZhbHVlICogMC4wNzczOTkzODA4MDQ5NTM1NzsKICAgIH0KICAgIHJldHVybiBNYXRoLnBvdygKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWxvc3Mtb2YtcHJlY2lzaW9uCiAgICAgICh2YWx1ZSArIDAuMDU1KSAqIDAuOTQ3ODY3Mjk4NTc4MTk5MSwKICAgICAgMi40CiAgICApOwogIH0KICB2YXIgc3JnYlRvTGluZWFyX2RlZmF1bHQ7CiAgdmFyIGluaXRfc3JnYlRvTGluZWFyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9zcmdiVG9MaW5lYXIuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIHNyZ2JUb0xpbmVhcl9kZWZhdWx0ID0gc3JnYlRvTGluZWFyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlSTNTLmpzCiAgdmFyIGRlY29kZUkzU19leHBvcnRzID0ge307CiAgX19leHBvcnQoZGVjb2RlSTNTX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGRlY29kZUkzU19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gYmlsaW5lYXJJbnRlcnBvbGF0ZSh0eCwgdHksIGgwMCwgaDEwLCBoMDEsIGgxMSkgewogICAgY29uc3QgYTMgPSBoMDAgKiAoMSAtIHR4KSArIGgxMCAqIHR4OwogICAgY29uc3QgYiA9IGgwMSAqICgxIC0gdHgpICsgaDExICogdHg7CiAgICByZXR1cm4gYTMgKiAoMSAtIHR5KSArIGIgKiB0eTsKICB9CiAgZnVuY3Rpb24gc2FtcGxlTWFwKHUzLCB2Mywgd2lkdGgsIGRhdGEpIHsKICAgIGNvbnN0IGFkZHJlc3MgPSB1MyArIHYzICogd2lkdGg7CiAgICByZXR1cm4gZGF0YVthZGRyZXNzXTsKICB9CiAgZnVuY3Rpb24gc2FtcGxlR2VvaWQoc2FtcGxlWCwgc2FtcGxlWSwgZ2VvaWREYXRhKSB7CiAgICBjb25zdCBleHRlbnQgPSBnZW9pZERhdGEubmF0aXZlRXh0ZW50OwogICAgbGV0IHggPSAoc2FtcGxlWCAtIGV4dGVudC53ZXN0KSAvIChleHRlbnQuZWFzdCAtIGV4dGVudC53ZXN0KSAqIChnZW9pZERhdGEud2lkdGggLSAxKTsKICAgIGxldCB5ID0gKHNhbXBsZVkgLSBleHRlbnQuc291dGgpIC8gKGV4dGVudC5ub3J0aCAtIGV4dGVudC5zb3V0aCkgKiAoZ2VvaWREYXRhLmhlaWdodCAtIDEpOwogICAgY29uc3QgeGkgPSBNYXRoLmZsb29yKHgpOwogICAgbGV0IHlpID0gTWF0aC5mbG9vcih5KTsKICAgIHggLT0geGk7CiAgICB5IC09IHlpOwogICAgY29uc3QgeE5leHQgPSB4aSA8IGdlb2lkRGF0YS53aWR0aCA/IHhpICsgMSA6IHhpOwogICAgbGV0IHlOZXh0ID0geWkgPCBnZW9pZERhdGEuaGVpZ2h0ID8geWkgKyAxIDogeWk7CiAgICB5aSA9IGdlb2lkRGF0YS5oZWlnaHQgLSAxIC0geWk7CiAgICB5TmV4dCA9IGdlb2lkRGF0YS5oZWlnaHQgLSAxIC0geU5leHQ7CiAgICBjb25zdCBoMDAgPSBzYW1wbGVNYXAoeGksIHlpLCBnZW9pZERhdGEud2lkdGgsIGdlb2lkRGF0YS5idWZmZXIpOwogICAgY29uc3QgaDEwID0gc2FtcGxlTWFwKHhOZXh0LCB5aSwgZ2VvaWREYXRhLndpZHRoLCBnZW9pZERhdGEuYnVmZmVyKTsKICAgIGNvbnN0IGgwMSA9IHNhbXBsZU1hcCh4aSwgeU5leHQsIGdlb2lkRGF0YS53aWR0aCwgZ2VvaWREYXRhLmJ1ZmZlcik7CiAgICBjb25zdCBoMTEgPSBzYW1wbGVNYXAoeE5leHQsIHlOZXh0LCBnZW9pZERhdGEud2lkdGgsIGdlb2lkRGF0YS5idWZmZXIpOwogICAgbGV0IGZpbmFsSGVpZ2h0ID0gYmlsaW5lYXJJbnRlcnBvbGF0ZSh4LCB5LCBoMDAsIGgxMCwgaDAxLCBoMTEpOwogICAgZmluYWxIZWlnaHQgPSBmaW5hbEhlaWdodCAqIGdlb2lkRGF0YS5zY2FsZSArIGdlb2lkRGF0YS5vZmZzZXQ7CiAgICByZXR1cm4gZmluYWxIZWlnaHQ7CiAgfQogIGZ1bmN0aW9uIHNhbXBsZUdlb2lkRnJvbUxpc3QobG9uLCBsYXQsIGdlb2lkRGF0YUxpc3QpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2VvaWREYXRhTGlzdC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBsb2NhbEV4dGVudCA9IGdlb2lkRGF0YUxpc3RbaV0ubmF0aXZlRXh0ZW50OwogICAgICBsZXQgbG9jYWxQdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaWYgKGdlb2lkRGF0YUxpc3RbaV0ucHJvamVjdGlvblR5cGUgPT09ICJXZWJNZXJjYXRvciIpIHsKICAgICAgICBjb25zdCByYWRpaSA9IGdlb2lkRGF0YUxpc3RbaV0ucHJvamVjdGlvbi5fZWxsaXBzb2lkLl9yYWRpaTsKICAgICAgICBjb25zdCB3ZWJNZXJjYXRvclByb2ogPSBuZXcgV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQoCiAgICAgICAgICBuZXcgRWxsaXBzb2lkX2RlZmF1bHQocmFkaWkueCwgcmFkaWkueSwgcmFkaWkueikKICAgICAgICApOwogICAgICAgIGxvY2FsUHQgPSB3ZWJNZXJjYXRvclByb2oucHJvamVjdChuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uLCBsYXQsIDApKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsb2NhbFB0LnggPSBsb247CiAgICAgICAgbG9jYWxQdC55ID0gbGF0OwogICAgICB9CiAgICAgIGlmIChsb2NhbFB0LnggPiBsb2NhbEV4dGVudC53ZXN0ICYmIGxvY2FsUHQueCA8IGxvY2FsRXh0ZW50LmVhc3QgJiYgbG9jYWxQdC55ID4gbG9jYWxFeHRlbnQuc291dGggJiYgbG9jYWxQdC55IDwgbG9jYWxFeHRlbnQubm9ydGgpIHsKICAgICAgICByZXR1cm4gc2FtcGxlR2VvaWQobG9jYWxQdC54LCBsb2NhbFB0LnksIGdlb2lkRGF0YUxpc3RbaV0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gMDsKICB9CiAgZnVuY3Rpb24gb3J0aG9tZXRyaWNUb0VsbGlwc29pZGFsKHZlcnRleENvdW50LCBwb3NpdGlvbiwgc2NhbGVfeCwgc2NhbGVfeSwgY2VudGVyLCBnZW9pZERhdGFMaXN0LCBmYXN0KSB7CiAgICBpZiAoZmFzdCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjZW50ZXJIZWlnaHQgPSBzYW1wbGVHZW9pZEZyb21MaXN0KAogICAgICBjZW50ZXIubG9uZ2l0dWRlLAogICAgICBjZW50ZXIubGF0aXR1ZGUsCiAgICAgIGdlb2lkRGF0YUxpc3QKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyArK2kpIHsKICAgICAgY29uc3QgaGVpZ2h0ID0gc2FtcGxlR2VvaWRGcm9tTGlzdCgKICAgICAgICBjZW50ZXIubG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhzY2FsZV94ICogcG9zaXRpb25baSAqIDNdKSwKICAgICAgICBjZW50ZXIubGF0aXR1ZGUgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHNjYWxlX3kgKiBwb3NpdGlvbltpICogMyArIDFdKSwKICAgICAgICBnZW9pZERhdGFMaXN0CiAgICAgICk7CiAgICAgIHBvc2l0aW9uW2kgKiAzICsgMl0gKz0gaGVpZ2h0IC0gY2VudGVySGVpZ2h0OwogICAgfQogIH0KICBmdW5jdGlvbiB0cmFuc2Zvcm1Ub0xvY2FsKHZlcnRleENvdW50LCBwb3NpdGlvbnMsIG5vcm1hbHMsIGNhcnRvZ3JhcGhpY0NlbnRlciwgY2FydGVzaWFuQ2VudGVyLCBwYXJlbnRSb3RhdGlvbiwgZWxsaXBzb2lkUmFkaWlTcXVhcmUsIHNjYWxlX3gsIHNjYWxlX3kpIHsKICAgIGlmICh2ZXJ0ZXhDb3VudCA9PT0gMCB8fCAhZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBlbGxpcHNvaWQgPSBuZXcgRWxsaXBzb2lkX2RlZmF1bHQoCiAgICAgIE1hdGguc3FydChlbGxpcHNvaWRSYWRpaVNxdWFyZS54KSwKICAgICAgTWF0aC5zcXJ0KGVsbGlwc29pZFJhZGlpU3F1YXJlLnkpLAogICAgICBNYXRoLnNxcnQoZWxsaXBzb2lkUmFkaWlTcXVhcmUueikKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyArK2kpIHsKICAgICAgY29uc3QgaW5kZXhPZmZzZXQgPSBpICogMzsKICAgICAgY29uc3QgaW5kZXhPZmZzZXQxID0gaW5kZXhPZmZzZXQgKyAxOwogICAgICBjb25zdCBpbmRleE9mZnNldDIgPSBpbmRleE9mZnNldCArIDI7CiAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydG9ncmFwaGljMi5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWNDZW50ZXIubG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhzY2FsZV94ICogcG9zaXRpb25zW2luZGV4T2Zmc2V0XSk7CiAgICAgIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWNDZW50ZXIubGF0aXR1ZGUgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHNjYWxlX3kgKiBwb3NpdGlvbnNbaW5kZXhPZmZzZXQxXSk7CiAgICAgIGNhcnRvZ3JhcGhpYzIuaGVpZ2h0ID0gY2FydG9ncmFwaGljQ2VudGVyLmhlaWdodCArIHBvc2l0aW9uc1tpbmRleE9mZnNldDJdOwogICAgICBjb25zdCBwb3NpdGlvbiA9IHt9OwogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oY2FydG9ncmFwaGljMiwgcG9zaXRpb24pOwogICAgICBwb3NpdGlvbi54IC09IGNhcnRlc2lhbkNlbnRlci54OwogICAgICBwb3NpdGlvbi55IC09IGNhcnRlc2lhbkNlbnRlci55OwogICAgICBwb3NpdGlvbi56IC09IGNhcnRlc2lhbkNlbnRlci56OwogICAgICBjb25zdCByb3RhdGVkUG9zaXRpb24gPSB7fTsKICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IocGFyZW50Um90YXRpb24sIHBvc2l0aW9uLCByb3RhdGVkUG9zaXRpb24pOwogICAgICBwb3NpdGlvbnNbaW5kZXhPZmZzZXRdID0gcm90YXRlZFBvc2l0aW9uLng7CiAgICAgIHBvc2l0aW9uc1tpbmRleE9mZnNldDFdID0gcm90YXRlZFBvc2l0aW9uLnk7CiAgICAgIHBvc2l0aW9uc1tpbmRleE9mZnNldDJdID0gcm90YXRlZFBvc2l0aW9uLno7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgICBjb25zdCBub3JtYWwyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXRdLAogICAgICAgICAgbm9ybWFsc1tpbmRleE9mZnNldDFdLAogICAgICAgICAgbm9ybWFsc1tpbmRleE9mZnNldDJdCiAgICAgICAgKTsKICAgICAgICBjb25zdCByb3RhdGVkTm9ybWFsID0ge307CiAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IocGFyZW50Um90YXRpb24sIG5vcm1hbDIsIHJvdGF0ZWROb3JtYWwpOwogICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXRdID0gcm90YXRlZE5vcm1hbC54OwogICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXQxXSA9IHJvdGF0ZWROb3JtYWwueTsKICAgICAgICBub3JtYWxzW2luZGV4T2Zmc2V0Ml0gPSByb3RhdGVkTm9ybWFsLno7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gY3JvcFVWcyh2ZXJ0ZXhDb3VudCwgdXYwcywgdXZSZWdpb25zKSB7CiAgICBmb3IgKGxldCB2ZXJ0ZXhJbmRleCA9IDA7IHZlcnRleEluZGV4IDwgdmVydGV4Q291bnQ7ICsrdmVydGV4SW5kZXgpIHsKICAgICAgY29uc3QgbWluVSA9IHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDRdIC8gNjU1MzU7CiAgICAgIGNvbnN0IG1pblYgPSB1dlJlZ2lvbnNbdmVydGV4SW5kZXggKiA0ICsgMV0gLyA2NTUzNTsKICAgICAgY29uc3Qgc2NhbGVVID0gKHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDQgKyAyXSAtIHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDRdKSAvIDY1NTM1OwogICAgICBjb25zdCBzY2FsZVYgPSAodXZSZWdpb25zW3ZlcnRleEluZGV4ICogNCArIDNdIC0gdXZSZWdpb25zW3ZlcnRleEluZGV4ICogNCArIDFdKSAvIDY1NTM1OwogICAgICB1djBzW3ZlcnRleEluZGV4ICogMl0gKj0gc2NhbGVVOwogICAgICB1djBzW3ZlcnRleEluZGV4ICogMl0gKz0gbWluVTsKICAgICAgdXYwc1t2ZXJ0ZXhJbmRleCAqIDIgKyAxXSAqPSBzY2FsZVY7CiAgICAgIHV2MHNbdmVydGV4SW5kZXggKiAyICsgMV0gKz0gbWluVjsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVJbmRleEFycmF5KHZlcnRleENvdW50LCBpbmRpY2VzLCBjb2xvcnMsIHNwbGl0R2VvbWV0cnlCeUNvbG9yVHJhbnNwYXJlbmN5KSB7CiAgICBjb25zdCBpbmRleEFycmF5ID0gbmV3IFVpbnQzMkFycmF5KHZlcnRleENvdW50KTsKICAgIGNvbnN0IHZlcnRleEluZGV4Rm4gPSBkZWZpbmVkX2RlZmF1bHQoaW5kaWNlcykgPyAodmVydGV4SW5kZXgpID0+IGluZGljZXNbdmVydGV4SW5kZXhdIDogKHZlcnRleEluZGV4KSA9PiB2ZXJ0ZXhJbmRleDsKICAgIGxldCB0cmFuc3BhcmVudFZlcnRleE9mZnNldCA9IDA7CiAgICBpZiAoc3BsaXRHZW9tZXRyeUJ5Q29sb3JUcmFuc3BhcmVuY3kgJiYgZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgY29uc3QgaXNWZXJ0ZXhUcmFuc3BhcmVudEZuID0gKHZlcnRleEluZGV4KSA9PiBjb2xvcnNbdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCkgKiA0ICsgM10gPCAyNTU7CiAgICAgIGZvciAobGV0IHZlcnRleEluZGV4ID0gMDsgdmVydGV4SW5kZXggPCB2ZXJ0ZXhDb3VudDsgdmVydGV4SW5kZXggKz0gMykgewogICAgICAgIGlmICghaXNWZXJ0ZXhUcmFuc3BhcmVudEZuKHZlcnRleEluZGV4KSAmJiAhaXNWZXJ0ZXhUcmFuc3BhcmVudEZuKHZlcnRleEluZGV4ICsgMSkgJiYgIWlzVmVydGV4VHJhbnNwYXJlbnRGbih2ZXJ0ZXhJbmRleCArIDIpKSB7CiAgICAgICAgICBpbmRleEFycmF5W3RyYW5zcGFyZW50VmVydGV4T2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCk7CiAgICAgICAgICBpbmRleEFycmF5W3RyYW5zcGFyZW50VmVydGV4T2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCArIDEpOwogICAgICAgICAgaW5kZXhBcnJheVt0cmFuc3BhcmVudFZlcnRleE9mZnNldCsrXSA9IHZlcnRleEluZGV4Rm4odmVydGV4SW5kZXggKyAyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRyYW5zcGFyZW50VmVydGV4T2Zmc2V0ID4gMCkgewogICAgICAgIGxldCBvZmZzZXQgPSB0cmFuc3BhcmVudFZlcnRleE9mZnNldDsKICAgICAgICBmb3IgKGxldCB2ZXJ0ZXhJbmRleCA9IDA7IHZlcnRleEluZGV4IDwgdmVydGV4Q291bnQ7IHZlcnRleEluZGV4ICs9IDMpIHsKICAgICAgICAgIGlmIChpc1ZlcnRleFRyYW5zcGFyZW50Rm4odmVydGV4SW5kZXgpIHx8IGlzVmVydGV4VHJhbnNwYXJlbnRGbih2ZXJ0ZXhJbmRleCArIDEpIHx8IGlzVmVydGV4VHJhbnNwYXJlbnRGbih2ZXJ0ZXhJbmRleCArIDIpKSB7CiAgICAgICAgICAgIGluZGV4QXJyYXlbb2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCk7CiAgICAgICAgICAgIGluZGV4QXJyYXlbb2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCArIDEpOwogICAgICAgICAgICBpbmRleEFycmF5W29mZnNldCsrXSA9IHZlcnRleEluZGV4Rm4odmVydGV4SW5kZXggKyAyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChsZXQgdmVydGV4SW5kZXggPSAwOyB2ZXJ0ZXhJbmRleCA8IHZlcnRleENvdW50OyArK3ZlcnRleEluZGV4KSB7CiAgICAgICAgICBpbmRleEFycmF5W3ZlcnRleEluZGV4XSA9IHZlcnRleEluZGV4Rm4odmVydGV4SW5kZXgpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQgPSB2ZXJ0ZXhDb3VudDsKICAgICAgZm9yIChsZXQgdmVydGV4SW5kZXggPSAwOyB2ZXJ0ZXhJbmRleCA8IHZlcnRleENvdW50OyArK3ZlcnRleEluZGV4KSB7CiAgICAgICAgaW5kZXhBcnJheVt2ZXJ0ZXhJbmRleF0gPSB2ZXJ0ZXhJbmRleEZuKHZlcnRleEluZGV4KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgaW5kZXhBcnJheSwKICAgICAgdHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQKICAgIH07CiAgfQogIGZ1bmN0aW9uIGdldEZlYXR1cmVIYXNoKHN5bWJvbG9neURhdGEsIG91dGxpbmVzSGFzaCwgZmVhdHVyZUluZGV4KSB7CiAgICBjb25zdCBmZWF0dXJlSGFzaCA9IG91dGxpbmVzSGFzaFtmZWF0dXJlSW5kZXhdOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSGFzaCkpIHsKICAgICAgcmV0dXJuIGZlYXR1cmVIYXNoOwogICAgfQogICAgY29uc3QgbmV3RmVhdHVyZUhhc2ggPSBvdXRsaW5lc0hhc2hbZmVhdHVyZUluZGV4XSA9IHsKICAgICAgcG9zaXRpb25zOiB7fSwKICAgICAgaW5kaWNlczoge30sCiAgICAgIGVkZ2VzOiB7fQogICAgfTsKICAgIGNvbnN0IGZlYXR1cmVTeW1ib2xvZ3kgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgc3ltYm9sb2d5RGF0YVtmZWF0dXJlSW5kZXhdLAogICAgICBzeW1ib2xvZ3lEYXRhLmRlZmF1bHQKICAgICk7CiAgICBuZXdGZWF0dXJlSGFzaC5oYXNPdXRsaW5lID0gZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVTeW1ib2xvZ3k/LmVkZ2VzKTsKICAgIHJldHVybiBuZXdGZWF0dXJlSGFzaDsKICB9CiAgZnVuY3Rpb24gYWRkVmVydGV4VG9IYXNoKGluZGV4SGFzaCwgcG9zaXRpb25IYXNoLCB2ZXJ0ZXhJbmRleCwgcG9zaXRpb25zKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRleEhhc2hbdmVydGV4SW5kZXhdKSkgewogICAgICBjb25zdCBzdGFydFBvc2l0aW9uSW5kZXggPSB2ZXJ0ZXhJbmRleCAqIDM7CiAgICAgIGxldCBjb29yZGluYXRlSGFzaCA9IHBvc2l0aW9uSGFzaDsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IDM7IGluZGV4KyspIHsKICAgICAgICBjb25zdCBjb29yZGluYXRlID0gcG9zaXRpb25zW3N0YXJ0UG9zaXRpb25JbmRleCArIGluZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb29yZGluYXRlSGFzaFtjb29yZGluYXRlXSkpIHsKICAgICAgICAgIGNvb3JkaW5hdGVIYXNoW2Nvb3JkaW5hdGVdID0ge307CiAgICAgICAgfQogICAgICAgIGNvb3JkaW5hdGVIYXNoID0gY29vcmRpbmF0ZUhhc2hbY29vcmRpbmF0ZV07CiAgICAgIH0KICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29vcmRpbmF0ZUhhc2guaW5kZXgpKSB7CiAgICAgICAgY29vcmRpbmF0ZUhhc2guaW5kZXggPSB2ZXJ0ZXhJbmRleDsKICAgICAgfQogICAgICBpbmRleEhhc2hbdmVydGV4SW5kZXhdID0gY29vcmRpbmF0ZUhhc2guaW5kZXg7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGFkZEVkZ2VUb0hhc2goZWRnZUhhc2gsIHZlcnRleEFJbmRleCwgdmVydGV4QkluZGV4LCB2ZXJ0ZXhBSW5kZXhVbmlxdWUsIHZlcnRleEJJbmRleFVuaXF1ZSwgbm9ybWFsSW5kZXgpIHsKICAgIGxldCBzdGFydFZlcnRleEluZGV4OwogICAgbGV0IGVuZFZlcnRleEluZGV4OwogICAgaWYgKHZlcnRleEFJbmRleFVuaXF1ZSA8IHZlcnRleEJJbmRleFVuaXF1ZSkgewogICAgICBzdGFydFZlcnRleEluZGV4ID0gdmVydGV4QUluZGV4VW5pcXVlOwogICAgICBlbmRWZXJ0ZXhJbmRleCA9IHZlcnRleEJJbmRleFVuaXF1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YXJ0VmVydGV4SW5kZXggPSB2ZXJ0ZXhCSW5kZXhVbmlxdWU7CiAgICAgIGVuZFZlcnRleEluZGV4ID0gdmVydGV4QUluZGV4VW5pcXVlOwogICAgfQogICAgbGV0IGVkZ2VTdGFydCA9IGVkZ2VIYXNoW3N0YXJ0VmVydGV4SW5kZXhdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWRnZVN0YXJ0KSkgewogICAgICBlZGdlU3RhcnQgPSBlZGdlSGFzaFtzdGFydFZlcnRleEluZGV4XSA9IHt9OwogICAgfQogICAgbGV0IGVkZ2VFbmQgPSBlZGdlU3RhcnRbZW5kVmVydGV4SW5kZXhdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWRnZUVuZCkpIHsKICAgICAgZWRnZUVuZCA9IGVkZ2VTdGFydFtlbmRWZXJ0ZXhJbmRleF0gPSB7CiAgICAgICAgbm9ybWFsc0luZGV4OiBbXSwKICAgICAgICBvdXRsaW5lczogW10KICAgICAgfTsKICAgIH0KICAgIGVkZ2VFbmQubm9ybWFsc0luZGV4LnB1c2gobm9ybWFsSW5kZXgpOwogICAgaWYgKGVkZ2VFbmQub3V0bGluZXMubGVuZ3RoID09PSAwIHx8IHZlcnRleEFJbmRleCAhPT0gdmVydGV4QUluZGV4VW5pcXVlIHx8IHZlcnRleEJJbmRleCAhPT0gdmVydGV4QkluZGV4VW5pcXVlKSB7CiAgICAgIGVkZ2VFbmQub3V0bGluZXMucHVzaCh2ZXJ0ZXhBSW5kZXgsIHZlcnRleEJJbmRleCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlT3V0bGluZXNIYXNoKHN5bWJvbG9neURhdGEsIGZlYXR1cmVJbmRleEFycmF5LCBpbmRleEFycmF5LCBwb3NpdGlvbnMpIHsKICAgIGNvbnN0IG91dGxpbmVzSGFzaCA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleEFycmF5Lmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IGZlYXR1cmVJbmRleCA9IGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXhBcnJheSkgPyBmZWF0dXJlSW5kZXhBcnJheVtpbmRleEFycmF5W2ldXSA6ICJkZWZhdWx0IjsKICAgICAgY29uc3QgZmVhdHVyZUhhc2ggPSBnZXRGZWF0dXJlSGFzaCgKICAgICAgICBzeW1ib2xvZ3lEYXRhLAogICAgICAgIG91dGxpbmVzSGFzaCwKICAgICAgICBmZWF0dXJlSW5kZXgKICAgICAgKTsKICAgICAgaWYgKCFmZWF0dXJlSGFzaC5oYXNPdXRsaW5lKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgaW5kZXhIYXNoID0gZmVhdHVyZUhhc2guaW5kaWNlczsKICAgICAgY29uc3QgcG9zaXRpb25IYXNoID0gZmVhdHVyZUhhc2gucG9zaXRpb25zOwogICAgICBmb3IgKGxldCB2ZXJ0ZXggPSAwOyB2ZXJ0ZXggPCAzOyB2ZXJ0ZXgrKykgewogICAgICAgIGNvbnN0IHZlcnRleEluZGV4ID0gaW5kZXhBcnJheVtpICsgdmVydGV4XTsKICAgICAgICBhZGRWZXJ0ZXhUb0hhc2goaW5kZXhIYXNoLCBwb3NpdGlvbkhhc2gsIHZlcnRleEluZGV4LCBwb3NpdGlvbnMpOwogICAgICB9CiAgICAgIGNvbnN0IGVkZ2VIYXNoID0gZmVhdHVyZUhhc2guZWRnZXM7CiAgICAgIGZvciAobGV0IHZlcnRleCA9IDA7IHZlcnRleCA8IDM7IHZlcnRleCsrKSB7CiAgICAgICAgY29uc3QgdmVydGV4SW5kZXggPSBpbmRleEFycmF5W2kgKyB2ZXJ0ZXhdOwogICAgICAgIGNvbnN0IG5leHRWZXJ0ZXhJbmRleCA9IGluZGV4QXJyYXlbaSArICh2ZXJ0ZXggKyAxKSAlIDNdOwogICAgICAgIGNvbnN0IHVuaXF1ZVZlcnRleEluZGV4ID0gaW5kZXhIYXNoW3ZlcnRleEluZGV4XTsKICAgICAgICBjb25zdCB1bmlxdWVOZXh0VmVydGV4SW5kZXggPSBpbmRleEhhc2hbbmV4dFZlcnRleEluZGV4XTsKICAgICAgICBhZGRFZGdlVG9IYXNoKAogICAgICAgICAgZWRnZUhhc2gsCiAgICAgICAgICB2ZXJ0ZXhJbmRleCwKICAgICAgICAgIG5leHRWZXJ0ZXhJbmRleCwKICAgICAgICAgIHVuaXF1ZVZlcnRleEluZGV4LAogICAgICAgICAgdW5pcXVlTmV4dFZlcnRleEluZGV4LAogICAgICAgICAgaQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvdXRsaW5lc0hhc2g7CiAgfQogIGZ1bmN0aW9uIGNhbGN1bGF0ZUZhY2VOb3JtYWwobm9ybWFscywgdmVydGV4QUluZGV4LCBpbmRleEFycmF5LCBwb3NpdGlvbnMpIHsKICAgIGNvbnN0IHBvc2l0aW9uQUluZGV4ID0gaW5kZXhBcnJheVt2ZXJ0ZXhBSW5kZXhdICogMzsKICAgIGNvbnN0IHBvc2l0aW9uQkluZGV4ID0gaW5kZXhBcnJheVt2ZXJ0ZXhBSW5kZXggKyAxXSAqIDM7CiAgICBjb25zdCBwb3NpdGlvbkNJbmRleCA9IGluZGV4QXJyYXlbdmVydGV4QUluZGV4ICsgMl0gKiAzOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIHBvc2l0aW9uQUluZGV4LCBjYWxjdWxhdGVGYWNlTm9ybWFsQSk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgcG9zaXRpb25CSW5kZXgsIGNhbGN1bGF0ZUZhY2VOb3JtYWxCKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBwb3NpdGlvbkNJbmRleCwgY2FsY3VsYXRlRmFjZU5vcm1hbEMpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQiwKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEEsCiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxCCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQywKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEEsCiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxDCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQiwKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEMsCiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxBCiAgICApOwogICAgY29uc3QgbWFnbml0dWRlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShjYWxjdWxhdGVGYWNlTm9ybWFsQSk7CiAgICBpZiAobWFnbml0dWRlICE9PSAwKSB7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcigKICAgICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQSwKICAgICAgICBtYWduaXR1ZGUsCiAgICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEEKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG5vcm1hbEFJbmRleCA9IHZlcnRleEFJbmRleCAqIDM7CiAgICBjb25zdCBub3JtYWxCSW5kZXggPSAodmVydGV4QUluZGV4ICsgMSkgKiAzOwogICAgY29uc3Qgbm9ybWFsQ0luZGV4ID0gKHZlcnRleEFJbmRleCArIDIpICogMzsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhbGN1bGF0ZUZhY2VOb3JtYWxBLCBub3JtYWxzLCBub3JtYWxBSW5kZXgpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FsY3VsYXRlRmFjZU5vcm1hbEEsIG5vcm1hbHMsIG5vcm1hbEJJbmRleCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYWxjdWxhdGVGYWNlTm9ybWFsQSwgbm9ybWFscywgbm9ybWFsQ0luZGV4KTsKICB9CiAgZnVuY3Rpb24gaXNFZGdlU21vb3RoKG5vcm1hbHMsIG5vcm1hbEFJbmRleCwgbm9ybWFsQkluZGV4KSB7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KG5vcm1hbHMsIG5vcm1hbEFJbmRleCwgaXNFZGdlU21vb3RoQSk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KG5vcm1hbHMsIG5vcm1hbEJJbmRleCwgaXNFZGdlU21vb3RoQik7CiAgICBjb25zdCBjb3NpbmUgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGlzRWRnZVNtb290aEEsIGlzRWRnZVNtb290aEIpOwogICAgY29uc3Qgc2luZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhpc0VkZ2VTbW9vdGhBLCBpc0VkZ2VTbW9vdGhCLCBpc0VkZ2VTbW9vdGhBKQogICAgKTsKICAgIHJldHVybiBNYXRoLmF0YW4yKHNpbmUsIGNvc2luZSkgPCAwLjI1OwogIH0KICBmdW5jdGlvbiBhZGRPdXRsaW5lc0ZvckVkZ2Uob3V0bGluZXMsIGVkZ2VEYXRhLCBpbmRleEFycmF5LCBwb3NpdGlvbnMsIG5vcm1hbHMpIHsKICAgIGlmIChlZGdlRGF0YS5ub3JtYWxzSW5kZXgubGVuZ3RoID4gMSkgewogICAgICBjb25zdCBub3JtYWxzQnlJbmRleCA9IHBvc2l0aW9ucy5sZW5ndGggPT09IG5vcm1hbHMubGVuZ3RoOwogICAgICBmb3IgKGxldCBpbmRleEEgPSAwOyBpbmRleEEgPCBlZGdlRGF0YS5ub3JtYWxzSW5kZXgubGVuZ3RoOyBpbmRleEErKykgewogICAgICAgIGNvbnN0IHZlcnRleEFJbmRleCA9IGVkZ2VEYXRhLm5vcm1hbHNJbmRleFtpbmRleEFdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG5vcm1hbHNbdmVydGV4QUluZGV4ICogM10pKSB7CiAgICAgICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsKG5vcm1hbHMsIHZlcnRleEFJbmRleCwgaW5kZXhBcnJheSwgcG9zaXRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKGluZGV4QSA9PT0gMCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGluZGV4QiA9IDA7IGluZGV4QiA8IGluZGV4QTsgaW5kZXhCKyspIHsKICAgICAgICAgIGNvbnN0IHZlcnRleEJJbmRleCA9IGVkZ2VEYXRhLm5vcm1hbHNJbmRleFtpbmRleEJdOwogICAgICAgICAgY29uc3Qgbm9ybWFsQUluZGV4ID0gbm9ybWFsc0J5SW5kZXggPyBpbmRleEFycmF5W3ZlcnRleEFJbmRleF0gKiAzIDogdmVydGV4QUluZGV4ICogMzsKICAgICAgICAgIGNvbnN0IG5vcm1hbEJJbmRleCA9IG5vcm1hbHNCeUluZGV4ID8gaW5kZXhBcnJheVt2ZXJ0ZXhCSW5kZXhdICogMyA6IHZlcnRleEJJbmRleCAqIDM7CiAgICAgICAgICBpZiAoaXNFZGdlU21vb3RoKG5vcm1hbHMsIG5vcm1hbEFJbmRleCwgbm9ybWFsQkluZGV4KSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBvdXRsaW5lcy5wdXNoKC4uLmVkZ2VEYXRhLm91dGxpbmVzKTsKICB9CiAgZnVuY3Rpb24gYWRkT3V0bGluZXNGb3JGZWF0dXJlKG91dGxpbmVzLCBlZGdlSGFzaCwgaW5kZXhBcnJheSwgcG9zaXRpb25zLCBub3JtYWxzKSB7CiAgICBjb25zdCBlZGdlU3RhcnRLZXlzID0gT2JqZWN0LmtleXMoZWRnZUhhc2gpOwogICAgZm9yIChsZXQgc3RhcnRJbmRleCA9IDA7IHN0YXJ0SW5kZXggPCBlZGdlU3RhcnRLZXlzLmxlbmd0aDsgc3RhcnRJbmRleCsrKSB7CiAgICAgIGNvbnN0IGVkZ2VFbmRzID0gZWRnZUhhc2hbZWRnZVN0YXJ0S2V5c1tzdGFydEluZGV4XV07CiAgICAgIGNvbnN0IGVkZ2VFbmRLZXlzID0gT2JqZWN0LmtleXMoZWRnZUVuZHMpOwogICAgICBmb3IgKGxldCBlbmRJbmRleCA9IDA7IGVuZEluZGV4IDwgZWRnZUVuZEtleXMubGVuZ3RoOyBlbmRJbmRleCsrKSB7CiAgICAgICAgY29uc3QgZWRnZURhdGEgPSBlZGdlRW5kc1tlZGdlRW5kS2V5c1tlbmRJbmRleF1dOwogICAgICAgIGFkZE91dGxpbmVzRm9yRWRnZShvdXRsaW5lcywgZWRnZURhdGEsIGluZGV4QXJyYXksIHBvc2l0aW9ucywgbm9ybWFscyk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVPdXRsaW5lc0Zyb21IYXNoKG91dGxpbmVzSGFzaCwgaW5kZXhBcnJheSwgcG9zaXRpb25zLCBub3JtYWxzKSB7CiAgICBjb25zdCBvdXRsaW5lcyA9IFtdOwogICAgY29uc3QgZmVhdHVyZXMgPSBPYmplY3Qua2V5cyhvdXRsaW5lc0hhc2gpOwogICAgZm9yIChsZXQgZmVhdHVyZUluZGV4ID0gMDsgZmVhdHVyZUluZGV4IDwgZmVhdHVyZXMubGVuZ3RoOyBmZWF0dXJlSW5kZXgrKykgewogICAgICBjb25zdCBlZGdlSGFzaCA9IG91dGxpbmVzSGFzaFtmZWF0dXJlc1tmZWF0dXJlSW5kZXhdXS5lZGdlczsKICAgICAgYWRkT3V0bGluZXNGb3JGZWF0dXJlKG91dGxpbmVzLCBlZGdlSGFzaCwgaW5kZXhBcnJheSwgcG9zaXRpb25zLCBub3JtYWxzKTsKICAgIH0KICAgIHJldHVybiBvdXRsaW5lczsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVPdXRsaW5lc0luZGV4QXJyYXkoc3ltYm9sb2d5RGF0YSwgZmVhdHVyZUluZGV4QXJyYXksIGluZGV4QXJyYXksIHBvc2l0aW9ucywgbm9ybWFscykgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3ltYm9sb2d5RGF0YSkgfHwgT2JqZWN0LmtleXMoc3ltYm9sb2d5RGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBjb25zdCBvdXRsaW5lc0hhc2ggPSBnZW5lcmF0ZU91dGxpbmVzSGFzaCgKICAgICAgc3ltYm9sb2d5RGF0YSwKICAgICAgZmVhdHVyZUluZGV4QXJyYXksCiAgICAgIGluZGV4QXJyYXksCiAgICAgIHBvc2l0aW9ucwogICAgKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG5vcm1hbHMpIHx8IGluZGV4QXJyYXkubGVuZ3RoICogMyAhPT0gbm9ybWFscy5sZW5ndGgpIHsKICAgICAgbm9ybWFscyA9IFtdOwogICAgfQogICAgY29uc3Qgb3V0bGluZXMgPSBnZW5lcmF0ZU91dGxpbmVzRnJvbUhhc2goCiAgICAgIG91dGxpbmVzSGFzaCwKICAgICAgaW5kZXhBcnJheSwKICAgICAgcG9zaXRpb25zLAogICAgICBub3JtYWxzCiAgICApOwogICAgY29uc3Qgb3V0bGluZXNJbmRleEFycmF5ID0gb3V0bGluZXMubGVuZ3RoID4gMCA/IG5ldyBVaW50MzJBcnJheShvdXRsaW5lcykgOiB2b2lkIDA7CiAgICByZXR1cm4gb3V0bGluZXNJbmRleEFycmF5OwogIH0KICBmdW5jdGlvbiBjb252ZXJ0Q29sb3JzQXJyYXkoY29sb3JzKSB7CiAgICBjb25zdCBjb2xvcnNBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoY29sb3JzLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY29sb3JzLmxlbmd0aDsgaW5kZXggKz0gNCkgewogICAgICBjb2xvcnNBcnJheVtpbmRleF0gPSBzcmdiVG9MaW5lYXJfZGVmYXVsdChDb2xvcl9kZWZhdWx0LmJ5dGVUb0Zsb2F0KGNvbG9yc1tpbmRleF0pKTsKICAgICAgY29sb3JzQXJyYXlbaW5kZXggKyAxXSA9IHNyZ2JUb0xpbmVhcl9kZWZhdWx0KENvbG9yX2RlZmF1bHQuYnl0ZVRvRmxvYXQoY29sb3JzW2luZGV4ICsgMV0pKTsKICAgICAgY29sb3JzQXJyYXlbaW5kZXggKyAyXSA9IHNyZ2JUb0xpbmVhcl9kZWZhdWx0KENvbG9yX2RlZmF1bHQuYnl0ZVRvRmxvYXQoY29sb3JzW2luZGV4ICsgMl0pKTsKICAgICAgY29sb3JzQXJyYXlbaW5kZXggKyAzXSA9IENvbG9yX2RlZmF1bHQuYnl0ZVRvRmxvYXQoY29sb3JzW2luZGV4ICsgM10pOwogICAgfQogICAgcmV0dXJuIGNvbG9yc0FycmF5OwogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZU5vcm1hbHModmVydGV4Q291bnQsIGluZGljZXMsIHBvc2l0aW9ucywgbm9ybWFscywgdXYwcywgY29sb3JzLCBmZWF0dXJlSW5kZXgpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHsKICAgICAgbm9ybWFsczogdm9pZCAwLAogICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgdXYwczogdm9pZCAwLAogICAgICBjb2xvcnM6IHZvaWQgMCwKICAgICAgZmVhdHVyZUluZGV4OiB2b2lkIDAsCiAgICAgIHZlcnRleENvdW50OiB2b2lkIDAKICAgIH07CiAgICBpZiAodmVydGV4Q291bnQgPT09IDAgfHwgIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpIHx8IHBvc2l0aW9ucy5sZW5ndGggPT09IDAgfHwgZGVmaW5lZF9kZWZhdWx0KG5vcm1hbHMpKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgIHJlc3VsdC52ZXJ0ZXhDb3VudCA9IGluZGljZXMubGVuZ3RoOwogICAgICByZXN1bHQucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShpbmRpY2VzLmxlbmd0aCAqIDMpOwogICAgICByZXN1bHQudXYwcyA9IGRlZmluZWRfZGVmYXVsdCh1djBzKSA/IG5ldyBGbG9hdDMyQXJyYXkoaW5kaWNlcy5sZW5ndGggKiAyKSA6IHZvaWQgMDsKICAgICAgcmVzdWx0LmNvbG9ycyA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gbmV3IFVpbnQ4QXJyYXkoaW5kaWNlcy5sZW5ndGggKiA0KSA6IHZvaWQgMDsKICAgICAgcmVzdWx0LmZlYXR1cmVJbmRleCA9IGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXgpID8gbmV3IEFycmF5KGluZGljZXMubGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgaW5kZXggPSBpbmRpY2VzW2ldOwogICAgICAgIHJlc3VsdC5wb3NpdGlvbnNbaSAqIDNdID0gcG9zaXRpb25zW2luZGV4ICogM107CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uc1tpICogMyArIDFdID0gcG9zaXRpb25zW2luZGV4ICogMyArIDFdOwogICAgICAgIHJlc3VsdC5wb3NpdGlvbnNbaSAqIDMgKyAyXSA9IHBvc2l0aW9uc1tpbmRleCAqIDMgKyAyXTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdC51djBzKSkgewogICAgICAgICAgcmVzdWx0LnV2MHNbaSAqIDJdID0gdXYwc1tpbmRleCAqIDJdOwogICAgICAgICAgcmVzdWx0LnV2MHNbaSAqIDIgKyAxXSA9IHV2MHNbaW5kZXggKiAyICsgMV07CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0LmNvbG9ycykpIHsKICAgICAgICAgIHJlc3VsdC5jb2xvcnNbaSAqIDRdID0gY29sb3JzW2luZGV4ICogNF07CiAgICAgICAgICByZXN1bHQuY29sb3JzW2kgKiA0ICsgMV0gPSBjb2xvcnNbaW5kZXggKiA0ICsgMV07CiAgICAgICAgICByZXN1bHQuY29sb3JzW2kgKiA0ICsgMl0gPSBjb2xvcnNbaW5kZXggKiA0ICsgMl07CiAgICAgICAgICByZXN1bHQuY29sb3JzW2kgKiA0ICsgM10gPSBjb2xvcnNbaW5kZXggKiA0ICsgM107CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0LmZlYXR1cmVJbmRleCkpIHsKICAgICAgICAgIHJlc3VsdC5mZWF0dXJlSW5kZXhbaV0gPSBmZWF0dXJlSW5kZXhbaW5kZXhdOwogICAgICAgIH0KICAgICAgfQogICAgICB2ZXJ0ZXhDb3VudCA9IGluZGljZXMubGVuZ3RoOwogICAgICBwb3NpdGlvbnMgPSByZXN1bHQucG9zaXRpb25zOwogICAgfQogICAgaW5kaWNlcyA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyBpKyspIHsKICAgICAgaW5kaWNlc1tpXSA9IGk7CiAgICB9CiAgICByZXN1bHQubm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkoaW5kaWNlcy5sZW5ndGggKiAzKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kaWNlcy5sZW5ndGg7IGkgKz0gMykgewogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsKHJlc3VsdC5ub3JtYWxzLCBpLCBpbmRpY2VzLCBwb3NpdGlvbnMpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVHbHRmQnVmZmVyKHZlcnRleENvdW50LCBpbmRpY2VzLCBwb3NpdGlvbnMsIG5vcm1hbHMsIHV2MHMsIGNvbG9ycywgZmVhdHVyZUluZGV4LCBwYXJhbWV0ZXJzKSB7CiAgICBpZiAodmVydGV4Q291bnQgPT09IDAgfHwgIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpIHx8IHBvc2l0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBidWZmZXJzOiBbXSwKICAgICAgICBidWZmZXJWaWV3czogW10sCiAgICAgICAgYWNjZXNzb3JzOiBbXSwKICAgICAgICBtZXNoZXM6IFtdLAogICAgICAgIG5vZGVzOiBbXSwKICAgICAgICBub2Rlc0luU2NlbmU6IFtdCiAgICAgIH07CiAgICB9CiAgICBjb25zdCBidWZmZXJzID0gW107CiAgICBjb25zdCBidWZmZXJWaWV3cyA9IFtdOwogICAgY29uc3QgYWNjZXNzb3JzID0gW107CiAgICBjb25zdCBtZXNoZXMgPSBbXTsKICAgIGNvbnN0IG5vZGVzID0gW107CiAgICBjb25zdCBub2Rlc0luU2NlbmUgPSBbXTsKICAgIGNvbnN0IHJvb3RFeHRlbnNpb25zID0ge307CiAgICBjb25zdCBleHRlbnNpb25zVXNlZCA9IFtdOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICB2ZXJ0ZXhDb3VudCA9IGluZGljZXMubGVuZ3RoOwogICAgfQogICAgY29uc3QgeyBpbmRleEFycmF5LCB0cmFuc3BhcmVudFZlcnRleE9mZnNldCB9ID0gZ2VuZXJhdGVJbmRleEFycmF5KAogICAgICB2ZXJ0ZXhDb3VudCwKICAgICAgaW5kaWNlcywKICAgICAgY29sb3JzLAogICAgICBwYXJhbWV0ZXJzLnNwbGl0R2VvbWV0cnlCeUNvbG9yVHJhbnNwYXJlbmN5CiAgICApOwogICAgY29uc3QgaW5kaWNlc0Jsb2IgPSBuZXcgQmxvYihbaW5kZXhBcnJheV0sIHsgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIgfSk7CiAgICBjb25zdCBpbmRpY2VzVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChpbmRpY2VzQmxvYik7CiAgICBjb25zdCBlbmRJbmRleCA9IHZlcnRleENvdW50OwogICAgY29uc3QgZmVhdHVyZUluZGV4QXJyYXkgPSBwYXJhbWV0ZXJzLmVuYWJsZUZlYXR1cmVzICYmIGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXgpID8gbmV3IEZsb2F0MzJBcnJheShmZWF0dXJlSW5kZXgubGVuZ3RoKSA6IHZvaWQgMDsKICAgIGxldCBmZWF0dXJlQ291bnQgPSAwOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXhBcnJheSkpIHsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGZlYXR1cmVJbmRleC5sZW5ndGg7ICsraW5kZXgpIHsKICAgICAgICBmZWF0dXJlSW5kZXhBcnJheVtpbmRleF0gPSBmZWF0dXJlSW5kZXhbaW5kZXhdOwogICAgICAgIGNvbnN0IGNvdW50QnlJbmRleCA9IGZlYXR1cmVJbmRleFtpbmRleF0gKyAxOwogICAgICAgIGlmIChmZWF0dXJlQ291bnQgPCBjb3VudEJ5SW5kZXgpIHsKICAgICAgICAgIGZlYXR1cmVDb3VudCA9IGNvdW50QnlJbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGxldCBvdXRsaW5lc0luZGljZXNVUkw7CiAgICBjb25zdCBvdXRsaW5lc0luZGV4QXJyYXkgPSBnZW5lcmF0ZU91dGxpbmVzSW5kZXhBcnJheSgKICAgICAgcGFyYW1ldGVycy5zeW1ib2xvZ3lEYXRhLAogICAgICBmZWF0dXJlSW5kZXgsCiAgICAgIGluZGV4QXJyYXksCiAgICAgIHBvc2l0aW9ucywKICAgICAgbm9ybWFscwogICAgKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3V0bGluZXNJbmRleEFycmF5KSkgewogICAgICBjb25zdCBvdXRsaW5lc0luZGljZXNCbG9iID0gbmV3IEJsb2IoW291dGxpbmVzSW5kZXhBcnJheV0sIHsKICAgICAgICB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IgogICAgICB9KTsKICAgICAgb3V0bGluZXNJbmRpY2VzVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChvdXRsaW5lc0luZGljZXNCbG9iKTsKICAgIH0KICAgIGNvbnN0IG1lc2hQb3NpdGlvbnMgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMCwgZW5kSW5kZXggKiAzKTsKICAgIGNvbnN0IHBvc2l0aW9uc0Jsb2IgPSBuZXcgQmxvYihbbWVzaFBvc2l0aW9uc10sIHsKICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgIH0pOwogICAgY29uc3QgcG9zaXRpb25zVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChwb3NpdGlvbnNCbG9iKTsKICAgIGxldCBtaW5YID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IG1heFggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWluWSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGxldCBtYXhZID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IG1pblogPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4WiA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWVzaFBvc2l0aW9ucy5sZW5ndGggLyAzOyBpKyspIHsKICAgICAgbWluWCA9IE1hdGgubWluKG1pblgsIG1lc2hQb3NpdGlvbnNbaSAqIDMgKyAwXSk7CiAgICAgIG1heFggPSBNYXRoLm1heChtYXhYLCBtZXNoUG9zaXRpb25zW2kgKiAzICsgMF0pOwogICAgICBtaW5ZID0gTWF0aC5taW4obWluWSwgbWVzaFBvc2l0aW9uc1tpICogMyArIDFdKTsKICAgICAgbWF4WSA9IE1hdGgubWF4KG1heFksIG1lc2hQb3NpdGlvbnNbaSAqIDMgKyAxXSk7CiAgICAgIG1pblogPSBNYXRoLm1pbihtaW5aLCBtZXNoUG9zaXRpb25zW2kgKiAzICsgMl0pOwogICAgICBtYXhaID0gTWF0aC5tYXgobWF4WiwgbWVzaFBvc2l0aW9uc1tpICogMyArIDJdKTsKICAgIH0KICAgIGNvbnN0IG1lc2hOb3JtYWxzID0gbm9ybWFscyA/IG5vcm1hbHMuc3ViYXJyYXkoMCwgZW5kSW5kZXggKiAzKSA6IHZvaWQgMDsKICAgIGxldCBub3JtYWxzVVJMOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtZXNoTm9ybWFscykpIHsKICAgICAgY29uc3Qgbm9ybWFsc0Jsb2IgPSBuZXcgQmxvYihbbWVzaE5vcm1hbHNdLCB7CiAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgICAgfSk7CiAgICAgIG5vcm1hbHNVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKG5vcm1hbHNCbG9iKTsKICAgIH0KICAgIGNvbnN0IG1lc2hVdjBzID0gdXYwcyA/IHV2MHMuc3ViYXJyYXkoMCwgZW5kSW5kZXggKiAyKSA6IHZvaWQgMDsKICAgIGxldCB1djBVUkw7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1lc2hVdjBzKSkgewogICAgICBjb25zdCB1djBCbG9iID0gbmV3IEJsb2IoW21lc2hVdjBzXSwgeyB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IiB9KTsKICAgICAgdXYwVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTCh1djBCbG9iKTsKICAgIH0KICAgIGNvbnN0IG1lc2hDb2xvcnNJbkJ5dGVzID0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyBjb252ZXJ0Q29sb3JzQXJyYXkoY29sb3JzLnN1YmFycmF5KDAsIGVuZEluZGV4ICogNCkpIDogdm9pZCAwOwogICAgbGV0IGNvbG9yc1VSTDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWVzaENvbG9yc0luQnl0ZXMpKSB7CiAgICAgIGNvbnN0IGNvbG9yc0Jsb2IgPSBuZXcgQmxvYihbbWVzaENvbG9yc0luQnl0ZXNdLCB7CiAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgICAgfSk7CiAgICAgIGNvbG9yc1VSTCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoY29sb3JzQmxvYik7CiAgICB9CiAgICBjb25zdCBtZXNoRmVhdHVyZUlkMCA9IGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXhBcnJheSkgPyBmZWF0dXJlSW5kZXhBcnJheS5zdWJhcnJheSgwLCBlbmRJbmRleCkgOiB2b2lkIDA7CiAgICBsZXQgZmVhdHVyZUlkMFVSTDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWVzaEZlYXR1cmVJZDApKSB7CiAgICAgIGNvbnN0IGZlYXR1cmVJZDBCbG9iID0gbmV3IEJsb2IoW21lc2hGZWF0dXJlSWQwXSwgewogICAgICAgIHR5cGU6ICJhcHBsaWNhdGlvbi9iaW5hcnkiCiAgICAgIH0pOwogICAgICBmZWF0dXJlSWQwVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChmZWF0dXJlSWQwQmxvYik7CiAgICB9CiAgICBjb25zdCBtZXNoUHJvcGVydHlUYWJsZTAgPSBkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZUluZGV4QXJyYXkpID8gbmV3IEZsb2F0MzJBcnJheShmZWF0dXJlQ291bnQpIDogdm9pZCAwOwogICAgbGV0IHByb3BlcnR5VGFibGUwVVJMOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtZXNoUHJvcGVydHlUYWJsZTApKSB7CiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBtZXNoUHJvcGVydHlUYWJsZTAubGVuZ3RoOyArK2luZGV4KSB7CiAgICAgICAgbWVzaFByb3BlcnR5VGFibGUwW2luZGV4XSA9IGluZGV4OwogICAgICB9CiAgICAgIGNvbnN0IHByb3BlcnR5VGFibGUwQmxvYiA9IG5ldyBCbG9iKFttZXNoUHJvcGVydHlUYWJsZTBdLCB7CiAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgICAgfSk7CiAgICAgIHByb3BlcnR5VGFibGUwVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChwcm9wZXJ0eVRhYmxlMEJsb2IpOwogICAgfQogICAgY29uc3QgYXR0cmlidXRlcyA9IHt9OwogICAgY29uc3QgZXh0ZW5zaW9ucyA9IHt9OwogICAgYXR0cmlidXRlcy5QT1NJVElPTiA9IGFjY2Vzc29ycy5sZW5ndGg7CiAgICBidWZmZXJzLnB1c2goewogICAgICB1cmk6IHBvc2l0aW9uc1VSTCwKICAgICAgYnl0ZUxlbmd0aDogbWVzaFBvc2l0aW9ucy5ieXRlTGVuZ3RoCiAgICB9KTsKICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICBidWZmZXI6IGJ1ZmZlcnMubGVuZ3RoIC0gMSwKICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgYnl0ZUxlbmd0aDogbWVzaFBvc2l0aW9ucy5ieXRlTGVuZ3RoLAogICAgICB0YXJnZXQ6IDM0OTYyCiAgICB9KTsKICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgY29tcG9uZW50VHlwZTogNTEyNiwKICAgICAgY291bnQ6IG1lc2hQb3NpdGlvbnMubGVuZ3RoIC8gMywKICAgICAgdHlwZTogIlZFQzMiLAogICAgICBtYXg6IFttaW5YLCBtaW5ZLCBtaW5aXSwKICAgICAgbWluOiBbbWF4WCwgbWF4WSwgbWF4Wl0KICAgIH0pOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChub3JtYWxzVVJMKSkgewogICAgICBhdHRyaWJ1dGVzLk5PUk1BTCA9IGFjY2Vzc29ycy5sZW5ndGg7CiAgICAgIGJ1ZmZlcnMucHVzaCh7CiAgICAgICAgdXJpOiBub3JtYWxzVVJMLAogICAgICAgIGJ5dGVMZW5ndGg6IG1lc2hOb3JtYWxzLmJ5dGVMZW5ndGgKICAgICAgfSk7CiAgICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICAgIGJ1ZmZlcjogYnVmZmVycy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaE5vcm1hbHMuYnl0ZUxlbmd0aCwKICAgICAgICB0YXJnZXQ6IDM0OTYyCiAgICAgIH0pOwogICAgICBhY2Nlc3NvcnMucHVzaCh7CiAgICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjYsCiAgICAgICAgY291bnQ6IG1lc2hOb3JtYWxzLmxlbmd0aCAvIDMsCiAgICAgICAgdHlwZTogIlZFQzMiCiAgICAgIH0pOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh1djBVUkwpKSB7CiAgICAgIGF0dHJpYnV0ZXMuVEVYQ09PUkRfMCA9IGFjY2Vzc29ycy5sZW5ndGg7CiAgICAgIGJ1ZmZlcnMucHVzaCh7CiAgICAgICAgdXJpOiB1djBVUkwsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaFV2MHMuYnl0ZUxlbmd0aAogICAgICB9KTsKICAgICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgICAgYnVmZmVyOiBidWZmZXJzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoVXYwcy5ieXRlTGVuZ3RoLAogICAgICAgIHRhcmdldDogMzQ5NjIKICAgICAgfSk7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiBidWZmZXJWaWV3cy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgY29tcG9uZW50VHlwZTogNTEyNiwKICAgICAgICBjb3VudDogbWVzaFV2MHMubGVuZ3RoIC8gMiwKICAgICAgICB0eXBlOiAiVkVDMiIKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9yc1VSTCkpIHsKICAgICAgYXR0cmlidXRlcy5DT0xPUl8wID0gYWNjZXNzb3JzLmxlbmd0aDsKICAgICAgYnVmZmVycy5wdXNoKHsKICAgICAgICB1cmk6IGNvbG9yc1VSTCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoQ29sb3JzSW5CeXRlcy5ieXRlTGVuZ3RoCiAgICAgIH0pOwogICAgICBidWZmZXJWaWV3cy5wdXNoKHsKICAgICAgICBidWZmZXI6IGJ1ZmZlcnMubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGJ5dGVMZW5ndGg6IG1lc2hDb2xvcnNJbkJ5dGVzLmJ5dGVMZW5ndGgsCiAgICAgICAgdGFyZ2V0OiAzNDk2MgogICAgICB9KTsKICAgICAgYWNjZXNzb3JzLnB1c2goewogICAgICAgIGJ1ZmZlclZpZXc6IGJ1ZmZlclZpZXdzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBjb21wb25lbnRUeXBlOiA1MTI2LAogICAgICAgIGNvdW50OiBtZXNoQ29sb3JzSW5CeXRlcy5sZW5ndGggLyA0LAogICAgICAgIHR5cGU6ICJWRUM0IgogICAgICB9KTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZUlkMFVSTCkpIHsKICAgICAgYXR0cmlidXRlcy5fRkVBVFVSRV9JRF8wID0gYWNjZXNzb3JzLmxlbmd0aDsKICAgICAgYnVmZmVycy5wdXNoKHsKICAgICAgICB1cmk6IGZlYXR1cmVJZDBVUkwsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaEZlYXR1cmVJZDAuYnl0ZUxlbmd0aAogICAgICB9KTsKICAgICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgICAgYnVmZmVyOiBidWZmZXJzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoRmVhdHVyZUlkMC5ieXRlTGVuZ3RoLAogICAgICAgIHRhcmdldDogMzQ5NjMKICAgICAgfSk7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiBidWZmZXJWaWV3cy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgY29tcG9uZW50VHlwZTogNTEyNiwKICAgICAgICBjb3VudDogbWVzaEZlYXR1cmVJZDAubGVuZ3RoLAogICAgICAgIHR5cGU6ICJTQ0FMQVIiCiAgICAgIH0pOwogICAgICBleHRlbnNpb25zLkVYVF9tZXNoX2ZlYXR1cmVzID0gewogICAgICAgIGZlYXR1cmVJZHM6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgYXR0cmlidXRlOiAwLAogICAgICAgICAgICBwcm9wZXJ0eVRhYmxlOiAwLAogICAgICAgICAgICBmZWF0dXJlQ291bnQKICAgICAgICAgIH0KICAgICAgICBdCiAgICAgIH07CiAgICAgIGV4dGVuc2lvbnNVc2VkLnB1c2goIkVYVF9tZXNoX2ZlYXR1cmVzIik7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHByb3BlcnR5VGFibGUwVVJMKSkgewogICAgICBidWZmZXJzLnB1c2goewogICAgICAgIHVyaTogcHJvcGVydHlUYWJsZTBVUkwsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaFByb3BlcnR5VGFibGUwLmJ5dGVMZW5ndGgKICAgICAgfSk7CiAgICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICAgIGJ1ZmZlcjogYnVmZmVycy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaFByb3BlcnR5VGFibGUwLmJ5dGVMZW5ndGgsCiAgICAgICAgdGFyZ2V0OiAzNDk2MwogICAgICB9KTsKICAgICAgcm9vdEV4dGVuc2lvbnMuRVhUX3N0cnVjdHVyYWxfbWV0YWRhdGEgPSB7CiAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICBpZDogImkzcy1tZXRhZGF0YS1zY2hlbWEtMDAxIiwKICAgICAgICAgIG5hbWU6ICJJM1MgbWV0YWRhdGEgc2NoZW1hIDAwMSIsCiAgICAgICAgICBkZXNjcmlwdGlvbjogIlRoZSBzY2hlbWEgZm9yIEkzUyBtZXRhZGF0YSIsCiAgICAgICAgICB2ZXJzaW9uOiAiMS4wIiwKICAgICAgICAgIGNsYXNzZXM6IHsKICAgICAgICAgICAgZmVhdHVyZTogewogICAgICAgICAgICAgIG5hbWU6ICJmZWF0dXJlIiwKICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogIkZlYXR1cmUgbWV0YWRhdGEiLAogICAgICAgICAgICAgIHByb3BlcnRpZXM6IHsKICAgICAgICAgICAgICAgIGluZGV4OiB7CiAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiVGhlIGZlYXR1cmUgaW5kZXgiLAogICAgICAgICAgICAgICAgICB0eXBlOiAiU0NBTEFSIiwKICAgICAgICAgICAgICAgICAgY29tcG9uZW50VHlwZTogIkZMT0FUMzIiLAogICAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJvcGVydHlUYWJsZXM6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgbmFtZTogImZlYXR1cmUtaW5kaWNlcy1tYXBwaW5nIiwKICAgICAgICAgICAgY2xhc3M6ICJmZWF0dXJlIiwKICAgICAgICAgICAgY291bnQ6IGZlYXR1cmVDb3VudCwKICAgICAgICAgICAgcHJvcGVydGllczogewogICAgICAgICAgICAgIGluZGV4OiB7CiAgICAgICAgICAgICAgICB2YWx1ZXM6IGJ1ZmZlclZpZXdzLmxlbmd0aCAtIDEKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICBdCiAgICAgIH07CiAgICAgIGV4dGVuc2lvbnNVc2VkLnB1c2goIkVYVF9zdHJ1Y3R1cmFsX21ldGFkYXRhIik7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG91dGxpbmVzSW5kaWNlc1VSTCkpIHsKICAgICAgYnVmZmVycy5wdXNoKHsKICAgICAgICB1cmk6IG91dGxpbmVzSW5kaWNlc1VSTCwKICAgICAgICBieXRlTGVuZ3RoOiBvdXRsaW5lc0luZGV4QXJyYXkuYnl0ZUxlbmd0aAogICAgICB9KTsKICAgICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgICAgYnVmZmVyOiBidWZmZXJzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBvdXRsaW5lc0luZGV4QXJyYXkuYnl0ZUxlbmd0aCwKICAgICAgICB0YXJnZXQ6IDM0OTYzCiAgICAgIH0pOwogICAgICBhY2Nlc3NvcnMucHVzaCh7CiAgICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjUsCiAgICAgICAgY291bnQ6IG91dGxpbmVzSW5kZXhBcnJheS5sZW5ndGgsCiAgICAgICAgdHlwZTogIlNDQUxBUiIKICAgICAgfSk7CiAgICAgIGV4dGVuc2lvbnMuQ0VTSVVNX3ByaW1pdGl2ZV9vdXRsaW5lID0gewogICAgICAgIGluZGljZXM6IGFjY2Vzc29ycy5sZW5ndGggLSAxCiAgICAgIH07CiAgICAgIGV4dGVuc2lvbnNVc2VkLnB1c2goIkNFU0lVTV9wcmltaXRpdmVfb3V0bGluZSIpOwogICAgfQogICAgYnVmZmVycy5wdXNoKHsKICAgICAgdXJpOiBpbmRpY2VzVVJMLAogICAgICBieXRlTGVuZ3RoOiBpbmRleEFycmF5LmJ5dGVMZW5ndGgKICAgIH0pOwogICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgIGJ1ZmZlcjogYnVmZmVycy5sZW5ndGggLSAxLAogICAgICBieXRlT2Zmc2V0OiAwLAogICAgICBieXRlTGVuZ3RoOiBpbmRleEFycmF5LmJ5dGVMZW5ndGgsCiAgICAgIHRhcmdldDogMzQ5NjMKICAgIH0pOwogICAgY29uc3QgbWVzaFByaW1pdGl2ZXMgPSBbXTsKICAgIGlmICh0cmFuc3BhcmVudFZlcnRleE9mZnNldCA+IDApIHsKICAgICAgYWNjZXNzb3JzLnB1c2goewogICAgICAgIGJ1ZmZlclZpZXc6IGJ1ZmZlclZpZXdzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBjb21wb25lbnRUeXBlOiA1MTI1LAogICAgICAgIGNvdW50OiB0cmFuc3BhcmVudFZlcnRleE9mZnNldCwKICAgICAgICB0eXBlOiAiU0NBTEFSIgogICAgICB9KTsKICAgICAgbWVzaFByaW1pdGl2ZXMucHVzaCh7CiAgICAgICAgYXR0cmlidXRlcywKICAgICAgICBpbmRpY2VzOiBhY2Nlc3NvcnMubGVuZ3RoIC0gMSwKICAgICAgICBtYXRlcmlhbDogbWVzaFByaW1pdGl2ZXMubGVuZ3RoLAogICAgICAgIGV4dGVuc2lvbnMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQgPCB2ZXJ0ZXhDb3VudCkgewogICAgICBhY2Nlc3NvcnMucHVzaCh7CiAgICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiA0ICogdHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQsCiAgICAgICAgLy8gc2tpcCA0IGJ5dGVzIGZvciBlYWNoIG9wYXF1ZSB2ZXJ0ZXgKICAgICAgICBjb21wb25lbnRUeXBlOiA1MTI1LAogICAgICAgIGNvdW50OiB2ZXJ0ZXhDb3VudCAtIHRyYW5zcGFyZW50VmVydGV4T2Zmc2V0LAogICAgICAgIHR5cGU6ICJTQ0FMQVIiCiAgICAgIH0pOwogICAgICBtZXNoUHJpbWl0aXZlcy5wdXNoKHsKICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgIGluZGljZXM6IGFjY2Vzc29ycy5sZW5ndGggLSAxLAogICAgICAgIG1hdGVyaWFsOiBtZXNoUHJpbWl0aXZlcy5sZW5ndGgsCiAgICAgICAgZXh0ZW5zaW9ucywKICAgICAgICBleHRyYTogewogICAgICAgICAgaXNUcmFuc3BhcmVudDogdHJ1ZQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBtZXNoZXMucHVzaCh7CiAgICAgIHByaW1pdGl2ZXM6IG1lc2hQcmltaXRpdmVzCiAgICB9KTsKICAgIG5vZGVzSW5TY2VuZS5wdXNoKDApOwogICAgbm9kZXMucHVzaCh7IG1lc2g6IDAgfSk7CiAgICByZXR1cm4gewogICAgICBidWZmZXJzLAogICAgICBidWZmZXJWaWV3cywKICAgICAgYWNjZXNzb3JzLAogICAgICBtZXNoZXMsCiAgICAgIG5vZGVzLAogICAgICBub2Rlc0luU2NlbmUsCiAgICAgIHJvb3RFeHRlbnNpb25zLAogICAgICBleHRlbnNpb25zVXNlZAogICAgfTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlMihkYXRhLCBzY2hlbWEsIGJ1ZmZlckluZm8sIGZlYXR1cmVEYXRhKSB7CiAgICBjb25zdCBtYWdpY051bWJlciA9IG5ldyBVaW50OEFycmF5KGRhdGEsIDAsIDUpOwogICAgaWYgKG1hZ2ljTnVtYmVyWzBdID09PSAiRCIuY2hhckNvZGVBdCgpICYmIG1hZ2ljTnVtYmVyWzFdID09PSAiUiIuY2hhckNvZGVBdCgpICYmIG1hZ2ljTnVtYmVyWzJdID09PSAiQSIuY2hhckNvZGVBdCgpICYmIG1hZ2ljTnVtYmVyWzNdID09PSAiQyIuY2hhckNvZGVBdCgpICYmIG1hZ2ljTnVtYmVyWzRdID09PSAiTyIuY2hhckNvZGVBdCgpKSB7CiAgICAgIHJldHVybiBkZWNvZGVEcmFjb0VuY29kZWRHZW9tZXRyeShkYXRhLCBidWZmZXJJbmZvKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVCaW5hcnlHZW9tZXRyeShkYXRhLCBzY2hlbWEsIGJ1ZmZlckluZm8sIGZlYXR1cmVEYXRhKTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRHJhY29FbmNvZGVkR2VvbWV0cnkoZGF0YSkgewogICAgY29uc3QgZHJhY29EZWNvZGVyTW9kdWxlID0gZHJhY28yOwogICAgY29uc3QgYnVmZmVyID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EZWNvZGVyQnVmZmVyKCk7CiAgICBjb25zdCBieXRlQXJyYXkgPSBuZXcgVWludDhBcnJheShkYXRhKTsKICAgIGJ1ZmZlci5Jbml0KGJ5dGVBcnJheSwgYnl0ZUFycmF5Lmxlbmd0aCk7CiAgICBjb25zdCBkcmFjb0RlY29kZXIgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRlY29kZXIoKTsKICAgIGNvbnN0IGdlb21ldHJ5VHlwZSA9IGRyYWNvRGVjb2Rlci5HZXRFbmNvZGVkR2VvbWV0cnlUeXBlKGJ1ZmZlcik7CiAgICBjb25zdCBtZXRhZGF0YVF1ZXJpZXIgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLk1ldGFkYXRhUXVlcmllcigpOwogICAgbGV0IGRyYWNvR2VvbWV0cnk7CiAgICBsZXQgc3RhdHVzOwogICAgaWYgKGdlb21ldHJ5VHlwZSA9PT0gZHJhY29EZWNvZGVyTW9kdWxlLlRSSUFOR1VMQVJfTUVTSCkgewogICAgICBkcmFjb0dlb21ldHJ5ID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5NZXNoKCk7CiAgICAgIHN0YXR1cyA9IGRyYWNvRGVjb2Rlci5EZWNvZGVCdWZmZXJUb01lc2goYnVmZmVyLCBkcmFjb0dlb21ldHJ5KTsKICAgIH0KICAgIGNvbnN0IGRlY29kZWRHZW9tZXRyeSA9IHsKICAgICAgdmVydGV4Q291bnQ6IFswXSwKICAgICAgZmVhdHVyZUNvdW50OiAwCiAgICB9OwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdGF0dXMpICYmIHN0YXR1cy5vaygpICYmIGRyYWNvR2VvbWV0cnkucHRyICE9PSAwKSB7CiAgICAgIGNvbnN0IGZhY2VDb3VudCA9IGRyYWNvR2VvbWV0cnkubnVtX2ZhY2VzKCk7CiAgICAgIGNvbnN0IGF0dHJpYnV0ZXNDb3VudCA9IGRyYWNvR2VvbWV0cnkubnVtX2F0dHJpYnV0ZXMoKTsKICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBkcmFjb0dlb21ldHJ5Lm51bV9wb2ludHMoKTsKICAgICAgZGVjb2RlZEdlb21ldHJ5LmluZGljZXMgPSBuZXcgVWludDMyQXJyYXkoZmFjZUNvdW50ICogMyk7CiAgICAgIGNvbnN0IGZhY2VzMiA9IGRlY29kZWRHZW9tZXRyeS5pbmRpY2VzOwogICAgICBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnRbMF0gPSB2ZXJ0ZXhDb3VudDsKICAgICAgZGVjb2RlZEdlb21ldHJ5LnNjYWxlX3ggPSAxOwogICAgICBkZWNvZGVkR2VvbWV0cnkuc2NhbGVfeSA9IDE7CiAgICAgIGNvbnN0IGZhY2UgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50MzJBcnJheSgzKTsKICAgICAgZm9yIChsZXQgZmFjZUluZGV4ID0gMDsgZmFjZUluZGV4IDwgZmFjZUNvdW50OyArK2ZhY2VJbmRleCkgewogICAgICAgIGRyYWNvRGVjb2Rlci5HZXRGYWNlRnJvbU1lc2goZHJhY29HZW9tZXRyeSwgZmFjZUluZGV4LCBmYWNlKTsKICAgICAgICBmYWNlczJbZmFjZUluZGV4ICogM10gPSBmYWNlLkdldFZhbHVlKDApOwogICAgICAgIGZhY2VzMltmYWNlSW5kZXggKiAzICsgMV0gPSBmYWNlLkdldFZhbHVlKDEpOwogICAgICAgIGZhY2VzMltmYWNlSW5kZXggKiAzICsgMl0gPSBmYWNlLkdldFZhbHVlKDIpOwogICAgICB9CiAgICAgIGRyYWNvRGVjb2Rlck1vZHVsZS5kZXN0cm95KGZhY2UpOwogICAgICBmb3IgKGxldCBhdHRySW5kZXggPSAwOyBhdHRySW5kZXggPCBhdHRyaWJ1dGVzQ291bnQ7ICsrYXR0ckluZGV4KSB7CiAgICAgICAgY29uc3QgZHJhY29BdHRyaWJ1dGUgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGF0dHJJbmRleAogICAgICAgICk7CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YSA9IGRlY29kZURyYWNvQXR0cmlidXRlKAogICAgICAgICAgZHJhY29EZWNvZGVyTW9kdWxlLAogICAgICAgICAgZHJhY29EZWNvZGVyLAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgdmVydGV4Q291bnQKICAgICAgICApOwogICAgICAgIGNvbnN0IGRyYWNvQXR0cmlidXRlVHlwZSA9IGRyYWNvQXR0cmlidXRlLmF0dHJpYnV0ZV90eXBlKCk7CiAgICAgICAgbGV0IGF0dHJpYnV0ZWkzc05hbWUgPSAidW5rbm93biI7CiAgICAgICAgaWYgKGRyYWNvQXR0cmlidXRlVHlwZSA9PT0gZHJhY29EZWNvZGVyTW9kdWxlLlBPU0lUSU9OKSB7CiAgICAgICAgICBhdHRyaWJ1dGVpM3NOYW1lID0gInBvc2l0aW9ucyI7CiAgICAgICAgfSBlbHNlIGlmIChkcmFjb0F0dHJpYnV0ZVR5cGUgPT09IGRyYWNvRGVjb2Rlck1vZHVsZS5OT1JNQUwpIHsKICAgICAgICAgIGF0dHJpYnV0ZWkzc05hbWUgPSAibm9ybWFscyI7CiAgICAgICAgfSBlbHNlIGlmIChkcmFjb0F0dHJpYnV0ZVR5cGUgPT09IGRyYWNvRGVjb2Rlck1vZHVsZS5DT0xPUikgewogICAgICAgICAgYXR0cmlidXRlaTNzTmFtZSA9ICJjb2xvcnMiOwogICAgICAgIH0gZWxzZSBpZiAoZHJhY29BdHRyaWJ1dGVUeXBlID09PSBkcmFjb0RlY29kZXJNb2R1bGUuVEVYX0NPT1JEKSB7CiAgICAgICAgICBhdHRyaWJ1dGVpM3NOYW1lID0gInV2MHMiOwogICAgICAgIH0KICAgICAgICBjb25zdCBtZXRhZGF0YSA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVNZXRhZGF0YSgKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBhdHRySW5kZXgKICAgICAgICApOwogICAgICAgIGlmIChtZXRhZGF0YS5wdHIgIT09IDApIHsKICAgICAgICAgIGNvbnN0IG51bUVudHJpZXMgPSBtZXRhZGF0YVF1ZXJpZXIuTnVtRW50cmllcyhtZXRhZGF0YSk7CiAgICAgICAgICBmb3IgKGxldCBlbnRyeSA9IDA7IGVudHJ5IDwgbnVtRW50cmllczsgKytlbnRyeSkgewogICAgICAgICAgICBjb25zdCBlbnRyeU5hbWUgPSBtZXRhZGF0YVF1ZXJpZXIuR2V0RW50cnlOYW1lKG1ldGFkYXRhLCBlbnRyeSk7CiAgICAgICAgICAgIGlmIChlbnRyeU5hbWUgPT09ICJpM3Mtc2NhbGVfeCIpIHsKICAgICAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkuc2NhbGVfeCA9IG1ldGFkYXRhUXVlcmllci5HZXREb3VibGVFbnRyeSgKICAgICAgICAgICAgICAgIG1ldGFkYXRhLAogICAgICAgICAgICAgICAgImkzcy1zY2FsZV94IgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50cnlOYW1lID09PSAiaTNzLXNjYWxlX3kiKSB7CiAgICAgICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LnNjYWxlX3kgPSBtZXRhZGF0YVF1ZXJpZXIuR2V0RG91YmxlRW50cnkoCiAgICAgICAgICAgICAgICBtZXRhZGF0YSwKICAgICAgICAgICAgICAgICJpM3Mtc2NhbGVfeSIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVudHJ5TmFtZSA9PT0gImkzcy1hdHRyaWJ1dGUtdHlwZSIpIHsKICAgICAgICAgICAgICBhdHRyaWJ1dGVpM3NOYW1lID0gbWV0YWRhdGFRdWVyaWVyLkdldFN0cmluZ0VudHJ5KAogICAgICAgICAgICAgICAgbWV0YWRhdGEsCiAgICAgICAgICAgICAgICAiaTNzLWF0dHJpYnV0ZS10eXBlIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChkZWNvZGVkR2VvbWV0cnlbYXR0cmlidXRlaTNzTmFtZV0pKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygiQXR0cmlidXRlIGFscmVhZHkgZXhpc3RzIiwgYXR0cmlidXRlaTNzTmFtZSk7CiAgICAgICAgfQogICAgICAgIGRlY29kZWRHZW9tZXRyeVthdHRyaWJ1dGVpM3NOYW1lXSA9IGF0dHJpYnV0ZURhdGE7CiAgICAgICAgaWYgKGF0dHJpYnV0ZWkzc05hbWUgPT09ICJmZWF0dXJlLWluZGV4IikgewogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LmZlYXR1cmVDb3VudCsrOwogICAgICAgIH0KICAgICAgfQogICAgICBkcmFjb0RlY29kZXJNb2R1bGUuZGVzdHJveShkcmFjb0dlb21ldHJ5KTsKICAgIH0KICAgIGRyYWNvRGVjb2Rlck1vZHVsZS5kZXN0cm95KG1ldGFkYXRhUXVlcmllcik7CiAgICBkcmFjb0RlY29kZXJNb2R1bGUuZGVzdHJveShkcmFjb0RlY29kZXIpOwogICAgcmV0dXJuIGRlY29kZWRHZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRHJhY29BdHRyaWJ1dGUoZHJhY29EZWNvZGVyTW9kdWxlLCBkcmFjb0RlY29kZXIsIGRyYWNvR2VvbWV0cnksIGRyYWNvQXR0cmlidXRlLCB2ZXJ0ZXhDb3VudCkgewogICAgY29uc3QgYnVmZmVyU2l6ZSA9IGRyYWNvQXR0cmlidXRlLm51bV9jb21wb25lbnRzKCkgKiB2ZXJ0ZXhDb3VudDsKICAgIGxldCBkcmFjb0F0dHJpYnV0ZURhdGE7CiAgICBjb25zdCBoYW5kbGVycyA9IFsKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgIH0sCiAgICAgIC8vIERUX0lOVkFMSUQgLSAwCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVJbnQ4Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgSW50OEFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50OEFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50MTZBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDE2Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgSW50MTZBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0ludDE2QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50MTZGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBVaW50MTZBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0ludDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJCYWQgc3RyZWFtIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEyID0gbmV3IEludDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQzMkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDMyRm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgVWludDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0Zsb2F0MzJBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb1VJbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJCYWQgc3RyZWFtIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEyID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0KICAgIF07CiAgICBjb25zdCBhdHRyaWJ1dGVEYXRhID0gaGFuZGxlcnNbZHJhY29BdHRyaWJ1dGUuZGF0YV90eXBlKCldKCk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGRyYWNvQXR0cmlidXRlRGF0YSkpIHsKICAgICAgZHJhY29EZWNvZGVyTW9kdWxlLmRlc3Ryb3koZHJhY29BdHRyaWJ1dGVEYXRhKTsKICAgIH0KICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhOwogIH0KICBmdW5jdGlvbiBkZWNvZGVCaW5hcnlHZW9tZXRyeShkYXRhLCBzY2hlbWEsIGJ1ZmZlckluZm8sIGZlYXR1cmVEYXRhKSB7CiAgICBjb25zdCBkZWNvZGVkR2VvbWV0cnkgPSB7CiAgICAgIHZlcnRleENvdW50OiAwCiAgICB9OwogICAgY29uc3QgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YSk7CiAgICB0cnkgewogICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ID0gZGF0YVZpZXcuZ2V0VWludDMyKG9mZnNldCwgMSk7CiAgICAgIG9mZnNldCArPSA0OwogICAgICBkZWNvZGVkR2VvbWV0cnkuZmVhdHVyZUNvdW50ID0gZGF0YVZpZXcuZ2V0VWludDMyKG9mZnNldCwgMSk7CiAgICAgIG9mZnNldCArPSA0OwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJ1ZmZlckluZm8pKSB7CiAgICAgICAgZm9yIChsZXQgYXR0ckluZGV4ID0gMDsgYXR0ckluZGV4IDwgYnVmZmVySW5mby5hdHRyaWJ1dGVzLmxlbmd0aDsgYXR0ckluZGV4KyspIHsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYmluYXJ5QXR0cmlidXRlRGVjb2RlcnNbYnVmZmVySW5mby5hdHRyaWJ1dGVzW2F0dHJJbmRleF1dKSkgewogICAgICAgICAgICBvZmZzZXQgPSBiaW5hcnlBdHRyaWJ1dGVEZWNvZGVyc1tidWZmZXJJbmZvLmF0dHJpYnV0ZXNbYXR0ckluZGV4XV0oCiAgICAgICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LAogICAgICAgICAgICAgIGRhdGEsCiAgICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgICAgICJVbmtub3duIGRlY29kZXIgZm9yIiwKICAgICAgICAgICAgICBidWZmZXJJbmZvLmF0dHJpYnV0ZXNbYXR0ckluZGV4XQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgb3JkZXJpbmcgPSBzY2hlbWEub3JkZXJpbmc7CiAgICAgICAgbGV0IGZlYXR1cmVBdHRyaWJ1dGVPcmRlciA9IHNjaGVtYS5mZWF0dXJlQXR0cmlidXRlT3JkZXI7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChmZWF0dXJlRGF0YSkgJiYgZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVEYXRhLmdlb21ldHJ5RGF0YSkgJiYgZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVEYXRhLmdlb21ldHJ5RGF0YVswXSkgJiYgZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVEYXRhLmdlb21ldHJ5RGF0YVswXS5wYXJhbXMpKSB7CiAgICAgICAgICBvcmRlcmluZyA9IE9iamVjdC5rZXlzKAogICAgICAgICAgICBmZWF0dXJlRGF0YS5nZW9tZXRyeURhdGFbMF0ucGFyYW1zLnZlcnRleEF0dHJpYnV0ZXMKICAgICAgICAgICk7CiAgICAgICAgICBmZWF0dXJlQXR0cmlidXRlT3JkZXIgPSBPYmplY3Qua2V5cygKICAgICAgICAgICAgZmVhdHVyZURhdGEuZ2VvbWV0cnlEYXRhWzBdLnBhcmFtcy5mZWF0dXJlQXR0cmlidXRlcwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcmRlcmluZy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgZGVjb2RlciA9IGJpbmFyeUF0dHJpYnV0ZURlY29kZXJzW29yZGVyaW5nW2ldXTsKICAgICAgICAgIG9mZnNldCA9IGRlY29kZXIoZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGZlYXR1cmVBdHRyaWJ1dGVPcmRlci5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgY3VyRGVjb2RlciA9IGJpbmFyeUF0dHJpYnV0ZURlY29kZXJzW2ZlYXR1cmVBdHRyaWJ1dGVPcmRlcltqXV07CiAgICAgICAgICBvZmZzZXQgPSBjdXJEZWNvZGVyKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgIH0KICAgIGRlY29kZWRHZW9tZXRyeS5zY2FsZV94ID0gMTsKICAgIGRlY29kZWRHZW9tZXRyeS5zY2FsZV95ID0gMTsKICAgIHJldHVybiBkZWNvZGVkR2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIGRlY29kZUFuZENyZWF0ZUdsdGYocGFyYW1ldGVycykgewogICAgY29uc3QgZ2VvbWV0cnlEYXRhID0gZGVjb2RlMigKICAgICAgcGFyYW1ldGVycy5iaW5hcnlEYXRhLAogICAgICBwYXJhbWV0ZXJzLnNjaGVtYSwKICAgICAgcGFyYW1ldGVycy5idWZmZXJJbmZvLAogICAgICBwYXJhbWV0ZXJzLmZlYXR1cmVEYXRhCiAgICApOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmdlb2lkRGF0YUxpc3QpICYmIHBhcmFtZXRlcnMuZ2VvaWREYXRhTGlzdC5sZW5ndGggPiAwKSB7CiAgICAgIG9ydGhvbWV0cmljVG9FbGxpcHNvaWRhbCgKICAgICAgICBnZW9tZXRyeURhdGEudmVydGV4Q291bnQsCiAgICAgICAgZ2VvbWV0cnlEYXRhLnBvc2l0aW9ucywKICAgICAgICBnZW9tZXRyeURhdGEuc2NhbGVfeCwKICAgICAgICBnZW9tZXRyeURhdGEuc2NhbGVfeSwKICAgICAgICBwYXJhbWV0ZXJzLmNhcnRvZ3JhcGhpY0NlbnRlciwKICAgICAgICBwYXJhbWV0ZXJzLmdlb2lkRGF0YUxpc3QsCiAgICAgICAgZmFsc2UKICAgICAgKTsKICAgIH0KICAgIHRyYW5zZm9ybVRvTG9jYWwoCiAgICAgIGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCwKICAgICAgZ2VvbWV0cnlEYXRhLnBvc2l0aW9ucywKICAgICAgZ2VvbWV0cnlEYXRhLm5vcm1hbHMsCiAgICAgIHBhcmFtZXRlcnMuY2FydG9ncmFwaGljQ2VudGVyLAogICAgICBwYXJhbWV0ZXJzLmNhcnRlc2lhbkNlbnRlciwKICAgICAgcGFyYW1ldGVycy5wYXJlbnRSb3RhdGlvbiwKICAgICAgcGFyYW1ldGVycy5lbGxpcHNvaWRSYWRpaVNxdWFyZSwKICAgICAgZ2VvbWV0cnlEYXRhLnNjYWxlX3gsCiAgICAgIGdlb21ldHJ5RGF0YS5zY2FsZV95CiAgICApOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeURhdGEudXYwcykgJiYgZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5RGF0YVsidXYtcmVnaW9uIl0pKSB7CiAgICAgIGNyb3BVVnMoCiAgICAgICAgZ2VvbWV0cnlEYXRhLnZlcnRleENvdW50LAogICAgICAgIGdlb21ldHJ5RGF0YS51djBzLAogICAgICAgIGdlb21ldHJ5RGF0YVsidXYtcmVnaW9uIl0KICAgICAgKTsKICAgIH0KICAgIGxldCBmZWF0dXJlSW5kZXg7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5RGF0YVsiZmVhdHVyZS1pbmRleCJdKSkgewogICAgICBmZWF0dXJlSW5kZXggPSBnZW9tZXRyeURhdGFbImZlYXR1cmUtaW5kZXgiXTsKICAgIH0gZWxzZSBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5RGF0YVsiZmFjZVJhbmdlIl0pKSB7CiAgICAgIGZlYXR1cmVJbmRleCA9IG5ldyBBcnJheShnZW9tZXRyeURhdGEudmVydGV4Q291bnQpOwogICAgICBmb3IgKGxldCByYW5nZSA9IDA7IHJhbmdlIDwgZ2VvbWV0cnlEYXRhWyJmYWNlUmFuZ2UiXS5sZW5ndGggLSAxOyByYW5nZSArPSAyKSB7CiAgICAgICAgY29uc3QgY3VySW5kZXggPSByYW5nZSAvIDI7CiAgICAgICAgY29uc3QgcmFuZ2VTdGFydCA9IGdlb21ldHJ5RGF0YVsiZmFjZVJhbmdlIl1bcmFuZ2VdOwogICAgICAgIGNvbnN0IHJhbmdlRW5kID0gZ2VvbWV0cnlEYXRhWyJmYWNlUmFuZ2UiXVtyYW5nZSArIDFdOwogICAgICAgIGZvciAobGV0IGkgPSByYW5nZVN0YXJ0OyBpIDw9IHJhbmdlRW5kOyBpKyspIHsKICAgICAgICAgIGZlYXR1cmVJbmRleFtpICogM10gPSBjdXJJbmRleDsKICAgICAgICAgIGZlYXR1cmVJbmRleFtpICogMyArIDFdID0gY3VySW5kZXg7CiAgICAgICAgICBmZWF0dXJlSW5kZXhbaSAqIDMgKyAyXSA9IGN1ckluZGV4OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHBhcmFtZXRlcnMuY2FsY3VsYXRlTm9ybWFscykgewogICAgICBjb25zdCBkYXRhID0gZ2VuZXJhdGVOb3JtYWxzKAogICAgICAgIGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCwKICAgICAgICBnZW9tZXRyeURhdGEuaW5kaWNlcywKICAgICAgICBnZW9tZXRyeURhdGEucG9zaXRpb25zLAogICAgICAgIGdlb21ldHJ5RGF0YS5ub3JtYWxzLAogICAgICAgIGdlb21ldHJ5RGF0YS51djBzLAogICAgICAgIGdlb21ldHJ5RGF0YS5jb2xvcnMsCiAgICAgICAgZmVhdHVyZUluZGV4CiAgICAgICk7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZGF0YS5ub3JtYWxzKSkgewogICAgICAgIGdlb21ldHJ5RGF0YS5ub3JtYWxzID0gZGF0YS5ub3JtYWxzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZGF0YS52ZXJ0ZXhDb3VudCkpIHsKICAgICAgICAgIGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCA9IGRhdGEudmVydGV4Q291bnQ7CiAgICAgICAgICBnZW9tZXRyeURhdGEuaW5kaWNlcyA9IGRhdGEuaW5kaWNlczsKICAgICAgICAgIGdlb21ldHJ5RGF0YS5wb3NpdGlvbnMgPSBkYXRhLnBvc2l0aW9uczsKICAgICAgICAgIGdlb21ldHJ5RGF0YS51djBzID0gZGF0YS51djBzOwogICAgICAgICAgZ2VvbWV0cnlEYXRhLmNvbG9ycyA9IGRhdGEuY29sb3JzOwogICAgICAgICAgZmVhdHVyZUluZGV4ID0gZGF0YS5mZWF0dXJlSW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBjb25zdCBtZXNoRGF0YSA9IGdlbmVyYXRlR2x0ZkJ1ZmZlcigKICAgICAgZ2VvbWV0cnlEYXRhLnZlcnRleENvdW50LAogICAgICBnZW9tZXRyeURhdGEuaW5kaWNlcywKICAgICAgZ2VvbWV0cnlEYXRhLnBvc2l0aW9ucywKICAgICAgZ2VvbWV0cnlEYXRhLm5vcm1hbHMsCiAgICAgIGdlb21ldHJ5RGF0YS51djBzLAogICAgICBnZW9tZXRyeURhdGEuY29sb3JzLAogICAgICBmZWF0dXJlSW5kZXgsCiAgICAgIHBhcmFtZXRlcnMKICAgICk7CiAgICBjb25zdCBjdXN0b21BdHRyaWJ1dGVzID0gewogICAgICBwb3NpdGlvbnM6IGdlb21ldHJ5RGF0YS5wb3NpdGlvbnMsCiAgICAgIGluZGljZXM6IGdlb21ldHJ5RGF0YS5pbmRpY2VzLAogICAgICBmZWF0dXJlSW5kZXgsCiAgICAgIHNvdXJjZVVSTDogcGFyYW1ldGVycy51cmwsCiAgICAgIGNhcnRlc2lhbkNlbnRlcjogcGFyYW1ldGVycy5jYXJ0ZXNpYW5DZW50ZXIsCiAgICAgIHBhcmVudFJvdGF0aW9uOiBwYXJhbWV0ZXJzLnBhcmVudFJvdGF0aW9uCiAgICB9OwogICAgbWVzaERhdGEuX2N1c3RvbUF0dHJpYnV0ZXMgPSBjdXN0b21BdHRyaWJ1dGVzOwogICAgY29uc3QgcmVzdWx0cyA9IHsKICAgICAgbWVzaERhdGEKICAgIH07CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgYXN5bmMgZnVuY3Rpb24gaW5pdFdvcmtlcjIocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgd2FzbUNvbmZpZyA9IHBhcmFtZXRlcnMud2ViQXNzZW1ibHlDb25maWc7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcpICYmIGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnLndhc21CaW5hcnlGaWxlKSkgewogICAgICBkcmFjbzIgPSBhd2FpdCAoMCwgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzMi5kZWZhdWx0KSh3YXNtQ29uZmlnKTsKICAgIH0gZWxzZSB7CiAgICAgIGRyYWNvMiA9IGF3YWl0ICgwLCBpbXBvcnRfZHJhY29fZGVjb2Rlcl9ub2RlanMyLmRlZmF1bHQpKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlSTNTKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHdhc21Db25maWcgPSBwYXJhbWV0ZXJzLndlYkFzc2VtYmx5Q29uZmlnOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnKSkgewogICAgICByZXR1cm4gaW5pdFdvcmtlcjIocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgICB9CiAgICByZXR1cm4gZGVjb2RlQW5kQ3JlYXRlR2x0ZihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICB9CiAgdmFyIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqczIsIGRyYWNvMiwgY2FsY3VsYXRlRmFjZU5vcm1hbEEsIGNhbGN1bGF0ZUZhY2VOb3JtYWxCLCBjYWxjdWxhdGVGYWNlTm9ybWFsQywgaXNFZGdlU21vb3RoQSwgaXNFZGdlU21vb3RoQiwgYmluYXJ5QXR0cmlidXRlRGVjb2RlcnMsIGRlY29kZUkzU19kZWZhdWx0OwogIHZhciBpbml0X2RlY29kZUkzUyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlSTNTLmpzIigpIHsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db2xvcigpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqczIgPSBfX3RvRVNNKHJlcXVpcmVfZHJhY29fZGVjb2Rlcl9ub2RlanMoKSwgMSk7CiAgICAgIGluaXRfc3JnYlRvTGluZWFyKCk7CiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxBID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGlzRWRnZVNtb290aEEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGlzRWRnZVNtb290aEIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJpbmFyeUF0dHJpYnV0ZURlY29kZXJzID0gewogICAgICAgIHBvc2l0aW9uOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgKiAzOwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LnBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoZGF0YSwgb2Zmc2V0LCBjb3VudCk7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiA0OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIG5vcm1hbDogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ICogMzsKICAgICAgICAgIGRlY29kZWRHZW9tZXRyeS5ub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShkYXRhLCBvZmZzZXQsIGNvdW50KTsKICAgICAgICAgIG9mZnNldCArPSBjb3VudCAqIDQ7CiAgICAgICAgICByZXR1cm4gb2Zmc2V0OwogICAgICAgIH0sCiAgICAgICAgdXYwOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgKiAyOwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LnV2MHMgPSBuZXcgRmxvYXQzMkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogNDsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICBjb2xvcjogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ICogNDsKICAgICAgICAgIGRlY29kZWRHZW9tZXRyeS5jb2xvcnMgPSBuZXcgVWludDhBcnJheShkYXRhLCBvZmZzZXQsIGNvdW50KTsKICAgICAgICAgIG9mZnNldCArPSBjb3VudDsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICBmZWF0dXJlSWQ6IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS5mZWF0dXJlQ291bnQ7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiA4OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIGlkOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkuZmVhdHVyZUNvdW50OwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogODsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICBmYWNlUmFuZ2U6IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS5mZWF0dXJlQ291bnQgKiAyOwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LmZhY2VSYW5nZSA9IG5ldyBVaW50MzJBcnJheShkYXRhLCBvZmZzZXQsIGNvdW50KTsKICAgICAgICAgIG9mZnNldCArPSBjb3VudCAqIDQ7CiAgICAgICAgICByZXR1cm4gb2Zmc2V0OwogICAgICAgIH0sCiAgICAgICAgdXZSZWdpb246IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudCAqIDQ7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnlbInV2LXJlZ2lvbiJdID0gbmV3IFVpbnQxNkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogMjsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICByZWdpb246IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudCAqIDQ7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnlbInV2LXJlZ2lvbiJdID0gbmV3IFVpbnQxNkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogMjsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfQogICAgICB9OwogICAgICBkZWNvZGVJM1NfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChkZWNvZGVJM1MpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1JlbmRlcmVyL1BpeGVsRGF0YXR5cGUuanMKICB2YXIgUGl4ZWxEYXRhdHlwZSwgUGl4ZWxEYXRhdHlwZV9kZWZhdWx0OwogIHZhciBpbml0X1BpeGVsRGF0YXR5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9SZW5kZXJlci9QaXhlbERhdGF0eXBlLmpzIigpIHsKICAgICAgaW5pdF9XZWJHTENvbnN0YW50cygpOwogICAgICBQaXhlbERhdGF0eXBlID0gewogICAgICAgIFVOU0lHTkVEX0JZVEU6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBVTlNJR05FRF9TSE9SVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCwKICAgICAgICBVTlNJR05FRF9JTlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICAgIEZMT0FUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkZMT0FULAogICAgICAgIEhBTEZfRkxPQVQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuSEFMRl9GTE9BVF9PRVMsCiAgICAgICAgVU5TSUdORURfSU5UXzI0Xzg6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5UXzI0XzgsCiAgICAgICAgVU5TSUdORURfU0hPUlRfNF80XzRfNDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF80XzRfNF80LAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNV81XzE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlRfNV81XzVfMSwKICAgICAgICBVTlNJR05FRF9TSE9SVF81XzZfNTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF81XzZfNQogICAgICB9OwogICAgICBQaXhlbERhdGF0eXBlLnRvV2ViR0xDb25zdGFudCA9IGZ1bmN0aW9uKHBpeGVsRGF0YXR5cGUsIGNvbnRleHQpIHsKICAgICAgICBzd2l0Y2ggKHBpeGVsRGF0YXR5cGUpIHsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9CWVRFOgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9CWVRFOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVDsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlQ6CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX0lOVDsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuRkxPQVQ7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuSEFMRl9GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQud2ViZ2wyID8gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5IQUxGX0ZMT0FUIDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5IQUxGX0ZMT0FUX09FUzsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlRfMjRfODoKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5UXzI0Xzg7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNF80XzRfNDoKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlRfNF80XzRfNDsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzVfNV8xOgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF81XzVfNV8xOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNl81OgogICAgICAgICAgICByZXR1cm4gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzZfNTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFBpeGVsRGF0YXR5cGUuaXNQYWNrZWQgPSBmdW5jdGlvbihwaXhlbERhdGF0eXBlKSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfSU5UXzI0XzggfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF80XzRfNF80IHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV81XzVfMSB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNl81OwogICAgICB9OwogICAgICBQaXhlbERhdGF0eXBlLnNpemVJbkJ5dGVzID0gZnVuY3Rpb24ocGl4ZWxEYXRhdHlwZSkgewogICAgICAgIHN3aXRjaCAocGl4ZWxEYXRhdHlwZSkgewogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzRfNF80XzQ6CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV81XzVfMToKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzZfNToKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5IQUxGX0ZMT0FUOgogICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlQ6CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuRkxPQVQ6CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfSU5UXzI0Xzg6CiAgICAgICAgICAgIHJldHVybiA0OwogICAgICAgIH0KICAgICAgfTsKICAgICAgUGl4ZWxEYXRhdHlwZS52YWxpZGF0ZSA9IGZ1bmN0aW9uKHBpeGVsRGF0YXR5cGUpIHsKICAgICAgICByZXR1cm4gcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9CWVRFIHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5GTE9BVCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLkhBTEZfRkxPQVQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlRfMjRfOCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzRfNF80XzQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzVfNV8xIHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV82XzU7CiAgICAgIH07CiAgICAgIFBpeGVsRGF0YXR5cGUuZ2V0VHlwZWRBcnJheUNvbnN0cnVjdG9yID0gZnVuY3Rpb24ocGl4ZWxEYXRhdHlwZSkgewogICAgICAgIGNvbnN0IHNpemVJbkJ5dGVzID0gUGl4ZWxEYXRhdHlwZS5zaXplSW5CeXRlcyhwaXhlbERhdGF0eXBlKTsKICAgICAgICBpZiAoc2l6ZUluQnl0ZXMgPT09IFVpbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQpIHsKICAgICAgICAgIHJldHVybiBVaW50OEFycmF5OwogICAgICAgIH0gZWxzZSBpZiAoc2l6ZUluQnl0ZXMgPT09IFVpbnQxNkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UKSB7CiAgICAgICAgICByZXR1cm4gVWludDE2QXJyYXk7CiAgICAgICAgfSBlbHNlIGlmIChzaXplSW5CeXRlcyA9PT0gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UICYmIHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuRkxPQVQpIHsKICAgICAgICAgIHJldHVybiBGbG9hdDMyQXJyYXk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBVaW50MzJBcnJheTsKICAgICAgfTsKICAgICAgUGl4ZWxEYXRhdHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShQaXhlbERhdGF0eXBlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BpeGVsRm9ybWF0LmpzCiAgdmFyIFBpeGVsRm9ybWF0LCBQaXhlbEZvcm1hdF9kZWZhdWx0OwogIHZhciBpbml0X1BpeGVsRm9ybWF0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QaXhlbEZvcm1hdC5qcyIoKSB7CiAgICAgIGluaXRfUGl4ZWxEYXRhdHlwZSgpOwogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIFBpeGVsRm9ybWF0ID0gewogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgYSBkZXB0aCB2YWx1ZS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgREVQVEhfQ09NUE9ORU5UOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkRFUFRIX0NPTVBPTkVOVCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIGEgZGVwdGggYW5kIHN0ZW5jaWwgdmFsdWUsIG1vc3Qgb2Z0ZW4gdXNlZCB3aXRoIHtAbGluayBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVF8yNF84fS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgREVQVEhfU1RFTkNJTDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSF9TVEVOQ0lMLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgYW4gYWxwaGEgY2hhbm5lbC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQUxQSEE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQUxQSEEsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyBhIHJlZCBjaGFubmVsCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJFRDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SRUQsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQgYW5kIGdyZWVuIGNoYW5uZWxzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSRzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SRywKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0I6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkdCLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQkEsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyBhIGx1bWluYW5jZSAoaW50ZW5zaXR5KSBjaGFubmVsLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBMVU1JTkFOQ0U6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuTFVNSU5BTkNFLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgbHVtaW5hbmNlIChpbnRlbnNpdHkpIGFuZCBhbHBoYSBjaGFubmVscy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTFVNSU5BTkNFX0FMUEhBOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkxVTUlOQU5DRV9BTFBIQSwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzIHRoYXQgaXMgRFhUMSBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JfRFhUMTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQl9TM1RDX0RYVDFfRVhULAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgRFhUMSBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBX0RYVDE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUMV9FWFQsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBEWFQzIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfRFhUMzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQzX0VYVCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGJsdWUsIGFuZCBhbHBoYSBjaGFubmVscyB0aGF0IGlzIERYVDUgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9EWFQ1OiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDVfRVhULAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYW5kIGJsdWUgY2hhbm5lbHMgdGhhdCBpcyBQVlIgNGJwcCBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JfUFZSVENfNEJQUFYxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCX1BWUlRDXzRCUFBWMV9JTUcsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBhbmQgYmx1ZSBjaGFubmVscyB0aGF0IGlzIFBWUiAyYnBwIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQl9QVlJUQ18yQlBQVjE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JfUFZSVENfMkJQUFYxX0lNRywKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGJsdWUsIGFuZCBhbHBoYSBjaGFubmVscyB0aGF0IGlzIFBWUiA0YnBwIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfUFZSVENfNEJQUFYxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQV9QVlJUQ180QlBQVjFfSU1HLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgUFZSIDJicHAgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9QVlJUQ18yQlBQVjE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX1BWUlRDXzJCUFBWMV9JTUcsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBBU1RDIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfQVNUQzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQkFfQVNUQ180eDRfV0VCR0wsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBhbmQgYmx1ZSBjaGFubmVscyB0aGF0IGlzIEVUQzEgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCX0VUQzE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JfRVRDMV9XRUJHTCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzIHRoYXQgaXMgRVRDMiBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0I4X0VUQzI6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0I4X0VUQzIsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBFVEMyIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkE4X0VUQzJfRUFDOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQThfRVRDMl9FQUMsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBCQzcgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9CQzc6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX0JQVENfVU5PUk0KICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuY29tcG9uZW50c0xlbmd0aCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgc3dpdGNoIChwaXhlbEZvcm1hdCkgewogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0I6CiAgICAgICAgICAgIHJldHVybiAzOwogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBOgogICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuTFVNSU5BTkNFX0FMUEhBOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRzoKICAgICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LkFMUEhBOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRUQ6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LkxVTUlOQU5DRToKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LnZhbGlkYXRlID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkRFUFRIX0NPTVBPTkVOVCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuREVQVEhfU1RFTkNJTCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuQUxQSEEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJFRCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkcgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuTFVNSU5BTkNFIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5MVU1JTkFOQ0VfQUxQSEEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9EWFQxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUMyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQ1IHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfNEJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfMkJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzRCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ18yQlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQVNUQyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX0VUQzEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQjhfRVRDMiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQThfRVRDMl9FQUMgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQkM3OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0NvbG9yRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJFRCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuQUxQSEEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuTFVNSU5BTkNFIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5MVU1JTkFOQ0VfQUxQSEE7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzRGVwdGhGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuREVQVEhfQ09NUE9ORU5UIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5ERVBUSF9TVEVOQ0lMOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0NvbXByZXNzZWRGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX0RYVDEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQzIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDUgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9QVlJUQ180QlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9QVlJUQ18yQlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfNEJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzJCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9BU1RDIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfRVRDMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCOF9FVEMyIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBOF9FVEMyX0VBQyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9CQzc7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzRFhURm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9EWFQxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUMyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQ1OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc1BWUlRDRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9QVlJUQ180QlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9QVlJUQ18yQlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfNEJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzJCUFBWMTsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNBU1RDRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQVNUQzsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNFVEMxRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9FVEMxOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0VUQzJGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCOF9FVEMyIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBOF9FVEMyX0VBQzsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNCQzdGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9CQzc7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmNvbXByZXNzZWRUZXh0dXJlU2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCwgd2lkdGgsIGhlaWdodCkgewogICAgICAgIHN3aXRjaCAocGl4ZWxGb3JtYXQpIHsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCX0RYVDE6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfRFhUMToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCX0VUQzE6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQjhfRVRDMjoKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKHdpZHRoICsgMykgLyA0KSAqIE1hdGguZmxvb3IoKGhlaWdodCArIDMpIC8gNCkgKiA4OwogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBX0RYVDM6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfRFhUNToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQV9BU1RDOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBOF9FVEMyX0VBQzoKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKHdpZHRoICsgMykgLyA0KSAqIE1hdGguZmxvb3IoKGhlaWdodCArIDMpIC8gNCkgKiAxNjsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCX1BWUlRDXzRCUFBWMToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ180QlBQVjE6CiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKChNYXRoLm1heCh3aWR0aCwgOCkgKiBNYXRoLm1heChoZWlnaHQsIDgpICogNCArIDcpIC8gOCk7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQl9QVlJUQ18yQlBQVjE6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfMkJQUFYxOgogICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcigKICAgICAgICAgICAgICAoTWF0aC5tYXgod2lkdGgsIDE2KSAqIE1hdGgubWF4KGhlaWdodCwgOCkgKiAyICsgNykgLyA4CiAgICAgICAgICAgICk7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfQkM3OgogICAgICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHdpZHRoIC8gNCkgKiBNYXRoLmNlaWwoaGVpZ2h0IC8gNCkgKiAxNjsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQudGV4dHVyZVNpemVJbkJ5dGVzID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQsIHBpeGVsRGF0YXR5cGUsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICBsZXQgY29tcG9uZW50c0xlbmd0aCA9IFBpeGVsRm9ybWF0LmNvbXBvbmVudHNMZW5ndGgocGl4ZWxGb3JtYXQpOwogICAgICAgIGlmIChQaXhlbERhdGF0eXBlX2RlZmF1bHQuaXNQYWNrZWQocGl4ZWxEYXRhdHlwZSkpIHsKICAgICAgICAgIGNvbXBvbmVudHNMZW5ndGggPSAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcG9uZW50c0xlbmd0aCAqIFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5zaXplSW5CeXRlcyhwaXhlbERhdGF0eXBlKSAqIHdpZHRoICogaGVpZ2h0OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5hbGlnbm1lbnRJbkJ5dGVzID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQsIHBpeGVsRGF0YXR5cGUsIHdpZHRoKSB7CiAgICAgICAgY29uc3QgbW9kID0gUGl4ZWxGb3JtYXQudGV4dHVyZVNpemVJbkJ5dGVzKHBpeGVsRm9ybWF0LCBwaXhlbERhdGF0eXBlLCB3aWR0aCwgMSkgJSA0OwogICAgICAgIHJldHVybiBtb2QgPT09IDAgPyA0IDogbW9kID09PSAyID8gMiA6IDE7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmNyZWF0ZVR5cGVkQXJyYXkgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCwgcGl4ZWxEYXRhdHlwZSwgd2lkdGgsIGhlaWdodCkgewogICAgICAgIGNvbnN0IGNvbnN0cnVjdG9yID0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LmdldFR5cGVkQXJyYXlDb25zdHJ1Y3RvcihwaXhlbERhdGF0eXBlKTsKICAgICAgICBjb25zdCBzaXplID0gUGl4ZWxGb3JtYXQuY29tcG9uZW50c0xlbmd0aChwaXhlbEZvcm1hdCkgKiB3aWR0aCAqIGhlaWdodDsKICAgICAgICByZXR1cm4gbmV3IGNvbnN0cnVjdG9yKHNpemUpOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5mbGlwWSA9IGZ1bmN0aW9uKGJ1ZmZlclZpZXcsIHBpeGVsRm9ybWF0LCBwaXhlbERhdGF0eXBlLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgaWYgKGhlaWdodCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIGJ1ZmZlclZpZXc7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZsaXBwZWQgPSBQaXhlbEZvcm1hdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgcGl4ZWxGb3JtYXQsCiAgICAgICAgICBwaXhlbERhdGF0eXBlLAogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBoZWlnaHQKICAgICAgICApOwogICAgICAgIGNvbnN0IG51bWJlck9mQ29tcG9uZW50cyA9IFBpeGVsRm9ybWF0LmNvbXBvbmVudHNMZW5ndGgocGl4ZWxGb3JtYXQpOwogICAgICAgIGNvbnN0IHRleHR1cmVXaWR0aCA9IHdpZHRoICogbnVtYmVyT2ZDb21wb25lbnRzOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGVpZ2h0OyArK2kpIHsKICAgICAgICAgIGNvbnN0IHJvdyA9IGkgKiB3aWR0aCAqIG51bWJlck9mQ29tcG9uZW50czsKICAgICAgICAgIGNvbnN0IGZsaXBwZWRSb3cgPSAoaGVpZ2h0IC0gaSAtIDEpICogd2lkdGggKiBudW1iZXJPZkNvbXBvbmVudHM7CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRleHR1cmVXaWR0aDsgKytqKSB7CiAgICAgICAgICAgIGZsaXBwZWRbZmxpcHBlZFJvdyArIGpdID0gYnVmZmVyVmlld1tyb3cgKyBqXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZsaXBwZWQ7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LnRvSW50ZXJuYWxGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCwgcGl4ZWxEYXRhdHlwZSwgY29udGV4dCkgewogICAgICAgIGlmICghY29udGV4dC53ZWJnbDIpIHsKICAgICAgICAgIHJldHVybiBwaXhlbEZvcm1hdDsKICAgICAgICB9CiAgICAgICAgaWYgKHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5ERVBUSF9TVEVOQ0lMKSB7CiAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSDI0X1NURU5DSUw4OwogICAgICAgIH0KICAgICAgICBpZiAocGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkRFUFRIX0NPTVBPTkVOVCkgewogICAgICAgICAgaWYgKHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCkgewogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSF9DT01QT05FTlQxNjsKICAgICAgICAgIH0gZWxzZSBpZiAocGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0lOVCkgewogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSF9DT01QT05FTlQyNDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5GTE9BVCkgewogICAgICAgICAgc3dpdGNoIChwaXhlbEZvcm1hdCkgewogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkE6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkdCQTMyRjsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0I6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkdCMzJGOwogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHMzJGOwogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJFRDoKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SMzJGOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LkhBTEZfRkxPQVQpIHsKICAgICAgICAgIHN3aXRjaCAocGl4ZWxGb3JtYXQpIHsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQkExNkY7CiAgICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQjE2RjsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRzoKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SRzE2RjsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRUQ6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUjE2RjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdF9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShQaXhlbEZvcm1hdCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9WdWxrYW5Db25zdGFudHMuanMKICB2YXIgVnVsa2FuQ29uc3RhbnRzLCBWdWxrYW5Db25zdGFudHNfZGVmYXVsdDsKICB2YXIgaW5pdF9WdWxrYW5Db25zdGFudHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1Z1bGthbkNvbnN0YW50cy5qcyIoKSB7CiAgICAgIFZ1bGthbkNvbnN0YW50cyA9IHsKICAgICAgICBWS19GT1JNQVRfVU5ERUZJTkVEOiAwLAogICAgICAgIFZLX0ZPUk1BVF9SNEc0X1VOT1JNX1BBQ0s4OiAxLAogICAgICAgIFZLX0ZPUk1BVF9SNEc0QjRBNF9VTk9STV9QQUNLMTY6IDIsCiAgICAgICAgVktfRk9STUFUX0I0RzRSNEE0X1VOT1JNX1BBQ0sxNjogMywKICAgICAgICBWS19GT1JNQVRfUjVHNkI1X1VOT1JNX1BBQ0sxNjogNCwKICAgICAgICBWS19GT1JNQVRfQjVHNlI1X1VOT1JNX1BBQ0sxNjogNSwKICAgICAgICBWS19GT1JNQVRfUjVHNUI1QTFfVU5PUk1fUEFDSzE2OiA2LAogICAgICAgIFZLX0ZPUk1BVF9CNUc1UjVBMV9VTk9STV9QQUNLMTY6IDcsCiAgICAgICAgVktfRk9STUFUX0ExUjVHNUI1X1VOT1JNX1BBQ0sxNjogOCwKICAgICAgICBWS19GT1JNQVRfUjhfVU5PUk06IDksCiAgICAgICAgVktfRk9STUFUX1I4X1NOT1JNOiAxMCwKICAgICAgICBWS19GT1JNQVRfUjhfVVNDQUxFRDogMTEsCiAgICAgICAgVktfRk9STUFUX1I4X1NTQ0FMRUQ6IDEyLAogICAgICAgIFZLX0ZPUk1BVF9SOF9VSU5UOiAxMywKICAgICAgICBWS19GT1JNQVRfUjhfU0lOVDogMTQsCiAgICAgICAgVktfRk9STUFUX1I4X1NSR0I6IDE1LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4X1VOT1JNOiAxNiwKICAgICAgICBWS19GT1JNQVRfUjhHOF9TTk9STTogMTcsCiAgICAgICAgVktfRk9STUFUX1I4RzhfVVNDQUxFRDogMTgsCiAgICAgICAgVktfRk9STUFUX1I4RzhfU1NDQUxFRDogMTksCiAgICAgICAgVktfRk9STUFUX1I4RzhfVUlOVDogMjAsCiAgICAgICAgVktfRk9STUFUX1I4RzhfU0lOVDogMjEsCiAgICAgICAgVktfRk9STUFUX1I4RzhfU1JHQjogMjIsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9VTk9STTogMjMsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9TTk9STTogMjQsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9VU0NBTEVEOiAyNSwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4X1NTQ0FMRUQ6IDI2LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhfVUlOVDogMjcsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9TSU5UOiAyOCwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4X1NSR0I6IDI5LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfVU5PUk06IDMwLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfU05PUk06IDMxLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfVVNDQUxFRDogMzIsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOF9TU0NBTEVEOiAzMywKICAgICAgICBWS19GT1JNQVRfQjhHOFI4X1VJTlQ6IDM0LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfU0lOVDogMzUsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOF9TUkdCOiAzNiwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4QThfVU5PUk06IDM3LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9TTk9STTogMzgsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOEE4X1VTQ0FMRUQ6IDM5LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9TU0NBTEVEOiA0MCwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4QThfVUlOVDogNDEsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOEE4X1NJTlQ6IDQyLAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9TUkdCOiA0MywKICAgICAgICBWS19GT1JNQVRfQjhHOFI4QThfVU5PUk06IDQ0LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9TTk9STTogNDUsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEE4X1VTQ0FMRUQ6IDQ2LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9TU0NBTEVEOiA0NywKICAgICAgICBWS19GT1JNQVRfQjhHOFI4QThfVUlOVDogNDgsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEE4X1NJTlQ6IDQ5LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9TUkdCOiA1MCwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfVU5PUk1fUEFDSzMyOiA1MSwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfU05PUk1fUEFDSzMyOiA1MiwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfVVNDQUxFRF9QQUNLMzI6IDUzLAogICAgICAgIFZLX0ZPUk1BVF9BOEI4RzhSOF9TU0NBTEVEX1BBQ0szMjogNTQsCiAgICAgICAgVktfRk9STUFUX0E4QjhHOFI4X1VJTlRfUEFDSzMyOiA1NSwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfU0lOVF9QQUNLMzI6IDU2LAogICAgICAgIFZLX0ZPUk1BVF9BOEI4RzhSOF9TUkdCX1BBQ0szMjogNTcsCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1VOT1JNX1BBQ0szMjogNTgsCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1NOT1JNX1BBQ0szMjogNTksCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1VTQ0FMRURfUEFDSzMyOiA2MCwKICAgICAgICBWS19GT1JNQVRfQTJSMTBHMTBCMTBfU1NDQUxFRF9QQUNLMzI6IDYxLAogICAgICAgIFZLX0ZPUk1BVF9BMlIxMEcxMEIxMF9VSU5UX1BBQ0szMjogNjIsCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1NJTlRfUEFDSzMyOiA2MywKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfVU5PUk1fUEFDSzMyOiA2NCwKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfU05PUk1fUEFDSzMyOiA2NSwKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfVVNDQUxFRF9QQUNLMzI6IDY2LAogICAgICAgIFZLX0ZPUk1BVF9BMkIxMEcxMFIxMF9TU0NBTEVEX1BBQ0szMjogNjcsCiAgICAgICAgVktfRk9STUFUX0EyQjEwRzEwUjEwX1VJTlRfUEFDSzMyOiA2OCwKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfU0lOVF9QQUNLMzI6IDY5LAogICAgICAgIFZLX0ZPUk1BVF9SMTZfVU5PUk06IDcwLAogICAgICAgIFZLX0ZPUk1BVF9SMTZfU05PUk06IDcxLAogICAgICAgIFZLX0ZPUk1BVF9SMTZfVVNDQUxFRDogNzIsCiAgICAgICAgVktfRk9STUFUX1IxNl9TU0NBTEVEOiA3MywKICAgICAgICBWS19GT1JNQVRfUjE2X1VJTlQ6IDc0LAogICAgICAgIFZLX0ZPUk1BVF9SMTZfU0lOVDogNzUsCiAgICAgICAgVktfRk9STUFUX1IxNl9TRkxPQVQ6IDc2LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfVU5PUk06IDc3LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfU05PUk06IDc4LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfVVNDQUxFRDogNzksCiAgICAgICAgVktfRk9STUFUX1IxNkcxNl9TU0NBTEVEOiA4MCwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2X1VJTlQ6IDgxLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfU0lOVDogODIsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNl9TRkxPQVQ6IDgzLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfVU5PUk06IDg0LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfU05PUk06IDg1LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfVVNDQUxFRDogODYsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNl9TU0NBTEVEOiA4NywKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2X1VJTlQ6IDg4LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfU0lOVDogODksCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNl9TRkxPQVQ6IDkwLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfVU5PUk06IDkxLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfU05PUk06IDkyLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfVVNDQUxFRDogOTMsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNkExNl9TU0NBTEVEOiA5NCwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2QTE2X1VJTlQ6IDk1LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfU0lOVDogOTYsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNkExNl9TRkxPQVQ6IDk3LAogICAgICAgIFZLX0ZPUk1BVF9SMzJfVUlOVDogOTgsCiAgICAgICAgVktfRk9STUFUX1IzMl9TSU5UOiA5OSwKICAgICAgICBWS19GT1JNQVRfUjMyX1NGTE9BVDogMTAwLAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJfVUlOVDogMTAxLAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJfU0lOVDogMTAyLAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJfU0ZMT0FUOiAxMDMsCiAgICAgICAgVktfRk9STUFUX1IzMkczMkIzMl9VSU5UOiAxMDQsCiAgICAgICAgVktfRk9STUFUX1IzMkczMkIzMl9TSU5UOiAxMDUsCiAgICAgICAgVktfRk9STUFUX1IzMkczMkIzMl9TRkxPQVQ6IDEwNiwKICAgICAgICBWS19GT1JNQVRfUjMyRzMyQjMyQTMyX1VJTlQ6IDEwNywKICAgICAgICBWS19GT1JNQVRfUjMyRzMyQjMyQTMyX1NJTlQ6IDEwOCwKICAgICAgICBWS19GT1JNQVRfUjMyRzMyQjMyQTMyX1NGTE9BVDogMTA5LAogICAgICAgIFZLX0ZPUk1BVF9SNjRfVUlOVDogMTEwLAogICAgICAgIFZLX0ZPUk1BVF9SNjRfU0lOVDogMTExLAogICAgICAgIFZLX0ZPUk1BVF9SNjRfU0ZMT0FUOiAxMTIsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NF9VSU5UOiAxMTMsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NF9TSU5UOiAxMTQsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NF9TRkxPQVQ6IDExNSwKICAgICAgICBWS19GT1JNQVRfUjY0RzY0QjY0X1VJTlQ6IDExNiwKICAgICAgICBWS19GT1JNQVRfUjY0RzY0QjY0X1NJTlQ6IDExNywKICAgICAgICBWS19GT1JNQVRfUjY0RzY0QjY0X1NGTE9BVDogMTE4LAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRCNjRBNjRfVUlOVDogMTE5LAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRCNjRBNjRfU0lOVDogMTIwLAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRCNjRBNjRfU0ZMT0FUOiAxMjEsCiAgICAgICAgVktfRk9STUFUX0IxMEcxMVIxMV9VRkxPQVRfUEFDSzMyOiAxMjIsCiAgICAgICAgVktfRk9STUFUX0U1QjlHOVI5X1VGTE9BVF9QQUNLMzI6IDEyMywKICAgICAgICBWS19GT1JNQVRfRDE2X1VOT1JNOiAxMjQsCiAgICAgICAgVktfRk9STUFUX1g4X0QyNF9VTk9STV9QQUNLMzI6IDEyNSwKICAgICAgICBWS19GT1JNQVRfRDMyX1NGTE9BVDogMTI2LAogICAgICAgIFZLX0ZPUk1BVF9TOF9VSU5UOiAxMjcsCiAgICAgICAgVktfRk9STUFUX0QxNl9VTk9STV9TOF9VSU5UOiAxMjgsCiAgICAgICAgVktfRk9STUFUX0QyNF9VTk9STV9TOF9VSU5UOiAxMjksCiAgICAgICAgVktfRk9STUFUX0QzMl9TRkxPQVRfUzhfVUlOVDogMTMwLAogICAgICAgIFZLX0ZPUk1BVF9CQzFfUkdCX1VOT1JNX0JMT0NLOiAxMzEsCiAgICAgICAgVktfRk9STUFUX0JDMV9SR0JfU1JHQl9CTE9DSzogMTMyLAogICAgICAgIFZLX0ZPUk1BVF9CQzFfUkdCQV9VTk9STV9CTE9DSzogMTMzLAogICAgICAgIFZLX0ZPUk1BVF9CQzFfUkdCQV9TUkdCX0JMT0NLOiAxMzQsCiAgICAgICAgVktfRk9STUFUX0JDMl9VTk9STV9CTE9DSzogMTM1LAogICAgICAgIFZLX0ZPUk1BVF9CQzJfU1JHQl9CTE9DSzogMTM2LAogICAgICAgIFZLX0ZPUk1BVF9CQzNfVU5PUk1fQkxPQ0s6IDEzNywKICAgICAgICBWS19GT1JNQVRfQkMzX1NSR0JfQkxPQ0s6IDEzOCwKICAgICAgICBWS19GT1JNQVRfQkM0X1VOT1JNX0JMT0NLOiAxMzksCiAgICAgICAgVktfRk9STUFUX0JDNF9TTk9STV9CTE9DSzogMTQwLAogICAgICAgIFZLX0ZPUk1BVF9CQzVfVU5PUk1fQkxPQ0s6IDE0MSwKICAgICAgICBWS19GT1JNQVRfQkM1X1NOT1JNX0JMT0NLOiAxNDIsCiAgICAgICAgVktfRk9STUFUX0JDNkhfVUZMT0FUX0JMT0NLOiAxNDMsCiAgICAgICAgVktfRk9STUFUX0JDNkhfU0ZMT0FUX0JMT0NLOiAxNDQsCiAgICAgICAgVktfRk9STUFUX0JDN19VTk9STV9CTE9DSzogMTQ1LAogICAgICAgIFZLX0ZPUk1BVF9CQzdfU1JHQl9CTE9DSzogMTQ2LAogICAgICAgIFZLX0ZPUk1BVF9FVEMyX1I4RzhCOF9VTk9STV9CTE9DSzogMTQ3LAogICAgICAgIFZLX0ZPUk1BVF9FVEMyX1I4RzhCOF9TUkdCX0JMT0NLOiAxNDgsCiAgICAgICAgVktfRk9STUFUX0VUQzJfUjhHOEI4QTFfVU5PUk1fQkxPQ0s6IDE0OSwKICAgICAgICBWS19GT1JNQVRfRVRDMl9SOEc4QjhBMV9TUkdCX0JMT0NLOiAxNTAsCiAgICAgICAgVktfRk9STUFUX0VUQzJfUjhHOEI4QThfVU5PUk1fQkxPQ0s6IDE1MSwKICAgICAgICBWS19GT1JNQVRfRVRDMl9SOEc4QjhBOF9TUkdCX0JMT0NLOiAxNTIsCiAgICAgICAgVktfRk9STUFUX0VBQ19SMTFfVU5PUk1fQkxPQ0s6IDE1MywKICAgICAgICBWS19GT1JNQVRfRUFDX1IxMV9TTk9STV9CTE9DSzogMTU0LAogICAgICAgIFZLX0ZPUk1BVF9FQUNfUjExRzExX1VOT1JNX0JMT0NLOiAxNTUsCiAgICAgICAgVktfRk9STUFUX0VBQ19SMTFHMTFfU05PUk1fQkxPQ0s6IDE1NiwKICAgICAgICBWS19GT1JNQVRfQVNUQ180eDRfVU5PUk1fQkxPQ0s6IDE1NywKICAgICAgICBWS19GT1JNQVRfQVNUQ180eDRfU1JHQl9CTE9DSzogMTU4LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NF9VTk9STV9CTE9DSzogMTU5LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NF9TUkdCX0JMT0NLOiAxNjAsCiAgICAgICAgVktfRk9STUFUX0FTVENfNXg1X1VOT1JNX0JMT0NLOiAxNjEsCiAgICAgICAgVktfRk9STUFUX0FTVENfNXg1X1NSR0JfQkxPQ0s6IDE2MiwKICAgICAgICBWS19GT1JNQVRfQVNUQ182eDVfVU5PUk1fQkxPQ0s6IDE2MywKICAgICAgICBWS19GT1JNQVRfQVNUQ182eDVfU1JHQl9CTE9DSzogMTY0LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4Nl9VTk9STV9CTE9DSzogMTY1LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4Nl9TUkdCX0JMT0NLOiAxNjYsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg1X1VOT1JNX0JMT0NLOiAxNjcsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg1X1NSR0JfQkxPQ0s6IDE2OCwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDZfVU5PUk1fQkxPQ0s6IDE2OSwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDZfU1JHQl9CTE9DSzogMTcwLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4OF9VTk9STV9CTE9DSzogMTcxLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4OF9TUkdCX0JMT0NLOiAxNzIsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4NV9VTk9STV9CTE9DSzogMTczLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDVfU1JHQl9CTE9DSzogMTc0LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDZfVU5PUk1fQkxPQ0s6IDE3NSwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg2X1NSR0JfQkxPQ0s6IDE3NiwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg4X1VOT1JNX0JMT0NLOiAxNzcsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4OF9TUkdCX0JMT0NLOiAxNzgsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4MTBfVU5PUk1fQkxPQ0s6IDE3OSwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHgxMF9TUkdCX0JMT0NLOiAxODAsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTJ4MTBfVU5PUk1fQkxPQ0s6IDE4MSwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMngxMF9TUkdCX0JMT0NLOiAxODIsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTJ4MTJfVU5PUk1fQkxPQ0s6IDE4MywKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMngxMl9TUkdCX0JMT0NLOiAxODQsCiAgICAgICAgVktfRk9STUFUX0c4QjhHOFI4XzQyMl9VTk9STTogMTAwMDE1NmUzLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhHOF80MjJfVU5PUk06IDEwMDAxNTYwMDEsCiAgICAgICAgVktfRk9STUFUX0c4X0I4X1I4XzNQTEFORV80MjBfVU5PUk06IDEwMDAxNTYwMDIsCiAgICAgICAgVktfRk9STUFUX0c4X0I4UjhfMlBMQU5FXzQyMF9VTk9STTogMTAwMDE1NjAwMywKICAgICAgICBWS19GT1JNQVRfRzhfQjhfUjhfM1BMQU5FXzQyMl9VTk9STTogMTAwMDE1NjAwNCwKICAgICAgICBWS19GT1JNQVRfRzhfQjhSOF8yUExBTkVfNDIyX1VOT1JNOiAxMDAwMTU2MDA1LAogICAgICAgIFZLX0ZPUk1BVF9HOF9COF9SOF8zUExBTkVfNDQ0X1VOT1JNOiAxMDAwMTU2MDA2LAogICAgICAgIFZLX0ZPUk1BVF9SMTBYNl9VTk9STV9QQUNLMTY6IDEwMDAxNTYwMDcsCiAgICAgICAgVktfRk9STUFUX1IxMFg2RzEwWDZfVU5PUk1fMlBBQ0sxNjogMTAwMDE1NjAwOCwKICAgICAgICBWS19GT1JNQVRfUjEwWDZHMTBYNkIxMFg2QTEwWDZfVU5PUk1fNFBBQ0sxNjogMTAwMDE1NjAwOSwKICAgICAgICBWS19GT1JNQVRfRzEwWDZCMTBYNkcxMFg2UjEwWDZfNDIyX1VOT1JNXzRQQUNLMTY6IDEwMDAxNTYwMTAsCiAgICAgICAgVktfRk9STUFUX0IxMFg2RzEwWDZSMTBYNkcxMFg2XzQyMl9VTk9STV80UEFDSzE2OiAxMDAwMTU2MDExLAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDIwX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMTIsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2UjEwWDZfMlBMQU5FXzQyMF9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDEzLAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDIyX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMTQsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2UjEwWDZfMlBMQU5FXzQyMl9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDE1LAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDQ0X1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMTYsCiAgICAgICAgVktfRk9STUFUX1IxMlg0X1VOT1JNX1BBQ0sxNjogMTAwMDE1NjAxNywKICAgICAgICBWS19GT1JNQVRfUjEyWDRHMTJYNF9VTk9STV8yUEFDSzE2OiAxMDAwMTU2MDE4LAogICAgICAgIFZLX0ZPUk1BVF9SMTJYNEcxMlg0QjEyWDRBMTJYNF9VTk9STV80UEFDSzE2OiAxMDAwMTU2MDE5LAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNEIxMlg0RzEyWDRSMTJYNF80MjJfVU5PUk1fNFBBQ0sxNjogMTAwMDE1NjAyMCwKICAgICAgICBWS19GT1JNQVRfQjEyWDRHMTJYNFIxMlg0RzEyWDRfNDIyX1VOT1JNXzRQQUNLMTY6IDEwMDAxNTYwMjEsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80MjBfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAyMiwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRSMTJYNF8yUExBTkVfNDIwX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMjMsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80MjJfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAyNCwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRSMTJYNF8yUExBTkVfNDIyX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMjUsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80NDRfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAyNiwKICAgICAgICBWS19GT1JNQVRfRzE2QjE2RzE2UjE2XzQyMl9VTk9STTogMTAwMDE1NjAyNywKICAgICAgICBWS19GT1JNQVRfQjE2RzE2UjE2RzE2XzQyMl9VTk9STTogMTAwMDE1NjAyOCwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNl9SMTZfM1BMQU5FXzQyMF9VTk9STTogMTAwMDE1NjAyOSwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNlIxNl8yUExBTkVfNDIwX1VOT1JNOiAxMDAwMTU2MDMwLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2X1IxNl8zUExBTkVfNDIyX1VOT1JNOiAxMDAwMTU2MDMxLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2UjE2XzJQTEFORV80MjJfVU5PUk06IDEwMDAxNTYwMzIsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZfUjE2XzNQTEFORV80NDRfVU5PUk06IDEwMDAxNTYwMzMsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMV8yQlBQX1VOT1JNX0JMT0NLX0lNRzogMTAwMDA1NGUzLAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzFfNEJQUF9VTk9STV9CTE9DS19JTUc6IDEwMDAwNTQwMDEsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMl8yQlBQX1VOT1JNX0JMT0NLX0lNRzogMTAwMDA1NDAwMiwKICAgICAgICBWS19GT1JNQVRfUFZSVEMyXzRCUFBfVU5PUk1fQkxPQ0tfSU1HOiAxMDAwMDU0MDAzLAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzFfMkJQUF9TUkdCX0JMT0NLX0lNRzogMTAwMDA1NDAwNCwKICAgICAgICBWS19GT1JNQVRfUFZSVEMxXzRCUFBfU1JHQl9CTE9DS19JTUc6IDEwMDAwNTQwMDUsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMl8yQlBQX1NSR0JfQkxPQ0tfSU1HOiAxMDAwMDU0MDA2LAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzJfNEJQUF9TUkdCX0JMT0NLX0lNRzogMTAwMDA1NDAwNywKICAgICAgICBWS19GT1JNQVRfQVNUQ180eDRfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NmUzLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NF9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDAxLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NV9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDAyLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4NV9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDAzLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4Nl9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA0LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4NV9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA1LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4Nl9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA2LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4OF9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA3LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDVfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwOCwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg2X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDksCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4OF9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDEwLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDEwX1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMTEsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTJ4MTBfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAxMiwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMngxMl9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDEzLAogICAgICAgIFZLX0ZPUk1BVF9HOEI4RzhSOF80MjJfVU5PUk1fS0hSOiAxMDAwMTU2ZTMsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEc4XzQyMl9VTk9STV9LSFI6IDEwMDAxNTYwMDEsCiAgICAgICAgVktfRk9STUFUX0c4X0I4X1I4XzNQTEFORV80MjBfVU5PUk1fS0hSOiAxMDAwMTU2MDAyLAogICAgICAgIFZLX0ZPUk1BVF9HOF9COFI4XzJQTEFORV80MjBfVU5PUk1fS0hSOiAxMDAwMTU2MDAzLAogICAgICAgIFZLX0ZPUk1BVF9HOF9COF9SOF8zUExBTkVfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAwNCwKICAgICAgICBWS19GT1JNQVRfRzhfQjhSOF8yUExBTkVfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAwNSwKICAgICAgICBWS19GT1JNQVRfRzhfQjhfUjhfM1BMQU5FXzQ0NF9VTk9STV9LSFI6IDEwMDAxNTYwMDYsCiAgICAgICAgVktfRk9STUFUX1IxMFg2X1VOT1JNX1BBQ0sxNl9LSFI6IDEwMDAxNTYwMDcsCiAgICAgICAgVktfRk9STUFUX1IxMFg2RzEwWDZfVU5PUk1fMlBBQ0sxNl9LSFI6IDEwMDAxNTYwMDgsCiAgICAgICAgVktfRk9STUFUX1IxMFg2RzEwWDZCMTBYNkExMFg2X1VOT1JNXzRQQUNLMTZfS0hSOiAxMDAwMTU2MDA5LAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNkIxMFg2RzEwWDZSMTBYNl80MjJfVU5PUk1fNFBBQ0sxNl9LSFI6IDEwMDAxNTYwMTAsCiAgICAgICAgVktfRk9STUFUX0IxMFg2RzEwWDZSMTBYNkcxMFg2XzQyMl9VTk9STV80UEFDSzE2X0tIUjogMTAwMDE1NjAxMSwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZfUjEwWDZfM1BMQU5FXzQyMF9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAxMiwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZSMTBYNl8yUExBTkVfNDIwX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDEzLAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDIyX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDE0LAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNlIxMFg2XzJQTEFORV80MjJfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMTUsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2X1IxMFg2XzNQTEFORV80NDRfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMTYsCiAgICAgICAgVktfRk9STUFUX1IxMlg0X1VOT1JNX1BBQ0sxNl9LSFI6IDEwMDAxNTYwMTcsCiAgICAgICAgVktfRk9STUFUX1IxMlg0RzEyWDRfVU5PUk1fMlBBQ0sxNl9LSFI6IDEwMDAxNTYwMTgsCiAgICAgICAgVktfRk9STUFUX1IxMlg0RzEyWDRCMTJYNEExMlg0X1VOT1JNXzRQQUNLMTZfS0hSOiAxMDAwMTU2MDE5LAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNEIxMlg0RzEyWDRSMTJYNF80MjJfVU5PUk1fNFBBQ0sxNl9LSFI6IDEwMDAxNTYwMjAsCiAgICAgICAgVktfRk9STUFUX0IxMlg0RzEyWDRSMTJYNEcxMlg0XzQyMl9VTk9STV80UEFDSzE2X0tIUjogMTAwMDE1NjAyMSwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRfUjEyWDRfM1BMQU5FXzQyMF9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAyMiwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRSMTJYNF8yUExBTkVfNDIwX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDIzLAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNF9SMTJYNF8zUExBTkVfNDIyX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDI0LAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNFIxMlg0XzJQTEFORV80MjJfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMjUsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80NDRfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMjYsCiAgICAgICAgVktfRk9STUFUX0cxNkIxNkcxNlIxNl80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDI3LAogICAgICAgIFZLX0ZPUk1BVF9CMTZHMTZSMTZHMTZfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAyOCwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNl9SMTZfM1BMQU5FXzQyMF9VTk9STV9LSFI6IDEwMDAxNTYwMjksCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZSMTZfMlBMQU5FXzQyMF9VTk9STV9LSFI6IDEwMDAxNTYwMzAsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZfUjE2XzNQTEFORV80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDMxLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2UjE2XzJQTEFORV80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDMyLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2X1IxNl8zUExBTkVfNDQ0X1VOT1JNX0tIUjogMTAwMDE1NjAzMwogICAgICB9OwogICAgICBWdWxrYW5Db25zdGFudHNfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoVnVsa2FuQ29uc3RhbnRzKTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL2t0eC1wYXJzZS9kaXN0L2t0eC1wYXJzZS5tb2Rlcm4uanMKICBmdW5jdGlvbiBkZWNvZGVUZXh0KGJ1ZmZlcikgewogICAgcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShidWZmZXIpOwogIH0KICBmdW5jdGlvbiByZWFkMihkYXRhKSB7CiAgICBjb25zdCBpZCA9IG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIEtUWDJfSUQubGVuZ3RoKTsKICAgIGlmIChpZFswXSAhPT0gS1RYMl9JRFswXSB8fCAvLyAnwrQnCiAgICBpZFsxXSAhPT0gS1RYMl9JRFsxXSB8fCAvLyAnSycKICAgIGlkWzJdICE9PSBLVFgyX0lEWzJdIHx8IC8vICdUJwogICAgaWRbM10gIT09IEtUWDJfSURbM10gfHwgLy8gJ1gnCiAgICBpZFs0XSAhPT0gS1RYMl9JRFs0XSB8fCAvLyAnICcKICAgIGlkWzVdICE9PSBLVFgyX0lEWzVdIHx8IC8vICcyJwogICAgaWRbNl0gIT09IEtUWDJfSURbNl0gfHwgLy8gJzAnCiAgICBpZFs3XSAhPT0gS1RYMl9JRFs3XSB8fCAvLyAnwqonCiAgICBpZFs4XSAhPT0gS1RYMl9JRFs4XSB8fCAvLyAnXHInCiAgICBpZFs5XSAhPT0gS1RYMl9JRFs5XSB8fCAvLyAnXG4nCiAgICBpZFsxMF0gIT09IEtUWDJfSURbMTBdIHx8IC8vICdceDFBJwogICAgaWRbMTFdICE9PSBLVFgyX0lEWzExXSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgS1RYIDIuMCBpZGVudGlmaWVyLiIpOwogICAgfQogICAgY29uc3QgY29udGFpbmVyID0gbmV3IEtUWDJDb250YWluZXIoKTsKICAgIGNvbnN0IGhlYWRlckJ5dGVMZW5ndGggPSAxNyAqIFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgY29uc3QgaGVhZGVyUmVhZGVyID0gbmV3IEJ1ZmZlclJlYWRlcihkYXRhLCBLVFgyX0lELmxlbmd0aCwgaGVhZGVyQnl0ZUxlbmd0aCwgdHJ1ZSk7CiAgICBjb250YWluZXIudmtGb3JtYXQgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci50eXBlU2l6ZSA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29udGFpbmVyLnBpeGVsV2lkdGggPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci5waXhlbEhlaWdodCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29udGFpbmVyLnBpeGVsRGVwdGggPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci5sYXllckNvdW50ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb250YWluZXIuZmFjZUNvdW50ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBsZXZlbENvdW50ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb250YWluZXIuc3VwZXJjb21wcmVzc2lvblNjaGVtZSA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgZGZkQnl0ZU9mZnNldCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgZGZkQnl0ZUxlbmd0aCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3Qga3ZkQnl0ZU9mZnNldCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3Qga3ZkQnl0ZUxlbmd0aCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3Qgc2dkQnl0ZU9mZnNldCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQ2NCgpOwogICAgY29uc3Qgc2dkQnl0ZUxlbmd0aCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQ2NCgpOwogICAgY29uc3QgbGV2ZWxCeXRlTGVuZ3RoID0gbGV2ZWxDb3VudCAqIDMgKiA4OwogICAgY29uc3QgbGV2ZWxSZWFkZXIgPSBuZXcgQnVmZmVyUmVhZGVyKGRhdGEsIEtUWDJfSUQubGVuZ3RoICsgaGVhZGVyQnl0ZUxlbmd0aCwgbGV2ZWxCeXRlTGVuZ3RoLCB0cnVlKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGV2ZWxDb3VudDsgaSsrKSB7CiAgICAgIGNvbnRhaW5lci5sZXZlbHMucHVzaCh7CiAgICAgICAgbGV2ZWxEYXRhOiBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgbGV2ZWxSZWFkZXIuX25leHRVaW50NjQoKSwgbGV2ZWxSZWFkZXIuX25leHRVaW50NjQoKSksCiAgICAgICAgdW5jb21wcmVzc2VkQnl0ZUxlbmd0aDogbGV2ZWxSZWFkZXIuX25leHRVaW50NjQoKQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGRmZFJlYWRlciA9IG5ldyBCdWZmZXJSZWFkZXIoZGF0YSwgZGZkQnl0ZU9mZnNldCwgZGZkQnl0ZUxlbmd0aCwgdHJ1ZSk7CiAgICBjb25zdCBkZmQgPSB7CiAgICAgIHZlbmRvcklkOiBkZmRSZWFkZXIuX3NraXAoCiAgICAgICAgNAogICAgICAgIC8qIHRvdGFsU2l6ZSAqLwogICAgICApLl9uZXh0VWludDE2KCksCiAgICAgIGRlc2NyaXB0b3JUeXBlOiBkZmRSZWFkZXIuX25leHRVaW50MTYoKSwKICAgICAgdmVyc2lvbk51bWJlcjogZGZkUmVhZGVyLl9uZXh0VWludDE2KCksCiAgICAgIGRlc2NyaXB0b3JCbG9ja1NpemU6IGRmZFJlYWRlci5fbmV4dFVpbnQxNigpLAogICAgICBjb2xvck1vZGVsOiBkZmRSZWFkZXIuX25leHRVaW50OCgpLAogICAgICBjb2xvclByaW1hcmllczogZGZkUmVhZGVyLl9uZXh0VWludDgoKSwKICAgICAgdHJhbnNmZXJGdW5jdGlvbjogZGZkUmVhZGVyLl9uZXh0VWludDgoKSwKICAgICAgZmxhZ3M6IGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksCiAgICAgIHRleGVsQmxvY2tEaW1lbnNpb246IFtkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpXSwKICAgICAgYnl0ZXNQbGFuZTogW2RmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCldLAogICAgICBzYW1wbGVzOiBbXQogICAgfTsKICAgIGNvbnN0IHNhbXBsZVN0YXJ0ID0gNjsKICAgIGNvbnN0IHNhbXBsZVdvcmRzID0gNDsKICAgIGNvbnN0IG51bVNhbXBsZXMgPSAoZGZkLmRlc2NyaXB0b3JCbG9ja1NpemUgLyA0IC0gc2FtcGxlU3RhcnQpIC8gc2FtcGxlV29yZHM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVNhbXBsZXM7IGkrKykgewogICAgICBjb25zdCBzYW1wbGUgPSB7CiAgICAgICAgYml0T2Zmc2V0OiBkZmRSZWFkZXIuX25leHRVaW50MTYoKSwKICAgICAgICBiaXRMZW5ndGg6IGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksCiAgICAgICAgY2hhbm5lbFR5cGU6IGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksCiAgICAgICAgc2FtcGxlUG9zaXRpb246IFtkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpXSwKICAgICAgICBzYW1wbGVMb3dlcjogLUluZmluaXR5LAogICAgICAgIHNhbXBsZVVwcGVyOiBJbmZpbml0eQogICAgICB9OwogICAgICBpZiAoc2FtcGxlLmNoYW5uZWxUeXBlICYgS0hSX0RGX1NBTVBMRV9EQVRBVFlQRV9TSUdORUQpIHsKICAgICAgICBzYW1wbGUuc2FtcGxlTG93ZXIgPSBkZmRSZWFkZXIuX25leHRJbnQzMigpOwogICAgICAgIHNhbXBsZS5zYW1wbGVVcHBlciA9IGRmZFJlYWRlci5fbmV4dEludDMyKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2FtcGxlLnNhbXBsZUxvd2VyID0gZGZkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICAgICAgc2FtcGxlLnNhbXBsZVVwcGVyID0gZGZkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICAgIH0KICAgICAgZGZkLnNhbXBsZXNbaV0gPSBzYW1wbGU7CiAgICB9CiAgICBjb250YWluZXIuZGF0YUZvcm1hdERlc2NyaXB0b3IubGVuZ3RoID0gMDsKICAgIGNvbnRhaW5lci5kYXRhRm9ybWF0RGVzY3JpcHRvci5wdXNoKGRmZCk7CiAgICBjb25zdCBrdmRSZWFkZXIgPSBuZXcgQnVmZmVyUmVhZGVyKGRhdGEsIGt2ZEJ5dGVPZmZzZXQsIGt2ZEJ5dGVMZW5ndGgsIHRydWUpOwogICAgd2hpbGUgKGt2ZFJlYWRlci5fb2Zmc2V0IDwga3ZkQnl0ZUxlbmd0aCkgewogICAgICBjb25zdCBrZXlWYWx1ZUJ5dGVMZW5ndGggPSBrdmRSZWFkZXIuX25leHRVaW50MzIoKTsKICAgICAgY29uc3Qga2V5RGF0YSA9IGt2ZFJlYWRlci5fc2NhbihrZXlWYWx1ZUJ5dGVMZW5ndGgpOwogICAgICBjb25zdCBrZXkgPSBkZWNvZGVUZXh0KGtleURhdGEpOwogICAgICBjb250YWluZXIua2V5VmFsdWVba2V5XSA9IGt2ZFJlYWRlci5fbmV4dFVpbnQ4QXJyYXkoa2V5VmFsdWVCeXRlTGVuZ3RoIC0ga2V5RGF0YS5ieXRlTGVuZ3RoIC0gMSk7CiAgICAgIGlmIChrZXkubWF0Y2goL15rdHgvaSkpIHsKICAgICAgICBjb25zdCB0ZXh0ID0gZGVjb2RlVGV4dChjb250YWluZXIua2V5VmFsdWVba2V5XSk7CiAgICAgICAgY29udGFpbmVyLmtleVZhbHVlW2tleV0gPSB0ZXh0LnN1YnN0cmluZygwLCB0ZXh0Lmxhc3RJbmRleE9mKCJcMCIpKTsKICAgICAgfQogICAgICBjb25zdCBrdlBhZGRpbmcgPSBrZXlWYWx1ZUJ5dGVMZW5ndGggJSA0ID8gNCAtIGtleVZhbHVlQnl0ZUxlbmd0aCAlIDQgOiAwOwogICAgICBrdmRSZWFkZXIuX3NraXAoa3ZQYWRkaW5nKTsKICAgIH0KICAgIGlmIChzZ2RCeXRlTGVuZ3RoIDw9IDApIHJldHVybiBjb250YWluZXI7CiAgICBjb25zdCBzZ2RSZWFkZXIgPSBuZXcgQnVmZmVyUmVhZGVyKGRhdGEsIHNnZEJ5dGVPZmZzZXQsIHNnZEJ5dGVMZW5ndGgsIHRydWUpOwogICAgY29uc3QgZW5kcG9pbnRDb3VudCA9IHNnZFJlYWRlci5fbmV4dFVpbnQxNigpOwogICAgY29uc3Qgc2VsZWN0b3JDb3VudCA9IHNnZFJlYWRlci5fbmV4dFVpbnQxNigpOwogICAgY29uc3QgZW5kcG9pbnRzQnl0ZUxlbmd0aCA9IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3Qgc2VsZWN0b3JzQnl0ZUxlbmd0aCA9IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgdGFibGVzQnl0ZUxlbmd0aCA9IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgZXh0ZW5kZWRCeXRlTGVuZ3RoID0gc2dkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBpbWFnZURlc2NzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxldmVsQ291bnQ7IGkrKykgewogICAgICBpbWFnZURlc2NzLnB1c2goewogICAgICAgIGltYWdlRmxhZ3M6IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpLAogICAgICAgIHJnYlNsaWNlQnl0ZU9mZnNldDogc2dkUmVhZGVyLl9uZXh0VWludDMyKCksCiAgICAgICAgcmdiU2xpY2VCeXRlTGVuZ3RoOiBzZ2RSZWFkZXIuX25leHRVaW50MzIoKSwKICAgICAgICBhbHBoYVNsaWNlQnl0ZU9mZnNldDogc2dkUmVhZGVyLl9uZXh0VWludDMyKCksCiAgICAgICAgYWxwaGFTbGljZUJ5dGVMZW5ndGg6IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgZW5kcG9pbnRzQnl0ZU9mZnNldCA9IHNnZEJ5dGVPZmZzZXQgKyBzZ2RSZWFkZXIuX29mZnNldDsKICAgIGNvbnN0IHNlbGVjdG9yc0J5dGVPZmZzZXQgPSBlbmRwb2ludHNCeXRlT2Zmc2V0ICsgZW5kcG9pbnRzQnl0ZUxlbmd0aDsKICAgIGNvbnN0IHRhYmxlc0J5dGVPZmZzZXQgPSBzZWxlY3RvcnNCeXRlT2Zmc2V0ICsgc2VsZWN0b3JzQnl0ZUxlbmd0aDsKICAgIGNvbnN0IGV4dGVuZGVkQnl0ZU9mZnNldCA9IHRhYmxlc0J5dGVPZmZzZXQgKyB0YWJsZXNCeXRlTGVuZ3RoOwogICAgY29uc3QgZW5kcG9pbnRzRGF0YSA9IG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBlbmRwb2ludHNCeXRlT2Zmc2V0LCBlbmRwb2ludHNCeXRlTGVuZ3RoKTsKICAgIGNvbnN0IHNlbGVjdG9yc0RhdGEgPSBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgc2VsZWN0b3JzQnl0ZU9mZnNldCwgc2VsZWN0b3JzQnl0ZUxlbmd0aCk7CiAgICBjb25zdCB0YWJsZXNEYXRhID0gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIHRhYmxlc0J5dGVPZmZzZXQsIHRhYmxlc0J5dGVMZW5ndGgpOwogICAgY29uc3QgZXh0ZW5kZWREYXRhID0gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIGV4dGVuZGVkQnl0ZU9mZnNldCwgZXh0ZW5kZWRCeXRlTGVuZ3RoKTsKICAgIGNvbnRhaW5lci5nbG9iYWxEYXRhID0gewogICAgICBlbmRwb2ludENvdW50LAogICAgICBzZWxlY3RvckNvdW50LAogICAgICBpbWFnZURlc2NzLAogICAgICBlbmRwb2ludHNEYXRhLAogICAgICBzZWxlY3RvcnNEYXRhLAogICAgICB0YWJsZXNEYXRhLAogICAgICBleHRlbmRlZERhdGEKICAgIH07CiAgICByZXR1cm4gY29udGFpbmVyOwogIH0KICB2YXIgS0hSX1NVUEVSQ09NUFJFU1NJT05fTk9ORSwgS0hSX0RGX0tIUl9ERVNDUklQVE9SVFlQRV9CQVNJQ0ZPUk1BVCwgS0hSX0RGX1ZFTkRPUklEX0tIUk9OT1MsIEtIUl9ERl9WRVJTSU9OLCBLSFJfREZfTU9ERUxfVU5TUEVDSUZJRUQsIEtIUl9ERl9GTEFHX0FMUEhBX1NUUkFJR0hULCBLSFJfREZfVFJBTlNGRVJfU1JHQiwgS0hSX0RGX1BSSU1BUklFU19CVDcwOSwgS0hSX0RGX1NBTVBMRV9EQVRBVFlQRV9TSUdORUQsIFZLX0ZPUk1BVF9VTkRFRklORUQsIEtUWDJDb250YWluZXIsIEJ1ZmZlclJlYWRlciwgTlVMLCBLVFgyX0lEOwogIHZhciBpbml0X2t0eF9wYXJzZV9tb2Rlcm4gPSBfX2VzbSh7CiAgICAibm9kZV9tb2R1bGVzL2t0eC1wYXJzZS9kaXN0L2t0eC1wYXJzZS5tb2Rlcm4uanMiKCkgewogICAgICBLSFJfU1VQRVJDT01QUkVTU0lPTl9OT05FID0gMDsKICAgICAgS0hSX0RGX0tIUl9ERVNDUklQVE9SVFlQRV9CQVNJQ0ZPUk1BVCA9IDA7CiAgICAgIEtIUl9ERl9WRU5ET1JJRF9LSFJPTk9TID0gMDsKICAgICAgS0hSX0RGX1ZFUlNJT04gPSAyOwogICAgICBLSFJfREZfTU9ERUxfVU5TUEVDSUZJRUQgPSAwOwogICAgICBLSFJfREZfRkxBR19BTFBIQV9TVFJBSUdIVCA9IDA7CiAgICAgIEtIUl9ERl9UUkFOU0ZFUl9TUkdCID0gMjsKICAgICAgS0hSX0RGX1BSSU1BUklFU19CVDcwOSA9IDE7CiAgICAgIEtIUl9ERl9TQU1QTEVfREFUQVRZUEVfU0lHTkVEID0gNjQ7CiAgICAgIFZLX0ZPUk1BVF9VTkRFRklORUQgPSAwOwogICAgICBLVFgyQ29udGFpbmVyID0gY2xhc3MgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgdGhpcy52a0Zvcm1hdCA9IFZLX0ZPUk1BVF9VTkRFRklORUQ7CiAgICAgICAgICB0aGlzLnR5cGVTaXplID0gMTsKICAgICAgICAgIHRoaXMucGl4ZWxXaWR0aCA9IDA7CiAgICAgICAgICB0aGlzLnBpeGVsSGVpZ2h0ID0gMDsKICAgICAgICAgIHRoaXMucGl4ZWxEZXB0aCA9IDA7CiAgICAgICAgICB0aGlzLmxheWVyQ291bnQgPSAwOwogICAgICAgICAgdGhpcy5mYWNlQ291bnQgPSAxOwogICAgICAgICAgdGhpcy5zdXBlcmNvbXByZXNzaW9uU2NoZW1lID0gS0hSX1NVUEVSQ09NUFJFU1NJT05fTk9ORTsKICAgICAgICAgIHRoaXMubGV2ZWxzID0gW107CiAgICAgICAgICB0aGlzLmRhdGFGb3JtYXREZXNjcmlwdG9yID0gW3sKICAgICAgICAgICAgdmVuZG9ySWQ6IEtIUl9ERl9WRU5ET1JJRF9LSFJPTk9TLAogICAgICAgICAgICBkZXNjcmlwdG9yVHlwZTogS0hSX0RGX0tIUl9ERVNDUklQVE9SVFlQRV9CQVNJQ0ZPUk1BVCwKICAgICAgICAgICAgZGVzY3JpcHRvckJsb2NrU2l6ZTogMCwKICAgICAgICAgICAgdmVyc2lvbk51bWJlcjogS0hSX0RGX1ZFUlNJT04sCiAgICAgICAgICAgIGNvbG9yTW9kZWw6IEtIUl9ERl9NT0RFTF9VTlNQRUNJRklFRCwKICAgICAgICAgICAgY29sb3JQcmltYXJpZXM6IEtIUl9ERl9QUklNQVJJRVNfQlQ3MDksCiAgICAgICAgICAgIHRyYW5zZmVyRnVuY3Rpb246IEtIUl9ERl9UUkFOU0ZFUl9TUkdCLAogICAgICAgICAgICBmbGFnczogS0hSX0RGX0ZMQUdfQUxQSEFfU1RSQUlHSFQsCiAgICAgICAgICAgIHRleGVsQmxvY2tEaW1lbnNpb246IFswLCAwLCAwLCAwXSwKICAgICAgICAgICAgYnl0ZXNQbGFuZTogWzAsIDAsIDAsIDAsIDAsIDAsIDAsIDBdLAogICAgICAgICAgICBzYW1wbGVzOiBbXQogICAgICAgICAgfV07CiAgICAgICAgICB0aGlzLmtleVZhbHVlID0ge307CiAgICAgICAgICB0aGlzLmdsb2JhbERhdGEgPSBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQnVmZmVyUmVhZGVyID0gY2xhc3MgewogICAgICAgIGNvbnN0cnVjdG9yKGRhdGEsIGJ5dGVPZmZzZXQsIGJ5dGVMZW5ndGgsIGxpdHRsZUVuZGlhbjIpIHsKICAgICAgICAgIHRoaXMuX2RhdGFWaWV3ID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5fbGl0dGxlRW5kaWFuID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5fZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIGJ5dGVPZmZzZXQsIGJ5dGVMZW5ndGgpOwogICAgICAgICAgdGhpcy5fbGl0dGxlRW5kaWFuID0gbGl0dGxlRW5kaWFuMjsKICAgICAgICAgIHRoaXMuX29mZnNldCA9IDA7CiAgICAgICAgfQogICAgICAgIF9uZXh0VWludDgoKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2RhdGFWaWV3LmdldFVpbnQ4KHRoaXMuX29mZnNldCk7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gMTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX25leHRVaW50MTYoKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2RhdGFWaWV3LmdldFVpbnQxNih0aGlzLl9vZmZzZXQsIHRoaXMuX2xpdHRsZUVuZGlhbik7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gMjsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX25leHRVaW50MzIoKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2RhdGFWaWV3LmdldFVpbnQzMih0aGlzLl9vZmZzZXQsIHRoaXMuX2xpdHRsZUVuZGlhbik7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gNDsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX25leHRVaW50NjQoKSB7CiAgICAgICAgICBjb25zdCBsZWZ0ID0gdGhpcy5fZGF0YVZpZXcuZ2V0VWludDMyKHRoaXMuX29mZnNldCwgdGhpcy5fbGl0dGxlRW5kaWFuKTsKICAgICAgICAgIGNvbnN0IHJpZ2h0ID0gdGhpcy5fZGF0YVZpZXcuZ2V0VWludDMyKHRoaXMuX29mZnNldCArIDQsIHRoaXMuX2xpdHRsZUVuZGlhbik7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGxlZnQgKyAyICoqIDMyICogcmlnaHQ7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gODsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX25leHRJbnQzMigpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fZGF0YVZpZXcuZ2V0SW50MzIodGhpcy5fb2Zmc2V0LCB0aGlzLl9saXR0bGVFbmRpYW4pOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IDQ7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIF9uZXh0VWludDhBcnJheShsZW4pIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5fZGF0YVZpZXcuYnVmZmVyLCB0aGlzLl9kYXRhVmlldy5ieXRlT2Zmc2V0ICsgdGhpcy5fb2Zmc2V0LCBsZW4pOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IGxlbjsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX3NraXAoYnl0ZXMpIHsKICAgICAgICAgIHRoaXMuX29mZnNldCArPSBieXRlczsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBfc2NhbihtYXhCeXRlTGVuZ3RoLCB0ZXJtID0gMCkgewogICAgICAgICAgY29uc3QgYnl0ZU9mZnNldCA9IHRoaXMuX29mZnNldDsKICAgICAgICAgIGxldCBieXRlTGVuZ3RoID0gMDsKICAgICAgICAgIHdoaWxlICh0aGlzLl9kYXRhVmlldy5nZXRVaW50OCh0aGlzLl9vZmZzZXQpICE9PSB0ZXJtICYmIGJ5dGVMZW5ndGggPCBtYXhCeXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIGJ5dGVMZW5ndGgrKzsKICAgICAgICAgICAgdGhpcy5fb2Zmc2V0Kys7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYnl0ZUxlbmd0aCA8IG1heEJ5dGVMZW5ndGgpIHRoaXMuX29mZnNldCsrOwogICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHRoaXMuX2RhdGFWaWV3LmJ1ZmZlciwgdGhpcy5fZGF0YVZpZXcuYnl0ZU9mZnNldCArIGJ5dGVPZmZzZXQsIGJ5dGVMZW5ndGgpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgTlVMID0gbmV3IFVpbnQ4QXJyYXkoWzBdKTsKICAgICAgS1RYMl9JRCA9IFsKICAgICAgICAvLyAnwrQnLCAnSycsICdUJywgJ1gnLCAnMicsICcwJywgJ8KqJywgJ1xyJywgJ1xuJywgJ1x4MUEnLCAnXG4nCiAgICAgICAgMTcxLAogICAgICAgIDc1LAogICAgICAgIDg0LAogICAgICAgIDg4LAogICAgICAgIDMyLAogICAgICAgIDUwLAogICAgICAgIDQ4LAogICAgICAgIDE4NywKICAgICAgICAxMywKICAgICAgICAxMCwKICAgICAgICAyNiwKICAgICAgICAxMAogICAgICBdOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1RoaXJkUGFydHkvV29ya2Vycy9iYXNpc190cmFuc2NvZGVyLmpzCiAgdmFyIHJlcXVpcmVfYmFzaXNfdHJhbnNjb2RlciA9IF9fY29tbW9uSlMoewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvVGhpcmRQYXJ0eS9Xb3JrZXJzL2Jhc2lzX3RyYW5zY29kZXIuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgdmFyIEJBU0lTID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIF9zY3JpcHREaXIgPSB0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQgPyBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYyA6IHZvaWQgMDsKICAgICAgICBpZiAodHlwZW9mIF9fZmlsZW5hbWUgIT09ICJ1bmRlZmluZWQiKSBfc2NyaXB0RGlyID0gX3NjcmlwdERpciB8fCBfX2ZpbGVuYW1lOwogICAgICAgIHJldHVybiBmdW5jdGlvbihCQVNJUzIpIHsKICAgICAgICAgIEJBU0lTMiA9IEJBU0lTMiB8fCB7fTsKICAgICAgICAgIHZhciBNb2R1bGUgPSB0eXBlb2YgQkFTSVMyICE9PSAidW5kZWZpbmVkIiA/IEJBU0lTMiA6IHt9OwogICAgICAgICAgdmFyIHJlYWR5UHJvbWlzZVJlc29sdmUsIHJlYWR5UHJvbWlzZVJlamVjdDsKICAgICAgICAgIE1vZHVsZVsicmVhZHkiXSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICByZWFkeVByb21pc2VSZXNvbHZlID0gcmVzb2x2ZTsKICAgICAgICAgICAgcmVhZHlQcm9taXNlUmVqZWN0ID0gcmVqZWN0OwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgbW9kdWxlT3ZlcnJpZGVzID0ge307CiAgICAgICAgICB2YXIga2V5OwogICAgICAgICAgZm9yIChrZXkgaW4gTW9kdWxlKSB7CiAgICAgICAgICAgIGlmIChNb2R1bGUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIG1vZHVsZU92ZXJyaWRlc1trZXldID0gTW9kdWxlW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBhcmd1bWVudHNfID0gW107CiAgICAgICAgICB2YXIgdGhpc1Byb2dyYW0gPSAiLi90aGlzLnByb2dyYW0iOwogICAgICAgICAgdmFyIHF1aXRfID0gZnVuY3Rpb24oc3RhdHVzLCB0b1Rocm93KSB7CiAgICAgICAgICAgIHRocm93IHRvVGhyb3c7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIEVOVklST05NRU5UX0lTX1dFQiA9IGZhbHNlOwogICAgICAgICAgdmFyIEVOVklST05NRU5UX0lTX1dPUktFUiA9IGZhbHNlOwogICAgICAgICAgdmFyIEVOVklST05NRU5UX0lTX05PREUgPSBmYWxzZTsKICAgICAgICAgIHZhciBFTlZJUk9OTUVOVF9JU19TSEVMTCA9IGZhbHNlOwogICAgICAgICAgRU5WSVJPTk1FTlRfSVNfV0VCID0gdHlwZW9mIHdpbmRvdyA9PT0gIm9iamVjdCI7CiAgICAgICAgICBFTlZJUk9OTUVOVF9JU19XT1JLRVIgPSB0eXBlb2YgaW1wb3J0U2NyaXB0cyA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIEVOVklST05NRU5UX0lTX05PREUgPSB0eXBlb2YgcHJvY2VzcyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHByb2Nlc3MudmVyc2lvbnMgPT09ICJvYmplY3QiICYmIHR5cGVvZiBwcm9jZXNzLnZlcnNpb25zLm5vZGUgPT09ICJzdHJpbmciOwogICAgICAgICAgRU5WSVJPTk1FTlRfSVNfU0hFTEwgPSAhRU5WSVJPTk1FTlRfSVNfV0VCICYmICFFTlZJUk9OTUVOVF9JU19OT0RFICYmICFFTlZJUk9OTUVOVF9JU19XT1JLRVI7CiAgICAgICAgICB2YXIgc2NyaXB0RGlyZWN0b3J5ID0gIiI7CiAgICAgICAgICBmdW5jdGlvbiBsb2NhdGVGaWxlKHBhdGgpIHsKICAgICAgICAgICAgaWYgKE1vZHVsZVsibG9jYXRlRmlsZSJdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1vZHVsZVsibG9jYXRlRmlsZSJdKHBhdGgsIHNjcmlwdERpcmVjdG9yeSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNjcmlwdERpcmVjdG9yeSArIHBhdGg7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVhZF8sIHJlYWRBc3luYywgcmVhZEJpbmFyeSwgc2V0V2luZG93VGl0bGU7CiAgICAgICAgICB2YXIgbm9kZUZTOwogICAgICAgICAgdmFyIG5vZGVQYXRoOwogICAgICAgICAgaWYgKEVOVklST05NRU5UX0lTX05PREUpIHsKICAgICAgICAgICAgaWYgKEVOVklST05NRU5UX0lTX1dPUktFUikgewogICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IF9fcmVxdWlyZSgicGF0aCIpLmRpcm5hbWUoc2NyaXB0RGlyZWN0b3J5KSArICIvIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSBfX2Rpcm5hbWUgKyAiLyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVhZF8gPSBmdW5jdGlvbiBzaGVsbF9yZWFkKGZpbGVuYW1lLCBiaW5hcnkpIHsKICAgICAgICAgICAgICBpZiAoIW5vZGVGUykgbm9kZUZTID0gX19yZXF1aXJlKCJmcyIpOwogICAgICAgICAgICAgIGlmICghbm9kZVBhdGgpIG5vZGVQYXRoID0gX19yZXF1aXJlKCJwYXRoIik7CiAgICAgICAgICAgICAgZmlsZW5hbWUgPSBub2RlUGF0aFsibm9ybWFsaXplIl0oZmlsZW5hbWUpOwogICAgICAgICAgICAgIHJldHVybiBub2RlRlNbInJlYWRGaWxlU3luYyJdKGZpbGVuYW1lLCBiaW5hcnkgPyBudWxsIDogInV0ZjgiKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmVhZEJpbmFyeSA9IGZ1bmN0aW9uIHJlYWRCaW5hcnkyKGZpbGVuYW1lKSB7CiAgICAgICAgICAgICAgdmFyIHJldCA9IHJlYWRfKGZpbGVuYW1lLCB0cnVlKTsKICAgICAgICAgICAgICBpZiAoIXJldC5idWZmZXIpIHsKICAgICAgICAgICAgICAgIHJldCA9IG5ldyBVaW50OEFycmF5KHJldCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFzc2VydChyZXQuYnVmZmVyKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAocHJvY2Vzc1siYXJndiJdLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICB0aGlzUHJvZ3JhbSA9IHByb2Nlc3NbImFyZ3YiXVsxXS5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFyZ3VtZW50c18gPSBwcm9jZXNzWyJhcmd2Il0uc2xpY2UoMik7CiAgICAgICAgICAgIHByb2Nlc3NbIm9uIl0oInVuY2F1Z2h0RXhjZXB0aW9uIiwgZnVuY3Rpb24oZXgpIHsKICAgICAgICAgICAgICBpZiAoIShleCBpbnN0YW5jZW9mIEV4aXRTdGF0dXMpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBwcm9jZXNzWyJvbiJdKCJ1bmhhbmRsZWRSZWplY3Rpb24iLCBhYm9ydCk7CiAgICAgICAgICAgIHF1aXRfID0gZnVuY3Rpb24oc3RhdHVzKSB7CiAgICAgICAgICAgICAgcHJvY2Vzc1siZXhpdCJdKHN0YXR1cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIE1vZHVsZVsiaW5zcGVjdCJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJbRW1zY3JpcHRlbiBNb2R1bGUgb2JqZWN0XSI7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKEVOVklST05NRU5UX0lTX1NIRUxMKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVhZCAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIHJlYWRfID0gZnVuY3Rpb24gc2hlbGxfcmVhZChmKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZChmKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlYWRCaW5hcnkgPSBmdW5jdGlvbiByZWFkQmluYXJ5MihmKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGE7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZWFkYnVmZmVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkocmVhZGJ1ZmZlcihmKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRhdGEgPSByZWFkKGYsICJiaW5hcnkiKTsKICAgICAgICAgICAgICBhc3NlcnQodHlwZW9mIGRhdGEgPT09ICJvYmplY3QiKTsKICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBzY3JpcHRBcmdzICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgYXJndW1lbnRzXyA9IHNjcmlwdEFyZ3M7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50cyAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGFyZ3VtZW50c18gPSBhcmd1bWVudHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBxdWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcXVpdF8gPSBmdW5jdGlvbihzdGF0dXMpIHsKICAgICAgICAgICAgICAgIHF1aXQoc3RhdHVzKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpbnQgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25zb2xlID09PSAidW5kZWZpbmVkIikgY29uc29sZSA9IHt9OwogICAgICAgICAgICAgIGNvbnNvbGUubG9nID0gcHJpbnQ7CiAgICAgICAgICAgICAgY29uc29sZS53YXJuID0gY29uc29sZS5lcnJvciA9IHR5cGVvZiBwcmludEVyciAhPT0gInVuZGVmaW5lZCIgPyBwcmludEVyciA6IHByaW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKEVOVklST05NRU5UX0lTX1dFQiB8fCBFTlZJUk9OTUVOVF9JU19XT1JLRVIpIHsKICAgICAgICAgICAgaWYgKEVOVklST05NRU5UX0lTX1dPUktFUikgewogICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IHNlbGYubG9jYXRpb24uaHJlZjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQpIHsKICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoX3NjcmlwdERpcikgewogICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IF9zY3JpcHREaXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNjcmlwdERpcmVjdG9yeS5pbmRleE9mKCJibG9iOiIpICE9PSAwKSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gc2NyaXB0RGlyZWN0b3J5LnN1YnN0cigwLCBzY3JpcHREaXJlY3RvcnkubGFzdEluZGV4T2YoIi8iKSArIDEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWFkXyA9IGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICAgICAgeGhyLm9wZW4oIkdFVCIsIHVybCwgZmFsc2UpOwogICAgICAgICAgICAgICAgeGhyLnNlbmQobnVsbCk7CiAgICAgICAgICAgICAgICByZXR1cm4geGhyLnJlc3BvbnNlVGV4dDsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChFTlZJUk9OTUVOVF9JU19XT1JLRVIpIHsKICAgICAgICAgICAgICAgIHJlYWRCaW5hcnkgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICAgICAgICB4aHIub3BlbigiR0VUIiwgdXJsLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAiYXJyYXlidWZmZXIiOwogICAgICAgICAgICAgICAgICB4aHIuc2VuZChudWxsKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHhoci5yZXNwb25zZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWFkQXN5bmMgPSBmdW5jdGlvbih1cmwsIG9ubG9hZCwgb25lcnJvcikgewogICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICAgICAgeGhyLm9wZW4oIkdFVCIsIHVybCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgICAgIHhoci5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT0gMjAwIHx8IHhoci5zdGF0dXMgPT0gMCAmJiB4aHIucmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICBvbmxvYWQoeGhyLnJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgb25lcnJvcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHhoci5vbmVycm9yID0gb25lcnJvcjsKICAgICAgICAgICAgICAgIHhoci5zZW5kKG51bGwpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0V2luZG93VGl0bGUgPSBmdW5jdGlvbih0aXRsZSkgewogICAgICAgICAgICAgIGRvY3VtZW50LnRpdGxlID0gdGl0bGU7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgfQogICAgICAgICAgdmFyIG91dCA9IE1vZHVsZVsicHJpbnQiXSB8fCBjb25zb2xlLmxvZy5iaW5kKGNvbnNvbGUpOwogICAgICAgICAgdmFyIGVyciA9IE1vZHVsZVsicHJpbnRFcnIiXSB8fCBjb25zb2xlLndhcm4uYmluZChjb25zb2xlKTsKICAgICAgICAgIGZvciAoa2V5IGluIG1vZHVsZU92ZXJyaWRlcykgewogICAgICAgICAgICBpZiAobW9kdWxlT3ZlcnJpZGVzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICBNb2R1bGVba2V5XSA9IG1vZHVsZU92ZXJyaWRlc1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtb2R1bGVPdmVycmlkZXMgPSBudWxsOwogICAgICAgICAgaWYgKE1vZHVsZVsiYXJndW1lbnRzIl0pIGFyZ3VtZW50c18gPSBNb2R1bGVbImFyZ3VtZW50cyJdOwogICAgICAgICAgaWYgKE1vZHVsZVsidGhpc1Byb2dyYW0iXSkgdGhpc1Byb2dyYW0gPSBNb2R1bGVbInRoaXNQcm9ncmFtIl07CiAgICAgICAgICBpZiAoTW9kdWxlWyJxdWl0Il0pIHF1aXRfID0gTW9kdWxlWyJxdWl0Il07CiAgICAgICAgICB2YXIgdGVtcFJldDAgPSAwOwogICAgICAgICAgdmFyIHNldFRlbXBSZXQwID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGVtcFJldDAgPSB2YWx1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FzbUJpbmFyeTsKICAgICAgICAgIGlmIChNb2R1bGVbIndhc21CaW5hcnkiXSkgd2FzbUJpbmFyeSA9IE1vZHVsZVsid2FzbUJpbmFyeSJdOwogICAgICAgICAgdmFyIG5vRXhpdFJ1bnRpbWUgPSBNb2R1bGVbIm5vRXhpdFJ1bnRpbWUiXSB8fCB0cnVlOwogICAgICAgICAgaWYgKHR5cGVvZiBXZWJBc3NlbWJseSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgYWJvcnQoIm5vIG5hdGl2ZSB3YXNtIHN1cHBvcnQgZGV0ZWN0ZWQiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNtTWVtb3J5OwogICAgICAgICAgdmFyIEFCT1JUID0gZmFsc2U7CiAgICAgICAgICB2YXIgRVhJVFNUQVRVUzsKICAgICAgICAgIGZ1bmN0aW9uIGFzc2VydChjb25kaXRpb24sIHRleHQpIHsKICAgICAgICAgICAgaWYgKCFjb25kaXRpb24pIHsKICAgICAgICAgICAgICBhYm9ydCgiQXNzZXJ0aW9uIGZhaWxlZDogIiArIHRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgVVRGOERlY29kZXIgPSB0eXBlb2YgVGV4dERlY29kZXIgIT09ICJ1bmRlZmluZWQiID8gbmV3IFRleHREZWNvZGVyKCJ1dGY4IikgOiB2b2lkIDA7CiAgICAgICAgICBmdW5jdGlvbiBVVEY4QXJyYXlUb1N0cmluZyhoZWFwLCBpZHgsIG1heEJ5dGVzVG9SZWFkKSB7CiAgICAgICAgICAgIHZhciBlbmRJZHggPSBpZHggKyBtYXhCeXRlc1RvUmVhZDsKICAgICAgICAgICAgdmFyIGVuZFB0ciA9IGlkeDsKICAgICAgICAgICAgd2hpbGUgKGhlYXBbZW5kUHRyXSAmJiAhKGVuZFB0ciA+PSBlbmRJZHgpKSArK2VuZFB0cjsKICAgICAgICAgICAgaWYgKGVuZFB0ciAtIGlkeCA+IDE2ICYmIGhlYXAuc3ViYXJyYXkgJiYgVVRGOERlY29kZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gVVRGOERlY29kZXIuZGVjb2RlKGhlYXAuc3ViYXJyYXkoaWR4LCBlbmRQdHIpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgc3RyID0gIiI7CiAgICAgICAgICAgICAgd2hpbGUgKGlkeCA8IGVuZFB0cikgewogICAgICAgICAgICAgICAgdmFyIHUwID0gaGVhcFtpZHgrK107CiAgICAgICAgICAgICAgICBpZiAoISh1MCAmIDEyOCkpIHsKICAgICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUodTApOwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB1MTIgPSBoZWFwW2lkeCsrXSAmIDYzOwogICAgICAgICAgICAgICAgaWYgKCh1MCAmIDIyNCkgPT0gMTkyKSB7CiAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCh1MCAmIDMxKSA8PCA2IHwgdTEyKTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdTIyID0gaGVhcFtpZHgrK10gJiA2MzsKICAgICAgICAgICAgICAgIGlmICgodTAgJiAyNDApID09IDIyNCkgewogICAgICAgICAgICAgICAgICB1MCA9ICh1MCAmIDE1KSA8PCAxMiB8IHUxMiA8PCA2IHwgdTIyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdTAgPSAodTAgJiA3KSA8PCAxOCB8IHUxMiA8PCAxMiB8IHUyMiA8PCA2IHwgaGVhcFtpZHgrK10gJiA2MzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1MCA8IDY1NTM2KSB7CiAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHUwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaCA9IHUwIC0gNjU1MzY7CiAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDU1Mjk2IHwgY2ggPj4gMTAsIDU2MzIwIHwgY2ggJiAxMDIzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFVURjhUb1N0cmluZyhwdHIsIG1heEJ5dGVzVG9SZWFkKSB7CiAgICAgICAgICAgIHJldHVybiBwdHIgPyBVVEY4QXJyYXlUb1N0cmluZyhIRUFQVTgsIHB0ciwgbWF4Qnl0ZXNUb1JlYWQpIDogIiI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdHJpbmdUb1VURjhBcnJheShzdHIsIGhlYXAsIG91dElkeCwgbWF4Qnl0ZXNUb1dyaXRlKSB7CiAgICAgICAgICAgIGlmICghKG1heEJ5dGVzVG9Xcml0ZSA+IDApKSByZXR1cm4gMDsKICAgICAgICAgICAgdmFyIHN0YXJ0SWR4ID0gb3V0SWR4OwogICAgICAgICAgICB2YXIgZW5kSWR4ID0gb3V0SWR4ICsgbWF4Qnl0ZXNUb1dyaXRlIC0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgdTMgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICBpZiAodTMgPj0gNTUyOTYgJiYgdTMgPD0gNTczNDMpIHsKICAgICAgICAgICAgICAgIHZhciB1MTIgPSBzdHIuY2hhckNvZGVBdCgrK2kpOwogICAgICAgICAgICAgICAgdTMgPSA2NTUzNiArICgodTMgJiAxMDIzKSA8PCAxMCkgfCB1MTIgJiAxMDIzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodTMgPD0gMTI3KSB7CiAgICAgICAgICAgICAgICBpZiAob3V0SWR4ID49IGVuZElkeCkgYnJlYWs7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IHUzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodTMgPD0gMjA0NykgewogICAgICAgICAgICAgICAgaWYgKG91dElkeCArIDEgPj0gZW5kSWR4KSBicmVhazsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTkyIHwgdTMgPj4gNjsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTI4IHwgdTMgJiA2MzsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHUzIDw9IDY1NTM1KSB7CiAgICAgICAgICAgICAgICBpZiAob3V0SWR4ICsgMiA+PSBlbmRJZHgpIGJyZWFrOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAyMjQgfCB1MyA+PiAxMjsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTI4IHwgdTMgPj4gNiAmIDYzOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyAmIDYzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAob3V0SWR4ICsgMyA+PSBlbmRJZHgpIGJyZWFrOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAyNDAgfCB1MyA+PiAxODsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTI4IHwgdTMgPj4gMTIgJiA2MzsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTI4IHwgdTMgPj4gNiAmIDYzOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyAmIDYzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBoZWFwW291dElkeF0gPSAwOwogICAgICAgICAgICByZXR1cm4gb3V0SWR4IC0gc3RhcnRJZHg7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdHJpbmdUb1VURjgoc3RyLCBvdXRQdHIsIG1heEJ5dGVzVG9Xcml0ZSkgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nVG9VVEY4QXJyYXkoc3RyLCBIRUFQVTgsIG91dFB0ciwgbWF4Qnl0ZXNUb1dyaXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGxlbmd0aEJ5dGVzVVRGOChzdHIpIHsKICAgICAgICAgICAgdmFyIGxlbiA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgdmFyIHUzID0gc3RyLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgICAgaWYgKHUzID49IDU1Mjk2ICYmIHUzIDw9IDU3MzQzKSB1MyA9IDY1NTM2ICsgKCh1MyAmIDEwMjMpIDw8IDEwKSB8IHN0ci5jaGFyQ29kZUF0KCsraSkgJiAxMDIzOwogICAgICAgICAgICAgIGlmICh1MyA8PSAxMjcpICsrbGVuOwogICAgICAgICAgICAgIGVsc2UgaWYgKHUzIDw9IDIwNDcpIGxlbiArPSAyOwogICAgICAgICAgICAgIGVsc2UgaWYgKHUzIDw9IDY1NTM1KSBsZW4gKz0gMzsKICAgICAgICAgICAgICBlbHNlIGxlbiArPSA0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZW47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgVVRGMTZEZWNvZGVyID0gdHlwZW9mIFRleHREZWNvZGVyICE9PSAidW5kZWZpbmVkIiA/IG5ldyBUZXh0RGVjb2RlcigidXRmLTE2bGUiKSA6IHZvaWQgMDsKICAgICAgICAgIGZ1bmN0aW9uIFVURjE2VG9TdHJpbmcocHRyLCBtYXhCeXRlc1RvUmVhZCkgewogICAgICAgICAgICB2YXIgZW5kUHRyID0gcHRyOwogICAgICAgICAgICB2YXIgaWR4ID0gZW5kUHRyID4+IDE7CiAgICAgICAgICAgIHZhciBtYXhJZHggPSBpZHggKyBtYXhCeXRlc1RvUmVhZCAvIDI7CiAgICAgICAgICAgIHdoaWxlICghKGlkeCA+PSBtYXhJZHgpICYmIEhFQVBVMTZbaWR4XSkgKytpZHg7CiAgICAgICAgICAgIGVuZFB0ciA9IGlkeCA8PCAxOwogICAgICAgICAgICBpZiAoZW5kUHRyIC0gcHRyID4gMzIgJiYgVVRGMTZEZWNvZGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFVURjE2RGVjb2Rlci5kZWNvZGUoSEVBUFU4LnN1YmFycmF5KHB0ciwgZW5kUHRyKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHN0ciA9ICIiOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyAhKGkgPj0gbWF4Qnl0ZXNUb1JlYWQgLyAyKTsgKytpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29kZVVuaXQgPSBIRUFQMTZbcHRyICsgaSAqIDIgPj4gMV07CiAgICAgICAgICAgICAgICBpZiAoY29kZVVuaXQgPT0gMCkgYnJlYWs7CiAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlVW5pdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0cmluZ1RvVVRGMTYoc3RyLCBvdXRQdHIsIG1heEJ5dGVzVG9Xcml0ZSkgewogICAgICAgICAgICBpZiAobWF4Qnl0ZXNUb1dyaXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBtYXhCeXRlc1RvV3JpdGUgPSAyMTQ3NDgzNjQ3OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtYXhCeXRlc1RvV3JpdGUgPCAyKSByZXR1cm4gMDsKICAgICAgICAgICAgbWF4Qnl0ZXNUb1dyaXRlIC09IDI7CiAgICAgICAgICAgIHZhciBzdGFydFB0ciA9IG91dFB0cjsKICAgICAgICAgICAgdmFyIG51bUNoYXJzVG9Xcml0ZSA9IG1heEJ5dGVzVG9Xcml0ZSA8IHN0ci5sZW5ndGggKiAyID8gbWF4Qnl0ZXNUb1dyaXRlIC8gMiA6IHN0ci5sZW5ndGg7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtQ2hhcnNUb1dyaXRlOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgY29kZVVuaXQgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICBIRUFQMTZbb3V0UHRyID4+IDFdID0gY29kZVVuaXQ7CiAgICAgICAgICAgICAgb3V0UHRyICs9IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSEVBUDE2W291dFB0ciA+PiAxXSA9IDA7CiAgICAgICAgICAgIHJldHVybiBvdXRQdHIgLSBzdGFydFB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGxlbmd0aEJ5dGVzVVRGMTYoc3RyKSB7CiAgICAgICAgICAgIHJldHVybiBzdHIubGVuZ3RoICogMjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFVURjMyVG9TdHJpbmcocHRyLCBtYXhCeXRlc1RvUmVhZCkgewogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciBzdHIgPSAiIjsKICAgICAgICAgICAgd2hpbGUgKCEoaSA+PSBtYXhCeXRlc1RvUmVhZCAvIDQpKSB7CiAgICAgICAgICAgICAgdmFyIHV0ZjMyID0gSEVBUDMyW3B0ciArIGkgKiA0ID4+IDJdOwogICAgICAgICAgICAgIGlmICh1dGYzMiA9PSAwKSBicmVhazsKICAgICAgICAgICAgICArK2k7CiAgICAgICAgICAgICAgaWYgKHV0ZjMyID49IDY1NTM2KSB7CiAgICAgICAgICAgICAgICB2YXIgY2ggPSB1dGYzMiAtIDY1NTM2OwogICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTYgfCBjaCA+PiAxMCwgNTYzMjAgfCBjaCAmIDEwMjMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSh1dGYzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdHJpbmdUb1VURjMyKHN0ciwgb3V0UHRyLCBtYXhCeXRlc1RvV3JpdGUpIHsKICAgICAgICAgICAgaWYgKG1heEJ5dGVzVG9Xcml0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgbWF4Qnl0ZXNUb1dyaXRlID0gMjE0NzQ4MzY0NzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWF4Qnl0ZXNUb1dyaXRlIDwgNCkgcmV0dXJuIDA7CiAgICAgICAgICAgIHZhciBzdGFydFB0ciA9IG91dFB0cjsKICAgICAgICAgICAgdmFyIGVuZFB0ciA9IHN0YXJ0UHRyICsgbWF4Qnl0ZXNUb1dyaXRlIC0gNDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgY29kZVVuaXQgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICBpZiAoY29kZVVuaXQgPj0gNTUyOTYgJiYgY29kZVVuaXQgPD0gNTczNDMpIHsKICAgICAgICAgICAgICAgIHZhciB0cmFpbFN1cnJvZ2F0ZSA9IHN0ci5jaGFyQ29kZUF0KCsraSk7CiAgICAgICAgICAgICAgICBjb2RlVW5pdCA9IDY1NTM2ICsgKChjb2RlVW5pdCAmIDEwMjMpIDw8IDEwKSB8IHRyYWlsU3Vycm9nYXRlICYgMTAyMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgSEVBUDMyW291dFB0ciA+PiAyXSA9IGNvZGVVbml0OwogICAgICAgICAgICAgIG91dFB0ciArPSA0OwogICAgICAgICAgICAgIGlmIChvdXRQdHIgKyA0ID4gZW5kUHRyKSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBIRUFQMzJbb3V0UHRyID4+IDJdID0gMDsKICAgICAgICAgICAgcmV0dXJuIG91dFB0ciAtIHN0YXJ0UHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbGVuZ3RoQnl0ZXNVVEYzMihzdHIpIHsKICAgICAgICAgICAgdmFyIGxlbiA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgdmFyIGNvZGVVbml0ID0gc3RyLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgICAgaWYgKGNvZGVVbml0ID49IDU1Mjk2ICYmIGNvZGVVbml0IDw9IDU3MzQzKSArK2k7CiAgICAgICAgICAgICAgbGVuICs9IDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFsaWduVXAoeCwgbXVsdGlwbGUpIHsKICAgICAgICAgICAgaWYgKHggJSBtdWx0aXBsZSA+IDApIHsKICAgICAgICAgICAgICB4ICs9IG11bHRpcGxlIC0geCAlIG11bHRpcGxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB4OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGJ1ZmZlciwgSEVBUDgsIEhFQVBVOCwgSEVBUDE2LCBIRUFQVTE2LCBIRUFQMzIsIEhFQVBVMzIsIEhFQVBGMzIsIEhFQVBGNjQ7CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVHbG9iYWxCdWZmZXJBbmRWaWV3cyhidWYpIHsKICAgICAgICAgICAgYnVmZmVyID0gYnVmOwogICAgICAgICAgICBNb2R1bGVbIkhFQVA4Il0gPSBIRUFQOCA9IG5ldyBJbnQ4QXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQMTYiXSA9IEhFQVAxNiA9IG5ldyBJbnQxNkFycmF5KGJ1Zik7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUDMyIl0gPSBIRUFQMzIgPSBuZXcgSW50MzJBcnJheShidWYpOwogICAgICAgICAgICBNb2R1bGVbIkhFQVBVOCJdID0gSEVBUFU4ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQVTE2Il0gPSBIRUFQVTE2ID0gbmV3IFVpbnQxNkFycmF5KGJ1Zik7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUFUzMiJdID0gSEVBUFUzMiA9IG5ldyBVaW50MzJBcnJheShidWYpOwogICAgICAgICAgICBNb2R1bGVbIkhFQVBGMzIiXSA9IEhFQVBGMzIgPSBuZXcgRmxvYXQzMkFycmF5KGJ1Zik7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUEY2NCJdID0gSEVBUEY2NCA9IG5ldyBGbG9hdDY0QXJyYXkoYnVmKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBJTklUSUFMX01FTU9SWSA9IE1vZHVsZVsiSU5JVElBTF9NRU1PUlkiXSB8fCAxNjc3NzIxNjsKICAgICAgICAgIHZhciB3YXNtVGFibGU7CiAgICAgICAgICB2YXIgX19BVFBSRVJVTl9fID0gW107CiAgICAgICAgICB2YXIgX19BVElOSVRfXyA9IFtdOwogICAgICAgICAgdmFyIF9fQVRNQUlOX18gPSBbXTsKICAgICAgICAgIHZhciBfX0FUUE9TVFJVTl9fID0gW107CiAgICAgICAgICB2YXIgcnVudGltZUluaXRpYWxpemVkID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBwcmVSdW4oKSB7CiAgICAgICAgICAgIGlmIChNb2R1bGVbInByZVJ1biJdKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBNb2R1bGVbInByZVJ1biJdID09ICJmdW5jdGlvbiIpIE1vZHVsZVsicHJlUnVuIl0gPSBbTW9kdWxlWyJwcmVSdW4iXV07CiAgICAgICAgICAgICAgd2hpbGUgKE1vZHVsZVsicHJlUnVuIl0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBhZGRPblByZVJ1bihNb2R1bGVbInByZVJ1biJdLnNoaWZ0KCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsUnVudGltZUNhbGxiYWNrcyhfX0FUUFJFUlVOX18pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdFJ1bnRpbWUoKSB7CiAgICAgICAgICAgIHJ1bnRpbWVJbml0aWFsaXplZCA9IHRydWU7CiAgICAgICAgICAgIGNhbGxSdW50aW1lQ2FsbGJhY2tzKF9fQVRJTklUX18pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHJlTWFpbigpIHsKICAgICAgICAgICAgY2FsbFJ1bnRpbWVDYWxsYmFja3MoX19BVE1BSU5fXyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3N0UnVuKCkgewogICAgICAgICAgICBpZiAoTW9kdWxlWyJwb3N0UnVuIl0pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIE1vZHVsZVsicG9zdFJ1biJdID09ICJmdW5jdGlvbiIpIE1vZHVsZVsicG9zdFJ1biJdID0gW01vZHVsZVsicG9zdFJ1biJdXTsKICAgICAgICAgICAgICB3aGlsZSAoTW9kdWxlWyJwb3N0UnVuIl0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBhZGRPblBvc3RSdW4oTW9kdWxlWyJwb3N0UnVuIl0uc2hpZnQoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxSdW50aW1lQ2FsbGJhY2tzKF9fQVRQT1NUUlVOX18pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWRkT25QcmVSdW4oY2IpIHsKICAgICAgICAgICAgX19BVFBSRVJVTl9fLnVuc2hpZnQoY2IpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWRkT25Jbml0KGNiKSB7CiAgICAgICAgICAgIF9fQVRJTklUX18udW5zaGlmdChjYik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhZGRPblBvc3RSdW4oY2IpIHsKICAgICAgICAgICAgX19BVFBPU1RSVU5fXy51bnNoaWZ0KGNiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBydW5EZXBlbmRlbmNpZXMgPSAwOwogICAgICAgICAgdmFyIHJ1bkRlcGVuZGVuY3lXYXRjaGVyID0gbnVsbDsKICAgICAgICAgIHZhciBkZXBlbmRlbmNpZXNGdWxmaWxsZWQgPSBudWxsOwogICAgICAgICAgZnVuY3Rpb24gYWRkUnVuRGVwZW5kZW5jeShpZCkgewogICAgICAgICAgICBydW5EZXBlbmRlbmNpZXMrKzsKICAgICAgICAgICAgaWYgKE1vZHVsZVsibW9uaXRvclJ1bkRlcGVuZGVuY2llcyJdKSB7CiAgICAgICAgICAgICAgTW9kdWxlWyJtb25pdG9yUnVuRGVwZW5kZW5jaWVzIl0ocnVuRGVwZW5kZW5jaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlUnVuRGVwZW5kZW5jeShpZCkgewogICAgICAgICAgICBydW5EZXBlbmRlbmNpZXMtLTsKICAgICAgICAgICAgaWYgKE1vZHVsZVsibW9uaXRvclJ1bkRlcGVuZGVuY2llcyJdKSB7CiAgICAgICAgICAgICAgTW9kdWxlWyJtb25pdG9yUnVuRGVwZW5kZW5jaWVzIl0ocnVuRGVwZW5kZW5jaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocnVuRGVwZW5kZW5jaWVzID09IDApIHsKICAgICAgICAgICAgICBpZiAocnVuRGVwZW5kZW5jeVdhdGNoZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocnVuRGVwZW5kZW5jeVdhdGNoZXIpOwogICAgICAgICAgICAgICAgcnVuRGVwZW5kZW5jeVdhdGNoZXIgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGVwZW5kZW5jaWVzRnVsZmlsbGVkKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBkZXBlbmRlbmNpZXNGdWxmaWxsZWQ7CiAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXNGdWxmaWxsZWQgPSBudWxsOwogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIE1vZHVsZVsicHJlbG9hZGVkSW1hZ2VzIl0gPSB7fTsKICAgICAgICAgIE1vZHVsZVsicHJlbG9hZGVkQXVkaW9zIl0gPSB7fTsKICAgICAgICAgIGZ1bmN0aW9uIGFib3J0KHdoYXQpIHsKICAgICAgICAgICAgaWYgKE1vZHVsZVsib25BYm9ydCJdKSB7CiAgICAgICAgICAgICAgTW9kdWxlWyJvbkFib3J0Il0od2hhdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hhdCArPSAiIjsKICAgICAgICAgICAgZXJyKHdoYXQpOwogICAgICAgICAgICBBQk9SVCA9IHRydWU7CiAgICAgICAgICAgIEVYSVRTVEFUVVMgPSAxOwogICAgICAgICAgICB3aGF0ID0gImFib3J0KCIgKyB3aGF0ICsgIikuIEJ1aWxkIHdpdGggLXMgQVNTRVJUSU9OUz0xIGZvciBtb3JlIGluZm8uIjsKICAgICAgICAgICAgdmFyIGUgPSBuZXcgV2ViQXNzZW1ibHkuUnVudGltZUVycm9yKHdoYXQpOwogICAgICAgICAgICByZWFkeVByb21pc2VSZWplY3QoZSk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoYXNQcmVmaXgoc3RyLCBwcmVmaXgpIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5wcm90b3R5cGUuc3RhcnRzV2l0aCA/IHN0ci5zdGFydHNXaXRoKHByZWZpeCkgOiBzdHIuaW5kZXhPZihwcmVmaXgpID09PSAwOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRhdGFVUklQcmVmaXggPSAiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCI7CiAgICAgICAgICBmdW5jdGlvbiBpc0RhdGFVUkkoZmlsZW5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGhhc1ByZWZpeChmaWxlbmFtZSwgZGF0YVVSSVByZWZpeCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlsZVVSSVByZWZpeCA9ICJmaWxlOi8vIjsKICAgICAgICAgIGZ1bmN0aW9uIGlzRmlsZVVSSShmaWxlbmFtZSkgewogICAgICAgICAgICByZXR1cm4gaGFzUHJlZml4KGZpbGVuYW1lLCBmaWxlVVJJUHJlZml4KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNtQmluYXJ5RmlsZSA9ICJiYXNpc190cmFuc2NvZGVyLndhc20iOwogICAgICAgICAgaWYgKCFpc0RhdGFVUkkod2FzbUJpbmFyeUZpbGUpKSB7CiAgICAgICAgICAgIHdhc21CaW5hcnlGaWxlID0gbG9jYXRlRmlsZSh3YXNtQmluYXJ5RmlsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRCaW5hcnkoZmlsZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmIChmaWxlID09IHdhc21CaW5hcnlGaWxlICYmIHdhc21CaW5hcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheSh3YXNtQmluYXJ5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlYWRCaW5hcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWFkQmluYXJ5KGZpbGUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiYm90aCBhc3luYyBhbmQgc3luYyBmZXRjaGluZyBvZiB0aGUgd2FzbSBmYWlsZWQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyMikgewogICAgICAgICAgICAgIGFib3J0KGVycjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRCaW5hcnlQcm9taXNlKCkgewogICAgICAgICAgICBpZiAoIXdhc21CaW5hcnkgJiYgKEVOVklST05NRU5UX0lTX1dFQiB8fCBFTlZJUk9OTUVOVF9JU19XT1JLRVIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmZXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNGaWxlVVJJKHdhc21CaW5hcnlGaWxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZldGNoKHdhc21CaW5hcnlGaWxlLCB7IGNyZWRlbnRpYWxzOiAic2FtZS1vcmlnaW4iIH0pLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZVsib2siXSkgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJmYWlsZWQgdG8gbG9hZCB3YXNtIGJpbmFyeSBmaWxlIGF0ICciICsgd2FzbUJpbmFyeUZpbGUgKyAiJyI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlWyJhcnJheUJ1ZmZlciJdKCk7CiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEJpbmFyeSh3YXNtQmluYXJ5RmlsZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHJlYWRBc3luYykgewogICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVhZEFzeW5jKHdhc21CaW5hcnlGaWxlLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShuZXcgVWludDhBcnJheShyZXNwb25zZSkpOwogICAgICAgICAgICAgICAgICAgIH0sIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0QmluYXJ5KHdhc21CaW5hcnlGaWxlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVXYXNtKCkgewogICAgICAgICAgICB2YXIgaW5mbyA9IHsgImEiOiBhc21MaWJyYXJ5QXJnIH07CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlY2VpdmVJbnN0YW5jZShpbnN0YW5jZSwgbW9kdWxlMikgewogICAgICAgICAgICAgIHZhciBleHBvcnRzNCA9IGluc3RhbmNlLmV4cG9ydHM7CiAgICAgICAgICAgICAgTW9kdWxlWyJhc20iXSA9IGV4cG9ydHM0OwogICAgICAgICAgICAgIHdhc21NZW1vcnkgPSBNb2R1bGVbImFzbSJdWyJLIl07CiAgICAgICAgICAgICAgdXBkYXRlR2xvYmFsQnVmZmVyQW5kVmlld3Mod2FzbU1lbW9yeS5idWZmZXIpOwogICAgICAgICAgICAgIHdhc21UYWJsZSA9IE1vZHVsZVsiYXNtIl1bIk8iXTsKICAgICAgICAgICAgICBhZGRPbkluaXQoTW9kdWxlWyJhc20iXVsiTCJdKTsKICAgICAgICAgICAgICByZW1vdmVSdW5EZXBlbmRlbmN5KCJ3YXNtLWluc3RhbnRpYXRlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWRkUnVuRGVwZW5kZW5jeSgid2FzbS1pbnN0YW50aWF0ZSIpOwogICAgICAgICAgICBmdW5jdGlvbiByZWNlaXZlSW5zdGFudGlhdGVkU291cmNlKG91dHB1dCkgewogICAgICAgICAgICAgIHJlY2VpdmVJbnN0YW5jZShvdXRwdXRbImluc3RhbmNlIl0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGluc3RhbnRpYXRlQXJyYXlCdWZmZXIocmVjZWl2ZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0QmluYXJ5UHJvbWlzZSgpLnRoZW4oZnVuY3Rpb24oYmluYXJ5KSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGUoYmluYXJ5LCBpbmZvKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgfSkudGhlbihyZWNlaXZlciwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICBlcnIoImZhaWxlZCB0byBhc3luY2hyb25vdXNseSBwcmVwYXJlIHdhc206ICIgKyByZWFzb24pOwogICAgICAgICAgICAgICAgYWJvcnQocmVhc29uKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZUFzeW5jKCkgewogICAgICAgICAgICAgIGlmICghd2FzbUJpbmFyeSAmJiB0eXBlb2YgV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmcgPT09ICJmdW5jdGlvbiIgJiYgIWlzRGF0YVVSSSh3YXNtQmluYXJ5RmlsZSkgJiYgIWlzRmlsZVVSSSh3YXNtQmluYXJ5RmlsZSkgJiYgdHlwZW9mIGZldGNoID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmV0Y2god2FzbUJpbmFyeUZpbGUsIHsgY3JlZGVudGlhbHM6ICJzYW1lLW9yaWdpbiIgfSkudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmcocmVzcG9uc2UsIGluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnRoZW4ocmVjZWl2ZUluc3RhbnRpYXRlZFNvdXJjZSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyKCJ3YXNtIHN0cmVhbWluZyBjb21waWxlIGZhaWxlZDogIiArIHJlYXNvbik7CiAgICAgICAgICAgICAgICAgICAgZXJyKCJmYWxsaW5nIGJhY2sgdG8gQXJyYXlCdWZmZXIgaW5zdGFudGlhdGlvbiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW50aWF0ZUFycmF5QnVmZmVyKHJlY2VpdmVJbnN0YW50aWF0ZWRTb3VyY2UpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFudGlhdGVBcnJheUJ1ZmZlcihyZWNlaXZlSW5zdGFudGlhdGVkU291cmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKE1vZHVsZVsiaW5zdGFudGlhdGVXYXNtIl0pIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGV4cG9ydHMzID0gTW9kdWxlWyJpbnN0YW50aWF0ZVdhc20iXShpbmZvLCByZWNlaXZlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydHMzOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGVycigiTW9kdWxlLmluc3RhbnRpYXRlV2FzbSBjYWxsYmFjayBmYWlsZWQgd2l0aCBlcnJvcjogIiArIGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW50aWF0ZUFzeW5jKCkuY2F0Y2gocmVhZHlQcm9taXNlUmVqZWN0KTsKICAgICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2FsbFJ1bnRpbWVDYWxsYmFja3MoY2FsbGJhY2tzKSB7CiAgICAgICAgICAgIHdoaWxlIChjYWxsYmFja3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGNhbGxiYWNrcy5zaGlmdCgpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY2FsbGJhY2soTW9kdWxlKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZnVuYyA9IGNhbGxiYWNrLmZ1bmM7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmdW5jID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrLmFyZyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHdhc21UYWJsZS5nZXQoZnVuYykoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHdhc21UYWJsZS5nZXQoZnVuYykoY2FsbGJhY2suYXJnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZnVuYyhjYWxsYmFjay5hcmcgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjay5hcmcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0cnVjdFJlZ2lzdHJhdGlvbnMgPSB7fTsKICAgICAgICAgIGZ1bmN0aW9uIHJ1bkRlc3RydWN0b3JzKGRlc3RydWN0b3JzKSB7CiAgICAgICAgICAgIHdoaWxlIChkZXN0cnVjdG9ycy5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGVzdHJ1Y3RvcnMucG9wKCk7CiAgICAgICAgICAgICAgdmFyIGRlbCA9IGRlc3RydWN0b3JzLnBvcCgpOwogICAgICAgICAgICAgIGRlbChwdHIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzaW1wbGVSZWFkVmFsdWVGcm9tUG9pbnRlcihwb2ludGVyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShIRUFQVTMyW3BvaW50ZXIgPj4gMl0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGF3YWl0aW5nRGVwZW5kZW5jaWVzID0ge307CiAgICAgICAgICB2YXIgcmVnaXN0ZXJlZFR5cGVzID0ge307CiAgICAgICAgICB2YXIgdHlwZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgICAgdmFyIGNoYXJfMCA9IDQ4OwogICAgICAgICAgdmFyIGNoYXJfOSA9IDU3OwogICAgICAgICAgZnVuY3Rpb24gbWFrZUxlZ2FsRnVuY3Rpb25OYW1lKG5hbWUpIHsKICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gbmFtZSkgewogICAgICAgICAgICAgIHJldHVybiAiX3Vua25vd24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoL1teYS16QS1aMC05X10vZywgIiQiKTsKICAgICAgICAgICAgdmFyIGYgPSBuYW1lLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgIGlmIChmID49IGNoYXJfMCAmJiBmIDw9IGNoYXJfOSkgewogICAgICAgICAgICAgIHJldHVybiAiXyIgKyBuYW1lOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVOYW1lZEZ1bmN0aW9uKG5hbWUsIGJvZHkpIHsKICAgICAgICAgICAgbmFtZSA9IG1ha2VMZWdhbEZ1bmN0aW9uTmFtZShuYW1lKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigiYm9keSIsICJyZXR1cm4gZnVuY3Rpb24gIiArIG5hbWUgKyAnKCkge1xuICAgICJ1c2Ugc3RyaWN0IjsgICAgcmV0dXJuIGJvZHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn07XG4nKShib2R5KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGV4dGVuZEVycm9yKGJhc2VFcnJvclR5cGUsIGVycm9yTmFtZSkgewogICAgICAgICAgICB2YXIgZXJyb3JDbGFzcyA9IGNyZWF0ZU5hbWVkRnVuY3Rpb24oZXJyb3JOYW1lLCBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgICAgICAgICAgdGhpcy5uYW1lID0gZXJyb3JOYW1lOwogICAgICAgICAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gbmV3IEVycm9yKG1lc3NhZ2UpLnN0YWNrOwogICAgICAgICAgICAgIGlmIChzdGFjayAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YWNrID0gdGhpcy50b1N0cmluZygpICsgIlxuIiArIHN0YWNrLnJlcGxhY2UoL15FcnJvcig6W15cbl0qKT9cbi8sICIiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlcnJvckNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoYmFzZUVycm9yVHlwZS5wcm90b3R5cGUpOwogICAgICAgICAgICBlcnJvckNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGVycm9yQ2xhc3M7CiAgICAgICAgICAgIGVycm9yQ2xhc3MucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMubWVzc2FnZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uYW1lOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uYW1lICsgIjogIiArIHRoaXMubWVzc2FnZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBlcnJvckNsYXNzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIEludGVybmFsRXJyb3IgPSB2b2lkIDA7CiAgICAgICAgICBmdW5jdGlvbiB0aHJvd0ludGVybmFsRXJyb3IobWVzc2FnZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgSW50ZXJuYWxFcnJvcihtZXNzYWdlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKG15VHlwZXMsIGRlcGVuZGVudFR5cGVzLCBnZXRUeXBlQ29udmVydGVycykgewogICAgICAgICAgICBteVR5cGVzLmZvckVhY2goZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgICAgIHR5cGVEZXBlbmRlbmNpZXNbdHlwZV0gPSBkZXBlbmRlbnRUeXBlczsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGZ1bmN0aW9uIG9uQ29tcGxldGUodHlwZUNvbnZlcnRlcnMyKSB7CiAgICAgICAgICAgICAgdmFyIG15VHlwZUNvbnZlcnRlcnMgPSBnZXRUeXBlQ29udmVydGVycyh0eXBlQ29udmVydGVyczIpOwogICAgICAgICAgICAgIGlmIChteVR5cGVDb252ZXJ0ZXJzLmxlbmd0aCAhPT0gbXlUeXBlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRocm93SW50ZXJuYWxFcnJvcigiTWlzbWF0Y2hlZCB0eXBlIGNvbnZlcnRlciBjb3VudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG15VHlwZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShteVR5cGVzW2ldLCBteVR5cGVDb252ZXJ0ZXJzW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHR5cGVDb252ZXJ0ZXJzID0gbmV3IEFycmF5KGRlcGVuZGVudFR5cGVzLmxlbmd0aCk7CiAgICAgICAgICAgIHZhciB1bnJlZ2lzdGVyZWRUeXBlcyA9IFtdOwogICAgICAgICAgICB2YXIgcmVnaXN0ZXJlZCA9IDA7CiAgICAgICAgICAgIGRlcGVuZGVudFR5cGVzLmZvckVhY2goZnVuY3Rpb24oZHQsIGkpIHsKICAgICAgICAgICAgICBpZiAocmVnaXN0ZXJlZFR5cGVzLmhhc093blByb3BlcnR5KGR0KSkgewogICAgICAgICAgICAgICAgdHlwZUNvbnZlcnRlcnNbaV0gPSByZWdpc3RlcmVkVHlwZXNbZHRdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1bnJlZ2lzdGVyZWRUeXBlcy5wdXNoKGR0KTsKICAgICAgICAgICAgICAgIGlmICghYXdhaXRpbmdEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkoZHQpKSB7CiAgICAgICAgICAgICAgICAgIGF3YWl0aW5nRGVwZW5kZW5jaWVzW2R0XSA9IFtdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXdhaXRpbmdEZXBlbmRlbmNpZXNbZHRdLnB1c2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHR5cGVDb252ZXJ0ZXJzW2ldID0gcmVnaXN0ZXJlZFR5cGVzW2R0XTsKICAgICAgICAgICAgICAgICAgKytyZWdpc3RlcmVkOwogICAgICAgICAgICAgICAgICBpZiAocmVnaXN0ZXJlZCA9PT0gdW5yZWdpc3RlcmVkVHlwZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgb25Db21wbGV0ZSh0eXBlQ29udmVydGVycyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICgwID09PSB1bnJlZ2lzdGVyZWRUeXBlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICBvbkNvbXBsZXRlKHR5cGVDb252ZXJ0ZXJzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfZmluYWxpemVfdmFsdWVfb2JqZWN0KHN0cnVjdFR5cGUpIHsKICAgICAgICAgICAgdmFyIHJlZyA9IHN0cnVjdFJlZ2lzdHJhdGlvbnNbc3RydWN0VHlwZV07CiAgICAgICAgICAgIGRlbGV0ZSBzdHJ1Y3RSZWdpc3RyYXRpb25zW3N0cnVjdFR5cGVdOwogICAgICAgICAgICB2YXIgcmF3Q29uc3RydWN0b3IgPSByZWcucmF3Q29uc3RydWN0b3I7CiAgICAgICAgICAgIHZhciByYXdEZXN0cnVjdG9yID0gcmVnLnJhd0Rlc3RydWN0b3I7CiAgICAgICAgICAgIHZhciBmaWVsZFJlY29yZHMgPSByZWcuZmllbGRzOwogICAgICAgICAgICB2YXIgZmllbGRUeXBlcyA9IGZpZWxkUmVjb3Jkcy5tYXAoZnVuY3Rpb24oZmllbGQpIHsKICAgICAgICAgICAgICByZXR1cm4gZmllbGQuZ2V0dGVyUmV0dXJuVHlwZTsKICAgICAgICAgICAgfSkuY29uY2F0KGZpZWxkUmVjb3Jkcy5tYXAoZnVuY3Rpb24oZmllbGQpIHsKICAgICAgICAgICAgICByZXR1cm4gZmllbGQuc2V0dGVyQXJndW1lbnRUeXBlOwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtzdHJ1Y3RUeXBlXSwgZmllbGRUeXBlcywgZnVuY3Rpb24oZmllbGRUeXBlczIpIHsKICAgICAgICAgICAgICB2YXIgZmllbGRzID0ge307CiAgICAgICAgICAgICAgZmllbGRSZWNvcmRzLmZvckVhY2goZnVuY3Rpb24oZmllbGQsIGkpIHsKICAgICAgICAgICAgICAgIHZhciBmaWVsZE5hbWUgPSBmaWVsZC5maWVsZE5hbWU7CiAgICAgICAgICAgICAgICB2YXIgZ2V0dGVyUmV0dXJuVHlwZSA9IGZpZWxkVHlwZXMyW2ldOwogICAgICAgICAgICAgICAgdmFyIGdldHRlciA9IGZpZWxkLmdldHRlcjsKICAgICAgICAgICAgICAgIHZhciBnZXR0ZXJDb250ZXh0ID0gZmllbGQuZ2V0dGVyQ29udGV4dDsKICAgICAgICAgICAgICAgIHZhciBzZXR0ZXJBcmd1bWVudFR5cGUgPSBmaWVsZFR5cGVzMltpICsgZmllbGRSZWNvcmRzLmxlbmd0aF07CiAgICAgICAgICAgICAgICB2YXIgc2V0dGVyID0gZmllbGQuc2V0dGVyOwogICAgICAgICAgICAgICAgdmFyIHNldHRlckNvbnRleHQgPSBmaWVsZC5zZXR0ZXJDb250ZXh0OwogICAgICAgICAgICAgICAgZmllbGRzW2ZpZWxkTmFtZV0gPSB7IHJlYWQ6IGZ1bmN0aW9uKHB0cikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0dGVyUmV0dXJuVHlwZVsiZnJvbVdpcmVUeXBlIl0oZ2V0dGVyKGdldHRlckNvbnRleHQsIHB0cikpOwogICAgICAgICAgICAgICAgfSwgd3JpdGU6IGZ1bmN0aW9uKHB0ciwgbykgewogICAgICAgICAgICAgICAgICB2YXIgZGVzdHJ1Y3RvcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgc2V0dGVyKHNldHRlckNvbnRleHQsIHB0ciwgc2V0dGVyQXJndW1lbnRUeXBlWyJ0b1dpcmVUeXBlIl0oZGVzdHJ1Y3RvcnMsIG8pKTsKICAgICAgICAgICAgICAgICAgcnVuRGVzdHJ1Y3RvcnMoZGVzdHJ1Y3RvcnMpOwogICAgICAgICAgICAgICAgfSB9OwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBbeyBuYW1lOiByZWcubmFtZSwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKHB0cikgewogICAgICAgICAgICAgICAgdmFyIHJ2ID0ge307CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGZpZWxkcykgewogICAgICAgICAgICAgICAgICBydltpXSA9IGZpZWxkc1tpXS5yZWFkKHB0cik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByYXdEZXN0cnVjdG9yKHB0cik7CiAgICAgICAgICAgICAgICByZXR1cm4gcnY7CiAgICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgbykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgZmllbGROYW1lIGluIGZpZWxkcykgewogICAgICAgICAgICAgICAgICBpZiAoIShmaWVsZE5hbWUgaW4gbykpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdNaXNzaW5nIGZpZWxkOiAgIicgKyBmaWVsZE5hbWUgKyAnIicpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgcHRyID0gcmF3Q29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIGZvciAoZmllbGROYW1lIGluIGZpZWxkcykgewogICAgICAgICAgICAgICAgICBmaWVsZHNbZmllbGROYW1lXS53cml0ZShwdHIsIG9bZmllbGROYW1lXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGVzdHJ1Y3RvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVzdHJ1Y3RvcnMucHVzaChyYXdEZXN0cnVjdG9yLCBwdHIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBzaW1wbGVSZWFkVmFsdWVGcm9tUG9pbnRlciwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiByYXdEZXN0cnVjdG9yIH1dOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFNoaWZ0RnJvbVNpemUoc2l6ZSkgewogICAgICAgICAgICBzd2l0Y2ggKHNpemUpIHsKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biB0eXBlIHNpemU6ICIgKyBzaXplKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW1iaW5kX2luaXRfY2hhckNvZGVzKCkgewogICAgICAgICAgICB2YXIgY29kZXMgPSBuZXcgQXJyYXkoMjU2KTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7ICsraSkgewogICAgICAgICAgICAgIGNvZGVzW2ldID0gU3RyaW5nLmZyb21DaGFyQ29kZShpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbWJpbmRfY2hhckNvZGVzID0gY29kZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW1iaW5kX2NoYXJDb2RlcyA9IHZvaWQgMDsKICAgICAgICAgIGZ1bmN0aW9uIHJlYWRMYXRpbjFTdHJpbmcocHRyKSB7CiAgICAgICAgICAgIHZhciByZXQgPSAiIjsKICAgICAgICAgICAgdmFyIGMgPSBwdHI7CiAgICAgICAgICAgIHdoaWxlIChIRUFQVThbY10pIHsKICAgICAgICAgICAgICByZXQgKz0gZW1iaW5kX2NoYXJDb2Rlc1tIRUFQVThbYysrXV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBCaW5kaW5nRXJyb3IgPSB2b2lkIDA7CiAgICAgICAgICBmdW5jdGlvbiB0aHJvd0JpbmRpbmdFcnJvcihtZXNzYWdlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBCaW5kaW5nRXJyb3IobWVzc2FnZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWdpc3RlclR5cGUocmF3VHlwZSwgcmVnaXN0ZXJlZEluc3RhbmNlLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICBpZiAoISgiYXJnUGFja0FkdmFuY2UiIGluIHJlZ2lzdGVyZWRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJyZWdpc3RlclR5cGUgcmVnaXN0ZXJlZEluc3RhbmNlIHJlcXVpcmVzIGFyZ1BhY2tBZHZhbmNlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5hbWUgPSByZWdpc3RlcmVkSW5zdGFuY2UubmFtZTsKICAgICAgICAgICAgaWYgKCFyYXdUeXBlKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoJ3R5cGUgIicgKyBuYW1lICsgJyIgbXVzdCBoYXZlIGEgcG9zaXRpdmUgaW50ZWdlciB0eXBlaWQgcG9pbnRlcicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZWdpc3RlcmVkVHlwZXMuaGFzT3duUHJvcGVydHkocmF3VHlwZSkpIHsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5pZ25vcmVEdXBsaWNhdGVSZWdpc3RyYXRpb25zKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcmVnaXN0ZXIgdHlwZSAnIiArIG5hbWUgKyAiJyB0d2ljZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZWdpc3RlcmVkVHlwZXNbcmF3VHlwZV0gPSByZWdpc3RlcmVkSW5zdGFuY2U7CiAgICAgICAgICAgIGRlbGV0ZSB0eXBlRGVwZW5kZW5jaWVzW3Jhd1R5cGVdOwogICAgICAgICAgICBpZiAoYXdhaXRpbmdEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocmF3VHlwZSkpIHsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gYXdhaXRpbmdEZXBlbmRlbmNpZXNbcmF3VHlwZV07CiAgICAgICAgICAgICAgZGVsZXRlIGF3YWl0aW5nRGVwZW5kZW5jaWVzW3Jhd1R5cGVdOwogICAgICAgICAgICAgIGNhbGxiYWNrcy5mb3JFYWNoKGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgICAgICAgICBjYigpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9ib29sKHJhd1R5cGUsIG5hbWUsIHNpemUsIHRydWVWYWx1ZSwgZmFsc2VWYWx1ZSkgewogICAgICAgICAgICB2YXIgc2hpZnQgPSBnZXRTaGlmdEZyb21TaXplKHNpemUpOwogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgbmFtZSwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKHd0KSB7CiAgICAgICAgICAgICAgcmV0dXJuICEhd3Q7CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIG8pIHsKICAgICAgICAgICAgICByZXR1cm4gbyA/IHRydWVWYWx1ZSA6IGZhbHNlVmFsdWU7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IGZ1bmN0aW9uKHBvaW50ZXIpIHsKICAgICAgICAgICAgICB2YXIgaGVhcDsKICAgICAgICAgICAgICBpZiAoc2l6ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgaGVhcCA9IEhFQVA4OwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2l6ZSA9PT0gMikgewogICAgICAgICAgICAgICAgaGVhcCA9IEhFQVAxNjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNpemUgPT09IDQpIHsKICAgICAgICAgICAgICAgIGhlYXAgPSBIRUFQMzI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gYm9vbGVhbiB0eXBlIHNpemU6ICIgKyBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbImZyb21XaXJlVHlwZSJdKGhlYXBbcG9pbnRlciA+PiBzaGlmdF0pOwogICAgICAgICAgICB9LCBkZXN0cnVjdG9yRnVuY3Rpb246IG51bGwgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBDbGFzc0hhbmRsZV9pc0FsaWFzT2Yob3RoZXIpIHsKICAgICAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIENsYXNzSGFuZGxlKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIENsYXNzSGFuZGxlKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGVmdENsYXNzID0gdGhpcy4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzczsKICAgICAgICAgICAgdmFyIGxlZnQgPSB0aGlzLiQkLnB0cjsKICAgICAgICAgICAgdmFyIHJpZ2h0Q2xhc3MgPSBvdGhlci4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzczsKICAgICAgICAgICAgdmFyIHJpZ2h0ID0gb3RoZXIuJCQucHRyOwogICAgICAgICAgICB3aGlsZSAobGVmdENsYXNzLmJhc2VDbGFzcykgewogICAgICAgICAgICAgIGxlZnQgPSBsZWZ0Q2xhc3MudXBjYXN0KGxlZnQpOwogICAgICAgICAgICAgIGxlZnRDbGFzcyA9IGxlZnRDbGFzcy5iYXNlQ2xhc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKHJpZ2h0Q2xhc3MuYmFzZUNsYXNzKSB7CiAgICAgICAgICAgICAgcmlnaHQgPSByaWdodENsYXNzLnVwY2FzdChyaWdodCk7CiAgICAgICAgICAgICAgcmlnaHRDbGFzcyA9IHJpZ2h0Q2xhc3MuYmFzZUNsYXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0Q2xhc3MgPT09IHJpZ2h0Q2xhc3MgJiYgbGVmdCA9PT0gcmlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzaGFsbG93Q29weUludGVybmFsUG9pbnRlcihvKSB7CiAgICAgICAgICAgIHJldHVybiB7IGNvdW50OiBvLmNvdW50LCBkZWxldGVTY2hlZHVsZWQ6IG8uZGVsZXRlU2NoZWR1bGVkLCBwcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZTogby5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSwgcHRyOiBvLnB0ciwgcHRyVHlwZTogby5wdHJUeXBlLCBzbWFydFB0cjogby5zbWFydFB0ciwgc21hcnRQdHJUeXBlOiBvLnNtYXJ0UHRyVHlwZSB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdGhyb3dJbnN0YW5jZUFscmVhZHlEZWxldGVkKG9iaikgewogICAgICAgICAgICBmdW5jdGlvbiBnZXRJbnN0YW5jZVR5cGVOYW1lKGhhbmRsZSkgewogICAgICAgICAgICAgIHJldHVybiBoYW5kbGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3MubmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcihnZXRJbnN0YW5jZVR5cGVOYW1lKG9iaikgKyAiIGluc3RhbmNlIGFscmVhZHkgZGVsZXRlZCIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmFsaXphdGlvbkdyb3VwID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBkZXRhY2hGaW5hbGl6ZXIoaGFuZGxlKSB7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBydW5EZXN0cnVjdG9yKCQkKSB7CiAgICAgICAgICAgIGlmICgkJC5zbWFydFB0cikgewogICAgICAgICAgICAgICQkLnNtYXJ0UHRyVHlwZS5yYXdEZXN0cnVjdG9yKCQkLnNtYXJ0UHRyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAkJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzcy5yYXdEZXN0cnVjdG9yKCQkLnB0cik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlbGVhc2VDbGFzc0hhbmRsZSgkJCkgewogICAgICAgICAgICAkJC5jb3VudC52YWx1ZSAtPSAxOwogICAgICAgICAgICB2YXIgdG9EZWxldGUgPSAwID09PSAkJC5jb3VudC52YWx1ZTsKICAgICAgICAgICAgaWYgKHRvRGVsZXRlKSB7CiAgICAgICAgICAgICAgcnVuRGVzdHJ1Y3RvcigkJCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGF0dGFjaEZpbmFsaXplcihoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKCJ1bmRlZmluZWQiID09PSB0eXBlb2YgRmluYWxpemF0aW9uR3JvdXApIHsKICAgICAgICAgICAgICBhdHRhY2hGaW5hbGl6ZXIgPSBmdW5jdGlvbihoYW5kbGUyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlMjsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJldHVybiBoYW5kbGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxpemF0aW9uR3JvdXAgPSBuZXcgRmluYWxpemF0aW9uR3JvdXAoZnVuY3Rpb24oaXRlcikgewogICAgICAgICAgICAgIGZvciAodmFyIHJlc3VsdCA9IGl0ZXIubmV4dCgpOyAhcmVzdWx0LmRvbmU7IHJlc3VsdCA9IGl0ZXIubmV4dCgpKSB7CiAgICAgICAgICAgICAgICB2YXIgJCQgPSByZXN1bHQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoISQkLnB0cikgewogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIm9iamVjdCBhbHJlYWR5IGRlbGV0ZWQ6ICIgKyAkJC5wdHIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVsZWFzZUNsYXNzSGFuZGxlKCQkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhdHRhY2hGaW5hbGl6ZXIgPSBmdW5jdGlvbihoYW5kbGUyKSB7CiAgICAgICAgICAgICAgZmluYWxpemF0aW9uR3JvdXAucmVnaXN0ZXIoaGFuZGxlMiwgaGFuZGxlMi4kJCwgaGFuZGxlMi4kJCk7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGRldGFjaEZpbmFsaXplciA9IGZ1bmN0aW9uKGhhbmRsZTIpIHsKICAgICAgICAgICAgICBmaW5hbGl6YXRpb25Hcm91cC51bnJlZ2lzdGVyKGhhbmRsZTIuJCQpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gYXR0YWNoRmluYWxpemVyKGhhbmRsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBDbGFzc0hhbmRsZV9jbG9uZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLiQkLnB0cikgewogICAgICAgICAgICAgIHRocm93SW5zdGFuY2VBbHJlYWR5RGVsZXRlZCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSkgewogICAgICAgICAgICAgIHRoaXMuJCQuY291bnQudmFsdWUgKz0gMTsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgY2xvbmUyID0gYXR0YWNoRmluYWxpemVyKE9iamVjdC5jcmVhdGUoT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLCB7ICQkOiB7IHZhbHVlOiBzaGFsbG93Q29weUludGVybmFsUG9pbnRlcih0aGlzLiQkKSB9IH0pKTsKICAgICAgICAgICAgICBjbG9uZTIuJCQuY291bnQudmFsdWUgKz0gMTsKICAgICAgICAgICAgICBjbG9uZTIuJCQuZGVsZXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgcmV0dXJuIGNsb25lMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQ2xhc3NIYW5kbGVfZGVsZXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuJCQucHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dJbnN0YW5jZUFscmVhZHlEZWxldGVkKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLiQkLmRlbGV0ZVNjaGVkdWxlZCAmJiAhdGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJPYmplY3QgYWxyZWFkeSBzY2hlZHVsZWQgZm9yIGRlbGV0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGV0YWNoRmluYWxpemVyKHRoaXMpOwogICAgICAgICAgICByZWxlYXNlQ2xhc3NIYW5kbGUodGhpcy4kJCk7CiAgICAgICAgICAgIGlmICghdGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSkgewogICAgICAgICAgICAgIHRoaXMuJCQuc21hcnRQdHIgPSB2b2lkIDA7CiAgICAgICAgICAgICAgdGhpcy4kJC5wdHIgPSB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENsYXNzSGFuZGxlX2lzRGVsZXRlZCgpIHsKICAgICAgICAgICAgcmV0dXJuICF0aGlzLiQkLnB0cjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZWxheUZ1bmN0aW9uID0gdm9pZCAwOwogICAgICAgICAgdmFyIGRlbGV0aW9uUXVldWUgPSBbXTsKICAgICAgICAgIGZ1bmN0aW9uIGZsdXNoUGVuZGluZ0RlbGV0ZXMoKSB7CiAgICAgICAgICAgIHdoaWxlIChkZWxldGlvblF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgIHZhciBvYmogPSBkZWxldGlvblF1ZXVlLnBvcCgpOwogICAgICAgICAgICAgIG9iai4kJC5kZWxldGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBvYmpbImRlbGV0ZSJdKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENsYXNzSGFuZGxlX2RlbGV0ZUxhdGVyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuJCQucHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dJbnN0YW5jZUFscmVhZHlEZWxldGVkKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLiQkLmRlbGV0ZVNjaGVkdWxlZCAmJiAhdGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJPYmplY3QgYWxyZWFkeSBzY2hlZHVsZWQgZm9yIGRlbGV0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRpb25RdWV1ZS5wdXNoKHRoaXMpOwogICAgICAgICAgICBpZiAoZGVsZXRpb25RdWV1ZS5sZW5ndGggPT09IDEgJiYgZGVsYXlGdW5jdGlvbikgewogICAgICAgICAgICAgIGRlbGF5RnVuY3Rpb24oZmx1c2hQZW5kaW5nRGVsZXRlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy4kJC5kZWxldGVTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluaXRfQ2xhc3NIYW5kbGUoKSB7CiAgICAgICAgICAgIENsYXNzSGFuZGxlLnByb3RvdHlwZVsiaXNBbGlhc09mIl0gPSBDbGFzc0hhbmRsZV9pc0FsaWFzT2Y7CiAgICAgICAgICAgIENsYXNzSGFuZGxlLnByb3RvdHlwZVsiY2xvbmUiXSA9IENsYXNzSGFuZGxlX2Nsb25lOwogICAgICAgICAgICBDbGFzc0hhbmRsZS5wcm90b3R5cGVbImRlbGV0ZSJdID0gQ2xhc3NIYW5kbGVfZGVsZXRlOwogICAgICAgICAgICBDbGFzc0hhbmRsZS5wcm90b3R5cGVbImlzRGVsZXRlZCJdID0gQ2xhc3NIYW5kbGVfaXNEZWxldGVkOwogICAgICAgICAgICBDbGFzc0hhbmRsZS5wcm90b3R5cGVbImRlbGV0ZUxhdGVyIl0gPSBDbGFzc0hhbmRsZV9kZWxldGVMYXRlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENsYXNzSGFuZGxlKCkgewogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlZ2lzdGVyZWRQb2ludGVycyA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gZW5zdXJlT3ZlcmxvYWRUYWJsZShwcm90bywgbWV0aG9kTmFtZSwgaHVtYW5OYW1lKSB7CiAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGUpIHsKICAgICAgICAgICAgICB2YXIgcHJldkZ1bmMgPSBwcm90b1ttZXRob2ROYW1lXTsKICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCFwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlLmhhc093blByb3BlcnR5KGFyZ3VtZW50cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJGdW5jdGlvbiAnIiArIGh1bWFuTmFtZSArICInIGNhbGxlZCB3aXRoIGFuIGludmFsaWQgbnVtYmVyIG9mIGFyZ3VtZW50cyAoIiArIGFyZ3VtZW50cy5sZW5ndGggKyAiKSAtIGV4cGVjdHMgb25lIG9mICgiICsgcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZSArICIpISIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGVbYXJndW1lbnRzLmxlbmd0aF0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGUgPSBbXTsKICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlW3ByZXZGdW5jLmFyZ0NvdW50XSA9IHByZXZGdW5jOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBleHBvc2VQdWJsaWNTeW1ib2wobmFtZSwgdmFsdWUsIG51bUFyZ3VtZW50cykgewogICAgICAgICAgICBpZiAoTW9kdWxlLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gbnVtQXJndW1lbnRzIHx8IHZvaWQgMCAhPT0gTW9kdWxlW25hbWVdLm92ZXJsb2FkVGFibGUgJiYgdm9pZCAwICE9PSBNb2R1bGVbbmFtZV0ub3ZlcmxvYWRUYWJsZVtudW1Bcmd1bWVudHNdKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHJlZ2lzdGVyIHB1YmxpYyBuYW1lICciICsgbmFtZSArICInIHR3aWNlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVuc3VyZU92ZXJsb2FkVGFibGUoTW9kdWxlLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgICBpZiAoTW9kdWxlLmhhc093blByb3BlcnR5KG51bUFyZ3VtZW50cykpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgb3ZlcmxvYWRzIG9mIGEgZnVuY3Rpb24gd2l0aCB0aGUgc2FtZSBudW1iZXIgb2YgYXJndW1lbnRzICgiICsgbnVtQXJndW1lbnRzICsgIikhIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIE1vZHVsZVtuYW1lXS5vdmVybG9hZFRhYmxlW251bUFyZ3VtZW50c10gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBNb2R1bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBudW1Bcmd1bWVudHMpIHsKICAgICAgICAgICAgICAgIE1vZHVsZVtuYW1lXS5udW1Bcmd1bWVudHMgPSBudW1Bcmd1bWVudHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWdpc3RlcmVkQ2xhc3MobmFtZSwgY29uc3RydWN0b3IsIGluc3RhbmNlUHJvdG90eXBlLCByYXdEZXN0cnVjdG9yLCBiYXNlQ2xhc3MsIGdldEFjdHVhbFR5cGUsIHVwY2FzdCwgZG93bmNhc3QpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlUHJvdG90eXBlID0gaW5zdGFuY2VQcm90b3R5cGU7CiAgICAgICAgICAgIHRoaXMucmF3RGVzdHJ1Y3RvciA9IHJhd0Rlc3RydWN0b3I7CiAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzID0gYmFzZUNsYXNzOwogICAgICAgICAgICB0aGlzLmdldEFjdHVhbFR5cGUgPSBnZXRBY3R1YWxUeXBlOwogICAgICAgICAgICB0aGlzLnVwY2FzdCA9IHVwY2FzdDsKICAgICAgICAgICAgdGhpcy5kb3duY2FzdCA9IGRvd25jYXN0OwogICAgICAgICAgICB0aGlzLnB1cmVWaXJ0dWFsRnVuY3Rpb25zID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGNhc3RQb2ludGVyKHB0ciwgcHRyQ2xhc3MsIGRlc2lyZWRDbGFzcykgewogICAgICAgICAgICB3aGlsZSAocHRyQ2xhc3MgIT09IGRlc2lyZWRDbGFzcykgewogICAgICAgICAgICAgIGlmICghcHRyQ2xhc3MudXBjYXN0KSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiRXhwZWN0ZWQgbnVsbCBvciBpbnN0YW5jZSBvZiAiICsgZGVzaXJlZENsYXNzLm5hbWUgKyAiLCBnb3QgYW4gaW5zdGFuY2Ugb2YgIiArIHB0ckNsYXNzLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwdHIgPSBwdHJDbGFzcy51cGNhc3QocHRyKTsKICAgICAgICAgICAgICBwdHJDbGFzcyA9IHB0ckNsYXNzLmJhc2VDbGFzczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29uc3ROb1NtYXJ0UHRyUmF3UG9pbnRlclRvV2lyZVR5cGUoZGVzdHJ1Y3RvcnMsIGhhbmRsZSkgewogICAgICAgICAgICBpZiAoaGFuZGxlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSZWZlcmVuY2UpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJudWxsIGlzIG5vdCBhIHZhbGlkICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCdDYW5ub3QgcGFzcyAiJyArIF9lbWJpbmRfcmVwcihoYW5kbGUpICsgJyIgYXMgYSAnICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJC5wdHIpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHBhc3MgZGVsZXRlZCBvYmplY3QgYXMgYSBwb2ludGVyIG9mIHR5cGUgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhbmRsZUNsYXNzID0gaGFuZGxlLiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzOwogICAgICAgICAgICB2YXIgcHRyID0gdXBjYXN0UG9pbnRlcihoYW5kbGUuJCQucHRyLCBoYW5kbGVDbGFzcywgdGhpcy5yZWdpc3RlcmVkQ2xhc3MpOwogICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2VuZXJpY1BvaW50ZXJUb1dpcmVUeXBlKGRlc3RydWN0b3JzLCBoYW5kbGUpIHsKICAgICAgICAgICAgdmFyIHB0cjsKICAgICAgICAgICAgaWYgKGhhbmRsZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICh0aGlzLmlzUmVmZXJlbmNlKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigibnVsbCBpcyBub3QgYSB2YWxpZCAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTbWFydFBvaW50ZXIpIHsKICAgICAgICAgICAgICAgIHB0ciA9IHRoaXMucmF3Q29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIGlmIChkZXN0cnVjdG9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5wdXNoKHRoaXMucmF3RGVzdHJ1Y3RvciwgcHRyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCdDYW5ub3QgcGFzcyAiJyArIF9lbWJpbmRfcmVwcihoYW5kbGUpICsgJyIgYXMgYSAnICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJC5wdHIpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHBhc3MgZGVsZXRlZCBvYmplY3QgYXMgYSBwb2ludGVyIG9mIHR5cGUgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLmlzQ29uc3QgJiYgaGFuZGxlLiQkLnB0clR5cGUuaXNDb25zdCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgY29udmVydCBhcmd1bWVudCBvZiB0eXBlICIgKyAoaGFuZGxlLiQkLnNtYXJ0UHRyVHlwZSA/IGhhbmRsZS4kJC5zbWFydFB0clR5cGUubmFtZSA6IGhhbmRsZS4kJC5wdHJUeXBlLm5hbWUpICsgIiB0byBwYXJhbWV0ZXIgdHlwZSAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFuZGxlQ2xhc3MgPSBoYW5kbGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgIHB0ciA9IHVwY2FzdFBvaW50ZXIoaGFuZGxlLiQkLnB0ciwgaGFuZGxlQ2xhc3MsIHRoaXMucmVnaXN0ZXJlZENsYXNzKTsKICAgICAgICAgICAgaWYgKHRoaXMuaXNTbWFydFBvaW50ZXIpIHsKICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBoYW5kbGUuJCQuc21hcnRQdHIpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJQYXNzaW5nIHJhdyBwb2ludGVyIHRvIHNtYXJ0IHBvaW50ZXIgaXMgaWxsZWdhbCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzd2l0Y2ggKHRoaXMuc2hhcmluZ1BvbGljeSkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBpZiAoaGFuZGxlLiQkLnNtYXJ0UHRyVHlwZSA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgIHB0ciA9IGhhbmRsZS4kJC5zbWFydFB0cjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiICsgKGhhbmRsZS4kJC5zbWFydFB0clR5cGUgPyBoYW5kbGUuJCQuc21hcnRQdHJUeXBlLm5hbWUgOiBoYW5kbGUuJCQucHRyVHlwZS5uYW1lKSArICIgdG8gcGFyYW1ldGVyIHR5cGUgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIHB0ciA9IGhhbmRsZS4kJC5zbWFydFB0cjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgIGlmIChoYW5kbGUuJCQuc21hcnRQdHJUeXBlID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICAgICAgcHRyID0gaGFuZGxlLiQkLnNtYXJ0UHRyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZWRIYW5kbGUgPSBoYW5kbGVbImNsb25lIl0oKTsKICAgICAgICAgICAgICAgICAgICBwdHIgPSB0aGlzLnJhd1NoYXJlKHB0ciwgX19lbXZhbF9yZWdpc3RlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIGNsb25lZEhhbmRsZVsiZGVsZXRlIl0oKTsKICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3RydWN0b3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5wdXNoKHRoaXMucmF3RGVzdHJ1Y3RvciwgcHRyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiVW5zdXBwb3J0aW5nIHNoYXJpbmcgcG9saWN5Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBub25Db25zdE5vU21hcnRQdHJSYXdQb2ludGVyVG9XaXJlVHlwZShkZXN0cnVjdG9ycywgaGFuZGxlKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5pc1JlZmVyZW5jZSkgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIm51bGwgaXMgbm90IGEgdmFsaWQgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaGFuZGxlLiQkKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoJ0Nhbm5vdCBwYXNzICInICsgX2VtYmluZF9yZXByKGhhbmRsZSkgKyAnIiBhcyBhICcgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaGFuZGxlLiQkLnB0cikgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcGFzcyBkZWxldGVkIG9iamVjdCBhcyBhIHBvaW50ZXIgb2YgdHlwZSAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFuZGxlLiQkLnB0clR5cGUuaXNDb25zdCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgY29udmVydCBhcmd1bWVudCBvZiB0eXBlICIgKyBoYW5kbGUuJCQucHRyVHlwZS5uYW1lICsgIiB0byBwYXJhbWV0ZXIgdHlwZSAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFuZGxlQ2xhc3MgPSBoYW5kbGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgIHZhciBwdHIgPSB1cGNhc3RQb2ludGVyKGhhbmRsZS4kJC5wdHIsIGhhbmRsZUNsYXNzLCB0aGlzLnJlZ2lzdGVyZWRDbGFzcyk7CiAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWdpc3RlcmVkUG9pbnRlcl9nZXRQb2ludGVlKHB0cikgewogICAgICAgICAgICBpZiAodGhpcy5yYXdHZXRQb2ludGVlKSB7CiAgICAgICAgICAgICAgcHRyID0gdGhpcy5yYXdHZXRQb2ludGVlKHB0cik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFJlZ2lzdGVyZWRQb2ludGVyX2Rlc3RydWN0b3IocHRyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnJhd0Rlc3RydWN0b3IpIHsKICAgICAgICAgICAgICB0aGlzLnJhd0Rlc3RydWN0b3IocHRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUmVnaXN0ZXJlZFBvaW50ZXJfZGVsZXRlT2JqZWN0KGhhbmRsZSkgewogICAgICAgICAgICBpZiAoaGFuZGxlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaGFuZGxlWyJkZWxldGUiXSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkb3duY2FzdFBvaW50ZXIocHRyLCBwdHJDbGFzcywgZGVzaXJlZENsYXNzKSB7CiAgICAgICAgICAgIGlmIChwdHJDbGFzcyA9PT0gZGVzaXJlZENsYXNzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodm9pZCAwID09PSBkZXNpcmVkQ2xhc3MuYmFzZUNsYXNzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJ2ID0gZG93bmNhc3RQb2ludGVyKHB0ciwgcHRyQ2xhc3MsIGRlc2lyZWRDbGFzcy5iYXNlQ2xhc3MpOwogICAgICAgICAgICBpZiAocnYgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVzaXJlZENsYXNzLmRvd25jYXN0KHJ2KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEluaGVyaXRlZEluc3RhbmNlQ291bnQoKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZWdpc3RlcmVkSW5zdGFuY2VzKS5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRMaXZlSW5oZXJpdGVkSW5zdGFuY2VzKCkgewogICAgICAgICAgICB2YXIgcnYgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgayBpbiByZWdpc3RlcmVkSW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdGVyZWRJbnN0YW5jZXMuaGFzT3duUHJvcGVydHkoaykpIHsKICAgICAgICAgICAgICAgIHJ2LnB1c2gocmVnaXN0ZXJlZEluc3RhbmNlc1trXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBydjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNldERlbGF5RnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgZGVsYXlGdW5jdGlvbiA9IGZuOwogICAgICAgICAgICBpZiAoZGVsZXRpb25RdWV1ZS5sZW5ndGggJiYgZGVsYXlGdW5jdGlvbikgewogICAgICAgICAgICAgIGRlbGF5RnVuY3Rpb24oZmx1c2hQZW5kaW5nRGVsZXRlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluaXRfZW1iaW5kKCkgewogICAgICAgICAgICBNb2R1bGVbImdldEluaGVyaXRlZEluc3RhbmNlQ291bnQiXSA9IGdldEluaGVyaXRlZEluc3RhbmNlQ291bnQ7CiAgICAgICAgICAgIE1vZHVsZVsiZ2V0TGl2ZUluaGVyaXRlZEluc3RhbmNlcyJdID0gZ2V0TGl2ZUluaGVyaXRlZEluc3RhbmNlczsKICAgICAgICAgICAgTW9kdWxlWyJmbHVzaFBlbmRpbmdEZWxldGVzIl0gPSBmbHVzaFBlbmRpbmdEZWxldGVzOwogICAgICAgICAgICBNb2R1bGVbInNldERlbGF5RnVuY3Rpb24iXSA9IHNldERlbGF5RnVuY3Rpb247CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVnaXN0ZXJlZEluc3RhbmNlcyA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gZ2V0QmFzZXN0UG9pbnRlcihjbGFzc18sIHB0cikgewogICAgICAgICAgICBpZiAocHRyID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigicHRyIHNob3VsZCBub3QgYmUgdW5kZWZpbmVkIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGNsYXNzXy5iYXNlQ2xhc3MpIHsKICAgICAgICAgICAgICBwdHIgPSBjbGFzc18udXBjYXN0KHB0cik7CiAgICAgICAgICAgICAgY2xhc3NfID0gY2xhc3NfLmJhc2VDbGFzczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0SW5oZXJpdGVkSW5zdGFuY2UoY2xhc3NfLCBwdHIpIHsKICAgICAgICAgICAgcHRyID0gZ2V0QmFzZXN0UG9pbnRlcihjbGFzc18sIHB0cik7CiAgICAgICAgICAgIHJldHVybiByZWdpc3RlcmVkSW5zdGFuY2VzW3B0cl07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYWtlQ2xhc3NIYW5kbGUocHJvdG90eXBlLCByZWNvcmQpIHsKICAgICAgICAgICAgaWYgKCFyZWNvcmQucHRyVHlwZSB8fCAhcmVjb3JkLnB0cikgewogICAgICAgICAgICAgIHRocm93SW50ZXJuYWxFcnJvcigibWFrZUNsYXNzSGFuZGxlIHJlcXVpcmVzIHB0ciBhbmQgcHRyVHlwZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNTbWFydFB0clR5cGUgPSAhIXJlY29yZC5zbWFydFB0clR5cGU7CiAgICAgICAgICAgIHZhciBoYXNTbWFydFB0ciA9ICEhcmVjb3JkLnNtYXJ0UHRyOwogICAgICAgICAgICBpZiAoaGFzU21hcnRQdHJUeXBlICE9PSBoYXNTbWFydFB0cikgewogICAgICAgICAgICAgIHRocm93SW50ZXJuYWxFcnJvcigiQm90aCBzbWFydFB0clR5cGUgYW5kIHNtYXJ0UHRyIG11c3QgYmUgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb3JkLmNvdW50ID0geyB2YWx1ZTogMSB9OwogICAgICAgICAgICByZXR1cm4gYXR0YWNoRmluYWxpemVyKE9iamVjdC5jcmVhdGUocHJvdG90eXBlLCB7ICQkOiB7IHZhbHVlOiByZWNvcmQgfSB9KSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWdpc3RlcmVkUG9pbnRlcl9mcm9tV2lyZVR5cGUocHRyKSB7CiAgICAgICAgICAgIHZhciByYXdQb2ludGVyID0gdGhpcy5nZXRQb2ludGVlKHB0cik7CiAgICAgICAgICAgIGlmICghcmF3UG9pbnRlcikgewogICAgICAgICAgICAgIHRoaXMuZGVzdHJ1Y3RvcihwdHIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZWdpc3RlcmVkSW5zdGFuY2UgPSBnZXRJbmhlcml0ZWRJbnN0YW5jZSh0aGlzLnJlZ2lzdGVyZWRDbGFzcywgcmF3UG9pbnRlcik7CiAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IHJlZ2lzdGVyZWRJbnN0YW5jZSkgewogICAgICAgICAgICAgIGlmICgwID09PSByZWdpc3RlcmVkSW5zdGFuY2UuJCQuY291bnQudmFsdWUpIHsKICAgICAgICAgICAgICAgIHJlZ2lzdGVyZWRJbnN0YW5jZS4kJC5wdHIgPSByYXdQb2ludGVyOwogICAgICAgICAgICAgICAgcmVnaXN0ZXJlZEluc3RhbmNlLiQkLnNtYXJ0UHRyID0gcHRyOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyZWRJbnN0YW5jZVsiY2xvbmUiXSgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcnYgPSByZWdpc3RlcmVkSW5zdGFuY2VbImNsb25lIl0oKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJ1Y3RvcihwdHIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJ2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBtYWtlRGVmYXVsdEhhbmRsZSgpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5pc1NtYXJ0UG9pbnRlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VDbGFzc0hhbmRsZSh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSwgeyBwdHJUeXBlOiB0aGlzLnBvaW50ZWVUeXBlLCBwdHI6IHJhd1BvaW50ZXIsIHNtYXJ0UHRyVHlwZTogdGhpcywgc21hcnRQdHI6IHB0ciB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VDbGFzc0hhbmRsZSh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSwgeyBwdHJUeXBlOiB0aGlzLCBwdHIgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhY3R1YWxUeXBlID0gdGhpcy5yZWdpc3RlcmVkQ2xhc3MuZ2V0QWN0dWFsVHlwZShyYXdQb2ludGVyKTsKICAgICAgICAgICAgdmFyIHJlZ2lzdGVyZWRQb2ludGVyUmVjb3JkID0gcmVnaXN0ZXJlZFBvaW50ZXJzW2FjdHVhbFR5cGVdOwogICAgICAgICAgICBpZiAoIXJlZ2lzdGVyZWRQb2ludGVyUmVjb3JkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VEZWZhdWx0SGFuZGxlLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRvVHlwZTsKICAgICAgICAgICAgaWYgKHRoaXMuaXNDb25zdCkgewogICAgICAgICAgICAgIHRvVHlwZSA9IHJlZ2lzdGVyZWRQb2ludGVyUmVjb3JkLmNvbnN0UG9pbnRlclR5cGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdG9UeXBlID0gcmVnaXN0ZXJlZFBvaW50ZXJSZWNvcmQucG9pbnRlclR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRwID0gZG93bmNhc3RQb2ludGVyKHJhd1BvaW50ZXIsIHRoaXMucmVnaXN0ZXJlZENsYXNzLCB0b1R5cGUucmVnaXN0ZXJlZENsYXNzKTsKICAgICAgICAgICAgaWYgKGRwID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VEZWZhdWx0SGFuZGxlLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuaXNTbWFydFBvaW50ZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gbWFrZUNsYXNzSGFuZGxlKHRvVHlwZS5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGUsIHsgcHRyVHlwZTogdG9UeXBlLCBwdHI6IGRwLCBzbWFydFB0clR5cGU6IHRoaXMsIHNtYXJ0UHRyOiBwdHIgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VDbGFzc0hhbmRsZSh0b1R5cGUucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLCB7IHB0clR5cGU6IHRvVHlwZSwgcHRyOiBkcCB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdF9SZWdpc3RlcmVkUG9pbnRlcigpIHsKICAgICAgICAgICAgUmVnaXN0ZXJlZFBvaW50ZXIucHJvdG90eXBlLmdldFBvaW50ZWUgPSBSZWdpc3RlcmVkUG9pbnRlcl9nZXRQb2ludGVlOwogICAgICAgICAgICBSZWdpc3RlcmVkUG9pbnRlci5wcm90b3R5cGUuZGVzdHJ1Y3RvciA9IFJlZ2lzdGVyZWRQb2ludGVyX2Rlc3RydWN0b3I7CiAgICAgICAgICAgIFJlZ2lzdGVyZWRQb2ludGVyLnByb3RvdHlwZVsiYXJnUGFja0FkdmFuY2UiXSA9IDg7CiAgICAgICAgICAgIFJlZ2lzdGVyZWRQb2ludGVyLnByb3RvdHlwZVsicmVhZFZhbHVlRnJvbVBvaW50ZXIiXSA9IHNpbXBsZVJlYWRWYWx1ZUZyb21Qb2ludGVyOwogICAgICAgICAgICBSZWdpc3RlcmVkUG9pbnRlci5wcm90b3R5cGVbImRlbGV0ZU9iamVjdCJdID0gUmVnaXN0ZXJlZFBvaW50ZXJfZGVsZXRlT2JqZWN0OwogICAgICAgICAgICBSZWdpc3RlcmVkUG9pbnRlci5wcm90b3R5cGVbImZyb21XaXJlVHlwZSJdID0gUmVnaXN0ZXJlZFBvaW50ZXJfZnJvbVdpcmVUeXBlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUmVnaXN0ZXJlZFBvaW50ZXIobmFtZSwgcmVnaXN0ZXJlZENsYXNzLCBpc1JlZmVyZW5jZSwgaXNDb25zdCwgaXNTbWFydFBvaW50ZXIsIHBvaW50ZWVUeXBlLCBzaGFyaW5nUG9saWN5LCByYXdHZXRQb2ludGVlLCByYXdDb25zdHJ1Y3RvciwgcmF3U2hhcmUsIHJhd0Rlc3RydWN0b3IpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy5yZWdpc3RlcmVkQ2xhc3MgPSByZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgIHRoaXMuaXNSZWZlcmVuY2UgPSBpc1JlZmVyZW5jZTsKICAgICAgICAgICAgdGhpcy5pc0NvbnN0ID0gaXNDb25zdDsKICAgICAgICAgICAgdGhpcy5pc1NtYXJ0UG9pbnRlciA9IGlzU21hcnRQb2ludGVyOwogICAgICAgICAgICB0aGlzLnBvaW50ZWVUeXBlID0gcG9pbnRlZVR5cGU7CiAgICAgICAgICAgIHRoaXMuc2hhcmluZ1BvbGljeSA9IHNoYXJpbmdQb2xpY3k7CiAgICAgICAgICAgIHRoaXMucmF3R2V0UG9pbnRlZSA9IHJhd0dldFBvaW50ZWU7CiAgICAgICAgICAgIHRoaXMucmF3Q29uc3RydWN0b3IgPSByYXdDb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdGhpcy5yYXdTaGFyZSA9IHJhd1NoYXJlOwogICAgICAgICAgICB0aGlzLnJhd0Rlc3RydWN0b3IgPSByYXdEZXN0cnVjdG9yOwogICAgICAgICAgICBpZiAoIWlzU21hcnRQb2ludGVyICYmIHJlZ2lzdGVyZWRDbGFzcy5iYXNlQ2xhc3MgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmIChpc0NvbnN0KSB7CiAgICAgICAgICAgICAgICB0aGlzWyJ0b1dpcmVUeXBlIl0gPSBjb25zdE5vU21hcnRQdHJSYXdQb2ludGVyVG9XaXJlVHlwZTsKICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJ1Y3RvckZ1bmN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc1sidG9XaXJlVHlwZSJdID0gbm9uQ29uc3ROb1NtYXJ0UHRyUmF3UG9pbnRlclRvV2lyZVR5cGU7CiAgICAgICAgICAgICAgICB0aGlzLmRlc3RydWN0b3JGdW5jdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXNbInRvV2lyZVR5cGUiXSA9IGdlbmVyaWNQb2ludGVyVG9XaXJlVHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVwbGFjZVB1YmxpY1N5bWJvbChuYW1lLCB2YWx1ZSwgbnVtQXJndW1lbnRzKSB7CiAgICAgICAgICAgIGlmICghTW9kdWxlLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgdGhyb3dJbnRlcm5hbEVycm9yKCJSZXBsYWNpbmcgbm9uZXhpc3RhbnQgcHVibGljIHN5bWJvbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IE1vZHVsZVtuYW1lXS5vdmVybG9hZFRhYmxlICYmIHZvaWQgMCAhPT0gbnVtQXJndW1lbnRzKSB7CiAgICAgICAgICAgICAgTW9kdWxlW25hbWVdLm92ZXJsb2FkVGFibGVbbnVtQXJndW1lbnRzXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIE1vZHVsZVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgIE1vZHVsZVtuYW1lXS5hcmdDb3VudCA9IG51bUFyZ3VtZW50czsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZHluQ2FsbExlZ2FjeShzaWcsIHB0ciwgYXJncykgewogICAgICAgICAgICB2YXIgZiA9IE1vZHVsZVsiZHluQ2FsbF8iICsgc2lnXTsKICAgICAgICAgICAgcmV0dXJuIGFyZ3MgJiYgYXJncy5sZW5ndGggPyBmLmFwcGx5KG51bGwsIFtwdHJdLmNvbmNhdChhcmdzKSkgOiBmLmNhbGwobnVsbCwgcHRyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGR5bkNhbGwoc2lnLCBwdHIsIGFyZ3MpIHsKICAgICAgICAgICAgaWYgKHNpZy5pbmRleE9mKCJqIikgIT0gLTEpIHsKICAgICAgICAgICAgICByZXR1cm4gZHluQ2FsbExlZ2FjeShzaWcsIHB0ciwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdhc21UYWJsZS5nZXQocHRyKS5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldER5bkNhbGxlcihzaWcsIHB0cikgewogICAgICAgICAgICB2YXIgYXJnQ2FjaGUgPSBbXTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGFyZ0NhY2hlLmxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGFyZ0NhY2hlW2ldID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZHluQ2FsbChzaWcsIHB0ciwgYXJnQ2FjaGUpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oc2lnbmF0dXJlLCByYXdGdW5jdGlvbikgewogICAgICAgICAgICBzaWduYXR1cmUgPSByZWFkTGF0aW4xU3RyaW5nKHNpZ25hdHVyZSk7CiAgICAgICAgICAgIGZ1bmN0aW9uIG1ha2VEeW5DYWxsZXIoKSB7CiAgICAgICAgICAgICAgaWYgKHNpZ25hdHVyZS5pbmRleE9mKCJqIikgIT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXREeW5DYWxsZXIoc2lnbmF0dXJlLCByYXdGdW5jdGlvbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB3YXNtVGFibGUuZ2V0KHJhd0Z1bmN0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnAgPSBtYWtlRHluQ2FsbGVyKCk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZnAgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigidW5rbm93biBmdW5jdGlvbiBwb2ludGVyIHdpdGggc2lnbmF0dXJlICIgKyBzaWduYXR1cmUgKyAiOiAiICsgcmF3RnVuY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmcDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBVbmJvdW5kVHlwZUVycm9yID0gdm9pZCAwOwogICAgICAgICAgZnVuY3Rpb24gZ2V0VHlwZU5hbWUodHlwZSkgewogICAgICAgICAgICB2YXIgcHRyID0gX19fZ2V0VHlwZU5hbWUodHlwZSk7CiAgICAgICAgICAgIHZhciBydiA9IHJlYWRMYXRpbjFTdHJpbmcocHRyKTsKICAgICAgICAgICAgX2ZyZWUocHRyKTsKICAgICAgICAgICAgcmV0dXJuIHJ2OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdGhyb3dVbmJvdW5kVHlwZUVycm9yKG1lc3NhZ2UsIHR5cGVzKSB7CiAgICAgICAgICAgIHZhciB1bmJvdW5kVHlwZXMgPSBbXTsKICAgICAgICAgICAgdmFyIHNlZW4gPSB7fTsKICAgICAgICAgICAgZnVuY3Rpb24gdmlzaXQodHlwZSkgewogICAgICAgICAgICAgIGlmIChzZWVuW3R5cGVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWdpc3RlcmVkVHlwZXNbdHlwZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVEZXBlbmRlbmNpZXNbdHlwZV0pIHsKICAgICAgICAgICAgICAgIHR5cGVEZXBlbmRlbmNpZXNbdHlwZV0uZm9yRWFjaCh2aXNpdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVuYm91bmRUeXBlcy5wdXNoKHR5cGUpOwogICAgICAgICAgICAgIHNlZW5bdHlwZV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHR5cGVzLmZvckVhY2godmlzaXQpOwogICAgICAgICAgICB0aHJvdyBuZXcgVW5ib3VuZFR5cGVFcnJvcihtZXNzYWdlICsgIjogIiArIHVuYm91bmRUeXBlcy5tYXAoZ2V0VHlwZU5hbWUpLmpvaW4oWyIsICJdKSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9jbGFzcyhyYXdUeXBlLCByYXdQb2ludGVyVHlwZSwgcmF3Q29uc3RQb2ludGVyVHlwZSwgYmFzZUNsYXNzUmF3VHlwZSwgZ2V0QWN0dWFsVHlwZVNpZ25hdHVyZSwgZ2V0QWN0dWFsVHlwZSwgdXBjYXN0U2lnbmF0dXJlLCB1cGNhc3QsIGRvd25jYXN0U2lnbmF0dXJlLCBkb3duY2FzdCwgbmFtZSwgZGVzdHJ1Y3RvclNpZ25hdHVyZSwgcmF3RGVzdHJ1Y3RvcikgewogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgZ2V0QWN0dWFsVHlwZSA9IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGdldEFjdHVhbFR5cGVTaWduYXR1cmUsIGdldEFjdHVhbFR5cGUpOwogICAgICAgICAgICBpZiAodXBjYXN0KSB7CiAgICAgICAgICAgICAgdXBjYXN0ID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24odXBjYXN0U2lnbmF0dXJlLCB1cGNhc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb3duY2FzdCkgewogICAgICAgICAgICAgIGRvd25jYXN0ID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oZG93bmNhc3RTaWduYXR1cmUsIGRvd25jYXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByYXdEZXN0cnVjdG9yID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oZGVzdHJ1Y3RvclNpZ25hdHVyZSwgcmF3RGVzdHJ1Y3Rvcik7CiAgICAgICAgICAgIHZhciBsZWdhbEZ1bmN0aW9uTmFtZSA9IG1ha2VMZWdhbEZ1bmN0aW9uTmFtZShuYW1lKTsKICAgICAgICAgICAgZXhwb3NlUHVibGljU3ltYm9sKGxlZ2FsRnVuY3Rpb25OYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvd1VuYm91bmRUeXBlRXJyb3IoIkNhbm5vdCBjb25zdHJ1Y3QgIiArIG5hbWUgKyAiIGR1ZSB0byB1bmJvdW5kIHR5cGVzIiwgW2Jhc2VDbGFzc1Jhd1R5cGVdKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtyYXdUeXBlLCByYXdQb2ludGVyVHlwZSwgcmF3Q29uc3RQb2ludGVyVHlwZV0sIGJhc2VDbGFzc1Jhd1R5cGUgPyBbYmFzZUNsYXNzUmF3VHlwZV0gOiBbXSwgZnVuY3Rpb24oYmFzZSkgewogICAgICAgICAgICAgIGJhc2UgPSBiYXNlWzBdOwogICAgICAgICAgICAgIHZhciBiYXNlQ2xhc3M7CiAgICAgICAgICAgICAgdmFyIGJhc2VQcm90b3R5cGU7CiAgICAgICAgICAgICAgaWYgKGJhc2VDbGFzc1Jhd1R5cGUpIHsKICAgICAgICAgICAgICAgIGJhc2VDbGFzcyA9IGJhc2UucmVnaXN0ZXJlZENsYXNzOwogICAgICAgICAgICAgICAgYmFzZVByb3RvdHlwZSA9IGJhc2VDbGFzcy5pbnN0YW5jZVByb3RvdHlwZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYmFzZVByb3RvdHlwZSA9IENsYXNzSGFuZGxlLnByb3RvdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gY3JlYXRlTmFtZWRGdW5jdGlvbihsZWdhbEZ1bmN0aW9uTmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpICE9PSBpbnN0YW5jZVByb3RvdHlwZSkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmluZGluZ0Vycm9yKCJVc2UgJ25ldycgdG8gY29uc3RydWN0ICIgKyBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IHJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBCaW5kaW5nRXJyb3IobmFtZSArICIgaGFzIG5vIGFjY2Vzc2libGUgY29uc3RydWN0b3IiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBib2R5ID0gcmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHlbYXJndW1lbnRzLmxlbmd0aF07CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBib2R5KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBCaW5kaW5nRXJyb3IoIlRyaWVkIHRvIGludm9rZSBjdG9yIG9mICIgKyBuYW1lICsgIiB3aXRoIGludmFsaWQgbnVtYmVyIG9mIHBhcmFtZXRlcnMgKCIgKyBhcmd1bWVudHMubGVuZ3RoICsgIikgLSBleHBlY3RlZCAoIiArIE9iamVjdC5rZXlzKHJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5KS50b1N0cmluZygpICsgIikgcGFyYW1ldGVycyBpbnN0ZWFkISIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGJvZHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2VQcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGJhc2VQcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IGNvbnN0cnVjdG9yIH0gfSk7CiAgICAgICAgICAgICAgY29uc3RydWN0b3IucHJvdG90eXBlID0gaW5zdGFuY2VQcm90b3R5cGU7CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdGVyZWRDbGFzcyA9IG5ldyBSZWdpc3RlcmVkQ2xhc3MobmFtZSwgY29uc3RydWN0b3IsIGluc3RhbmNlUHJvdG90eXBlLCByYXdEZXN0cnVjdG9yLCBiYXNlQ2xhc3MsIGdldEFjdHVhbFR5cGUsIHVwY2FzdCwgZG93bmNhc3QpOwogICAgICAgICAgICAgIHZhciByZWZlcmVuY2VDb252ZXJ0ZXIgPSBuZXcgUmVnaXN0ZXJlZFBvaW50ZXIobmFtZSwgcmVnaXN0ZXJlZENsYXNzLCB0cnVlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgIHZhciBwb2ludGVyQ29udmVydGVyID0gbmV3IFJlZ2lzdGVyZWRQb2ludGVyKG5hbWUgKyAiKiIsIHJlZ2lzdGVyZWRDbGFzcywgZmFsc2UsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgdmFyIGNvbnN0UG9pbnRlckNvbnZlcnRlciA9IG5ldyBSZWdpc3RlcmVkUG9pbnRlcihuYW1lICsgIiBjb25zdCoiLCByZWdpc3RlcmVkQ2xhc3MsIGZhbHNlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgICAgICAgcmVnaXN0ZXJlZFBvaW50ZXJzW3Jhd1R5cGVdID0geyBwb2ludGVyVHlwZTogcG9pbnRlckNvbnZlcnRlciwgY29uc3RQb2ludGVyVHlwZTogY29uc3RQb2ludGVyQ29udmVydGVyIH07CiAgICAgICAgICAgICAgcmVwbGFjZVB1YmxpY1N5bWJvbChsZWdhbEZ1bmN0aW9uTmFtZSwgY29uc3RydWN0b3IpOwogICAgICAgICAgICAgIHJldHVybiBbcmVmZXJlbmNlQ29udmVydGVyLCBwb2ludGVyQ29udmVydGVyLCBjb25zdFBvaW50ZXJDb252ZXJ0ZXJdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGhlYXAzMlZlY3RvclRvQXJyYXkoY291bnQsIGZpcnN0RWxlbWVudCkgewogICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgYXJyYXkucHVzaChIRUFQMzJbKGZpcnN0RWxlbWVudCA+PiAyKSArIGldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19jb25zdHJ1Y3RvcihyYXdDbGFzc1R5cGUsIGFyZ0NvdW50LCByYXdBcmdUeXBlc0FkZHIsIGludm9rZXJTaWduYXR1cmUsIGludm9rZXIsIHJhd0NvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIGFzc2VydChhcmdDb3VudCA+IDApOwogICAgICAgICAgICB2YXIgcmF3QXJnVHlwZXMgPSBoZWFwMzJWZWN0b3JUb0FycmF5KGFyZ0NvdW50LCByYXdBcmdUeXBlc0FkZHIpOwogICAgICAgICAgICBpbnZva2VyID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oaW52b2tlclNpZ25hdHVyZSwgaW52b2tlcik7CiAgICAgICAgICAgIHZhciBhcmdzID0gW3Jhd0NvbnN0cnVjdG9yXTsKICAgICAgICAgICAgdmFyIGRlc3RydWN0b3JzID0gW107CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCBbcmF3Q2xhc3NUeXBlXSwgZnVuY3Rpb24oY2xhc3NUeXBlKSB7CiAgICAgICAgICAgICAgY2xhc3NUeXBlID0gY2xhc3NUeXBlWzBdOwogICAgICAgICAgICAgIHZhciBodW1hbk5hbWUgPSAiY29uc3RydWN0b3IgIiArIGNsYXNzVHlwZS5uYW1lOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keSkgewogICAgICAgICAgICAgICAgY2xhc3NUeXBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5ID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keVthcmdDb3VudCAtIDFdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmluZGluZ0Vycm9yKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgY29uc3RydWN0b3JzIHdpdGggaWRlbnRpY2FsIG51bWJlciBvZiBwYXJhbWV0ZXJzICgiICsgKGFyZ0NvdW50IC0gMSkgKyAiKSBmb3IgY2xhc3MgJyIgKyBjbGFzc1R5cGUubmFtZSArICInISBPdmVybG9hZCByZXNvbHV0aW9uIGlzIGN1cnJlbnRseSBvbmx5IHBlcmZvcm1lZCB1c2luZyB0aGUgcGFyYW1ldGVyIGNvdW50LCBub3QgYWN0dWFsIHR5cGUgaW5mbyEiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2xhc3NUeXBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W2FyZ0NvdW50IC0gMV0gPSBmdW5jdGlvbiB1bmJvdW5kVHlwZUhhbmRsZXIoKSB7CiAgICAgICAgICAgICAgICB0aHJvd1VuYm91bmRUeXBlRXJyb3IoIkNhbm5vdCBjb25zdHJ1Y3QgIiArIGNsYXNzVHlwZS5uYW1lICsgIiBkdWUgdG8gdW5ib3VuZCB0eXBlcyIsIHJhd0FyZ1R5cGVzKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCByYXdBcmdUeXBlcywgZnVuY3Rpb24oYXJnVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keVthcmdDb3VudCAtIDFdID0gZnVuY3Rpb24gY29uc3RydWN0b3JfYm9keSgpIHsKICAgICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggIT09IGFyZ0NvdW50IC0gMSkgewogICAgICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKGh1bWFuTmFtZSArICIgY2FsbGVkIHdpdGggIiArIGFyZ3VtZW50cy5sZW5ndGggKyAiIGFyZ3VtZW50cywgZXhwZWN0ZWQgIiArIChhcmdDb3VudCAtIDEpKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5sZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICBhcmdzLmxlbmd0aCA9IGFyZ0NvdW50OwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ0NvdW50OyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW2ldID0gYXJnVHlwZXNbaV1bInRvV2lyZVR5cGUiXShkZXN0cnVjdG9ycywgYXJndW1lbnRzW2kgLSAxXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHB0ciA9IGludm9rZXIuYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgICAgICAgIHJ1bkRlc3RydWN0b3JzKGRlc3RydWN0b3JzKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ1R5cGVzWzBdWyJmcm9tV2lyZVR5cGUiXShwdHIpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbmV3Xyhjb25zdHJ1Y3RvciwgYXJndW1lbnRMaXN0KSB7CiAgICAgICAgICAgIGlmICghKGNvbnN0cnVjdG9yIGluc3RhbmNlb2YgRnVuY3Rpb24pKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigibmV3XyBjYWxsZWQgd2l0aCBjb25zdHJ1Y3RvciB0eXBlICIgKyB0eXBlb2YgY29uc3RydWN0b3IgKyAiIHdoaWNoIGlzIG5vdCBhIGZ1bmN0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGR1bW15ID0gY3JlYXRlTmFtZWRGdW5jdGlvbihjb25zdHJ1Y3Rvci5uYW1lIHx8ICJ1bmtub3duRnVuY3Rpb25OYW1lIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkdW1teS5wcm90b3R5cGUgPSBjb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgICAgICAgIHZhciBvYmogPSBuZXcgZHVtbXkoKTsKICAgICAgICAgICAgdmFyIHIgPSBjb25zdHJ1Y3Rvci5hcHBseShvYmosIGFyZ3VtZW50TGlzdCk7CiAgICAgICAgICAgIHJldHVybiByIGluc3RhbmNlb2YgT2JqZWN0ID8gciA6IG9iajsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyYWZ0SW52b2tlckZ1bmN0aW9uKGh1bWFuTmFtZSwgYXJnVHlwZXMsIGNsYXNzVHlwZSwgY3BwSW52b2tlckZ1bmMsIGNwcFRhcmdldEZ1bmMpIHsKICAgICAgICAgICAgdmFyIGFyZ0NvdW50ID0gYXJnVHlwZXMubGVuZ3RoOwogICAgICAgICAgICBpZiAoYXJnQ291bnQgPCAyKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoImFyZ1R5cGVzIGFycmF5IHNpemUgbWlzbWF0Y2ghIE11c3QgYXQgbGVhc3QgZ2V0IHJldHVybiB2YWx1ZSBhbmQgJ3RoaXMnIHR5cGVzISIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0NsYXNzTWV0aG9kRnVuYyA9IGFyZ1R5cGVzWzFdICE9PSBudWxsICYmIGNsYXNzVHlwZSAhPT0gbnVsbDsKICAgICAgICAgICAgdmFyIG5lZWRzRGVzdHJ1Y3RvclN0YWNrID0gZmFsc2U7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJnVHlwZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICBpZiAoYXJnVHlwZXNbaV0gIT09IG51bGwgJiYgYXJnVHlwZXNbaV0uZGVzdHJ1Y3RvckZ1bmN0aW9uID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIG5lZWRzRGVzdHJ1Y3RvclN0YWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmV0dXJucyA9IGFyZ1R5cGVzWzBdLm5hbWUgIT09ICJ2b2lkIjsKICAgICAgICAgICAgdmFyIGFyZ3NMaXN0ID0gIiI7CiAgICAgICAgICAgIHZhciBhcmdzTGlzdFdpcmVkID0gIiI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnQ291bnQgLSAyOyArK2kpIHsKICAgICAgICAgICAgICBhcmdzTGlzdCArPSAoaSAhPT0gMCA/ICIsICIgOiAiIikgKyAiYXJnIiArIGk7CiAgICAgICAgICAgICAgYXJnc0xpc3RXaXJlZCArPSAoaSAhPT0gMCA/ICIsICIgOiAiIikgKyAiYXJnIiArIGkgKyAiV2lyZWQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnZva2VyRm5Cb2R5ID0gInJldHVybiBmdW5jdGlvbiAiICsgbWFrZUxlZ2FsRnVuY3Rpb25OYW1lKGh1bWFuTmFtZSkgKyAiKCIgKyBhcmdzTGlzdCArICIpIHtcbmlmIChhcmd1bWVudHMubGVuZ3RoICE9PSAiICsgKGFyZ0NvdW50IC0gMikgKyAiKSB7XG50aHJvd0JpbmRpbmdFcnJvcignZnVuY3Rpb24gIiArIGh1bWFuTmFtZSArICIgY2FsbGVkIHdpdGggJyArIGFyZ3VtZW50cy5sZW5ndGggKyAnIGFyZ3VtZW50cywgZXhwZWN0ZWQgIiArIChhcmdDb3VudCAtIDIpICsgIiBhcmdzIScpO1xufVxuIjsKICAgICAgICAgICAgaWYgKG5lZWRzRGVzdHJ1Y3RvclN0YWNrKSB7CiAgICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAidmFyIGRlc3RydWN0b3JzID0gW107XG4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkdG9yU3RhY2sgPSBuZWVkc0Rlc3RydWN0b3JTdGFjayA/ICJkZXN0cnVjdG9ycyIgOiAibnVsbCI7CiAgICAgICAgICAgIHZhciBhcmdzMSA9IFsidGhyb3dCaW5kaW5nRXJyb3IiLCAiaW52b2tlciIsICJmbiIsICJydW5EZXN0cnVjdG9ycyIsICJyZXRUeXBlIiwgImNsYXNzUGFyYW0iXTsKICAgICAgICAgICAgdmFyIGFyZ3MyID0gW3Rocm93QmluZGluZ0Vycm9yLCBjcHBJbnZva2VyRnVuYywgY3BwVGFyZ2V0RnVuYywgcnVuRGVzdHJ1Y3RvcnMsIGFyZ1R5cGVzWzBdLCBhcmdUeXBlc1sxXV07CiAgICAgICAgICAgIGlmIChpc0NsYXNzTWV0aG9kRnVuYykgewogICAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gInZhciB0aGlzV2lyZWQgPSBjbGFzc1BhcmFtLnRvV2lyZVR5cGUoIiArIGR0b3JTdGFjayArICIsIHRoaXMpO1xuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50IC0gMjsgKytpKSB7CiAgICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAidmFyIGFyZyIgKyBpICsgIldpcmVkID0gYXJnVHlwZSIgKyBpICsgIi50b1dpcmVUeXBlKCIgKyBkdG9yU3RhY2sgKyAiLCBhcmciICsgaSArICIpOyAvLyAiICsgYXJnVHlwZXNbaSArIDJdLm5hbWUgKyAiXG4iOwogICAgICAgICAgICAgIGFyZ3MxLnB1c2goImFyZ1R5cGUiICsgaSk7CiAgICAgICAgICAgICAgYXJnczIucHVzaChhcmdUeXBlc1tpICsgMl0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0NsYXNzTWV0aG9kRnVuYykgewogICAgICAgICAgICAgIGFyZ3NMaXN0V2lyZWQgPSAidGhpc1dpcmVkIiArIChhcmdzTGlzdFdpcmVkLmxlbmd0aCA+IDAgPyAiLCAiIDogIiIpICsgYXJnc0xpc3RXaXJlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnZva2VyRm5Cb2R5ICs9IChyZXR1cm5zID8gInZhciBydiA9ICIgOiAiIikgKyAiaW52b2tlcihmbiIgKyAoYXJnc0xpc3RXaXJlZC5sZW5ndGggPiAwID8gIiwgIiA6ICIiKSArIGFyZ3NMaXN0V2lyZWQgKyAiKTtcbiI7CiAgICAgICAgICAgIGlmIChuZWVkc0Rlc3RydWN0b3JTdGFjaykgewogICAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gInJ1bkRlc3RydWN0b3JzKGRlc3RydWN0b3JzKTtcbiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGlzQ2xhc3NNZXRob2RGdW5jID8gMSA6IDI7IGkgPCBhcmdUeXBlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIHBhcmFtTmFtZSA9IGkgPT09IDEgPyAidGhpc1dpcmVkIiA6ICJhcmciICsgKGkgLSAyKSArICJXaXJlZCI7CiAgICAgICAgICAgICAgICBpZiAoYXJnVHlwZXNbaV0uZGVzdHJ1Y3RvckZ1bmN0aW9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gcGFyYW1OYW1lICsgIl9kdG9yKCIgKyBwYXJhbU5hbWUgKyAiKTsgLy8gIiArIGFyZ1R5cGVzW2ldLm5hbWUgKyAiXG4iOwogICAgICAgICAgICAgICAgICBhcmdzMS5wdXNoKHBhcmFtTmFtZSArICJfZHRvciIpOwogICAgICAgICAgICAgICAgICBhcmdzMi5wdXNoKGFyZ1R5cGVzW2ldLmRlc3RydWN0b3JGdW5jdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXR1cm5zKSB7CiAgICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAidmFyIHJldCA9IHJldFR5cGUuZnJvbVdpcmVUeXBlKHJ2KTtcbnJldHVybiByZXQ7XG4iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB9CiAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gIn1cbiI7CiAgICAgICAgICAgIGFyZ3MxLnB1c2goaW52b2tlckZuQm9keSk7CiAgICAgICAgICAgIHZhciBpbnZva2VyRnVuY3Rpb24gPSBuZXdfKEZ1bmN0aW9uLCBhcmdzMSkuYXBwbHkobnVsbCwgYXJnczIpOwogICAgICAgICAgICByZXR1cm4gaW52b2tlckZ1bmN0aW9uOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3NfZnVuY3Rpb24ocmF3Q2xhc3NUeXBlLCBtZXRob2ROYW1lLCBhcmdDb3VudCwgcmF3QXJnVHlwZXNBZGRyLCBpbnZva2VyU2lnbmF0dXJlLCByYXdJbnZva2VyLCBjb250ZXh0LCBpc1B1cmVWaXJ0dWFsKSB7CiAgICAgICAgICAgIHZhciByYXdBcmdUeXBlcyA9IGhlYXAzMlZlY3RvclRvQXJyYXkoYXJnQ291bnQsIHJhd0FyZ1R5cGVzQWRkcik7CiAgICAgICAgICAgIG1ldGhvZE5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG1ldGhvZE5hbWUpOwogICAgICAgICAgICByYXdJbnZva2VyID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oaW52b2tlclNpZ25hdHVyZSwgcmF3SW52b2tlcik7CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCBbcmF3Q2xhc3NUeXBlXSwgZnVuY3Rpb24oY2xhc3NUeXBlKSB7CiAgICAgICAgICAgICAgY2xhc3NUeXBlID0gY2xhc3NUeXBlWzBdOwogICAgICAgICAgICAgIHZhciBodW1hbk5hbWUgPSBjbGFzc1R5cGUubmFtZSArICIuIiArIG1ldGhvZE5hbWU7CiAgICAgICAgICAgICAgaWYgKGlzUHVyZVZpcnR1YWwpIHsKICAgICAgICAgICAgICAgIGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MucHVyZVZpcnR1YWxGdW5jdGlvbnMucHVzaChtZXRob2ROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZnVuY3Rpb24gdW5ib3VuZFR5cGVzSGFuZGxlcigpIHsKICAgICAgICAgICAgICAgIHRocm93VW5ib3VuZFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgIiArIGh1bWFuTmFtZSArICIgZHVlIHRvIHVuYm91bmQgdHlwZXMiLCByYXdBcmdUeXBlcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm90byA9IGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGU7CiAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IHByb3RvW21ldGhvZE5hbWVdOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IG1ldGhvZCB8fCB2b2lkIDAgPT09IG1ldGhvZC5vdmVybG9hZFRhYmxlICYmIG1ldGhvZC5jbGFzc05hbWUgIT09IGNsYXNzVHlwZS5uYW1lICYmIG1ldGhvZC5hcmdDb3VudCA9PT0gYXJnQ291bnQgLSAyKSB7CiAgICAgICAgICAgICAgICB1bmJvdW5kVHlwZXNIYW5kbGVyLmFyZ0NvdW50ID0gYXJnQ291bnQgLSAyOwogICAgICAgICAgICAgICAgdW5ib3VuZFR5cGVzSGFuZGxlci5jbGFzc05hbWUgPSBjbGFzc1R5cGUubmFtZTsKICAgICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdID0gdW5ib3VuZFR5cGVzSGFuZGxlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW5zdXJlT3ZlcmxvYWRUYWJsZShwcm90bywgbWV0aG9kTmFtZSwgaHVtYW5OYW1lKTsKICAgICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGVbYXJnQ291bnQgLSAyXSA9IHVuYm91bmRUeXBlc0hhbmRsZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCByYXdBcmdUeXBlcywgZnVuY3Rpb24oYXJnVHlwZXMpIHsKICAgICAgICAgICAgICAgIHZhciBtZW1iZXJGdW5jdGlvbiA9IGNyYWZ0SW52b2tlckZ1bmN0aW9uKGh1bWFuTmFtZSwgYXJnVHlwZXMsIGNsYXNzVHlwZSwgcmF3SW52b2tlciwgY29udGV4dCk7CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlKSB7CiAgICAgICAgICAgICAgICAgIG1lbWJlckZ1bmN0aW9uLmFyZ0NvdW50ID0gYXJnQ291bnQgLSAyOwogICAgICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXSA9IG1lbWJlckZ1bmN0aW9uOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZVthcmdDb3VudCAtIDJdID0gbWVtYmVyRnVuY3Rpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2NvbnN0YW50KG5hbWUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbXSwgW3R5cGVdLCBmdW5jdGlvbih0eXBlMikgewogICAgICAgICAgICAgIHR5cGUyID0gdHlwZTJbMF07CiAgICAgICAgICAgICAgTW9kdWxlW25hbWVdID0gdHlwZTJbImZyb21XaXJlVHlwZSJdKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVtdmFsX2ZyZWVfbGlzdCA9IFtdOwogICAgICAgICAgdmFyIGVtdmFsX2hhbmRsZV9hcnJheSA9IFt7fSwgeyB2YWx1ZTogdm9pZCAwIH0sIHsgdmFsdWU6IG51bGwgfSwgeyB2YWx1ZTogdHJ1ZSB9LCB7IHZhbHVlOiBmYWxzZSB9XTsKICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfZGVjcmVmKGhhbmRsZSkgewogICAgICAgICAgICBpZiAoaGFuZGxlID4gNCAmJiAwID09PSAtLWVtdmFsX2hhbmRsZV9hcnJheVtoYW5kbGVdLnJlZmNvdW50KSB7CiAgICAgICAgICAgICAgZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgZW12YWxfZnJlZV9saXN0LnB1c2goaGFuZGxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY291bnRfZW12YWxfaGFuZGxlcygpIHsKICAgICAgICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDU7IGkgPCBlbXZhbF9oYW5kbGVfYXJyYXkubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICBpZiAoZW12YWxfaGFuZGxlX2FycmF5W2ldICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICsrY291bnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldF9maXJzdF9lbXZhbCgpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDU7IGkgPCBlbXZhbF9oYW5kbGVfYXJyYXkubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICBpZiAoZW12YWxfaGFuZGxlX2FycmF5W2ldICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbXZhbF9oYW5kbGVfYXJyYXlbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdF9lbXZhbCgpIHsKICAgICAgICAgICAgTW9kdWxlWyJjb3VudF9lbXZhbF9oYW5kbGVzIl0gPSBjb3VudF9lbXZhbF9oYW5kbGVzOwogICAgICAgICAgICBNb2R1bGVbImdldF9maXJzdF9lbXZhbCJdID0gZ2V0X2ZpcnN0X2VtdmFsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9yZWdpc3Rlcih2YWx1ZSkgewogICAgICAgICAgICBzd2l0Y2ggKHZhbHVlKSB7CiAgICAgICAgICAgICAgY2FzZSB2b2lkIDA6IHsKICAgICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIG51bGw6IHsKICAgICAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIHRydWU6IHsKICAgICAgICAgICAgICAgIHJldHVybiAzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIGZhbHNlOiB7CiAgICAgICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgdmFyIGhhbmRsZSA9IGVtdmFsX2ZyZWVfbGlzdC5sZW5ndGggPyBlbXZhbF9mcmVlX2xpc3QucG9wKCkgOiBlbXZhbF9oYW5kbGVfYXJyYXkubGVuZ3RoOwogICAgICAgICAgICAgICAgZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0gPSB7IHJlZmNvdW50OiAxLCB2YWx1ZSB9OwogICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2VtdmFsKHJhd1R5cGUsIG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCB7IG5hbWUsICJmcm9tV2lyZVR5cGUiOiBmdW5jdGlvbihoYW5kbGUpIHsKICAgICAgICAgICAgICB2YXIgcnYgPSBlbXZhbF9oYW5kbGVfYXJyYXlbaGFuZGxlXS52YWx1ZTsKICAgICAgICAgICAgICBfX2VtdmFsX2RlY3JlZihoYW5kbGUpOwogICAgICAgICAgICAgIHJldHVybiBydjsKICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3Rlcih2YWx1ZSk7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IHNpbXBsZVJlYWRWYWx1ZUZyb21Qb2ludGVyLCBkZXN0cnVjdG9yRnVuY3Rpb246IG51bGwgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBlbnVtUmVhZFZhbHVlRnJvbVBvaW50ZXIobmFtZSwgc2hpZnQsIHNpZ25lZCkgewogICAgICAgICAgICBzd2l0Y2ggKHNoaWZ0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGhlYXAgPSBzaWduZWQgPyBIRUFQOCA6IEhFQVBVODsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbImZyb21XaXJlVHlwZSJdKGhlYXBbcG9pbnRlcl0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9pbnRlcikgewogICAgICAgICAgICAgICAgICB2YXIgaGVhcCA9IHNpZ25lZCA/IEhFQVAxNiA6IEhFQVBVMTY7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShoZWFwW3BvaW50ZXIgPj4gMV0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9pbnRlcikgewogICAgICAgICAgICAgICAgICB2YXIgaGVhcCA9IHNpZ25lZCA/IEhFQVAzMiA6IEhFQVBVMzI7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShoZWFwW3BvaW50ZXIgPj4gMl0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBpbnRlZ2VyIHR5cGU6ICIgKyBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfZW51bShyYXdUeXBlLCBuYW1lLCBzaXplLCBpc1NpZ25lZCkgewogICAgICAgICAgICB2YXIgc2hpZnQgPSBnZXRTaGlmdEZyb21TaXplKHNpemUpOwogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgZnVuY3Rpb24gY3RvcigpIHsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdG9yLnZhbHVlcyA9IHt9OwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCBjb25zdHJ1Y3RvcjogY3RvciwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci52YWx1ZXNbY107CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIGMpIHsKICAgICAgICAgICAgICByZXR1cm4gYy52YWx1ZTsKICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogZW51bVJlYWRWYWx1ZUZyb21Qb2ludGVyKG5hbWUsIHNoaWZ0LCBpc1NpZ25lZCksIGRlc3RydWN0b3JGdW5jdGlvbjogbnVsbCB9KTsKICAgICAgICAgICAgZXhwb3NlUHVibGljU3ltYm9sKG5hbWUsIGN0b3IpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVxdWlyZVJlZ2lzdGVyZWRUeXBlKHJhd1R5cGUsIGh1bWFuTmFtZSkgewogICAgICAgICAgICB2YXIgaW1wbCA9IHJlZ2lzdGVyZWRUeXBlc1tyYXdUeXBlXTsKICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gaW1wbCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKGh1bWFuTmFtZSArICIgaGFzIHVua25vd24gdHlwZSAiICsgZ2V0VHlwZU5hbWUocmF3VHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbXBsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfZW51bV92YWx1ZShyYXdFbnVtVHlwZSwgbmFtZSwgZW51bVZhbHVlKSB7CiAgICAgICAgICAgIHZhciBlbnVtVHlwZSA9IHJlcXVpcmVSZWdpc3RlcmVkVHlwZShyYXdFbnVtVHlwZSwgImVudW0iKTsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHZhciBFbnVtID0gZW51bVR5cGUuY29uc3RydWN0b3I7CiAgICAgICAgICAgIHZhciBWYWx1ZSA9IE9iamVjdC5jcmVhdGUoZW51bVR5cGUuY29uc3RydWN0b3IucHJvdG90eXBlLCB7IHZhbHVlOiB7IHZhbHVlOiBlbnVtVmFsdWUgfSwgY29uc3RydWN0b3I6IHsgdmFsdWU6IGNyZWF0ZU5hbWVkRnVuY3Rpb24oZW51bVR5cGUubmFtZSArICJfIiArIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB9KSB9IH0pOwogICAgICAgICAgICBFbnVtLnZhbHVlc1tlbnVtVmFsdWVdID0gVmFsdWU7CiAgICAgICAgICAgIEVudW1bbmFtZV0gPSBWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9lbWJpbmRfcmVwcih2MykgewogICAgICAgICAgICBpZiAodjMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gIm51bGwiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0ID0gdHlwZW9mIHYzOwogICAgICAgICAgICBpZiAodCA9PT0gIm9iamVjdCIgfHwgdCA9PT0gImFycmF5IiB8fCB0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHYzLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiICsgdjM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZsb2F0UmVhZFZhbHVlRnJvbVBvaW50ZXIobmFtZSwgc2hpZnQpIHsKICAgICAgICAgICAgc3dpdGNoIChzaGlmdCkgewogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShIRUFQRjMyW3BvaW50ZXIgPj4gMl0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1siZnJvbVdpcmVUeXBlIl0oSEVBUEY2NFtwb2ludGVyID4+IDNdKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZmxvYXQgdHlwZTogIiArIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9mbG9hdChyYXdUeXBlLCBuYW1lLCBzaXplKSB7CiAgICAgICAgICAgIHZhciBzaGlmdCA9IGdldFNoaWZ0RnJvbVNpemUoc2l6ZSk7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm51bWJlciIgJiYgdHlwZW9mIHZhbHVlICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjb252ZXJ0ICInICsgX2VtYmluZF9yZXByKHZhbHVlKSArICciIHRvICcgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IGZsb2F0UmVhZFZhbHVlRnJvbVBvaW50ZXIobmFtZSwgc2hpZnQpLCBkZXN0cnVjdG9yRnVuY3Rpb246IG51bGwgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9mdW5jdGlvbihuYW1lLCBhcmdDb3VudCwgcmF3QXJnVHlwZXNBZGRyLCBzaWduYXR1cmUsIHJhd0ludm9rZXIsIGZuKSB7CiAgICAgICAgICAgIHZhciBhcmdUeXBlcyA9IGhlYXAzMlZlY3RvclRvQXJyYXkoYXJnQ291bnQsIHJhd0FyZ1R5cGVzQWRkcik7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICByYXdJbnZva2VyID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oc2lnbmF0dXJlLCByYXdJbnZva2VyKTsKICAgICAgICAgICAgZXhwb3NlUHVibGljU3ltYm9sKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93VW5ib3VuZFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgIiArIG5hbWUgKyAiIGR1ZSB0byB1bmJvdW5kIHR5cGVzIiwgYXJnVHlwZXMpOwogICAgICAgICAgICB9LCBhcmdDb3VudCAtIDEpOwogICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbXSwgYXJnVHlwZXMsIGZ1bmN0aW9uKGFyZ1R5cGVzMikgewogICAgICAgICAgICAgIHZhciBpbnZva2VyQXJnc0FycmF5ID0gW2FyZ1R5cGVzMlswXSwgbnVsbF0uY29uY2F0KGFyZ1R5cGVzMi5zbGljZSgxKSk7CiAgICAgICAgICAgICAgcmVwbGFjZVB1YmxpY1N5bWJvbChuYW1lLCBjcmFmdEludm9rZXJGdW5jdGlvbihuYW1lLCBpbnZva2VyQXJnc0FycmF5LCBudWxsLCByYXdJbnZva2VyLCBmbiksIGFyZ0NvdW50IC0gMSk7CiAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGludGVnZXJSZWFkVmFsdWVGcm9tUG9pbnRlcihuYW1lLCBzaGlmdCwgc2lnbmVkKSB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hpZnQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICByZXR1cm4gc2lnbmVkID8gZnVuY3Rpb24gcmVhZFM4RnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUDhbcG9pbnRlcl07CiAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24gcmVhZFU4RnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUFU4W3BvaW50ZXJdOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICByZXR1cm4gc2lnbmVkID8gZnVuY3Rpb24gcmVhZFMxNkZyb21Qb2ludGVyKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQVAxNltwb2ludGVyID4+IDFdOwogICAgICAgICAgICAgICAgfSA6IGZ1bmN0aW9uIHJlYWRVMTZGcm9tUG9pbnRlcihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQVTE2W3BvaW50ZXIgPj4gMV07CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiBzaWduZWQgPyBmdW5jdGlvbiByZWFkUzMyRnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUDMyW3BvaW50ZXIgPj4gMl07CiAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24gcmVhZFUzMkZyb21Qb2ludGVyKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQVBVMzJbcG9pbnRlciA+PiAyXTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gaW50ZWdlciB0eXBlOiAiICsgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2ludGVnZXIocHJpbWl0aXZlVHlwZSwgbmFtZSwgc2l6ZSwgbWluUmFuZ2UsIG1heFJhbmdlKSB7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICBpZiAobWF4UmFuZ2UgPT09IC0xKSB7CiAgICAgICAgICAgICAgbWF4UmFuZ2UgPSA0Mjk0OTY3Mjk1OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaGlmdCA9IGdldFNoaWZ0RnJvbVNpemUoc2l6ZSk7CiAgICAgICAgICAgIHZhciBmcm9tV2lyZVR5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKG1pblJhbmdlID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIGJpdHNoaWZ0ID0gMzIgLSA4ICogc2l6ZTsKICAgICAgICAgICAgICBmcm9tV2lyZVR5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlIDw8IGJpdHNoaWZ0ID4+PiBiaXRzaGlmdDsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1Vuc2lnbmVkVHlwZSA9IG5hbWUuaW5kZXhPZigidW5zaWduZWQiKSAhPSAtMTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHByaW1pdGl2ZVR5cGUsIHsgbmFtZSwgImZyb21XaXJlVHlwZSI6IGZyb21XaXJlVHlwZSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgdmFsdWUpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAibnVtYmVyIiAmJiB0eXBlb2YgdmFsdWUgIT09ICJib29sZWFuIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNvbnZlcnQgIicgKyBfZW1iaW5kX3JlcHIodmFsdWUpICsgJyIgdG8gJyArIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2YWx1ZSA8IG1pblJhbmdlIHx8IHZhbHVlID4gbWF4UmFuZ2UpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Bhc3NpbmcgYSBudW1iZXIgIicgKyBfZW1iaW5kX3JlcHIodmFsdWUpICsgJyIgZnJvbSBKUyBzaWRlIHRvIEMvQysrIHNpZGUgdG8gYW4gYXJndW1lbnQgb2YgdHlwZSAiJyArIG5hbWUgKyAnIiwgd2hpY2ggaXMgb3V0c2lkZSB0aGUgdmFsaWQgcmFuZ2UgWycgKyBtaW5SYW5nZSArICIsICIgKyBtYXhSYW5nZSArICJdISIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gaXNVbnNpZ25lZFR5cGUgPyB2YWx1ZSA+Pj4gMCA6IHZhbHVlIHwgMDsKICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogaW50ZWdlclJlYWRWYWx1ZUZyb21Qb2ludGVyKG5hbWUsIHNoaWZ0LCBtaW5SYW5nZSAhPT0gMCksIGRlc3RydWN0b3JGdW5jdGlvbjogbnVsbCB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX21lbW9yeV92aWV3KHJhd1R5cGUsIGRhdGFUeXBlSW5kZXgsIG5hbWUpIHsKICAgICAgICAgICAgdmFyIHR5cGVNYXBwaW5nID0gW0ludDhBcnJheSwgVWludDhBcnJheSwgSW50MTZBcnJheSwgVWludDE2QXJyYXksIEludDMyQXJyYXksIFVpbnQzMkFycmF5LCBGbG9hdDMyQXJyYXksIEZsb2F0NjRBcnJheV07CiAgICAgICAgICAgIHZhciBUQSA9IHR5cGVNYXBwaW5nW2RhdGFUeXBlSW5kZXhdOwogICAgICAgICAgICBmdW5jdGlvbiBkZWNvZGVNZW1vcnlWaWV3KGhhbmRsZSkgewogICAgICAgICAgICAgIGhhbmRsZSA9IGhhbmRsZSA+PiAyOwogICAgICAgICAgICAgIHZhciBoZWFwID0gSEVBUFUzMjsKICAgICAgICAgICAgICB2YXIgc2l6ZSA9IGhlYXBbaGFuZGxlXTsKICAgICAgICAgICAgICB2YXIgZGF0YSA9IGhlYXBbaGFuZGxlICsgMV07CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUQShidWZmZXIsIGRhdGEsIHNpemUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZGVjb2RlTWVtb3J5VmlldywgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogZGVjb2RlTWVtb3J5VmlldyB9LCB7IGlnbm9yZUR1cGxpY2F0ZVJlZ2lzdHJhdGlvbnM6IHRydWUgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9zdGRfc3RyaW5nKHJhd1R5cGUsIG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHZhciBzdGRTdHJpbmdJc1VURjggPSBuYW1lID09PSAic3RkOjpzdHJpbmciOwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gSEVBUFUzMlt2YWx1ZSA+PiAyXTsKICAgICAgICAgICAgICB2YXIgc3RyOwogICAgICAgICAgICAgIGlmIChzdGRTdHJpbmdJc1VURjgpIHsKICAgICAgICAgICAgICAgIHZhciBkZWNvZGVTdGFydFB0ciA9IHZhbHVlICsgNDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Qnl0ZVB0ciA9IHZhbHVlICsgNCArIGk7CiAgICAgICAgICAgICAgICAgIGlmIChpID09IGxlbmd0aCB8fCBIRUFQVThbY3VycmVudEJ5dGVQdHJdID09IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF4UmVhZCA9IGN1cnJlbnRCeXRlUHRyIC0gZGVjb2RlU3RhcnRQdHI7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0cmluZ1NlZ21lbnQgPSBVVEY4VG9TdHJpbmcoZGVjb2RlU3RhcnRQdHIsIG1heFJlYWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdHIgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyaW5nU2VnbWVudDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMCk7CiAgICAgICAgICAgICAgICAgICAgICBzdHIgKz0gc3RyaW5nU2VnbWVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGVjb2RlU3RhcnRQdHIgPSBjdXJyZW50Qnl0ZVB0ciArIDE7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGEzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgIGEzW2ldID0gU3RyaW5nLmZyb21DaGFyQ29kZShIRUFQVThbdmFsdWUgKyA0ICsgaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyID0gYTMuam9pbigiIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF9mcmVlKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgICAgICB9LCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCB2YWx1ZSkgewogICAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IG5ldyBVaW50OEFycmF5KHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGdldExlbmd0aDsKICAgICAgICAgICAgICB2YXIgdmFsdWVJc09mVHlwZVN0cmluZyA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyI7CiAgICAgICAgICAgICAgaWYgKCEodmFsdWVJc09mVHlwZVN0cmluZyB8fCB2YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgfHwgdmFsdWUgaW5zdGFuY2VvZiBVaW50OENsYW1wZWRBcnJheSB8fCB2YWx1ZSBpbnN0YW5jZW9mIEludDhBcnJheSkpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcGFzcyBub24tc3RyaW5nIHRvIHN0ZDo6c3RyaW5nIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzdGRTdHJpbmdJc1VURjggJiYgdmFsdWVJc09mVHlwZVN0cmluZykgewogICAgICAgICAgICAgICAgZ2V0TGVuZ3RoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBsZW5ndGhCeXRlc1VURjgodmFsdWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZ2V0TGVuZ3RoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gZ2V0TGVuZ3RoKCk7CiAgICAgICAgICAgICAgdmFyIHB0ciA9IF9tYWxsb2MoNCArIGxlbmd0aCArIDEpOwogICAgICAgICAgICAgIEhFQVBVMzJbcHRyID4+IDJdID0gbGVuZ3RoOwogICAgICAgICAgICAgIGlmIChzdGRTdHJpbmdJc1VURjggJiYgdmFsdWVJc09mVHlwZVN0cmluZykgewogICAgICAgICAgICAgICAgc3RyaW5nVG9VVEY4KHZhbHVlLCBwdHIgKyA0LCBsZW5ndGggKyAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHZhbHVlSXNPZlR5cGVTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGFyQ29kZSA9IHZhbHVlLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXJDb2RlID4gMjU1KSB7CiAgICAgICAgICAgICAgICAgICAgICBfZnJlZShwdHIpOwogICAgICAgICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIlN0cmluZyBoYXMgVVRGLTE2IGNvZGUgdW5pdHMgdGhhdCBkbyBub3QgZml0IGluIDggYml0cyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBIRUFQVThbcHRyICsgNCArIGldID0gY2hhckNvZGU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBIRUFQVThbcHRyICsgNCArIGldID0gdmFsdWVbaV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRlc3RydWN0b3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5wdXNoKF9mcmVlLCBwdHIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBzaW1wbGVSZWFkVmFsdWVGcm9tUG9pbnRlciwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiBmdW5jdGlvbihwdHIpIHsKICAgICAgICAgICAgICBfZnJlZShwdHIpOwogICAgICAgICAgICB9IH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfc3RkX3dzdHJpbmcocmF3VHlwZSwgY2hhclNpemUsIG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHZhciBkZWNvZGVTdHJpbmcsIGVuY29kZVN0cmluZywgZ2V0SGVhcCwgbGVuZ3RoQnl0ZXNVVEYsIHNoaWZ0OwogICAgICAgICAgICBpZiAoY2hhclNpemUgPT09IDIpIHsKICAgICAgICAgICAgICBkZWNvZGVTdHJpbmcgPSBVVEYxNlRvU3RyaW5nOwogICAgICAgICAgICAgIGVuY29kZVN0cmluZyA9IHN0cmluZ1RvVVRGMTY7CiAgICAgICAgICAgICAgbGVuZ3RoQnl0ZXNVVEYgPSBsZW5ndGhCeXRlc1VURjE2OwogICAgICAgICAgICAgIGdldEhlYXAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBIRUFQVTE2OwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc2hpZnQgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXJTaXplID09PSA0KSB7CiAgICAgICAgICAgICAgZGVjb2RlU3RyaW5nID0gVVRGMzJUb1N0cmluZzsKICAgICAgICAgICAgICBlbmNvZGVTdHJpbmcgPSBzdHJpbmdUb1VURjMyOwogICAgICAgICAgICAgIGxlbmd0aEJ5dGVzVVRGID0gbGVuZ3RoQnl0ZXNVVEYzMjsKICAgICAgICAgICAgICBnZXRIZWFwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gSEVBUFUzMjsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHNoaWZ0ID0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gSEVBUFUzMlt2YWx1ZSA+PiAyXTsKICAgICAgICAgICAgICB2YXIgSEVBUCA9IGdldEhlYXAoKTsKICAgICAgICAgICAgICB2YXIgc3RyOwogICAgICAgICAgICAgIHZhciBkZWNvZGVTdGFydFB0ciA9IHZhbHVlICsgNDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBsZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRCeXRlUHRyID0gdmFsdWUgKyA0ICsgaSAqIGNoYXJTaXplOwogICAgICAgICAgICAgICAgaWYgKGkgPT0gbGVuZ3RoIHx8IEhFQVBbY3VycmVudEJ5dGVQdHIgPj4gc2hpZnRdID09IDApIHsKICAgICAgICAgICAgICAgICAgdmFyIG1heFJlYWRCeXRlcyA9IGN1cnJlbnRCeXRlUHRyIC0gZGVjb2RlU3RhcnRQdHI7CiAgICAgICAgICAgICAgICAgIHZhciBzdHJpbmdTZWdtZW50ID0gZGVjb2RlU3RyaW5nKGRlY29kZVN0YXJ0UHRyLCBtYXhSZWFkQnl0ZXMpOwogICAgICAgICAgICAgICAgICBpZiAoc3RyID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHJpbmdTZWdtZW50OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDApOwogICAgICAgICAgICAgICAgICAgIHN0ciArPSBzdHJpbmdTZWdtZW50OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlY29kZVN0YXJ0UHRyID0gY3VycmVudEJ5dGVQdHIgKyBjaGFyU2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgX2ZyZWUodmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKCEodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcGFzcyBub24tc3RyaW5nIHRvIEMrKyBzdHJpbmcgdHlwZSAiICsgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBsZW5ndGggPSBsZW5ndGhCeXRlc1VURih2YWx1ZSk7CiAgICAgICAgICAgICAgdmFyIHB0ciA9IF9tYWxsb2MoNCArIGxlbmd0aCArIGNoYXJTaXplKTsKICAgICAgICAgICAgICBIRUFQVTMyW3B0ciA+PiAyXSA9IGxlbmd0aCA+PiBzaGlmdDsKICAgICAgICAgICAgICBlbmNvZGVTdHJpbmcodmFsdWUsIHB0ciArIDQsIGxlbmd0aCArIGNoYXJTaXplKTsKICAgICAgICAgICAgICBpZiAoZGVzdHJ1Y3RvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRlc3RydWN0b3JzLnB1c2goX2ZyZWUsIHB0cik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IHNpbXBsZVJlYWRWYWx1ZUZyb21Qb2ludGVyLCBkZXN0cnVjdG9yRnVuY3Rpb246IGZ1bmN0aW9uKHB0cikgewogICAgICAgICAgICAgIF9mcmVlKHB0cik7CiAgICAgICAgICAgIH0gfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl92YWx1ZV9vYmplY3QocmF3VHlwZSwgbmFtZSwgY29uc3RydWN0b3JTaWduYXR1cmUsIHJhd0NvbnN0cnVjdG9yLCBkZXN0cnVjdG9yU2lnbmF0dXJlLCByYXdEZXN0cnVjdG9yKSB7CiAgICAgICAgICAgIHN0cnVjdFJlZ2lzdHJhdGlvbnNbcmF3VHlwZV0gPSB7IG5hbWU6IHJlYWRMYXRpbjFTdHJpbmcobmFtZSksIHJhd0NvbnN0cnVjdG9yOiBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihjb25zdHJ1Y3RvclNpZ25hdHVyZSwgcmF3Q29uc3RydWN0b3IpLCByYXdEZXN0cnVjdG9yOiBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihkZXN0cnVjdG9yU2lnbmF0dXJlLCByYXdEZXN0cnVjdG9yKSwgZmllbGRzOiBbXSB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfdmFsdWVfb2JqZWN0X2ZpZWxkKHN0cnVjdFR5cGUsIGZpZWxkTmFtZSwgZ2V0dGVyUmV0dXJuVHlwZSwgZ2V0dGVyU2lnbmF0dXJlLCBnZXR0ZXIsIGdldHRlckNvbnRleHQsIHNldHRlckFyZ3VtZW50VHlwZSwgc2V0dGVyU2lnbmF0dXJlLCBzZXR0ZXIsIHNldHRlckNvbnRleHQpIHsKICAgICAgICAgICAgc3RydWN0UmVnaXN0cmF0aW9uc1tzdHJ1Y3RUeXBlXS5maWVsZHMucHVzaCh7IGZpZWxkTmFtZTogcmVhZExhdGluMVN0cmluZyhmaWVsZE5hbWUpLCBnZXR0ZXJSZXR1cm5UeXBlLCBnZXR0ZXI6IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGdldHRlclNpZ25hdHVyZSwgZ2V0dGVyKSwgZ2V0dGVyQ29udGV4dCwgc2V0dGVyQXJndW1lbnRUeXBlLCBzZXR0ZXI6IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKHNldHRlclNpZ25hdHVyZSwgc2V0dGVyKSwgc2V0dGVyQ29udGV4dCB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX3ZvaWQocmF3VHlwZSwgbmFtZSkgewogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgaXNWb2lkOiB0cnVlLCBuYW1lLCAiYXJnUGFja0FkdmFuY2UiOiAwLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgbykgewogICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgIH0gfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXF1aXJlSGFuZGxlKGhhbmRsZSkgewogICAgICAgICAgICBpZiAoIWhhbmRsZSkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgdXNlIGRlbGV0ZWQgdmFsLiBoYW5kbGUgPSAiICsgaGFuZGxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0udmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2FzKGhhbmRsZSwgcmV0dXJuVHlwZSwgZGVzdHJ1Y3RvcnNSZWYpIHsKICAgICAgICAgICAgaGFuZGxlID0gcmVxdWlyZUhhbmRsZShoYW5kbGUpOwogICAgICAgICAgICByZXR1cm5UeXBlID0gcmVxdWlyZVJlZ2lzdGVyZWRUeXBlKHJldHVyblR5cGUsICJlbXZhbDo6YXMiKTsKICAgICAgICAgICAgdmFyIGRlc3RydWN0b3JzID0gW107CiAgICAgICAgICAgIHZhciByZCA9IF9fZW12YWxfcmVnaXN0ZXIoZGVzdHJ1Y3RvcnMpOwogICAgICAgICAgICBIRUFQMzJbZGVzdHJ1Y3RvcnNSZWYgPj4gMl0gPSByZDsKICAgICAgICAgICAgcmV0dXJuIHJldHVyblR5cGVbInRvV2lyZVR5cGUiXShkZXN0cnVjdG9ycywgaGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbXZhbF9zeW1ib2xzID0ge307CiAgICAgICAgICBmdW5jdGlvbiBnZXRTdHJpbmdPclN5bWJvbChhZGRyZXNzKSB7CiAgICAgICAgICAgIHZhciBzeW1ib2wgPSBlbXZhbF9zeW1ib2xzW2FkZHJlc3NdOwogICAgICAgICAgICBpZiAoc3ltYm9sID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZExhdGluMVN0cmluZyhhZGRyZXNzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gc3ltYm9sOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW12YWxfbWV0aG9kQ2FsbGVycyA9IFtdOwogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9jYWxsX3ZvaWRfbWV0aG9kKGNhbGxlciwgaGFuZGxlLCBtZXRob2ROYW1lLCBhcmdzKSB7CiAgICAgICAgICAgIGNhbGxlciA9IGVtdmFsX21ldGhvZENhbGxlcnNbY2FsbGVyXTsKICAgICAgICAgICAgaGFuZGxlID0gcmVxdWlyZUhhbmRsZShoYW5kbGUpOwogICAgICAgICAgICBtZXRob2ROYW1lID0gZ2V0U3RyaW5nT3JTeW1ib2wobWV0aG9kTmFtZSk7CiAgICAgICAgICAgIGNhbGxlcihoYW5kbGUsIG1ldGhvZE5hbWUsIG51bGwsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW12YWxfZ2V0X2dsb2JhbCgpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBnbG9iYWxUaGlzID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybiBnbG9iYWxUaGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAoLyogQF9fUFVSRV9fICovIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBGdW5jdGlvbjsKICAgICAgICAgICAgfSgpKSgicmV0dXJuIHRoaXMiKSgpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9nZXRfZ2xvYmFsKG5hbWUpIHsKICAgICAgICAgICAgaWYgKG5hbWUgPT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3RlcihlbXZhbF9nZXRfZ2xvYmFsKCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5hbWUgPSBnZXRTdHJpbmdPclN5bWJvbChuYW1lKTsKICAgICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3RlcihlbXZhbF9nZXRfZ2xvYmFsKClbbmFtZV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2FkZE1ldGhvZENhbGxlcihjYWxsZXIpIHsKICAgICAgICAgICAgdmFyIGlkID0gZW12YWxfbWV0aG9kQ2FsbGVycy5sZW5ndGg7CiAgICAgICAgICAgIGVtdmFsX21ldGhvZENhbGxlcnMucHVzaChjYWxsZXIpOwogICAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2xvb2t1cFR5cGVzKGFyZ0NvdW50LCBhcmdUeXBlcykgewogICAgICAgICAgICB2YXIgYTMgPSBuZXcgQXJyYXkoYXJnQ291bnQpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50OyArK2kpIHsKICAgICAgICAgICAgICBhM1tpXSA9IHJlcXVpcmVSZWdpc3RlcmVkVHlwZShIRUFQMzJbKGFyZ1R5cGVzID4+IDIpICsgaV0sICJwYXJhbWV0ZXIgIiArIGkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhMzsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfZ2V0X21ldGhvZF9jYWxsZXIoYXJnQ291bnQsIGFyZ1R5cGVzKSB7CiAgICAgICAgICAgIHZhciB0eXBlcyA9IF9fZW12YWxfbG9va3VwVHlwZXMoYXJnQ291bnQsIGFyZ1R5cGVzKTsKICAgICAgICAgICAgdmFyIHJldFR5cGUgPSB0eXBlc1swXTsKICAgICAgICAgICAgdmFyIHNpZ25hdHVyZU5hbWUgPSByZXRUeXBlLm5hbWUgKyAiXyQiICsgdHlwZXMuc2xpY2UoMSkubWFwKGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICByZXR1cm4gdC5uYW1lOwogICAgICAgICAgICB9KS5qb2luKCJfIikgKyAiJCI7CiAgICAgICAgICAgIHZhciBwYXJhbXMgPSBbInJldFR5cGUiXTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbcmV0VHlwZV07CiAgICAgICAgICAgIHZhciBhcmdzTGlzdCA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50IC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgYXJnc0xpc3QgKz0gKGkgIT09IDAgPyAiLCAiIDogIiIpICsgImFyZyIgKyBpOwogICAgICAgICAgICAgIHBhcmFtcy5wdXNoKCJhcmdUeXBlIiArIGkpOwogICAgICAgICAgICAgIGFyZ3MucHVzaCh0eXBlc1sxICsgaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBtYWtlTGVnYWxGdW5jdGlvbk5hbWUoIm1ldGhvZENhbGxlcl8iICsgc2lnbmF0dXJlTmFtZSk7CiAgICAgICAgICAgIHZhciBmdW5jdGlvbkJvZHkgPSAicmV0dXJuIGZ1bmN0aW9uICIgKyBmdW5jdGlvbk5hbWUgKyAiKGhhbmRsZSwgbmFtZSwgZGVzdHJ1Y3RvcnMsIGFyZ3MpIHtcbiI7CiAgICAgICAgICAgIHZhciBvZmZzZXQgPSAwOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50IC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICIgICAgdmFyIGFyZyIgKyBpICsgIiA9IGFyZ1R5cGUiICsgaSArICIucmVhZFZhbHVlRnJvbVBvaW50ZXIoYXJncyIgKyAob2Zmc2V0ID8gIisiICsgb2Zmc2V0IDogIiIpICsgIik7XG4iOwogICAgICAgICAgICAgIG9mZnNldCArPSB0eXBlc1tpICsgMV1bImFyZ1BhY2tBZHZhbmNlIl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICIgICAgdmFyIHJ2ID0gaGFuZGxlW25hbWVdKCIgKyBhcmdzTGlzdCArICIpO1xuIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdDb3VudCAtIDE7ICsraSkgewogICAgICAgICAgICAgIGlmICh0eXBlc1tpICsgMV1bImRlbGV0ZU9iamVjdCJdKSB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbkJvZHkgKz0gIiAgICBhcmdUeXBlIiArIGkgKyAiLmRlbGV0ZU9iamVjdChhcmciICsgaSArICIpO1xuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFyZXRUeXBlLmlzVm9pZCkgewogICAgICAgICAgICAgIGZ1bmN0aW9uQm9keSArPSAiICAgIHJldHVybiByZXRUeXBlLnRvV2lyZVR5cGUoZGVzdHJ1Y3RvcnMsIHJ2KTtcbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICJ9O1xuIjsKICAgICAgICAgICAgcGFyYW1zLnB1c2goZnVuY3Rpb25Cb2R5KTsKICAgICAgICAgICAgdmFyIGludm9rZXJGdW5jdGlvbiA9IG5ld18oRnVuY3Rpb24sIHBhcmFtcykuYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgIHJldHVybiBfX2VtdmFsX2FkZE1ldGhvZENhbGxlcihpbnZva2VyRnVuY3Rpb24pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9nZXRfbW9kdWxlX3Byb3BlcnR5KG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IGdldFN0cmluZ09yU3ltYm9sKG5hbWUpOwogICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3RlcihNb2R1bGVbbmFtZV0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9nZXRfcHJvcGVydHkoaGFuZGxlLCBrZXkyKSB7CiAgICAgICAgICAgIGhhbmRsZSA9IHJlcXVpcmVIYW5kbGUoaGFuZGxlKTsKICAgICAgICAgICAga2V5MiA9IHJlcXVpcmVIYW5kbGUoa2V5Mik7CiAgICAgICAgICAgIHJldHVybiBfX2VtdmFsX3JlZ2lzdGVyKGhhbmRsZVtrZXkyXSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2luY3JlZihoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKGhhbmRsZSA+IDQpIHsKICAgICAgICAgICAgICBlbXZhbF9oYW5kbGVfYXJyYXlbaGFuZGxlXS5yZWZjb3VudCArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmFmdEVtdmFsQWxsb2NhdG9yKGFyZ0NvdW50KSB7CiAgICAgICAgICAgIHZhciBhcmdzTGlzdCA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50OyArK2kpIHsKICAgICAgICAgICAgICBhcmdzTGlzdCArPSAoaSAhPT0gMCA/ICIsICIgOiAiIikgKyAiYXJnIiArIGk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZ1bmN0aW9uQm9keSA9ICJyZXR1cm4gZnVuY3Rpb24gZW12YWxfYWxsb2NhdG9yXyIgKyBhcmdDb3VudCArICIoY29uc3RydWN0b3IsIGFyZ1R5cGVzLCBhcmdzKSB7XG4iOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50OyArK2kpIHsKICAgICAgICAgICAgICBmdW5jdGlvbkJvZHkgKz0gInZhciBhcmdUeXBlIiArIGkgKyAiID0gcmVxdWlyZVJlZ2lzdGVyZWRUeXBlKE1vZHVsZVsnSEVBUDMyJ11bKGFyZ1R5cGVzID4+PiAyKSArICIgKyBpICsgJ10sICJwYXJhbWV0ZXIgJyArIGkgKyAnIik7XG52YXIgYXJnJyArIGkgKyAiID0gYXJnVHlwZSIgKyBpICsgIi5yZWFkVmFsdWVGcm9tUG9pbnRlcihhcmdzKTtcbmFyZ3MgKz0gYXJnVHlwZSIgKyBpICsgIlsnYXJnUGFja0FkdmFuY2UnXTtcbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICJ2YXIgb2JqID0gbmV3IGNvbnN0cnVjdG9yKCIgKyBhcmdzTGlzdCArICIpO1xucmV0dXJuIF9fZW12YWxfcmVnaXN0ZXIob2JqKTtcbn1cbiI7CiAgICAgICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oInJlcXVpcmVSZWdpc3RlcmVkVHlwZSIsICJNb2R1bGUiLCAiX19lbXZhbF9yZWdpc3RlciIsIGZ1bmN0aW9uQm9keSkocmVxdWlyZVJlZ2lzdGVyZWRUeXBlLCBNb2R1bGUsIF9fZW12YWxfcmVnaXN0ZXIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVtdmFsX25ld2VycyA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9uZXcoaGFuZGxlLCBhcmdDb3VudCwgYXJnVHlwZXMsIGFyZ3MpIHsKICAgICAgICAgICAgaGFuZGxlID0gcmVxdWlyZUhhbmRsZShoYW5kbGUpOwogICAgICAgICAgICB2YXIgbmV3ZXIgPSBlbXZhbF9uZXdlcnNbYXJnQ291bnRdOwogICAgICAgICAgICBpZiAoIW5ld2VyKSB7CiAgICAgICAgICAgICAgbmV3ZXIgPSBjcmFmdEVtdmFsQWxsb2NhdG9yKGFyZ0NvdW50KTsKICAgICAgICAgICAgICBlbXZhbF9uZXdlcnNbYXJnQ291bnRdID0gbmV3ZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ld2VyKGhhbmRsZSwgYXJnVHlwZXMsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9uZXdfY3N0cmluZyh2MykgewogICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3RlcihnZXRTdHJpbmdPclN5bWJvbCh2MykpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9ydW5fZGVzdHJ1Y3RvcnMoaGFuZGxlKSB7CiAgICAgICAgICAgIHZhciBkZXN0cnVjdG9ycyA9IGVtdmFsX2hhbmRsZV9hcnJheVtoYW5kbGVdLnZhbHVlOwogICAgICAgICAgICBydW5EZXN0cnVjdG9ycyhkZXN0cnVjdG9ycyk7CiAgICAgICAgICAgIF9fZW12YWxfZGVjcmVmKGhhbmRsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfYWJvcnQoKSB7CiAgICAgICAgICAgIGFib3J0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfZW1zY3JpcHRlbl9tZW1jcHlfYmlnKGRlc3QsIHNyYywgbnVtKSB7CiAgICAgICAgICAgIEhFQVBVOC5jb3B5V2l0aGluKGRlc3QsIHNyYywgc3JjICsgbnVtKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVtc2NyaXB0ZW5fcmVhbGxvY19idWZmZXIoc2l6ZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHdhc21NZW1vcnkuZ3JvdyhzaXplIC0gYnVmZmVyLmJ5dGVMZW5ndGggKyA2NTUzNSA+Pj4gMTYpOwogICAgICAgICAgICAgIHVwZGF0ZUdsb2JhbEJ1ZmZlckFuZFZpZXdzKHdhc21NZW1vcnkuYnVmZmVyKTsKICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfZW1zY3JpcHRlbl9yZXNpemVfaGVhcChyZXF1ZXN0ZWRTaXplKSB7CiAgICAgICAgICAgIHZhciBvbGRTaXplID0gSEVBUFU4Lmxlbmd0aDsKICAgICAgICAgICAgcmVxdWVzdGVkU2l6ZSA9IHJlcXVlc3RlZFNpemUgPj4+IDA7CiAgICAgICAgICAgIHZhciBtYXhIZWFwU2l6ZSA9IDIxNDc0ODM2NDg7CiAgICAgICAgICAgIGlmIChyZXF1ZXN0ZWRTaXplID4gbWF4SGVhcFNpemUpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgY3V0RG93biA9IDE7IGN1dERvd24gPD0gNDsgY3V0RG93biAqPSAyKSB7CiAgICAgICAgICAgICAgdmFyIG92ZXJHcm93bkhlYXBTaXplID0gb2xkU2l6ZSAqICgxICsgMC4yIC8gY3V0RG93bik7CiAgICAgICAgICAgICAgb3Zlckdyb3duSGVhcFNpemUgPSBNYXRoLm1pbihvdmVyR3Jvd25IZWFwU2l6ZSwgcmVxdWVzdGVkU2l6ZSArIDEwMDY2MzI5Nik7CiAgICAgICAgICAgICAgdmFyIG5ld1NpemUgPSBNYXRoLm1pbihtYXhIZWFwU2l6ZSwgYWxpZ25VcChNYXRoLm1heChyZXF1ZXN0ZWRTaXplLCBvdmVyR3Jvd25IZWFwU2l6ZSksIDY1NTM2KSk7CiAgICAgICAgICAgICAgdmFyIHJlcGxhY2VtZW50ID0gZW1zY3JpcHRlbl9yZWFsbG9jX2J1ZmZlcihuZXdTaXplKTsKICAgICAgICAgICAgICBpZiAocmVwbGFjZW1lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU1lTQ0FMTFMgPSB7IG1hcHBpbmdzOiB7fSwgYnVmZmVyczogW251bGwsIFtdLCBbXV0sIHByaW50Q2hhcjogZnVuY3Rpb24oc3RyZWFtLCBjdXJyKSB7CiAgICAgICAgICAgIHZhciBidWZmZXIyID0gU1lTQ0FMTFMuYnVmZmVyc1tzdHJlYW1dOwogICAgICAgICAgICBpZiAoY3VyciA9PT0gMCB8fCBjdXJyID09PSAxMCkgewogICAgICAgICAgICAgIChzdHJlYW0gPT09IDEgPyBvdXQgOiBlcnIpKFVURjhBcnJheVRvU3RyaW5nKGJ1ZmZlcjIsIDApKTsKICAgICAgICAgICAgICBidWZmZXIyLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYnVmZmVyMi5wdXNoKGN1cnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCB2YXJhcmdzOiB2b2lkIDAsIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIFNZU0NBTExTLnZhcmFyZ3MgKz0gNDsKICAgICAgICAgICAgdmFyIHJldCA9IEhFQVAzMltTWVNDQUxMUy52YXJhcmdzIC0gNCA+PiAyXTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0sIGdldFN0cjogZnVuY3Rpb24ocHRyKSB7CiAgICAgICAgICAgIHZhciByZXQgPSBVVEY4VG9TdHJpbmcocHRyKTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0sIGdldDY0OiBmdW5jdGlvbihsb3csIGhpZ2gpIHsKICAgICAgICAgICAgcmV0dXJuIGxvdzsKICAgICAgICAgIH0gfTsKICAgICAgICAgIGZ1bmN0aW9uIF9mZF9jbG9zZShmZCkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9mZF9zZWVrKGZkLCBvZmZzZXRfbG93LCBvZmZzZXRfaGlnaCwgd2hlbmNlLCBuZXdPZmZzZXQpIHsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9mZF93cml0ZShmZCwgaW92LCBpb3ZjbnQsIHBudW0pIHsKICAgICAgICAgICAgdmFyIG51bSA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW92Y250OyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gSEVBUDMyW2lvdiArIGkgKiA4ID4+IDJdOwogICAgICAgICAgICAgIHZhciBsZW4gPSBIRUFQMzJbaW92ICsgKGkgKiA4ICsgNCkgPj4gMl07CiAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBsZW47IGorKykgewogICAgICAgICAgICAgICAgU1lTQ0FMTFMucHJpbnRDaGFyKGZkLCBIRUFQVThbcHRyICsgal0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBudW0gKz0gbGVuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEhFQVAzMltwbnVtID4+IDJdID0gbnVtOwogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9zZXRUZW1wUmV0MCgkaSkgewogICAgICAgICAgICBzZXRUZW1wUmV0MCgkaSB8IDApOwogICAgICAgICAgfQogICAgICAgICAgSW50ZXJuYWxFcnJvciA9IE1vZHVsZVsiSW50ZXJuYWxFcnJvciJdID0gZXh0ZW5kRXJyb3IoRXJyb3IsICJJbnRlcm5hbEVycm9yIik7CiAgICAgICAgICBlbWJpbmRfaW5pdF9jaGFyQ29kZXMoKTsKICAgICAgICAgIEJpbmRpbmdFcnJvciA9IE1vZHVsZVsiQmluZGluZ0Vycm9yIl0gPSBleHRlbmRFcnJvcihFcnJvciwgIkJpbmRpbmdFcnJvciIpOwogICAgICAgICAgaW5pdF9DbGFzc0hhbmRsZSgpOwogICAgICAgICAgaW5pdF9SZWdpc3RlcmVkUG9pbnRlcigpOwogICAgICAgICAgaW5pdF9lbWJpbmQoKTsKICAgICAgICAgIFVuYm91bmRUeXBlRXJyb3IgPSBNb2R1bGVbIlVuYm91bmRUeXBlRXJyb3IiXSA9IGV4dGVuZEVycm9yKEVycm9yLCAiVW5ib3VuZFR5cGVFcnJvciIpOwogICAgICAgICAgaW5pdF9lbXZhbCgpOwogICAgICAgICAgdmFyIGFzbUxpYnJhcnlBcmcgPSB7ICJ0IjogX19lbWJpbmRfZmluYWxpemVfdmFsdWVfb2JqZWN0LCAiSSI6IF9fZW1iaW5kX3JlZ2lzdGVyX2Jvb2wsICJ4IjogX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3MsICJ3IjogX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3NfY29uc3RydWN0b3IsICJkIjogX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3NfZnVuY3Rpb24sICJrIjogX19lbWJpbmRfcmVnaXN0ZXJfY29uc3RhbnQsICJIIjogX19lbWJpbmRfcmVnaXN0ZXJfZW12YWwsICJuIjogX19lbWJpbmRfcmVnaXN0ZXJfZW51bSwgImEiOiBfX2VtYmluZF9yZWdpc3Rlcl9lbnVtX3ZhbHVlLCAiQSI6IF9fZW1iaW5kX3JlZ2lzdGVyX2Zsb2F0LCAiaSI6IF9fZW1iaW5kX3JlZ2lzdGVyX2Z1bmN0aW9uLCAiaiI6IF9fZW1iaW5kX3JlZ2lzdGVyX2ludGVnZXIsICJoIjogX19lbWJpbmRfcmVnaXN0ZXJfbWVtb3J5X3ZpZXcsICJCIjogX19lbWJpbmRfcmVnaXN0ZXJfc3RkX3N0cmluZywgInYiOiBfX2VtYmluZF9yZWdpc3Rlcl9zdGRfd3N0cmluZywgInUiOiBfX2VtYmluZF9yZWdpc3Rlcl92YWx1ZV9vYmplY3QsICJjIjogX19lbWJpbmRfcmVnaXN0ZXJfdmFsdWVfb2JqZWN0X2ZpZWxkLCAiSiI6IF9fZW1iaW5kX3JlZ2lzdGVyX3ZvaWQsICJtIjogX19lbXZhbF9hcywgInMiOiBfX2VtdmFsX2NhbGxfdm9pZF9tZXRob2QsICJiIjogX19lbXZhbF9kZWNyZWYsICJ5IjogX19lbXZhbF9nZXRfZ2xvYmFsLCAicCI6IF9fZW12YWxfZ2V0X21ldGhvZF9jYWxsZXIsICJyIjogX19lbXZhbF9nZXRfbW9kdWxlX3Byb3BlcnR5LCAiZSI6IF9fZW12YWxfZ2V0X3Byb3BlcnR5LCAiZyI6IF9fZW12YWxfaW5jcmVmLCAicSI6IF9fZW12YWxfbmV3LCAiZiI6IF9fZW12YWxfbmV3X2NzdHJpbmcsICJsIjogX19lbXZhbF9ydW5fZGVzdHJ1Y3RvcnMsICJvIjogX2Fib3J0LCAiRSI6IF9lbXNjcmlwdGVuX21lbWNweV9iaWcsICJGIjogX2Vtc2NyaXB0ZW5fcmVzaXplX2hlYXAsICJHIjogX2ZkX2Nsb3NlLCAiQyI6IF9mZF9zZWVrLCAieiI6IF9mZF93cml0ZSwgIkQiOiBfc2V0VGVtcFJldDAgfTsKICAgICAgICAgIHZhciBhc20gPSBjcmVhdGVXYXNtKCk7CiAgICAgICAgICB2YXIgX19fd2FzbV9jYWxsX2N0b3JzID0gTW9kdWxlWyJfX193YXNtX2NhbGxfY3RvcnMiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKF9fX3dhc21fY2FsbF9jdG9ycyA9IE1vZHVsZVsiX19fd2FzbV9jYWxsX2N0b3JzIl0gPSBNb2R1bGVbImFzbSJdWyJMIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9tYWxsb2MgPSBNb2R1bGVbIl9tYWxsb2MiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKF9tYWxsb2MgPSBNb2R1bGVbIl9tYWxsb2MiXSA9IE1vZHVsZVsiYXNtIl1bIk0iXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2ZyZWUgPSBNb2R1bGVbIl9mcmVlIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChfZnJlZSA9IE1vZHVsZVsiX2ZyZWUiXSA9IE1vZHVsZVsiYXNtIl1bIk4iXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX19fZ2V0VHlwZU5hbWUgPSBNb2R1bGVbIl9fX2dldFR5cGVOYW1lIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChfX19nZXRUeXBlTmFtZSA9IE1vZHVsZVsiX19fZ2V0VHlwZU5hbWUiXSA9IE1vZHVsZVsiYXNtIl1bIlAiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX19fZW1iaW5kX3JlZ2lzdGVyX25hdGl2ZV9hbmRfYnVpbHRpbl90eXBlcyA9IE1vZHVsZVsiX19fZW1iaW5kX3JlZ2lzdGVyX25hdGl2ZV9hbmRfYnVpbHRpbl90eXBlcyJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoX19fZW1iaW5kX3JlZ2lzdGVyX25hdGl2ZV9hbmRfYnVpbHRpbl90eXBlcyA9IE1vZHVsZVsiX19fZW1iaW5kX3JlZ2lzdGVyX25hdGl2ZV9hbmRfYnVpbHRpbl90eXBlcyJdID0gTW9kdWxlWyJhc20iXVsiUSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBkeW5DYWxsX2ppamkgPSBNb2R1bGVbImR5bkNhbGxfamlqaSJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZHluQ2FsbF9qaWppID0gTW9kdWxlWyJkeW5DYWxsX2ppamkiXSA9IE1vZHVsZVsiYXNtIl1bIlIiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY2FsbGVkUnVuOwogICAgICAgICAgZnVuY3Rpb24gRXhpdFN0YXR1cyhzdGF0dXMpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gIkV4aXRTdGF0dXMiOwogICAgICAgICAgICB0aGlzLm1lc3NhZ2UgPSAiUHJvZ3JhbSB0ZXJtaW5hdGVkIHdpdGggZXhpdCgiICsgc3RhdHVzICsgIikiOwogICAgICAgICAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgIH0KICAgICAgICAgIGRlcGVuZGVuY2llc0Z1bGZpbGxlZCA9IGZ1bmN0aW9uIHJ1bkNhbGxlcigpIHsKICAgICAgICAgICAgaWYgKCFjYWxsZWRSdW4pIHJ1bigpOwogICAgICAgICAgICBpZiAoIWNhbGxlZFJ1bikgZGVwZW5kZW5jaWVzRnVsZmlsbGVkID0gcnVuQ2FsbGVyOwogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIHJ1bihhcmdzKSB7CiAgICAgICAgICAgIGFyZ3MgPSBhcmdzIHx8IGFyZ3VtZW50c187CiAgICAgICAgICAgIGlmIChydW5EZXBlbmRlbmNpZXMgPiAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByZVJ1bigpOwogICAgICAgICAgICBpZiAocnVuRGVwZW5kZW5jaWVzID4gMCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBkb1J1bigpIHsKICAgICAgICAgICAgICBpZiAoY2FsbGVkUnVuKSByZXR1cm47CiAgICAgICAgICAgICAgY2FsbGVkUnVuID0gdHJ1ZTsKICAgICAgICAgICAgICBNb2R1bGVbImNhbGxlZFJ1biJdID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAoQUJPUlQpIHJldHVybjsKICAgICAgICAgICAgICBpbml0UnVudGltZSgpOwogICAgICAgICAgICAgIHByZU1haW4oKTsKICAgICAgICAgICAgICByZWFkeVByb21pc2VSZXNvbHZlKE1vZHVsZSk7CiAgICAgICAgICAgICAgaWYgKE1vZHVsZVsib25SdW50aW1lSW5pdGlhbGl6ZWQiXSkgTW9kdWxlWyJvblJ1bnRpbWVJbml0aWFsaXplZCJdKCk7CiAgICAgICAgICAgICAgcG9zdFJ1bigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChNb2R1bGVbInNldFN0YXR1cyJdKSB7CiAgICAgICAgICAgICAgTW9kdWxlWyJzZXRTdGF0dXMiXSgiUnVubmluZy4uLiIpOwogICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBNb2R1bGVbInNldFN0YXR1cyJdKCIiKTsKICAgICAgICAgICAgICAgIH0sIDEpOwogICAgICAgICAgICAgICAgZG9SdW4oKTsKICAgICAgICAgICAgICB9LCAxKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkb1J1bigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBNb2R1bGVbInJ1biJdID0gcnVuOwogICAgICAgICAgaWYgKE1vZHVsZVsicHJlSW5pdCJdKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgTW9kdWxlWyJwcmVJbml0Il0gPT0gImZ1bmN0aW9uIikgTW9kdWxlWyJwcmVJbml0Il0gPSBbTW9kdWxlWyJwcmVJbml0Il1dOwogICAgICAgICAgICB3aGlsZSAoTW9kdWxlWyJwcmVJbml0Il0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIE1vZHVsZVsicHJlSW5pdCJdLnBvcCgpKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJ1bigpOwogICAgICAgICAgcmV0dXJuIEJBU0lTMi5yZWFkeTsKICAgICAgICB9OwogICAgICB9KCk7CiAgICAgIGlmICh0eXBlb2YgZXhwb3J0czIgPT09ICJvYmplY3QiICYmIHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiKQogICAgICAgIG1vZHVsZS5leHBvcnRzID0gQkFTSVM7CiAgICAgIGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lWyJhbWQiXSkKICAgICAgICBkZWZpbmUoW10sIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIEJBU0lTOwogICAgICAgIH0pOwogICAgICBlbHNlIGlmICh0eXBlb2YgZXhwb3J0czIgPT09ICJvYmplY3QiKQogICAgICAgIGV4cG9ydHMyWyJCQVNJUyJdID0gQkFTSVM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy90cmFuc2NvZGVLVFgyLmpzCiAgdmFyIHRyYW5zY29kZUtUWDJfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KHRyYW5zY29kZUtUWDJfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gdHJhbnNjb2RlS1RYMl9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gdHJhbnNjb2RlKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNjb2Rlck1vZHVsZSIsIHRyYW5zY29kZXJNb2R1bGUpOwogICAgY29uc3QgZGF0YSA9IHBhcmFtZXRlcnMua3R4MkJ1ZmZlcjsKICAgIGNvbnN0IHN1cHBvcnRlZFRhcmdldEZvcm1hdHMgPSBwYXJhbWV0ZXJzLnN1cHBvcnRlZFRhcmdldEZvcm1hdHM7CiAgICBsZXQgaGVhZGVyOwogICAgdHJ5IHsKICAgICAgaGVhZGVyID0gcmVhZDIoZGF0YSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBLVFgyIGZpbGUuIik7CiAgICB9CiAgICBpZiAoaGVhZGVyLmxheWVyQ291bnQgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJLVFgyIHRleHR1cmUgYXJyYXlzIGFyZSBub3Qgc3VwcG9ydGVkLiIpOwogICAgfQogICAgaWYgKGhlYWRlci5waXhlbERlcHRoICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiS1RYMiAzRCB0ZXh0dXJlcyBhcmUgdW5zdXBwb3J0ZWQuIik7CiAgICB9CiAgICBjb25zdCBkZmQgPSBoZWFkZXIuZGF0YUZvcm1hdERlc2NyaXB0b3JbMF07CiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkoaGVhZGVyLmxldmVsQ291bnQpOwogICAgaWYgKGhlYWRlci52a0Zvcm1hdCA9PT0gMCAmJiAoZGZkLmNvbG9yTW9kZWwgPT09IGNvbG9yTW9kZWxFVEMxUyB8fCBkZmQuY29sb3JNb2RlbCA9PT0gY29sb3JNb2RlbFVBU1RDKSkgewogICAgICB0cmFuc2NvZGVDb21wcmVzc2VkKAogICAgICAgIGRhdGEsCiAgICAgICAgaGVhZGVyLAogICAgICAgIHN1cHBvcnRlZFRhcmdldEZvcm1hdHMsCiAgICAgICAgdHJhbnNjb2Rlck1vZHVsZSwKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLAogICAgICAgIHJlc3VsdAogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGRhdGEuYnVmZmVyKTsKICAgICAgcGFyc2VVbmNvbXByZXNzZWQoaGVhZGVyLCByZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gcGFyc2VVbmNvbXByZXNzZWQoaGVhZGVyLCByZXN1bHQpIHsKICAgIGNvbnN0IGludGVybmFsRm9ybWF0ID0gaGVhZGVyLnZrRm9ybWF0ID09PSBWdWxrYW5Db25zdGFudHNfZGVmYXVsdC5WS19GT1JNQVRfUjhHOEI4X1NSR0IgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQiA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQTsKICAgIGxldCBkYXRhdHlwZTsKICAgIGlmIChoZWFkZXIudmtGb3JtYXQgPT09IFZ1bGthbkNvbnN0YW50c19kZWZhdWx0LlZLX0ZPUk1BVF9SOEc4QjhBOF9VTk9STSkgewogICAgICBkYXRhdHlwZSA9IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFOwogICAgfSBlbHNlIGlmIChoZWFkZXIudmtGb3JtYXQgPT09IFZ1bGthbkNvbnN0YW50c19kZWZhdWx0LlZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfU0ZMT0FUKSB7CiAgICAgIGRhdGF0eXBlID0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LkhBTEZfRkxPQVQ7CiAgICB9IGVsc2UgaWYgKGhlYWRlci52a0Zvcm1hdCA9PT0gVnVsa2FuQ29uc3RhbnRzX2RlZmF1bHQuVktfRk9STUFUX1IzMkczMkIzMkEzMl9TRkxPQVQpIHsKICAgICAgZGF0YXR5cGUgPSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuRkxPQVQ7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhlYWRlci5sZXZlbHMubGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgbGV2ZWwgPSB7fTsKICAgICAgcmVzdWx0W2ldID0gbGV2ZWw7CiAgICAgIGNvbnN0IGxldmVsQnVmZmVyID0gaGVhZGVyLmxldmVsc1tpXS5sZXZlbERhdGE7CiAgICAgIGNvbnN0IHdpZHRoID0gaGVhZGVyLnBpeGVsV2lkdGggPj4gaTsKICAgICAgY29uc3QgaGVpZ2h0ID0gaGVhZGVyLnBpeGVsSGVpZ2h0ID4+IGk7CiAgICAgIGNvbnN0IGZhY2VMZW5ndGggPSB3aWR0aCAqIGhlaWdodCAqIFBpeGVsRm9ybWF0X2RlZmF1bHQuY29tcG9uZW50c0xlbmd0aChpbnRlcm5hbEZvcm1hdCk7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgaGVhZGVyLmZhY2VDb3VudDsgKytqKSB7CiAgICAgICAgY29uc3QgZmFjZUJ5dGVPZmZzZXQgPSBsZXZlbEJ1ZmZlci5ieXRlT2Zmc2V0ICsgZmFjZUxlbmd0aCAqIGhlYWRlci50eXBlU2l6ZSAqIGo7CiAgICAgICAgbGV0IGZhY2VWaWV3OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRhdGF0eXBlKSB8fCBQaXhlbERhdGF0eXBlX2RlZmF1bHQuc2l6ZUluQnl0ZXMoZGF0YXR5cGUpID09PSAxKSB7CiAgICAgICAgICBmYWNlVmlldyA9IG5ldyBVaW50OEFycmF5KAogICAgICAgICAgICBsZXZlbEJ1ZmZlci5idWZmZXIsCiAgICAgICAgICAgIGZhY2VCeXRlT2Zmc2V0LAogICAgICAgICAgICBmYWNlTGVuZ3RoCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAoUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LnNpemVJbkJ5dGVzKGRhdGF0eXBlKSA9PT0gMikgewogICAgICAgICAgZmFjZVZpZXcgPSBuZXcgVWludDE2QXJyYXkoCiAgICAgICAgICAgIGxldmVsQnVmZmVyLmJ1ZmZlciwKICAgICAgICAgICAgZmFjZUJ5dGVPZmZzZXQsCiAgICAgICAgICAgIGZhY2VMZW5ndGgKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZhY2VWaWV3ID0gbmV3IEZsb2F0MzJBcnJheSgKICAgICAgICAgICAgbGV2ZWxCdWZmZXIuYnVmZmVyLAogICAgICAgICAgICBmYWNlQnl0ZU9mZnNldCwKICAgICAgICAgICAgZmFjZUxlbmd0aAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGV2ZWxbZmFjZU9yZGVyW2pdXSA9IHsKICAgICAgICAgIGludGVybmFsRm9ybWF0LAogICAgICAgICAgZGF0YXR5cGUsCiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGxldmVsQnVmZmVyOiBmYWNlVmlldwogICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gdHJhbnNjb2RlQ29tcHJlc3NlZChkYXRhLCBoZWFkZXIsIHN1cHBvcnRlZFRhcmdldEZvcm1hdHMsIHRyYW5zY29kZXJNb2R1bGUyLCB0cmFuc2ZlcmFibGVPYmplY3RzLCByZXN1bHQpIHsKICAgIGNvbnN0IGt0eDJGaWxlID0gbmV3IHRyYW5zY29kZXJNb2R1bGUyLktUWDJGaWxlKGRhdGEpOwogICAgbGV0IHdpZHRoID0ga3R4MkZpbGUuZ2V0V2lkdGgoKTsKICAgIGxldCBoZWlnaHQgPSBrdHgyRmlsZS5nZXRIZWlnaHQoKTsKICAgIGNvbnN0IGxldmVscyA9IGt0eDJGaWxlLmdldExldmVscygpOwogICAgY29uc3QgaGFzQWxwaGEgPSBrdHgyRmlsZS5nZXRIYXNBbHBoYSgpOwogICAgaWYgKCEod2lkdGggPiAwKSB8fCAhKGhlaWdodCA+IDApIHx8ICEobGV2ZWxzID4gMCkpIHsKICAgICAga3R4MkZpbGUuY2xvc2UoKTsKICAgICAga3R4MkZpbGUuZGVsZXRlKCk7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBLVFgyIGZpbGUiKTsKICAgIH0KICAgIGxldCBpbnRlcm5hbEZvcm1hdCwgdHJhbnNjb2RlckZvcm1hdDsKICAgIGNvbnN0IGRmZCA9IGhlYWRlci5kYXRhRm9ybWF0RGVzY3JpcHRvclswXTsKICAgIGNvbnN0IEJhc2lzRm9ybWF0ID0gdHJhbnNjb2Rlck1vZHVsZTIudHJhbnNjb2Rlcl90ZXh0dXJlX2Zvcm1hdDsKICAgIGlmIChkZmQuY29sb3JNb2RlbCA9PT0gY29sb3JNb2RlbEVUQzFTKSB7CiAgICAgIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmV0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gaGFzQWxwaGEgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkE4X0VUQzJfRUFDIDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0I4X0VUQzI7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IGhhc0FscGhhID8gQmFzaXNGb3JtYXQuY1RGRVRDMl9SR0JBIDogQmFzaXNGb3JtYXQuY1RGRVRDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5ldGMxICYmICFoYXNBbHBoYSkgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfRVRDMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGRVRDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5zM3RjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBoYXNBbHBoYSA/IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9EWFQ1IDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfRFhUMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gaGFzQWxwaGEgPyBCYXNpc0Zvcm1hdC5jVEZCQzNfUkdCQSA6IEJhc2lzRm9ybWF0LmNURkJDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5wdnJ0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gaGFzQWxwaGEgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfUFZSVENfNEJQUFYxIDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfUFZSVENfNEJQUFYxOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBoYXNBbHBoYSA/IEJhc2lzRm9ybWF0LmNURlBWUlRDMV80X1JHQkEgOiBCYXNpc0Zvcm1hdC5jVEZQVlJUQzFfNF9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5hc3RjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfQVNUQzsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGQVNUQ180eDRfUkdCQTsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmJjNykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX0JDNzsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGQkM3X1JHQkE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIk5vIHRyYW5zY29kaW5nIGZvcm1hdCB0YXJnZXQgYXZhaWxhYmxlIGZvciBFVEMxUyBjb21wcmVzc2VkIGt0eDIuIgogICAgICAgICk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZGZkLmNvbG9yTW9kZWwgPT09IGNvbG9yTW9kZWxVQVNUQykgewogICAgICBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5hc3RjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfQVNUQzsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGQVNUQ180eDRfUkdCQTsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmJjNykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX0JDNzsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGQkM3X1JHQkE7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5zM3RjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBoYXNBbHBoYSA/IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9EWFQ1IDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfRFhUMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gaGFzQWxwaGEgPyBCYXNpc0Zvcm1hdC5jVEZCQzNfUkdCQSA6IEJhc2lzRm9ybWF0LmNURkJDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5ldGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IGhhc0FscGhhID8gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBOF9FVEMyX0VBQyA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCOF9FVEMyOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBoYXNBbHBoYSA/IEJhc2lzRm9ybWF0LmNURkVUQzJfUkdCQSA6IEJhc2lzRm9ybWF0LmNURkVUQzFfUkdCOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuZXRjMSAmJiAhaGFzQWxwaGEpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCX0VUQzE7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IEJhc2lzRm9ybWF0LmNURkVUQzFfUkdCOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMucHZydGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IGhhc0FscGhhID8gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX1BWUlRDXzRCUFBWMSA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCX1BWUlRDXzRCUFBWMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gaGFzQWxwaGEgPyBCYXNpc0Zvcm1hdC5jVEZQVlJUQzFfNF9SR0JBIDogQmFzaXNGb3JtYXQuY1RGUFZSVEMxXzRfUkdCOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJObyB0cmFuc2NvZGluZyBmb3JtYXQgdGFyZ2V0IGF2YWlsYWJsZSBmb3IgVUFTVEMgY29tcHJlc3NlZCBrdHgyLiIKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBpZiAoIWt0eDJGaWxlLnN0YXJ0VHJhbnNjb2RpbmcoKSkgewogICAgICBrdHgyRmlsZS5jbG9zZSgpOwogICAgICBrdHgyRmlsZS5kZWxldGUoKTsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJzdGFydFRyYW5zY29kaW5nKCkgZmFpbGVkIik7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhlYWRlci5sZXZlbHMubGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgbGV2ZWwgPSB7fTsKICAgICAgcmVzdWx0W2ldID0gbGV2ZWw7CiAgICAgIHdpZHRoID0gaGVhZGVyLnBpeGVsV2lkdGggPj4gaTsKICAgICAgaGVpZ2h0ID0gaGVhZGVyLnBpeGVsSGVpZ2h0ID4+IGk7CiAgICAgIGNvbnN0IGRzdFNpemUgPSBrdHgyRmlsZS5nZXRJbWFnZVRyYW5zY29kZWRTaXplSW5CeXRlcygKICAgICAgICBpLAogICAgICAgIC8vIGxldmVsIGluZGV4CiAgICAgICAgMCwKICAgICAgICAvLyBsYXllciBpbmRleAogICAgICAgIDAsCiAgICAgICAgLy8gZmFjZSBpbmRleAogICAgICAgIHRyYW5zY29kZXJGb3JtYXQudmFsdWUKICAgICAgKTsKICAgICAgY29uc3QgZHN0ID0gbmV3IFVpbnQ4QXJyYXkoZHN0U2l6ZSk7CiAgICAgIGNvbnN0IHRyYW5zY29kZWQgPSBrdHgyRmlsZS50cmFuc2NvZGVJbWFnZSgKICAgICAgICBkc3QsCiAgICAgICAgaSwKICAgICAgICAvLyBsZXZlbCBpbmRleAogICAgICAgIDAsCiAgICAgICAgLy8gbGF5ZXIgaW5kZXgKICAgICAgICAwLAogICAgICAgIC8vIGZhY2UgaW5kZXgKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0LnZhbHVlLAogICAgICAgIDAsCiAgICAgICAgLy8gZ2V0X2FscGhhX2Zvcl9vcGFxdWVfZm9ybWF0cwogICAgICAgIC0xLAogICAgICAgIC8vIGNoYW5uZWwwCiAgICAgICAgLTEKICAgICAgICAvLyBjaGFubmVsMQogICAgICApOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0cmFuc2NvZGVkKSkgewogICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgidHJhbnNjb2RlSW1hZ2UoKSBmYWlsZWQuIik7CiAgICAgIH0KICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGRzdC5idWZmZXIpOwogICAgICBsZXZlbFtmYWNlT3JkZXJbMF1dID0gewogICAgICAgIGludGVybmFsRm9ybWF0LAogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodCwKICAgICAgICBsZXZlbEJ1ZmZlcjogZHN0CiAgICAgIH07CiAgICB9CiAgICBrdHgyRmlsZS5jbG9zZSgpOwogICAga3R4MkZpbGUuZGVsZXRlKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBhc3luYyBmdW5jdGlvbiBpbml0V29ya2VyMyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCB3YXNtQ29uZmlnID0gcGFyYW1ldGVycy53ZWJBc3NlbWJseUNvbmZpZzsKICAgIGNvbnN0IGJhc2lzVHJhbnNjb2RlciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGltcG9ydF9iYXNpc190cmFuc2NvZGVyLmRlZmF1bHQsIHNlbGYuQkFTSVMpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnLndhc21CaW5hcnlGaWxlKSkgewogICAgICB0cmFuc2NvZGVyTW9kdWxlID0gYXdhaXQgYmFzaXNUcmFuc2NvZGVyKHdhc21Db25maWcpOwogICAgfSBlbHNlIHsKICAgICAgdHJhbnNjb2Rlck1vZHVsZSA9IGF3YWl0IGJhc2lzVHJhbnNjb2RlcigpOwogICAgfQogICAgdHJhbnNjb2Rlck1vZHVsZS5pbml0aWFsaXplQmFzaXMoKTsKICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiB0cmFuc2NvZGVLVFgyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHdhc21Db25maWcgPSBwYXJhbWV0ZXJzLndlYkFzc2VtYmx5Q29uZmlnOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnKSkgewogICAgICByZXR1cm4gaW5pdFdvcmtlcjMocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgICB9CiAgICByZXR1cm4gdHJhbnNjb2RlKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogIH0KICB2YXIgaW1wb3J0X2Jhc2lzX3RyYW5zY29kZXIsIGZhY2VPcmRlciwgY29sb3JNb2RlbEVUQzFTLCBjb2xvck1vZGVsVUFTVEMsIHRyYW5zY29kZXJNb2R1bGUsIHRyYW5zY29kZUtUWDJfZGVmYXVsdDsKICB2YXIgaW5pdF90cmFuc2NvZGVLVFgyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy90cmFuc2NvZGVLVFgyLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9QaXhlbEZvcm1hdCgpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBpbml0X1Z1bGthbkNvbnN0YW50cygpOwogICAgICBpbml0X1BpeGVsRGF0YXR5cGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGluaXRfa3R4X3BhcnNlX21vZGVybigpOwogICAgICBpbXBvcnRfYmFzaXNfdHJhbnNjb2RlciA9IF9fdG9FU00ocmVxdWlyZV9iYXNpc190cmFuc2NvZGVyKCksIDEpOwogICAgICBmYWNlT3JkZXIgPSBbCiAgICAgICAgInBvc2l0aXZlWCIsCiAgICAgICAgIm5lZ2F0aXZlWCIsCiAgICAgICAgInBvc2l0aXZlWSIsCiAgICAgICAgIm5lZ2F0aXZlWSIsCiAgICAgICAgInBvc2l0aXZlWiIsCiAgICAgICAgIm5lZ2F0aXZlWiIKICAgICAgXTsKICAgICAgY29sb3JNb2RlbEVUQzFTID0gMTYzOwogICAgICBjb2xvck1vZGVsVUFTVEMgPSAxNjY7CiAgICAgIHRyYW5zY29kZUtUWDJfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdCh0cmFuc2NvZGVLVFgyKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL3RyYW5zZmVyVHlwZWRBcnJheVRlc3QuanMKICB2YXIgdHJhbnNmZXJUeXBlZEFycmF5VGVzdF9leHBvcnRzID0ge307CiAgdmFyIGluaXRfdHJhbnNmZXJUeXBlZEFycmF5VGVzdCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvdHJhbnNmZXJUeXBlZEFycmF5VGVzdC5qcyIoKSB7CiAgICAgIHNlbGYub25tZXNzYWdlID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBjb25zdCBhcnJheSA9IGV2ZW50LmRhdGEuYXJyYXk7CiAgICAgICAgY29uc3QgcG9zdE1lc3NhZ2UyID0gc2VsZi53ZWJraXRQb3N0TWVzc2FnZSB8fCBzZWxmLnBvc3RNZXNzYWdlOwogICAgICAgIHRyeSB7CiAgICAgICAgICBwb3N0TWVzc2FnZTIoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBhcnJheQogICAgICAgICAgICB9LAogICAgICAgICAgICBbYXJyYXkuYnVmZmVyXQogICAgICAgICAgKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBwb3N0TWVzc2FnZTIoe30pOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ludGVyc2VjdGlvbnMyRC5qcwogIHZhciBJbnRlcnNlY3Rpb25zMkQsIEludGVyc2VjdGlvbnMyRF9kZWZhdWx0OwogIHZhciBpbml0X0ludGVyc2VjdGlvbnMyRCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW50ZXJzZWN0aW9uczJELmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIEludGVyc2VjdGlvbnMyRCA9IHt9OwogICAgICBJbnRlcnNlY3Rpb25zMkQuY2xpcFRyaWFuZ2xlQXRBeGlzQWxpZ25lZFRocmVzaG9sZCA9IGZ1bmN0aW9uKHRocmVzaG9sZCwga2VlcEFib3ZlLCB1MCwgdTEyLCB1MjIsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRocmVzaG9sZCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ0aHJlc2hvbGQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGtlZXBBYm92ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJrZWVwQWJvdmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHUwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInUwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1MTIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidTEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHUyMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ1MiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgdTBCZWhpbmQ7CiAgICAgICAgbGV0IHUxQmVoaW5kOwogICAgICAgIGxldCB1MkJlaGluZDsKICAgICAgICBpZiAoa2VlcEFib3ZlKSB7CiAgICAgICAgICB1MEJlaGluZCA9IHUwIDwgdGhyZXNob2xkOwogICAgICAgICAgdTFCZWhpbmQgPSB1MTIgPCB0aHJlc2hvbGQ7CiAgICAgICAgICB1MkJlaGluZCA9IHUyMiA8IHRocmVzaG9sZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdTBCZWhpbmQgPSB1MCA+IHRocmVzaG9sZDsKICAgICAgICAgIHUxQmVoaW5kID0gdTEyID4gdGhyZXNob2xkOwogICAgICAgICAgdTJCZWhpbmQgPSB1MjIgPiB0aHJlc2hvbGQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bUJlaGluZCA9IHUwQmVoaW5kICsgdTFCZWhpbmQgKyB1MkJlaGluZDsKICAgICAgICBsZXQgdTAxUmF0aW87CiAgICAgICAgbGV0IHUwMlJhdGlvOwogICAgICAgIGxldCB1MTJSYXRpbzsKICAgICAgICBsZXQgdTEwUmF0aW87CiAgICAgICAgbGV0IHUyMFJhdGlvOwogICAgICAgIGxldCB1MjFSYXRpbzsKICAgICAgICBpZiAobnVtQmVoaW5kID09PSAxKSB7CiAgICAgICAgICBpZiAodTBCZWhpbmQpIHsKICAgICAgICAgICAgdTAxUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUxMiAtIHUwKTsKICAgICAgICAgICAgdTAyUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUyMiAtIHUwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICBpZiAodTAyUmF0aW8gIT09IDEpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2godTAyUmF0aW8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh1MDFSYXRpbyAhPT0gMSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCh1MDFSYXRpbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodTFCZWhpbmQpIHsKICAgICAgICAgICAgdTEyUmF0aW8gPSAodGhyZXNob2xkIC0gdTEyKSAvICh1MjIgLSB1MTIpOwogICAgICAgICAgICB1MTBSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MTIpIC8gKHUwIC0gdTEyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICBpZiAodTEwUmF0aW8gIT09IDEpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2godTEwUmF0aW8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh1MTJSYXRpbyAhPT0gMSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCh1MTJSYXRpbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodTJCZWhpbmQpIHsKICAgICAgICAgICAgdTIwUmF0aW8gPSAodGhyZXNob2xkIC0gdTIyKSAvICh1MCAtIHUyMik7CiAgICAgICAgICAgIHUyMVJhdGlvID0gKHRocmVzaG9sZCAtIHUyMikgLyAodTEyIC0gdTIyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICBpZiAodTIxUmF0aW8gIT09IDEpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2godTIxUmF0aW8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh1MjBSYXRpbyAhPT0gMSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCh1MjBSYXRpbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG51bUJlaGluZCA9PT0gMikgewogICAgICAgICAgaWYgKCF1MEJlaGluZCAmJiB1MCAhPT0gdGhyZXNob2xkKSB7CiAgICAgICAgICAgIHUxMFJhdGlvID0gKHRocmVzaG9sZCAtIHUxMikgLyAodTAgLSB1MTIpOwogICAgICAgICAgICB1MjBSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MjIpIC8gKHUwIC0gdTIyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICByZXN1bHQucHVzaCh1MTBSYXRpbyk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICByZXN1bHQucHVzaCh1MjBSYXRpbyk7CiAgICAgICAgICB9IGVsc2UgaWYgKCF1MUJlaGluZCAmJiB1MTIgIT09IHRocmVzaG9sZCkgewogICAgICAgICAgICB1MjFSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MjIpIC8gKHUxMiAtIHUyMik7CiAgICAgICAgICAgIHUwMVJhdGlvID0gKHRocmVzaG9sZCAtIHUwKSAvICh1MTIgLSB1MCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2godTIxUmF0aW8pOwogICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2godTAxUmF0aW8pOwogICAgICAgICAgfSBlbHNlIGlmICghdTJCZWhpbmQgJiYgdTIyICE9PSB0aHJlc2hvbGQpIHsKICAgICAgICAgICAgdTAyUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUyMiAtIHUwKTsKICAgICAgICAgICAgdTEyUmF0aW8gPSAodGhyZXNob2xkIC0gdTEyKSAvICh1MjIgLSB1MTIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUwMlJhdGlvKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUxMlJhdGlvKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG51bUJlaGluZCAhPT0gMykgewogICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBJbnRlcnNlY3Rpb25zMkQuY29tcHV0ZUJhcnljZW50cmljQ29vcmRpbmF0ZXMgPSBmdW5jdGlvbih4LCB5LCB4MSwgeTEsIHgyLCB5MiwgeDMsIHkzLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh4KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeDEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieDEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHkxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInkxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh4MikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ4MiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeTIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieTIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHgzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIngzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh5MykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ5MyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgeDFteDMgPSB4MSAtIHgzOwogICAgICAgIGNvbnN0IHgzbXgyID0geDMgLSB4MjsKICAgICAgICBjb25zdCB5Mm15MyA9IHkyIC0geTM7CiAgICAgICAgY29uc3QgeTFteTMgPSB5MSAtIHkzOwogICAgICAgIGNvbnN0IGludmVyc2VEZXRlcm1pbmFudCA9IDEgLyAoeTJteTMgKiB4MW14MyArIHgzbXgyICogeTFteTMpOwogICAgICAgIGNvbnN0IHlteTMgPSB5IC0geTM7CiAgICAgICAgY29uc3QgeG14MyA9IHggLSB4MzsKICAgICAgICBjb25zdCBsMSA9ICh5Mm15MyAqIHhteDMgKyB4M214MiAqIHlteTMpICogaW52ZXJzZURldGVybWluYW50OwogICAgICAgIGNvbnN0IGwyID0gKC15MW15MyAqIHhteDMgKyB4MW14MyAqIHlteTMpICogaW52ZXJzZURldGVybWluYW50OwogICAgICAgIGNvbnN0IGwzID0gMSAtIGwxIC0gbDI7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQueCA9IGwxOwogICAgICAgICAgcmVzdWx0LnkgPSBsMjsKICAgICAgICAgIHJlc3VsdC56ID0gbDM7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjNfZGVmYXVsdChsMSwgbDIsIGwzKTsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uczJELmNvbXB1dGVMaW5lU2VnbWVudExpbmVTZWdtZW50SW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oeDAwLCB5MDAsIHgwMSwgeTAxLCB4MTAsIHkxMCwgeDExLCB5MTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieDAwIiwgeDAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInkwMCIsIHkwMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ4MDEiLCB4MDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieTAxIiwgeTAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIngxMCIsIHgxMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ5MTAiLCB5MTApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieDExIiwgeDExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInkxMSIsIHkxMSk7CiAgICAgICAgY29uc3QgbnVtZXJhdG9yMUEgPSAoeDExIC0geDEwKSAqICh5MDAgLSB5MTApIC0gKHkxMSAtIHkxMCkgKiAoeDAwIC0geDEwKTsKICAgICAgICBjb25zdCBudW1lcmF0b3IxQiA9ICh4MDEgLSB4MDApICogKHkwMCAtIHkxMCkgLSAoeTAxIC0geTAwKSAqICh4MDAgLSB4MTApOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9yMSA9ICh5MTEgLSB5MTApICogKHgwMSAtIHgwMCkgLSAoeDExIC0geDEwKSAqICh5MDEgLSB5MDApOwogICAgICAgIGlmIChkZW5vbWluYXRvcjEgPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdWExID0gbnVtZXJhdG9yMUEgLyBkZW5vbWluYXRvcjE7CiAgICAgICAgY29uc3QgdWIxID0gbnVtZXJhdG9yMUIgLyBkZW5vbWluYXRvcjE7CiAgICAgICAgaWYgKHVhMSA+PSAwICYmIHVhMSA8PSAxICYmIHViMSA+PSAwICYmIHViMSA8PSAxKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC54ID0geDAwICsgdWExICogKHgwMSAtIHgwMCk7CiAgICAgICAgICByZXN1bHQueSA9IHkwMCArIHVhMSAqICh5MDEgLSB5MDApOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEludGVyc2VjdGlvbnMyRF9kZWZhdWx0ID0gSW50ZXJzZWN0aW9uczJEOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaC5qcwogIHZhciB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydCh1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2hfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2gocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgaXNFYXN0Q2hpbGQgPSBwYXJhbWV0ZXJzLmlzRWFzdENoaWxkOwogICAgY29uc3QgaXNOb3J0aENoaWxkID0gcGFyYW1ldGVycy5pc05vcnRoQ2hpbGQ7CiAgICBjb25zdCBtaW5VID0gaXNFYXN0Q2hpbGQgPyBoYWxmTWF4U2hvcnQgOiAwOwogICAgY29uc3QgbWF4VSA9IGlzRWFzdENoaWxkID8gbWF4U2hvcnQ1IDogaGFsZk1heFNob3J0OwogICAgY29uc3QgbWluViA9IGlzTm9ydGhDaGlsZCA/IGhhbGZNYXhTaG9ydCA6IDA7CiAgICBjb25zdCBtYXhWID0gaXNOb3J0aENoaWxkID8gbWF4U2hvcnQ1IDogaGFsZk1heFNob3J0OwogICAgY29uc3QgdUJ1ZmZlciA9IHVTY3JhdGNoOwogICAgY29uc3QgdkJ1ZmZlciA9IHZTY3JhdGNoOwogICAgY29uc3QgaGVpZ2h0QnVmZmVyID0gaGVpZ2h0U2NyYXRjaDsKICAgIGNvbnN0IG5vcm1hbEJ1ZmZlciA9IG5vcm1hbHNTY3JhdGNoOwogICAgdUJ1ZmZlci5sZW5ndGggPSAwOwogICAgdkJ1ZmZlci5sZW5ndGggPSAwOwogICAgaGVpZ2h0QnVmZmVyLmxlbmd0aCA9IDA7CiAgICBub3JtYWxCdWZmZXIubGVuZ3RoID0gMDsKICAgIGNvbnN0IGluZGljZXMgPSBpbmRpY2VzU2NyYXRjaDsKICAgIGluZGljZXMubGVuZ3RoID0gMDsKICAgIGNvbnN0IHZlcnRleE1hcCA9IHt9OwogICAgY29uc3QgcGFyZW50VmVydGljZXMgPSBwYXJhbWV0ZXJzLnZlcnRpY2VzOwogICAgbGV0IHBhcmVudEluZGljZXMgPSBwYXJhbWV0ZXJzLmluZGljZXM7CiAgICBwYXJlbnRJbmRpY2VzID0gcGFyZW50SW5kaWNlcy5zdWJhcnJheSgwLCBwYXJhbWV0ZXJzLmluZGV4Q291bnRXaXRob3V0U2tpcnRzKTsKICAgIGNvbnN0IGVuY29kaW5nID0gVGVycmFpbkVuY29kaW5nX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5lbmNvZGluZyk7CiAgICBjb25zdCBoYXNWZXJ0ZXhOb3JtYWxzID0gZW5jb2RpbmcuaGFzVmVydGV4Tm9ybWFsczsKICAgIGxldCB2ZXJ0ZXhDb3VudCA9IDA7CiAgICBjb25zdCBxdWFudGl6ZWRWZXJ0ZXhDb3VudCA9IHBhcmFtZXRlcnMudmVydGV4Q291bnRXaXRob3V0U2tpcnRzOwogICAgY29uc3QgcGFyZW50TWluaW11bUhlaWdodCA9IHBhcmFtZXRlcnMubWluaW11bUhlaWdodDsKICAgIGNvbnN0IHBhcmVudE1heGltdW1IZWlnaHQgPSBwYXJhbWV0ZXJzLm1heGltdW1IZWlnaHQ7CiAgICBjb25zdCBwYXJlbnRVQnVmZmVyID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICAgIGNvbnN0IHBhcmVudFZCdWZmZXIgPSBuZXcgQXJyYXkocXVhbnRpemVkVmVydGV4Q291bnQpOwogICAgY29uc3QgcGFyZW50SGVpZ2h0QnVmZmVyID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICAgIGNvbnN0IHBhcmVudE5vcm1hbEJ1ZmZlciA9IGhhc1ZlcnRleE5vcm1hbHMgPyBuZXcgQXJyYXkocXVhbnRpemVkVmVydGV4Q291bnQgKiAyKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRocmVzaG9sZCA9IDIwOwogICAgbGV0IGhlaWdodDsKICAgIGxldCBpLCBuOwogICAgbGV0IHUzLCB2MzsKICAgIGZvciAoaSA9IDAsIG4gPSAwOyBpIDwgcXVhbnRpemVkVmVydGV4Q291bnQ7ICsraSwgbiArPSAyKSB7CiAgICAgIGNvbnN0IHRleENvb3JkcyA9IGVuY29kaW5nLmRlY29kZVRleHR1cmVDb29yZGluYXRlcygKICAgICAgICBwYXJlbnRWZXJ0aWNlcywKICAgICAgICBpLAogICAgICAgIGRlY29kZVRleENvb3Jkc1NjcmF0Y2gKICAgICAgKTsKICAgICAgaGVpZ2h0ID0gZW5jb2RpbmcuZGVjb2RlSGVpZ2h0KHBhcmVudFZlcnRpY2VzLCBpKTsKICAgICAgdTMgPSBNYXRoX2RlZmF1bHQuY2xhbXAodGV4Q29vcmRzLnggKiBtYXhTaG9ydDUgfCAwLCAwLCBtYXhTaG9ydDUpOwogICAgICB2MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh0ZXhDb29yZHMueSAqIG1heFNob3J0NSB8IDAsIDAsIG1heFNob3J0NSk7CiAgICAgIHBhcmVudEhlaWdodEJ1ZmZlcltpXSA9IE1hdGhfZGVmYXVsdC5jbGFtcCgKICAgICAgICAoaGVpZ2h0IC0gcGFyZW50TWluaW11bUhlaWdodCkgLyAocGFyZW50TWF4aW11bUhlaWdodCAtIHBhcmVudE1pbmltdW1IZWlnaHQpICogbWF4U2hvcnQ1IHwgMCwKICAgICAgICAwLAogICAgICAgIG1heFNob3J0NQogICAgICApOwogICAgICBpZiAodTMgPCB0aHJlc2hvbGQpIHsKICAgICAgICB1MyA9IDA7CiAgICAgIH0KICAgICAgaWYgKHYzIDwgdGhyZXNob2xkKSB7CiAgICAgICAgdjMgPSAwOwogICAgICB9CiAgICAgIGlmIChtYXhTaG9ydDUgLSB1MyA8IHRocmVzaG9sZCkgewogICAgICAgIHUzID0gbWF4U2hvcnQ1OwogICAgICB9CiAgICAgIGlmIChtYXhTaG9ydDUgLSB2MyA8IHRocmVzaG9sZCkgewogICAgICAgIHYzID0gbWF4U2hvcnQ1OwogICAgICB9CiAgICAgIHBhcmVudFVCdWZmZXJbaV0gPSB1MzsKICAgICAgcGFyZW50VkJ1ZmZlcltpXSA9IHYzOwogICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgIGNvbnN0IGVuY29kZWROb3JtYWwgPSBlbmNvZGluZy5nZXRPY3RFbmNvZGVkTm9ybWFsKAogICAgICAgICAgcGFyZW50VmVydGljZXMsCiAgICAgICAgICBpLAogICAgICAgICAgb2N0RW5jb2RlZE5vcm1hbFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIHBhcmVudE5vcm1hbEJ1ZmZlcltuXSA9IGVuY29kZWROb3JtYWwueDsKICAgICAgICBwYXJlbnROb3JtYWxCdWZmZXJbbiArIDFdID0gZW5jb2RlZE5vcm1hbC55OwogICAgICB9CiAgICAgIGlmICgoaXNFYXN0Q2hpbGQgJiYgdTMgPj0gaGFsZk1heFNob3J0IHx8ICFpc0Vhc3RDaGlsZCAmJiB1MyA8PSBoYWxmTWF4U2hvcnQpICYmIChpc05vcnRoQ2hpbGQgJiYgdjMgPj0gaGFsZk1heFNob3J0IHx8ICFpc05vcnRoQ2hpbGQgJiYgdjMgPD0gaGFsZk1heFNob3J0KSkgewogICAgICAgIHZlcnRleE1hcFtpXSA9IHZlcnRleENvdW50OwogICAgICAgIHVCdWZmZXIucHVzaCh1Myk7CiAgICAgICAgdkJ1ZmZlci5wdXNoKHYzKTsKICAgICAgICBoZWlnaHRCdWZmZXIucHVzaChwYXJlbnRIZWlnaHRCdWZmZXJbaV0pOwogICAgICAgIGlmIChoYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICBub3JtYWxCdWZmZXIucHVzaChwYXJlbnROb3JtYWxCdWZmZXJbbl0pOwogICAgICAgICAgbm9ybWFsQnVmZmVyLnB1c2gocGFyZW50Tm9ybWFsQnVmZmVyW24gKyAxXSk7CiAgICAgICAgfQogICAgICAgICsrdmVydGV4Q291bnQ7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHRyaWFuZ2xlVmVydGljZXMgPSBbXTsKICAgIHRyaWFuZ2xlVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgdHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICB0cmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgIGNvbnN0IGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzID0gW107CiAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICBsZXQgY2xpcHBlZEluZGV4OwogICAgbGV0IGNsaXBwZWQyOwogICAgZm9yIChpID0gMDsgaSA8IHBhcmVudEluZGljZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgaTAgPSBwYXJlbnRJbmRpY2VzW2ldOwogICAgICBjb25zdCBpMSA9IHBhcmVudEluZGljZXNbaSArIDFdOwogICAgICBjb25zdCBpMiA9IHBhcmVudEluZGljZXNbaSArIDJdOwogICAgICBjb25zdCB1MCA9IHBhcmVudFVCdWZmZXJbaTBdOwogICAgICBjb25zdCB1MTIgPSBwYXJlbnRVQnVmZmVyW2kxXTsKICAgICAgY29uc3QgdTIyID0gcGFyZW50VUJ1ZmZlcltpMl07CiAgICAgIHRyaWFuZ2xlVmVydGljZXNbMF0uaW5pdGlhbGl6ZUluZGV4ZWQoCiAgICAgICAgcGFyZW50VUJ1ZmZlciwKICAgICAgICBwYXJlbnRWQnVmZmVyLAogICAgICAgIHBhcmVudEhlaWdodEJ1ZmZlciwKICAgICAgICBwYXJlbnROb3JtYWxCdWZmZXIsCiAgICAgICAgaTAKICAgICAgKTsKICAgICAgdHJpYW5nbGVWZXJ0aWNlc1sxXS5pbml0aWFsaXplSW5kZXhlZCgKICAgICAgICBwYXJlbnRVQnVmZmVyLAogICAgICAgIHBhcmVudFZCdWZmZXIsCiAgICAgICAgcGFyZW50SGVpZ2h0QnVmZmVyLAogICAgICAgIHBhcmVudE5vcm1hbEJ1ZmZlciwKICAgICAgICBpMQogICAgICApOwogICAgICB0cmlhbmdsZVZlcnRpY2VzWzJdLmluaXRpYWxpemVJbmRleGVkKAogICAgICAgIHBhcmVudFVCdWZmZXIsCiAgICAgICAgcGFyZW50VkJ1ZmZlciwKICAgICAgICBwYXJlbnRIZWlnaHRCdWZmZXIsCiAgICAgICAgcGFyZW50Tm9ybWFsQnVmZmVyLAogICAgICAgIGkyCiAgICAgICk7CiAgICAgIGNvbnN0IGNsaXBwZWQgPSBJbnRlcnNlY3Rpb25zMkRfZGVmYXVsdC5jbGlwVHJpYW5nbGVBdEF4aXNBbGlnbmVkVGhyZXNob2xkKAogICAgICAgIGhhbGZNYXhTaG9ydCwKICAgICAgICBpc0Vhc3RDaGlsZCwKICAgICAgICB1MCwKICAgICAgICB1MTIsCiAgICAgICAgdTIyLAogICAgICAgIGNsaXBTY3JhdGNoCiAgICAgICk7CiAgICAgIGNsaXBwZWRJbmRleCA9IDA7CiAgICAgIGlmIChjbGlwcGVkSW5kZXggPj0gY2xpcHBlZC5sZW5ndGgpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjbGlwcGVkSW5kZXggPSBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1swXS5pbml0aWFsaXplRnJvbUNsaXBSZXN1bHQoCiAgICAgICAgY2xpcHBlZCwKICAgICAgICBjbGlwcGVkSW5kZXgsCiAgICAgICAgdHJpYW5nbGVWZXJ0aWNlcwogICAgICApOwogICAgICBpZiAoY2xpcHBlZEluZGV4ID49IGNsaXBwZWQubGVuZ3RoKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY2xpcHBlZEluZGV4ID0gY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMV0uaW5pdGlhbGl6ZUZyb21DbGlwUmVzdWx0KAogICAgICAgIGNsaXBwZWQsCiAgICAgICAgY2xpcHBlZEluZGV4LAogICAgICAgIHRyaWFuZ2xlVmVydGljZXMKICAgICAgKTsKICAgICAgaWYgKGNsaXBwZWRJbmRleCA+PSBjbGlwcGVkLmxlbmd0aCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNsaXBwZWRJbmRleCA9IGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzJdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgICBjbGlwcGVkLAogICAgICAgIGNsaXBwZWRJbmRleCwKICAgICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICAgICk7CiAgICAgIGNsaXBwZWQyID0gSW50ZXJzZWN0aW9uczJEX2RlZmF1bHQuY2xpcFRyaWFuZ2xlQXRBeGlzQWxpZ25lZFRocmVzaG9sZCgKICAgICAgICBoYWxmTWF4U2hvcnQsCiAgICAgICAgaXNOb3J0aENoaWxkLAogICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzBdLmdldFYoKSwKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1sxXS5nZXRWKCksCiAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMl0uZ2V0VigpLAogICAgICAgIGNsaXBTY3JhdGNoMgogICAgICApOwogICAgICBhZGRDbGlwcGVkUG9seWdvbigKICAgICAgICB1QnVmZmVyLAogICAgICAgIHZCdWZmZXIsCiAgICAgICAgaGVpZ2h0QnVmZmVyLAogICAgICAgIG5vcm1hbEJ1ZmZlciwKICAgICAgICBpbmRpY2VzLAogICAgICAgIHZlcnRleE1hcCwKICAgICAgICBjbGlwcGVkMiwKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcywKICAgICAgICBoYXNWZXJ0ZXhOb3JtYWxzCiAgICAgICk7CiAgICAgIGlmIChjbGlwcGVkSW5kZXggPCBjbGlwcGVkLmxlbmd0aCkgewogICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzJdLmNsb25lKGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzFdKTsKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1syXS5pbml0aWFsaXplRnJvbUNsaXBSZXN1bHQoCiAgICAgICAgICBjbGlwcGVkLAogICAgICAgICAgY2xpcHBlZEluZGV4LAogICAgICAgICAgdHJpYW5nbGVWZXJ0aWNlcwogICAgICAgICk7CiAgICAgICAgY2xpcHBlZDIgPSBJbnRlcnNlY3Rpb25zMkRfZGVmYXVsdC5jbGlwVHJpYW5nbGVBdEF4aXNBbGlnbmVkVGhyZXNob2xkKAogICAgICAgICAgaGFsZk1heFNob3J0LAogICAgICAgICAgaXNOb3J0aENoaWxkLAogICAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMF0uZ2V0VigpLAogICAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMV0uZ2V0VigpLAogICAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMl0uZ2V0VigpLAogICAgICAgICAgY2xpcFNjcmF0Y2gyCiAgICAgICAgKTsKICAgICAgICBhZGRDbGlwcGVkUG9seWdvbigKICAgICAgICAgIHVCdWZmZXIsCiAgICAgICAgICB2QnVmZmVyLAogICAgICAgICAgaGVpZ2h0QnVmZmVyLAogICAgICAgICAgbm9ybWFsQnVmZmVyLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHZlcnRleE1hcCwKICAgICAgICAgIGNsaXBwZWQyLAogICAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXMsCiAgICAgICAgICBoYXNWZXJ0ZXhOb3JtYWxzCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgY29uc3QgdU9mZnNldCA9IGlzRWFzdENoaWxkID8gLW1heFNob3J0NSA6IDA7CiAgICBjb25zdCB2T2Zmc2V0ID0gaXNOb3J0aENoaWxkID8gLW1heFNob3J0NSA6IDA7CiAgICBjb25zdCB3ZXN0SW5kaWNlcyA9IFtdOwogICAgY29uc3Qgc291dGhJbmRpY2VzID0gW107CiAgICBjb25zdCBlYXN0SW5kaWNlcyA9IFtdOwogICAgY29uc3Qgbm9ydGhJbmRpY2VzID0gW107CiAgICBsZXQgbWluaW11bUhlaWdodCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICBsZXQgbWF4aW11bUhlaWdodCA9IC1taW5pbXVtSGVpZ2h0OwogICAgY29uc3QgY2FydGVzaWFuVmVydGljZXMgPSB2ZXJ0aWNlc1NjcmF0Y2g7CiAgICBjYXJ0ZXNpYW5WZXJ0aWNlcy5sZW5ndGggPSAwOwogICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5lbGxpcHNvaWQpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5jaGlsZFJlY3RhbmdsZSk7CiAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgIGlmIChlYXN0IDwgd2VzdCkgewogICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICB9CiAgICBmb3IgKGkgPSAwOyBpIDwgdUJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgICB1MyA9IE1hdGgucm91bmQodUJ1ZmZlcltpXSk7CiAgICAgIGlmICh1MyA8PSBtaW5VKSB7CiAgICAgICAgd2VzdEluZGljZXMucHVzaChpKTsKICAgICAgICB1MyA9IDA7CiAgICAgIH0gZWxzZSBpZiAodTMgPj0gbWF4VSkgewogICAgICAgIGVhc3RJbmRpY2VzLnB1c2goaSk7CiAgICAgICAgdTMgPSBtYXhTaG9ydDU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdTMgPSB1MyAqIDIgKyB1T2Zmc2V0OwogICAgICB9CiAgICAgIHVCdWZmZXJbaV0gPSB1MzsKICAgICAgdjMgPSBNYXRoLnJvdW5kKHZCdWZmZXJbaV0pOwogICAgICBpZiAodjMgPD0gbWluVikgewogICAgICAgIHNvdXRoSW5kaWNlcy5wdXNoKGkpOwogICAgICAgIHYzID0gMDsKICAgICAgfSBlbHNlIGlmICh2MyA+PSBtYXhWKSB7CiAgICAgICAgbm9ydGhJbmRpY2VzLnB1c2goaSk7CiAgICAgICAgdjMgPSBtYXhTaG9ydDU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdjMgPSB2MyAqIDIgKyB2T2Zmc2V0OwogICAgICB9CiAgICAgIHZCdWZmZXJbaV0gPSB2MzsKICAgICAgaGVpZ2h0ID0gTWF0aF9kZWZhdWx0LmxlcnAoCiAgICAgICAgcGFyZW50TWluaW11bUhlaWdodCwKICAgICAgICBwYXJlbnRNYXhpbXVtSGVpZ2h0LAogICAgICAgIGhlaWdodEJ1ZmZlcltpXSAvIG1heFNob3J0NQogICAgICApOwogICAgICBpZiAoaGVpZ2h0IDwgbWluaW11bUhlaWdodCkgewogICAgICAgIG1pbmltdW1IZWlnaHQgPSBoZWlnaHQ7CiAgICAgIH0KICAgICAgaWYgKGhlaWdodCA+IG1heGltdW1IZWlnaHQpIHsKICAgICAgICBtYXhpbXVtSGVpZ2h0ID0gaGVpZ2h0OwogICAgICB9CiAgICAgIGhlaWdodEJ1ZmZlcltpXSA9IGhlaWdodDsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDIubG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAod2VzdCwgZWFzdCwgdTMgLyBtYXhTaG9ydDUpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMi5sYXRpdHVkZSA9IE1hdGhfZGVmYXVsdC5sZXJwKHNvdXRoLCBub3J0aCwgdjMgLyBtYXhTaG9ydDUpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMi5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0b2dyYXBoaWNTY3JhdGNoMiwgY2FydGVzaWFuM1NjcmF0Y2g5KTsKICAgICAgY2FydGVzaWFuVmVydGljZXMucHVzaChjYXJ0ZXNpYW4zU2NyYXRjaDkueCk7CiAgICAgIGNhcnRlc2lhblZlcnRpY2VzLnB1c2goY2FydGVzaWFuM1NjcmF0Y2g5LnkpOwogICAgICBjYXJ0ZXNpYW5WZXJ0aWNlcy5wdXNoKGNhcnRlc2lhbjNTY3JhdGNoOS56KTsKICAgIH0KICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgIGNhcnRlc2lhblZlcnRpY2VzLAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgMywKICAgICAgYm91bmRpbmdTcGhlcmVTY3JhdGNoCiAgICApOwogICAgY29uc3Qgb3JpZW50ZWRCb3VuZGluZ0JveCA9IE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlKAogICAgICByZWN0YW5nbGUsCiAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIGVsbGlwc29pZCwKICAgICAgb3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBvY2NsdWRlciA9IG5ldyBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgIGNvbnN0IGhvcml6b25PY2NsdXNpb25Qb2ludCA9IG9jY2x1ZGVyLmNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVZlcnRpY2VzUG9zc2libHlVbmRlckVsbGlwc29pZCgKICAgICAgYm91bmRpbmdTcGhlcmUuY2VudGVyLAogICAgICBjYXJ0ZXNpYW5WZXJ0aWNlcywKICAgICAgMywKICAgICAgYm91bmRpbmdTcGhlcmUuY2VudGVyLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBob3Jpem9uT2NjbHVzaW9uUG9pbnRTY3JhdGNoCiAgICApOwogICAgY29uc3QgaGVpZ2h0UmFuZ2UgPSBtYXhpbXVtSGVpZ2h0IC0gbWluaW11bUhlaWdodDsKICAgIGNvbnN0IHZlcnRpY2VzID0gbmV3IFVpbnQxNkFycmF5KAogICAgICB1QnVmZmVyLmxlbmd0aCArIHZCdWZmZXIubGVuZ3RoICsgaGVpZ2h0QnVmZmVyLmxlbmd0aAogICAgKTsKICAgIGZvciAoaSA9IDA7IGkgPCB1QnVmZmVyLmxlbmd0aDsgKytpKSB7CiAgICAgIHZlcnRpY2VzW2ldID0gdUJ1ZmZlcltpXTsKICAgIH0KICAgIGxldCBzdGFydCA9IHVCdWZmZXIubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IHZCdWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgdmVydGljZXNbc3RhcnQgKyBpXSA9IHZCdWZmZXJbaV07CiAgICB9CiAgICBzdGFydCArPSB2QnVmZmVyLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBoZWlnaHRCdWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgdmVydGljZXNbc3RhcnQgKyBpXSA9IG1heFNob3J0NSAqIChoZWlnaHRCdWZmZXJbaV0gLSBtaW5pbXVtSGVpZ2h0KSAvIGhlaWdodFJhbmdlOwogICAgfQogICAgY29uc3QgaW5kaWNlc1R5cGVkQXJyYXkgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgdUJ1ZmZlci5sZW5ndGgsCiAgICAgIGluZGljZXMKICAgICk7CiAgICBsZXQgZW5jb2RlZE5vcm1hbHM7CiAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICBjb25zdCBub3JtYWxBcnJheSA9IG5ldyBVaW50OEFycmF5KG5vcm1hbEJ1ZmZlcik7CiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgICB2ZXJ0aWNlcy5idWZmZXIsCiAgICAgICAgaW5kaWNlc1R5cGVkQXJyYXkuYnVmZmVyLAogICAgICAgIG5vcm1hbEFycmF5LmJ1ZmZlcgogICAgICApOwogICAgICBlbmNvZGVkTm9ybWFscyA9IG5vcm1hbEFycmF5LmJ1ZmZlcjsKICAgIH0gZWxzZSB7CiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCh2ZXJ0aWNlcy5idWZmZXIsIGluZGljZXNUeXBlZEFycmF5LmJ1ZmZlcik7CiAgICB9CiAgICByZXR1cm4gewogICAgICB2ZXJ0aWNlczogdmVydGljZXMuYnVmZmVyLAogICAgICBlbmNvZGVkTm9ybWFscywKICAgICAgaW5kaWNlczogaW5kaWNlc1R5cGVkQXJyYXkuYnVmZmVyLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICB3ZXN0SW5kaWNlcywKICAgICAgc291dGhJbmRpY2VzLAogICAgICBlYXN0SW5kaWNlcywKICAgICAgbm9ydGhJbmRpY2VzLAogICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgb3JpZW50ZWRCb3VuZGluZ0JveCwKICAgICAgaG9yaXpvbk9jY2x1c2lvblBvaW50CiAgICB9OwogIH0KICBmdW5jdGlvbiBWZXJ0ZXgoKSB7CiAgICB0aGlzLnZlcnRleEJ1ZmZlciA9IHZvaWQgMDsKICAgIHRoaXMuaW5kZXggPSB2b2lkIDA7CiAgICB0aGlzLmZpcnN0ID0gdm9pZCAwOwogICAgdGhpcy5zZWNvbmQgPSB2b2lkIDA7CiAgICB0aGlzLnJhdGlvID0gdm9pZCAwOwogIH0KICBmdW5jdGlvbiBsZXJwT2N0RW5jb2RlZE5vcm1hbCh2ZXJ0ZXgsIHJlc3VsdCkgewogICAgKytkZXB0aDsKICAgIGxldCBmaXJzdCA9IGNhcnRlc2lhblNjcmF0Y2gxW2RlcHRoXTsKICAgIGxldCBzZWNvbmQgPSBjYXJ0ZXNpYW5TY3JhdGNoMltkZXB0aF07CiAgICBmaXJzdCA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RGVjb2RlKAogICAgICB2ZXJ0ZXguZmlyc3QuZ2V0Tm9ybWFsWCgpLAogICAgICB2ZXJ0ZXguZmlyc3QuZ2V0Tm9ybWFsWSgpLAogICAgICBmaXJzdAogICAgKTsKICAgIHNlY29uZCA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RGVjb2RlKAogICAgICB2ZXJ0ZXguc2Vjb25kLmdldE5vcm1hbFgoKSwKICAgICAgdmVydGV4LnNlY29uZC5nZXROb3JtYWxZKCksCiAgICAgIHNlY29uZAogICAgKTsKICAgIGNhcnRlc2lhbjNTY3JhdGNoOSA9IENhcnRlc2lhbjNfZGVmYXVsdC5sZXJwKAogICAgICBmaXJzdCwKICAgICAgc2Vjb25kLAogICAgICB2ZXJ0ZXgucmF0aW8sCiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOQogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoY2FydGVzaWFuM1NjcmF0Y2g5LCBjYXJ0ZXNpYW4zU2NyYXRjaDkpOwogICAgQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5vY3RFbmNvZGUoY2FydGVzaWFuM1NjcmF0Y2g5LCByZXN1bHQpOwogICAgLS1kZXB0aDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGFkZENsaXBwZWRQb2x5Z29uKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlciwgbm9ybWFsQnVmZmVyLCBpbmRpY2VzLCB2ZXJ0ZXhNYXAsIGNsaXBwZWQsIHRyaWFuZ2xlVmVydGljZXMsIGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgIGlmIChjbGlwcGVkLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgbnVtVmVydGljZXMgPSAwOwogICAgbGV0IGNsaXBwZWRJbmRleCA9IDA7CiAgICB3aGlsZSAoY2xpcHBlZEluZGV4IDwgY2xpcHBlZC5sZW5ndGgpIHsKICAgICAgY2xpcHBlZEluZGV4ID0gcG9seWdvblZlcnRpY2VzW251bVZlcnRpY2VzKytdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgICBjbGlwcGVkLAogICAgICAgIGNsaXBwZWRJbmRleCwKICAgICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICAgICk7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZlcnRpY2VzOyArK2kpIHsKICAgICAgY29uc3QgcG9seWdvblZlcnRleCA9IHBvbHlnb25WZXJ0aWNlc1tpXTsKICAgICAgaWYgKCFwb2x5Z29uVmVydGV4LmlzSW5kZXhlZCgpKSB7CiAgICAgICAgY29uc3Qga2V5ID0gcG9seWdvblZlcnRleC5nZXRLZXkoKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHZlcnRleE1hcFtrZXldKSkgewogICAgICAgICAgcG9seWdvblZlcnRleC5uZXdJbmRleCA9IHZlcnRleE1hcFtrZXldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IHVCdWZmZXIubGVuZ3RoOwogICAgICAgICAgdUJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0VSgpKTsKICAgICAgICAgIHZCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldFYoKSk7CiAgICAgICAgICBoZWlnaHRCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldEgoKSk7CiAgICAgICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgICAgICBub3JtYWxCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldE5vcm1hbFgoKSk7CiAgICAgICAgICAgIG5vcm1hbEJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0Tm9ybWFsWSgpKTsKICAgICAgICAgIH0KICAgICAgICAgIHBvbHlnb25WZXJ0ZXgubmV3SW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgIHZlcnRleE1hcFtrZXldID0gbmV3SW5kZXg7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHBvbHlnb25WZXJ0ZXgubmV3SW5kZXggPSB2ZXJ0ZXhNYXBbcG9seWdvblZlcnRleC5pbmRleF07CiAgICAgICAgcG9seWdvblZlcnRleC51QnVmZmVyID0gdUJ1ZmZlcjsKICAgICAgICBwb2x5Z29uVmVydGV4LnZCdWZmZXIgPSB2QnVmZmVyOwogICAgICAgIHBvbHlnb25WZXJ0ZXguaGVpZ2h0QnVmZmVyID0gaGVpZ2h0QnVmZmVyOwogICAgICAgIGlmIChoYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICBwb2x5Z29uVmVydGV4Lm5vcm1hbEJ1ZmZlciA9IG5vcm1hbEJ1ZmZlcjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChudW1WZXJ0aWNlcyA9PT0gMykgewogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzBdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1sxXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMl0ubmV3SW5kZXgpOwogICAgfSBlbHNlIGlmIChudW1WZXJ0aWNlcyA9PT0gNCkgewogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzBdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1sxXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMl0ubmV3SW5kZXgpOwogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzBdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1syXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbM10ubmV3SW5kZXgpOwogICAgfQogIH0KICB2YXIgbWF4U2hvcnQ1LCBoYWxmTWF4U2hvcnQsIGNsaXBTY3JhdGNoLCBjbGlwU2NyYXRjaDIsIHZlcnRpY2VzU2NyYXRjaCwgY2FydG9ncmFwaGljU2NyYXRjaDIsIGNhcnRlc2lhbjNTY3JhdGNoOSwgdVNjcmF0Y2gsIHZTY3JhdGNoLCBoZWlnaHRTY3JhdGNoLCBpbmRpY2VzU2NyYXRjaCwgbm9ybWFsc1NjcmF0Y2gsIGhvcml6b25PY2NsdXNpb25Qb2ludFNjcmF0Y2gsIGJvdW5kaW5nU3BoZXJlU2NyYXRjaCwgb3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2gsIGRlY29kZVRleENvb3Jkc1NjcmF0Y2gsIG9jdEVuY29kZWROb3JtYWxTY3JhdGNoLCBlbmNvZGVkU2NyYXRjaCwgZGVwdGgsIGNhcnRlc2lhblNjcmF0Y2gxLCBjYXJ0ZXNpYW5TY3JhdGNoMiwgcG9seWdvblZlcnRpY2VzLCB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoX2RlZmF1bHQ7CiAgdmFyIGluaXRfdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaC5qcyIoKSB7CiAgICAgIGluaXRfQXR0cmlidXRlQ29tcHJlc3Npb24oKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZGFsT2NjbHVkZXIoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0aW9uczJEKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X09yaWVudGVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9UZXJyYWluRW5jb2RpbmcoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIG1heFNob3J0NSA9IDMyNzY3OwogICAgICBoYWxmTWF4U2hvcnQgPSBtYXhTaG9ydDUgLyAyIHwgMDsKICAgICAgY2xpcFNjcmF0Y2ggPSBbXTsKICAgICAgY2xpcFNjcmF0Y2gyID0gW107CiAgICAgIHZlcnRpY2VzU2NyYXRjaCA9IFtdOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHVTY3JhdGNoID0gW107CiAgICAgIHZTY3JhdGNoID0gW107CiAgICAgIGhlaWdodFNjcmF0Y2ggPSBbXTsKICAgICAgaW5kaWNlc1NjcmF0Y2ggPSBbXTsKICAgICAgbm9ybWFsc1NjcmF0Y2ggPSBbXTsKICAgICAgaG9yaXpvbk9jY2x1c2lvblBvaW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYm91bmRpbmdTcGhlcmVTY3JhdGNoID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgb3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2ggPSBuZXcgT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0KCk7CiAgICAgIGRlY29kZVRleENvb3Jkc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIG9jdEVuY29kZWROb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFZlcnRleCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQudUJ1ZmZlciA9IHRoaXMudUJ1ZmZlcjsKICAgICAgICByZXN1bHQudkJ1ZmZlciA9IHRoaXMudkJ1ZmZlcjsKICAgICAgICByZXN1bHQuaGVpZ2h0QnVmZmVyID0gdGhpcy5oZWlnaHRCdWZmZXI7CiAgICAgICAgcmVzdWx0Lm5vcm1hbEJ1ZmZlciA9IHRoaXMubm9ybWFsQnVmZmVyOwogICAgICAgIHJlc3VsdC5pbmRleCA9IHRoaXMuaW5kZXg7CiAgICAgICAgcmVzdWx0LmZpcnN0ID0gdGhpcy5maXJzdDsKICAgICAgICByZXN1bHQuc2Vjb25kID0gdGhpcy5zZWNvbmQ7CiAgICAgICAgcmVzdWx0LnJhdGlvID0gdGhpcy5yYXRpbzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmluaXRpYWxpemVJbmRleGVkID0gZnVuY3Rpb24odUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyLCBub3JtYWxCdWZmZXIsIGluZGV4KSB7CiAgICAgICAgdGhpcy51QnVmZmVyID0gdUJ1ZmZlcjsKICAgICAgICB0aGlzLnZCdWZmZXIgPSB2QnVmZmVyOwogICAgICAgIHRoaXMuaGVpZ2h0QnVmZmVyID0gaGVpZ2h0QnVmZmVyOwogICAgICAgIHRoaXMubm9ybWFsQnVmZmVyID0gbm9ybWFsQnVmZmVyOwogICAgICAgIHRoaXMuaW5kZXggPSBpbmRleDsKICAgICAgICB0aGlzLmZpcnN0ID0gdm9pZCAwOwogICAgICAgIHRoaXMuc2Vjb25kID0gdm9pZCAwOwogICAgICAgIHRoaXMucmF0aW8gPSB2b2lkIDA7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuaW5pdGlhbGl6ZUZyb21DbGlwUmVzdWx0ID0gZnVuY3Rpb24oY2xpcFJlc3VsdCwgaW5kZXgsIHZlcnRpY2VzKSB7CiAgICAgICAgbGV0IG5leHRJbmRleCA9IGluZGV4ICsgMTsKICAgICAgICBpZiAoY2xpcFJlc3VsdFtpbmRleF0gIT09IC0xKSB7CiAgICAgICAgICB2ZXJ0aWNlc1tjbGlwUmVzdWx0W2luZGV4XV0uY2xvbmUodGhpcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMudmVydGV4QnVmZmVyID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5pbmRleCA9IHZvaWQgMDsKICAgICAgICAgIHRoaXMuZmlyc3QgPSB2ZXJ0aWNlc1tjbGlwUmVzdWx0W25leHRJbmRleF1dOwogICAgICAgICAgKytuZXh0SW5kZXg7CiAgICAgICAgICB0aGlzLnNlY29uZCA9IHZlcnRpY2VzW2NsaXBSZXN1bHRbbmV4dEluZGV4XV07CiAgICAgICAgICArK25leHRJbmRleDsKICAgICAgICAgIHRoaXMucmF0aW8gPSBjbGlwUmVzdWx0W25leHRJbmRleF07CiAgICAgICAgICArK25leHRJbmRleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5leHRJbmRleDsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5nZXRLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5pc0luZGV4ZWQoKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuaW5kZXg7CiAgICAgICAgfQogICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBmaXJzdDogdGhpcy5maXJzdC5nZXRLZXkoKSwKICAgICAgICAgIHNlY29uZDogdGhpcy5zZWNvbmQuZ2V0S2V5KCksCiAgICAgICAgICByYXRpbzogdGhpcy5yYXRpbwogICAgICAgIH0pOwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmlzSW5kZXhlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQodGhpcy5pbmRleCk7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuZ2V0SCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGhpcy5pbmRleCkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmhlaWdodEJ1ZmZlclt0aGlzLmluZGV4XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5sZXJwKHRoaXMuZmlyc3QuZ2V0SCgpLCB0aGlzLnNlY29uZC5nZXRIKCksIHRoaXMucmF0aW8pOwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmdldFUgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuaW5kZXgpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy51QnVmZmVyW3RoaXMuaW5kZXhdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gTWF0aF9kZWZhdWx0LmxlcnAodGhpcy5maXJzdC5nZXRVKCksIHRoaXMuc2Vjb25kLmdldFUoKSwgdGhpcy5yYXRpbyk7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuZ2V0ViA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGhpcy5pbmRleCkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnZCdWZmZXJbdGhpcy5pbmRleF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoX2RlZmF1bHQubGVycCh0aGlzLmZpcnN0LmdldFYoKSwgdGhpcy5zZWNvbmQuZ2V0VigpLCB0aGlzLnJhdGlvKTsKICAgICAgfTsKICAgICAgZW5jb2RlZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGRlcHRoID0gLTE7CiAgICAgIGNhcnRlc2lhblNjcmF0Y2gxID0gW25ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpXTsKICAgICAgY2FydGVzaWFuU2NyYXRjaDIgPSBbbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCldOwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmdldE5vcm1hbFggPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuaW5kZXgpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxCdWZmZXJbdGhpcy5pbmRleCAqIDJdOwogICAgICAgIH0KICAgICAgICBlbmNvZGVkU2NyYXRjaCA9IGxlcnBPY3RFbmNvZGVkTm9ybWFsKHRoaXMsIGVuY29kZWRTY3JhdGNoKTsKICAgICAgICByZXR1cm4gZW5jb2RlZFNjcmF0Y2gueDsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5nZXROb3JtYWxZID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLmluZGV4KSkgewogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsQnVmZmVyW3RoaXMuaW5kZXggKiAyICsgMV07CiAgICAgICAgfQogICAgICAgIGVuY29kZWRTY3JhdGNoID0gbGVycE9jdEVuY29kZWROb3JtYWwodGhpcywgZW5jb2RlZFNjcmF0Y2gpOwogICAgICAgIHJldHVybiBlbmNvZGVkU2NyYXRjaC55OwogICAgICB9OwogICAgICBwb2x5Z29uVmVydGljZXMgPSBbXTsKICAgICAgcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgICAgcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgICAgcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgICAgcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgICAgdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2gpOwogICAgfQogIH0pOwoKICAvLyBpbXBvcnQoIi4vKiovKi5qcyIpIGluIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVHZW9tZXRyeS5qcwogIHZhciBnbG9iSW1wb3J0X2pzOwogIHZhciBpbml0XyA9IF9fZXNtKHsKICAgICdpbXBvcnQoIi4vKiovKi5qcyIpIGluIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVHZW9tZXRyeS5qcycoKSB7CiAgICAgIGdsb2JJbXBvcnRfanMgPSBfX2dsb2IoewogICAgICAgICIuL2NvbWJpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY29tYmluZUdlb21ldHJ5KCksIGNvbWJpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQm94R2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUJveEdlb21ldHJ5KCksIGNyZWF0ZUJveEdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUJveE91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUNpcmNsZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDaXJjbGVHZW9tZXRyeSgpLCBjcmVhdGVDaXJjbGVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkoKSwgY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ29ycmlkb3JHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ29ycmlkb3JHZW9tZXRyeSgpLCBjcmVhdGVDb3JyaWRvckdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkoKSwgY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVFbGxpcHNlR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUVsbGlwc2VHZW9tZXRyeSgpLCBjcmVhdGVFbGxpcHNlR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUVsbGlwc29pZEdlb21ldHJ5KCksIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUZydXN0dW1HZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlRnJ1c3R1bUdlb21ldHJ5KCksIGNyZWF0ZUZydXN0dW1HZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlR2VvbWV0cnkoKSwgY3JlYXRlR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkoKSwgY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUGxhbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUGxhbmVHZW9tZXRyeSgpLCBjcmVhdGVQbGFuZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVBvbHlnb25HZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUG9seWdvbkdlb21ldHJ5KCksIGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVQb2x5bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVQb2x5bGluZUdlb21ldHJ5KCksIGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkoKSwgY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVSZWN0YW5nbGVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkoKSwgY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeSgpLCBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVTcGhlcmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlU3BoZXJlR2VvbWV0cnkoKSwgY3JlYXRlU3BoZXJlR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlci5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpLCBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lcy5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMoKSwgY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXNfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcygpLCBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllc19leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVjdG9yVGlsZVBvaW50cy5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvaW50cygpLCBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2x5Z29ucygpLCBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXMuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXMoKSwgY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lc19leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXIoKSwgY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcCgpLCBjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXBfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaCgpLCBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlV2FsbEdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVXYWxsR2VvbWV0cnkoKSwgY3JlYXRlV2FsbEdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2RlY29kZURyYWNvLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9kZWNvZGVEcmFjbygpLCBkZWNvZGVEcmFjb19leHBvcnRzKSksCiAgICAgICAgIi4vZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQoKSwgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0X2V4cG9ydHMpKSwKICAgICAgICAiLi9kZWNvZGVJM1MuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2RlY29kZUkzUygpLCBkZWNvZGVJM1NfZXhwb3J0cykpLAogICAgICAgICIuL3RyYW5zY29kZUtUWDIuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X3RyYW5zY29kZUtUWDIoKSwgdHJhbnNjb2RlS1RYMl9leHBvcnRzKSksCiAgICAgICAgIi4vdHJhbnNmZXJUeXBlZEFycmF5VGVzdC5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfdHJhbnNmZXJUeXBlZEFycmF5VGVzdCgpLCB0cmFuc2ZlclR5cGVkQXJyYXlUZXN0X2V4cG9ydHMpKSwKICAgICAgICAiLi91cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF91cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoKCksIHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2hfZXhwb3J0cykpCiAgICAgIH0pOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBhc3luYyBmdW5jdGlvbiBnZXRNb2R1bGUobW9kdWxlTmFtZSwgbW9kdWxlUGF0aCkgewogICAgbGV0IG1vZHVsZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1vZHVsZUNhY2hlW21vZHVsZVBhdGhdLCBtb2R1bGVDYWNoZVttb2R1bGVOYW1lXSk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1vZHVsZSkpIHsKICAgICAgcmV0dXJuIG1vZHVsZTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobW9kdWxlUGF0aCkpIHsKICAgICAgaWYgKHR5cGVvZiBleHBvcnRzID09PSAib2JqZWN0IikgewogICAgICAgIG1vZHVsZSA9IF9fcmVxdWlyZShtb2R1bGVQYXRoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBpbXBvcnQobW9kdWxlUGF0aCk7CiAgICAgICAgbW9kdWxlID0gcmVzdWx0LmRlZmF1bHQ7CiAgICAgIH0KICAgICAgbW9kdWxlQ2FjaGVbbW9kdWxlUGF0aF0gPSBtb2R1bGU7CiAgICAgIHJldHVybiBtb2R1bGU7CiAgICB9CiAgICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICJvYmplY3QiKSB7CiAgICAgIG1vZHVsZSA9IF9fcmVxdWlyZShgV29ya2Vycy8ke21vZHVsZU5hbWV9YCk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCByZXN1bHQgPSBkZWZpbmVkX2RlZmF1bHQobW9kdWxlUGF0aCkgPyBhd2FpdCBpbXBvcnQobW9kdWxlUGF0aCkgOiBhd2FpdCBnbG9iSW1wb3J0X2pzKGAuLyR7bW9kdWxlTmFtZX0uanNgKTsKICAgICAgbW9kdWxlID0gcmVzdWx0LmRlZmF1bHQ7CiAgICB9CiAgICBtb2R1bGVDYWNoZVttb2R1bGVOYW1lXSA9IG1vZHVsZTsKICAgIHJldHVybiBtb2R1bGU7CiAgfQogIGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5KHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHN1YlRhc2tzID0gcGFyYW1ldGVycy5zdWJUYXNrczsKICAgIGNvbnN0IGxlbmd0aCA9IHN1YlRhc2tzLmxlbmd0aDsKICAgIGNvbnN0IHJlc3VsdHNPclByb21pc2VzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHRhc2sgPSBzdWJUYXNrc1tpXTsKICAgICAgY29uc3QgZ2VvbWV0cnkgPSB0YXNrLmdlb21ldHJ5OwogICAgICBjb25zdCBtb2R1bGVOYW1lID0gdGFzay5tb2R1bGVOYW1lOwogICAgICBjb25zdCBtb2R1bGVQYXRoID0gdGFzay5tb2R1bGVQYXRoOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1vZHVsZU5hbWUpICYmIGRlZmluZWRfZGVmYXVsdChtb2R1bGVQYXRoKSkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJNdXN0IG9ubHkgc2V0IG1vZHVsZU5hbWUgb3IgbW9kdWxlUGF0aCIpOwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobW9kdWxlTmFtZSkgfHwgZGVmaW5lZF9kZWZhdWx0KG1vZHVsZVBhdGgpKSB7CiAgICAgICAgcmVzdWx0c09yUHJvbWlzZXNbaV0gPSBnZXRNb2R1bGUobW9kdWxlTmFtZSwgbW9kdWxlUGF0aCkudGhlbigKICAgICAgICAgIChjcmVhdGVGdW5jdGlvbikgPT4gY3JlYXRlRnVuY3Rpb24oZ2VvbWV0cnksIHRhc2sub2Zmc2V0KQogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0c09yUHJvbWlzZXNbaV0gPSBnZW9tZXRyeTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIFByb21pc2UuYWxsKHJlc3VsdHNPclByb21pc2VzKS50aGVuKGZ1bmN0aW9uKHJlc3VsdHMpIHsKICAgICAgcmV0dXJuIFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQucGFja0NyZWF0ZUdlb21ldHJ5UmVzdWx0cygKICAgICAgICByZXN1bHRzLAogICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMKICAgICAgKTsKICAgIH0pOwogIH0KICB2YXIgbW9kdWxlQ2FjaGUsIGNyZWF0ZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9QcmltaXRpdmVQaXBlbGluZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgaW5pdF8oKTsKICAgICAgbW9kdWxlQ2FjaGUgPSB7fTsKICAgICAgY3JlYXRlR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVHZW9tZXRyeSk7CiAgICB9CiAgfSk7CgogIC8vIDxzdGRpbj4KICB2YXIgc3RkaW5fZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KHN0ZGluX2V4cG9ydHMsIHsKICAgIGNvbWJpbmVHZW9tZXRyeTogKCkgPT4gY29tYmluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUJveEdlb21ldHJ5OiAoKSA9PiBjcmVhdGVCb3hHZW9tZXRyeTIsCiAgICBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVDaXJjbGVHZW9tZXRyeTogKCkgPT4gY3JlYXRlQ2lyY2xlR2VvbWV0cnkyLAogICAgY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5MiwKICAgIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnkyLAogICAgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUN5bGluZGVyR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUN5bGluZGVyR2VvbWV0cnkyLAogICAgY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc2VHZW9tZXRyeTogKCkgPT4gY3JlYXRlRWxsaXBzZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUZydXN0dW1HZW9tZXRyeTogKCkgPT4gY3JlYXRlRnJ1c3R1bUdlb21ldHJ5MiwKICAgIGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlUGxhbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUGxhbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWdvbkdlb21ldHJ5OiAoKSA9PiBjcmVhdGVQb2x5Z29uR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVQb2x5bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVQb2x5bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeTIsCiAgICBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVNwaGVyZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVTcGhlcmVHZW9tZXRyeTIsCiAgICBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyOiAoKSA9PiBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyMiwKICAgIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzOiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lczIsCiAgICBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllczogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMyLAogICAgY3JlYXRlVmVjdG9yVGlsZVBvaW50czogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvaW50czIsCiAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnM6ICgpID0+IGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29uczIsCiAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzOiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzMiwKICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcjogKCkgPT4gY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyMiwKICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcDogKCkgPT4gY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwMiwKICAgIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoOiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaDIsCiAgICBjcmVhdGVXYWxsR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVdhbGxHZW9tZXRyeTIsCiAgICBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5MiwKICAgIGRlY29kZURyYWNvOiAoKSA9PiBkZWNvZGVEcmFjbzIsCiAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQ6ICgpID0+IGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldDIsCiAgICBkZWNvZGVJM1M6ICgpID0+IGRlY29kZUkzUzIsCiAgICB0cmFuc2NvZGVLVFgyOiAoKSA9PiB0cmFuc2NvZGVLVFgyMiwKICAgIHRyYW5zZmVyVHlwZWRBcnJheVRlc3Q6ICgpID0+IHRyYW5zZmVyVHlwZWRBcnJheVRlc3QsCiAgICB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoOiAoKSA9PiB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoMgogIH0pOwogIHZhciBjb21iaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NvbWJpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVCb3hHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQm94R2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQ2lyY2xlR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUNpcmNsZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDb3JyaWRvckdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3JyaWRvckdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDeWxpbmRlckdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDeWxpbmRlckdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNlR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUVsbGlwc2VHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVFbGxpcHNvaWRHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVGcnVzdHVtR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUZydXN0dW1HZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBsYW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBsYW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlnb25HZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUG9seWdvbkdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUG9seWxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUG9seWxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVTcGhlcmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlU3BoZXJlR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcjIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpKTsKICB9OwogIHZhciBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lczIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzKCkpOwogIH07CiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVQb2ludHMyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2ludHMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lczIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcygpKTsKICB9OwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXIyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcigpKTsKICB9OwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcCgpKTsKICB9OwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaDIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2goKSk7CiAgfTsKICB2YXIgY3JlYXRlV2FsbEdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVXYWxsR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBkZWNvZGVEcmFjbzIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfZGVjb2RlRHJhY28oKSk7CiAgfTsKICB2YXIgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQoKSk7CiAgfTsKICB2YXIgZGVjb2RlSTNTMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9kZWNvZGVJM1MoKSk7CiAgfTsKICB2YXIgdHJhbnNjb2RlS1RYMjIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfdHJhbnNjb2RlS1RYMigpKTsKICB9OwogIHZhciB0cmFuc2ZlclR5cGVkQXJyYXlUZXN0ID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X3RyYW5zZmVyVHlwZWRBcnJheVRlc3QoKSk7CiAgfTsKICB2YXIgdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaDIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaCgpKTsKICB9OwogIHJldHVybiBfX3RvQ29tbW9uSlMoc3RkaW5fZXhwb3J0cyk7Cn0pKCk7Cg==");